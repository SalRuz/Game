import vk_api
import time
import logging
import json
import os
import random
import io
import sqlite3
import threading
from pathlib import Path
from PIL import Image, ImageDraw, ImageFont, ImageEnhance
from vk_api.longpoll import VkLongPoll, VkEventType
from vk_api.keyboard import VkKeyboard, VkKeyboardColor
from vk_api.bot_longpoll import VkBotLongPoll, VkBotEventType
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)
TOKEN = "vk1.a.1xW2SgtNrmY7IT0LXBRgdZ5Ty3Rk-9t9LusZjvEx_ErEfeKkAN2HF9ONYimFKsQ6cnEhCgQamxjTZC-jxMjNYI76FTou6rmb1zbZBlx7ZVw-pCkant8aaWcAuG04dDgohdLlPbS7Jb53A1L0Eoy3wxhc0xiP47dumu8xop07a2-WoZM77xWTkxWTtI5ce5wXDdaNdMJXUefT27BtXk0erg"
GROUP_ID = 221169719
DATA_DIR = Path("data")
DATA_DIR.mkdir(parents=True, exist_ok=True)
DB_PATH = DATA_DIR / "bot.db"
AVATAR_DIR = "custom_avatars"
os.makedirs(AVATAR_DIR, exist_ok=True)
CELL_SIZE = 60
MARGIN = 5
COLUMNS = 5
ROWS = 10
INVENTORY_SIZE = COLUMNS * ROWS
LOCATION_MAPS = {"–ö–æ—Ä–¥–æ–Ω": "backgrounds/–∫–∞—Ä—Ç–∞_–∫–æ—Ä–¥–æ–Ω–∞.png", "–°–≤–∞–ª–∫–∞": "backgrounds/–∫–∞—Ä—Ç–∞_—Å–≤–∞–ª–∫–∏.png", "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞": "backgrounds/–∫–∞—Ä—Ç–∞_—Ç–µ–º–Ω–æ–π_–¥–æ–ª–∏–Ω—ã.png", "–ü–æ–ª—è–Ω–∞": "backgrounds/–∫–∞—Ä—Ç–∞_–ø–æ–ª—è–Ω—ã.png"}
ITEM_ICONS = {"—à–æ–∫–æ–ª–∞–¥–Ω—ã–π –±–∞—Ç–æ–Ω—á–∏–∫": "icons/chocolate.png", "—Ö–ª–µ–±": "icons/bread.png", "–∫–æ–ª–±–∞—Å–∞": "icons/sausage.png", "–∫–æ–Ω—Å–µ—Ä–≤–∞": "icons/canned_food.png", "–±–∏–Ω—Ç": "icons/bandage.png", "–∞–ø—Ç–µ—á–∫–∞": "icons/first_aid.png", "–∞—Ä–º–µ–π—Å–∫–∞—è –∞–ø—Ç–µ—á–∫–∞": "icons/army_medkit.png", "–Ω–∞—É—á–Ω–∞—è –∞–ø—Ç–µ—á–∫–∞": "icons/science_medkit.png", "—Å–∏–≥–∞—Ä–µ—Ç—ã": "icons/cigarettes.png", "–≤–æ–¥–∫–∞": "icons/vodka.png", "—Ä–∞–¥–∏–æ–ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä": "icons/radioprotector.png", "–∞–Ω—Ç–∏—Ä–∞–¥": "icons/antirad.png", "—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫ –Ω–æ–Ω—Å—Ç–æ–ø": "icons/energy_nostop.png", "—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫ —Å—Ç–∞–ª–∫–µ—Ä": "icons/energy_stalker.png", "–≥–µ—Ä–∫—É–ª–µ—Å": "icons/hercules.png", "–±–∞—Ç–∞—Ä–µ–π–∫–∏": "icons/battery.png", "–ø–æ–Ω—á–∏–∫": "icons/–ü–æ–Ω—á–∏–∫.png", "—Å—Ç–µ–π–∫": "icons/–°—Ç–µ–π–∫.png", "–∂–µ–ª—É–¥—å": "icons/–ñ–µ–ª—É–¥—å.png"}
SPECIAL_WEAPONS = {"–°–ì–ò 5–∫": {"mutant_bonus": 0.5, "radiation_reduce": 0.5}, "–ì—Ä–æ–º –°14": {"mutant_bonus": 1}, "–ê–ö–°-103": {"war_bonus_chance": 30, "war_bonus_damage": 1}, "–û–±—Ä–µ–∑ –¥–≤—É—Å—Ç–≤–æ–ª–∫–∏": {"shotgun_spread": True}, "–¢–û–ó-34": {"shotgun_spread": True}, "–°–ü–°–ê-14": {"shotgun_spread": True}}
DETECTORS = {"–û—Ç–∫–ª–∏–∫": {"charge": 10, "price": 70}, "–ú–µ–¥–≤–µ–¥—å": {"charge": 15, "price": 170}, "–í–µ–ª–µ—Å": {"charge": 20, "price": 320}, "–°–≤–∞—Ä–æ–≥": {"charge": 24, "price": 500}}
ANOMALY_ZONES = {"–ö–æ—Ä–¥–æ–Ω": {"–ê1": "–≥—Ä–∞–≤–∏", "–ê2": "—ç–ª–µ–∫—Ç—Ä–æ", "–ê3": "—Ö–∏–º"}, "–°–≤–∞–ª–∫–∞": {"–ê1": "—Ç–µ—Ä–º–æ", "–ê2": "–≥—Ä–∞–≤–∏", "–ê3": "–≥—Ä–∞–≤–∏"}, "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞": {"–ê1": "—ç–ª–µ–∫—Ç—Ä–æ", "–ê2": "–≥—Ä–∞–≤–∏"}, "–ü–æ–ª—è–Ω–∞": {"–ê1": "–≥—Ä–∞–≤–∏", "–ê2": "—ç–ª–µ–∫—Ç—Ä–æ", "–ê3": "—Ç–µ—Ä–º–æ"}}
ANOMALY_BUTTONS = {"–≥—Ä–∞–≤–∏": "üå™Ô∏è –ì—Ä–∞–≤–∏ –∞–Ω–æ–º–∞–ª–∏–∏", "—ç–ª–µ–∫—Ç—Ä–æ": "‚ö° –≠–ª–µ–∫—Ç—Ä–æ –∞–Ω–æ–º–∞–ª–∏–∏", "—Ö–∏–º": "‚ò£Ô∏è –•–∏–º –∞–Ω–æ–º–∞–ª–∏–∏", "—Ç–µ—Ä–º–æ": "üî• –¢–µ—Ä–º–æ –∞–Ω–æ–º–∞–ª–∏–∏"}
ANOMALY_DAMAGE = {"–≥—Ä–∞–≤–∏": (3, 4.5), "—ç–ª–µ–∫—Ç—Ä–æ": (3, 5), "—Ö–∏–º": (3.5, 5.5), "—Ç–µ—Ä–º–æ": (3.5, 6)}
ARTIFACTS = {"–≥—Ä–∞–≤–∏": ["–í—Å–ø—ã—à–∫–∞", "–ö—Ä–æ–≤—å –∫–∞–º–Ω—è", "–õ–æ–º–æ—Ç—å –º—è—Å–∞", "–ö–æ–ª—é—á–∫–∞", "–ì–ª–∞–∑", "–ì—Ä–∞–≤–∏", "–ú–∞–º–∏–Ω—ã –±—É—Å—ã", "–ó–æ–ª–æ—Ç–∞—è —Ä—ã–±–∫–∞"], "—ç–ª–µ–∫—Ç—Ä–æ": ["–ú–µ–¥—É–∑–∞", "–°–ª–∏–∑—å", "–ë–µ–Ω–≥–∞–ª—å—Å–∫–∏–π –æ–≥–æ–Ω—å", "–î—É—à–∞", "–°–ª—é–¥–∞", "–ü–ª–∞–º—è", "–ù–æ—á–Ω–∞—è –∑–≤–µ–∑–¥–∞", "–ë–∞—Ç–∞—Ä–µ–π–∫–∞"], "—Ö–∏–º": ["–ö–æ–ª–æ–±–æ–∫", "–ü—É—Å—Ç—ã—à–∫–∞", "–ö–∞–º–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç–æ–∫", "–ö–∞–ø–ª–∏", "–ö—Ä–∏—Å—Ç–∞–ª—å–Ω–∞—è –∫–æ–ª—é—á–∫–∞", "–õ—É–Ω–Ω—ã–π —Å–≤–µ—Ç", "–ü—É–∑—ã—Ä—å", "–ü–ª—ë–Ω–∫–∞"], "—Ç–µ—Ä–º–æ": ["–í—ã–≤–µ—Ä—Ç", "–°–Ω–µ–∂–∏–Ω–∫–∞", "–û–≥–Ω–µ–Ω–Ω—ã–π —à–∞—Ä", "–°–ª–∏–∑–Ω—è–∫", "–ü—Ä—É–∂–∏–Ω–∞", "–°–≤–µ—Ç–ª—è–∫", "–ö—Ä–∏—Å—Ç–∞–ª–ª", "–ú–æ—Ä—Å–∫–æ–π —ë–∂"]}
DONATION_ARTIFACTS = ["–ü–æ–Ω—á–∏–∫", "–°—Ç–µ–π–∫"]
ALL_ARTIFACTS = []
for arts in ARTIFACTS.values():
    ALL_ARTIFACTS.extend(arts)
ALL_ARTIFACTS = list(set(ALL_ARTIFACTS + DONATION_ARTIFACTS))
ARTIFACT_EFFECTS = {"–ö—Ä–æ–≤—å –∫–∞–º–Ω—è": {"health_regen": 0.25}, "–õ–æ–º–æ—Ç—å –º—è—Å–∞": {"health_regen": 0.5}, "–î—É—à–∞": {"health_regen": 0.75}, "–°–≤–µ—Ç–ª—è–∫": {"health_regen": 1}, "–ö–æ–ª–æ–±–æ–∫": {"radiation_reduce": 0.25}, "–ú–µ–¥—É–∑–∞": {"radiation_reduce": 0.5}, "–°–ª–∏–∑–Ω—è–∫": {"radiation_reduce": 0.75}, "–ü—É–∑—ã—Ä—å": {"radiation_reduce": 1}, "–í—Å–ø—ã—à–∫–∞": {"stamina_regen": 0.5}, "–°–Ω–µ–∂–∏–Ω–∫–∞": {"stamina_regen": 1}, "–õ—É–Ω–Ω—ã–π —Å–≤–µ—Ç": {"stamina_regen": 1.5}, "–ë–∞—Ç–∞—Ä–µ–π–∫–∞": {"stamina_regen": 2}, "–ë–µ–Ω–≥–∞–ª—å—Å–∫–∏–π –æ–≥–æ–Ω—å": {"blast_resist": 0.25}, "–í—ã–≤–µ—Ä—Ç": {"blast_resist": 0.5}, "–ì—Ä–∞–≤–∏": {"blast_resist": 0.75}, "–ó–æ–ª–æ—Ç–∞—è —Ä—ã–±–∫–∞": {"blast_resist": 1}, "–ü—É—Å—Ç—ã—à–∫–∞": {"bullet_resist": 0.5}, "–ö–∞–º–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç–æ–∫": {"bullet_resist": 1}, "–ù–æ—á–Ω–∞—è –∑–≤–µ–∑–¥–∞": {"bullet_resist": 1.5}, "–ö—Ä–∏—Å—Ç–∞–ª–ª": {"bullet_resist": 2}, "–ö–æ–ª—é—á–∫–∞": {"anomaly_resist": 0.25}, "–ü–ª–∞–º—è": {"anomaly_resist": 0.5}, "–û–≥–Ω–µ–Ω–Ω—ã–π —à–∞—Ä": {"anomaly_resist": 0.75}, "–ü–ª—ë–Ω–∫–∞": {"anomaly_resist": 1}, "–ì–ª–∞–∑": {"weapon_damage": 0.5}, "–ö–∞–ø–ª–∏": {"weapon_damage": 1}, "–ö—Ä–∏—Å—Ç–∞–ª—å–Ω–∞—è –∫–æ–ª—é—á–∫–∞": {"weapon_damage": 1.5}, "–ü—Ä—É–∂–∏–Ω–∞": {"weapon_damage": 2}, "–°–ª–∏–∑—å": {"weapon_accuracy": 0.5}, "–°–ª—é–¥–∞": {"weapon_accuracy": 1}, "–ú–∞–º–∏–Ω—ã –±—É—Å—ã": {"weapon_accuracy": 1.5}, "–ú–æ—Ä—Å–∫–æ–π —ë–∂": {"weapon_accuracy": 2}}
ARTIFACT_PRICES = {"–ö—Ä–æ–≤—å –∫–∞–º–Ω—è": 15, "–ö–æ–ª–æ–±–æ–∫": 15, "–í—Å–ø—ã—à–∫–∞": 15, "–ë–µ–Ω–≥–∞–ª—å—Å–∫–∏–π –æ–≥–æ–Ω—å": 15, "–ü—É—Å—Ç—ã—à–∫–∞": 15, "–ö–æ–ª—é—á–∫–∞": 15, "–ì–ª–∞–∑": 15, "–°–ª–∏–∑—å": 15, "–õ–æ–º–æ—Ç—å –º—è—Å–∞": 25, "–ú–µ–¥—É–∑–∞": 25, "–°–Ω–µ–∂–∏–Ω–∫–∞": 25, "–í—ã–≤–µ—Ä—Ç": 25, "–ö–∞–º–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç–æ–∫": 25, "–ü–ª–∞–º—è": 25, "–ö–∞–ø–ª–∏": 25, "–°–ª—é–¥–∞": 25, "–î—É—à–∞": 35, "–°–ª–∏–∑–Ω—è–∫": 35, "–õ—É–Ω–Ω—ã–π —Å–≤–µ—Ç": 35, "–ì—Ä–∞–≤–∏": 35, "–ù–æ—á–Ω–∞—è –∑–≤–µ–∑–¥–∞": 35, "–û–≥–Ω–µ–Ω–Ω—ã–π —à–∞—Ä": 35, "–ö—Ä–∏—Å—Ç–∞–ª—å–Ω–∞—è –∫–æ–ª—é—á–∫–∞": 35, "–ú–∞–º–∏–Ω—ã –±—É—Å—ã": 35, "–°–≤–µ—Ç–ª—è–∫": 45, "–ü—É–∑—ã—Ä—å": 45, "–ë–∞—Ç–∞—Ä–µ–π–∫–∞": 45, "–ó–æ–ª–æ—Ç–∞—è —Ä—ã–±–∫–∞": 45, "–ö—Ä–∏—Å—Ç–∞–ª–ª": 45, "–ü–ª—ë–Ω–∫–∞": 45, "–ü—Ä—É–∂–∏–Ω–∞": 45, "–ú–æ—Ä—Å–∫–æ–π —ë–∂": 45}
ARTIFACT_ICONS = {"–í—Å–ø—ã—à–∫–∞": "icons/–í—Å–ø—ã—à–∫–∞.png", "–ö—Ä–æ–≤—å –∫–∞–º–Ω—è": "icons/–ö—Ä–æ–≤—å_–∫–∞–º–Ω—è.png", "–õ–æ–º–æ—Ç—å –º—è—Å–∞": "icons/–õ–æ–º–æ—Ç—å_–º—è—Å–∞.png", "–ö–æ–ª—é—á–∫–∞": "icons/–ö–æ–ª—é—á–∫–∞.png", "–ì–ª–∞–∑": "icons/–ì–ª–∞–∑.png", "–ì—Ä–∞–≤–∏": "icons/–ì—Ä–∞–≤–∏.png", "–ú–∞–º–∏–Ω—ã –±—É—Å—ã": "icons/–ú–∞–º–∏–Ω—ã_–±—É—Å—ã.png", "–ó–æ–ª–æ—Ç–∞—è —Ä—ã–±–∫–∞": "icons/–ó–æ–ª–æ—Ç–∞—è_—Ä—ã–±–∫–∞.png", "–ú–µ–¥—É–∑–∞": "icons/–ú–µ–¥—É–∑–∞.png", "–°–ª–∏–∑—å": "icons/–°–ª–∏–∑—å.png", "–ë–µ–Ω–≥–∞–ª—å—Å–∫–∏–π –æ–≥–æ–Ω—å": "icons/–ë–µ–Ω–≥–∞–ª—å—Å–∫–∏–π_–æ–≥–æ–Ω—å.png", "–î—É—à–∞": "icons/–î—É—à–∞.png", "–°–ª—é–¥–∞": "icons/–°–ª—é–¥–∞.png", "–ü–ª–∞–º—è": "icons/–ü–ª–∞–º—è.png", "–ù–æ—á–Ω–∞—è –∑–≤–µ–∑–¥–∞": "icons/–ù–æ—á–Ω–∞—è_–∑–≤–µ–∑–¥–∞.png", "–ë–∞—Ç–∞—Ä–µ–π–∫–∞": "icons/–ë–∞—Ç–∞—Ä–µ–π–∫–∞.png", "–ö–æ–ª–æ–±–æ–∫": "icons/–ö–æ–ª–æ–±–æ–∫.png", "–ü—É—Å—Ç—ã—à–∫–∞": "icons/–ü—É—Å—Ç—ã—à–∫–∞.png", "–ö–∞–º–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç–æ–∫": "icons/–ö–∞–º–µ–Ω–Ω—ã–π_—Ü–≤–µ—Ç–æ–∫.png", "–ö–∞–ø–ª–∏": "icons/–ö–∞–ø–ª–∏.png", "–ö—Ä–∏—Å—Ç–∞–ª—å–Ω–∞—è –∫–æ–ª—é—á–∫–∞": "icons/–ö—Ä–∏—Å—Ç–∞–ª—å–Ω–∞—è_–∫–æ–ª—é—á–∫–∞.png", "–õ—É–Ω–Ω—ã–π —Å–≤–µ—Ç": "icons/–õ—É–Ω–Ω—ã–π_—Å–≤–µ—Ç.png", "–ü—É–∑—ã—Ä—å": "icons/–ü—É–∑—ã—Ä—å.png", "–ü–ª—ë–Ω–∫–∞": "icons/–ü–ª–µ–Ω–∫–∞.png", "–í—ã–≤–µ—Ä—Ç": "icons/–í—ã–≤–µ—Ä—Ç.png", "–°–Ω–µ–∂–∏–Ω–∫–∞": "icons/–°–Ω–µ–∂–∏–Ω–∫–∞.png", "–û–≥–Ω–µ–Ω–Ω—ã–π —à–∞—Ä": "icons/–û–≥–Ω–µ–Ω–Ω—ã–π_—à–∞—Ä.png", "–°–ª–∏–∑–Ω—è–∫": "icons/–°–ª–∏–∑–Ω—è–∫.png", "–ü—Ä—É–∂–∏–Ω–∞": "icons/–ü—Ä—É–∂–∏–Ω–∞.png", "–°–≤–µ—Ç–ª—è–∫": "icons/–°–≤–µ—Ç–ª—è–∫.png", "–ö—Ä–∏—Å—Ç–∞–ª–ª": "icons/–ö—Ä–∏—Å—Ç–∞–ª–ª.png", "–ú–æ—Ä—Å–∫–æ–π —ë–∂": "icons/–ú–æ—Ä—Å–∫–æ–π_–µ–∂.png"}
ARTIFACT_ICONS["–ü–æ–Ω—á–∏–∫"] = "icons/–ü–æ–Ω—á–∏–∫.png"
ARTIFACT_ICONS["–°—Ç–µ–π–∫"] = "icons/–°—Ç–µ–π–∫.png"
ARTIFACT_EFFECTS["–ü–æ–Ω—á–∏–∫"] = {"heal_on_consume": 0.5}
ARTIFACT_EFFECTS["–°—Ç–µ–π–∫"] = {"hunger_on_consume": 0.5}
DONATION_DURATIONS = {"–¥–µ–Ω—å": 86400,"–Ω–µ–¥–µ–ª—è": 604800,"–º–µ—Å—è—Ü": 2592000}
DONATION_EXCLUDED_ITEMS = ["–≤–æ–¥–∫–∞", "—Å–∏–≥–∞—Ä–µ—Ç—ã", "—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫ –Ω–æ–Ω—Å—Ç–æ–ø", "—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫ —Å—Ç–∞–ª–∫–µ—Ä", "–≥–µ—Ä–∫—É–ª–µ—Å"]
players = {}
factions = {"üõ°Ô∏è –î–æ–ª–≥": [], "‚ò¶Ô∏è –ì—Ä–µ—Ö": [], "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": []}
MAX_FACTION_SIZES = {"üõ°Ô∏è –î–æ–ª–≥": 5, "‚ò¶Ô∏è –ì—Ä–µ—Ö": 5, "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": 5}
STATE_WAITING_FOR_START = "waiting_for_start"
STATE_READING_INSTRUCTIONS = "reading_instructions"
STATE_CHOOSING_FACTION = "choosing_faction"
STATE_ENTERING_NICKNAME = "entering_nickname"
STATE_IN_MENU = "in_menu"
STATE_IN_CAMP = "in_camp"
STATE_IN_BACKPACK = "in_backpack"
STATE_TRANSITION_WAIT = "transition_wait"
STATE_IN_TRANSITION_MENU = "in_transition_menu"
STATE_WAITING_FOR_POINT = "waiting_for_point"
STATE_CONFIRMING_TRANSITION = "confirming_transition"
STATE_RESTING = "resting"
STATE_USING_ITEM = "using_item"
STATE_EXPLORING = "exploring"
STATE_TRADER_MAIN = "trader_main"
STATE_TRADER_BUY = "trader_buy"
STATE_TRADER_SELL = "trader_sell"
STATE_TRADER_BUY_CATEGORY = "trader_buy_category"
STATE_TRADER_SELL_CATEGORY = "trader_sell_category"
STATE_TRADER_BUY_EQUIPMENT = "trader_buy_equipment"
STATE_TRADER_SELL_EQUIPMENT = "trader_sell_equipment"
STATE_TRADER_SELL_EQUIPMENT_CONFIRM = "trader_sell_equipment_confirm"
STATE_TRADER_BUY_EQUIPMENT_CONFIRM = "trader_buy_equipment_confirm"
STATE_TRADER_REPAIR = "trader_repair"
STATE_TRADER_REPAIR_CONFIRM = "trader_repair_confirm"
STATE_WAREHOUSE = "in_warehouse"
STATE_DEAD = "dead"
STATE_CONFIRMING_EQUIPMENT_SELL = "confirming_equipment_sell"
STATE_WAR_MAIN = "war_main"
STATE_WAR_TERRITORIES = "war_territories"
STATE_HUNTING = "hunting"
STATE_HUNTING_SHOOTING = "hunting_shooting"
STATE_ANOMALY_EXPLORE = "anomaly_explore"
STATE_BELT_MAIN = "belt_main"
STATE_BELT_EQUIP = "belt_equip"
STATE_BELT_UNEQUIP = "belt_unequip"
STATE_BELT_SELECT_SLOT = "belt_select_slot"
STATE_BELT_SELECT_ARTIFACT = "belt_select_artifact"
STATE_TRADER_SELL_ARTIFACTS = "trader_sell_artifacts"
STATE_WAR_BUY_SQUAD = "war_buy_squad"
STATE_WAR_CONVERT = "war_convert"
STATE_WAR_MANAGE_SQUADS = "war_manage_squads"
STATE_WAR_SEND_SQUAD = "war_send_squad"
STATE_WAR_SEND_SQUAD_LOCATION = "war_send_squad_location"
STATE_WAR_SEND_SQUAD_POINT = "war_send_squad_point"
STATE_WAR_WITHDRAW_SQUAD = "war_withdraw_squad"
STATE_WAR_ATTACK_CONFIRM = "war_attack_confirm"
STATE_WAR_SHARED_SQUADS = "war_shared_squads"
STATE_WAITING_QUOTE_PHOTO = "waiting_quote_photo"
POINT_COORDINATES = {"–ö–æ—Ä–¥–æ–Ω": {"–ë1": (136, 866), "–ë2": (100, 693), "–ë3": (322, 604), "–ë4": (256, 92), "–¢1": (85, 791), "–¢2": (283, 491), "–¢3": (482, 615), "–¢4": (130, 434), "–¢5": (343, 370), "–õ1": (174, 748), "–õ2": (142, 573), "–õ3": (425, 510), "–õ4": (420, 373), "–õ5": (325, 253), "–¢–†1": (180, 648), "–¢–†2": (236, 546), "–¢–†3": (245, 400), "–ê1": (62, 611), "–ê2": (190, 483), "–ê3": (500, 413)}, "–°–≤–∞–ª–∫–∞": {"–ë1": (413, 406), "–ë2": (661, 192), "–¢1": (608, 906), "–¢2": (667, 642), "–¢3": (227, 451), "–õ1": (666, 765), "–õ2": (869, 664), "–õ3": (879, 390), "–õ4": (358, 177), "–¢–†1": (407, 727), "–¢–†2": (207, 628), "–¢–†3": (593, 86), "–ê1": (471, 578), "–ê2": (683, 387), "–ê3": (448, 262)}, "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞": {"–ë1": (288, 858), "–ë2": (626, 516), "–ë3": (486, 238), "–¢1": (503, 441), "–¢2": (363, 180), "–¢3": (593, 201), "–õ1": (583, 790), "–õ2": (509, 650), "–õ3": (307, 643), "–õ4": (308, 452), "–¢–†1": (381, 374), "–¢–†2": (464, 136), "–ê1": (439, 517), "–ê2": (627, 410)}, "–ü–æ–ª—è–Ω–∞": {"–ë1": (451, 751), "–ë2": (1203, 495), "–ë3": (915, 279), "–¢1": (205, 761), "–¢2": (1051, 401), "–õ1": (135, 575), "–õ2": (557, 143), "–¢–†1": (985, 649), "–¢–†2": (521, 527), "–¢–†3": (423, 331), "–ê1": (743, 633), "–ê2": (373, 499), "–ê3": (607, 327)}}
SQUAD_COSTS = {1: {"money": 100, "food": 5, "med": 5, "rad": 5}, 3: {"money": 300, "food": 10, "med": 10, "rad": 10}, 5: {"money": 500, "food": 15, "med": 15, "rad": 15}}
MIN_SQUADS_FOR_POINT = {"–ë–∞–∑–∞": 5,"–¢–æ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤": 4,"–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞": 3,"–õ–æ–≥–æ–≤–æ": 2,"–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è": 1}
CONVERSION_VALUES = {"—à–æ–∫–æ–ª–∞–¥–Ω—ã–π –±–∞—Ç–æ–Ω—á–∏–∫": {"type": "food", "value": 1},"—Ö–ª–µ–±": {"type": "food", "value": 2},"–∫–æ–ª–±–∞—Å–∞": {"type": "food", "value": 3},"–∫–æ–Ω—Å–µ—Ä–≤–∞": {"type": "food", "value": 4},"–±–∏–Ω—Ç": {"type": "med", "value": 1},"–∞–ø—Ç–µ—á–∫–∞": {"type": "med", "value": 2},"–∞—Ä–º–µ–π—Å–∫–∞—è –∞–ø—Ç–µ—á–∫–∞": {"type": "med", "value": 3},"–Ω–∞—É—á–Ω–∞—è –∞–ø—Ç–µ—á–∫–∞": {"type": "special", "med": 3, "rad": 1},"—Å–∏–≥–∞—Ä–µ—Ç—ã": {"type": "rad", "value": 1},"–≤–æ–¥–∫–∞": {"type": "rad", "value": 2},"—Ä–∞–¥–∏–æ–ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä": {"type": "rad", "value": 3},"–∞–Ω—Ç–∏—Ä–∞–¥": {"type": "rad", "value": 4}}
FACTION_ICONS = {"üõ°Ô∏è –î–æ–ª–≥": "icons/dolg.png","‚ò¶Ô∏è –ì—Ä–µ—Ö": "icons/greh.png","‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": "icons/odinochki.png"}
ZOMBIE_FACTION = "üßü –ó–æ–º–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ"
FACTION_ICONS[ZOMBIE_FACTION] = "icons/–∑–æ–º–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ.png"
LAST_STAND_MODE = False
LAST_STAND_START_POSITIONS = {"üõ°Ô∏è –î–æ–ª–≥": ("–ö–æ—Ä–¥–æ–Ω", "–ë1"), "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": ("–ö–æ—Ä–¥–æ–Ω", "–ë2"), "‚ò¶Ô∏è –ì—Ä–µ—Ö": ("–ö–æ—Ä–¥–æ–Ω", "–ë3"), ZOMBIE_FACTION: [("–°–≤–∞–ª–∫–∞", "–ë1"), ("–ü–æ–ª—è–Ω–∞", "–ë1"), ("–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "–ë3")]}
faction_warehouses = {"üõ°Ô∏è –î–æ–ª–≥": {}, "‚ò¶Ô∏è –ì—Ä–µ—Ö": {}, "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": {}, ZOMBIE_FACTION: {}}
faction_warehouse_money = {"üõ°Ô∏è –î–æ–ª–≥": 0, "‚ò¶Ô∏è –ì—Ä–µ—Ö": 0, "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": 0, ZOMBIE_FACTION: 0}
zombie_bot = {"money": 0, "squads": 0, "food_units": 0, "med_units": 0, "rad_units": 0, "last_action_time": 0, "next_action": "", "backpack": {}, "mode": "normal", "priority_target": None, "agro_points": [], "last_attacked_by": None}
ZOMBIE_ACTION_INTERVAL = 1800
POINT_STRENGTH = {"–ë–∞–∑–∞": 5, "–¢–æ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤": 4, "–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞": 3, "–õ–æ–≥–æ–≤–æ": 2, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è": 1}
ZOMBIE_PHASES = {15: {"name": "–°—Ç–∞—Ä—Ç–æ–≤—ã–µ —Å–∏–ª—ã", "territories": 1, "loot_times": 5}, 30: {"name": "–ù–∏–∑–∫–∏–π —Å—Ç–∞—Ä—Ç", "territories": 1, "loot_times": 10}, 45: {"name": "–ù–∞—á–∞–ª—å–Ω–∞—è —Ñ–∞–∑–∞ –∞–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å–∞", "territories": 2, "loot_times": 10}, 60: {"name": "–ù–µ—É–¥–µ—Ä–∂–∏–º—ã–π –º–∞—Ä—à —Å–º–µ—Ä—Ç–∏", "territories": 3, "loot_times": 10}, 75: {"name": "–•–∞–æ—Å –≤–æ–ø–ª–æ—Ç–∏", "territories": 4, "loot_times": 10}, 100: {"name": "–ê—Ä–º–∞–≥–µ–¥–¥–æ–Ω", "territories": 5, "loot_times": 10}}
FACTION_START_LOCATIONS = {"üõ°Ô∏è –î–æ–ª–≥": ("–ö–æ—Ä–¥–æ–Ω", "–ë1"),"‚ò¶Ô∏è –ì—Ä–µ—Ö": ("–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "–ë1"),"‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": ("–°–≤–∞–ª–∫–∞", "–ë1")}
FACTION_CHAT_LINKS = {"üõ°Ô∏è –î–æ–ª–≥": "https://vk.me/join//eWcWfZ3Kcr3PZtkGLF91BIxJq4GnZ4aeB8=", "‚ò¶Ô∏è –ì—Ä–µ—Ö": "https://vk.me/join/gO2fqOqDnL756hWkhjvMm9P2ypNTz7/r2vw=", "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": "https://vk.me/join/ynzBEUOPUmsKVaB0K0BhSFnzGZsNJlrFGNY="}
POINT_TYPES = {"–ë1": "–ë–∞–∑–∞", "–ë2": "–ë–∞–∑–∞", "–ë3": "–ë–∞–∑–∞", "–ë4": "–ë–∞–∑–∞", "–¢1": "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è", "–¢2": "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è", "–¢3": "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è", "–¢4": "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è", "–¢5": "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è", "–¢–†1": "–¢–æ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤", "–¢–†2": "–¢–æ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤", "–¢–†3": "–¢–æ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤", "–ê1": "–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞", "–ê2": "–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞", "–ê3": "–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞", "–õ1": "–õ–æ–≥–æ–≤–æ", "–õ2": "–õ–æ–≥–æ–≤–æ", "–õ3": "–õ–æ–≥–æ–≤–æ", "–õ4": "–õ–æ–≥–æ–≤–æ", "–õ5": "–õ–æ–≥–æ–≤–æ"}
LOCATIONS = {"–ö–æ—Ä–¥–æ–Ω": ["–¢1", "–¢2", "–¢3", "–¢4", "–¢5", "–¢–†1", "–¢–†2", "–¢–†3", "–ë1", "–ë2", "–ë3", "–ë4", "–ê1", "–ê2", "–ê3", "–õ1", "–õ2", "–õ3", "–õ4", "–õ5"], "–°–≤–∞–ª–∫–∞": ["–¢1", "–¢2", "–¢3", "–¢–†1", "–¢–†2", "–¢–†3", "–ë1", "–ë2", "–ê1", "–ê2", "–ê3", "–õ1", "–õ2", "–õ3", "–õ4"], "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞": ["–¢1", "–¢2", "–¢3", "–¢–†1", "–¢–†2", "–ë1", "–ë2", "–ë3", "–ê1", "–ê2", "–õ1", "–õ2", "–õ3", "–õ4"], "–ü–æ–ª—è–Ω–∞": ["–¢1", "–¢2", "–¢–†1", "–¢–†2", "–¢–†3", "–ë1", "–ë2", "–ë3", "–ê1", "–ê2", "–ê3", "–õ1", "–õ2"]}
BASE_POINTS = {"–ö–æ—Ä–¥–æ–Ω": "–ë1", "–°–≤–∞–ª–∫–∞": "–ë1", "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞": "–ë1"}
TRANSITION_ROUTES = {("–ö–æ—Ä–¥–æ–Ω", "–¢3"): [("–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "–ë1")], ("–ö–æ—Ä–¥–æ–Ω", "–õ3"): [("–ü–æ–ª—è–Ω–∞", "–¢1")], ("–ö–æ—Ä–¥–æ–Ω", "–ë4"): [("–°–≤–∞–ª–∫–∞", "–¢1")], ("–°–≤–∞–ª–∫–∞", "–¢1"): [("–ö–æ—Ä–¥–æ–Ω", "–ë4")], ("–°–≤–∞–ª–∫–∞", "–õ2"): [("–ü–æ–ª—è–Ω–∞", "–õ2")], ("–°–≤–∞–ª–∫–∞", "–õ3"): [("–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "–õ4")], ("–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "–ë1"): [("–ö–æ—Ä–¥–æ–Ω", "–¢3")], ("–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "–õ4"): [("–°–≤–∞–ª–∫–∞", "–õ3")], ("–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "–õ3"): [("–ü–æ–ª—è–Ω–∞", "–¢–†1")], ("–ü–æ–ª—è–Ω–∞", "–¢–†1"): [("–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "–õ3")], ("–ü–æ–ª—è–Ω–∞", "–¢1"): [("–ö–æ—Ä–¥–æ–Ω", "–õ3")], ("–ü–æ–ª—è–Ω–∞", "–õ2"): [("–°–≤–∞–ª–∫–∞", "–õ2")]}
ITEM_EFFECTS = {"—à–æ–∫–æ–ª–∞–¥–Ω—ã–π –±–∞—Ç–æ–Ω—á–∏–∫": {"hunger": -0.5}, "—Ö–ª–µ–±": {"hunger": -1}, "–∫–æ–ª–±–∞—Å–∞": {"hunger": -1.5}, "–∫–æ–Ω—Å–µ—Ä–≤–∞": {"hunger": -2}, "–±–∏–Ω—Ç": {"health": 0.5}, "–∞–ø—Ç–µ—á–∫–∞": {"health": 1}, "–∞—Ä–º–µ–π—Å–∫–∞—è –∞–ø—Ç–µ—á–∫–∞": {"health": 1.5}, "–Ω–∞—É—á–Ω–∞—è –∞–ø—Ç–µ—á–∫–∞": {"health": 1.5, "radiation": -0.5}, "—Å–∏–≥–∞—Ä–µ—Ç—ã": {"radiation": -0.5}, "–≤–æ–¥–∫–∞": {"radiation": -1}, "—Ä–∞–¥–∏–æ–ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä": {"radiation": -1.5}, "–∞–Ω—Ç–∏—Ä–∞–¥": {"radiation": -2}, "—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫ –Ω–æ–Ω—Å—Ç–æ–ø": {"stamina": 3}, "—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫ —Å—Ç–∞–ª–∫–µ—Ä": {"stamina": 5}, "–≥–µ—Ä–∫—É–ª–µ—Å": {"stamina": 7}, "–±–∞—Ç–∞—Ä–µ–π–∫–∏": {}, "–∂–µ–ª—É–¥—å": {"random_effect": True}}
CATEGORIES = {"–µ–¥–∞": ["—à–æ–∫–æ–ª–∞–¥–Ω—ã–π –±–∞—Ç–æ–Ω—á–∏–∫", "—Ö–ª–µ–±", "–∫–æ–ª–±–∞—Å–∞", "–∫–æ–Ω—Å–µ—Ä–≤–∞", "–≥–µ—Ä–∫—É–ª–µ—Å"], "–º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã": ["–±–∏–Ω—Ç", "–∞–ø—Ç–µ—á–∫–∞", "–∞—Ä–º–µ–π—Å–∫–∞—è –∞–ø—Ç–µ—á–∫–∞", "–Ω–∞—É—á–Ω–∞—è –∞–ø—Ç–µ—á–∫–∞"], "–∞–Ω—Ç–∏—Ä–∞–¥": ["—Å–∏–≥–∞—Ä–µ—Ç—ã", "–≤–æ–¥–∫–∞", "—Ä–∞–¥–∏–æ–ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä", "–∞–Ω—Ç–∏—Ä–∞–¥"], "—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∏": ["—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫ –Ω–æ–Ω—Å—Ç–æ–ø", "—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫ —Å—Ç–∞–ª–∫–µ—Ä"], "–ø—Ä–æ—á–µ–µ": ["–±–∞—Ç–∞—Ä–µ–π–∫–∏", "–∂–µ–ª—É–¥—å"], "–∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã": ALL_ARTIFACTS}
BUY_PRICES = {"—à–æ–∫–æ–ª–∞–¥–Ω—ã–π –±–∞—Ç–æ–Ω—á–∏–∫": 5, "—Ö–ª–µ–±": 10, "–∫–æ–ª–±–∞—Å–∞": 15, "–∫–æ–Ω—Å–µ—Ä–≤–∞": 20, "–±–∏–Ω—Ç": 10, "–∞–ø—Ç–µ—á–∫–∞": 15, "–∞—Ä–º–µ–π—Å–∫–∞—è –∞–ø—Ç–µ—á–∫–∞": 20, "–Ω–∞—É—á–Ω–∞—è –∞–ø—Ç–µ—á–∫–∞": 34, "—Å–∏–≥–∞—Ä–µ—Ç—ã": 5, "–≤–æ–¥–∫–∞": 10, "—Ä–∞–¥–∏–æ–ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä": 15, "–∞–Ω—Ç–∏—Ä–∞–¥": 20, "—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫ –Ω–æ–Ω—Å—Ç–æ–ø": 21, "—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫ —Å—Ç–∞–ª–∫–µ—Ä": 35, "–≥–µ—Ä–∫—É–ª–µ—Å": 50, "–±–∞—Ç–∞—Ä–µ–π–∫–∏": 3}
SELL_PRICES = {"—à–æ–∫–æ–ª–∞–¥–Ω—ã–π –±–∞—Ç–æ–Ω—á–∏–∫": 2, "—Ö–ª–µ–±": 5, "–∫–æ–ª–±–∞—Å–∞": 7, "–∫–æ–Ω—Å–µ—Ä–≤–∞": 10, "–±–∏–Ω—Ç": 5, "–∞–ø—Ç–µ—á–∫–∞": 7, "–∞—Ä–º–µ–π—Å–∫–∞—è –∞–ø—Ç–µ—á–∫–∞": 10, "–Ω–∞—É—á–Ω–∞—è –∞–ø—Ç–µ—á–∫–∞": 17, "—Å–∏–≥–∞—Ä–µ—Ç—ã": 2, "–≤–æ–¥–∫–∞": 5, "—Ä–∞–¥–∏–æ–ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä": 7, "–∞–Ω—Ç–∏—Ä–∞–¥": 10, "—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫ –Ω–æ–Ω—Å—Ç–æ–ø": 5, "—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫ —Å—Ç–∞–ª–∫–µ—Ä": 10, "–≥–µ—Ä–∫—É–ª–µ—Å": 20, "–±–∞—Ç–∞—Ä–µ–π–∫–∏": 0.5}
EQUIPMENT = {"‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": {"weapon": [("–ü–ë-1—Å", 2, 1, 1, 200), ("–ö–æ—Ä–∞-919", 3, 1, 2, 300), ("–û–±—Ä–µ–∑ –¥–≤—É—Å—Ç–≤–æ–ª–∫–∏", 3.5, 2, 1, 730), ("–ì–∞–¥—é–∫–∞", 4, 1, 5, 770), ("–¢–†—Å", 3.5, 2, 2, 780), ("–ê–ö–ú-74/2", 4, 2, 3, 870), ("–¢–û–ó-34", 4, 3, 1, 970), ("–°–ü–°–ê-14", 4.5, 4, 1, 1210), ("–°–ì–ò 5–∫", 4.5, 4, 3, 1410)], "armor": [("–ö–æ–∂–∞–Ω–∞—è –∫—É—Ä—Ç–∫–∞", 3, 0, 1, 0, 250), ("–ö–æ–º–±–∏–Ω–µ–∑–æ–Ω ¬´–ó–∞—Ä—è¬ª", 4, 0, 1, 1, 500), ("–ö–æ–º–±–∏–Ω–µ–∑–æ–Ω ¬´–°–ï–í–ê¬ª", 5, 1, 1, 3, 1300), ("–¢—è–∂—ë–ª—ã–π –±—Ä–æ–Ω–µ–∫–æ—Å—Ç—é–º ¬´–¢–ë¬ª", 6, 3, 3, 2, 2350), ("–≠–∫–∑–æ—Å–∫–µ–ª–µ—Ç –Ω–µ–π—Ç—Ä–∞–ª–æ–≤", 7, 4, 4, 2, 3000)]}, "üõ°Ô∏è –î–æ–ª–≥": {"weapon": [("–ü–ú", 1.5, 1, 1, 150), ("–§–æ—Ä–∞-12", 2.5, 1, 1, 250), ("–ì–∞–¥—é–∫–∞", 4, 1, 5, 770), ("–ê–ö–°-74—É", 4, 2, 2, 770), ("–ò–õ-85", 4, 2, 3, 870), ("–ê–° –í–ê–õ", 4.5, 2, 5, 1010), ("–ê–±–∞–∫–∞–Ω", 4, 3, 3, 1070), ("–°–ü–°–ê-14", 4.5, 4, 1, 1210), ("–ì—Ä–æ–º –°14", 4.5, 4, 3, 1410)], "armor": [("–ö—É—Ä—Ç–∫–∞ –î–æ–ª–≥–∞", 3, 0, 1, 0, 250), ("–ü–°5-–ú ¬´–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞¬ª", 4, 1, 1, 0, 750), ("–ü–°–ó-9–ú–¥ ¬´–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞¬ª", 5, 2, 2, 1, 1550), ("–ü–°–ó-9–¥ –ë—Ä–æ–Ω—è ¬´–î–æ–ª–≥–∞¬ª", 6, 3, 4, 1, 2350), ("–≠–∫–∑–æ—Å–∫–µ–ª–µ—Ç ¬´–î–æ–ª–≥–∞¬ª", 7, 4, 5, 1, 3000)]}, "‚ò¶Ô∏è –ì—Ä–µ—Ö": {"weapon": [("–ü–ë-1—Å", 2, 1, 1, 200), ("–ö–æ—Ä–∞-919", 3, 1, 2, 300), ("–û–±—Ä–µ–∑ –¥–≤—É—Å—Ç–≤–æ–ª–∫–∏", 3.5, 2, 1, 730), ("–ì–∞–¥—é–∫–∞", 4, 1, 5, 770), ("–ê–ö–ú-74/2", 4, 2, 3, 870), ("–¢–û–ó-34", 4, 3, 1, 970), ("–ê–ö–°-103", 5, 2, 4, 1000), ("–ê–° –í–ê–õ", 4.5, 2, 5, 1010), ("–°–ü–°–ê-14", 4.5, 4, 1, 1210)], "armor": [("–ü–ª–∞—â ¬´–ì—Ä–µ—Ö–æ–≤—Ü–∞¬ª", 3, 0, 0, 1, 250), ("–ö–µ–≤–ª–∞—Ä–æ–≤—ã–π –ø–ª–∞—â ¬´–ì—Ä–µ—Ö–∞¬ª", 4, 0, 1, 1, 500), ("–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –±—Ä–æ–Ω—è ¬´–í–µ–ª–µ—Å¬ª", 5, 1, 2, 2, 1300), ("–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç ¬´–ü–µ–ø–µ–ª¬ª", 6, 3, 2, 3, 2350), ("–≠–∫–∑–æ—Å–∫–µ–ª–µ—Ç ¬´–ò—Ä–∏–π¬ª", 7, 4, 3, 3, 3000)]}}
EQUIPMENT[ZOMBIE_FACTION] = EQUIPMENT["‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏"].copy()
DROP_T = {"–î–µ–Ω—å–≥–∏": {"chance": 30, "min": 5, "max": 15, "type": "money"}, "—à–æ–∫–æ–ª–∞–¥–Ω—ã–π –±–∞—Ç–æ–Ω—á–∏–∫": {"chance": 33, "min": 1, "max": 3}, "–±–∞—Ç–∞—Ä–µ–π–∫–∏": {"chance": 33, "min": 1, "max": 10}, "—Ö–ª–µ–±": {"chance": 20, "min": 1, "max": 3}, "–∫–æ–ª–±–∞—Å–∞": {"chance": 10, "min": 1, "max": 3}, "–∫–æ–Ω—Å–µ—Ä–≤–∞": {"chance": 5, "min": 1, "max": 3}, "–±–∏–Ω—Ç": {"chance": 33, "min": 1, "max": 3}, "–∞–ø—Ç–µ—á–∫–∞": {"chance": 20, "min": 1, "max": 3}, "–∞—Ä–º–µ–π—Å–∫–∞—è –∞–ø—Ç–µ—á–∫–∞": {"chance": 10, "min": 1, "max": 3}, "–Ω–∞—É—á–Ω–∞—è –∞–ø—Ç–µ—á–∫–∞": {"chance": 5, "min": 1, "max": 3}, "—Å–∏–≥–∞—Ä–µ—Ç—ã": {"chance": 33, "min": 1, "max": 3}, "–≤–æ–¥–∫–∞": {"chance": 20, "min": 1, "max": 3}, "—Ä–∞–¥–∏–æ–ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä": {"chance": 10, "min": 1, "max": 3}, "–∞–Ω—Ç–∏—Ä–∞–¥": {"chance": 5, "min": 1, "max": 3}, "—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫ –Ω–æ–Ω—Å—Ç–æ–ø": {"chance": 10, "min": 1, "max": 3}, "—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫ —Å—Ç–∞–ª–∫–µ—Ä": {"chance": 5, "min": 1, "max": 2}, "–≥–µ—Ä–∫—É–ª–µ—Å": {"chance": 1, "min": 1, "max": 1}}
DROP_TR = {"–î–µ–Ω—å–≥–∏": {"chance": 29, "min": 5, "max": 30, "type": "money"}, "—à–æ–∫–æ–ª–∞–¥–Ω—ã–π –±–∞—Ç–æ–Ω—á–∏–∫": {"chance": 23, "min": 1, "max": 3}, "–±–∞—Ç–∞—Ä–µ–π–∫–∏": {"chance": 30, "min": 1, "max": 15}, "—Ö–ª–µ–±": {"chance": 30, "min": 1, "max": 3}, "–∫–æ–ª–±–∞—Å–∞": {"chance": 20, "min": 1, "max": 3}, "–∫–æ–Ω—Å–µ—Ä–≤–∞": {"chance": 10, "min": 1, "max": 3}, "–±–∏–Ω—Ç": {"chance": 23, "min": 1, "max": 3}, "–∞–ø—Ç–µ—á–∫–∞": {"chance": 25, "min": 1, "max": 3}, "–∞—Ä–º–µ–π—Å–∫–∞—è –∞–ø—Ç–µ—á–∫–∞": {"chance": 20, "min": 1, "max": 3}, "–Ω–∞—É—á–Ω–∞—è –∞–ø—Ç–µ—á–∫–∞": {"chance": 10, "min": 1, "max": 3}, "—Å–∏–≥–∞—Ä–µ—Ç—ã": {"chance": 23, "min": 1, "max": 3}, "–≤–æ–¥–∫–∞": {"chance": 30, "min": 1, "max": 3}, "—Ä–∞–¥–∏–æ–ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä": {"chance": 20, "min": 1, "max": 3}, "–∞–Ω—Ç–∏—Ä–∞–¥": {"chance": 10, "min": 1, "max": 3}, "—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫ –Ω–æ–Ω—Å—Ç–æ–ø": {"chance": 15, "min": 1, "max": 3}, "—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫ —Å—Ç–∞–ª–∫–µ—Ä": {"chance": 10, "min": 1, "max": 2}, "–≥–µ—Ä–∫—É–ª–µ—Å": {"chance": 5, "min": 1, "max": 1}}
DROP_B = {"–î–µ–Ω—å–≥–∏": {"chance": 30, "min": 5, "max": 45, "type": "money"}, "—à–æ–∫–æ–ª–∞–¥–Ω—ã–π –±–∞—Ç–æ–Ω—á–∏–∫": {"chance": 13, "min": 1, "max": 3}, "–±–∞—Ç–∞—Ä–µ–π–∫–∏": {"chance": 30, "min": 1, "max": 20}, "—Ö–ª–µ–±": {"chance": 30, "min": 1, "max": 3}, "–∫–æ–ª–±–∞—Å–∞": {"chance": 30, "min": 1, "max": 3}, "–∫–æ–Ω—Å–µ—Ä–≤–∞": {"chance": 20, "min": 1, "max": 3}, "–±–∏–Ω—Ç": {"chance": 9, "min": 1, "max": 3}, "–∞–ø—Ç–µ—á–∫–∞": {"chance": 13, "min": 1, "max": 3}, "–∞—Ä–º–µ–π—Å–∫–∞—è –∞–ø—Ç–µ—á–∫–∞": {"chance": 13, "min": 1, "max": 3}, "–Ω–∞—É—á–Ω–∞—è –∞–ø—Ç–µ—á–∫–∞": {"chance": 13, "min": 1, "max": 3}, "—Å–∏–≥–∞—Ä–µ—Ç—ã": {"chance": 13, "min": 1, "max": 3}, "–≤–æ–¥–∫–∞": {"chance": 30, "min": 1, "max": 3}, "—Ä–∞–¥–∏–æ–ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä": {"chance": 25, "min": 1, "max": 3}, "–∞–Ω—Ç–∏—Ä–∞–¥": {"chance": 20, "min": 1, "max": 3}, "—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫ –Ω–æ–Ω—Å—Ç–æ–ø": {"chance": 10, "min": 1, "max": 3}, "—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫ —Å—Ç–∞–ª–∫–µ—Ä": {"chance": 5, "min": 1, "max": 2}, "–≥–µ—Ä–∫—É–ª–µ—Å": {"chance": 5, "min": 1, "max": 1}}
DROP_POLYANA_T = {"–∂–µ–ª—É–¥—å": {"chance": 5, "min": 1, "max": 1}}
GAME_INFO_TEXT = "üåå –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ó–æ–Ω—É, —Å—Ç–∞–ª–∫–µ—Ä!\n\n–≠—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤–∞—è RPG –ø–æ –º–æ—Ç–∏–≤–∞–º S.T.A.L.K.E.R. –ó–¥–µ—Å—å —Ç–µ–±–µ –ø—Ä–µ–¥—Å—Ç–æ–∏—Ç –≤—ã–∂–∏–≤–∞—Ç—å, –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –∞–Ω–æ–º–∞–ª—å–Ω—ã–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏, –æ—Ö–æ—Ç–∏—Ç—å—Å—è –Ω–∞ –º—É—Ç–∞–Ω—Ç–æ–≤ –∏ —Å—Ä–∞–∂–∞—Ç—å—Å—è –∑–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ —Å–≤–æ–µ–π –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏.\n\nüèõÔ∏è –ì–†–£–ü–ü–ò–†–û–í–ö–ò\n\n–í –∏–≥—Ä–µ —Ç—Ä–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏: –î–æ–ª–≥, –ì—Ä–µ—Ö –∏ –û–¥–∏–Ω–æ—á–∫–∏. –ö–∞–∂–¥–∞—è –∏–º–µ–µ—Ç —Å–≤–æ–∏ —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ —Å–Ω–∞—Ä—è–∂–µ–Ω–∏–µ. –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å —Å—Ç–∞—Ä—Ç–æ–≤—É—é –ª–æ–∫–∞—Ü–∏—é –∏ –º–æ–∂–µ—à—å –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É.\n\nüìä –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò\n\n¬∑ ‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ: –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ 0 —Ç—ã —É–º–∏—Ä–∞–µ—à—å –∏ —Ç–µ—Ä—è–µ—à—å —á–∞—Å—Ç—å –≤–µ—â–µ–π\n¬∑ ‚ò¢Ô∏è –†–∞–¥–∏–∞—Ü–∏—è: –ø—Ä–∏ –º–∞–∫—Å–∏–º—É–º–µ –Ω–∞–Ω–æ—Å–∏—Ç —É—Ä–æ–Ω –∑–¥–æ—Ä–æ–≤—å—é –∫–∞–∂–¥—ã–π —Ö–æ–¥\n¬∑ üçñ –ì–æ–ª–æ–¥: –ø—Ä–∏ –º–∞–∫—Å–∏–º—É–º–µ —Å–Ω–∏–∂–∞–µ—Ç –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å –∏ –∑–¥–æ—Ä–æ–≤—å–µ\n¬∑ ‚ö° –í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å: —Ç—Ä–∞—Ç–∏—Ç—Å—è –Ω–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏ –ø–µ—Ä–µ—Ö–æ–¥—ã, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –æ—Ç–¥—ã—Ö–æ–º\n\nüéí –ò–ù–í–ï–ù–¢–ê–†–¨ –ò –ü–†–ï–î–ú–ï–¢–´\n\n–í —Ä—é–∫–∑–∞–∫–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã.\n\n¬∑ üçû –ï–¥–∞ —Å–Ω–∏–∂–∞–µ—Ç –≥–æ–ª–æ–¥\n¬∑ üíä –ú–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã –ª–µ—á–∞—Ç –∑–¥–æ—Ä–æ–≤—å–µ\n¬∑ üß™ –ê–Ω—Ç–∏—Ä–∞–¥ –≤—ã–≤–æ–¥–∏—Ç —Ä–∞–¥–∏–∞—Ü–∏—é\n¬∑ üîã –≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å\n¬∑ üîå –ë–∞—Ç–∞—Ä–µ–π–∫–∏ –Ω—É–∂–Ω—ã –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏\n\nüõ°Ô∏è –°–ù–ê–†–Ø–ñ–ï–ù–ò–ï\n\n¬∑ üî´ –û—Ä—É–∂–∏–µ: –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —É—Ä–æ–Ω –∏ —Ç–æ—á–Ω–æ—Å—Ç—å –≤ –±–æ—é —Å –º—É—Ç–∞–Ω—Ç–∞–º–∏\n¬∑ ü¶∫ –ë—Ä–æ–Ω—è: –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç —É—Ä–æ–Ω–∞ –º—É—Ç–∞–Ω—Ç–æ–≤ –∏ –∞–Ω–æ–º–∞–ª–∏–π\n¬∑ üì° –î–µ—Ç–µ–∫—Ç–æ—Ä: –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–∫–∞—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –≤ –∞–Ω–æ–º–∞–ª—å–Ω—ã—Ö –∑–æ–Ω–∞—Ö\n\nüó∫Ô∏è –õ–û–ö–ê–¶–ò–ò –ò –¢–û–ß–ö–ò\n\n–ó–æ–Ω–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∞ –Ω–∞ 4 –ª–æ–∫–∞—Ü–∏–∏:\n\n1. –ö–æ—Ä–¥–æ–Ω \n2. –°–≤–∞–ª–∫–∞ \n3. –¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞\n4. –ü–æ–ª—è–Ω–∞ \n\n–ö–∞–∂–¥–∞—è –ª–æ–∫–∞—Ü–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ—á–∫–∏ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤:\n\n¬∑ üè† –ë–∞–∑—ã: –º–Ω–æ–≥–æ —Ä–µ—Å—É—Ä—Å–æ–≤, –¥–æ—Å—Ç—É–ø –∫ —Å–∫–ª–∞–¥—É\n¬∑ üì¶ –¢–æ—á–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤: —Å—Ä–µ–¥–Ω–∏–π –ª—É—Ç\n¬∑ üó∫Ô∏è –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏: –±–∞–∑–æ–≤—ã–π –ª—É—Ç\n¬∑ üêæ –õ–æ–≥–æ–≤–∞: –æ—Ö–æ—Ç–∞ –Ω–∞ –º—É—Ç–∞–Ω—Ç–æ–≤ –∑–∞ –¥–µ–Ω—å–≥–∏\n¬∑ ‚ö° –ê–Ω–æ–º–∞–ª—å–Ω—ã–µ –∑–æ–Ω—ã: –ø–æ–∏—Å–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤\n\nüö∂ –ü–ï–†–ï–•–û–î–´\n\n–î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏ –Ω—É–∂–Ω—ã –±–∞—Ç–∞—Ä–µ–π–∫–∏ –∏ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –¥—Ä—É–≥—É—é –ª–æ–∫–∞—Ü–∏—é –≤–æ–∑–º–æ–∂–µ–Ω —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞.\n\nüîç –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï\n\n¬∑ üîç –ù–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è—Ö –∏—â–∏ –ø—Ä–µ–¥–º–µ—Ç—ã\n¬∑ üê∫ –í –ª–æ–≥–æ–≤–∞—Ö –æ—Ö–æ—Ç–∏—Å—å –Ω–∞ –º—É—Ç–∞–Ω—Ç–æ–≤\n¬∑ ‚ö° –í –∞–Ω–æ–º–∞–ª—å–Ω—ã—Ö –∑–æ–Ω–∞—Ö –∏—â–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å –¥–µ—Ç–µ–∫—Ç–æ—Ä–æ–º\n\nüêæ –û–•–û–¢–ê –ù–ê –ú–£–¢–ê–ù–¢–û–í\n\n–í –ª–æ–≥–æ–≤–∞—Ö –æ–±–∏—Ç–∞—é—Ç –º—É—Ç–∞–Ω—Ç—ã —Ä–∞–∑–Ω–æ–π —Å–∏–ª—ã. –í –±–æ—é —Ç—ã –≤—ã–±–∏—Ä–∞–µ—à—å –æ–¥–Ω—É –∏–∑ 9 –º–∏—à–µ–Ω–µ–π. –¢–æ—á–Ω–æ—Å—Ç—å –æ—Ä—É–∂–∏—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —Å–∫–æ–ª—å–∫–æ –º–∏—à–µ–Ω–µ–π –±—É–¥—É—Ç –ø–æ–ø–∞–¥–∞–Ω–∏—è–º–∏. –ó–∞ —É–±–∏–π—Å—Ç–≤–æ –º—É—Ç–∞–Ω—Ç–∞ –ø–æ–ª—É—á–∞–µ—à—å –¥–µ–Ω—å–≥–∏.\n\n‚ö° –ê–ù–û–ú–ê–õ–¨–ù–´–ï –ó–û–ù–´\n\n–î–ª—è –≤—Ö–æ–¥–∞ –Ω—É–∂–µ–Ω –¥–µ—Ç–µ–∫—Ç–æ—Ä. –¢—ã –ø–µ—Ä–µ–º–µ—â–∞–µ—à—å—Å—è –ø–æ —Å–µ—Ç–∫–µ 6x6, –∏—â–µ—à—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –∏ –∏–∑–±–µ–≥–∞–µ—à—å –∞–Ω–æ–º–∞–ª–∏–π. –†–∞–∑–Ω—ã–µ –¥–µ—Ç–µ–∫—Ç–æ—Ä—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ä–∞–∑–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–ø–∞—Å–Ω–æ—Å—Ç—è—Ö.\n\nüíé –ê–†–¢–ï–§–ê–ö–¢–´ –ò –ü–û–Ø–°\n\n–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –º–æ–∂–Ω–æ –ø–æ–≤–µ—Å–∏—Ç—å –Ω–∞ –ø–æ—è—Å (3 —Å–ª–æ—Ç–∞). –ö–∞–∂–¥—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –¥–∞—ë—Ç –ø–∞—Å—Å–∏–≤–Ω—ã–µ –±–æ–Ω—É—Å—ã:\n\n¬∑ ‚ù§Ô∏è –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–¥–æ—Ä–æ–≤—å—è\n¬∑ ‚ò¢Ô∏è –í—ã–≤–æ–¥ —Ä–∞–¥–∏–∞—Ü–∏–∏\n¬∑ üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç —É—Ä–æ–Ω–∞\n¬∑ ‚ö° –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏\n\nüõí –¢–û–†–ì–û–í–ï–¶\n\n¬∑ üõí –ü–æ–∫—É–ø–∞–π –ø—Ä–æ–≤–∏–∑–∏—é –∏ —Å–Ω–∞—Ä—è–∂–µ–Ω–∏–µ –∑–∞ –¥–µ–Ω—å–≥–∏\n¬∑ üí∞ –ü—Ä–æ–¥–∞–≤–∞–π –ª–∏—à–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã\n¬∑ üîß –†–µ–º–æ–Ω—Ç–∏—Ä—É–π —Å–ª–æ–º–∞–Ω–Ω–æ–µ –æ—Ä—É–∂–∏–µ –∏ –±—Ä–æ–Ω—é\n\n‚öîÔ∏è –í–û–ô–ù–ê –ì–†–£–ü–ü–ò–†–û–í–û–ö\n\n¬∑ üë• –ü–æ–∫—É–ø–∞–π —Å–∫–≤–∞–¥—ã –∑–∞ –¥–µ–Ω—å–≥–∏ –∏ —Ä–µ—Å—É—Ä—Å—ã\n¬∑ ‚öîÔ∏è –û—Ç–ø—Ä–∞–≤–ª—è–π –∏—Ö –Ω–∞ –∑–∞—Ö–≤–∞—Ç —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π\n¬∑ üõ°Ô∏è –ó–∞—â–∏—â–∞–π —Å–≤–æ–∏ —Ç–æ—á–∫–∏ –æ—Ç –∞—Ç–∞–∫ –¥—Ä—É–≥–∏—Ö –≥—Ä—É–ø–ø–∏—Ä–æ–≤–æ–∫\n¬∑ üî• –ê—Ç–∞–∫—É–π –ª–∏—á–Ω–æ –≤–º–µ—Å—Ç–µ —Å–æ —Å–∫–≤–∞–¥–∞–º–∏ –¥–ª—è —É—Å–∏–ª–µ–Ω–∏—è —É—Ä–æ–Ω–∞\n\nüå™Ô∏è –í–´–ë–†–û–°\n\n–®–∫–∞–ª–∞ –≤—ã–±—Ä–æ—Å–∞ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å –∫–∞–∂–¥—ã–º –¥–µ–π—Å—Ç–≤–∏–µ–º –∏–≥—Ä–æ–∫–æ–≤. –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –º–∞–∫—Å–∏–º—É–º–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤—ã–±—Ä–æ—Å: –≤—Å–µ, –∫—Ç–æ –Ω–µ –≤ —É–∫—Ä—ã—Ç–∏–∏, –ø–æ–≥–∏–±–∞—é—Ç, –∞ —á–∞—Å—Ç—å —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã.\n\nüíé –î–û–ù–ê–¢\n\n–î–æ–Ω–∞—Ç–µ—Ä—ã –ø–æ–ª—É—á–∞—é—Ç –æ—Å–æ–±—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:\n\n¬∑ üç© –ê—Ä—Ç–µ—Ñ–∞–∫—Ç \"–ü–æ–Ω—á–∏–∫\" –∏–ª–∏ \"–°—Ç–µ–π–∫\"\n¬∑ ‚ö° –£—Å–∫–æ—Ä–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã\n¬∑ üõí –î–æ—Å—Ç—É–ø –∫ —Ç–æ—Ä–≥–æ–≤—Ü—É –≤–µ–∑–¥–µ\n¬∑ üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –æ—Ç –ø–æ—Ç–µ—Ä–∏\n\n–£–¥–∞—á–Ω–æ–π –æ—Ö–æ—Ç—ã, —Å—Ç–∞–ª–∫–µ—Ä! –í—ã–∂–∏–≤–∏ –∏ —Å—Ç–∞–Ω—å –ª–µ–≥–µ–Ω–¥–æ–π –ó–æ–Ω—ã. üê∫‚ö°"
MAIN_MENU_TEXT = "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:\n\nüí° –ö–æ–º–∞–Ω–¥–∞ \"2604\" –±—ã—Å—Ç—Ä–æ –≤–µ—Ä–Ω—ë—Ç –≤–∞—Å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n\n‚ùì –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–≥—Ä—ã –ø–æ –∫–æ–º–∞–Ω–¥–µ \"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è\"\n\n¬´üèïÔ∏è –õ–∞–≥–µ—Ä—å - –º–µ—Å—Ç–æ –≤–∞—à–µ–≥–æ —É–∫—Ä—ã—Ç–∏—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è\n‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n¬´üë£ –ü–µ—Ä–µ—Ö–æ–¥ - –ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏–µ –ø–æ –ª–æ–∫–∞—Ü–∏—è–º\n‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n¬´üîé –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ - –ø–æ–∏—Å–∫ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –º–æ–±–æ–≤ \n‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n¬´üõí –¢–æ—Ä–≥–æ–≤–µ—Ü - –ø—Ä–æ–¥–∞–∂–∞ –∏ –ø–æ–∫—É–ø–∫–∞ –≤–µ—â–µ–π\n‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n¬´‚öîÔ∏è –í–æ–π–Ω–∞ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–æ–∫ - –∑–∞—Ö–≤–∞—Ç —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–≤–∞–¥–∞–º–∏"
MUTANTS = {"—Ç—É—à–∫–∞–Ω—á–∏–∫": [{"name": "–°–ª–∞–±—ã–π —Ç—É—à–∫–∞–Ω—á–∏–∫", "hp": 1, "damage": 0.5, "reward": 5}, {"name": "–û–±—ã—á–Ω—ã–π —Ç—É—à–∫–∞–Ω—á–∏–∫", "hp": 1.5, "damage": 1, "reward": 10}, {"name": "–ú–∞—Ç—ë—Ä—ã–π —Ç—É—à–∫–∞–Ω—á–∏–∫", "hp": 2, "damage": 1.5, "reward": 15}], "—Å–ª–µ–ø–æ–π –ø—ë—Å": [{"name": "–°–ª–∞–±—ã–π —Å–ª–µ–ø–æ–π –ø—ë—Å", "hp": 2.5, "damage": 1.5, "reward": 15}, {"name": "–û–±—ã—á–Ω—ã–π —Å–ª–µ–ø–æ–π –ø—ë—Å", "hp": 2.5, "damage": 2, "reward": 20}, {"name": "–ú–∞—Ç—ë—Ä—ã–π —Å–ª–µ–ø–æ–π –ø—ë—Å", "hp": 3, "damage": 2.5, "reward": 25}], "–ø—Å–µ–≤–¥–æ–ø—ë—Å": [{"name": "–°–ª–∞–±—ã–π –ø—Å–µ–≤–¥–æ–ø—ë—Å", "hp": 3.5, "damage": 3.5, "reward": 35}, {"name": "–û–±—ã—á–Ω—ã–π –ø—Å–µ–≤–¥–æ–ø—ë—Å", "hp": 3.5, "damage": 4, "reward": 40}, {"name": "–ú–∞—Ç—ë—Ä—ã–π –ø—Å–µ–≤–¥–æ–ø—ë—Å", "hp": 4, "damage": 4, "reward": 45}], "–ø–ª–æ—Ç—å": [{"name": "–°–ª–∞–±–∞—è –ø–ª–æ—Ç—å", "hp": 4, "damage": 2.5, "reward": 25}, {"name": "–û–±—ã—á–Ω–∞—è –ø–ª–æ—Ç—å", "hp": 4.5, "damage": 3, "reward": 30}, {"name": "–ú–∞—Ç—ë—Ä–∞—è –ø–ª–æ—Ç—å", "hp": 5, "damage": 3, "reward": 35}], "–∫–∞–±–∞–Ω": [{"name": "–°–ª–∞–±—ã–π –∫–∞–±–∞–Ω", "hp": 4, "damage": 3, "reward": 30}, {"name": "–û–±—ã—á–Ω—ã–π –∫–∞–±–∞–Ω", "hp": 4.5, "damage": 3.5, "reward": 35}, {"name": "–ú–∞—Ç—ë—Ä—ã–π –∫–∞–±–∞–Ω", "hp": 5, "damage": 4, "reward": 40}], "–∫—Ä–æ–≤–æ—Å–æ—Å": [{"name": "–°–ª–∞–±—ã–π –∫—Ä–æ–≤–æ—Å–æ—Å", "hp": 5, "damage": 4, "reward": 40}, {"name": "–û–±—ã—á–Ω—ã–π –∫—Ä–æ–≤–æ—Å–æ—Å", "hp": 6, "damage": 4.5, "reward": 45}, {"name": "–ú–∞—Ç—ë—Ä—ã–π –∫—Ä–æ–≤–æ—Å–æ—Å", "hp": 7, "damage": 4.5, "reward": 50}]}
MUTANT_SPAWN_CHANCES = {"–ö–æ—Ä–¥–æ–Ω": {"–õ1": {"—Ç—É—à–∫–∞–Ω—á–∏–∫": 20, "—Å–ª–µ–ø–æ–π –ø—ë—Å": 5, "–ø—Å–µ–≤–¥–æ–ø—ë—Å": 0, "–ø–ª–æ—Ç—å": 10, "–∫–∞–±–∞–Ω": 15, "–∫—Ä–æ–≤–æ—Å–æ—Å": 0}, "–õ2": {"—Ç—É—à–∫–∞–Ω—á–∏–∫": 15, "—Å–ª–µ–ø–æ–π –ø—ë—Å": 20, "–ø—Å–µ–≤–¥–æ–ø—ë—Å": 0, "–ø–ª–æ—Ç—å": 5, "–∫–∞–±–∞–Ω": 20, "–∫—Ä–æ–≤–æ—Å–æ—Å": 0}, "–õ3": {"—Ç—É—à–∫–∞–Ω—á–∏–∫": 10, "—Å–ª–µ–ø–æ–π –ø—ë—Å": 20, "–ø—Å–µ–≤–¥–æ–ø—ë—Å": 10, "–ø–ª–æ—Ç—å": 10, "–∫–∞–±–∞–Ω": 15, "–∫—Ä–æ–≤–æ—Å–æ—Å": 0}, "–õ4": {"—Ç—É—à–∫–∞–Ω—á–∏–∫": 10, "—Å–ª–µ–ø–æ–π –ø—ë—Å": 20, "–ø—Å–µ–≤–¥–æ–ø—ë—Å": 15, "–ø–ª–æ—Ç—å": 10, "–∫–∞–±–∞–Ω": 15, "–∫—Ä–æ–≤–æ—Å–æ—Å": 0}, "–õ5": {"—Ç—É—à–∫–∞–Ω—á–∏–∫": 5, "—Å–ª–µ–ø–æ–π –ø—ë—Å": 25, "–ø—Å–µ–≤–¥–æ–ø—ë—Å": 15, "–ø–ª–æ—Ç—å": 10, "–∫–∞–±–∞–Ω": 15, "–∫—Ä–æ–≤–æ—Å–æ—Å": 0}}, "–°–≤–∞–ª–∫–∞": {"–õ1": {"—Ç—É—à–∫–∞–Ω—á–∏–∫": 20, "—Å–ª–µ–ø–æ–π –ø—ë—Å": 15, "–ø—Å–µ–≤–¥–æ–ø—ë—Å": 10, "–ø–ª–æ—Ç—å": 5, "–∫–∞–±–∞–Ω": 5, "–∫—Ä–æ–≤–æ—Å–æ—Å": 0}, "–õ2": {"—Ç—É—à–∫–∞–Ω—á–∏–∫": 10, "—Å–ª–µ–ø–æ–π –ø—ë—Å": 20, "–ø—Å–µ–≤–¥–æ–ø—ë—Å": 15, "–ø–ª–æ—Ç—å": 5, "–∫–∞–±–∞–Ω": 5, "–∫—Ä–æ–≤–æ—Å–æ—Å": 0}, "–õ3": {"—Ç—É—à–∫–∞–Ω—á–∏–∫": 15, "—Å–ª–µ–ø–æ–π –ø—ë—Å": 20, "–ø—Å–µ–≤–¥–æ–ø—ë—Å": 10, "–ø–ª–æ—Ç—å": 10, "–∫–∞–±–∞–Ω": 10, "–∫—Ä–æ–≤–æ—Å–æ—Å": 0}, "–õ4": {"—Ç—É—à–∫–∞–Ω—á–∏–∫": 10, "—Å–ª–µ–ø–æ–π –ø—ë—Å": 10, "–ø—Å–µ–≤–¥–æ–ø—ë—Å": 0, "–ø–ª–æ—Ç—å": 30, "–∫–∞–±–∞–Ω": 10, "–∫—Ä–æ–≤–æ—Å–æ—Å": 0}}, "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞": {"–õ1": {"—Ç—É—à–∫–∞–Ω—á–∏–∫": 5, "—Å–ª–µ–ø–æ–π –ø—ë—Å": 10, "–ø—Å–µ–≤–¥–æ–ø—ë—Å": 20, "–ø–ª–æ—Ç—å": 0, "–∫–∞–±–∞–Ω": 5, "–∫—Ä–æ–≤–æ—Å–æ—Å": 15}, "–õ2": {"—Ç—É—à–∫–∞–Ω—á–∏–∫": 10, "—Å–ª–µ–ø–æ–π –ø—ë—Å": 5, "–ø—Å–µ–≤–¥–æ–ø—ë—Å": 5, "–ø–ª–æ—Ç—å": 15, "–∫–∞–±–∞–Ω": 10, "–∫—Ä–æ–≤–æ—Å–æ—Å": 5}, "–õ3": {"—Ç—É—à–∫–∞–Ω—á–∏–∫": 15, "—Å–ª–µ–ø–æ–π –ø—ë—Å": 10, "–ø—Å–µ–≤–¥–æ–ø—ë—Å": 15, "–ø–ª–æ—Ç—å": 5, "–∫–∞–±–∞–Ω": 10, "–∫—Ä–æ–≤–æ—Å–æ—Å": 5}, "–õ4": {"—Ç—É—à–∫–∞–Ω—á–∏–∫": 15, "—Å–ª–µ–ø–æ–π –ø—ë—Å": 20, "–ø—Å–µ–≤–¥–æ–ø—ë—Å": 15, "–ø–ª–æ—Ç—å": 5, "–∫–∞–±–∞–Ω": 10, "–∫—Ä–æ–≤–æ—Å–æ—Å": 0}}, "–ü–æ–ª—è–Ω–∞": {"–õ1": {"—Ç—É—à–∫–∞–Ω—á–∏–∫": 15, "—Å–ª–µ–ø–æ–π –ø—ë—Å": 10, "–ø—Å–µ–≤–¥–æ–ø—ë—Å": 15, "–ø–ª–æ—Ç—å": 10, "–∫–∞–±–∞–Ω": 10, "–∫—Ä–æ–≤–æ—Å–æ—Å": 5}, "–õ2": {"—Ç—É—à–∫–∞–Ω—á–∏–∫": 15, "—Å–ª–µ–ø–æ–π –ø—ë—Å": 20, "–ø—Å–µ–≤–¥–æ–ø—ë—Å": 10, "–ø–ª–æ—Ç—å": 10, "–∫–∞–±–∞–Ω": 10, "–∫—Ä–æ–≤–æ—Å–æ—Å": 0}}}
ARTIFACT_INFO_TEXT = "üí° –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞—Ö: \n \n‚ûñ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è:\n \nüåí –ö—Ä–æ–≤—å –∫–∞–º–Ω—è +0.25‚ù§Ô∏è\nüåì –õ–æ–º–æ—Ç—å –º—è—Å–∞ +0.5‚ù§Ô∏è\nüåî –î—É—à–∞ +0.75‚ù§Ô∏è\nüåï –°–≤–µ—Ç–ª—è–∫ +1‚ù§Ô∏è\n \n‚ûñ –í—ã–≤–æ–¥ —Ä–∞–¥–∏–∞—Ü–∏–∏:\n \nüåí –ö–æ–ª–æ–±–æ–∫ -0.25‚ò¢Ô∏è\nüåì –ú–µ–¥—É–∑–∞ -0.5‚ò¢Ô∏è\nüåî –°–ª–∏–∑–Ω—è–∫ -0.75‚ò¢Ô∏è\nüåï –ü—É–∑—ã—Ä—å -1‚ò¢Ô∏è\n \n‚ûñ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏–ª –ø—Ä–∏ –æ—Ç–¥—ã—Ö–µ: \n \nüåí –í—Å–ø—ã—à–∫–∞ +0.5‚ö°\nüåì –°–Ω–µ–∂–∏–Ω–∫–∞ +1‚ö°\nüåî –õ—É–Ω–Ω—ã–π —Å–≤–µ—Ç +1.5‚ö°\nüåï –ë–∞—Ç–∞—Ä–µ–π–∫–∞ +2‚ö°\n \n‚ûñ –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–∞–∑—Ä—ã–≤–∞:\n \nüåí –ë–µ–Ω–≥–∞–ª—å—Å–∫–∏–π –æ–≥–æ–Ω—å +0.25üêæ\nüåì –í—ã–≤–µ—Ä—Ç +0.5üêæ\nüåî –ì—Ä–∞–≤–∏ +0.75üêæ\nüåï –ó–æ–ª–æ—Ç–∞—è —Ä—ã–±–∫–∞ +1üêæ\n \n‚ûñ –ü—É–ª–µ—Å—Ç–æ–π–∫–æ—Å—Ç—å:\n \nüåí –ü—É—Å—Ç—ã—à–∫–∞ +0.5üõ°Ô∏è\nüåì –ö–∞–º–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç–æ–∫ +1üõ°Ô∏è\nüåî –ù–æ—á–Ω–∞—è –∑–≤–µ–∑–¥–∞ +1.5üõ°Ô∏è\nüåï –ö—Ä–∏—Å—Ç–∞–ª–ª +2üõ°Ô∏è\n \n‚ûñ –ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞:\n \nüåí –ö–æ–ª—é—á–∫–∞ +0.25üí•\nüåì –ü–ª–∞–º—è +0.5üí•\nüåî –û–≥–Ω–µ–Ω–Ω—ã–π —à–∞—Ä +0.75üí•\nüåï –ü–ª—ë–Ω–∫–∞ +1üí•\n \n‚ûñ –ù–∞–Ω–µ—Å–µ–Ω–∏–µ —É—Ä–æ–Ω–∞:\n \nüåí –ì–ª–∞–∑ +0.5üí¢\nüåì –ö–∞–ø–ª–∏ +1üí¢\nüåî –ö—Ä–∏—Å—Ç–∞–ª—å–Ω–∞—è –∫–æ–ª—é—á–∫–∞ +1.5üí¢\nüåï –ü—Ä—É–∂–∏–Ω–∞ +2üí¢\n \n‚ûñ –¢–æ—á–Ω–æ—Å—Ç—å –ø–æ–ø–∞–¥–∞–Ω–∏—è: \n \nüåí –°–ª–∏–∑—å +0.5üéØ\nüåì –°–ª—é–¥–∞ +1üéØ\nüåî –ú–∞–º–∏–Ω—ã –±—É—Å—ã +1.5üéØ\nüåï –ú–æ—Ä—Å–∫–æ–π —ë–∂ +2üéØ"
EXHAUSTION_LIMITS = {"–ë–∞–∑–∞": 200,"–¢–æ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤": 150,"–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è": 100,"–õ–æ–≥–æ–≤–æ": 30, "–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞": 10}
EMISSION_MAX = 350
EMISSION_WARNING = 335
GAME_CHAT_ID = 2000000003 
shared_warehouse = {}
territory_control = {}
faction_leaders = {}
territory_exhaustion = {}
emission_counter = 0
last_restored_categories = []
faction_shared_squads = {"üõ°Ô∏è –î–æ–ª–≥": 0, "‚ò¶Ô∏è –ì—Ä–µ—Ö": 0, "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": 0}
banned_users = {}
admin_users = []
shared_warehouse_money = 0
def init_database():
    conn = None
    try:
        conn = sqlite3.connect(str(DB_PATH))
        cursor = conn.cursor()
        cursor.execute('''CREATE TABLE IF NOT EXISTS players (
            user_id INTEGER PRIMARY KEY,
            data TEXT NOT NULL
        )''')
        cursor.execute('''CREATE TABLE IF NOT EXISTS game_state (
            key TEXT PRIMARY KEY,
            value TEXT NOT NULL
        )''')
        conn.commit()
        conn.close()
        logger.info(f"–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞: {DB_PATH}")
    except sqlite3.DatabaseError as e:
        logger.error(f"–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
        if conn:
            conn.close()
        if os.path.exists(DB_PATH):
            os.remove(DB_PATH)
            logger.info("–ü–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω–∞—è –±–∞–∑–∞ —É–¥–∞–ª–µ–Ω–∞, —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é...")
            conn = sqlite3.connect(str(DB_PATH))
            cursor = conn.cursor()
            cursor.execute('''CREATE TABLE IF NOT EXISTS players (
                user_id INTEGER PRIMARY KEY,
                data TEXT NOT NULL
            )''')
            cursor.execute('''CREATE TABLE IF NOT EXISTS game_state (
                key TEXT PRIMARY KEY,
                value TEXT NOT NULL
            )''')
            conn.commit()
            conn.close()
            logger.info("–ù–æ–≤–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞")
def create_start_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("–°—Ç–∞—Ä—Ç", color=VkKeyboardColor.POSITIVE)
    return k
def create_next_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("–î–∞–ª–µ–µ", color=VkKeyboardColor.PRIMARY)
    return k
def create_faction_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button(f"üõ°Ô∏è –î–æ–ª–≥ ({len(factions['üõ°Ô∏è –î–æ–ª–≥'])}/{MAX_FACTION_SIZES['üõ°Ô∏è –î–æ–ª–≥']})", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button(f"‚ò¶Ô∏è –ì—Ä–µ—Ö ({len(factions['‚ò¶Ô∏è –ì—Ä–µ—Ö'])}/{MAX_FACTION_SIZES['‚ò¶Ô∏è –ì—Ä–µ—Ö']})", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button(f"‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏ ({len(factions['‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏'])}/{MAX_FACTION_SIZES['‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏']})", color=VkKeyboardColor.POSITIVE)
    return k
def get_main_menu_button(point, location=None):
    ptype = POINT_TYPES.get(point, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è")
    if ptype == "–ë–∞–∑–∞":
        return "üïã –ë–∞–∑–∞"
    elif ptype == "–¢–æ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤":
        return "üèóÔ∏è –¢–æ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤"
    elif ptype == "–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞":
        if location and location in ANOMALY_ZONES and point in ANOMALY_ZONES[location]:
            atype = ANOMALY_ZONES[location][point]
            return ANOMALY_BUTTONS[atype]
        return "üåï –ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞"
    elif ptype == "–õ–æ–≥–æ–≤–æ":
        return "‚ò†Ô∏è –õ–æ–≥–æ–≤–æ"
    else:
        return "üß± –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è"
def create_main_menu_keyboard(user_id):
    p = players[user_id]
    point = p.get("point", "–ë1")
    location = p.get("location", "–õ–∞–≥–µ—Ä—å")
    k = VkKeyboard(one_time=False)
    k.add_button("üèïÔ∏è –õ–∞–≥–µ—Ä—å", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("üë£ –ü–µ—Ä–µ—Ö–æ–¥", color=VkKeyboardColor.POSITIVE)
    k.add_button(get_main_menu_button(point, location), color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("üõí –¢–æ—Ä–≥–æ–≤–µ—Ü", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("‚öîÔ∏è –í–æ–π–Ω–∞ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–æ–∫", color=VkKeyboardColor.NEGATIVE)
    if location in BASE_POINTS and point == BASE_POINTS[location]:
        k.add_line()
        k.add_button("üß∞ –°–∫–ª–∞–¥", color=VkKeyboardColor.SECONDARY)
    return k
def create_camp_menu_keyboard():
    status = get_emission_status()
    k = VkKeyboard(one_time=False)
    k.add_button("üéí –†—é–∫–∑–∞–∫", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("üü° –ü–æ—è—Å", color=VkKeyboardColor.POSITIVE)
    k.add_button("üí§ –û—Ç–¥—ã—Ö", color=VkKeyboardColor.POSITIVE)
    k.add_button("üîã –ü–æ–¥–∑–∞—Ä—è–¥–∫–∞", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button(f"üìä –°—Ç–∞—Ç—É—Å –≤—ã–±—Ä–æ—Å–∞: {status}", color=VkKeyboardColor.NEGATIVE)
    k.add_line()
    k.add_button("üîö –ù–∞–∑–∞–¥", color=VkKeyboardColor.SECONDARY)
    return k
def create_backpack_menu_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("‚ùáÔ∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("‚ôªÔ∏è –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞", color=VkKeyboardColor.SECONDARY)
    k.add_line()
    k.add_button("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", color=VkKeyboardColor.POSITIVE)
    k.add_button("üí° –∏–Ω—Ñ–æ", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("üîö –ù–∞–∑–∞–¥", color=VkKeyboardColor.NEGATIVE)
    return k
def create_warehouse_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("üîö –ù–∞–∑–∞–¥", color=VkKeyboardColor.NEGATIVE)
    return k
def create_trader_main_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("üí≤ –ü—Ä–∏–æ–±—Ä–µ—Å—Ç–∏", color=VkKeyboardColor.POSITIVE)
    k.add_button("üí± –ü—Ä–æ–¥–∞—Ç—å", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("‚öôÔ∏è –ü–æ—á–∏–Ω–∏—Ç—å", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("üîö –ù–∞–∑–∞–¥", color=VkKeyboardColor.SECONDARY)
    return k
def create_trader_category_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("ü•´ –ü—Ä–æ–≤–∏–∑–∏—è", color=VkKeyboardColor.POSITIVE)
    k.add_button("ü™ñ –°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("üîö –ù–∞–∑–∞–¥", color=VkKeyboardColor.SECONDARY)
    return k
def create_trader_sell_category_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("ü•´ –ü—Ä–æ–≤–∏–∑–∏—è", color=VkKeyboardColor.POSITIVE)
    k.add_button("ü™ñ –°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("üåï –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("üîö –ù–∞–∑–∞–¥", color=VkKeyboardColor.SECONDARY)
    return k
def create_equipment_category_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("üî´ –û—Ä—É–∂–∏–µ", color=VkKeyboardColor.POSITIVE)
    k.add_button("ü¶∫ –ë—Ä–æ–Ω—è", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("üìü –î–µ—Ç–µ–∫—Ç–æ—Ä—ã", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("üîö –ù–∞–∑–∞–¥", color=VkKeyboardColor.SECONDARY)
    return k
def create_equipment_sell_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("üî´ –û—Ä—É–∂–∏–µ", color=VkKeyboardColor.POSITIVE)
    k.add_button("ü¶∫ –ë—Ä–æ–Ω—è", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("üìü –î–µ—Ç–µ–∫—Ç–æ—Ä—ã", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("üîö –ù–∞–∑–∞–¥", color=VkKeyboardColor.SECONDARY)
    return k
def create_repair_keyboard(user_id):
    p = players[user_id]
    weapon = p.get("weapon", None)
    armor = p.get("armor", None)
    k = VkKeyboard(one_time=False)
    if weapon:
        k.add_button("üî´ –û—Ä—É–∂–∏–µ", color=VkKeyboardColor.POSITIVE)
    else:
        k.add_button("üî´ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç", color=VkKeyboardColor.SECONDARY)
    if armor:
        k.add_button("ü¶∫ –ë—Ä–æ–Ω—è", color=VkKeyboardColor.POSITIVE)
    else:
        k.add_button("ü¶∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç", color=VkKeyboardColor.SECONDARY)
    k.add_line()
    k.add_button("üîö –ù–∞–∑–∞–¥", color=VkKeyboardColor.NEGATIVE)
    return k
def create_confirmation_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("‚úÖ –î–∞", color=VkKeyboardColor.POSITIVE)
    k.add_button("‚ùå –ù–µ—Ç", color=VkKeyboardColor.NEGATIVE)
    return k
def create_resting_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—Ç–¥—ã—Ö–∞", color=VkKeyboardColor.SECONDARY)
    return k
def create_use_item_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("–û—Ç–º–µ–Ω–∞", color=VkKeyboardColor.NEGATIVE)
    return k
def create_back_only_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("üîö –ù–∞–∑–∞–¥", color=VkKeyboardColor.SECONDARY)
    return k
def create_war_main_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("üó∫Ô∏è –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –∑–æ–Ω—ã üó∫Ô∏è", color=VkKeyboardColor.NEGATIVE)
    k.add_line()
    k.add_button("üí≤ –ü—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ —Å–∫–≤–∞–¥", color=VkKeyboardColor.PRIMARY)
    k.add_button("‚ôªÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–≤–∞–¥–∞–º–∏", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("üîö –ù–∞–∑–∞–¥", color=VkKeyboardColor.SECONDARY)
    return k
def create_war_territories_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("–ö–æ—Ä–¥–æ–Ω", color=VkKeyboardColor.SECONDARY)
    k.add_button("–°–≤–∞–ª–∫–∞", color=VkKeyboardColor.SECONDARY)
    k.add_line()
    k.add_button("–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", color=VkKeyboardColor.SECONDARY)
    k.add_button("–ü–æ–ª—è–Ω–∞", color=VkKeyboardColor.SECONDARY)
    k.add_line()
    k.add_button("üîö –ù–∞–∑–∞–¥", color=VkKeyboardColor.NEGATIVE)
    return k
def create_hunting_keyboard():
    k = VkKeyboard(one_time=False)
    for i in range(1, 10):
        k.add_button(f"üéØ {i}", color=VkKeyboardColor.SECONDARY)
        if i % 3 == 0:
            k.add_line()
    k.add_button("üèÉ –ü–æ–±–µ–≥", color=VkKeyboardColor.NEGATIVE)
    return k
def create_anomaly_movement_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("‚¨ÜÔ∏è", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("‚¨ÖÔ∏è", color=VkKeyboardColor.PRIMARY)
    k.add_button("‚û°Ô∏è", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("‚¨áÔ∏è", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("üö™ –£–π—Ç–∏", color=VkKeyboardColor.NEGATIVE)
    return k
def create_belt_main_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("‚ûï –ü–æ–≤–µ—Å–∏—Ç—å", color=VkKeyboardColor.POSITIVE)
    k.add_button("‚ûñ –°–Ω—è—Ç—å", color=VkKeyboardColor.NEGATIVE)
    k.add_line()
    k.add_button("üí° –ò–Ω—Ñ–æ –æ–± –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞—Ö", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("üîö –ù–∞–∑–∞–¥", color=VkKeyboardColor.SECONDARY)
    return k
def create_belt_slot_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("1Ô∏è‚É£ –ü–æ—è—Å", color=VkKeyboardColor.PRIMARY)
    k.add_button("2Ô∏è‚É£ –ü–æ—è—Å", color=VkKeyboardColor.PRIMARY)
    k.add_button("3Ô∏è‚É£ –ü–æ—è—Å", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("üîö –ù–∞–∑–∞–¥", color=VkKeyboardColor.SECONDARY)
    return k
def create_artifact_selection_keyboard(artifacts, page=0):
    k = VkKeyboard(one_time=False)
    items_per_page = 6
    start = page * items_per_page
    end = start + items_per_page
    page_items = artifacts[start:end]
    count = 0
    for art in page_items:
        if count > 0 and count % 2 == 0:
            k.add_line()
        k.add_button(art[:20], color=VkKeyboardColor.SECONDARY)
        count += 1
    k.add_line()
    total_pages = (len(artifacts) + items_per_page - 1) // items_per_page
    if total_pages > 1:
        if page > 0:
            k.add_button("‚óÄÔ∏è –¢—É–¥–∞", color=VkKeyboardColor.PRIMARY)
        if page < total_pages - 1:
            k.add_button("‚ñ∂Ô∏è –°—é–¥–∞", color=VkKeyboardColor.PRIMARY)
        k.add_line()
    k.add_button("üîö –ù–∞–∑–∞–¥", color=VkKeyboardColor.NEGATIVE)
    return k
def create_transition_keyboard(user_id):
    current_loc = players[user_id]["location"]
    k = VkKeyboard(one_time=False)
    k.add_button(f"‚ñ∂Ô∏è {current_loc} ‚óÄÔ∏è", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    for loc in ["–ö–æ—Ä–¥–æ–Ω", "–°–≤–∞–ª–∫–∞", "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "–ü–æ–ª—è–Ω–∞"]:
        if loc != current_loc:
            k.add_button(loc, color=VkKeyboardColor.SECONDARY)
    k.add_line()
    k.add_button("üîö –ù–∞–∑–∞–¥", color=VkKeyboardColor.NEGATIVE)
    return k
def create_empty_keyboard():
    k = VkKeyboard(one_time=True)
    k.add_button("‚è≥", color=VkKeyboardColor.SECONDARY)
    return k
def create_war_buy_squad_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("1 —Å–∫–≤–∞–¥", color=VkKeyboardColor.POSITIVE)
    k.add_button("3 —Å–∫–≤–∞–¥–∞", color=VkKeyboardColor.POSITIVE)
    k.add_button("5 —Å–∫–≤–∞–¥–æ–≤", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("‚ôªÔ∏è –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –ø—Ä–æ–≤–∏–∑–∏–∏", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("üîö –ù–∞–∑–∞–¥", color=VkKeyboardColor.SECONDARY)
    return k
def create_war_manage_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å", color=VkKeyboardColor.POSITIVE)
    k.add_button("üì• –í—ã–≤–µ—Å—Ç–∏", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("üë• –û–±—â–∏–µ —Å–∫–≤–∞–¥—ã", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("üîö –ù–∞–∑–∞–¥", color=VkKeyboardColor.SECONDARY)
    return k
def create_war_send_location_keyboard(user_id):
    k = VkKeyboard(one_time=False)
    for loc in ["–ö–æ—Ä–¥–æ–Ω", "–°–≤–∞–ª–∫–∞", "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "–ü–æ–ª—è–Ω–∞"]:
        k.add_button(loc, color=VkKeyboardColor.SECONDARY)
        k.add_line()
    k.add_button("üîö –ù–∞–∑–∞–¥", color=VkKeyboardColor.NEGATIVE)
    return k
def create_attack_confirm_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("‚úÖ –î–∞", color=VkKeyboardColor.POSITIVE)
    k.add_button("‚ùå –ù–µ—Ç", color=VkKeyboardColor.NEGATIVE)
    k.add_line()
    k.add_button("‚öîÔ∏è –ù–∞–ø–∞—Å—Ç—å —Å–æ —Å–∫–≤–∞–¥–∞–º–∏", color=VkKeyboardColor.PRIMARY)
    return k
def create_shared_squads_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("üì• –ü–æ–ø–æ–ª–Ω–∏—Ç—å", color=VkKeyboardColor.POSITIVE)
    k.add_button("üì§ –í—ã–≤–µ—Å—Ç–∏", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("üîö –ù–∞–∑–∞–¥", color=VkKeyboardColor.SECONDARY)
    return k
def create_anomaly_path_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("üåÄ –ü—É—Ç—å 1", color=VkKeyboardColor.PRIMARY)
    k.add_button("üåÄ –ü—É—Ç—å 2", color=VkKeyboardColor.PRIMARY)
    k.add_button("üåÄ –ü—É—Ç—å 3", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("üö™ –£–π—Ç–∏", color=VkKeyboardColor.NEGATIVE)
    return k
def create_zombie_control_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("‚öîÔ∏è –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –∑–∞—Ö–≤–∞—Ç", color=VkKeyboardColor.NEGATIVE)
    k.add_line()
    k.add_button("‚öñÔ∏è –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("üì¶ –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("üéØ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç", color=VkKeyboardColor.SECONDARY)
    k.add_button("‚ùå –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç", color=VkKeyboardColor.SECONDARY)
    k.add_line()
    k.add_button("üîö –ù–∞–∑–∞–¥", color=VkKeyboardColor.SECONDARY)
    return k
def load_data():
    global players, factions, shared_warehouse, shared_warehouse_money, territory_control, faction_leaders, territory_exhaustion, emission_counter, last_restored_categories, faction_shared_squads, banned_users, admin_users
    init_database()
    conn = sqlite3.connect(str(DB_PATH))
    cursor = conn.cursor()
    cursor.execute("SELECT user_id, data FROM players")
    rows = cursor.fetchall()
    for row in rows:
        user_id = row[0]
        try:
            p = json.loads(row[1])
            if "belt" not in p:
                p["belt"] = [None, None, None]
            if "squads" not in p:
                p["squads"] = 0
            if "food_units" not in p:
                p["food_units"] = 0
            if "med_units" not in p:
                p["med_units"] = 0
            if "rad_units" not in p:
                p["rad_units"] = 0
            if "donation_end_time" not in p:
                p["donation_end_time"] = None
            if "donation_artifact" not in p:
                p["donation_artifact"] = None
            if "hidden_anomaly_positions" not in p:
                p["hidden_anomaly_positions"] = []
            if "backpack" in p:
                new_backpack = {}
                for item, count in p["backpack"].items():
                    clean_name = item.lower() if item.lower() in ITEM_ICONS else item
                    new_backpack[clean_name] = count
                p["backpack"] = new_backpack
            players[user_id] = p
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä–æ–∫–∞ {user_id}: {e}")
    def load_state(key, default):
        cursor.execute("SELECT value FROM game_state WHERE key = ?", (key,))
        row = cursor.fetchone()
        if row:
            try:
                return json.loads(row[0])
            except:
                return default
        return default
    factions = load_state("factions", {"üõ°Ô∏è –î–æ–ª–≥": [], "‚ò¶Ô∏è –ì—Ä–µ—Ö": [], "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": []})
    for key in factions:
        factions[key] = [int(uid) for uid in factions[key]]
    shared_warehouse = load_state("shared_warehouse", {})
    shared_warehouse_money = load_state("shared_warehouse_money", 0)
    territory_control = load_state("territory_control", {})
    faction_leaders = load_state("faction_leaders", {})
    territory_exhaustion = load_state("territory_exhaustion", {})
    emission_counter = load_state("emission_counter", 0)
    last_restored_categories = load_state("last_restored_categories", [])
    faction_shared_squads = load_state("faction_shared_squads", {"üõ°Ô∏è –î–æ–ª–≥": 0, "‚ò¶Ô∏è –ì—Ä–µ—Ö": 0, "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": 0})
    global LAST_STAND_MODE, faction_warehouses, faction_warehouse_money, zombie_bot
    LAST_STAND_MODE = load_state("last_stand_mode", False)
    global EMISSION_MAX, ZOMBIE_ACTION_INTERVAL
    EMISSION_MAX = load_state("emission_max", 350)
    ZOMBIE_ACTION_INTERVAL = load_state("zombie_action_interval", 1800)
    faction_warehouses = load_state("faction_warehouses", {"üõ°Ô∏è –î–æ–ª–≥": {}, "‚ò¶Ô∏è –ì—Ä–µ—Ö": {}, "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": {}, ZOMBIE_FACTION: {}})
    faction_warehouse_money = load_state("faction_warehouse_money", {"üõ°Ô∏è –î–æ–ª–≥": 0, "‚ò¶Ô∏è –ì—Ä–µ—Ö": 0, "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": 0, ZOMBIE_FACTION: 0})
    zombie_bot = load_state("zombie_bot", {"money": 0, "squads": 0, "food_units": 0, "med_units": 0, "rad_units": 0, "last_action_time": 0, "next_action": "", "backpack": {}, "mode": "normal", "priority_target": None, "agro_points": [], "last_attacked_by": None, "pending_target": None, "last_logs": [], "bonus_squads": 0})
    if "pending_target" not in zombie_bot:
        zombie_bot["pending_target"] = None
    if "last_logs" not in zombie_bot:
        zombie_bot["last_logs"] = []
    if "bonus_squads" not in zombie_bot:
        zombie_bot["bonus_squads"] = 0
    if "revenge_target" not in zombie_bot:
        zombie_bot["revenge_target"] = None
    banned_users = load_state("banned_users", {})
    if isinstance(banned_users, list):
        banned_users = {uid: "–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞" for uid in banned_users}
    admin_users = load_state("admin_users", [])
    loaded_limits = load_state("max_faction_sizes", {})
    for faction in MAX_FACTION_SIZES:
        if faction in loaded_limits:
            MAX_FACTION_SIZES[faction] = loaded_limits[faction]
    conn.close()
    if not territory_control:
        init_territory_control()
    if not territory_exhaustion:
        init_territory_exhaustion()
    logger.info("‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ SQLite.")
def save_data():
    try:
        conn = sqlite3.connect(str(DB_PATH))
        cursor = conn.cursor()
        for user_id, data in players.items():
            cursor.execute("INSERT OR REPLACE INTO players (user_id, data) VALUES (?, ?)", (user_id, json.dumps(data, ensure_ascii=False)))
        def save_state(key, value):
            cursor.execute("INSERT OR REPLACE INTO game_state (key, value) VALUES (?, ?)", (key, json.dumps(value, ensure_ascii=False)))
        save_state("factions", factions)
        save_state("shared_warehouse", shared_warehouse)
        save_state("shared_warehouse_money", shared_warehouse_money)
        save_state("territory_control", territory_control)
        save_state("faction_leaders", faction_leaders)
        save_state("territory_exhaustion", territory_exhaustion)
        save_state("emission_counter", emission_counter)
        save_state("last_restored_categories", last_restored_categories)
        save_state("faction_shared_squads", faction_shared_squads)
        save_state("last_stand_mode", LAST_STAND_MODE)
        save_state("faction_warehouses", faction_warehouses)
        save_state("faction_warehouse_money", faction_warehouse_money)
        save_state("zombie_bot", zombie_bot)
        save_state("emission_max", EMISSION_MAX)
        save_state("zombie_action_interval", ZOMBIE_ACTION_INTERVAL)
        save_state("banned_users", banned_users)
        save_state("admin_users", admin_users)
        save_state("max_faction_sizes", MAX_FACTION_SIZES)
        conn.commit()
        conn.close()
        logger.debug("üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ SQLite.")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ SQLite: {e}")
def has_active_donation(user_id):
    p = players.get(user_id)
    if not p:
        return False
    end_time = p.get("donation_end_time")
    if end_time and time.time() < end_time:
        return True
    return False
def get_donation_artifact(user_id):
    p = players.get(user_id)
    if not p:
        return None
    if has_active_donation(user_id):
        return p.get("donation_artifact")
    return None
def remove_donation(user_id, vk_session):
    p = players.get(user_id)
    if not p:
        return
    artifact = p.get("donation_artifact")
    if artifact:
        if p["backpack"].get(artifact, 0) > 0:
            p["backpack"][artifact] -= 1
            if p["backpack"][artifact] <= 0:
                del p["backpack"][artifact]
        belt = p.get("belt", [None, None, None])
        for i in range(3):
            if belt[i] == artifact:
                belt[i] = None
        p["belt"] = belt
    p["donation_end_time"] = None
    p["donation_artifact"] = None
    save_data()
    send_message(user_id, "‚è∞ –í–∞—à –¥–æ–Ω–∞—Ç-—Å—Ç–∞—Ç—É—Å –∏—Å—Ç—ë–∫. –ü—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã.", None, vk_session)
def get_random_artifact_by_rarity(anomaly_type):
    artifacts = ARTIFACTS[anomaly_type]
    weighted_artifacts = []
    for art in artifacts:
        price = ARTIFACT_PRICES.get(art, 15)
        if price <= 15:
            weight = 40
        elif price <= 25:
            weight = 30
        elif price <= 35:
            weight = 20
        else:
            weight = 10
        weighted_artifacts.append((art, weight))
    total_weight = sum(w for _, w in weighted_artifacts)
    rand = random.randint(1, total_weight)
    current = 0
    for art, weight in weighted_artifacts:
        current += weight
        if rand <= current:
            return art
    return artifacts[0]
def get_user_info(user_id, vk_session):
    try:
        user = vk_session.method("users.get", {"user_ids": user_id, "fields": "screen_name"})[0]
        first_name = user['first_name']
        screen_name = user.get("screen_name", "")
        return first_name, screen_name
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏: {e}")
        return "–¥—Ä—É–≥", ""
def get_user_avatar(user_id, vk_session):
    try:
        user = vk_session.method("users.get", {"user_ids": user_id, "fields": "photo_200"})[0]
        photo_url = user.get("photo_200")
        if photo_url:
            response = vk_session.http.get(photo_url)
            img = Image.open(io.BytesIO(response.content))
            return img
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∫–∏: {e}")
    return None
def send_message(user_id, message, keyboard=None, vk_session=None, peer_id=None):
    if vk_session is None:
        logger.error("‚ùå vk_session –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –≤ send_message")
        return
    if not message.strip():
        logger.warning("–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")
        return
    try:
        target_id = peer_id if peer_id else user_id
        params = {"peer_id": target_id, "message": message, "random_id": 0}
        if keyboard:
            params["keyboard"] = keyboard.get_keyboard()
        vk_session.method("messages.send", params)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
def send_location_image(user_id, location, point, message, keyboard, vk_session):
    loc_short = location
    if location == "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞":
        loc_short = "–¢–î"
    filename_base = f"{loc_short} {point}"
    img_path = None
    for ext in ["png", "jpg", "jpeg"]:
        path = f"location/{filename_base}.{ext}"
        if os.path.exists(path):
            img_path = path
            break
    if not img_path:
        send_message(user_id, message, keyboard, vk_session)
        return
    try:
        upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
        with open(img_path, "rb") as f:
            response = vk_session.http.post(upload_url, files={"photo": f})
        result = response.json()
        photo_data = vk_session.method("photos.saveMessagesPhoto", {"photo": result["photo"], "server": result["server"], "hash": result["hash"]})[0]
        params = {"user_id": user_id, "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}", "random_id": 0, "message": message}
        if keyboard:
            params["keyboard"] = keyboard.get_keyboard()
        vk_session.method("messages.send", params)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ª–æ–∫–∞—Ü–∏–∏: {e}")
        send_message(user_id, message, keyboard, vk_session)
def reset_all_data():
    global players, factions, shared_warehouse, shared_warehouse_money, territory_control
    global faction_leaders, territory_exhaustion, emission_counter, last_restored_categories
    global faction_shared_squads, LAST_STAND_MODE, faction_warehouses, faction_warehouse_money, zombie_bot
    players = {}
    factions = {"üõ°Ô∏è –î–æ–ª–≥": [], "‚ò¶Ô∏è –ì—Ä–µ—Ö": [], "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": []}
    shared_warehouse = {}
    shared_warehouse_money = 0
    territory_control = {}
    faction_leaders = {}
    territory_exhaustion = {}
    banned_users = {}
    admin_users = []
    emission_counter = 0
    last_restored_categories = []
    faction_shared_squads = {"üõ°Ô∏è –î–æ–ª–≥": 0, "‚ò¶Ô∏è –ì—Ä–µ—Ö": 0, "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": 0}
    LAST_STAND_MODE = False
    faction_warehouses = {"üõ°Ô∏è –î–æ–ª–≥": {}, "‚ò¶Ô∏è –ì—Ä–µ—Ö": {}, "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": {}, ZOMBIE_FACTION: {}}
    faction_warehouse_money = {"üõ°Ô∏è –î–æ–ª–≥": 0, "‚ò¶Ô∏è –ì—Ä–µ—Ö": 0, "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": 0, ZOMBIE_FACTION: 0}
    zombie_bot = {"money": 0, "squads": 0, "food_units": 0, "med_units": 0, "rad_units": 0, "last_action_time": 0, "next_action": "", "backpack": {}, "mode": "normal", "priority_target": None, "agro_points": [], "last_attacked_by": None, "pending_target": None, "last_logs": [], "bonus_squads": 0}
    init_territory_control()
    init_territory_exhaustion()
    save_data()
    logger.info("‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã!")
def get_belt_bonus(user_id, stat):
    p = players[user_id]
    belt = p.get("belt", [None, None, None])
    total = 0
    for art in belt:
        if art and art in ARTIFACT_EFFECTS:
            total += ARTIFACT_EFFECTS[art].get(stat, 0)
    return total
def normalize_stats(user_id):
    p = players[user_id]
    p["health"] = round(max(0, min(10, p.get("health", 10))), 1)
    p["radiation"] = round(max(0, min(10, p.get("radiation", 0))), 1)
    p["hunger"] = round(max(0, min(10, p.get("hunger", 0))), 1)
    p["stamina"] = round(max(0, min(10, p.get("stamina", 10))), 1)
def get_player_position(user_id):
    p = players[user_id]
    if p.get("state") != STATE_TRANSITION_WAIT:
        return p.get("location"), p.get("point")
    end_time = p.get("transition_end_time")
    if not end_time:
        return p.get("location"), p.get("point")
    current_time = time.time()
    if current_time >= end_time:
        return p.get("location"), p.get("point")
    transition_duration = 900 if has_active_donation(user_id) else 1800
    start_time = end_time - transition_duration
    elapsed = current_time - start_time
    half_time = transition_duration / 2
    if elapsed < half_time:
        prev_loc = p.get("previous_location")
        prev_point = p.get("previous_point")
        if prev_loc and prev_point:
            return prev_loc, prev_point
    return p.get("location"), p.get("point")
def apply_belt_effects_on_exploration(user_id):
    p = players[user_id]
    health_regen = get_belt_bonus(user_id, "health_regen")
    radiation_reduce = get_belt_bonus(user_id, "radiation_reduce")
    if health_regen > 0:
        p["health"] = min(10, p["health"] + health_regen)
    if radiation_reduce > 0:
        p["radiation"] = max(0, p["radiation"] - radiation_reduce)
    normalize_stats(user_id)
def apply_belt_effects_on_rest(user_id):
    return get_belt_bonus(user_id, "stamina_regen")
def get_total_stats_with_belt(user_id):
    p = players[user_id]
    return {"blast_resist": p.get("blast_resist", 0) + get_belt_bonus(user_id, "blast_resist"), "bullet_resist": p.get("bullet_resist", 0) + get_belt_bonus(user_id, "bullet_resist"), "anomaly_resist": p.get("anomaly_resist", 0) + get_belt_bonus(user_id, "anomaly_resist"), "weapon_damage": p.get("weapon_damage", 0) + get_belt_bonus(user_id, "weapon_damage"), "weapon_accuracy": p.get("weapon_accuracy", 0) + get_belt_bonus(user_id, "weapon_accuracy")}
def get_total_weapon_damage(user_id):
    p = players[user_id]
    return p.get("weapon_damage", 0) + get_belt_bonus(user_id, "weapon_damage")
def get_total_weapon_accuracy(user_id):
    p = players[user_id]
    return int(p.get("weapon_accuracy", 0) + get_belt_bonus(user_id, "weapon_accuracy"))
def get_total_blast_resist(user_id):
    p = players[user_id]
    return p.get("blast_resist", 0) + get_belt_bonus(user_id, "blast_resist")
def get_total_anomaly_resist(user_id):
    p = players[user_id]
    return p.get("anomaly_resist", 0) + get_belt_bonus(user_id, "anomaly_resist")
def format_camp_info(user_id):
    p = players[user_id]
    nickname = p["nickname"]
    faction = p["faction"]
    location = p.get("location", "–õ–∞–≥–µ—Ä—å")
    point = p.get("point", "–ë1")
    full_loc = f"{location} {point}"
    health = p.get("health", 10)
    radiation = p.get("radiation", 0)
    hunger = p.get("hunger", 0)
    stamina = p.get("stamina", 10)
    detector = p.get("detector", None)
    detector_charge = p.get("detector_charge", 0)
    detector_max_charge = p.get("detector_max_charge", 0)
    armor = p.get("armor", None)
    armor_durability = p.get("armor_durability", 0)
    armor_max_durability = p.get("armor_max_durability", 0)
    bullet_resist = p.get("bullet_resist", 0) + get_belt_bonus(user_id, "bullet_resist")
    blast_resist = p.get("blast_resist", 0) + get_belt_bonus(user_id, "blast_resist")
    anomaly_resist = p.get("anomaly_resist", 0) + get_belt_bonus(user_id, "anomaly_resist")
    weapon = p.get("weapon", None)
    weapon_durability = p.get("weapon_durability", 0)
    weapon_max_durability = p.get("weapon_max_durability", 0)
    weapon_damage = p.get("weapon_damage", 0) + get_belt_bonus(user_id, "weapon_damage")
    weapon_accuracy = p.get("weapon_accuracy", 0) + get_belt_bonus(user_id, "weapon_accuracy")
    money = p.get("money", 0)
    belt = p.get("belt", [None, None, None])
    belt_str = f"1Ô∏è‚É£{belt[0] or '-'} 2Ô∏è‚É£{belt[1] or '-'} 3Ô∏è‚É£{belt[2] or '-'}"
    lines = [f"¬´üí¨ –ö–ª–∏—á: {nickname}", f"¬´üë• –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞: {faction}", f"¬´üó∫ –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: {full_loc}", "‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî", f"¬´‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ: {health}/10", f"¬´‚ò¢Ô∏è –†–∞–¥–∏–∞—Ü–∏—è: {radiation}/10", f"¬´üçΩÔ∏è –ì–æ–ª–æ–¥: {hunger}/10", f"¬´‚ö° –í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å: {stamina}/10", "‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî", f"¬´üìü –î–µ—Ç–µ–∫—Ç–æ—Ä: {'–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç' if not detector else detector} {detector_charge}/{detector_max_charge}üîã", f"¬´ü™ñ –ë—Ä–æ–Ω—è: {'–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç' if not armor else armor} üîß{armor_durability}/{armor_max_durability}", f"(üõ°) {bullet_resist}", f"(üêæ) {blast_resist}", f"(üí•) {anomaly_resist}", f"¬´üî´ –û—Ä—É–∂–∏–µ: {'–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç' if not weapon else weapon} üîß{weapon_durability}/{weapon_max_durability}", f"(üí¢) {weapon_damage}", f"(üéØ) {weapon_accuracy}", f"¬´üü° –ü–æ—è—Å: {belt_str}", f"¬´üí≤ –î–µ–Ω—å–≥–∏: {money}—Ä"]
    return "\n".join(lines)
def format_minimal_info(user_id):
    p = players[user_id]
    health = p.get("health", 10)
    radiation = p.get("radiation", 0)
    hunger = p.get("hunger", 0)
    stamina = p.get("stamina", 10)
    return f"¬´‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ: {health}/10\n¬´‚ò¢Ô∏è –†–∞–¥–∏–∞—Ü–∏—è: {radiation}/10\n¬´üçΩÔ∏è –ì–æ–ª–æ–¥: {hunger}/10\n¬´‚ö° –í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å: {stamina}/10"
def get_sort_mode(user_id):
    return players[user_id].get("backpack_sort", 0)
def set_sort_mode(user_id, mode):
    players[user_id]["backpack_sort"] = mode % 3
def format_backpack_info(user_id):
    p = players[user_id]
    backpack = p.get("backpack", {})
    money = p.get("money", 0)
    sort_mode = get_sort_mode(user_id)
    if not backpack:
        items_str = "–ü–æ–∫–∞ –ø—É—Å—Ç–æ... üì¶"
    else:
        active_items = {k: v for k, v in backpack.items() if v > 0}
        if not active_items:
            items_str = "–ü—É—Å—Ç–æ"
        else:
            if sort_mode == 0:
                items_list = [f"{item}: {count}" for item, count in active_items.items()]
                items_str = ", ".join(items_list)
            else:
                clean_items = {}
                for emoji_name, count in active_items.items():
                    clean_name = emoji_name.lower()
                    clean_items[clean_name] = (emoji_name, count)
                if sort_mode == 1:
                    sorted_items = []
                    for cat in ["–µ–¥–∞", "–º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã", "–∞–Ω—Ç–∏—Ä–∞–¥", "—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∏", "–ø—Ä–æ—á–µ–µ"]:
                        for name in CATEGORIES[cat]:
                            if name in clean_items:
                                emoji, count = clean_items[name]
                                sorted_items.append((emoji, count))
                    for name, (emoji, count) in clean_items.items():
                        if name not in [n for cat in CATEGORIES.values() for n in cat]:
                            sorted_items.append((emoji, count))
                elif sort_mode == 2:
                    sorted_items = sorted(active_items.items(), key=lambda x: x[1], reverse=True)
                items_str = "\n".join([f"{item}: {count}" for item, count in sorted_items])
    return "üéí –í–∞—à–∏ –≤–µ—â–∏:\n" + items_str + "\n‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n" + f"üí≤ –í–∞—à–∏ –¥–µ–Ω—å–≥–∏: {money}—Ä"
def format_warehouse_info(user_id=None):
    if LAST_STAND_MODE and user_id:
        faction = players[user_id].get("faction")
        warehouse = faction_warehouses.get(faction, {})
        money = faction_warehouse_money.get(faction, 0)
    else:
        warehouse = shared_warehouse
        money = shared_warehouse_money
    if not warehouse:
        items_str = "–ü–æ–∫–∞ –ø—É—Å—Ç–æ... üì¶"
    else:
        active_items = {k: v for k, v in warehouse.items() if v > 0}
        if not active_items:
            items_str = "–ü—É—Å—Ç–æ"
        else:
            items_list = [f"{item}: {count}" for item, count in active_items.items()]
            items_str = "\n".join(items_list)
    return "üß∞ –°–∫–ª–∞–¥:\n" + items_str + "\n‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n" + f"üí≤ –î–µ–Ω—å–≥–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ: {money}—Ä"
def can_transition_from(loc, point):
    return (loc, point) in TRANSITION_ROUTES
def get_available_transitions(loc, point):
    return TRANSITION_ROUTES.get((loc, point), [])
def is_valid_point(loc_name, point):
    return point in LOCATIONS.get(loc_name, [])
def apply_radiation_damage(user_id):
    p = players[user_id]
    if p["radiation"] >= 10:
        p["health"] = max(0, p["health"] - 2)
        return True
    return False
def apply_hunger_damage(user_id):
    p = players[user_id]
    if p["hunger"] >= 10:
        p["health"] = max(0, p["health"] - 1)
        p["stamina"] = max(0, p["stamina"] - 2)
        return True
    return False
def get_damage_reason(user_id):
    reasons = []
    if players[user_id]["radiation"] >= 10:
        reasons.append("—Ä–∞–¥–∏–∞—Ü–∏—è")
    if players[user_id]["hunger"] >= 10:
        reasons.append("–≥–æ–ª–æ–¥")
    return " –∏ ".join(reasons) if reasons else ""
def check_vital_conditions(user_id, action="–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ"):
    p = players[user_id]
    messages = []
    if p["health"] <= 0:
        messages.append("üíÄ –í—ã –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏!")
        return False, "\n".join(messages)
    if action == "–ø–µ—Ä–µ—Ö–æ–¥":
        if p["stamina"] < 3:
            messages.append("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ (—Ç—Ä–µ–±—É–µ—Ç—Å—è 3).")
        if p["hunger"] >= 8:
            messages.append("‚ùå –í—ã —Å–ª–∏—à–∫–æ–º –≥–æ–ª–æ–¥–Ω—ã –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ (–≥–æ–ª–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å < 8).")
        if p["backpack"].get("–±–∞—Ç–∞—Ä–µ–π–∫–∏", 0) < 2:
            messages.append("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞—Ç–∞—Ä–µ–µ–∫ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ (—Ç—Ä–µ–±—É–µ—Ç—Å—è 2).")
    elif action == "–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ":
        if p["stamina"] <= 0:
            messages.append("üò¥ –£ –≤–∞—Å –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å ‚Äî –ø–æ—Ä–∞ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å.")
    elif action == "–æ—Ö–æ—Ç–∞":
        if p["stamina"] <= 0:
            messages.append("üò¥ –£ –≤–∞—Å –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å ‚Äî –ø–æ—Ä–∞ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å.")
        if not p.get("weapon"):
            messages.append("‚ùå –ù–µ—Ç –æ—Ä—É–∂–∏—è ‚Äî –æ—Ö–æ—Ç–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞.")
        elif p.get("weapon_durability", 0) <= 0:
            messages.append("üîß –í–∞—à–µ –æ—Ä—É–∂–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–ª–æ–º–∞–Ω–æ ‚Äî —Å–Ω–∞—á–∞–ª–∞ –ø–æ—á–∏–Ω–∏—Ç–µ –µ–≥–æ.")
    if messages:
        return False, "\n".join(messages)
    return True, ""
def roll_drops(drop_table, point_type):
    rand = random.random()
    if rand < 0.5:
        num_types = 1
    elif rand < 0.75:
        num_types = 2
    elif rand < 0.875:
        num_types = 3
    else:
        num_types = 1
    candidates = []
    for item, data in drop_table.items():
        if random.randint(1, 100) <= data["chance"]:
            candidates.append(item)
    if not candidates:
        if random.random() < 0.1:
            all_items = list(drop_table.keys())
            candidates = random.sample(all_items, k=min(1, len(all_items)))
    if len(candidates) > num_types:
        candidates = random.sample(candidates, k=num_types)
    elif len(candidates) == 0:
        return {}
    found = {}
    for item in candidates:
        data = drop_table[item]
        amount = random.randint(data["min"], data["max"])
        found[item] = amount
    return found
def get_radiation_gain(point_type):
    if random.randint(1, 100) > 25:
        return 0
    if point_type == "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è":
        return random.choice([0.5, 1])
    elif point_type == "–¢–æ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤":
        return random.choice([0.5, 1.5])
    elif point_type == "–ë–∞–∑–∞":
        return random.choice([0.5, 2])
    elif point_type == "–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞":
        return random.choice([0.5, 2.5])
    elif point_type == "–õ–æ–≥–æ–≤–æ":
        return random.choice([0.5, 2])
    return 0
def find_start_position(faction):
    start_loc, start_point = FACTION_START_LOCATIONS.get(faction, ("–ö–æ—Ä–¥–æ–Ω", "–ë1"))
    owner = get_territory_owner(start_loc, start_point)
    if owner == faction:
        return start_loc, start_point
    for loc in LOCATIONS:
        for point in LOCATIONS[loc]:
            if get_territory_owner(loc, point) == faction:
                return loc, point
    return start_loc, start_point
def select_mutant(location, point):
    chances = MUTANT_SPAWN_CHANCES.get(location, {}).get(point, {})
    if not chances:
        return None
    total = sum(chances.values())
    if total == 0:
        return None
    rand = random.randint(1, total)
    cumulative = 0
    for mutant_type, prob in chances.items():
        cumulative += prob
        if rand <= cumulative:
            rank_roll = random.randint(1, 100)
            if rank_roll <= 30:
                rank = 0
            elif rank_roll <= 80:
                rank = 1
            else:
                rank = 2
            return MUTANTS[mutant_type][rank]
    return None
def calculate_and_apply_death_losses(user_id, max_items=10, max_money=100):
    p = players[user_id]
    backpack = p.get("backpack", {})
    money = p.get("money", 0)
    lost_items = {}
    items_list = []
    for item, count in backpack.items():
        if item not in DONATION_ARTIFACTS:
            items_list.extend([item] * count)
    total_items = len(items_list)
    if total_items > 0:
        num_items_to_lose = random.randint(1, min(max_items, total_items))
        random.shuffle(items_list)
        lost_list = items_list[:num_items_to_lose]
        for item in lost_list:
            lost_items[item] = lost_items.get(item, 0) + 1
        for item, count in lost_items.items():
            p["backpack"][item] -= count
            if p["backpack"][item] <= 0:
                del p["backpack"][item]
    money_lost = random.randint(1, min(max_money, money)) if money > 0 else 0
    p["money"] -= money_lost
    return lost_items, money_lost
def format_death_losses(lost_items, money_lost):
    lines = []
    if lost_items or money_lost:
        lines.append("–ü–æ—Ç–µ—Ä—è–Ω–æ:")
        for item, count in lost_items.items():
            lines.append(f"  {item} x{count}")
        if money_lost > 0:
            lines.append(f"  üí≤ {money_lost}—Ä")
    return lines
def lose_random_items_on_death(user_id, vk_session):
    p = players[user_id]
    if p.get("death_notified", False):
        return
    lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=10, max_money=100)
    msg_lines = ["üíÄ –í—ã –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏!"]
    msg_lines.extend(format_death_losses(lost_items, money_lost))
    send_message(user_id, "\n".join(msg_lines), None, vk_session)
    p["death_notified"] = True
    save_data()
def handle_shooting(user_id, vk_session):
    p = players[user_id]
    mutant = p.get("current_mutant")
    if not mutant or p.get("mutant_hp", 0) <= 0:
        send_message(user_id, "–ú—É—Ç–∞–Ω—Ç —É–∂–µ –º—ë—Ä—Ç–≤.", create_main_menu_keyboard(user_id), vk_session)
        p["state"] = STATE_IN_MENU
        save_data()
        return
    if p.get("weapon_durability", 0) <= 0:
        mutant_hp = p.get("mutant_hp", 0)
        player_health = p.get("health", 10)
        blast_resist = get_total_blast_resist(user_id)
        broken_msg = f"üîß –í–∞—à–µ –æ—Ä—É–∂–∏–µ —Å–ª–æ–º–∞–Ω–æ! –°—Ç—Ä–µ–ª—è—Ç—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.\n–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã—Ö–æ–¥ ‚Äî üèÉ –ü–æ–±–µ–≥\n\nüëπ {mutant['name']}\n–•–ü –º—É—Ç–∞–Ω—Ç–∞: {mutant_hp}/{mutant['hp']}\nüí¢ –£—Ä–æ–Ω –º—É—Ç–∞–Ω—Ç–∞: {mutant['damage']}\n\n‚ù§Ô∏è –í–∞—à–µ –•–ü: {player_health}/10\nüêæ –†–∞–∑—Ä—ã–≤: {blast_resist}"
        p["state"] = STATE_HUNTING
        save_data()
        send_message(user_id, broken_msg, create_hunting_keyboard(), vk_session)
        return
    shot_button = p.get("shot_button", 0)
    valid_shots = set(p.get("valid_targets", []))
    messages = []
    weapon_damage = get_total_weapon_damage(user_id)
    weapon_name = p.get("weapon", "")
    special = SPECIAL_WEAPONS.get(weapon_name, {})
    mutant_bonus = special.get("mutant_bonus", 0)
    total_damage = weapon_damage + mutant_bonus
    base_weapon_damage = p.get("weapon_damage", 0)
    def get_adjacent_buttons(btn):
        adjacency = {1: [2, 4, 5], 2: [1, 3, 4, 5, 6], 3: [2, 5, 6], 4: [1, 2, 5, 7, 8], 5: [1, 2, 3, 4, 6, 7, 8, 9], 6: [2, 3, 5, 8, 9], 7: [4, 5, 8], 8: [4, 5, 6, 7, 9], 9: [5, 6, 8]}
        return adjacency.get(btn, [])
    if shot_button not in valid_shots:
        shotgun_hit = False
        if special.get("shotgun_spread"):
            adjacent = get_adjacent_buttons(shot_button)
            adjacent_valid = [btn for btn in adjacent if btn in valid_shots]
            if adjacent_valid and random.randint(1, 100) <= 50:
                shotgun_hit = True
                spread_damage = base_weapon_damage / 2
                p["mutant_hp"] = max(0, p["mutant_hp"] - spread_damage)
                messages.append(f"üí® –ü—Ä–æ–º–∞—Ö, –Ω–æ –¥—Ä–æ–±—å –∑–∞—Ü–µ–ø–∏–ª–∞! –ù–∞–Ω–µ—Å–µ–Ω–æ {spread_damage} —É—Ä–æ–Ω–∞.")
                if p["mutant_hp"] <= 0:
                    reward = mutant["reward"]
                    p["money"] += reward
                    messages.append(f"‚ò†Ô∏è –ú—É—Ç–∞–Ω—Ç —É–±–∏—Ç! –ü–æ–ª—É—á–µ–Ω–æ {reward}—Ä.")
                    radiation_reduce = special.get("radiation_reduce", 0)
                    if radiation_reduce > 0:
                        p["radiation"] = max(0, p["radiation"] - radiation_reduce)
                        messages.append(f"‚ò¢Ô∏è –†–∞–¥–∏–∞—Ü–∏—è —Å–Ω–∏–∂–µ–Ω–∞ –Ω–∞ {radiation_reduce} (—ç—Ñ—Ñ–µ–∫—Ç –æ—Ä—É–∂–∏—è).")
                    p["state"] = STATE_IN_MENU
                    p.pop("current_mutant", None)
                    p.pop("mutant_hp", None)
                    p.pop("valid_targets", None)
                    save_data()
                    send_message(user_id, "\n".join(messages), create_main_menu_keyboard(user_id), vk_session)
                    return
        if not shotgun_hit:
            messages.append("üí® –í—ã –ø—Ä–æ–º–∞—Ö–Ω—É–ª–∏—Å—å!")
    else:
        if random.randint(1, 100) <= 10:
            messages.append("üëπ –ú—É—Ç–∞–Ω—Ç —É–≤–µ—Ä–Ω—É–ª—Å—è –æ—Ç –≤—ã—Å—Ç—Ä–µ–ª–∞!")
        else:
            p["mutant_hp"] = max(0, p["mutant_hp"] - total_damage)
            if mutant_bonus > 0:
                messages.append(f"üí• –ü–æ–ø–∞–¥–∞–Ω–∏–µ! –ù–∞–Ω–µ—Å–µ–Ω–æ {total_damage} —É—Ä–æ–Ω–∞ (üî´+{mutant_bonus}).")
            else:
                messages.append(f"üí• –ü–æ–ø–∞–¥–∞–Ω–∏–µ! –ù–∞–Ω–µ—Å–µ–Ω–æ {total_damage} —É—Ä–æ–Ω–∞.")
            if p["mutant_hp"] <= 0:
                reward = mutant["reward"]
                p["money"] += reward
                messages.append(f"‚ò†Ô∏è –ú—É—Ç–∞–Ω—Ç —É–±–∏—Ç! –ü–æ–ª—É—á–µ–Ω–æ {reward}—Ä.")
                radiation_reduce = special.get("radiation_reduce", 0)
                if radiation_reduce > 0:
                    p["radiation"] = max(0, p["radiation"] - radiation_reduce)
                    messages.append(f"‚ò¢Ô∏è –†–∞–¥–∏–∞—Ü–∏—è —Å–Ω–∏–∂–µ–Ω–∞ –Ω–∞ {radiation_reduce} (—ç—Ñ—Ñ–µ–∫—Ç –æ—Ä—É–∂–∏—è).")
                p["state"] = STATE_IN_MENU
                p.pop("current_mutant", None)
                p.pop("mutant_hp", None)
                p.pop("valid_targets", None)
                save_data()
                send_message(user_id, "\n".join(messages), create_main_menu_keyboard(user_id), vk_session)
                return
    if random.randint(1, 100) <= 10:
        messages.append("üõ°Ô∏è –í—ã —É–∫–ª–æ–Ω–∏–ª–∏—Å—å –æ—Ç –∞—Ç–∞–∫–∏!")
    else:
        raw_damage = mutant["damage"]
        blast_resist = get_total_blast_resist(user_id)
        actual_damage = max(0, round(raw_damage - blast_resist, 1))
        if actual_damage <= 0:
            messages.append("üõ°Ô∏è –ë—Ä–æ–Ω—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≥–ª–æ—Ç–∏–ª–∞ —É—Ä–æ–Ω!")
        else:
            p["health"] = max(0, p["health"] - actual_damage)
            messages.append(f"üíî –ú—É—Ç–∞–Ω—Ç –Ω–∞–Ω—ë—Å {actual_damage} —É—Ä–æ–Ω–∞!")
            if p["health"] <= 0:
                messages.append(f"\nüíÄ –í—ã –ø–æ–≥–∏–±–ª–∏ –≤ –±–æ—é —Å {mutant['name']}!")
                lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=5, max_money=50)
                messages.extend(format_death_losses(lost_items, money_lost))
                p["state"] = STATE_IN_MENU
                p["death_notified"] = True
                p.pop("current_mutant", None)
                p.pop("mutant_hp", None)
                p.pop("valid_targets", None)
                normalize_stats(user_id)
                save_data()
                send_message(user_id, "\n".join(messages), create_main_menu_keyboard(user_id), vk_session)
                return
    if random.randint(1, 100) <= 25:
        equip_to_damage = []
        if p.get("weapon"):
            equip_to_damage.append("weapon")
        if p.get("armor"):
            equip_to_damage.append("armor")
        if equip_to_damage:
            target = random.choice(equip_to_damage)
            if target == "weapon":
                p["weapon_durability"] = max(0, p["weapon_durability"] - 0.5)
                messages.append("üîß –û—Ä—É–∂–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–æ (-0.5)!")
                if p["weapon_durability"] <= 0:
                    messages.append("‚ö†Ô∏è –í–∞—à–µ –æ—Ä—É–∂–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–ª–æ–º–∞–Ω–æ! –°—Ç—Ä–µ–ª—è—Ç—å –±–æ–ª—å—à–µ –Ω–µ–ª—å–∑—è ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ–±–µ–≥!")
            else:
                p["armor_durability"] = max(0, p["armor_durability"] - 0.5)
                messages.append("üîß –ë—Ä–æ–Ω—è –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ (-0.5)!")
    mutant_hp = p.get("mutant_hp", 0)
    player_health = p.get("health", 10)
    display_damage = total_damage
    accuracy = get_total_weapon_accuracy(user_id)
    blast_resist = get_total_blast_resist(user_id)
    weapon_durability = p.get("weapon_durability", 0)
    weapon_max_durability = p.get("weapon_max_durability", 0)
    armor_durability = p.get("armor_durability", 0)
    armor_max_durability = p.get("armor_max_durability", 0)
    special_info = ""
    if mutant_bonus > 0:
        special_info = f" (+{mutant_bonus}üî´)"
    battle_info = f"\nüëπ {mutant['name']}\n–•–ü –º—É—Ç–∞–Ω—Ç–∞: {mutant_hp}/{mutant['hp']}\nüí¢ –£—Ä–æ–Ω –º—É—Ç–∞–Ω—Ç–∞: {mutant['damage']}\n\n‚ù§Ô∏è –í–∞—à–µ –•–ü: {player_health}/10\nüí¢ –í–∞—à —É—Ä–æ–Ω: {display_damage}{special_info}\nüéØ –¢–æ—á–Ω–æ—Å—Ç—å: {accuracy}/9\nüêæ –†–∞–∑—Ä—ã–≤: {blast_resist}\nüîßüî´ –û—Ä—É–∂–∏–µ: {weapon_durability}/{weapon_max_durability}\nüîßü¶∫ –ë—Ä–æ–Ω—è: {armor_durability}/{armor_max_durability}"
    messages.append(battle_info)
    p["state"] = STATE_HUNTING
    save_data()
    send_message(user_id, "\n".join(messages), create_hunting_keyboard(), vk_session)
def handle_exploration(user_id, vk_session):
    p = players[user_id]
    point = p["point"]
    location = p["location"]
    ptype = POINT_TYPES.get(point, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è")
    if not is_player_on_own_territory(user_id):
        send_message(user_id, "‚ùå –≠—Ç–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –≤–∞—à–µ–π –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–µ. –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.", create_main_menu_keyboard(user_id), vk_session)
        return
    if not check_territory_exhaustion(location, point):
        send_message(user_id, "‚ùå –≠—Ç–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –∏—Å—Ç–æ—â–µ–Ω–∞. –î–æ–∂–¥–∏—Ç–µ—Å—å –≤—ã–±—Ä–æ—Å–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.", create_main_menu_keyboard(user_id), vk_session)
        return
    if ptype == "–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞":
        if p["health"] <= 0:
            send_message(user_id, "üíÄ –í—ã –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏! –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.", create_main_menu_keyboard(user_id), vk_session)
            return
        if not p.get("detector"):
            send_message(user_id, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ ‚Äî –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –∞–Ω–æ–º–∞–ª–∏–∏ –Ω–µ–ª—å–∑—è.", create_main_menu_keyboard(user_id), vk_session)
            return
        if p.get("detector_charge", 0) <= 0:
            send_message(user_id, "üîã –î–µ—Ç–µ–∫—Ç–æ—Ä —Ä–∞–∑—Ä—è–∂–µ–Ω ‚Äî —Å–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∑–∞—Ä—è–¥–∏—Ç–µ –µ–≥–æ.", create_main_menu_keyboard(user_id), vk_session)
            return
        if p["stamina"] <= 0:
            send_message(user_id, "üò¥ –£ –≤–∞—Å –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å ‚Äî –ø–æ—Ä–∞ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å.", create_main_menu_keyboard(user_id), vk_session)
            return
        send_message(user_id, "üîç –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ...", create_empty_keyboard(), vk_session)
        add_territory_exhaustion(location, point)
        increment_emission(vk_session)
        p["stamina"] = max(0, p["stamina"] - 1)
        p["hunger"] = min(10, p["hunger"] + 0.5)
        status_messages = []
        if p["hunger"] >= 10:
            p["stamina"] = max(0, p["stamina"] - 2)
            p["health"] = max(0, p["health"] - 0.5)
            status_messages.append("üçΩÔ∏è –í—ã –≥–æ–ª–æ–¥–∞–µ—Ç–µ! (-2‚ö°, -0.5‚ù§Ô∏è)")
        if p["radiation"] >= 10:
            rad_damage = random.choice([1, 1.5, 2])
            p["health"] = max(0, p["health"] - rad_damage)
            status_messages.append(f"‚ò¢Ô∏è –†–∞–¥–∏–∞—Ü–∏—è —Ä–∞–∑—ä–µ–¥–∞–µ—Ç –≤–∞—Å! (-{rad_damage}‚ù§Ô∏è)")
        apply_belt_effects_on_exploration(user_id)
        radiation_gain = get_radiation_gain("–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞")
        if radiation_gain > 0:
            p["radiation"] = min(10, p["radiation"] + radiation_gain)
            status_messages.append(f"‚ò¢Ô∏è –í—ã –ø–æ–ø–∞–ª–∏ –ø–æ–¥ –∏–∑–ª—É—á–µ–Ω–∏–µ —Ä–∞–¥–∏–∞—Ü–∏–∏! (+{radiation_gain})")
        normalize_stats(user_id)
        save_data()
        if p["health"] <= 0:
            death_msg = "\n".join(status_messages) + "\n\n" if status_messages else ""
            death_msg += "üíÄ –í—ã –ø–æ–≥–∏–±–ª–∏ –æ—Ç –∏—Å—Ç–æ—â–µ–Ω–∏—è!"
            lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=5, max_money=50)
            loss_lines = format_death_losses(lost_items, money_lost)
            if loss_lines:
                death_msg += "\n" + "\n".join(loss_lines)
            p["death_notified"] = True
            p["state"] = STATE_IN_MENU
            normalize_stats(user_id)
            save_data()
            send_message(user_id, death_msg, create_main_menu_keyboard(user_id), vk_session)
            return
        init_anomaly_exploration(user_id)
        if p.get("anomaly_path_choosing"):
            atype = p.get("current_anomaly_type", "–≥—Ä–∞–≤–∏")
            msg_parts = []
            if status_messages:
                msg_parts.extend(status_messages)
                msg_parts.append("")
            msg_parts.append(f"üåÄ –í—ã –ø–æ–¥–æ—à–ª–∏ –∫ –∞–Ω–æ–º–∞–ª—å–Ω–æ–π –∑–æ–Ω–µ ({atype})")
            msg_parts.append("‚ö†Ô∏è –í–ø–µ—Ä–µ–¥–∏ –æ–ø–∞—Å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫! –í—ã–±–µ—Ä–∏—Ç–µ –ø—É—Ç—å:")
            msg_parts.append("")
            msg_parts.append("üåÄ –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø—É—Ç—å –±–µ–∑–æ–ø–∞—Å–µ–Ω...")
            send_message(user_id, "\n".join(msg_parts), create_anomaly_path_keyboard(), vk_session)
        else:
            try:
                img_buffer = generate_anomaly_map_image(user_id)
                upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
                response = vk_session.http.post(upload_url, files={"photo": ("map.png", img_buffer, "image/png")})
                result = response.json()
                photo_data = vk_session.method("photos.saveMessagesPhoto", {"photo": result["photo"], "server": result["server"], "hash": result["hash"]})[0]
                atype = p.get("current_anomaly_type", "–≥—Ä–∞–≤–∏")
                msg_parts = []
                if status_messages:
                    msg_parts.extend(status_messages)
                    msg_parts.append("")
                msg_parts.append(f"üåÄ –í—ã –≤–æ—à–ª–∏ –≤ –∞–Ω–æ–º–∞–ª—å–Ω—É—é –∑–æ–Ω—É ({atype})")
                msg_parts.append("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏—è.")
                msg_parts.append("–ù–∞–π–¥–∏—Ç–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –∏ –∏–∑–±–µ–≥–∞–π—Ç–µ –∞–Ω–æ–º–∞–ª–∏–π!")
                alerts = get_detector_alerts(user_id)
                if alerts:
                    msg_parts.append(alerts)
                vk_session.method("messages.send", {"user_id": user_id, "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}", "random_id": 0, "message": "\n".join(msg_parts), "keyboard": create_anomaly_movement_keyboard().get_keyboard()})
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã: {e}")
                send_message(user_id, "üåÄ –í—ã –≤–æ—à–ª–∏ –≤ –∞–Ω–æ–º–∞–ª—å–Ω—É—é –∑–æ–Ω—É. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏—è.", create_anomaly_movement_keyboard(), vk_session)
        return
    if ptype == "–õ–æ–≥–æ–≤–æ":
        if p["health"] <= 0:
            send_message(user_id, "üíÄ –í—ã –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏! –û—Ö–æ—Ç–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞.", create_main_menu_keyboard(user_id), vk_session)
            return
        if not p.get("weapon"):
            send_message(user_id, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –æ—Ä—É–∂–∏—è ‚Äî –æ—Ö–æ—Ç–∏—Ç—å—Å—è –Ω–µ–ª—å–∑—è.", create_main_menu_keyboard(user_id), vk_session)
            return
        if p.get("weapon_durability", 0) <= 0:
            send_message(user_id, "üîß –í–∞—à–µ –æ—Ä—É–∂–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–ª–æ–º–∞–Ω–æ ‚Äî —Å–Ω–∞—á–∞–ª–∞ –ø–æ—á–∏–Ω–∏—Ç–µ –µ–≥–æ.", create_main_menu_keyboard(user_id), vk_session)
            return
        if p["stamina"] <= 0:
            send_message(user_id, "üò¥ –£ –≤–∞—Å –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å ‚Äî –ø–æ—Ä–∞ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å.", create_main_menu_keyboard(user_id), vk_session)
            return
        send_message(user_id, "üîç –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ...", create_empty_keyboard(), vk_session)
        add_territory_exhaustion(location, point)
        increment_emission(vk_session)
        p["stamina"] = max(0, p["stamina"] - 1)
        p["hunger"] = min(10, p["hunger"] + 0.5)
        status_messages = []
        if p["hunger"] >= 10:
            p["stamina"] = max(0, p["stamina"] - 2)
            p["health"] = max(0, p["health"] - 0.5)
            status_messages.append("üçΩÔ∏è –í—ã –≥–æ–ª–æ–¥–∞–µ—Ç–µ! (-2‚ö°, -0.5‚ù§Ô∏è)")
        if p["radiation"] >= 10:
            rad_damage = random.choice([1, 1.5, 2])
            p["health"] = max(0, p["health"] - rad_damage)
            status_messages.append(f"‚ò¢Ô∏è –†–∞–¥–∏–∞—Ü–∏—è —Ä–∞–∑—ä–µ–¥–∞–µ—Ç –≤–∞—Å! (-{rad_damage}‚ù§Ô∏è)")
        apply_belt_effects_on_exploration(user_id)
        radiation_gain = get_radiation_gain("–õ–æ–≥–æ–≤–æ")
        if radiation_gain > 0:
            p["radiation"] = min(10, p["radiation"] + radiation_gain)
            status_messages.append(f"‚ò¢Ô∏è –í—ã –ø–æ–ø–∞–ª–∏ –ø–æ–¥ –∏–∑–ª—É—á–µ–Ω–∏–µ —Ä–∞–¥–∏–∞—Ü–∏–∏! (+{radiation_gain})")
        normalize_stats(user_id)
        save_data()
        if p["health"] <= 0:
            death_msg = "\n".join(status_messages) + "\n\n" if status_messages else ""
            death_msg += "üíÄ –í—ã –ø–æ–≥–∏–±–ª–∏ –æ—Ç –∏—Å—Ç–æ—â–µ–Ω–∏—è!"
            lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=5, max_money=50)
            loss_lines = format_death_losses(lost_items, money_lost)
            if loss_lines:
                death_msg += "\n" + "\n".join(loss_lines)
            p["death_notified"] = True
            p["state"] = STATE_IN_MENU
            normalize_stats(user_id)
            save_data()
            send_message(user_id, death_msg, create_main_menu_keyboard(user_id), vk_session)
            return
        loc = p["location"]
        mutant = select_mutant(loc, point)
        if not mutant:
            msg = "‚ùå –í —ç—Ç–æ–º –ª–æ–≥–æ–≤–µ –ø—É—Å—Ç–æ..."
            if status_messages:
                msg = "\n".join(status_messages) + "\n\n" + msg
            send_message(user_id, msg, create_main_menu_keyboard(user_id), vk_session)
            return
        p["current_mutant"] = mutant
        p["mutant_hp"] = mutant["hp"]
        weapon_accuracy = get_total_weapon_accuracy(user_id)
        all_buttons = list(range(1, 10))
        if weapon_accuracy > 0:
            valid_targets = random.sample(all_buttons, min(weapon_accuracy, 9))
        else:
            valid_targets = []
        p["valid_targets"] = valid_targets
        p["state"] = STATE_HUNTING
        save_data()
        try:
            upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
            img_path = f"mutants/{mutant['name'].lower().replace(' ', '_').replace('—ë', '–µ')}.png"
            if os.path.exists(img_path):
                with open(img_path, "rb") as f:
                    response = vk_session.http.post(upload_url, files={"photo": f})
                    result = response.json()
                    photo_data = vk_session.method("photos.saveMessagesPhoto", {"photo": result["photo"], "server": result["server"], "hash": result["hash"]})[0]
                    attachment = f"photo{photo_data['owner_id']}_{photo_data['id']}"
            else:
                attachment = None
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –º—É—Ç–∞–Ω—Ç–∞: {e}")
            attachment = None
        accuracy = get_total_weapon_accuracy(user_id)
        weapon_damage = get_total_weapon_damage(user_id)
        weapon_durability = p.get("weapon_durability", 0)
        weapon_max_durability = p.get("weapon_max_durability", 0)
        armor_durability = p.get("armor_durability", 0)
        armor_max_durability = p.get("armor_max_durability", 0)
        player_health = p.get("health", 10)
        blast_resist = get_total_blast_resist(user_id)
        msg_parts = []
        if status_messages:
            msg_parts.extend(status_messages)
            msg_parts.append("")
        msg_parts.append(f"üëπ –í—Å—Ç—Ä–µ—á–µ–Ω –º—É—Ç–∞–Ω—Ç: {mutant['name']}")
        msg_parts.append(f"–•–ü –º—É—Ç–∞–Ω—Ç–∞: {mutant['hp']}/{mutant['hp']}")
        msg_parts.append(f"üí¢ –£—Ä–æ–Ω –º—É—Ç–∞–Ω—Ç–∞: {mutant['damage']}")
        msg_parts.append(f"üí≤ –ù–∞–≥—Ä–∞–¥–∞: {mutant['reward']}—Ä")
        msg_parts.append("")
        msg_parts.append(f"‚ù§Ô∏è –í–∞—à–µ –•–ü: {player_health}/10")
        msg_parts.append(f"üí¢ –í–∞—à —É—Ä–æ–Ω: {weapon_damage}")
        msg_parts.append(f"üéØ –¢–æ—á–Ω–æ—Å—Ç—å: {accuracy}/9")
        msg_parts.append(f"üêæ –†–∞–∑—Ä—ã–≤: {blast_resist}")
        msg_parts.append(f"üîßüî´ –û—Ä—É–∂–∏–µ: {weapon_durability}/{weapon_max_durability}")
        msg_parts.append(f"üîßü¶∫ –ë—Ä–æ–Ω—è: {armor_durability}/{armor_max_durability}")
        msg = "\n".join(msg_parts)
        keyboard = create_hunting_keyboard()
        params = {"user_id": user_id, "message": msg, "random_id": 0, "keyboard": keyboard.get_keyboard()}
        if attachment:
            params["attachment"] = attachment
        vk_session.method("messages.send", params)
        return
    ok, msg = check_vital_conditions(user_id, "–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ")
    if not ok:
        send_message(user_id, msg, create_main_menu_keyboard(user_id), vk_session)
        return
    send_message(user_id, "üîç –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ...", create_empty_keyboard(), vk_session)
    add_territory_exhaustion(location, point)
    increment_emission(vk_session)
    p["stamina"] = max(0, p["stamina"] - 1)
    p["hunger"] = min(10, p["hunger"] + 0.5)
    radiation_gain = get_radiation_gain(ptype)
    result_lines = []
    if radiation_gain > 0:
        p["radiation"] = min(10, p["radiation"] + radiation_gain)
        result_lines.append(f"‚ò¢Ô∏è –í—ã –ø–æ–ø–∞–ª–∏ –ø–æ–¥ –∏–∑–ª—É—á–µ–Ω–∏–µ —Ä–∞–¥–∏–∞—Ü–∏–∏! (+{radiation_gain})")
    status_messages = []
    if p["hunger"] >= 10:
        p["stamina"] = max(0, p["stamina"] - 2)
        p["health"] = max(0, p["health"] - 0.5)
        status_messages.append("üçΩÔ∏è –í—ã –≥–æ–ª–æ–¥–∞–µ—Ç–µ! (-2‚ö°, -0.5‚ù§Ô∏è)")
    if p["radiation"] >= 10:
        rad_damage = random.choice([1, 1.5, 2])
        p["health"] = max(0, p["health"] - rad_damage)
        status_messages.append(f"‚ò¢Ô∏è –†–∞–¥–∏–∞—Ü–∏—è —Ä–∞–∑—ä–µ–¥–∞–µ—Ç –≤–∞—Å! (-{rad_damage}‚ù§Ô∏è)")
    apply_belt_effects_on_exploration(user_id)
    if p["health"] <= 0:
        death_msg = ""
        if status_messages:
            death_msg = "\n".join(status_messages) + "\n\n"
        death_msg += "üíÄ –í—ã –ø–æ–≥–∏–±–ª–∏ –æ—Ç –∏—Å—Ç–æ—â–µ–Ω–∏—è!"
        lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=5, max_money=50)
        loss_lines = format_death_losses(lost_items, money_lost)
        if loss_lines:
            death_msg += "\n" + "\n".join(loss_lines)
        p["death_notified"] = True
        p["state"] = STATE_IN_MENU
        normalize_stats(user_id)
        save_data()
        send_message(user_id, death_msg, create_main_menu_keyboard(user_id), vk_session)
        return
    drops = {}
    if ptype == "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è":
        drops = roll_drops(DROP_T, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è")
        if location == "–ü–æ–ª—è–Ω–∞" and point.startswith("–¢"):
            for item, data in DROP_POLYANA_T.items():
                if random.randint(1, 100) <= data["chance"]:
                    amount = random.randint(data["min"], data["max"])
                    drops[item] = drops.get(item, 0) + amount
    elif ptype == "–¢–æ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤":
        drops = roll_drops(DROP_TR, "–¢–æ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤")
    elif ptype == "–ë–∞–∑–∞":
        drops = roll_drops(DROP_B, "–ë–∞–∑–∞")
    if status_messages:
        result_lines.extend(status_messages)
    for item, amount in drops.items():
        if item == "–î–µ–Ω—å–≥–∏":
            p["money"] = p.get("money", 0) + amount
            result_lines.append(f"üí≤ –ù–∞–π–¥–µ–Ω–æ: {amount}—Ä")
        else:
            p["backpack"][item] = p["backpack"].get(item, 0) + amount
            result_lines.append(f"üì¶ –ù–∞–π–¥–µ–Ω–æ: {item} x{amount}")
    if not drops and not result_lines:
        result_lines.append("üîç –í–∞–º –Ω–µ –≤—ã–ø–∞–ª–æ –Ω–∏—á–µ–≥–æ.")
    save_data()
    send_message(user_id, "\n".join(result_lines), create_main_menu_keyboard(user_id), vk_session)
def init_territory_exhaustion():
    global territory_exhaustion
    territory_exhaustion = {}
    for loc in LOCATIONS:
        territory_exhaustion[loc] = {}
        for point in LOCATIONS[loc]:
            territory_exhaustion[loc][point] = 0
    save_data()
def init_last_stand_mode():
    global players, factions, territory_control, territory_exhaustion, emission_counter
    global last_restored_categories, faction_shared_squads, LAST_STAND_MODE
    global faction_warehouses, faction_warehouse_money, zombie_bot
    LAST_STAND_MODE = True
    territory_control = {}
    territory_exhaustion = {}
    emission_counter = 0
    last_restored_categories = []
    faction_shared_squads = {"üõ°Ô∏è –î–æ–ª–≥": 0, "‚ò¶Ô∏è –ì—Ä–µ—Ö": 0, "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": 0, ZOMBIE_FACTION: 0}
    faction_warehouses = {"üõ°Ô∏è –î–æ–ª–≥": {}, "‚ò¶Ô∏è –ì—Ä–µ—Ö": {}, "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": {}, ZOMBIE_FACTION: {}}
    faction_warehouse_money = {"üõ°Ô∏è –î–æ–ª–≥": 0, "‚ò¶Ô∏è –ì—Ä–µ—Ö": 0, "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": 0, ZOMBIE_FACTION: 0}
    zombie_bot = {"money": 0, "squads": 0, "food_units": 0, "med_units": 0, "rad_units": 0, "last_action_time": 0, "next_action": "", "backpack": {}, "mode": "normal", "priority_target": None, "agro_points": [], "last_attacked_by": None, "pending_target": None, "last_logs": [], "bonus_squads": 0}
    for loc in LOCATIONS:
        territory_control[loc] = {}
        territory_exhaustion[loc] = {}
        for point in LOCATIONS[loc]:
            territory_control[loc][point] = {"faction": None, "squads": 0}
            territory_exhaustion[loc][point] = 0
    territory_control["–ö–æ—Ä–¥–æ–Ω"]["–ë1"] = {"faction": "üõ°Ô∏è –î–æ–ª–≥", "squads": 5}
    territory_control["–ö–æ—Ä–¥–æ–Ω"]["–ë2"] = {"faction": "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏", "squads": 5}
    territory_control["–ö–æ—Ä–¥–æ–Ω"]["–ë3"] = {"faction": "‚ò¶Ô∏è –ì—Ä–µ—Ö", "squads": 5}
    territory_control["–°–≤–∞–ª–∫–∞"]["–ë1"] = {"faction": ZOMBIE_FACTION, "squads": 5}
    territory_control["–ü–æ–ª—è–Ω–∞"]["–ë1"] = {"faction": ZOMBIE_FACTION, "squads": 5}
    territory_control["–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞"]["–ë3"] = {"faction": ZOMBIE_FACTION, "squads": 5}
    for uid, p in players.items():
        faction = p.get("faction")
        if faction and faction in LAST_STAND_START_POSITIONS and faction != ZOMBIE_FACTION:
            start_loc, start_point = LAST_STAND_START_POSITIONS[faction]
            p["location"] = start_loc
            p["point"] = start_point
            p["state"] = STATE_IN_MENU
            p["transition_end_time"] = None
    save_data()
def init_last_stand_mode_v2():
    global players, factions, territory_control, territory_exhaustion, emission_counter
    global last_restored_categories, faction_shared_squads, LAST_STAND_MODE
    global faction_warehouses, faction_warehouse_money, zombie_bot
    LAST_STAND_MODE = True
    territory_control = {}
    territory_exhaustion = {}
    emission_counter = 0
    last_restored_categories = []
    faction_shared_squads = {"üõ°Ô∏è –î–æ–ª–≥": 0, "‚ò¶Ô∏è –ì—Ä–µ—Ö": 0, "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": 0, ZOMBIE_FACTION: 0}
    faction_warehouses = {"üõ°Ô∏è –î–æ–ª–≥": {}, "‚ò¶Ô∏è –ì—Ä–µ—Ö": {}, "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": {}, ZOMBIE_FACTION: {}}
    faction_warehouse_money = {"üõ°Ô∏è –î–æ–ª–≥": 0, "‚ò¶Ô∏è –ì—Ä–µ—Ö": 0, "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏": 0, ZOMBIE_FACTION: 0}
    zombie_bot = {"money": 0, "squads": 85, "food_units": 0, "med_units": 0, "rad_units": 0, "last_action_time": time.time(), "next_action": "–ª—É—Ç–∞–Ω–∏–µ", "backpack": {}, "mode": "normal", "priority_target": None, "agro_points": [], "last_attacked_by": None, "pending_target": None, "last_logs": [], "bonus_squads": 85}
    for loc in LOCATIONS:
        territory_control[loc] = {}
        territory_exhaustion[loc] = {}
        for point in LOCATIONS[loc]:
            territory_control[loc][point] = {"faction": None, "squads": 0}
            territory_exhaustion[loc][point] = 0
    territory_control["–ö–æ—Ä–¥–æ–Ω"]["–ë1"] = {"faction": "üõ°Ô∏è –î–æ–ª–≥", "squads": 5}
    territory_control["–°–≤–∞–ª–∫–∞"]["–ë1"] = {"faction": "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏", "squads": 5}
    territory_control["–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞"]["–ë1"] = {"faction": "‚ò¶Ô∏è –ì—Ä–µ—Ö", "squads": 5}
    territory_control["–ü–æ–ª—è–Ω–∞"]["–ë1"] = {"faction": ZOMBIE_FACTION, "squads": 5}
    for uid, p in players.items():
        faction = p.get("faction")
        if faction == "üõ°Ô∏è –î–æ–ª–≥":
            p["location"] = "–ö–æ—Ä–¥–æ–Ω"
            p["point"] = "–ë1"
        elif faction == "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏":
            p["location"] = "–°–≤–∞–ª–∫–∞"
            p["point"] = "–ë1"
        elif faction == "‚ò¶Ô∏è –ì—Ä–µ—Ö":
            p["location"] = "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞"
            p["point"] = "–ë1"
        if faction and faction != ZOMBIE_FACTION:
            p["state"] = STATE_IN_MENU
            p["transition_end_time"] = None
    save_data()
def get_zombie_controlled_locations():
    controlled = []
    for loc in LOCATIONS:
        for point in LOCATIONS[loc]:
            if get_territory_owner(loc, point) == ZOMBIE_FACTION:
                controlled.append((loc, point))
    return controlled
def get_zombie_available_targets():
    controlled = get_zombie_controlled_locations()
    if not controlled:
        return []
    available_locs = set()
    for loc, point in controlled:
        available_locs.add(loc)
        if (loc, point) in TRANSITION_ROUTES:
            for dest_loc, dest_point in TRANSITION_ROUTES[(loc, point)]:
                available_locs.add(dest_loc)
    targets = []
    for loc in available_locs:
        for point in LOCATIONS[loc]:
            owner = get_territory_owner(loc, point)
            if owner != ZOMBIE_FACTION:
                enemy_squads = get_territory_squads(loc, point)
                ptype = POINT_TYPES.get(point, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è")
                targets.append({"loc": loc, "point": point, "owner": owner, "squads": enemy_squads, "type": ptype})
    random.shuffle(targets)
    return targets
def zombie_loot_territory(loc, point, vk_session):
    global zombie_bot, emission_counter
    ptype = POINT_TYPES.get(point, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è")
    logs = []
    total_money = 0
    total_items = {}
    for _ in range(10):
        if not check_territory_exhaustion(loc, point):
            break
        add_territory_exhaustion(loc, point)
        emission_counter += 1
        if ptype == "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è":
            drops = roll_drops(DROP_T, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è")
        elif ptype == "–¢–æ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤":
            drops = roll_drops(DROP_TR, "–¢–æ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤")
        elif ptype == "–ë–∞–∑–∞":
            drops = roll_drops(DROP_B, "–ë–∞–∑–∞")
        elif ptype == "–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞":
            money_gain = random.randint(10, 30)
            total_money += money_gain
            continue
        elif ptype == "–õ–æ–≥–æ–≤–æ":
            money_gain = random.randint(15, 40)
            total_money += money_gain
            continue
        else:
            drops = roll_drops(DROP_T, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è")
        for item, amount in drops.items():
            if item == "–î–µ–Ω—å–≥–∏":
                total_money += amount
            else:
                total_items[item] = total_items.get(item, 0) + amount
    zombie_bot["money"] += total_money
    for item, amount in total_items.items():
        zombie_bot["backpack"][item] = zombie_bot["backpack"].get(item, 0) + amount
    logs.append(f"üìç {loc} {point}: üí≤{total_money}—Ä")
    if total_items:
        items_str = ", ".join([f"{k} x{v}" for k, v in total_items.items()])
        logs.append(f"   üì¶ {items_str}")
    if emission_counter >= EMISSION_MAX:
        trigger_emission(vk_session)
    save_data()
    return logs
def zombie_convert_items():
    global zombie_bot
    logs = []
    for item_name, conv_data in CONVERSION_VALUES.items():
        count = zombie_bot["backpack"].get(item_name, 0)
        if count > 0:
            if conv_data["type"] == "special":
                med_value = conv_data.get("med", 0) * count
                rad_value = conv_data.get("rad", 0) * count
                zombie_bot["med_units"] += med_value
                zombie_bot["rad_units"] += rad_value
            else:
                unit_type = conv_data["type"]
                unit_value = conv_data["value"] * count
                if unit_type == "food":
                    zombie_bot["food_units"] += unit_value
                elif unit_type == "med":
                    zombie_bot["med_units"] += unit_value
                elif unit_type == "rad":
                    zombie_bot["rad_units"] += unit_value
            del zombie_bot["backpack"][item_name]
            logs.append(f"‚ôªÔ∏è –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: {item_name} x{count}")
    save_data()
    return logs
def zombie_sell_items():
    global zombie_bot
    logs = []
    total_earned = 0
    always_sell = ["—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫ –Ω–æ–Ω—Å—Ç–æ–ø", "—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫ —Å—Ç–∞–ª–∫–µ—Ä", "–≥–µ—Ä–∫—É–ª–µ—Å", "–±–∞—Ç–∞—Ä–µ–π–∫–∏"]
    for item_name in always_sell:
        count = zombie_bot["backpack"].get(item_name, 0)
        if count > 0:
            price = BUY_PRICES.get(item_name, 0) * count
            zombie_bot["money"] += price
            total_earned += price
            logs.append(f"üí∞ {item_name} x{count} = {price}—Ä")
            del zombie_bot["backpack"][item_name]
    for art in ALL_ARTIFACTS:
        count = zombie_bot["backpack"].get(art, 0)
        if count > 0:
            price = ARTIFACT_PRICES.get(art, 15) * count
            zombie_bot["money"] += price
            total_earned += price
            logs.append(f"üí∞ {art} x{count} = {price}—Ä")
            del zombie_bot["backpack"][art]
    max_units = 50
    if zombie_bot["food_units"] > max_units:
        for item_name in ["–∫–æ–Ω—Å–µ—Ä–≤–∞", "–∫–æ–ª–±–∞—Å–∞", "—Ö–ª–µ–±", "—à–æ–∫–æ–ª–∞–¥–Ω—ã–π –±–∞—Ç–æ–Ω—á–∏–∫"]:
            count = zombie_bot["backpack"].get(item_name, 0)
            if count > 0:
                price = BUY_PRICES.get(item_name, 0) * count
                zombie_bot["money"] += price
                total_earned += price
                logs.append(f"üí∞ {item_name} x{count} = {price}—Ä (–∏–∑–ª–∏—à–∫–∏)")
                del zombie_bot["backpack"][item_name]
    if zombie_bot["med_units"] > max_units:
        for item_name in ["–Ω–∞—É—á–Ω–∞—è –∞–ø—Ç–µ—á–∫–∞", "–∞—Ä–º–µ–π—Å–∫–∞—è –∞–ø—Ç–µ—á–∫–∞", "–∞–ø—Ç–µ—á–∫–∞", "–±–∏–Ω—Ç"]:
            count = zombie_bot["backpack"].get(item_name, 0)
            if count > 0:
                price = BUY_PRICES.get(item_name, 0) * count
                zombie_bot["money"] += price
                total_earned += price
                logs.append(f"üí∞ {item_name} x{count} = {price}—Ä (–∏–∑–ª–∏—à–∫–∏)")
                del zombie_bot["backpack"][item_name]
    if zombie_bot["rad_units"] > max_units:
        for item_name in ["–∞–Ω—Ç–∏—Ä–∞–¥", "—Ä–∞–¥–∏–æ–ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä", "–≤–æ–¥–∫–∞", "—Å–∏–≥–∞—Ä–µ—Ç—ã"]:
            count = zombie_bot["backpack"].get(item_name, 0)
            if count > 0:
                price = BUY_PRICES.get(item_name, 0) * count
                zombie_bot["money"] += price
                total_earned += price
                logs.append(f"üí∞ {item_name} x{count} = {price}—Ä (–∏–∑–ª–∏—à–∫–∏)")
                del zombie_bot["backpack"][item_name]
    if total_earned > 0:
        logs.insert(0, f"üí≤ –ü—Ä–æ–¥–∞–Ω–æ –Ω–∞ {total_earned}—Ä:")
    save_data()
    return logs
def zombie_buy_squads():
    global zombie_bot
    logs = []
    bought = 0
    while True:
        can_buy_5 = (zombie_bot["money"] >= 500 and zombie_bot["food_units"] >= 15 and zombie_bot["med_units"] >= 15 and zombie_bot["rad_units"] >= 15)
        can_buy_3 = (zombie_bot["money"] >= 300 and zombie_bot["food_units"] >= 10 and zombie_bot["med_units"] >= 10 and zombie_bot["rad_units"] >= 10)
        can_buy_1 = (zombie_bot["money"] >= 100 and zombie_bot["food_units"] >= 5 and zombie_bot["med_units"] >= 5 and zombie_bot["rad_units"] >= 5)
        if can_buy_5:
            zombie_bot["money"] -= 500
            zombie_bot["food_units"] -= 15
            zombie_bot["med_units"] -= 15
            zombie_bot["rad_units"] -= 15
            zombie_bot["squads"] += 5
            bought += 5
        elif can_buy_3:
            zombie_bot["money"] -= 300
            zombie_bot["food_units"] -= 10
            zombie_bot["med_units"] -= 10
            zombie_bot["rad_units"] -= 10
            zombie_bot["squads"] += 3
            bought += 3
        elif can_buy_1:
            zombie_bot["money"] -= 100
            zombie_bot["food_units"] -= 5
            zombie_bot["med_units"] -= 5
            zombie_bot["rad_units"] -= 5
            zombie_bot["squads"] += 1
            bought += 1
        else:
            break
    if bought > 0:
        logs.append(f"üë®‚Äçüë®‚Äçüë¶‚Äçüë¶ –ö—É–ø–ª–µ–Ω–æ —Å–∫–≤–∞–¥–æ–≤: {bought} (–≤—Å–µ–≥–æ: {zombie_bot['squads']})")
    save_data()
    return logs
def zombie_choose_target():
    global zombie_bot
    agro_points = zombie_bot.get("agro_points", [])
    for ap in agro_points:
        if isinstance(ap, tuple):
            loc, point = ap[0], ap[1]
            attacker = None
        else:
            loc, point = ap["loc"], ap["point"]
            attacker = ap.get("attacker")
        owner = get_territory_owner(loc, point)
        if owner != ZOMBIE_FACTION:
            enemy_squads = get_territory_squads(loc, point)
            ptype = POINT_TYPES.get(point, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è")
            min_needed = MIN_SQUADS_FOR_POINT.get(ptype, 1)
            squads_needed = max(min_needed, enemy_squads + random.randint(3, 6))
            if zombie_bot["squads"] >= squads_needed:
                return loc, point, squads_needed
            else:
                zombie_bot["pending_target"] = (loc, point, squads_needed)
                return None, None, 0
    revenge_target = zombie_bot.get("revenge_target")
    if revenge_target:
        targets = get_zombie_available_targets()
        revenge_targets = [t for t in targets if t["owner"] == revenge_target]
        if revenge_targets:
            random.shuffle(revenge_targets)
            for target in revenge_targets:
                loc, point = target["loc"], target["point"]
                enemy_squads = target["squads"]
                ptype = target["type"]
                min_needed = MIN_SQUADS_FOR_POINT.get(ptype, 1)
                squads_needed = max(min_needed, enemy_squads + random.randint(2, 5))
                if zombie_bot["squads"] >= squads_needed:
                    zombie_bot["revenge_target"] = None
                    return loc, point, squads_needed
    priority = zombie_bot.get("priority_target")
    if priority:
        loc, point = priority
        current_owner = get_territory_owner(loc, point)
        if current_owner != ZOMBIE_FACTION:
            controlled = get_zombie_controlled_locations()
            can_reach = False
            for cloc, cpoint in controlled:
                if cloc == loc:
                    can_reach = True
                    break
                if (cloc, cpoint) in TRANSITION_ROUTES:
                    for dest_loc, dest_point in TRANSITION_ROUTES[(cloc, cpoint)]:
                        if dest_loc == loc:
                            can_reach = True
                            break
            if can_reach:
                enemy_squads = get_territory_squads(loc, point)
                ptype = POINT_TYPES.get(point, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è")
                min_needed = MIN_SQUADS_FOR_POINT.get(ptype, 1)
                squads_needed = max(min_needed, enemy_squads + random.randint(2, 5))
                if zombie_bot["squads"] >= squads_needed:
                    return loc, point, squads_needed
                else:
                    zombie_bot["pending_target"] = (loc, point, squads_needed)
                    return None, None, 0
            else:
                for cloc, cpoint in controlled:
                    if (cloc, cpoint) in TRANSITION_ROUTES:
                        for dest_loc, dest_point in TRANSITION_ROUTES[(cloc, cpoint)]:
                            if dest_loc == loc:
                                if get_territory_owner(dest_loc, dest_point) != ZOMBIE_FACTION:
                                    enemy_squads = get_territory_squads(dest_loc, dest_point)
                                    ptype = POINT_TYPES.get(dest_point, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è")
                                    min_needed = MIN_SQUADS_FOR_POINT.get(ptype, 1)
                                    squads_needed = max(min_needed, enemy_squads + 3)
                                    if zombie_bot["squads"] >= squads_needed:
                                        return dest_loc, dest_point, squads_needed
    pending = zombie_bot.get("pending_target")
    if pending:
        loc, point, squads_needed = pending
        if get_territory_owner(loc, point) == ZOMBIE_FACTION:
            zombie_bot["pending_target"] = None
        elif zombie_bot["squads"] >= squads_needed:
            zombie_bot["pending_target"] = None
            return loc, point, squads_needed
        else:
            return None, None, 0
    targets = get_zombie_available_targets()
    if not targets:
        return None, None, 0
    valid_targets = [t for t in targets if t["owner"] != ZOMBIE_FACTION]
    if not valid_targets:
        return None, None, 0
    selected = random.choice(valid_targets)
    loc, point = selected["loc"], selected["point"]
    owner = selected["owner"]
    enemy_squads = selected["squads"]
    ptype = selected["type"]
    min_needed = MIN_SQUADS_FOR_POINT.get(ptype, 1)
    if owner is None:
        squads_needed = min_needed
    else:
        squads_needed = max(min_needed, enemy_squads + random.randint(1, 4))
    if zombie_bot["squads"] >= squads_needed:
        return loc, point, squads_needed
    else:
        zombie_bot["pending_target"] = (loc, point, squads_needed)
        return None, None, 0
def zombie_attack(loc, point, squad_count, vk_session):
    global zombie_bot, territory_control
    logs = []
    owner = get_territory_owner(loc, point)
    if owner == ZOMBIE_FACTION:
        logs.append(f"‚ÑπÔ∏è {loc} {point} —É–∂–µ –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –∑–æ–º–±–∏")
        return logs
    enemy_squads = get_territory_squads(loc, point)
    ptype = POINT_TYPES.get(point, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è")
    min_needed = MIN_SQUADS_FOR_POINT.get(ptype, 1)
    if owner is None:
        set_territory_control(loc, point, ZOMBIE_FACTION, squad_count)
        zombie_bot["squads"] -= squad_count
        logs.append(f"‚úÖ –ó–∞—Ö–≤–∞—á–µ–Ω–æ: {loc} {point} ({squad_count} —Å–∫–≤–∞–¥–æ–≤)")
        try:
            vk_session.method("messages.send", {"peer_id": GAME_CHAT_ID, "message": f"üßü –ó–æ–º–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞—Ö–≤–∞—Ç–∏–ª–∏ {loc} {point}!", "random_id": 0})
        except:
            pass
        save_data()
        return logs
    if owner and owner != ZOMBIE_FACTION:
        leader = get_faction_leader(owner)
        if leader and leader in players:
            send_message(leader, f"‚ö†Ô∏è –ó–æ–º–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞—Ç–∞–∫—É—é—Ç {loc} {point} —Å–∏–ª–∞–º–∏ {squad_count} —Å–∫–≤–∞–¥–æ–≤!", None, vk_session)
    defenders = get_players_on_territory(loc, point)
    defender_players = [uid for uid in defenders if uid in players and players[uid].get("faction") == owner and players[uid].get("health", 0) > 0]
    if defender_players:
        damage_per_player = squad_count / max(1, len(defender_players))
        for def_id in defender_players:
            p = players[def_id]
            bullet_resist = get_player_bullet_resist(def_id)
            actual_damage = max(0.5, damage_per_player - bullet_resist)
            p["health"] = max(0, p["health"] - actual_damage)
            send_message(def_id, f"‚öîÔ∏è –ó–æ–º–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞—Ç–∞–∫—É—é—Ç {loc} {point}!\nüíî –ü–æ–ª—É—á–µ–Ω–æ {actual_damage} —É—Ä–æ–Ω–∞ –æ—Ç –∞—Ç–∞–∫–∏.", None, vk_session)
            if random.randint(1, 100) <= 30:
                if p.get("armor") and p.get("armor_durability", 0) > 0:
                    p["armor_durability"] = max(0, p["armor_durability"] - 1)
                    send_message(def_id, "üîß –ë—Ä–æ–Ω—è –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ (-1)!", None, vk_session)
            if p["health"] <= 0:
                p["death_notified"] = True
                lost_items, money_lost = calculate_and_apply_death_losses(def_id, max_items=10, max_money=100)
                for item, count in lost_items.items():
                    zombie_bot["backpack"][item] = zombie_bot["backpack"].get(item, 0) + count
                zombie_bot["money"] += money_lost
                msg_lines = ["üíÄ –í—ã –ø–æ–≥–∏–±–ª–∏ –æ—Ç –∞—Ç–∞–∫–∏ –∑–æ–º–±–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö!"]
                msg_lines.extend(format_death_losses(lost_items, money_lost))
                new_loc, new_point = find_nearest_faction_territory(def_id)
                if new_loc and new_point:
                    p["location"] = new_loc
                    p["point"] = new_point
                    msg_lines.append(f"\nüìç –í—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –Ω–∞ {new_loc} {new_point}")
                send_message(def_id, "\n".join(msg_lines), create_main_menu_keyboard(def_id), vk_session)
                logs.append(f"üíÄ –£–±–∏—Ç –∏–≥—Ä–æ–∫: {p.get('nickname', '?')}")
    remaining_after_battle = squad_count - enemy_squads
    if remaining_after_battle >= min_needed:
        set_territory_control(loc, point, ZOMBIE_FACTION, remaining_after_battle)
        zombie_bot["squads"] -= squad_count
        logs.append(f"‚öîÔ∏è –ê—Ç–∞–∫–∞: {loc} {point} vs {owner}")
        logs.append(f"‚úÖ –ó–∞—Ö–≤–∞—á–µ–Ω–æ! –ü–æ—Ç–µ—Ä–∏: {enemy_squads}, —Ä–∞–∑–º–µ—â–µ–Ω–æ: {remaining_after_battle}")
        try:
            vk_session.method("messages.send", {"peer_id": GAME_CHAT_ID, "message": f"üßü –ó–æ–º–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞—Ö–≤–∞—Ç–∏–ª–∏ {loc} {point} —É {owner}!", "random_id": 0})
        except:
            pass
        if leader and leader in players:
            send_message(leader, f"üíÄ –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è {loc} {point} –∑–∞—Ö–≤–∞—á–µ–Ω–∞ –∑–æ–º–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏!", None, vk_session)
        for def_id in defender_players:
            if players[def_id].get("health", 0) > 0:
                new_loc, new_point = find_nearest_faction_territory(def_id)
                if new_loc and new_point:
                    players[def_id]["location"] = new_loc
                    players[def_id]["point"] = new_point
                    send_message(def_id, f"üìç –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –ø–æ—Ç–µ—Ä—è–Ω–∞. –í—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –Ω–∞ {new_loc} {new_point}", create_main_menu_keyboard(def_id), vk_session)
    elif remaining_after_battle > 0:
        set_territory_control(loc, point, None, 0)
        zombie_bot["squads"] -= squad_count
        logs.append(f"‚öîÔ∏è –ê—Ç–∞–∫–∞: {loc} {point} vs {owner}")
        logs.append(f"‚ö†Ô∏è –¢–æ—á–∫–∞ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∞, –Ω–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —É–¥–µ—Ä–∂–∞–Ω–∏—è")
    else:
        territory_control[loc][point]["squads"] = max(0, enemy_squads - squad_count)
        zombie_bot["squads"] -= squad_count
        logs.append(f"‚öîÔ∏è –ê—Ç–∞–∫–∞: {loc} {point} vs {owner}")
        logs.append(f"‚ùå –ê—Ç–∞–∫–∞ –æ—Ç–±–∏—Ç–∞. –ü–æ—Ç–µ—Ä—è–Ω–æ: {squad_count}")
    save_data()
    return logs
def zombie_territory_attacked(location, point, attacker_faction, vk_session):
    global zombie_bot
    agro_entry = {"loc": location, "point": point, "attacker": attacker_faction, "time": time.time(), "reinforced": False}
    agro_points = zombie_bot.get("agro_points", [])
    exists = False
    for i, ap in enumerate(agro_points):
        if isinstance(ap, dict) and ap.get("loc") == location and ap.get("point") == point:
            agro_points[i] = agro_entry
            exists = True
            break
        elif isinstance(ap, tuple) and ap[0] == location and ap[1] == point:
            agro_points[i] = agro_entry
            exists = True
            break
    if not exists:
        agro_points.append(agro_entry)
    zombie_bot["agro_points"] = agro_points
    zombie_bot["last_attacked_by"] = attacker_faction
    save_data()
    try:
        send_message(353430025, f"üö® –ê–ì–†–û! {attacker_faction} –∞—Ç–∞–∫–æ–≤–∞–ª {location} {point}!", None, vk_session)
    except:
        pass
def zombie_reinforce():
    global zombie_bot, territory_control
    logs = []
    agro_points = zombie_bot.get("agro_points", [])
    new_agro_points = []
    for ap in agro_points:
        if isinstance(ap, tuple):
            ap = {"loc": ap[0], "point": ap[1], "attacker": None, "time": time.time(), "reinforced": False}
        loc, point = ap["loc"], ap["point"]
        owner = get_territory_owner(loc, point)
        if owner != ZOMBIE_FACTION:
            new_agro_points.append(ap)
            continue
        current_squads = get_territory_squads(loc, point)
        if current_squads >= 10:
            ap["reinforced"] = True
            if ap.get("attacker"):
                zombie_bot["revenge_target"] = ap["attacker"]
                logs.append(f"üò° –ú–µ—Å—Ç—å: –∏—â–µ–º —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ {ap['attacker']}")
            continue
        reinforce_amount = min(random.randint(3, 6), zombie_bot["squads"])
        if reinforce_amount > 0:
            territory_control[loc][point]["squads"] += reinforce_amount
            zombie_bot["squads"] -= reinforce_amount
            logs.append(f"üõ°Ô∏è –ê–≥—Ä–æ-—É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ: {loc} {point} +{reinforce_amount} (—Ç–µ–ø–µ—Ä—å {current_squads + reinforce_amount})")
            new_agro_points.append(ap)
    zombie_bot["agro_points"] = new_agro_points
    controlled = get_zombie_controlled_locations()
    weak_points = []
    for loc, point in controlled:
        is_agro = any((isinstance(ap, dict) and ap.get("loc") == loc and ap.get("point") == point) or (isinstance(ap, tuple) and ap[0] == loc and ap[1] == point) for ap in new_agro_points)
        if is_agro:
            continue
        current_squads = get_territory_squads(loc, point)
        ptype = POINT_TYPES.get(point, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è")
        min_needed = MIN_SQUADS_FOR_POINT.get(ptype, 1)
        if current_squads < min_needed + 1:
            weak_points.append((loc, point, current_squads, min_needed))
    random.shuffle(weak_points)
    for loc, point, current, min_needed in weak_points[:2]:
        needed = random.randint(1, 3)
        if zombie_bot["squads"] >= needed:
            territory_control[loc][point]["squads"] += needed
            zombie_bot["squads"] -= needed
            logs.append(f"üõ°Ô∏è –£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ: {loc} {point} +{needed} —Å–∫–≤–∞–¥–æ–≤")
    save_data()
    return logs
def zombie_take_action(vk_session):
    global zombie_bot
    phase = get_zombie_phase()
    strength = get_zombie_strength()
    logs = ["üßü === –î–ï–ô–°–¢–í–ò–Ø –ó–û–ú–ë–ò–†–û–í–ê–ù–ù–´–• ==="]
    logs.append(f"‚è∞ {time.strftime('%H:%M:%S')}")
    logs.append(f"üí™ –°–∏–ª–∞: {strength} | –§–∞–∑–∞: {phase['name']}")
    logs.append("")
    agro_points = zombie_bot.get("agro_points", [])
    if agro_points:
        logs.append("üò° –ê–ì–†–û-–¢–û–ß–ö–ò:")
        for ap in agro_points:
            if isinstance(ap, dict):
                loc, point = ap["loc"], ap["point"]
                attacker = ap.get("attacker", "?")
                owner = get_territory_owner(loc, point)
                status = "‚úÖ –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º" if owner == ZOMBIE_FACTION else f"‚ùå —É {owner}"
                squads = get_territory_squads(loc, point) if owner == ZOMBIE_FACTION else 0
                logs.append(f"   {loc} {point} (–æ—Ç {attacker}) - {status}, {squads} —Å–∫–≤–∞–¥–æ–≤")
        logs.append("")
    revenge = zombie_bot.get("revenge_target")
    if revenge:
        logs.append(f"üî• –¶–ï–õ–¨ –ú–ï–°–¢–ò: {revenge}")
        logs.append("")
    controlled = get_zombie_controlled_locations()
    loot_points = []
    for loc, point in controlled:
        if check_territory_exhaustion(loc, point):
            loot_points.append((loc, point))
    random.shuffle(loot_points)
    territories_to_loot = phase["territories"]
    loot_times = phase["loot_times"]
    loot_points = loot_points[:territories_to_loot]
    logs.append(f"üì¶ –õ–£–¢–ê–ù–ò–ï ({territories_to_loot} —Ç–æ—á–µ–∫ –ø–æ {loot_times} —Ä–∞–∑):")
    if loot_points:
        for loc, point in loot_points:
            loot_logs = zombie_loot_territory_custom(loc, point, loot_times, vk_session)
            logs.extend(loot_logs)
    else:
        logs.append("   –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–æ—á–µ–∫")
        if zombie_bot.get("mode") == "loot":
            zombie_bot["mode"] = "normal"
            logs.append("   ‚ö†Ô∏è –†–µ–∂–∏–º —Å–º–µ–Ω—ë–Ω –Ω–∞ –æ–±—ã—á–Ω—ã–π")
    logs.append("")
    logs.append("üí∞ –ü–†–û–î–ê–ñ–ê:")
    sell_logs = zombie_sell_items()
    if sell_logs:
        logs.extend(sell_logs)
    else:
        logs.append("   –ù–µ—á–µ–≥–æ –ø—Ä–æ–¥–∞–≤–∞—Ç—å")
    logs.append("")
    logs.append("‚ôªÔ∏è –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø:")
    conv_logs = zombie_convert_items()
    if conv_logs:
        logs.extend(conv_logs)
    else:
        logs.append("   –ù–µ—á–µ–≥–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å")
    logs.append("")
    logs.append("üí≤ –ü–û–ö–£–ü–ö–ê –°–ö–í–ê–î–û–í:")
    buy_logs = zombie_buy_squads()
    if buy_logs:
        logs.extend(buy_logs)
    else:
        logs.append("   –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤")
    logs.append("")
    logs.append("üõ°Ô∏è –£–ö–†–ï–ü–õ–ï–ù–ò–ï:")
    reinforce_logs = zombie_reinforce()
    if reinforce_logs:
        logs.extend(reinforce_logs)
    else:
        logs.append("   –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è")
    priority = zombie_bot.get("priority_target")
    if priority:
        loc, point = priority
        if get_territory_owner(loc, point) == ZOMBIE_FACTION:
            current_squads = get_territory_squads(loc, point)
            reinforce = min(random.randint(2, 5), zombie_bot["squads"])
            if reinforce > 0 and current_squads < 15:
                territory_control[loc][point]["squads"] += reinforce
                zombie_bot["squads"] -= reinforce
                logs.append(f"üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É–∫—Ä–µ–ø–ª—ë–Ω: {loc} {point} +{reinforce} (—Ç–µ–ø–µ—Ä—å {current_squads + reinforce})")
    logs.append("")
    mode = zombie_bot.get("mode", "normal")
    if mode == "aggressive" or mode == "normal":
        logs.append("‚öîÔ∏è –ê–¢–ê–ö–ê:")
        pending = zombie_bot.get("pending_target")
        if pending:
            p_loc, p_point, p_squads = pending
            if get_territory_owner(p_loc, p_point) == ZOMBIE_FACTION:
                zombie_bot["pending_target"] = None
                logs.append(f"   ‚úÖ –¶–µ–ª—å {p_loc} {p_point} —É–∂–µ –∑–∞—Ö–≤–∞—á–µ–Ω–∞")
            else:
                logs.append(f"   ‚è≥ –ö–æ–ø–∏–º —Å–∫–≤–∞–¥—ã –¥–ª—è: {p_loc} {p_point} (–Ω—É–∂–Ω–æ {p_squads}, –µ—Å—Ç—å {zombie_bot['squads']})")
        if zombie_bot["squads"] >= 1:
            target_loc, target_point, squads_to_send = zombie_choose_target()
            if target_loc:
                target_owner = get_territory_owner(target_loc, target_point)
                if target_owner == ZOMBIE_FACTION:
                    logs.append(f"   ‚ÑπÔ∏è {target_loc} {target_point} —É–∂–µ –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º")
                else:
                    attack_logs = zombie_attack(target_loc, target_point, squads_to_send, vk_session)
                    logs.extend(attack_logs)
            else:
                if not pending or get_territory_owner(pending[0], pending[1]) == ZOMBIE_FACTION:
                    logs.append("   –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ü–µ–ª–µ–π –∏–ª–∏ –∫–æ–ø–∏–º —Å–∏–ª—ã")
        else:
            logs.append("   –ù–µ—Ç —Å–∫–≤–∞–¥–æ–≤")
    elif mode == "loot":
        logs.append("‚öîÔ∏è –ê–¢–ê–ö–ê: –†–µ–∂–∏–º –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è, –∞—Ç–∞–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã")
    logs.append("")
    logs.append(f"üìä –ò–¢–û–ì–û:")
    logs.append(f"   üí≤ {zombie_bot['money']}—Ä")
    logs.append(f"   üë®‚Äçüë®‚Äçüë¶‚Äçüë¶ {zombie_bot['squads']} —Å–∫–≤–∞–¥–æ–≤")
    logs.append(f"   üçñ {zombie_bot['food_units']} üè• {zombie_bot['med_units']} ‚ò¢Ô∏è {zombie_bot['rad_units']}")
    logs.append(f"   üéØ –†–µ–∂–∏–º: {mode}")
    if priority:
        owner = get_territory_owner(priority[0], priority[1])
        status = "‚úÖ –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º" if owner == ZOMBIE_FACTION else f"‚öîÔ∏è —É {owner if owner else '–Ω–µ–π—Ç—Ä–∞–ª'}"
        logs.append(f"   üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {priority[0]} {priority[1]} ({status})")
    next_target = zombie_choose_target()
    if next_target[0]:
        zombie_bot["next_action"] = f"–∞—Ç–∞–∫–∞ {next_target[0]} {next_target[1]} ({next_target[2]} —Å–∫–≤–∞–¥–æ–≤)"
    elif zombie_bot.get("pending_target"):
        p = zombie_bot["pending_target"]
        if get_territory_owner(p[0], p[1]) != ZOMBIE_FACTION:
            zombie_bot["next_action"] = f"–Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –¥–ª—è {p[0]} {p[1]} ({p[2]} —Å–∫–≤–∞–¥–æ–≤)"
        else:
            zombie_bot["pending_target"] = None
            zombie_bot["next_action"] = "–ø–æ–∏—Å–∫ –Ω–æ–≤–æ–π —Ü–µ–ª–∏"
    else:
        zombie_bot["next_action"] = "–ª—É—Ç–∞–Ω–∏–µ –∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ"
    zombie_bot["last_action_time"] = time.time()
    zombie_bot["last_logs"] = logs.copy()
    save_data()
    try:
        send_message(353430025, "\n".join(logs), None, vk_session)
    except:
        pass
    return logs
def zombie_loot_territory_custom(loc, point, times, vk_session):
    global zombie_bot, emission_counter
    ptype = POINT_TYPES.get(point, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è")
    logs = []
    total_money = 0
    total_items = {}
    for _ in range(times):
        if not check_territory_exhaustion(loc, point):
            break
        add_territory_exhaustion(loc, point)
        emission_counter += 1
        if ptype == "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è":
            drops = roll_drops(DROP_T, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è")
        elif ptype == "–¢–æ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤":
            drops = roll_drops(DROP_TR, "–¢–æ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤")
        elif ptype == "–ë–∞–∑–∞":
            drops = roll_drops(DROP_B, "–ë–∞–∑–∞")
        elif ptype == "–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞":
            money_gain = random.randint(10, 30)
            total_money += money_gain
            continue
        elif ptype == "–õ–æ–≥–æ–≤–æ":
            money_gain = random.randint(15, 40)
            total_money += money_gain
            continue
        else:
            drops = roll_drops(DROP_T, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è")
        for item, amount in drops.items():
            if item == "–î–µ–Ω—å–≥–∏":
                total_money += amount
            else:
                total_items[item] = total_items.get(item, 0) + amount
    zombie_bot["money"] += total_money
    for item, amount in total_items.items():
        zombie_bot["backpack"][item] = zombie_bot["backpack"].get(item, 0) + amount
    logs.append(f"üìç {loc} {point}: üí≤{total_money}—Ä")
    if total_items:
        items_str = ", ".join([f"{k} x{v}" for k, v in list(total_items.items())[:5]])
        logs.append(f"   üì¶ {items_str}")
    if emission_counter >= EMISSION_MAX:
        trigger_emission(vk_session)
    save_data()
    return logs
def get_zombie_status():
    controlled = get_zombie_controlled_locations()
    strength = get_zombie_strength()
    phase = get_zombie_phase()
    next_action_time = zombie_bot.get("last_action_time", 0) + ZOMBIE_ACTION_INTERVAL
    remaining = max(0, next_action_time - time.time())
    mins = int(remaining // 60)
    secs = int(remaining % 60)
    lines = ["üßü === –°–¢–ê–¢–£–° –ó–û–ú–ë–ò–†–û–í–ê–ù–ù–´–• ===", ""]
    lines.append(f"üí™ –°–∏–ª–∞: {strength} | –§–∞–∑–∞: {phase['name']}")
    lines.append(f"üí≤ –î–µ–Ω—å–≥–∏: {zombie_bot['money']}—Ä")
    lines.append(f"üë®‚Äçüë®‚Äçüë¶‚Äçüë¶ –°–∫–≤–∞–¥—ã: {zombie_bot['squads']} (–±–æ–Ω—É—Å: {zombie_bot.get('bonus_squads', 0)})")
    lines.append(f"üçñ –ï–¥–∞: {zombie_bot['food_units']}")
    lines.append(f"üè• –ú–µ–¥: {zombie_bot['med_units']}")
    lines.append(f"‚ò¢Ô∏è –†–∞–¥: {zombie_bot['rad_units']}")
    lines.append(f"üéØ –†–µ–∂–∏–º: {zombie_bot.get('mode', 'normal')}")
    lines.append("")
    agro_points = zombie_bot.get("agro_points", [])
    if agro_points:
        lines.append("üò° –ê–ì–†–û-–¢–û–ß–ö–ò:")
        for ap in agro_points:
            if isinstance(ap, dict):
                loc, point = ap["loc"], ap["point"]
                attacker = ap.get("attacker", "?")
                owner = get_territory_owner(loc, point)
                status = "‚úÖ" if owner == ZOMBIE_FACTION else "‚ùå"
                lines.append(f"   {status} {loc} {point} (–æ—Ç {attacker})")
        lines.append("")
    revenge = zombie_bot.get("revenge_target")
    if revenge:
        lines.append(f"üî• –¶–ï–õ–¨ –ú–ï–°–¢–ò: {revenge}")
        lines.append("")
    priority = zombie_bot.get("priority_target")
    if priority:
        owner = get_territory_owner(priority[0], priority[1])
        status = "‚úÖ –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º" if owner == ZOMBIE_FACTION else f"‚öîÔ∏è —É {owner}"
        lines.append(f"üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {priority[0]} {priority[1]} ({status})")
    pending = zombie_bot.get("pending_target")
    if pending:
        lines.append(f"‚è≥ –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –¥–ª—è: {pending[0]} {pending[1]} (–Ω—É–∂–Ω–æ {pending[2]})")
    lines.append("")
    lines.append("üó∫Ô∏è –ö–û–ù–¢–†–û–õ–ò–†–£–ï–ú–´–ï –¢–û–ß–ö–ò:")
    for loc, point in controlled:
        squads = get_territory_squads(loc, point)
        ptype = POINT_TYPES.get(point, "?")
        lines.append(f"   {loc} {point} ({ptype}): {squads} —Å–∫–≤–∞–¥–æ–≤")
    lines.append("")
    lines.append(f"‚è±Ô∏è –î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è: {mins} –º–∏–Ω {secs} —Å–µ–∫")
    lines.append(f"üìã –ü–ª–∞–Ω–∏—Ä—É–µ–º–æ–µ: {zombie_bot.get('next_action', '?')}")
    lines.append("")
    lines.append("üìú –ü–û–°–õ–ï–î–ù–ò–ï –î–ï–ô–°–¢–í–ò–Ø:")
    last_logs = zombie_bot.get("last_logs", [])
    if last_logs:
        for log in last_logs[-20:]:
            lines.append(log)
    else:
        lines.append("   –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö")
    return "\n".join(lines)
def get_zombie_strength():
    controlled = get_zombie_controlled_locations()
    total_strength = 0
    for loc, point in controlled:
        ptype = POINT_TYPES.get(point, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è")
        total_strength += POINT_STRENGTH.get(ptype, 1)
    return total_strength
def get_zombie_phase():
    strength = get_zombie_strength()
    current_phase = None
    for min_strength, phase_data in sorted(ZOMBIE_PHASES.items()):
        if strength >= min_strength:
            current_phase = phase_data
    if current_phase is None:
        current_phase = ZOMBIE_PHASES[15]
    return current_phase
def find_nearest_faction_territory(user_id):
    p = players[user_id]
    faction = p.get("faction")
    current_loc = p.get("location")
    priority_types = ["–ë–∞–∑–∞", "–¢–æ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤", "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è", "–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞", "–õ–æ–≥–æ–≤–æ"]
    for ptype in priority_types:
        for point in LOCATIONS.get(current_loc, []):
            if POINT_TYPES.get(point) == ptype:
                if get_territory_owner(current_loc, point) == faction:
                    return current_loc, point
    for loc in LOCATIONS:
        for ptype in priority_types:
            for point in LOCATIONS.get(loc, []):
                if POINT_TYPES.get(point) == ptype:
                    if get_territory_owner(loc, point) == faction:
                        return loc, point
    return None, None
def get_emission_status():
    global emission_counter, EMISSION_MAX
    ratio = emission_counter / EMISSION_MAX
    if ratio < 0.2:
        return "üü¢"
    elif ratio < 0.4:
        return "üü°"
    elif ratio < 0.6:
        return "üü†"
    elif ratio < 0.8:
        return "üî¥"
    elif ratio < 0.957:
        return "‚ö´"
    else:
        return "‚ò†Ô∏è"
def increment_emission(vk_session):
    global emission_counter, last_restored_categories
    emission_counter += 1
    warning_threshold = int(EMISSION_MAX * 0.75)
    if emission_counter == warning_threshold:
        for uid in players:
            if uid in banned_users:
                continue
            p = players[uid]
            faction = p.get("faction")
            if not faction or faction == "None" or faction is None:
                continue
            state = p.get("state")
            if state in [STATE_WAITING_FOR_START, STATE_READING_INSTRUCTIONS, STATE_CHOOSING_FACTION, STATE_ENTERING_NICKNAME]:
                continue
            send_message(uid, "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –ü—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è –≤—ã–±—Ä–æ—Å! –£–∫—Ä–æ–π—Ç–µ—Å—å –≤ –ª–∞–≥–µ—Ä–µ!", None, vk_session)
    if emission_counter >= EMISSION_MAX:
        trigger_emission(vk_session)
    save_data()
def trigger_emission(vk_session):
    global emission_counter, last_restored_categories, territory_exhaustion
    categories = ["–ë–∞–∑–∞", "–¢–æ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤", "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è", "–õ–æ–≥–æ–≤–æ", "–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞"]
    num_categories = random.choice([1, 2])
    restored = random.sample(categories, num_categories)
    last_restored_categories = restored
    for loc in LOCATIONS:
        for point in LOCATIONS[loc]:
            ptype = POINT_TYPES.get(point, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è")
            if ptype in restored:
                territory_exhaustion[loc][point] = 0
    safe_states = [STATE_IN_CAMP, STATE_IN_BACKPACK, STATE_RESTING, STATE_USING_ITEM, STATE_BELT_MAIN, STATE_BELT_SELECT_SLOT, STATE_BELT_SELECT_ARTIFACT, STATE_BELT_EQUIP, STATE_BELT_UNEQUIP]
    dead_players = []
    for uid, p in players.items():
        if uid in banned_users:
            continue
        faction = p.get("faction")
        if not faction or faction == "None" or faction is None:
            continue
        state = p.get("state")
        if state in [STATE_WAITING_FOR_START, STATE_READING_INSTRUCTIONS, STATE_CHOOSING_FACTION, STATE_ENTERING_NICKNAME]:
            continue
        if state not in safe_states:
            if state == STATE_TRANSITION_WAIT:
                p["transition_end_time"] = None
                if p.get("previous_location") and p.get("previous_point"):
                    p["location"] = p["previous_location"]
                    p["point"] = p["previous_point"]
                p["previous_location"] = None
                p["previous_point"] = None
                p["state"] = STATE_IN_MENU
            elif state in [STATE_HUNTING, STATE_HUNTING_SHOOTING, STATE_ANOMALY_EXPLORE]:
                p["state"] = STATE_IN_MENU
                p["artifact_positions"] = []
                p["anomaly_positions"] = []
                p["hidden_anomaly_positions"] = []
                p["current_mutant"] = None
                p["mutant_hp"] = None
                p["anomaly_path_choosing"] = False
            p["health"] = 0
            p["hunger"] = 10
            p["radiation"] = 10
            p["death_notified"] = True
            nickname = p.get("nickname", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π")
            location = p.get("location", "?")
            point = p.get("point", "?")
            if faction != ZOMBIE_FACTION:
                dead_players.append(f"‚Ä¢ {nickname} ({faction}) ‚Äî {location} {point}")
            send_message(uid, "‚ò†Ô∏è –í—ã –ø–æ–≥–∏–±–ª–∏ –æ—Ç –≤—ã–±—Ä–æ—Å–∞! –ù—É–∂–Ω–æ –±—ã–ª–æ —É–∫—Ä—ã—Ç—å—Å—è –≤ –ª–∞–≥–µ—Ä–µ!", None, vk_session)
    emission_counter = 0
    restored_text = ", ".join(restored)
    for uid, p in players.items():
        if uid in banned_users:
            continue
        faction = p.get("faction")
        if not faction or faction == "None" or faction is None:
            continue
        state = p.get("state")
        if state in [STATE_WAITING_FOR_START, STATE_READING_INSTRUCTIONS, STATE_CHOOSING_FACTION, STATE_ENTERING_NICKNAME]:
            continue
        send_message(uid, f"‚ò¢Ô∏è –í—ã–±—Ä–æ—Å –∑–∞–≤–µ—Ä—à—ë–Ω!\n‚ôªÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã: {restored_text}", None, vk_session)
    if dead_players and GAME_CHAT_ID:
        dead_list = "\n".join(dead_players)
        chat_msg = f"‚ò¢Ô∏è –í–´–ë–†–û–° –ó–ê–í–ï–†–®–Å–ù!\n\n‚ò†Ô∏è –ü–æ–≥–∏–±—à–∏–µ —Å—Ç–∞–ª–∫–µ—Ä—ã:\n{dead_list}\n\n‚ôªÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã: {restored_text}"
        try:
            vk_session.method("messages.send", {"peer_id": GAME_CHAT_ID, "message": chat_msg, "random_id": 0})
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –±–µ—Å–µ–¥—É: {e}")
    elif GAME_CHAT_ID:
        chat_msg = f"‚ò¢Ô∏è –í–´–ë–†–û–° –∑–∞–≤–µ—Ä—à—ë–Ω!\n\n‚úÖ –í—Å–µ —Å—Ç–∞–ª–∫–µ—Ä—ã —É–∫—Ä—ã–ª–∏—Å—å!\n\n‚ôªÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã: {restored_text}"
        try:
            vk_session.method("messages.send", {"peer_id": GAME_CHAT_ID, "message": chat_msg, "random_id": 0})
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –±–µ—Å–µ–¥—É: {e}")
    save_data()
def check_territory_exhaustion(location, point):
    ptype = POINT_TYPES.get(point, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è")
    limit = EXHAUSTION_LIMITS.get(ptype, 100)
    current = territory_exhaustion.get(location, {}).get(point, 0)
    return current < limit
def add_territory_exhaustion(location, point):
    global territory_exhaustion
    if location not in territory_exhaustion:
        territory_exhaustion[location] = {}
    territory_exhaustion[location][point] = territory_exhaustion[location].get(point, 0) + 1
    save_data()
def init_territory_control():
    global territory_control
    territory_control = {}
    for loc in LOCATIONS:
        territory_control[loc] = {}
        for point in LOCATIONS[loc]:
            territory_control[loc][point] = {"faction": None, "squads": 0}
    territory_control["–ö–æ—Ä–¥–æ–Ω"]["–ë1"] = {"faction": "üõ°Ô∏è –î–æ–ª–≥", "squads": 5}
    territory_control["–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞"]["–ë1"] = {"faction": "‚ò¶Ô∏è –ì—Ä–µ—Ö", "squads": 5}
    territory_control["–°–≤–∞–ª–∫–∞"]["–ë1"] = {"faction": "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏", "squads": 5}
    save_data()
def get_territory_owner(location, point):
    if location in territory_control and point in territory_control[location]:
        return territory_control[location][point].get("faction")
    return None
def get_territory_squads(location, point):
    if location in territory_control and point in territory_control[location]:
        return territory_control[location][point].get("squads", 0)
    return 0
def set_territory_control(location, point, faction, squads):
    global territory_control
    if location not in territory_control:
        territory_control[location] = {}
    territory_control[location][point] = {"faction": faction, "squads": squads}
    save_data()
def is_player_on_own_territory(user_id):
    p = players[user_id]
    location, point = get_player_position(user_id)
    faction = p.get("faction")
    owner = get_territory_owner(location, point)
    return owner == faction
def get_faction_leader(faction):
    return faction_leaders.get(faction)
def set_faction_leader(faction, user_id):
    global faction_leaders
    faction_leaders[faction] = user_id
    save_data()
def get_players_on_territory(location, point):
    result = []
    for uid, p in players.items():
        loc, pt = get_player_position(uid)
        if loc == location and pt == point:
            result.append(uid)
    return result
def get_player_bullet_resist(user_id):
    p = players[user_id]
    return p.get("bullet_resist", 0) + get_belt_bonus(user_id, "bullet_resist")
def get_armor_category(user_id):
    p = players[user_id]
    armor = p.get("armor")
    if not armor:
        return 0
    faction = p.get("faction")
    for i, item in enumerate(EQUIPMENT[faction]["armor"]):
        if item[0] == armor:
            return i + 1
    return 0
def generate_war_map_image(location):
    map_path = LOCATION_MAPS.get(location)
    if not map_path or not os.path.exists(map_path):
        return None
    try:
        img = Image.open(map_path).convert("RGBA")
        draw = ImageDraw.Draw(img)
        icon_size = 45 if location == "–ü–æ–ª—è–Ω–∞" else 30
        faction_icons = {}
        for faction, icon_path in FACTION_ICONS.items():
            try:
                faction_icons[faction] = Image.open(icon_path).convert("RGBA").resize((icon_size, icon_size))
            except:
                faction_icons[faction] = None
        if location in POINT_COORDINATES:
            for point, (x, y) in POINT_COORDINATES[location].items():
                owner = get_territory_owner(location, point)
                if owner and owner in faction_icons and faction_icons[owner]:
                    icon = faction_icons[owner]
                    img.paste(icon, (x - icon_size // 2, y - icon_size // 2), icon)
        buffer = io.BytesIO()
        img.save(buffer, format="PNG")
        buffer.seek(0)
        return buffer
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã –≤–æ–π–Ω—ã: {e}")
        return None
def send_war_map(user_id, location, message, keyboard, vk_session):
    try:
        img_buffer = generate_war_map_image(location)
        if img_buffer:
            upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
            response = vk_session.http.post(upload_url, files={"photo": ("map.png", img_buffer, "image/png")})
            result = response.json()
            photo_data = vk_session.method("photos.saveMessagesPhoto", {
                "photo": result["photo"],
                "server": result["server"],
                "hash": result["hash"]
            })[0]
            vk_session.method("messages.send", {
                "user_id": user_id,
                "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}",
                "random_id": 0,
                "message": message,
                "keyboard": keyboard.get_keyboard()
            })
            return True
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–∞—Ä—Ç—ã –≤–æ–π–Ω—ã: {e}")
    send_message(user_id, message, keyboard, vk_session)
    return False
def process_attack(attacker_id, location, point, squad_count, with_player, vk_session):
    attacker = players[attacker_id]
    attacker_faction = attacker["faction"]
    defender_faction = get_territory_owner(location, point)
    if defender_faction == ZOMBIE_FACTION and LAST_STAND_MODE:
        zombie_territory_attacked(location, point, attacker_faction, vk_session)
    defender_squads = get_territory_squads(location, point)
    ptype = POINT_TYPES.get(point, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è")
    min_squads = MIN_SQUADS_FOR_POINT.get(ptype, 1)
    if defender_faction is not None and defender_faction != attacker_faction:
        if squad_count < min_squads:
            return f"‚ùå –î–ª—è –∞—Ç–∞–∫–∏ –Ω–∞ {ptype} –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º {min_squads} —Å–∫–≤–∞–¥–æ–≤."
    def notify_faction_leader(faction, message):
        leader = get_faction_leader(faction)
        if leader and leader in players and leader != attacker_id:
            send_message(leader, message, None, vk_session)
    def damage_equipment(player_id, messages_list):
        p = players[player_id]
        if random.randint(1, 100) <= 50:
            equip_to_damage = []
            if p.get("weapon") and p.get("weapon_durability", 0) > 0:
                equip_to_damage.append("weapon")
            if p.get("armor") and p.get("armor_durability", 0) > 0:
                equip_to_damage.append("armor")
            if equip_to_damage:
                target = random.choice(equip_to_damage)
                if target == "weapon":
                    p["weapon_durability"] = max(0, p["weapon_durability"] - 1)
                    if player_id == attacker_id:
                        messages_list.append("üîß –í–∞—à–µ –æ—Ä—É–∂–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–æ (-1)!")
                    else:
                        send_message(player_id, "üîß –í–∞—à–µ –æ—Ä—É–∂–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–æ –≤ –±–æ—é (-1)!", None, vk_session)
                else:
                    p["armor_durability"] = max(0, p["armor_durability"] - 1)
                    if player_id == attacker_id:
                        messages_list.append("üîß –í–∞—à–∞ –±—Ä–æ–Ω—è –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ (-1)!")
                    else:
                        send_message(player_id, "üîß –í–∞—à–∞ –±—Ä–æ–Ω—è –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ –≤ –±–æ—é (-1)!", None, vk_session)
    if defender_faction is None:
        if squad_count >= min_squads:
            set_territory_control(location, point, attacker_faction, squad_count)
            attacker["squads"] -= squad_count
            save_data()
            return f"‚úÖ –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è {location} {point} –∑–∞—Ö–≤–∞—á–µ–Ω–∞! –†–∞–∑–º–µ—â–µ–Ω–æ {squad_count} —Å–∫–≤–∞–¥–æ–≤."
        else:
            return f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–∫–≤–∞–¥–æ–≤ –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞. –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º {min_squads}."
    if defender_faction == attacker_faction:
        territory_control[location][point]["squads"] += squad_count
        attacker["squads"] -= squad_count
        save_data()
        return f"‚úÖ –ü–æ–¥–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –ù–∞ —Ç–æ—á–∫–µ —Ç–µ–ø–µ—Ä—å {territory_control[location][point]['squads']} —Å–∫–≤–∞–¥–æ–≤."
    if with_player:
        if not attacker.get("weapon") or attacker.get("health", 0) <= 0:
            return "‚ùå –î–ª—è –ª–∏—á–Ω–æ–≥–æ —É—á–∞—Å—Ç–∏—è –Ω—É–∂–Ω–æ –æ—Ä—É–∂–∏–µ –∏ –∑–¥–æ—Ä–æ–≤—å–µ."
    notify_faction_leader(defender_faction, f"‚ö†Ô∏è –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è {location} {point} –∞—Ç–∞–∫–æ–≤–∞–Ω–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π {attacker_faction}!")
    all_on_territory = get_players_on_territory(location, point)
    defenders = [uid for uid in all_on_territory if players[uid].get("faction") == defender_faction and players[uid].get("health", 0) > 0]
    total_bullet_resist = sum(get_player_bullet_resist(uid) for uid in defenders)
    player_damage = 0
    bonus_msg_parts = []
    if with_player:
        player_damage = attacker.get("weapon_damage", 0) + get_belt_bonus(attacker_id, "weapon_damage")
        weapon_name = attacker.get("weapon", "")
        special = SPECIAL_WEAPONS.get(weapon_name, {})
        if ptype in ["–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞", "–õ–æ–≥–æ–≤–æ"]:
            war_chance = special.get("war_bonus_chance", 0)
            war_bonus = special.get("war_bonus_damage", 0)
            if war_chance > 0 and random.randint(1, 100) <= war_chance:
                player_damage += war_bonus
                bonus_msg_parts.append(f"‚ö° {weapon_name}: +{war_bonus} —É—Ä–æ–Ω–∞!")
    defender_damage_to_attacker = squad_count / 2
    if with_player:
        defender_damage_to_attacker += player_damage
    def calculate_return_damage_to_player():
        squad_damage = round(defender_squads / 3)
        armor_cat = get_armor_category(attacker_id)
        armor_damage = [1, 1.5, 2, 2.5, 3, 3.5][min(armor_cat, 5)]
        return squad_damage + armor_damage
    effective_defender_squads = max(0, defender_squads - total_bullet_resist)
    remaining_defender_after_player = max(0, effective_defender_squads - player_damage) if with_player else effective_defender_squads
    if squad_count <= remaining_defender_after_player:
        squads_destroyed = squad_count
        remaining_attacker_squads = 0
        remaining_defender_squads = remaining_defender_after_player - squad_count
        territory_control[location][point]["squads"] = remaining_defender_squads
        global faction_shared_squads
        if remaining_defender_squads == 0:
            set_territory_control(location, point, None, 0)
            notify_faction_leader(defender_faction, f"‚ö†Ô∏è –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è {location} {point} –ø–æ—Ç–µ—Ä—è–Ω–∞ ‚Äî –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å —Å–∫–≤–∞–¥–æ–≤!")
        elif remaining_defender_squads < min_squads:
            faction_shared_squads[defender_faction] = faction_shared_squads.get(defender_faction, 0) + remaining_defender_squads
            set_territory_control(location, point, None, 0)
            notify_faction_leader(defender_faction, f"‚ö†Ô∏è –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è {location} {point} –ø–æ—Ç–µ—Ä—è–Ω–∞!\nüîô {remaining_defender_squads} —Å–∫–≤–∞–¥–æ–≤ –≤–µ—Ä–Ω—É–ª–æ—Å—å –≤ –æ–±—â–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.")
        if defenders:
            damage_per_player = defender_damage_to_attacker / len(defenders)
            for def_id in defenders:
                players[def_id]["health"] = max(0, players[def_id]["health"] - damage_per_player)
                damage_equipment(def_id, bonus_msg_parts)
                send_message(def_id, f"‚öîÔ∏è –ê—Ç–∞–∫–∞ –Ω–∞ {location} {point} –æ—Ç–±–∏—Ç–∞.", None, vk_session)
                if players[def_id]["health"] <= 0:
                    handle_war_death(def_id, attacker_id, vk_session)
        if with_player:
            return_damage = calculate_return_damage_to_player()
            attacker["health"] = max(0, attacker["health"] - return_damage)
            bonus_msg_parts.append(f"üíî –í—ã –ø–æ–ª—É—á–∏–ª–∏ {return_damage} —É—Ä–æ–Ω–∞.")
            damage_equipment(attacker_id, bonus_msg_parts)
            if attacker["health"] <= 0:
                handle_war_death(attacker_id, defenders[0] if defenders else None, vk_session)
        attacker["squads"] -= squad_count
        save_data()
        bonus_msg = "\n" + "\n".join(bonus_msg_parts) if bonus_msg_parts else ""
        return f"‚ùå –ê—Ç–∞–∫–∞ –æ—Ç–±–∏—Ç–∞. –ü–æ—Ç–µ—Ä—è–Ω–æ {squads_destroyed} —Å–∫–≤–∞–¥–æ–≤.{bonus_msg}"
    remaining_attacker_squads = squad_count - remaining_defender_after_player
    if defenders:
        damage_per_player = defender_damage_to_attacker / len(defenders)
        for def_id in defenders:
            players[def_id]["health"] = max(0, players[def_id]["health"] - damage_per_player)
            damage_equipment(def_id, bonus_msg_parts)
            send_message(def_id, f"‚öîÔ∏è –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è {location} {point} –ø–æ—Ç–µ—Ä—è–Ω–∞.", None, vk_session)
            if players[def_id]["health"] <= 0:
                handle_war_death(def_id, attacker_id, vk_session)
    if with_player:
        return_damage = calculate_return_damage_to_player()
        attacker["health"] = max(0, attacker["health"] - return_damage)
        bonus_msg_parts.append(f"üíî –í—ã –ø–æ–ª—É—á–∏–ª–∏ {return_damage} —É—Ä–æ–Ω–∞.")
        damage_equipment(attacker_id, bonus_msg_parts)
        if attacker["health"] <= 0:
            handle_war_death(attacker_id, defenders[0] if defenders else None, vk_session)
            attacker["squads"] -= squad_count
            save_data()
            bonus_msg = "\n" + "\n".join(bonus_msg_parts) if bonus_msg_parts else ""
            return f"üíÄ –í—ã –ø–æ–≥–∏–±–ª–∏ –≤ –±–æ—é.{bonus_msg}"
    squads_lost = squad_count - remaining_attacker_squads
    bonus_msg_parts.append(f"üíÄ –ü–æ—Ç–µ—Ä—è–Ω–æ —Å–∫–≤–∞–¥–æ–≤: {squads_lost}")
    if remaining_attacker_squads >= min_squads:
        set_territory_control(location, point, attacker_faction, remaining_attacker_squads)
        attacker["squads"] -= squad_count
        notify_faction_leader(defender_faction, f"üíÄ –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è {location} {point} –∑–∞—Ö–≤–∞—á–µ–Ω–∞ {attacker_faction}!")
        save_data()
        bonus_msg = "\n" + "\n".join(bonus_msg_parts) if bonus_msg_parts else ""
        return f"‚úÖ –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è {location} {point} –∑–∞—Ö–≤–∞—á–µ–Ω–∞! –†–∞–∑–º–µ—â–µ–Ω–æ {remaining_attacker_squads} —Å–∫–≤–∞–¥–æ–≤.{bonus_msg}"
    else:
        set_territory_control(location, point, None, 0)
        attacker["squads"] -= squad_count
        attacker["squads"] += remaining_attacker_squads
        notify_faction_leader(defender_faction, f"‚ö†Ô∏è –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è {location} {point} –ø–æ—Ç–µ—Ä—è–Ω–∞!")
        save_data()
        bonus_msg = "\n" + "\n".join(bonus_msg_parts) if bonus_msg_parts else ""
        return f"‚ö†Ô∏è –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∞, –Ω–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–∫–≤–∞–¥–æ–≤ –¥–ª—è —É–¥–µ—Ä–∂–∞–Ω–∏—è (–Ω—É–∂–Ω–æ {min_squads}).\nüîô {remaining_attacker_squads} —Å–∫–≤–∞–¥–æ–≤ –≤–µ—Ä–Ω—É–ª–æ—Å—å –∫ –≤–∞–º.{bonus_msg}"
def handle_war_death(dead_id, killer_id, vk_session):
    dead = players[dead_id]
    dead_faction = dead.get("faction")
    backpack = dead.get("backpack", {})
    money = dead.get("money", 0)
    lost_items = {}
    lootable_items = []
    for item, count in list(backpack.items()):
        if count > 0 and item not in DONATION_ARTIFACTS:
            lootable_items.extend([item] * count)
    total_lootable = len(lootable_items)
    if total_lootable > 0:
        max_items_to_lose = max(1, int(total_lootable * 0.15))
        num_items_to_lose = random.randint(1, max_items_to_lose)
        random.shuffle(lootable_items)
        lost_list = lootable_items[:num_items_to_lose]
        for item in lost_list:
            lost_items[item] = lost_items.get(item, 0) + 1
        for item, count in lost_items.items():
            backpack[item] -= count
            if backpack[item] <= 0:
                del backpack[item]
    max_money_to_lose = max(1, int(money * 0.15))
    money_lost = random.randint(1, max_money_to_lose) if money > 0 else 0
    dead["money"] -= money_lost
    dead["health"] = 0
    dead["death_notified"] = True
    if killer_id and killer_id in players and dead_faction != ZOMBIE_FACTION:
        killer = players[killer_id]
        for item, count in lost_items.items():
            killer["backpack"][item] = killer["backpack"].get(item, 0) + count
        killer["money"] = killer.get("money", 0) + money_lost
        loot_msg = f"üíÄ –í—ã —É–±–∏–ª–∏ –≤—Ä–∞–≥–∞ –≤ –±–æ—é!"
        if lost_items or money_lost:
            loot_msg += "\n–ü–æ–ª—É—á–µ–Ω–æ:"
            for item, count in lost_items.items():
                loot_msg += f"\n  {item} x{count}"
            if money_lost > 0:
                loot_msg += f"\n  üí≤ {money_lost}—Ä"
        send_message(killer_id, loot_msg, None, vk_session)
    msg_lines = ["üíÄ –í—ã –ø–æ–≥–∏–±–ª–∏ –≤ –±–æ—é!"]
    if lost_items or money_lost:
        msg_lines.append("–ü–æ—Ç–µ—Ä—è–Ω–æ:")
        for item, count in lost_items.items():
            msg_lines.append(f"  {item} x{count}")
        if money_lost > 0:
            msg_lines.append(f"  üí≤ {money_lost}—Ä")
    send_message(dead_id, "\n".join(msg_lines), create_main_menu_keyboard(dead_id), vk_session)
    save_data()
def init_anomaly_exploration(user_id):
    p = players[user_id]
    location = p["location"]
    point = p["point"]
    atype = ANOMALY_ZONES.get(location, {}).get(point, "–≥—Ä–∞–≤–∏")
    p["current_anomaly_type"] = atype
    p["state"] = STATE_ANOMALY_EXPLORE
    if random.randint(1, 100) <= 70:
        safe_path = random.randint(1, 3)
        p["anomaly_safe_path"] = safe_path
        p["anomaly_path_choosing"] = True
    else:
        p["anomaly_path_choosing"] = False
        p["anomaly_safe_path"] = None
        start_anomaly_map(user_id)
    save_data()
def start_anomaly_map(user_id):
    p = players[user_id]
    player_start = (random.randint(0, 5), random.randint(0, 5))
    p["player_pos"] = player_start
    num_artifacts = random.randint(1, 3)
    num_anomalies = random.randint(3, 6)
    num_hidden_anomalies = random.randint(0, 2)
    occupied = {player_start}
    artifact_positions = []
    for _ in range(num_artifacts):
        attempts = 0
        while attempts < 50:
            pos = (random.randint(0, 5), random.randint(0, 5))
            if pos not in occupied:
                artifact_positions.append(pos)
                occupied.add(pos)
                break
            attempts += 1
    anomaly_positions = []
    for _ in range(num_anomalies):
        attempts = 0
        while attempts < 50:
            pos = (random.randint(0, 5), random.randint(0, 5))
            if pos not in occupied:
                anomaly_positions.append(pos)
                occupied.add(pos)
                break
            attempts += 1
    hidden_anomaly_positions = []
    for _ in range(num_hidden_anomalies):
        attempts = 0
        while attempts < 50:
            pos = (random.randint(0, 5), random.randint(0, 5))
            if pos not in occupied:
                hidden_anomaly_positions.append(pos)
                occupied.add(pos)
                break
            attempts += 1
    p["artifact_positions"] = artifact_positions
    p["anomaly_positions"] = anomaly_positions
    p["hidden_anomaly_positions"] = hidden_anomaly_positions
    p["anomaly_path_choosing"] = False
    p["anomaly_safe_path"] = None
def get_detector_alerts(user_id):
    p = players[user_id]
    detector = p.get("detector", None)
    px, py = p.get("player_pos", (0, 0))
    artifact_positions = [tuple(pos) for pos in p.get("artifact_positions", [])]
    anomaly_positions = [tuple(pos) for pos in p.get("anomaly_positions", [])]
    alerts = []
    if detector in ["–ú–µ–¥–≤–µ–¥—å", "–í–µ–ª–µ—Å", "–°–≤–∞—Ä–æ–≥"]:
        anomaly_dirs = []
        for ax, ay in anomaly_positions:
            if abs(ax - px) <= 1 and abs(ay - py) <= 1 and (ax, ay) != (px, py):
                direction = ""
                if ay < py:
                    direction += "‚¨ÜÔ∏è"
                if ay > py:
                    direction += "‚¨áÔ∏è"
                if ax < px:
                    direction += "‚¨ÖÔ∏è"
                if ax > px:
                    direction += "‚û°Ô∏è"
                if direction and direction not in anomaly_dirs:
                    anomaly_dirs.append(direction)
        if anomaly_dirs:
            alerts.append("üö®" + "|".join(anomaly_dirs))
    if detector == "–û—Ç–∫–ª–∏–∫":
        for ax, ay in artifact_positions:
            if abs(ax - px) <= 1 and abs(ay - py) <= 1 and (ax, ay) != (px, py):
                alerts.append("‚ú¥Ô∏è‚ú¥Ô∏è‚ú¥Ô∏è")
                break
    elif detector == "–ú–µ–¥–≤–µ–¥—å":
        for ax, ay in artifact_positions:
            dist = max(abs(ax - px), abs(ay - py))
            if dist == 1:
                alerts.append("‚ú¥Ô∏è‚ú¥Ô∏è‚ú¥Ô∏è")
                break
            elif dist == 2:
                alerts.append("‚ú¥Ô∏è‚ú¥Ô∏è")
                break
    return " ".join(alerts)
def generate_anomaly_map_image(user_id):
    p = players[user_id]
    player_pos = tuple(p.get("player_pos", (0, 0)))
    artifact_positions = [tuple(pos) for pos in p.get("artifact_positions", [])]
    anomaly_positions = [tuple(pos) for pos in p.get("anomaly_positions", [])]
    detector = p.get("detector", None)
    cell_size = 60
    grid_size = 6
    width = cell_size * grid_size
    height = cell_size * grid_size
    try:
        bg = Image.open("backgrounds/background.png").convert("RGBA").resize((width, height))
        enhancer = ImageEnhance.Brightness(bg)
        bg = enhancer.enhance(0.75)
    except:
        bg = Image.new("RGBA", (width, height), (40, 40, 40, 255))
    img = bg.copy()
    draw = ImageDraw.Draw(img)
    for row in range(grid_size):
        for col in range(grid_size):
            x = col * cell_size
            y = row * cell_size
            draw.rectangle([x, y, x + cell_size, y + cell_size], outline="black", width=2)
    icon_size = cell_size - 10
    try:
        player_icon = Image.open("backgrounds/–∏–≥—Ä–æ–∫.png").convert("RGBA").resize((icon_size, icon_size))
    except:
        player_icon = None
    try:
        artifact_icon = Image.open("backgrounds/–∞—Ä—Ç.png").convert("RGBA").resize((icon_size, icon_size))
    except:
        artifact_icon = None
    try:
        anomaly_icon = Image.open("backgrounds/–∞–Ω–æ–º.png").convert("RGBA").resize((icon_size, icon_size))
    except:
        anomaly_icon = None
    px, py = player_pos
    if detector in ["–í–µ–ª–µ—Å", "–°–≤–∞—Ä–æ–≥"]:
        for ax, ay in artifact_positions:
            if abs(ax - px) <= 4 and abs(ay - py) <= 4:
                x = ax * cell_size + 5
                y = ay * cell_size + 5
                if artifact_icon:
                    img.paste(artifact_icon, (x, y), artifact_icon)
                else:
                    draw.ellipse([x, y, x + icon_size, y + icon_size], fill="yellow", outline="orange")
    if detector == "–°–≤–∞—Ä–æ–≥":
        for ax, ay in anomaly_positions:
            if abs(ax - px) <= 4 and abs(ay - py) <= 4:
                x = ax * cell_size + 5
                y = ay * cell_size + 5
                if anomaly_icon:
                    img.paste(anomaly_icon, (x, y), anomaly_icon)
                else:
                    draw.ellipse([x, y, x + icon_size, y + icon_size], fill="cyan", outline="blue")
    x = px * cell_size + 5
    y = py * cell_size + 5
    if player_icon:
        img.paste(player_icon, (x, y), player_icon)
    else:
        draw.ellipse([x, y, x + icon_size, y + icon_size], fill="white", outline="gray")
    buffer = io.BytesIO()
    img.save(buffer, format="PNG")
    buffer.seek(0)
    return buffer
def handle_anomaly_move(user_id, direction, vk_session):
    p = players[user_id]
    px, py = p.get("player_pos", (0, 0))
    if direction == "‚¨ÜÔ∏è" and py > 0:
        py -= 1
    elif direction == "‚¨áÔ∏è" and py < 5:
        py += 1
    elif direction == "‚¨ÖÔ∏è" and px > 0:
        px -= 1
    elif direction == "‚û°Ô∏è" and px < 5:
        px += 1
    else:
        send_message(user_id, "‚ùå –ù–µ–ª—å–∑—è –¥–≤–∏–≥–∞—Ç—å—Å—è –≤ —ç—Ç–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏.", create_anomaly_movement_keyboard(), vk_session)
        return
    p["player_pos"] = (px, py)
    messages = []
    artifact_positions = [tuple(pos) for pos in p.get("artifact_positions", [])]
    anomaly_positions = [tuple(pos) for pos in p.get("anomaly_positions", [])]
    hidden_anomaly_positions = [tuple(pos) for pos in p.get("hidden_anomaly_positions", [])]
    if (px, py) in artifact_positions:
        atype = p.get("current_anomaly_type", "–≥—Ä–∞–≤–∏")
        found_artifact = get_random_artifact_by_rarity(atype)
        p["backpack"][found_artifact] = p["backpack"].get(found_artifact, 0) + 1
        artifact_positions.remove((px, py))
        p["artifact_positions"] = artifact_positions
        detector = p.get("detector", "–û—Ç–∫–ª–∏–∫")
        if detector == "–í–µ–ª–µ—Å":
            charge_cost = 2
        elif detector == "–°–≤–∞—Ä–æ–≥":
            charge_cost = 3
        else:
            charge_cost = 1
        p["detector_charge"] = max(0, p.get("detector_charge", 0) - charge_cost)
        messages.append(f"üåï –í—ã –Ω–∞—à–ª–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç: {found_artifact}!")
        messages.append(f"üìü –î–µ—Ç–µ–∫—Ç–æ—Ä —Ä–∞–∑—Ä—è–¥–∏–ª—Å—è –Ω–∞ {charge_cost} –∑–∞—Ä—è–¥(–∞).")
        if not artifact_positions:
            messages.append("‚úÖ –í—Å–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –≤ —ç—Ç–æ–π –∑–æ–Ω–µ –Ω–∞–π–¥–µ–Ω—ã!")
            p["state"] = STATE_IN_MENU
            save_data()
            send_message(user_id, "\n".join(messages), create_main_menu_keyboard(user_id), vk_session)
            return
        min_charge = 2 if detector == "–í–µ–ª–µ—Å" else (3 if detector == "–°–≤–∞—Ä–æ–≥" else 1)
        if p["detector_charge"] < min_charge:
            messages.append(f"üîã –ó–∞—Ä—è–¥–∞ –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞! –í—ã –ø–æ–∫–∏–¥–∞–µ—Ç–µ –∞–Ω–æ–º–∞–ª—å–Ω—É—é –∑–æ–Ω—É.")
            p["state"] = STATE_IN_MENU
            save_data()
            send_message(user_id, "\n".join(messages), create_main_menu_keyboard(user_id), vk_session)
            return
    if (px, py) in hidden_anomaly_positions:
        atype = p.get("current_anomaly_type", "–≥—Ä–∞–≤–∏")
        min_dmg, max_dmg = ANOMALY_DAMAGE[atype]
        raw_damage = round(random.uniform(min_dmg, max_dmg), 1)
        anomaly_resist = get_total_anomaly_resist(user_id)
        actual_damage = max(0, round(raw_damage - anomaly_resist, 1))
        p["health"] = max(0, p["health"] - actual_damage)
        messages.append(f"üí• –í—ã –ø–æ–ø–∞–ª–∏ –≤ —Ç–∞–π–Ω—É—é –∞–Ω–æ–º–∞–ª–∏—é! –ü–æ–ª—É—á–µ–Ω–æ {actual_damage} —É—Ä–æ–Ω–∞. (‚ù§Ô∏è {p['health']}/10)")
        hidden_anomaly_positions.remove((px, py))
        p["hidden_anomaly_positions"] = hidden_anomaly_positions
        if random.randint(1, 100) <= 25 and p.get("armor"):
            p["armor_durability"] = max(0, p["armor_durability"] - 1)
            messages.append("üîß –ë—Ä–æ–Ω—è –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ (-1)!")
        if p["health"] <= 0:
            messages.append("üíÄ –í—ã –ø–æ–≥–∏–±–ª–∏ –≤ –∞–Ω–æ–º–∞–ª–∏–∏!")
            lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=5, max_money=50)
            messages.extend(format_death_losses(lost_items, money_lost))
            p["state"] = STATE_IN_MENU
            p["death_notified"] = True
            normalize_stats(user_id)
            save_data()
            send_message(user_id, "\n".join(messages), create_main_menu_keyboard(user_id), vk_session)
            return
    if (px, py) in anomaly_positions:
        atype = p.get("current_anomaly_type", "–≥—Ä–∞–≤–∏")
        min_dmg, max_dmg = ANOMALY_DAMAGE[atype]
        raw_damage = round(random.uniform(min_dmg, max_dmg), 1)
        anomaly_resist = get_total_anomaly_resist(user_id)
        actual_damage = max(0, round(raw_damage - anomaly_resist, 1))
        p["health"] = max(0, p["health"] - actual_damage)
        messages.append(f"üí• –í—ã –ø–æ–ø–∞–ª–∏ –≤ –∞–Ω–æ–º–∞–ª–∏—é! –ü–æ–ª—É—á–µ–Ω–æ {actual_damage} —É—Ä–æ–Ω–∞. (‚ù§Ô∏è {p['health']}/10)")
        if random.randint(1, 100) <= 25 and p.get("armor"):
            p["armor_durability"] = max(0, p["armor_durability"] - 1)
            messages.append("üîß –ë—Ä–æ–Ω—è –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ (-1)!")
        if p["health"] <= 0:
            messages.append("üíÄ –í—ã –ø–æ–≥–∏–±–ª–∏ –≤ –∞–Ω–æ–º–∞–ª–∏–∏!")
            lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=5, max_money=50)
            messages.extend(format_death_losses(lost_items, money_lost))
            p["state"] = STATE_IN_MENU
            p["death_notified"] = True
            normalize_stats(user_id)
            save_data()
            send_message(user_id, "\n".join(messages), create_main_menu_keyboard(user_id), vk_session)
            return
    alerts = get_detector_alerts(user_id)
    if alerts:
        messages.append(alerts)
    save_data()
    try:
        img_buffer = generate_anomaly_map_image(user_id)
        upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
        response = vk_session.http.post(upload_url, files={"photo": ("map.png", img_buffer, "image/png")})
        result = response.json()
        photo_data = vk_session.method("photos.saveMessagesPhoto", {"photo": result["photo"], "server": result["server"], "hash": result["hash"]})[0]
        msg = "\n".join(messages) if messages else "–í—ã –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª–∏—Å—å."
        vk_session.method("messages.send", {"user_id": user_id, "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}", "random_id": 0, "message": msg, "keyboard": create_anomaly_movement_keyboard().get_keyboard()})
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã: {e}")
        send_message(user_id, "\n".join(messages) if messages else "–í—ã –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª–∏—Å—å.", create_anomaly_movement_keyboard(), vk_session)
def send_location_map(user_id, location, vk_session):
    try:
        img_buffer = generate_war_map_image(location)
        if img_buffer:
            upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
            response = vk_session.http.post(upload_url, files={"photo": ("map.png", img_buffer, "image/png")})
            result = response.json()
            photo_data = vk_session.method("photos.saveMessagesPhoto", {
                "photo": result["photo"],
                "server": result["server"],
                "hash": result["hash"]
            })[0]
            current_point = players[user_id]["point"]
            vk_session.method("messages.send", {
                "user_id": user_id,
                "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}",
                "random_id": 0,
                "message": f"üó∫Ô∏è –ö–∞—Ä—Ç–∞ –ª–æ–∫–∞—Ü–∏–∏: {location}\nüìç –í–∞—à–∞ —Ç–æ—á–∫–∞: {current_point}\n\nüåê –í–ø–∏—à–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –ø–µ—Ä–µ–π—Ç–∏:\n‚ùï –ü—Ä–∏–º–µ—Ä: \"–¢–†1\", \"–ë1\"."
            })
            return True
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–∞—Ä—Ç—ã: {e}")
    send_message(user_id, 'üåê –í–ø–∏—à–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –ø–µ—Ä–µ–π—Ç–∏:\n‚ùï –ü—Ä–∏–º–µ—Ä: "–¢–†1", "–ë1".', None, vk_session)
    return False
def handle_hunting_escape(user_id, vk_session):
    p = players[user_id]
    lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=5, max_money=50)
    msg_lines = ["üí® –í—ã —Å–±–µ–∂–∞–ª–∏ —Å –æ—Ö–æ—Ç—ã!"]
    msg_lines.extend(format_death_losses(lost_items, money_lost))
    send_message(user_id, "\n".join(msg_lines), create_main_menu_keyboard(user_id), vk_session)
    p["state"] = STATE_IN_MENU
    p.pop("current_mutant", None)
    p.pop("mutant_hp", None)
    save_data()
def use_item(user_id, item_input, vk_session, from_global_command=False):
    p = players[user_id]
    parts = item_input.strip().split()
    if not parts:
        if from_global_command:
            send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç.", None, vk_session)
        else:
            send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç.", create_backpack_menu_keyboard(), vk_session)
        return
    item_name = ""
    count = 1
    if len(parts) >= 2:
        try:
            count = int(parts[-1])
            item_name = " ".join(parts[:-1]).lower()
        except:
            item_name = item_input.strip().lower()
    else:
        item_name = item_input.strip().lower()
    if item_name == "–±–∞—Ç–∞—Ä–µ–π–∫–∏":
        if from_global_command:
            send_message(user_id, "‚ùå –ë–∞—Ç–∞—Ä–µ–π–∫–∏ –Ω–µ–ª—å–∑—è —É–ø–æ—Ç—Ä–µ–±–∏—Ç—å.", None, vk_session)
        else:
            send_message(user_id, "‚ùå –ë–∞—Ç–∞—Ä–µ–π–∫–∏ –Ω–µ–ª—å–∑—è —É–ø–æ—Ç—Ä–µ–±–∏—Ç—å.", create_backpack_menu_keyboard(), vk_session)
        return
    if item_name not in ITEM_EFFECTS:
        if from_global_command:
            send_message(user_id, "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç.", None, vk_session)
        else:
            send_message(user_id, "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç.", create_backpack_menu_keyboard(), vk_session)
        return
    backpack = p.get("backpack", {})
    if backpack.get(item_name, 0) < count:
        if from_global_command:
            send_message(user_id, f"‚ùå –£ –≤–∞—Å –Ω–µ—Ç {count} —à—Ç. —ç—Ç–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞.", None, vk_session)
        else:
            send_message(user_id, f"‚ùå –£ –≤–∞—Å –Ω–µ—Ç {count} —à—Ç. —ç—Ç–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞.", create_backpack_menu_keyboard(), vk_session)
        return
    effects = ITEM_EFFECTS[item_name]
    messages = []
    if effects.get("random_effect"):
        for _ in range(count):
            effect_msg = apply_random_effect(user_id, vk_session)
            messages.append(f"üå∞ –ñ–µ–ª—É–¥—å: {effect_msg}")
        backpack[item_name] -= count
        if backpack[item_name] <= 0:
            del backpack[item_name]
        normalize_stats(user_id)
        save_data()
        if from_global_command:
            send_message(user_id, "\n".join(messages), None, vk_session)
        else:
            send_message(user_id, "\n".join(messages), create_backpack_menu_keyboard(), vk_session)
        return
    for attr, value in effects.items():
        total_value = value * count
        if attr == "health":
            p["health"] = min(10, p["health"] + total_value)
            if p["health"] > 0:
                p.pop("death_notified", None)
            messages.append(f"‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –¥–æ {round(p['health'], 1)}/10")
        elif attr == "radiation":
            p["radiation"] = max(0, p["radiation"] + total_value)
            messages.append(f"‚ò¢Ô∏è –†–∞–¥–∏–∞—Ü–∏—è —Å–Ω–∏–∂–µ–Ω–∞ –¥–æ {round(p['radiation'], 1)}/10")
        elif attr == "hunger":
            p["hunger"] = max(0, p["hunger"] + total_value)
            messages.append(f"üçΩÔ∏è –ì–æ–ª–æ–¥ —Å–Ω–∏–∂–µ–Ω –¥–æ {round(p['hunger'], 1)}/10")
        elif attr == "stamina":
            p["stamina"] = min(10, p["stamina"] + total_value)
            messages.append(f"‚ö° –í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ {round(p['stamina'], 1)}/10")
    if has_active_donation(user_id) and item_name not in DONATION_EXCLUDED_ITEMS:
        donation_art = get_donation_artifact(user_id)
        belt = p.get("belt", [None, None, None])
        if donation_art in belt or backpack.get(donation_art, 0) > 0:
            if donation_art == "–ü–æ–Ω—á–∏–∫":
                heal_bonus = 0.5 * count
                p["health"] = min(10, p["health"] + heal_bonus)
                messages.append(f"üç© –ü–æ–Ω—á–∏–∫: +{heal_bonus}‚ù§Ô∏è")
            elif donation_art == "–°—Ç–µ–π–∫":
                hunger_bonus = 0.5 * count
                p["hunger"] = max(0, p["hunger"] - hunger_bonus)
                messages.append(f"ü•© –°—Ç–µ–π–∫: -{hunger_bonus}üçΩÔ∏è")
    if not messages:
        messages.append(f"‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: {item_name} x{count}")
    backpack[item_name] -= count
    if backpack[item_name] <= 0:
        del backpack[item_name]
    normalize_stats(user_id)
    save_data()
    if from_global_command:
        send_message(user_id, "\n".join(messages), None, vk_session)
    else:
        send_message(user_id, "\n".join(messages), create_backpack_menu_keyboard(), vk_session)
def apply_random_effect(user_id, vk_session):
    p = players[user_id]
    effects = [
        ("health", 0.5, "‚ù§Ô∏è +0.5 –∑–¥–æ—Ä–æ–≤—å—è"),
        ("health", -0.5, "üíî -0.5 –∑–¥–æ—Ä–æ–≤—å—è"),
        ("radiation", 0.5, "‚ò¢Ô∏è +0.5 —Ä–∞–¥–∏–∞—Ü–∏–∏"),
        ("radiation", -0.5, "‚ò¢Ô∏è -0.5 —Ä–∞–¥–∏–∞—Ü–∏–∏"),
        ("hunger", 0.5, "üçΩÔ∏è +0.5 –≥–æ–ª–æ–¥–∞"),
        ("hunger", -0.5, "üçΩÔ∏è -0.5 –≥–æ–ª–æ–¥–∞"),
        ("stamina", 0.5, "‚ö° +0.5 –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏"),
        ("stamina", -0.5, "‚ö° -0.5 –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏"),
    ]
    effect = random.choice(effects)
    attr, value, msg = effect
    if attr == "money":
        p["money"] = max(0, p.get("money", 0) + int(value))
    elif attr == "health":
        p["health"] = max(0, min(10, p["health"] + value))
    elif attr == "radiation":
        p["radiation"] = max(0, min(10, p["radiation"] + value))
    elif attr == "hunger":
        p["hunger"] = max(0, min(10, p["hunger"] + value))
    elif attr == "stamina":
        p["stamina"] = max(0, min(10, p["stamina"] + value))
    save_data()
    return msg
def find_player_by_mention_or_nickname(target, vk_session):
    target = target.strip()
    if target.startswith('@'):
        screen_name = target[1:].lower()
        for uid, data in players.items():
            if data.get("screen_name", "").lower() == screen_name:
                return uid
        return None
    target_lower = target.lower()
    for uid, data in players.items():
        nickname = data.get("nickname", "")
        if nickname.lower() == target_lower:
            return uid
    for uid, data in players.items():
        nickname = data.get("nickname", "")
        if target_lower in nickname.lower():
            return uid
    return None
def is_admin(user_id):
    return user_id == 353430025 or user_id in admin_users
def is_game_open():
    for faction in factions:
        if len(factions[faction]) < MAX_FACTION_SIZES[faction]:
            return False
    return True
def handle_global_commands(user_id, text, vk_session, reply_user_id=None):
    text_original = text.strip()
    text = text_original.lower()
    words = text.split()
    words_original = text_original.split()
    if user_id in banned_users and not is_admin(user_id):
        return True
    if text == "–∏–Ω—Ñ–æ":
        current_keyboard = None
        state = players[user_id]["state"]
        if state == STATE_IN_MENU:
            current_keyboard = create_main_menu_keyboard(user_id)
        elif state == STATE_IN_CAMP:
            current_keyboard = create_camp_menu_keyboard()
        elif state == STATE_IN_BACKPACK:
            current_keyboard = create_backpack_menu_keyboard()
        elif state == STATE_TRADER_MAIN:
            current_keyboard = create_trader_main_keyboard()
        elif state == STATE_TRADER_BUY_CATEGORY:
            current_keyboard = create_trader_category_keyboard()
        elif state == STATE_TRADER_SELL_CATEGORY:
            current_keyboard = create_trader_sell_category_keyboard()
        elif state == STATE_TRADER_BUY_EQUIPMENT:
            current_keyboard = create_equipment_category_keyboard()
        elif state == STATE_TRADER_SELL_EQUIPMENT_CONFIRM:
            current_keyboard = create_equipment_sell_keyboard()
        elif state == STATE_TRADER_REPAIR:
            current_keyboard = create_repair_keyboard(user_id)
        elif state == STATE_WAREHOUSE:
            current_keyboard = create_warehouse_keyboard()
        send_message(user_id, format_camp_info(user_id), current_keyboard, vk_session)
        return True
    if text == "*":
        state = players[user_id]["state"]
        if state in [STATE_TRANSITION_WAIT, STATE_RESTING]:
            send_message(user_id, "–ö–æ–º–∞–Ω–¥–∞ * –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∏–ª–∏ –æ—Ç–¥—ã—Ö–∞.", None, vk_session)
            return True
        if state == STATE_IN_MENU:
            send_message(user_id, MAIN_MENU_TEXT, create_main_menu_keyboard(user_id), vk_session)
        elif state == STATE_IN_CAMP:
            send_message(user_id, format_camp_info(user_id), create_camp_menu_keyboard(), vk_session)
        elif state == STATE_IN_BACKPACK:
            upload_and_send_inventory(user_id, vk_session)
            return True
        elif state == STATE_WAREHOUSE:
            upload_and_send_warehouse_global(user_id, vk_session)
            return True
        elif state == STATE_TRADER_MAIN:
            send_message(user_id, "–í—ã —Ö–æ—Ç–∏—Ç–µ —á—Ç–æ –ª–∏–±–æ üí≤ –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –∏–ª–∏ üí± –ø—Ä–æ–¥–∞—Ç—å?", create_trader_main_keyboard(), vk_session)
        elif state == STATE_TRADER_BUY_CATEGORY:
            send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:", create_trader_category_keyboard(), vk_session)
        elif state == STATE_TRADER_SELL_CATEGORY:
            send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:", create_trader_sell_category_keyboard(), vk_session)
        elif state == STATE_TRADER_BUY_EQUIPMENT:
            send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è:", create_equipment_category_keyboard(), vk_session)
        elif state == STATE_TRADER_SELL_EQUIPMENT_CONFIRM:
            send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏:", create_equipment_sell_keyboard(), vk_session)
        elif state == STATE_TRADER_BUY:
            show_buy_provisions_menu(user_id, vk_session)
            return True
        elif state == STATE_TRADER_SELL:
            show_sell_provisions_menu(user_id, vk_session)
            return True
        elif state == STATE_TRADER_REPAIR:
            p = players[user_id]
            money = p.get("money", 0)
            repair_text = (
                f"‚öôÔ∏è –ß—Ç–æ —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –ø–æ—á–∏–Ω–∏—Ç—å? üßê\n"
                f"‚ùó –†–µ–º–æ–Ω—Ç –Ω–∞ 1 –µ–¥–∏–Ω–∏—Ü—É –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –∑–∞ 15—Ä\n"
                f"üí≤ –î–µ–Ω—å–≥–∏: {money}—Ä")
            send_message(user_id, repair_text, create_repair_keyboard(user_id), vk_session)
            return True
        else:
            send_message(user_id, "–ö–æ–º–∞–Ω–¥–∞ * –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.", None, vk_session)
        return True
    if text == "2604":
        current_state = players.get(user_id, {}).get("state")
        if current_state in [STATE_TRANSITION_WAIT, STATE_HUNTING, STATE_HUNTING_SHOOTING]:
            send_message(user_id, "‚ùå –ö–æ–º–∞–Ω–¥–∞ 2604 –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç.", None, vk_session)
        elif user_id in players:
            players[user_id]["state"] = STATE_IN_MENU
            save_data()
            send_message(user_id, "‚úÖ –í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", create_main_menu_keyboard(user_id), vk_session)
        else:
            send_message(user_id, "‚ùå –í—ã –Ω–µ –≤ –∏–≥—Ä–µ.", None, vk_session)
        return True
    if words and words[0] in ["–∏—Å–ø", "–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å"] and len(words) >= 2:
        item_part = " ".join(words[1:])
        use_item(user_id, item_part, vk_session, from_global_command=True)
        return True
    if words and words[0] == "–ø–µ—Ä–µ–≤–µ—Å—Ç–∏" and len(words) >= 3:
        try:
            amount = int(words[1])
            target_str = words[2]
        except:
            send_message(user_id, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü—Ä–∏–º–µ—Ä: –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ 100 –Ω–∏–∫", None, vk_session)
            return True
        if amount <= 0:
            send_message(user_id, "‚ùå –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0.", None, vk_session)
            return True
        target_uid = find_player_by_mention_or_nickname(target_str, vk_session)
        if not target_uid:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –Ω–∏–∫—É.", None, vk_session)
            return True
        if target_uid == user_id:
            send_message(user_id, "‚ùå –ù–µ–ª—å–∑—è –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –¥–µ–Ω—å–≥–∏ —Å–∞–º–æ–º—É —Å–µ–±–µ.", None, vk_session)
            return True
        if target_uid in banned_users:
            send_message(user_id, "‚ùå –≠—Ç–æ—Ç –∏–≥—Ä–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.", None, vk_session)
            return True
        if players[user_id]["money"] < amount:
            send_message(user_id, f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥. –£ –≤–∞—Å {players[user_id]['money']}—Ä.", None, vk_session)
            return True
        players[user_id]["money"] -= amount
        players[target_uid]["money"] = players[target_uid].get("money", 0) + amount
        sender_nickname = players[user_id]["nickname"]
        save_data()
        send_message(user_id, f"‚úÖ –ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ {amount}—Ä –∏–≥—Ä–æ–∫—É {players[target_uid]['nickname']}.", None, vk_session)
        send_message(target_uid, f"üì• –í–∞–º –ø–µ—Ä–µ–≤—ë–ª(–∞) {sender_nickname}: {amount}—Ä", None, vk_session)
        return True
    if words and words[0] == "–æ—Ç–ø—Ä–∞–≤–∏—Ç—å":
        target_uid = None
        if reply_user_id:
            if reply_user_id in players:
                target_uid = reply_user_id
        if len(words) >= 4 and not target_uid:
            item_parts = []
            amount = None
            target_str = None
            for i in range(len(words_original) - 1, 0, -1):
                if target_str is None:
                    target_str = words_original[i]
                elif amount is None:
                    try:
                        amount = int(words_original[i])
                    except:
                        send_message(user_id, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü—Ä–∏–º–µ—Ä: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ö–ª–µ–± 2 –Ω–∏–∫", None, vk_session)
                        return True
                else:
                    item_parts = words_original[1:i+1]
                    break
            if not item_parts or amount is None or target_str is None:
                send_message(user_id, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü—Ä–∏–º–µ—Ä: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ö–ª–µ–± 2 –Ω–∏–∫", None, vk_session)
                return True
            item_name_original = " ".join(item_parts)
            target_uid = find_player_by_mention_or_nickname(target_str, vk_session)
        elif reply_user_id and len(words) >= 3:
            try:
                amount = int(words[-1])
                item_name_original = " ".join(words_original[1:-1])
            except:
                send_message(user_id, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü—Ä–∏–º–µ—Ä: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ö–ª–µ–± 2 (–æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)", None, vk_session)
                return True
        else:
            send_message(user_id, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü—Ä–∏–º–µ—Ä: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ö–ª–µ–± 2 –Ω–∏–∫ –∏–ª–∏ –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ", None, vk_session)
            return True
        if not target_uid:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session)
            return True
        if target_uid == user_id:
            send_message(user_id, "‚ùå –ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç —Å–∞–º–æ–º—É —Å–µ–±–µ.", None, vk_session)
            return True
        if target_uid in banned_users:
            send_message(user_id, "‚ùå –≠—Ç–æ—Ç –∏–≥—Ä–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.", None, vk_session)
            return True
        found_item = None
        for item in ITEM_EFFECTS.keys():
            if item.lower() == item_name_original.lower():
                found_item = item
                break
        if not found_item:
            for art in ALL_ARTIFACTS:
                if art.lower() == item_name_original.lower():
                    found_item = art
                    break
        if not found_item:
            for art in DONATION_ARTIFACTS:
                if art.lower() == item_name_original.lower():
                    found_item = art
                    break
        if not found_item:
            send_message(user_id, "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç.", None, vk_session)
            return True
        backpack = players[user_id]["backpack"]
        current_count = backpack.get(found_item, 0)
        if current_count < amount:
            send_message(user_id, f"‚ùå –£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤. –ï—Å—Ç—å: {current_count}.", None, vk_session)
            return True
        backpack[found_item] -= amount
        if backpack[found_item] <= 0:
            del backpack[found_item]
        players[target_uid]["backpack"][found_item] = players[target_uid]["backpack"].get(found_item, 0) + amount
        sender_nickname = players[user_id]["nickname"]
        save_data()
        send_message(user_id, f"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {found_item} x{amount} –∏–≥—Ä–æ–∫—É {players[target_uid]['nickname']}.", None, vk_session)
        send_message(target_uid, f"üì• –í–∞–º –æ—Ç–ø—Ä–∞–≤–∏–ª(–∞) {sender_nickname}: {found_item} x{amount}", None, vk_session)
        return True
    if text.lower().startswith("–∏–Ω—Ñ–æ "):
        info_parts = text.lower()[5:].strip().split()
        if len(info_parts) < 2:
            send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: –∏–Ω—Ñ–æ [–ª–æ–∫–∞—Ü–∏—è] [—Ç–æ—á–∫–∞]\n–ü—Ä–∏–º–µ—Ä: –∏–Ω—Ñ–æ –∫–æ—Ä–¥–æ–Ω –±1\n–°–æ–∫—Ä–∞—â–µ–Ω–∏—è: —Ç–¥ = –¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", None, vk_session)
            return True
        info_point = info_parts[-1].upper()
        info_loc_input = " ".join(info_parts[:-1])
        location_map = {"–∫–æ—Ä–¥–æ–Ω": "–ö–æ—Ä–¥–æ–Ω", "—Å–≤–∞–ª–∫–∞": "–°–≤–∞–ª–∫–∞", "—Ç—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞": "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "—Ç–µ–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞": "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "—Ç–¥": "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "–ø–æ–ª—è–Ω–∞": "–ü–æ–ª—è–Ω–∞"}
        info_location = location_map.get(info_loc_input)
        if not info_location:
            send_message(user_id, "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è.\n–î–æ—Å—Ç—É–ø–Ω–æ: –ö–æ—Ä–¥–æ–Ω, –°–≤–∞–ª–∫–∞, —Ç–¥, –ü–æ–ª—è–Ω–∞", None, vk_session)
            return True
        if not is_valid_point(info_location, info_point):
            send_message(user_id, f"‚ùå –¢–æ—á–∫–∞ {info_point} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ –ª–æ–∫–∞—Ü–∏–∏ {info_location}.", None, vk_session)
            return True
        owner = get_territory_owner(info_location, info_point)
        player_faction = players[user_id]["faction"]
        if owner != player_faction:
            send_message(user_id, "‚ùå –≠—Ç–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –≤–∞—à–µ–π –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–µ.", None, vk_session)
            return True
        squads_on_point = get_territory_squads(info_location, info_point)
        ptype = POINT_TYPES.get(info_point, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è")
        min_req = MIN_SQUADS_FOR_POINT.get(ptype, 1)
        send_message(user_id, f"üìç {info_location} {info_point}\nüë• –°–∫–≤–∞–¥–æ–≤: {squads_on_point}\nüè∑Ô∏è –¢–∏–ø: {ptype}\nüìã –ú–∏–Ω–∏–º—É–º –¥–ª—è —É–¥–µ—Ä–∂–∞–Ω–∏—è: {min_req}", None, vk_session)
        return True
    if text.lower().startswith("–ø–æ–≤–µ—Å–∏—Ç—å "):
        art_name = text[9:].strip()
        found_art = None
        for art in ALL_ARTIFACTS:
            if art.lower() == art_name.lower():
                found_art = art
                break
        if not found_art:
            send_message(user_id, "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç.", None, vk_session)
            return True
        if players[user_id]["backpack"].get(found_art, 0) <= 0:
            send_message(user_id, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç —ç—Ç–æ–≥–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞.", None, vk_session)
            return True
        belt = players[user_id].get("belt", [None, None, None])
        for i in range(3):
            if belt[i] is None:
                belt[i] = found_art
                players[user_id]["belt"] = belt
                players[user_id]["backpack"][found_art] -= 1
                if players[user_id]["backpack"][found_art] <= 0:
                    del players[user_id]["backpack"][found_art]
                save_data()
                send_message(user_id, f"‚úÖ {found_art} –ø–æ–≤–µ—à–µ–Ω –Ω–∞ –ø–æ—è—Å {i + 1}.", None, vk_session)
                return True
        send_message(user_id, "‚ùå –í—Å–µ –ø–æ—è—Å–∞ –∑–∞–Ω—è—Ç—ã.", None, vk_session)
        return True
    if text.lower().startswith("—Å–Ω—è—Ç—å "):
        art_name = text[6:].strip()
        belt = players[user_id].get("belt", [None, None, None])
        for i in range(3):
            if belt[i] and belt[i].lower() == art_name.lower():
                art = belt[i]
                belt[i] = None
                players[user_id]["belt"] = belt
                players[user_id]["backpack"][art] = players[user_id]["backpack"].get(art, 0) + 1
                save_data()
                send_message(user_id, f"‚úÖ {art} —Å–Ω—è—Ç —Å –ø–æ—è—Å–∞ {i + 1}.", None, vk_session)
                return True
        send_message(user_id, "‚ùå –≠—Ç–æ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –Ω–µ –Ω–∞ –ø–æ—è—Å–µ.", None, vk_session)
        return True
    if text == "/–±–æ–≥" and is_admin(user_id):
        p = players[user_id]
        p["money"] += 1000
        p["health"] = 10
        p["radiation"] = 0
        p["hunger"] = 0
        p["stamina"] = 10
        save_data()
        send_message(user_id, "‚úÖ –í—ã –ø–æ–ª—É—á–∏–ª–∏ 1000—Ä –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –≤—Å–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏.", None, vk_session)
        return True
    if text.startswith("/–ª–∏–¥–µ—Ä ") and is_admin(user_id):
        parts = text_original.split(maxsplit=1)
        if len(parts) < 2:
            send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–∏–∫ –∏–≥—Ä–æ–∫–∞.", None, vk_session)
            return True
        target_nick = parts[1].strip()
        target_uid = find_player_by_mention_or_nickname(target_nick, vk_session)
        if not target_uid:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session)
            return True
        target_faction = players[target_uid]["faction"]
        set_faction_leader(target_faction, target_uid)
        send_message(user_id, f"‚úÖ {target_nick} –Ω–∞–∑–Ω–∞—á–µ–Ω –ª–∏–¥–µ—Ä–æ–º –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ {target_faction}.", None, vk_session)
        send_message(target_uid, f"üëë –í—ã –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –ª–∏–¥–µ—Ä–æ–º –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ {target_faction}!", None, vk_session)
        return True
    if text.startswith("/—Å–µ—Ç ") and is_admin(user_id):
        parts = text_original.split(maxsplit=1)
        if len(parts) < 2:
            send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–∏–∫ –∏–≥—Ä–æ–∫–∞.", None, vk_session)
            return True
        target_nick = parts[1].strip()
        target_uid = find_player_by_mention_or_nickname(target_nick, vk_session)
        if not target_uid:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session)
            return True
        all_items = list(ITEM_EFFECTS.keys()) + ALL_ARTIFACTS
        for item in all_items:
            players[target_uid]["backpack"][item] = players[target_uid]["backpack"].get(item, 0) + 1
        save_data()
        send_message(user_id, f"‚úÖ –ò–≥—Ä–æ–∫—É {target_nick} –≤—ã–¥–∞–Ω—ã –≤—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã –ø–æ 1 —à—Ç.", None, vk_session)
        return True
    if text.startswith("/–≥–∏–≤ ") and is_admin(user_id):
        parts = text_original.split()
        if len(parts) < 3:
            send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: /–≥–∏–≤ [–ø—Ä–µ–¥–º–µ—Ç] [–∫–æ–ª-–≤–æ] [–Ω–∏–∫]\n–ù–∏–∫ –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω. –ü—Ä–∏–º–µ—Ä: /–≥–∏–≤ —Ö–ª–µ–± 5", None, vk_session)
            return True
        target_uid = None
        count = None
        item_end_index = len(parts)
        for i in range(len(parts) - 1, 1, -1):
            potential_nick = " ".join(parts[i:])
            found_uid = find_player_by_mention_or_nickname(potential_nick, vk_session)
            if found_uid:
                target_uid = found_uid
                try:
                    count = int(parts[i - 1])
                    item_end_index = i - 1
                    break
                except:
                    continue
        if target_uid is None:
            try:
                count = int(parts[-1])
                item_end_index = len(parts) - 1
                target_uid = user_id
            except:
                send_message(user_id, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.", None, vk_session)
                return True
        if count is None or count <= 0:
            send_message(user_id, "‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.", None, vk_session)
            return True
        item_name = " ".join(parts[1:item_end_index]).lower()
        if item_name == "–¥–µ–Ω—å–≥–∏":
            players[target_uid]["money"] = players[target_uid].get("money", 0) + count
            save_data()
            send_message(user_id, f"‚úÖ –í—ã–¥–∞–Ω–æ {count}—Ä –∏–≥—Ä–æ–∫—É {players[target_uid]['nickname']}.", None, vk_session)
            return True
        found_item = None
        for item in ITEM_EFFECTS.keys():
            if item.lower() == item_name:
                found_item = item
                break
        if not found_item:
            for art in ALL_ARTIFACTS:
                if art.lower() == item_name:
                    found_item = art
                    break
        if not found_item:
            send_message(user_id, "‚ùå –ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session)
            return True
        players[target_uid]["backpack"][found_item] = players[target_uid]["backpack"].get(found_item, 0) + count
        save_data()
        send_message(user_id, f"‚úÖ –í—ã–¥–∞–Ω–æ {found_item} x{count} –∏–≥—Ä–æ–∫—É {players[target_uid]['nickname']}.", None, vk_session)
        return True
    if text.startswith("/–¥—ç–ª ") and is_admin(user_id):
        parts = text_original.split()
        if len(parts) < 3:
            send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: /–¥—ç–ª [–ø—Ä–µ–¥–º–µ—Ç] [–∫–æ–ª-–≤–æ] [–Ω–∏–∫]\n–ù–∏–∫ –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω. –ü—Ä–∏–º–µ—Ä: /–¥—ç–ª —Ö–ª–µ–± 5", None, vk_session)
            return True
        target_uid = None
        count = None
        item_end_index = len(parts)
        for i in range(len(parts) - 1, 1, -1):
            potential_nick = " ".join(parts[i:])
            found_uid = find_player_by_mention_or_nickname(potential_nick, vk_session)
            if found_uid:
                target_uid = found_uid
                try:
                    count = int(parts[i - 1])
                    item_end_index = i - 1
                    break
                except:
                    continue
        if target_uid is None:
            try:
                count = int(parts[-1])
                item_end_index = len(parts) - 1
                target_uid = user_id
            except:
                send_message(user_id, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.", None, vk_session)
                return True
        if count is None or count <= 0:
            send_message(user_id, "‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.", None, vk_session)
            return True
        item_name = " ".join(parts[1:item_end_index]).lower()
        if item_name == "–¥–µ–Ω—å–≥–∏":
            players[target_uid]["money"] = max(0, players[target_uid].get("money", 0) - count)
            save_data()
            send_message(user_id, f"‚úÖ –£–¥–∞–ª–µ–Ω–æ {count}—Ä —É –∏–≥—Ä–æ–∫–∞ {players[target_uid]['nickname']}.", None, vk_session)
            return True
        found_item = None
        for item in ITEM_EFFECTS.keys():
            if item.lower() == item_name:
                found_item = item
                break
        if not found_item:
            for art in ALL_ARTIFACTS:
                if art.lower() == item_name:
                    found_item = art
                    break
        if not found_item:
            send_message(user_id, "‚ùå –ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session)
            return True
        current = players[target_uid]["backpack"].get(found_item, 0)
        players[target_uid]["backpack"][found_item] = max(0, current - count)
        if players[target_uid]["backpack"][found_item] <= 0:
            del players[target_uid]["backpack"][found_item]
        save_data()
        send_message(user_id, f"‚úÖ –£–¥–∞–ª–µ–Ω–æ {found_item} x{count} —É –∏–≥—Ä–æ–∫–∞ {players[target_uid]['nickname']}.", None, vk_session)
        return True
    if text.startswith("/–≤—ã–±—Ä–æ—Å") and is_admin(user_id):
        global emission_counter, EMISSION_MAX
        parts = text.split()
        if len(parts) >= 2:
            try:
                new_max = int(parts[1])
                if new_max < 50 or new_max > 10000:
                    send_message(user_id, "‚ùå –õ–∏–º–∏—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 50 –¥–æ 10000.", None, vk_session)
                    return True
                EMISSION_MAX = new_max
                save_data()
                send_message(user_id, f"‚úÖ –õ–∏–º–∏—Ç –≤—ã–±—Ä–æ—Å–∞ –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ {EMISSION_MAX}.", None, vk_session)
            except:
                send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ —á–∏—Å–ª–æ. –ü—Ä–∏–º–µ—Ä: /–≤—ã–±—Ä–æ—Å 600", None, vk_session)
            return True
        else:
            emission_counter = EMISSION_MAX - 15
            save_data()
            send_message(user_id, f"‚úÖ –®–∫–∞–ª–∞ –≤—ã–±—Ä–æ—Å–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ {emission_counter}/{EMISSION_MAX}.", None, vk_session)
            return True
    if text.startswith("/–¥–æ–Ω–∞—Ç ") and user_id == 353430025:
        parts = text_original.split()
        if len(parts) < 3:
            send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: /–¥–æ–Ω–∞—Ç [–¥–µ–Ω—å/–Ω–µ–¥–µ–ª—è/–º–µ—Å—è—Ü] [–ø–æ–Ω—á–∏–∫/—Å—Ç–µ–π–∫] [–Ω–∏–∫]", None, vk_session)
            return True
        duration_str = parts[1].lower()
        if duration_str not in DONATION_DURATIONS:
            send_message(user_id, "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å. –î–æ—Å—Ç—É–ø–Ω–æ: –¥–µ–Ω—å, –Ω–µ–¥–µ–ª—è, –º–µ—Å—è—Ü", None, vk_session)
            return True
        artifact_input = parts[2].lower()
        artifact = None
        for art in DONATION_ARTIFACTS:
            if art.lower() == artifact_input:
                artifact = art
                break
        if not artifact:
            send_message(user_id, "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç. –î–æ—Å—Ç—É–ø–Ω–æ: –ü–æ–Ω—á–∏–∫, –°—Ç–µ–π–∫", None, vk_session)
            return True
        target_uid = user_id
        if len(parts) >= 4:
            target_nick = parts[3].strip()
            found_uid = find_player_by_mention_or_nickname(target_nick, vk_session)
            if not found_uid:
                send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session)
                return True
            target_uid = found_uid
        duration = DONATION_DURATIONS[duration_str]
        p = players[target_uid]
        p["donation_end_time"] = time.time() + duration
        p["donation_artifact"] = artifact
        p["backpack"][artifact] = p["backpack"].get(artifact, 0) + 1
        bonus_msg = ""
        if duration_str == "–Ω–µ–¥–µ–ª—è":
            p["backpack"]["–Ω–∞—É—á–Ω–∞—è –∞–ø—Ç–µ—á–∫–∞"] = p["backpack"].get("–Ω–∞—É—á–Ω–∞—è –∞–ø—Ç–µ—á–∫–∞", 0) + 1
            p["backpack"]["–∞–Ω—Ç–∏—Ä–∞–¥"] = p["backpack"].get("–∞–Ω—Ç–∏—Ä–∞–¥", 0) + 1
            p["backpack"]["–∫–æ–Ω—Å–µ—Ä–≤–∞"] = p["backpack"].get("–∫–æ–Ω—Å–µ—Ä–≤–∞", 0) + 1
            p["backpack"]["–≥–µ—Ä–∫—É–ª–µ—Å"] = p["backpack"].get("–≥–µ—Ä–∫—É–ª–µ—Å", 0) + 1
            p["money"] = p.get("money", 0) + 100
            bonus_msg = "\n\nüéÅ –ë–æ–Ω—É—Å—ã –∑–∞ –Ω–µ–¥–µ–ª—é:\n‚Ä¢ –ù–∞—É—á–Ω–∞—è –∞–ø—Ç–µ—á–∫–∞ x1\n‚Ä¢ –ê–Ω—Ç–∏—Ä–∞–¥ x1\n‚Ä¢ –ö–æ–Ω—Å–µ—Ä–≤–∞ x1\n‚Ä¢ –ì–µ—Ä–∫—É–ª–µ—Å x1\n‚Ä¢ üí≤ 100—Ä"
        save_data()
        target_name = players[target_uid]["nickname"]
        end_time_str = time.strftime('%d.%m.%Y %H:%M', time.localtime(p["donation_end_time"]))
        send_message(user_id, f"‚úÖ –î–æ–Ω–∞—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –∏–≥—Ä–æ–∫—É {target_name} –Ω–∞ {duration_str}!\nüéÅ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç: {artifact}\n‚è∞ –î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: {end_time_str}{bonus_msg}", None, vk_session)
        if target_uid != user_id:
            send_message(target_uid, f"üéÅ –í–∞–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –¥–æ–Ω–∞—Ç –Ω–∞ {duration_str}!\nüåï –ê—Ä—Ç–µ—Ñ–∞–∫—Ç: {artifact}\n‚è∞ –î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: {end_time_str}{bonus_msg}", None, vk_session)
        return True
    if text.startswith("/—Ñ–æ—Ç–æ") and user_id == 353430025:
        parts = text_original.split(maxsplit=1)
        target_uid = None
        if len(parts) >= 2:
            target_nick = parts[1].strip()
            for uid, data in players.items():
                if data.get("nickname", "").lower() == target_nick.lower():
                    target_uid = uid
                    break
            if not target_uid:
                for uid, data in players.items():
                    nickname = data.get("nickname", "")
                    if target_nick.lower() in nickname.lower():
                        target_uid = uid
                        break
            if not target_uid:
                all_nicks = [f"'{p.get('nickname', '?')}'" for p in players.values() if p.get('nickname')]
                send_message(user_id, f"‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.\n\nüìã –ù–∏–∫–∏:\n{', '.join(all_nicks[:15])}", None, vk_session)
                return True
        elif reply_user_id and reply_user_id in players:
            target_uid = reply_user_id
        else:
            send_message(user_id, "‚ùå –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ –Ω–∏–∫", None, vk_session)
            return True
        players[user_id]["pending_photo_target"] = target_uid
        send_message(user_id, f"üì∑ –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–æ—Ç–æ –¥–ª—è –∏–≥—Ä–æ–∫–∞ {players[target_uid]['nickname']}:", None, vk_session)
        return True
    if text == "/–∫–æ–º–∞–Ω–¥—ã" and is_admin(user_id):
        faction_info = "\nüë• –ò–ì–†–û–ö–ò –í –ì–†–£–ü–ü–ò–†–û–í–ö–ê–•:\n"
        for faction in ["üõ°Ô∏è –î–æ–ª–≥", "‚ò¶Ô∏è –ì—Ä–µ—Ö", "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏"]:
            current = len(factions.get(faction, []))
            limit = MAX_FACTION_SIZES.get(faction, 5)
            faction_info += f"\n{faction}: {current}/{limit}"
        donators_list = []
        for uid, p in players.items():
            if has_active_donation(uid):
                end_time = p.get("donation_end_time", 0)
                end_str = time.strftime('%d.%m.%Y', time.localtime(end_time))
                donators_list.append(f"‚Ä¢ {p.get('nickname', '?')} (–¥–æ {end_str})")
        donators_info = "\n\nüíé –î–û–ù–ê–¢–ï–†–´:\n" + ("\n".join(donators_list) if donators_list else "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö")
        admins_list = []
        if 353430025 in players:
            admins_list.append(f"‚Ä¢ {players[353430025].get('nickname', '?')} (—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫)")
        for uid in admin_users:
            if uid in players and uid != 353430025:
                admins_list.append(f"‚Ä¢ {players[uid].get('nickname', '?')}")
        admins_info = "\n\nüëë –ê–î–ú–ò–ù–´:\n" + ("\n".join(admins_list) if admins_list else "–ù–µ—Ç")
        admin_help = f"""üìã –ê–î–ú–ò–ù –ö–û–ú–ê–ù–î–´:
{faction_info}{donators_info}{admins_info}

üîπ /–±–æ–≥
   –ü–æ–ª—É—á–∏—Ç—å 1000—Ä –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

üîπ /–ª–∏–¥–µ—Ä [–Ω–∏–∫]
   –ù–∞–∑–Ω–∞—á–∏—Ç—å –∏–≥—Ä–æ–∫–∞ –ª–∏–¥–µ—Ä–æ–º –µ–≥–æ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏

üîπ /—Å–µ—Ç [–Ω–∏–∫]
   –í—ã–¥–∞—Ç—å –∏–≥—Ä–æ–∫—É –≤—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã –ø–æ 1 —à—Ç

üîπ /–≥–∏–≤ [–ø—Ä–µ–¥–º–µ—Ç] [–∫–æ–ª-–≤–æ] [–Ω–∏–∫]
   –í—ã–¥–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç –∏–≥—Ä–æ–∫—É (–Ω–∏–∫ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   –ü—Ä–∏–º–µ—Ä: /–≥–∏–≤ —Ö–ª–µ–± 5 –ù–∏–∫–ò–≥—Ä–æ–∫–∞
   –ü—Ä–∏–º–µ—Ä: /–≥–∏–≤ –¥–µ–Ω—å–≥–∏ 1000

üîπ /–¥—ç–ª [–ø—Ä–µ–¥–º–µ—Ç] [–∫–æ–ª-–≤–æ] [–Ω–∏–∫]
   –£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç —É –∏–≥—Ä–æ–∫–∞
   –ü—Ä–∏–º–µ—Ä: /–¥—ç–ª —Ö–ª–µ–± 5 –ù–∏–∫–ò–≥—Ä–æ–∫–∞

üîπ /–≤—ã–±—Ä–æ—Å [–ª–∏–º–∏—Ç]
   –ë–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ - –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—ã–±—Ä–æ—Å
   –° —á–∏—Å–ª–æ–º - –∏–∑–º–µ–Ω–∏—Ç—å –ª–∏–º–∏—Ç –≤—ã–±—Ä–æ—Å–∞
   –ü—Ä–∏–º–µ—Ä: /–≤—ã–±—Ä–æ—Å 600

üîπ /–¥–æ–Ω–∞—Ç [–¥–µ–Ω—å/–Ω–µ–¥–µ–ª—è/–º–µ—Å—è—Ü] [–ø–æ–Ω—á–∏–∫/—Å—Ç–µ–π–∫] [–Ω–∏–∫]
   –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –¥–æ–Ω–∞—Ç –∏–≥—Ä–æ–∫—É
   –ü—Ä–∏–º–µ—Ä: /–¥–æ–Ω–∞—Ç –¥–µ–Ω—å –ø–æ–Ω—á–∏–∫ –ù–∏–∫–ò–≥—Ä–æ–∫–∞

üîπ /—Ñ–æ—Ç–æ [–Ω–∏–∫]
   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É –∏–≥—Ä–æ–∫—É (–ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º)

üîπ /–ª–∏–º–∏—Ç [–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞] [—á–∏—Å–ª–æ]
   –ò–∑–º–µ–Ω–∏—Ç—å –ª–∏–º–∏—Ç –∏–≥—Ä–æ–∫–æ–≤ –≤ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–µ
   –ü—Ä–∏–º–µ—Ä: /–ª–∏–º–∏—Ç –¥–æ–ª–≥ 6
   –ü—Ä–∏–º–µ—Ä: /–ª–∏–º–∏—Ç –æ–¥–∏–Ω–æ—á–∫–∏ 4

üîπ /—Å–º–µ–Ω–∏—Ç—å–≥–ø [–Ω–∏–∫] [–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞]
   –°–º–µ–Ω–∏—Ç—å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É –∏–≥—Ä–æ–∫—É
   –ü—Ä–∏–º–µ—Ä: /—Å–º–µ–Ω–∏—Ç—å–≥–ø –ù–∏–∫–ò–≥—Ä–æ–∫–∞ –¥–æ–ª–≥

üîπ /—Ç–µ–ª–µ–ø–æ—Ä—Ç [–Ω–∏–∫] [–ª–æ–∫–∞—Ü–∏—è] [—Ç–æ—á–∫–∞]
   –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∏–≥—Ä–æ–∫–∞ –Ω–∞ –ª–æ–∫–∞—Ü–∏—é
   –ü—Ä–∏–º–µ—Ä: /—Ç–µ–ª–µ–ø–æ—Ä—Ç –ù–∏–∫–ò–≥—Ä–æ–∫–∞ –ö–æ—Ä–¥–æ–Ω –ë1

üîπ /–Ω–∏–∫ [—Å—Ç–∞—Ä—ã–π_–Ω–∏–∫] [–Ω–æ–≤—ã–π_–Ω–∏–∫]
   –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∏–∫ –∏–≥—Ä–æ–∫–∞ (–∞–≤—Ç–æ–ø–æ–∏—Å–∫)
   –ü—Ä–∏–º–µ—Ä: /–Ω–∏–∫ –î–µ–ª–æ–≤–æ–π –ì–∞–Ω–≥—Å—Ç–µ—Ä –ö—Ä—É—Ç–æ–π –ë–æ—Å—Å

üîπ /–±–∞–Ω [–Ω–∏–∫] [–ø—Ä–∏—á–∏–Ω–∞]
   –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä–æ–∫–∞ –≤ –±–æ—Ç–µ
   –ü—Ä–∏–º–µ—Ä: /–±–∞–Ω –ü–ª–æ—Ö–æ–π –ò–≥—Ä–æ–∫ –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª

üîπ /—Ä–∞–∑–±–∞–Ω [–Ω–∏–∫]
   –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä–æ–∫–∞
   –ü—Ä–∏–º–µ—Ä: /—Ä–∞–∑–±–∞–Ω –ü–ª–æ—Ö–æ–π –ò–≥—Ä–æ–∫

üîπ /skip_cd
   –°–±—Ä–æ—Å–∏—Ç—å —Ç–∞–π–º–µ—Ä –ø–µ—Ä–µ—Ö–æ–¥–∞

üîπ /reset_all
   –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã

üîπ /–∞–¥–º–∏–Ω [–Ω–∏–∫]
   –ù–∞–∑–Ω–∞—á–∏—Ç—å –∏–≥—Ä–æ–∫–∞ –∞–¥–º–∏–Ω–æ–º (—Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫)

üîπ /–¥–µ–ª–∞–¥–º–∏–Ω [–Ω–∏–∫]
   –°–Ω—è—Ç—å –∏–≥—Ä–æ–∫–∞ —Å –∞–¥–º–∏–Ω–∫–∏ (—Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫)

üîπ 2604
   –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (–¥–ª—è –≤—Å–µ—Ö)
   
üîπ /–ø–æ—Å–ª–µ–¥–Ω–∏–π_—Ä—É–±–µ–∂
   –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∂–∏–º —Å –±–æ—Ç–æ–º-–ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–æ–º (—Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫)

üîπ /–∑–æ–º–±–∏
   –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞ –ó–æ–º–±–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö

üîπ /–∑–æ–º–±–∏_–∫–¥ [—Å–µ–∫—É–Ω–¥—ã]
   –ò–∑–º–µ–Ω–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–µ–π—Å—Ç–≤–∏–π –∑–æ–º–±–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
   –ü—Ä–∏–º–µ—Ä: /–∑–æ–º–±–∏_–∫–¥ 900 (15 –º–∏–Ω—É—Ç)
   
üîπ /—Ä—ã—Ü–∞—Ä—å [–Ω–∏–∫]
   –≠–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä–æ–∫–∞ –ª—É—á—à–∏–º —Å–Ω–∞—Ä—è–∂–µ–Ω–∏–µ–º –î–æ–ª–≥–∞ –∏ +500 —Å–∫–≤–∞–¥–æ–≤
   –ü—Ä–∏–º–µ—Ä: /—Ä—ã—Ü–∞—Ä—å –ù–∏–∫–ò–≥—Ä–æ–∫–∞

üîπ /–∑–æ–º–±–∏_—Å–∏–ª–∞ [+-—á–∏—Å–ª–æ]
   –î–æ–±–∞–≤–∏—Ç—å/—É–±—Ä–∞—Ç—å –±–æ–Ω—É—Å–Ω—ã–µ —Å–∫–≤–∞–¥—ã –∑–æ–º–±–∏
   –ü—Ä–∏–º–µ—Ä: /–∑–æ–º–±–∏_—Å–∏–ª–∞ +50"""
        send_message(user_id, admin_help, None, vk_session)
        return True
    if text.startswith("/–ª–∏–º–∏—Ç ") and is_admin(user_id):
        parts = text_original.split()
        if len(parts) < 3:
            send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: /–ª–∏–º–∏—Ç [–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞] [—á–∏—Å–ª–æ]\n–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏: –¥–æ–ª–≥, –≥—Ä–µ—Ö, –æ–¥–∏–Ω–æ—á–∫–∏", None, vk_session)
            return True
        faction_input = parts[1].lower()
        try:
            new_limit = int(parts[2])
        except:
            send_message(user_id, "‚ùå –õ–∏–º–∏—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.", None, vk_session)
            return True
        if new_limit < 1 or new_limit > 50:
            send_message(user_id, "‚ùå –õ–∏–º–∏—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 50.", None, vk_session)
            return True
        faction_map = {"–¥–æ–ª–≥": "üõ°Ô∏è –î–æ–ª–≥", "–≥—Ä–µ—Ö": "‚ò¶Ô∏è –ì—Ä–µ—Ö", "–æ–¥–∏–Ω–æ—á–∫–∏": "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏"}
        if faction_input not in faction_map:
            send_message(user_id, "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞. –î–æ—Å—Ç—É–ø–Ω–æ: –¥–æ–ª–≥, –≥—Ä–µ—Ö, –æ–¥–∏–Ω–æ—á–∫–∏", None, vk_session)
            return True
        faction_name = faction_map[faction_input]
        MAX_FACTION_SIZES[faction_name] = new_limit
        save_data()
        send_message(user_id, f"‚úÖ –õ–∏–º–∏—Ç –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ {faction_name} –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ {new_limit}.", None, vk_session)
        return True
    if text.startswith("/—Å–º–µ–Ω–∏—Ç—å–≥–ø") and is_admin(user_id):
        parts = text_original.split()
        if len(parts) < 2:
            send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: /—Å–º–µ–Ω–∏—Ç—å–≥–ø [–Ω–∏–∫] [–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞]\n–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏: –¥–æ–ª–≥, –≥—Ä–µ—Ö, –æ–¥–∏–Ω–æ—á–∫–∏, –∑–æ–º–±–∏\n–ò–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ: /—Å–º–µ–Ω–∏—Ç—å–≥–ø [–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞]", None, vk_session)
            return True
        faction_map = {"–¥–æ–ª–≥": "üõ°Ô∏è –î–æ–ª–≥", "–≥—Ä–µ—Ö": "‚ò¶Ô∏è –ì—Ä–µ—Ö", "–æ–¥–∏–Ω–æ—á–∫–∏": "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏", "–∑–æ–º–±–∏": ZOMBIE_FACTION, "–∑–æ–º–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ": ZOMBIE_FACTION}
        if reply_user_id and reply_user_id in players and len(parts) == 2:
            target_uid = reply_user_id
            faction_input = parts[1].lower()
        elif len(parts) >= 3:
            target_nick = " ".join(parts[1:-1])
            faction_input = parts[-1].lower()
            target_uid = find_player_by_mention_or_nickname(target_nick, vk_session)
        else:
            send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: /—Å–º–µ–Ω–∏—Ç—å–≥–ø [–Ω–∏–∫] [–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞]", None, vk_session)
            return True
        if not target_uid:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session)
            return True
        if faction_input not in faction_map:
            send_message(user_id, "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞. –î–æ—Å—Ç—É–ø–Ω–æ: –¥–æ–ª–≥, –≥—Ä–µ—Ö, –æ–¥–∏–Ω–æ—á–∫–∏, –∑–æ–º–±–∏", None, vk_session)
            return True
        new_faction = faction_map[faction_input]
        old_faction = players[target_uid].get("faction")
        if old_faction and target_uid in factions.get(old_faction, []):
            factions[old_faction].remove(target_uid)
        players[target_uid]["faction"] = new_faction
        if new_faction not in factions:
            factions[new_faction] = []
        if target_uid not in factions[new_faction]:
            factions[new_faction].append(target_uid)
        save_data()
        send_message(user_id, f"‚úÖ –ò–≥—Ä–æ–∫ {players[target_uid]['nickname']} –ø–µ—Ä–µ–≤–µ–¥—ë–Ω –≤ {new_faction}.", None, vk_session)
        send_message(target_uid, f"‚ö†Ô∏è –í–∞—Å –ø–µ—Ä–µ–≤–µ–ª–∏ –≤ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É {new_faction}!", None, vk_session)
        return True
    if text.startswith("/—Ç–µ–ª–µ–ø–æ—Ä—Ç ") and is_admin(user_id):
        parts = text_original.split()
        if len(parts) < 4:
            send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: /—Ç–µ–ª–µ–ø–æ—Ä—Ç [–Ω–∏–∫] [–ª–æ–∫–∞—Ü–∏—è] [—Ç–æ—á–∫–∞]\n–õ–æ–∫–∞—Ü–∏–∏: –ö–æ—Ä–¥–æ–Ω, –°–≤–∞–ª–∫–∞, —Ç–¥ (–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞), –ü–æ–ª—è–Ω–∞", None, vk_session)
            return True
        target_nick = parts[1]
        point = parts[-1].upper()
        location_parts = parts[2:-1]
        location_input = " ".join(location_parts).lower()
        target_uid = find_player_by_mention_or_nickname(target_nick, vk_session)
        if not target_uid:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session)
            return True
        location_map = {
            "–∫–æ—Ä–¥–æ–Ω": "–ö–æ—Ä–¥–æ–Ω",
            "—Å–≤–∞–ª–∫–∞": "–°–≤–∞–ª–∫–∞",
            "—Ç—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞": "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞",
            "—Ç–µ–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞": "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞",
            "—Ç–¥": "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞",
            "–ø–æ–ª—è–Ω–∞": "–ü–æ–ª—è–Ω–∞"
        }
        location = location_map.get(location_input)
        if not location:
            send_message(user_id, "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è.\n–î–æ—Å—Ç—É–ø–Ω–æ: –ö–æ—Ä–¥–æ–Ω, –°–≤–∞–ª–∫–∞, —Ç–¥ (–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞), –ü–æ–ª—è–Ω–∞", None, vk_session)
            return True
        if not is_valid_point(location, point):
            send_message(user_id, f"‚ùå –¢–æ—á–∫–∞ {point} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ –ª–æ–∫–∞—Ü–∏–∏ {location}.", None, vk_session)
            return True
        players[target_uid]["location"] = location
        players[target_uid]["point"] = point
        players[target_uid]["transition_end_time"] = None
        if players[target_uid].get("state") == STATE_TRANSITION_WAIT:
            players[target_uid]["state"] = STATE_IN_MENU
        save_data()
        send_message(user_id, f"‚úÖ –ò–≥—Ä–æ–∫ {target_nick} —Ç–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ {location} {point}.", None, vk_session)
        send_message(target_uid, f"‚ö° –í–∞—Å —Ç–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∏ –Ω–∞ {location} {point}!", None, vk_session)
        return True
    if text.startswith("/–Ω–∏–∫ ") and user_id == 353430025:
        content = text_original[5:].strip()
        if " > " in content:
            parts = content.split(" > ", 1)
            old_nick = parts[0].strip()
            new_nick = parts[1].strip()
            target_uid = None
            for uid, data in players.items():
                if data.get("nickname", "").lower() == old_nick.lower():
                    target_uid = uid
                    break
            if not target_uid:
                for uid, data in players.items():
                    if old_nick.lower() in data.get("nickname", "").lower():
                        target_uid = uid
                        break
            if not target_uid:
                all_nicks = [f"'{p.get('nickname', '?')}'" for p in players.values() if p.get('nickname')]
                send_message(user_id, f"‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.\n\nüìã –ù–∏–∫–∏: {', '.join(all_nicks[:10])}", None, vk_session)
                return True
            old_nickname = players[target_uid]["nickname"]
            players[target_uid]["nickname"] = new_nick
            save_data()
            send_message(user_id, f"‚úÖ –ù–∏–∫ –∏–∑–º–µ–Ω—ë–Ω:\n{old_nickname} ‚Üí {new_nick}", None, vk_session)
            send_message(target_uid, f"üìù –í–∞—à –Ω–∏–∫ –∏–∑–º–µ–Ω—ë–Ω –Ω–∞: {new_nick}", None, vk_session)
            return True
        if reply_user_id and reply_user_id in players:
            new_nick = content
            if not new_nick:
                send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–æ–≤—ã–π –Ω–∏–∫", None, vk_session)
                return True
            old_nickname = players[reply_user_id]["nickname"]
            players[reply_user_id]["nickname"] = new_nick
            save_data()
            send_message(user_id, f"‚úÖ –ù–∏–∫ –∏–∑–º–µ–Ω—ë–Ω:\n{old_nickname} ‚Üí {new_nick}", None, vk_session)
            send_message(reply_user_id, f"üìù –í–∞—à –Ω–∏–∫ –∏–∑–º–µ–Ω—ë–Ω –Ω–∞: {new_nick}", None, vk_session)
            return True
        send_message(user_id, "‚ùå –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:\n/–Ω–∏–∫ —Å—Ç–∞—Ä—ã–π > –Ω–æ–≤—ã–π", None, vk_session)
        return True
    if text.lower() == "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è":
        send_message(user_id, GAME_INFO_TEXT, None, vk_session)
        return True
    if text.startswith("/–±–∞–Ω ") and is_admin(user_id):
        content = text_original[5:].strip()
        if not content:
            send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–∏–∫ –∏–≥—Ä–æ–∫–∞.\n–§–æ—Ä–º–∞—Ç: /–±–∞–Ω [–Ω–∏–∫] [–ø—Ä–∏—á–∏–Ω–∞]", None, vk_session)
            return True
        parts = content.split(maxsplit=1)
        target_nick = parts[0]
        reason = parts[1] if len(parts) > 1 else "–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"
        target_uid = find_player_by_mention_or_nickname(target_nick, vk_session)
        if not target_uid:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session)
            return True
        if target_uid == user_id:
            send_message(user_id, "‚ùå –ù–µ–ª—å–∑—è –∑–∞–±–∞–Ω–∏—Ç—å —Å–µ–±—è.", None, vk_session)
            return True
        if target_uid == 353430025:
            send_message(user_id, "‚ùå –ù–µ–ª—å–∑—è –∑–∞–±–∞–Ω–∏—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞.", None, vk_session)
            return True
        if target_uid in banned_users:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ —É–∂–µ –∑–∞–±–∞–Ω–µ–Ω.", None, vk_session)
            return True
        target_faction = players[target_uid].get("faction")
        if target_faction and target_uid in factions.get(target_faction, []):
            factions[target_faction].remove(target_uid)
        banned_users[target_uid] = reason
        save_data()
        send_message(user_id, f"‚úÖ –ò–≥—Ä–æ–∫ {players[target_uid]['nickname']} –∑–∞–±–∞–Ω–µ–Ω.\nüìù –ü—Ä–∏—á–∏–Ω–∞: {reason}", None, vk_session)
        send_message(target_uid, f"üö´ –í—ã –±—ã–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ –∏–≥—Ä–µ.\nüìù –ü—Ä–∏—á–∏–Ω–∞: {reason}", None, vk_session)
        return True
    if text.startswith("/—Ä–∞–∑–±–∞–Ω ") and is_admin(user_id):
        target_nick = text_original[8:].strip()
        if not target_nick:
            send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–∏–∫ –∏–≥—Ä–æ–∫–∞.", None, vk_session)
            return True
        target_uid = find_player_by_mention_or_nickname(target_nick, vk_session)
        if not target_uid:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session)
            return True
        if target_uid not in banned_users:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –∑–∞–±–∞–Ω–µ–Ω.", None, vk_session)
            return True
        del banned_users[target_uid]
        save_data()
        send_message(user_id, f"‚úÖ –ò–≥—Ä–æ–∫ {players[target_uid]['nickname']} —Ä–∞–∑–±–∞–Ω–µ–Ω.", None, vk_session)
        send_message(target_uid, "‚úÖ –í—ã –±—ã–ª–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ –∏–≥—Ä–µ.", None, vk_session)
        return True
    if text.startswith("/–∞–¥–º–∏–Ω ") and user_id == 353430025:
        target_nick = text_original[7:].strip()
        if not target_nick:
            send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–∏–∫ –∏–≥—Ä–æ–∫–∞.", None, vk_session)
            return True
        target_uid = find_player_by_mention_or_nickname(target_nick, vk_session)
        if not target_uid:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session)
            return True
        if target_uid == user_id:
            send_message(user_id, "‚ùå –í—ã —É–∂–µ –≥–ª–∞–≤–Ω—ã–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫.", None, vk_session)
            return True
        if target_uid in admin_users:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ —É–∂–µ –∞–¥–º–∏–Ω.", None, vk_session)
            return True
        admin_users.append(target_uid)
        save_data()
        send_message(user_id, f"‚úÖ –ò–≥—Ä–æ–∫ {players[target_uid]['nickname']} –Ω–∞–∑–Ω–∞—á–µ–Ω –∞–¥–º–∏–Ω–æ–º.", None, vk_session)
        send_message(target_uid, "üëë –í—ã –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –±–æ—Ç–∞!", None, vk_session)
        return True
    if text.startswith("/–¥–µ–ª–∞–¥–º–∏–Ω ") and user_id == 353430025:
        target_nick = text_original[10:].strip()
        if not target_nick:
            send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–∏–∫ –∏–≥—Ä–æ–∫–∞.", None, vk_session)
            return True
        target_uid = find_player_by_mention_or_nickname(target_nick, vk_session)
        if not target_uid:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session)
            return True
        if target_uid not in admin_users:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–æ–º.", None, vk_session)
            return True
        admin_users.remove(target_uid)
        save_data()
        send_message(user_id, f"‚úÖ –ò–≥—Ä–æ–∫ {players[target_uid]['nickname']} —Å–Ω—è—Ç —Å –∞–¥–º–∏–Ω–∫–∏.", None, vk_session)
        send_message(target_uid, "‚ö†Ô∏è –í—ã –±–æ–ª—å—à–µ –Ω–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –±–æ—Ç–∞.", None, vk_session)
        return True
    if text == "/–∏–Ω–≤" or text == "–∏–Ω–≤":
        p = players[user_id]
        backpack = p.get("backpack", {})
        money = p.get("money", 0)
        if not backpack or all(v <= 0 for v in backpack.values()):
            items_str = "–ü—É—Å—Ç–æ"
        else:
            items_list = []
            for item, count in backpack.items():
                if count > 0:
                    items_list.append(f"‚Ä¢ {item}: {count}")
            items_str = "\n".join(items_list)
        msg = f"üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –∏–≥—Ä–æ–∫–∞ {p.get('nickname', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π')}:\n\n{items_str}\n\nüí≤ –î–µ–Ω—å–≥–∏: {money}—Ä"
        send_message(user_id, msg, None, vk_session)
        return True
    if text == "/—Å–æ–Ω" or text == "—Å–æ–Ω":
        p = players[user_id]
        if p.get("state") != STATE_RESTING:
            send_message(user_id, "‚ùå –í—ã –Ω–µ –æ—Ç–¥—ã—Ö–∞–µ—Ç–µ.", None, vk_session)
            return True
        start_time = p.get("rest_start_time")
        if not start_time:
            send_message(user_id, "‚ùå –û—à–∏–±–∫–∞: –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –æ—Ç–¥—ã—Ö–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.", None, vk_session)
            return True
        current_time = time.time()
        elapsed = current_time - start_time
        initial = p.get("initial_stamina", p["stamina"])
        belt_bonus = apply_belt_effects_on_rest(user_id)
        donation_bonus = 1 if has_active_donation(user_id) else 0
        total_bonus = 1 + belt_bonus + donation_bonus
        elapsed_intervals = int(elapsed // 360)
        current_stamina = min(10, initial + elapsed_intervals * total_bonus)
        seconds_in_current_interval = elapsed % 360
        seconds_to_next = int(360 - seconds_in_current_interval)
        next_mins = seconds_to_next // 60
        next_secs = seconds_to_next % 60
        if current_stamina >= 10:
            total_remaining = 0
        else:
            stamina_after_next = min(10, current_stamina + total_bonus)
            if stamina_after_next >= 10:
                total_remaining = seconds_to_next
            else:
                remaining_after_next = 10 - stamina_after_next
                intervals_after_next = int(remaining_after_next / total_bonus)
                if remaining_after_next % total_bonus > 0:
                    intervals_after_next += 1
                total_remaining = seconds_to_next + intervals_after_next * 360
        total_mins = total_remaining // 60
        total_secs = total_remaining % 60
        msg = f"üò¥ –°—Ç–∞—Ç—É—Å –æ—Ç–¥—ã—Ö–∞:\n"
        msg += f"‚ö° –¢–µ–∫—É—â–∞—è –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å: {current_stamina}/10\n"
        msg += f"üîã –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞ 6 –º–∏–Ω: +{total_bonus}\n"
        msg += f"‚è±Ô∏è –î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: {next_mins} –º–∏–Ω {next_secs} —Å–µ–∫\n"
        msg += f"‚è±Ô∏è –î–æ –ø–æ–ª–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: {total_mins} –º–∏–Ω {total_secs} —Å–µ–∫"
        send_message(user_id, msg, None, vk_session)
        return True
    if text == "/–ø–æ—Å–ª–µ–¥–Ω–∏–π_—Ä—É–±–µ–∂" and user_id == 353430025:
        init_last_stand_mode()
        for uid in players:
            if uid in banned_users:
                continue
            faction = players[uid].get("faction")
            if faction and faction != ZOMBIE_FACTION:
                send_message(uid, "üßü –†–ï–ñ–ò–ú –ü–û–°–õ–ï–î–ù–ò–ô –†–£–ë–ï–ñ –ê–ö–¢–ò–í–ò–†–û–í–ê–ù!\n\n‚ö†Ô∏è –í—Å–µ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –Ω–∞ –ö–æ—Ä–¥–æ–Ω!\nüßü –ó–æ–º–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞—Ö–≤–∞—Ç–∏–ª–∏ –°–≤–∞–ª–∫—É, –ü–æ–ª—è–Ω—É –∏ –¢—ë–º–Ω—É—é –¥–æ–ª–∏–Ω—É!\n\n‚öîÔ∏è –û–±—ä–µ–¥–∏–Ω–∏—Ç–µ—Å—å –¥–ª—è –≤—ã–∂–∏–≤–∞–Ω–∏—è!", None, vk_session)
        try:
            vk_session.method("messages.send", {"peer_id": GAME_CHAT_ID, "message": "üßü –†–ï–ñ–ò–ú –ü–û–°–õ–ï–î–ù–ò–ô –†–£–ë–ï–ñ –ê–ö–¢–ò–í–ò–†–û–í–ê–ù!\n\n–ó–æ–º–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞—Ç–∞–∫—É—é—Ç –ó–æ–Ω—É!", "random_id": 0})
        except:
            pass
        send_message(user_id, "‚úÖ –†–µ–∂–∏–º –ü–æ—Å–ª–µ–¥–Ω–∏–π –†—É–±–µ–∂ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!", None, vk_session)
        return True
    if text == "/–∑–æ–º–±–∏" and is_admin(user_id):
        if not LAST_STAND_MODE:
            send_message(user_id, "‚ùå –†–µ–∂–∏–º –ü–æ—Å–ª–µ–¥–Ω–∏–π –†—É–±–µ–∂ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω.", None, vk_session)
            return True
        send_message(user_id, get_zombie_status(), None, vk_session)
        return True
    if text.startswith("/–∑–æ–º–±–∏_–∫–¥") and is_admin(user_id):
        global ZOMBIE_ACTION_INTERVAL
        parts = text.split()
        if len(parts) >= 2:
            try:
                new_interval = int(parts[1])
                if new_interval < 60 or new_interval > 7200:
                    send_message(user_id, "‚ùå –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 60 –¥–æ 7200 —Å–µ–∫—É–Ω–¥.", None, vk_session)
                    return True
                ZOMBIE_ACTION_INTERVAL = new_interval
                save_data()
                mins = new_interval // 60
                secs = new_interval % 60
                send_message(user_id, f"‚úÖ –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–µ–π—Å—Ç–≤–∏–π –∑–æ–º–±–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö: {mins} –º–∏–Ω {secs} —Å–µ–∫.", None, vk_session)
            except:
                send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ —á–∏—Å–ª–æ —Å–µ–∫—É–Ω–¥. –ü—Ä–∏–º–µ—Ä: /–∑–æ–º–±–∏_–∫–¥ 900", None, vk_session)
            return True
        else:
            mins = ZOMBIE_ACTION_INTERVAL // 60
            secs = ZOMBIE_ACTION_INTERVAL % 60
            send_message(user_id, f"‚è±Ô∏è –¢–µ–∫—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª: {mins} –º–∏–Ω {secs} —Å–µ–∫.\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /–∑–æ–º–±–∏_–∫–¥ [—Å–µ–∫—É–Ω–¥—ã]", None, vk_session)
            return True
    if text == "/–∑–æ–º–±–∏_—Ü–µ–ª—å":
        if not LAST_STAND_MODE:
            send_message(user_id, "‚ùå –†–µ–∂–∏–º –ü–æ—Å–ª–µ–¥–Ω–∏–π –†—É–±–µ–∂ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω.", None, vk_session)
            return True
        if players[user_id].get("faction") != ZOMBIE_FACTION:
            send_message(user_id, "‚ùå –í—ã –Ω–µ –≤ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–µ –ó–æ–º–±–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö.", None, vk_session)
            return True
        leader = get_faction_leader(ZOMBIE_FACTION)
        if leader != user_id and not is_admin(user_id):
            send_message(user_id, "‚ùå –¢–æ–ª—å–∫–æ –ª–∏–¥–µ—Ä –∑–æ–º–±–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –±–æ—Ç–æ–º.", None, vk_session)
            return True
        mode = zombie_bot.get("mode", "normal")
        priority = zombie_bot.get("priority_target")
        msg = f"üßü –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–û–ú–ë–ò–†–û–í–ê–ù–ù–´–ú–ò\n\nüéØ –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: {mode}\nüéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è —Ü–µ–ª—å: {priority if priority else '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'}\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞:"
        players[user_id]["state"] = "zombie_control"
        save_data()
        send_message(user_id, msg, create_zombie_control_keyboard(), vk_session)
        return True
    if text.startswith("/–∑–æ–º–±–∏_–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ") and is_admin(user_id):
        if not LAST_STAND_MODE:
            send_message(user_id, "‚ùå –†–µ–∂–∏–º –ü–æ—Å–ª–µ–¥–Ω–∏–π –†—É–±–µ–∂ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω.", None, vk_session)
            return True
        parts = text.split()
        if len(parts) < 3:
            send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: /–∑–æ–º–±–∏_–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç [–ª–æ–∫–∞—Ü–∏—è] [—Ç–æ—á–∫–∞]\n–ü—Ä–∏–º–µ—Ä: /–∑–æ–º–±–∏_–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ö–æ—Ä–¥–æ–Ω –ë1", None, vk_session)
            return True
        point = parts[-1].upper()
        loc_input = " ".join(parts[1:-1]).lower()
        location_map = {"–∫–æ—Ä–¥–æ–Ω": "–ö–æ—Ä–¥–æ–Ω", "—Å–≤–∞–ª–∫–∞": "–°–≤–∞–ª–∫–∞", "—Ç—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞": "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "—Ç–µ–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞": "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "—Ç–¥": "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "–ø–æ–ª—è–Ω–∞": "–ü–æ–ª—è–Ω–∞"}
        location = location_map.get(loc_input)
        if not location:
            send_message(user_id, "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è.", None, vk_session)
            return True
        if not is_valid_point(location, point):
            send_message(user_id, f"‚ùå –¢–æ—á–∫–∞ {point} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ {location}.", None, vk_session)
            return True
        zombie_bot["priority_target"] = (location, point)
        save_data()
        send_message(user_id, f"‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è —Ü–µ–ª—å: {location} {point}", None, vk_session)
        return True
    if text == "/–ø–æ—Å–ª–µ–¥–Ω–∏–π_—Ä—É–±–µ–∂2" and user_id == 353430025:
        init_last_stand_mode_v2()
        for uid in players:
            if uid in banned_users:
                continue
            faction = players[uid].get("faction")
            if faction and faction != ZOMBIE_FACTION:
                send_message(uid, "üßü –†–ï–ñ–ò–ú –ü–û–°–õ–ï–î–ù–ò–ô –†–£–ë–ï–ñ v2 –ê–ö–¢–ò–í–ò–†–û–í–ê–ù!\n\n‚ö†Ô∏è –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –Ω–∞ —Å–≤–æ–∏—Ö –±–∞–∑–∞—Ö!\nüßü –ó–æ–º–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞—Ö–≤–∞—Ç–∏–ª–∏ –ü–æ–ª—è–Ω—É —Å —Å–∏–ª–æ–π 100!\n\n‚öîÔ∏è –û–±—ä–µ–¥–∏–Ω–∏—Ç–µ—Å—å –¥–ª—è –≤—ã–∂–∏–≤–∞–Ω–∏—è!", None, vk_session)
        try:
            vk_session.method("messages.send", {"peer_id": GAME_CHAT_ID, "message": "üßü –†–ï–ñ–ò–ú –ü–û–°–õ–ï–î–ù–ò–ô –†–£–ë–ï–ñ v2!\n\n–ó–æ–º–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞ –ü–æ–ª—è–Ω–µ —Å —Å–∏–ª–æ–π 100!", "random_id": 0})
        except:
            pass
        send_message(user_id, "‚úÖ –†–µ–∂–∏–º –ü–æ—Å–ª–µ–¥–Ω–∏–π –†—É–±–µ–∂ v2 –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!", None, vk_session)
        return True
    if text.startswith("/–∑–æ–º–±–∏_—Å–∏–ª–∞") and is_admin(user_id):
        if not LAST_STAND_MODE:
            send_message(user_id, "‚ùå –†–µ–∂–∏–º –ü–æ—Å–ª–µ–¥–Ω–∏–π –†—É–±–µ–∂ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω.", None, vk_session)
            return True
        parts = text.split()
        if len(parts) < 2:
            current = zombie_bot.get("bonus_squads", 0)
            send_message(user_id, f"üë®‚Äçüë®‚Äçüë¶‚Äçüë¶ –ë–æ–Ω—É—Å–Ω—ã–µ —Å–∫–≤–∞–¥—ã –∑–æ–º–±–∏: {current}\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /–∑–æ–º–±–∏_—Å–∏–ª–∞ +50 –∏–ª–∏ /–∑–æ–º–±–∏_—Å–∏–ª–∞ -20", None, vk_session)
            return True
        try:
            value = int(parts[1])
            zombie_bot["bonus_squads"] = zombie_bot.get("bonus_squads", 0) + value
            zombie_bot["squads"] = zombie_bot.get("squads", 0) + value
            if zombie_bot["squads"] < 0:
                zombie_bot["squads"] = 0
            if zombie_bot["bonus_squads"] < 0:
                zombie_bot["bonus_squads"] = 0
            save_data()
            send_message(user_id, f"‚úÖ –°–∫–≤–∞–¥—ã –∑–æ–º–±–∏ –∏–∑–º–µ–Ω–µ–Ω—ã –Ω–∞ {value}.\n–¢–µ–∫—É—â–∏–µ —Å–∫–≤–∞–¥—ã: {zombie_bot['squads']}\n–ë–æ–Ω—É—Å: {zombie_bot['bonus_squads']}", None, vk_session)
        except:
            send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ —á–∏—Å–ª–æ. –ü—Ä–∏–º–µ—Ä: /–∑–æ–º–±–∏_—Å–∏–ª–∞ +50", None, vk_session)
        return True
    if text.startswith("/—Ä—ã—Ü–∞—Ä—å") and is_admin(user_id):
        parts = text_original.split()
        if len(parts) >= 2:
            target_nick = " ".join(parts[1:])
            target_uid = find_player_by_mention_or_nickname(target_nick, vk_session)
            if not target_uid:
                send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session)
                return True
        elif reply_user_id and reply_user_id in players:
            target_uid = reply_user_id
        else:
            target_uid = user_id
        p = players[target_uid]
        p["weapon"] = "–ì—Ä–æ–º –°14"
        p["weapon_durability"] = 4
        p["weapon_max_durability"] = 4
        p["weapon_damage"] = 4.5
        p["weapon_accuracy"] = 3
        p["armor"] = "–≠–∫–∑–æ—Å–∫–µ–ª–µ—Ç ¬´–î–æ–ª–≥–∞¬ª"
        p["armor_durability"] = 7
        p["armor_max_durability"] = 7
        p["bullet_resist"] = 4
        p["blast_resist"] = 5
        p["anomaly_resist"] = 1
        p["detector"] = "–°–≤–∞—Ä–æ–≥"
        p["detector_charge"] = 24
        p["detector_max_charge"] = 24
        p["squads"] = p.get("squads", 0) + 500
        p["health"] = 10
        p["radiation"] = 0
        p["hunger"] = 0
        p["stamina"] = 10
        save_data()
        target_name = players[target_uid]["nickname"]
        send_message(user_id, f"‚öîÔ∏è {target_name} —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ –†—ã—Ü–∞—Ä—å –î–æ–ª–≥–∞!\n\nüî´ –ì—Ä–æ–º –°14\nü¶∫ –≠–∫–∑–æ—Å–∫–µ–ª–µ—Ç ¬´–î–æ–ª–≥–∞¬ª\nüìü –°–≤–∞—Ä–æ–≥\nüë®‚Äçüë®‚Äçüë¶‚Äçüë¶ +500 —Å–∫–≤–∞–¥–æ–≤\n‚ù§Ô∏è –ü–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ", None, vk_session)
        if target_uid != user_id:
            send_message(target_uid, "‚öîÔ∏è –í—ã —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ –†—ã—Ü–∞—Ä—å –î–æ–ª–≥–∞!\n\nüî´ –ì—Ä–æ–º –°14\nü¶∫ –≠–∫–∑–æ—Å–∫–µ–ª–µ—Ç ¬´–î–æ–ª–≥–∞¬ª\nüìü –°–≤–∞—Ä–æ–≥\nüë®‚Äçüë®‚Äçüë¶‚Äçüë¶ +500 —Å–∫–≤–∞–¥–æ–≤", None, vk_session)
        return True
    return False
def generate_inventory_image(user_id):
    p = players[user_id]
    backpack = p.get("backpack", {})
    CELL_SIZE = 50
    INV_COLS = 6
    INV_ROWS = 10
    LEFT_PANEL_WIDTH = 210
    INV_WIDTH = INV_COLS * CELL_SIZE + 15
    width = LEFT_PANEL_WIDTH + INV_WIDTH + 5
    height = INV_ROWS * CELL_SIZE + 40
    try:
        bg = Image.open("backgrounds/inventory_bg.png").convert("RGBA").resize((width, height))
    except:
        bg = Image.new("RGBA", (width, height), (20, 25, 20, 255))
    img = bg.copy()
    draw = ImageDraw.Draw(img)
    try:
        font = ImageFont.truetype("Graffiti1C.ttf", 16)
        font_small = ImageFont.truetype("Graffiti1C.ttf", 12)
        font_title = ImageFont.truetype("Graffiti1C.ttf", 18)
    except:
        try:
            font = ImageFont.truetype("arial.ttf", 16)
            font_small = ImageFont.truetype("arial.ttf", 12)
            font_title = ImageFont.truetype("arial.ttf", 18)
        except:
            font = ImageFont.load_default()
            font_small = font
            font_title = font
    COLOR_FRAME = (70, 80, 60, 255)
    COLOR_FRAME_LIGHT = (100, 110, 85, 255)
    COLOR_SLOT_EMPTY = (40, 45, 40, 180)
    COLOR_HEALTH = (200, 60, 60, 255)
    COLOR_RADIATION = (80, 200, 80, 255)
    COLOR_HUNGER = (200, 170, 60, 255)
    COLOR_STAMINA = (80, 160, 200, 255)
    all_icons = {**ITEM_ICONS, **ARTIFACT_ICONS}
    def draw_text_with_outline(x, y, text, font_used, fill=(255, 255, 255)):
        for dx, dy in [(-1, 0), (1, 0), (0, -1), (0, 1), (-1, -1), (1, 1), (-1, 1), (1, -1)]:
            draw.text((x + dx, y + dy), text, fill=(0, 0, 0), font=font_used)
        draw.text((x, y), text, fill=fill, font=font_used)
    def draw_stalker_frame(x, y, w, h, title=None):
        draw.rectangle([x, y, x + w, y + h], fill=(30, 35, 30, 200), outline=COLOR_FRAME, width=2)
        draw.line([(x, y), (x + 8, y)], fill=COLOR_FRAME_LIGHT, width=2)
        draw.line([(x, y), (x, y + 8)], fill=COLOR_FRAME_LIGHT, width=2)
        draw.line([(x + w - 8, y), (x + w, y)], fill=COLOR_FRAME_LIGHT, width=2)
        draw.line([(x + w, y), (x + w, y + 8)], fill=COLOR_FRAME_LIGHT, width=2)
        draw.line([(x, y + h - 8), (x, y + h)], fill=COLOR_FRAME_LIGHT, width=2)
        draw.line([(x, y + h), (x + 8, y + h)], fill=COLOR_FRAME_LIGHT, width=2)
        draw.line([(x + w, y + h - 8), (x + w, y + h)], fill=COLOR_FRAME_LIGHT, width=2)
        draw.line([(x + w - 8, y + h), (x + w, y + h)], fill=COLOR_FRAME_LIGHT, width=2)
        if title:
            draw_text_with_outline(x + 5, y + 3, title, font_small)
    def draw_bar_stalker(x, y, w, h, value, max_val, color, label_icon):
        draw.rectangle([x, y, x + w, y + h], fill=(20, 25, 20, 255), outline=COLOR_FRAME, width=1)
        if max_val > 0:
            fill_w = int((value / max_val) * (w - 4))
            if fill_w > 0:
                for i in range(fill_w):
                    draw.line([(x + 2 + i, y + 2), (x + 2 + i, y + h - 2)], fill=color, width=1)
        draw_text_with_outline(x + w + 5, y - 2, f"{label_icon}{value}/{max_val}", font)
    panel_x = 5
    panel_y = 5
    avatar_size = int(CELL_SIZE * 2 / 1.5)
    avatar_x = panel_x + 3
    avatar_y = panel_y + 3
    draw.rectangle([avatar_x - 2, avatar_y - 2, avatar_x + avatar_size + 2, avatar_y + avatar_size + 2], outline=COLOR_FRAME, width=2)
    avatar_path = os.path.join(AVATAR_DIR, f"{user_id}.png")
    if os.path.exists(avatar_path):
        try:
            avatar = Image.open(avatar_path).convert("RGBA").resize((avatar_size, avatar_size))
            img.paste(avatar, (avatar_x, avatar_y), avatar)
        except:
            draw.rectangle([avatar_x, avatar_y, avatar_x + avatar_size, avatar_y + avatar_size], fill=COLOR_SLOT_EMPTY)
    else:
        draw.rectangle([avatar_x, avatar_y, avatar_x + avatar_size, avatar_y + avatar_size], fill=COLOR_SLOT_EMPTY)
    info_x = avatar_x + avatar_size + 10
    info_y = avatar_y
    draw_text_with_outline(info_x, info_y, f"{p['nickname']}", font_title)
    info_y += 22
    faction = p.get("faction", "")
    faction_icon_path = FACTION_ICONS.get(faction)
    faction_icon_size = 18
    if faction_icon_path and os.path.exists(faction_icon_path):
        try:
            faction_icon = Image.open(faction_icon_path).convert("RGBA").resize((faction_icon_size, faction_icon_size))
            img.paste(faction_icon, (info_x, info_y), faction_icon)
        except:
            pass
    faction_clean = faction.replace("üõ°Ô∏è ", "").replace("‚ò¶Ô∏è ", "").replace("‚ò¢Ô∏è ", "")
    draw_text_with_outline(info_x + faction_icon_size + 5, info_y, f"{faction_clean}", font)
    info_y += 22
    location = p.get("location", "–õ–∞–≥–µ—Ä—å")
    point = p.get("point", "–ë1")
    draw_text_with_outline(info_x, info_y, f"{location} {point}", font)
    info_y += 20
    money = p.get("money", 0)
    draw_text_with_outline(info_x, info_y, f"$ {money} RU", font)
    belt_y = height - 130
    draw_text_with_outline(panel_x + 5, belt_y - 18, "–ü–û–Ø–°", font_small)
    belt = p.get("belt", [None, None, None])
    belt_cell_size = 40
    belt_spacing = 6
    for i in range(3):
        cell_x = panel_x + 5 + i * (belt_cell_size + belt_spacing)
        draw.rectangle([cell_x, belt_y, cell_x + belt_cell_size, belt_y + belt_cell_size], fill=COLOR_SLOT_EMPTY, outline=COLOR_FRAME, width=1)
        draw_text_with_outline(cell_x + 3, belt_y + 2, f"{i+1}", font_small)
        if belt[i]:
            icon_path = all_icons.get(belt[i])
            if icon_path and os.path.exists(icon_path):
                try:
                    belt_icon = Image.open(icon_path).convert("RGBA").resize((belt_cell_size - 8, belt_cell_size - 8))
                    img.paste(belt_icon, (cell_x + 4, belt_y + 4), belt_icon)
                except:
                    pass
    stats_y = belt_y + belt_cell_size + 10
    bar_x = panel_x + 5
    bar_w = 100
    bar_h = 14
    bar_spacing = 20
    health = p.get("health", 10)
    radiation = p.get("radiation", 0)
    hunger = p.get("hunger", 0)
    stamina = p.get("stamina", 10)
    draw_bar_stalker(bar_x, stats_y, bar_w, bar_h, health, 10, COLOR_HEALTH, "‚ù§Ô∏è")
    draw_bar_stalker(bar_x, stats_y + bar_spacing, bar_w, bar_h, radiation, 10, COLOR_RADIATION, "‚ò¢Ô∏è")
    draw_bar_stalker(bar_x, stats_y + bar_spacing * 2, bar_w, bar_h, hunger, 10, COLOR_HUNGER, "üçΩÔ∏è")
    draw_bar_stalker(bar_x, stats_y + bar_spacing * 3, bar_w, bar_h, stamina, 10, COLOR_STAMINA, "‚ö°")
    inv_panel_x = LEFT_PANEL_WIDTH
    inv_panel_y = 5
    inv_panel_w = INV_COLS * CELL_SIZE + 12
    inv_panel_h = INV_ROWS * CELL_SIZE + 25
    draw_stalker_frame(inv_panel_x, inv_panel_y, inv_panel_w, inv_panel_h, "–ò–ù–í–ï–ù–¢–ê–†–¨")
    try:
        empty_icon = Image.open("icons/empty.png").convert("RGBA").resize((CELL_SIZE - 4, CELL_SIZE - 4))
    except:
        empty_icon = None
    items_list = []
    for item, count in backpack.items():
        if count > 0 and (item in ITEM_ICONS or item in ARTIFACT_ICONS):
            items_list.append((item, count))
    max_items = INV_COLS * INV_ROWS
    while len(items_list) < max_items:
        items_list.append((None, 0))
    items_list = items_list[:max_items]
    sort_mode = get_sort_mode(user_id)
    if sort_mode != 0:
        active_items = {k: v for k, v in backpack.items() if v > 0}
        if sort_mode == 1:
            sorted_items = []
            for cat in ["–µ–¥–∞", "–º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã", "–∞–Ω—Ç–∏—Ä–∞–¥", "—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∏", "–ø—Ä–æ—á–µ–µ"]:
                for name in CATEGORIES[cat]:
                    if name in active_items:
                        sorted_items.append((name, active_items[name]))
            for art in ALL_ARTIFACTS:
                if art in active_items:
                    sorted_items.append((art, active_items[art]))
            for name, count in active_items.items():
                if name not in [n for cat in CATEGORIES.values() for n in cat] and name not in ALL_ARTIFACTS:
                    sorted_items.append((name, count))
        elif sort_mode == 2:
            sorted_items = sorted(active_items.items(), key=lambda x: x[1], reverse=True)
        new_items_list = []
        for item, count in sorted_items:
            new_items_list.append((item, count))
        while len(new_items_list) < max_items:
            new_items_list.append((None, 0))
        items_list = new_items_list[:max_items]
    for idx, (item, count) in enumerate(items_list):
        row = idx // INV_COLS
        col = idx % INV_COLS
        x = inv_panel_x + 6 + col * CELL_SIZE
        y = inv_panel_y + 20 + row * CELL_SIZE
        draw.rectangle([x, y, x + CELL_SIZE - 2, y + CELL_SIZE - 2], fill=COLOR_SLOT_EMPTY, outline=COLOR_FRAME, width=1)
        if item:
            icon_path = all_icons.get(item)
            if icon_path and os.path.exists(icon_path):
                try:
                    icon = Image.open(icon_path).convert("RGBA").resize((CELL_SIZE - 6, CELL_SIZE - 6))
                    img.paste(icon, (x + 2, y + 2), icon)
                except:
                    pass
            text = str(count)
            text_x = x + CELL_SIZE - 15
            text_y = y + CELL_SIZE - 18
            for dx, dy in [(-1, 0), (1, 0), (0, -1), (0, 1)]:
                draw.text((text_x + dx, text_y + dy), text, fill=(0, 0, 0), font=font_small)
            draw.text((text_x, text_y), text, fill=(255, 255, 255), font=font_small)
        elif empty_icon:
            img.paste(empty_icon, (x + 2, y + 2), empty_icon)
    buffer = io.BytesIO()
    img.save(buffer, format="PNG")
    buffer.seek(0)
    return buffer
def generate_warehouse_image():
    width = COLUMNS * CELL_SIZE + (COLUMNS + 1) * MARGIN
    height = ROWS * CELL_SIZE + (ROWS + 1) * MARGIN + 40 - 10
    img = Image.new("RGBA", (width, height), (20, 20, 20, 255))
    try:
        empty_icon = Image.open("icons/empty.png").convert("RGBA").resize((CELL_SIZE, CELL_SIZE))
    except:
        empty_icon = Image.new("RGBA", (CELL_SIZE, CELL_SIZE), (40, 40, 40, 255))
    all_icons = {**ITEM_ICONS, **ARTIFACT_ICONS}
    items_list = []
    for item, count in shared_warehouse.items():
        if count > 0 and (item in ITEM_ICONS or item in ARTIFACT_ICONS):
            items_list.append((item, count))
    while len(items_list) < INVENTORY_SIZE:
        items_list.append((None, 0))
    items_list = items_list[:INVENTORY_SIZE]
    draw = ImageDraw.Draw(img)
    try:
        font = ImageFont.truetype("Graffiti1C.ttf", 16)
    except:
        try:
            font = ImageFont.truetype("arial.ttf", 16)
        except:
            font = ImageFont.load_default()
    draw.text((5, 30), f"–î–µ–Ω—å–≥–∏: {shared_warehouse_money}—Ä", fill="white", font=font)
    for idx, (item, count) in enumerate(items_list):
        row = idx // COLUMNS
        col = idx % COLUMNS
        x = MARGIN + col * (CELL_SIZE + MARGIN)
        y = 50 + MARGIN + row * (CELL_SIZE + MARGIN)
        img.paste(empty_icon, (x, y))
        if item:
            icon_path = all_icons.get(item)
            if icon_path:
                try:
                    icon = Image.open(icon_path).convert("RGBA").resize((CELL_SIZE, CELL_SIZE))
                    img.paste(icon, (x, y), icon)
                    text = str(count)
                    for dx, dy in [(-1, -1), (-1, 1), (1, -1), (1, 1), (0, -1), (0, 1), (-1, 0), (1, 0)]:
                        draw.text((x + 5 + dx, y + 5 + dy), text, fill="black", font=font)
                    draw.text((x + 5, y + 5), text, fill="white", font=font)
                except:
                    draw.rectangle([x, y, x + CELL_SIZE, y + CELL_SIZE], outline="gray", width=2)
                    text = str(count)
                    draw.text((x + 5, y + 5), text, fill="white", font=font)
    buffer = io.BytesIO()
    img.save(buffer, format="PNG")
    buffer.seek(0)
    return buffer
def generate_quote_image(quote_text, user_name, avatar_image, date_str, background_image=None, title=None):
    width = 800
    min_height = 300
    padding = 40
    avatar_size = 100
    try:
        font_quote = ImageFont.truetype("Graffiti1C.ttf", 28)
        font_name = ImageFont.truetype("Graffiti1C.ttf", 24)
        font_date = ImageFont.truetype("Graffiti1C.ttf", 18)
        font_title = ImageFont.truetype("Graffiti1C.ttf", 22)
    except:
        try:
            font_quote = ImageFont.truetype("arial.ttf", 28)
            font_name = ImageFont.truetype("arial.ttf", 24)
            font_date = ImageFont.truetype("arial.ttf", 18)
            font_title = ImageFont.truetype("arial.ttf", 22)
        except:
            font_quote = ImageFont.load_default()
            font_name = font_quote
            font_date = font_quote
            font_title = font_quote
    temp_img = Image.new("RGB", (1, 1))
    temp_draw = ImageDraw.Draw(temp_img)
    max_text_width = width - padding * 3 - avatar_size - 20
    words = quote_text.split()
    lines = []
    current_line = ""
    for word in words:
        test_line = current_line + " " + word if current_line else word
        bbox = temp_draw.textbbox((0, 0), test_line, font=font_quote)
        if bbox[2] - bbox[0] <= max_text_width:
            current_line = test_line
        else:
            if current_line:
                lines.append(current_line)
            current_line = word
    if current_line:
        lines.append(current_line)
    line_height = 35
    text_height = len(lines) * line_height
    title_height = 40 if title else 0
    height = max(min_height, text_height + padding * 2 + 80 + title_height)
    if background_image:
        try:
            bg = background_image.convert("RGB").resize((width, height))
            enhancer = ImageEnhance.Brightness(bg)
            bg = enhancer.enhance(0.4)
        except:
            bg = Image.new("RGB", (width, height), (20, 20, 20))
    else:
        bg = Image.new("RGB", (width, height), (20, 20, 20))
    img = bg.copy()
    draw = ImageDraw.Draw(img)
    top_offset = 0
    if title:
        title_bbox = temp_draw.textbbox((0, 0), title, font=font_title)
        title_x = (width - (title_bbox[2] - title_bbox[0])) // 2
        title_y = padding // 2
        for dx, dy in [(-1, 0), (1, 0), (0, -1), (0, 1)]:
            draw.text((title_x + dx, title_y + dy), title, fill=(0, 0, 0), font=font_title)
        draw.text((title_x, title_y), title, fill=(255, 215, 0), font=font_title)
        top_offset = title_height
    if avatar_image:
        try:
            avatar = avatar_image.convert("RGBA").resize((avatar_size, avatar_size))
            mask = Image.new("L", (avatar_size, avatar_size), 0)
            mask_draw = ImageDraw.Draw(mask)
            mask_draw.ellipse((0, 0, avatar_size, avatar_size), fill=255)
            avatar_x = padding
            avatar_y = (height - avatar_size) // 2 - 20 + top_offset // 2
            img.paste(avatar, (avatar_x, avatar_y), mask)
        except:
            avatar_x = padding
            avatar_y = (height - avatar_size) // 2 - 20 + top_offset // 2
            draw.ellipse((avatar_x, avatar_y, avatar_x + avatar_size, avatar_y + avatar_size), fill=(60, 60, 60))
    else:
        avatar_x = padding
        avatar_y = (height - avatar_size) // 2 - 20 + top_offset // 2
        draw.ellipse((avatar_x, avatar_y, avatar_x + avatar_size, avatar_y + avatar_size), fill=(60, 60, 60))
    name_bbox = temp_draw.textbbox((0, 0), user_name, font=font_name)
    name_x = avatar_x + (avatar_size - (name_bbox[2] - name_bbox[0])) // 2
    name_y = avatar_y + avatar_size + 10
    for dx, dy in [(-1, 0), (1, 0), (0, -1), (0, 1)]:
        draw.text((name_x + dx, name_y + dy), user_name, fill=(0, 0, 0), font=font_name)
    draw.text((name_x, name_y), user_name, fill=(255, 255, 255), font=font_name)
    quote_x = padding + avatar_size + 30
    quote_y = padding + top_offset
    draw.text((quote_x - 15, quote_y - 10), "¬´", fill=(150, 150, 150), font=font_quote)
    for i, line in enumerate(lines):
        y = quote_y + i * line_height
        for dx, dy in [(-1, 0), (1, 0), (0, -1), (0, 1)]:
            draw.text((quote_x + dx, y + dy), line, fill=(0, 0, 0), font=font_quote)
        draw.text((quote_x, y), line, fill=(255, 255, 255), font=font_quote)
    if lines:
        last_line = lines[-1]
        last_line_bbox = temp_draw.textbbox((0, 0), last_line, font=font_quote)
        end_quote_x = quote_x + last_line_bbox[2] - last_line_bbox[0] + 5
        end_quote_y = quote_y + (len(lines) - 1) * line_height
        draw.text((end_quote_x, end_quote_y - 10), "¬ª", fill=(150, 150, 150), font=font_quote)
    watermark = "@wargroupss"
    watermark_x = padding
    watermark_y = height - padding
    for dx, dy in [(-1, 0), (1, 0), (0, -1), (0, 1)]:
        draw.text((watermark_x + dx, watermark_y + dy), watermark, fill=(0, 0, 0), font=font_date)
    draw.text((watermark_x, watermark_y), watermark, fill=(120, 120, 120), font=font_date)
    date_bbox = temp_draw.textbbox((0, 0), date_str, font=font_date)
    date_x = width - padding - (date_bbox[2] - date_bbox[0])
    date_y = height - padding
    for dx, dy in [(-1, 0), (1, 0), (0, -1), (0, 1)]:
        draw.text((date_x + dx, date_y + dy), date_str, fill=(0, 0, 0), font=font_date)
    draw.text((date_x, date_y), date_str, fill=(180, 180, 180), font=font_date)
    buffer = io.BytesIO()
    img.save(buffer, format="PNG")
    buffer.seek(0)
    return buffer
def process_quote_request(user_id, quote_text, quote_user_id, quote_timestamp, peer_id, vk_session):
    if not quote_text or quote_user_id <= 0:
        send_message(user_id, "‚ùå –°–æ–æ–±—â–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ –∏–ª–∏ –æ—Ç —Å–æ–æ–±—â–µ—Å—Ç–≤–∞.", None, vk_session, peer_id)
        return False
    moscow_time = quote_timestamp + 3 * 3600
    quote_date = time.strftime('%d.%m.%Y %H:%M', time.gmtime(moscow_time))
    if user_id not in players:
        players[user_id] = {"state": STATE_WAITING_QUOTE_PHOTO, "pending_quote": {"text": quote_text, "user_id": quote_user_id, "date": quote_date}}
    else:
        players[user_id]["state"] = STATE_WAITING_QUOTE_PHOTO
        players[user_id]["pending_quote"] = {"text": quote_text, "user_id": quote_user_id, "date": quote_date}
    save_data()
    send_message(user_id, "üì∑ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –¥–ª—è —Ñ–æ–Ω–∞ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ ¬´–Ω–µ—Ç¬ª –¥–ª—è —á—ë—Ä–Ω–æ–≥–æ —Ñ–æ–Ω–∞.\nüí° –ó–∞–≥–æ–ª–æ–≤–æ–∫: ¬´–Ω–µ—Ç –¶–∏—Ç–∞—Ç—ã –≤–µ–ª–∏–∫–∏—Ö¬ª –∏–ª–∏ —Ñ–æ—Ç–æ —Å –ø–æ–¥–ø–∏—Å—å—é.", None, vk_session, peer_id)
    return True
def process_quote_photo(user_id, text, photo_attachment, peer_id, vk_session):
    p = players.get(user_id)
    if not p:
        return False
    quote_data = p.get("pending_quote")
    if not quote_data:
        return False
    background_img = None
    title = None
    if photo_attachment:
        sizes = photo_attachment.get('sizes', [])
        if sizes:
            best_size = max(sizes, key=lambda x: x.get('width', 0) * x.get('height', 0))
            photo_url = best_size.get('url')
            if photo_url:
                try:
                    resp = vk_session.http.get(photo_url)
                    background_img = Image.open(io.BytesIO(resp.content))
                except:
                    pass
        if text:
            title = text
    elif text.lower() == "–Ω–µ—Ç":
        background_img = None
        title = None
    elif text.lower().startswith("–Ω–µ—Ç "):
        background_img = None
        title = text[4:].strip()
    else:
        return False
    quote_text = quote_data.get("text", "")
    quote_user_id = quote_data.get("user_id")
    quote_date = quote_data.get("date", "")
    try:
        user_info = vk_session.method("users.get", {"user_ids": quote_user_id, "fields": "first_name"})[0]
        user_name = user_info.get("first_name", "–ê–Ω–æ–Ω–∏–º")
    except:
        user_name = "–ê–Ω–æ–Ω–∏–º"
    avatar_img = get_user_avatar(quote_user_id, vk_session)
    img_buffer = generate_quote_image(quote_text, user_name, avatar_img, quote_date, background_img, title)
    try:
        upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
        resp = vk_session.http.post(upload_url, files={"photo": ("quote.png", img_buffer, "image/png")})
        result = resp.json()
        photo_data = vk_session.method("photos.saveMessagesPhoto", {"photo": result["photo"], "server": result["server"], "hash": result["hash"]})[0]
        vk_session.method("messages.send", {"peer_id": peer_id, "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}", "random_id": 0, "message": "üñº –í–∞—à–∞ —Ü–∏—Ç–∞—Ç–∞ –≥–æ—Ç–æ–≤–∞!"})
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ü–∏—Ç–∞—Ç—ã: {e}")
        send_message(user_id, "‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ü–∏—Ç–∞—Ç—ã.", None, vk_session, peer_id)
    p["state"] = STATE_IN_MENU
    p.pop("pending_quote", None)
    save_data()
    return True
def generate_artifacts_info_image():
    categories = [
        ("–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è ‚ù§Ô∏è", ["–ö—Ä–æ–≤—å –∫–∞–º–Ω—è", "–õ–æ–º–æ—Ç—å –º—è—Å–∞", "–î—É—à–∞", "–°–≤–µ—Ç–ª—è–∫"], ["+0.25", "+0.5", "+0.75", "+1"]),
        ("–í—ã–≤–æ–¥ —Ä–∞–¥–∏–∞—Ü–∏–∏ ‚ò¢Ô∏è", ["–ö–æ–ª–æ–±–æ–∫", "–ú–µ–¥—É–∑–∞", "–°–ª–∏–∑–Ω—è–∫", "–ü—É–∑—ã—Ä—å"], ["-0.25", "-0.5", "-0.75", "-1"]),
        ("–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏–ª ‚ö°", ["–í—Å–ø—ã—à–∫–∞", "–°–Ω–µ–∂–∏–Ω–∫–∞", "–õ—É–Ω–Ω—ã–π —Å–≤–µ—Ç", "–ë–∞—Ç–∞—Ä–µ–π–∫–∞"], ["+0.5", "+1", "+1.5", "+2"]),
        ("–ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–∞–∑—Ä—ã–≤–∞ üêæ", ["–ë–µ–Ω–≥–∞–ª—å—Å–∫–∏–π –æ–≥–æ–Ω—å", "–í—ã–≤–µ—Ä—Ç", "–ì—Ä–∞–≤–∏", "–ó–æ–ª–æ—Ç–∞—è —Ä—ã–±–∫–∞"], ["+0.25", "+0.5", "+0.75", "+1"]),
        ("–ü—É–ª–µ—Å—Ç–æ–π–∫–æ—Å—Ç—å üõ°Ô∏è", ["–ü—É—Å—Ç—ã—à–∫–∞", "–ö–∞–º–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç–æ–∫", "–ù–æ—á–Ω–∞—è –∑–≤–µ–∑–¥–∞", "–ö—Ä–∏—Å—Ç–∞–ª–ª"], ["+0.5", "+1", "+1.5", "+2"]),
        ("–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ üí•", ["–ö–æ–ª—é—á–∫–∞", "–ü–ª–∞–º—è", "–û–≥–Ω–µ–Ω–Ω—ã–π —à–∞—Ä", "–ü–ª—ë–Ω–∫–∞"], ["+0.25", "+0.5", "+0.75", "+1"]),
        ("–ù–∞–Ω–µ—Å–µ–Ω–∏–µ —É—Ä–æ–Ω–∞ üí¢", ["–ì–ª–∞–∑", "–ö–∞–ø–ª–∏", "–ö—Ä–∏—Å—Ç–∞–ª—å–Ω–∞—è –∫–æ–ª—é—á–∫–∞", "–ü—Ä—É–∂–∏–Ω–∞"], ["+0.5", "+1", "+1.5", "+2"]),
        ("–¢–æ—á–Ω–æ—Å—Ç—å –ø–æ–ø–∞–¥–∞–Ω–∏—è üéØ", ["–°–ª–∏–∑—å", "–°–ª—é–¥–∞", "–ú–∞–º–∏–Ω—ã –±—É—Å—ã", "–ú–æ—Ä—Å–∫–æ–π —ë–∂"], ["+0.5", "+1", "+1.5", "+2"])
    ]
    icon_size = 40
    padding = 10
    category_height = 60
    item_width = 140
    items_per_row = 4
    width = padding * 2 + items_per_row * item_width
    height = padding * 2 + len(categories) * category_height
    img = Image.new("RGBA", (width, height), (25, 30, 25, 255))
    draw = ImageDraw.Draw(img)
    try:
        font = ImageFont.truetype("Graffiti1C.ttf", 12)
        font_title = ImageFont.truetype("Graffiti1C.ttf", 14)
    except:
        try:
            font = ImageFont.truetype("arial.ttf", 12)
            font_title = ImageFont.truetype("arial.ttf", 14)
        except:
            font = ImageFont.load_default()
            font_title = font
    def draw_text_outline(x, y, text, used_font, fill=(255, 255, 255)):
        for dx, dy in [(-1, 0), (1, 0), (0, -1), (0, 1)]:
            draw.text((x + dx, y + dy), text, fill=(0, 0, 0), font=used_font)
        draw.text((x, y), text, fill=fill, font=used_font)
    y = padding
    for cat_name, artifacts, values in categories:
        draw_text_outline(padding, y, cat_name, font_title, fill=(200, 200, 100))
        y += 18
        x = padding
        for i, art in enumerate(artifacts):
            icon_path = ARTIFACT_ICONS.get(art)
            if icon_path and os.path.exists(icon_path):
                try:
                    icon = Image.open(icon_path).convert("RGBA").resize((icon_size, icon_size))
                    img.paste(icon, (x, y), icon)
                except:
                    pass
            text_x = x + icon_size + 3
            draw_text_outline(text_x, y + 5, art[:12], font)
            draw_text_outline(text_x, y + 20, values[i], font, fill=(150, 255, 150))
            x += item_width
        y += category_height - 18
    buffer = io.BytesIO()
    img.save(buffer, format="PNG")
    buffer.seek(0)
    return buffer
def send_artifacts_info_with_image(user_id, keyboard, vk_session):
    try:
        img_buffer = generate_artifacts_info_image()
        upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
        response = vk_session.http.post(upload_url, files={"photo": ("artifacts.png", img_buffer, "image/png")})
        result = response.json()
        photo_data = vk_session.method("photos.saveMessagesPhoto", {
            "photo": result["photo"],
            "server": result["server"],
            "hash": result["hash"]
        })[0]
        vk_session.method("messages.send", {
            "user_id": user_id,
            "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}",
            "random_id": 0,
            "message": ARTIFACT_INFO_TEXT,
            "keyboard": keyboard.get_keyboard()
        })
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤: {e}")
        send_message(user_id, ARTIFACT_INFO_TEXT, keyboard, vk_session)
def upload_and_send_inventory(user_id, vk_session):
    try:
        img_buffer = generate_inventory_image(user_id)
        upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
        response = vk_session.http.post(upload_url, files={"photo": ("inventory.png", img_buffer, "image/png")})
        result = response.json()
        photo_data = vk_session.method("photos.saveMessagesPhoto", {
            "photo": result["photo"],
            "server": result["server"],
            "hash": result["hash"]
        })[0]
        vk_session.method("messages.send", {
            "user_id": user_id,
            "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}",
            "random_id": 0,
            "message": "üéí –í–∞—à —Ä—é–∫–∑–∞–∫:",
            "keyboard": create_backpack_menu_keyboard().get_keyboard()
        })
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è: {e}")
        send_message(user_id, format_backpack_info(user_id), create_backpack_menu_keyboard(), vk_session)
def upload_and_send_warehouse_global(user_id, vk_session):
    try:
        img_buffer = generate_warehouse_image()
        upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
        response = vk_session.http.post(upload_url, files={"photo": ("warehouse.png", img_buffer, "image/png")})
        result = response.json()
        photo_data = vk_session.method("photos.saveMessagesPhoto", {
            "photo": result["photo"],
            "server": result["server"],
            "hash": result["hash"]
        })[0]
        vk_session.method("messages.send", {
            "user_id": user_id,
            "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}",
            "random_id": 0,
            "message": "üß∞ –û–±—â–∏–π —Å–∫–ª–∞–¥:\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: –ø–æ–ª–æ–∂–∏—Ç—å/–∑–∞–±—Ä–∞—Ç—å (–ø—Ä–µ–¥–º–µ—Ç) (–∫–æ–ª-–≤–æ)",
            "keyboard": create_warehouse_keyboard().get_keyboard()
        })
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∫–ª–∞–¥–∞: {e}")
        send_message(user_id, format_warehouse_info(), create_warehouse_keyboard(), vk_session)
def show_buy_provisions_menu(user_id, vk_session):
    img_width = 500
    line_height = 60
    padding = 10
    all_provisions = (CATEGORIES["–µ–¥–∞"] + CATEGORIES["–º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã"] +
                      CATEGORIES["–∞–Ω—Ç–∏—Ä–∞–¥"] + CATEGORIES["—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∏"] + CATEGORIES["–ø—Ä–æ—á–µ–µ"])
    lines = []
    icons = []
    prices = []
    for item in all_provisions:
        if item in BUY_PRICES:
            price = BUY_PRICES[item]
            lines.append(item)
            prices.append(f"{price}—Ä")
            icons.append(ITEM_ICONS.get(item, "icons/empty.png"))
    img_height = padding * 2 + len(lines) * line_height
    img = Image.new("RGB", (img_width, img_height), (30, 30, 30))
    draw = ImageDraw.Draw(img)
    try:
        font = ImageFont.truetype("Graffiti1C.ttf", 16)
    except:
        try:
            font = ImageFont.truetype("arial.ttf", 16)
        except:
            font = ImageFont.load_default()
    y = padding
    for i, line in enumerate(lines):
        icon_path = icons[i]
        try:
            icon = Image.open(icon_path).convert("RGBA").resize((40, 40))
            img.paste(icon, (padding, y), icon)
        except Exception as e:
            draw.rectangle([padding, y, padding + 40, y + 40], outline="gray", width=2)
        draw.text((padding + 50, y + 10), line, fill="white", font=font)
        draw.text((img_width - 60, y + 10), prices[i], fill="yellow", font=font)
        y += line_height
    buffer = io.BytesIO()
    img.save(buffer, format="PNG")
    buffer.seek(0)
    try:
        upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
        response = vk_session.http.post(upload_url, files={"photo": ("menu.png", buffer, "image/png")})
        result = response.json()
        photo_data = vk_session.method("photos.saveMessagesPhoto", {
            "photo": result["photo"],
            "server": result["server"],
            "hash": result["hash"]
        })[0]
        money = players[user_id].get("money", 0)
        vk_session.method("messages.send", {
            "user_id": user_id,
            "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}",
            "random_id": 0,
            "message": f"üí≤ –í–∞—à–∏ –¥–µ–Ω—å–≥–∏: {money}—Ä\n\n–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: —Ö–ª–µ–± 2):",
            "keyboard": create_back_only_keyboard().get_keyboard()
        })
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–µ–Ω—é –ø—Ä–æ–≤–∏–∑–∏–∏: {e}")
        send_message(user_id, "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.", create_back_only_keyboard(), vk_session)
    players[user_id]["state"] = STATE_TRADER_BUY
    save_data()
def show_sell_provisions_menu(user_id, vk_session):
    p = players[user_id]
    backpack = p.get("backpack", {})
    all_provisions = (CATEGORIES["–µ–¥–∞"] + CATEGORIES["–º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã"] +
                      CATEGORIES["–∞–Ω—Ç–∏—Ä–∞–¥"] + CATEGORIES["—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∏"] + CATEGORIES["–ø—Ä–æ—á–µ–µ"])
    msg_lines = [f"üí≤ –í–∞—à–∏ –¥–µ–Ω—å–≥–∏: {p.get('money', 0)}—Ä\n", "üì¶ –í–∞—à–∞ –ø—Ä–æ–≤–∏–∑–∏—è:"]
    has_items = False
    for item in all_provisions:
        count = backpack.get(item, 0)
        if count > 0:
            price = SELL_PRICES.get(item, 0)
            msg_lines.append(f"{item} x{count} ‚Äî {price}—Ä/—à—Ç")
            has_items = True
    if not has_items:
        msg_lines.append("–ü—É—Å—Ç–æ")
    msg_lines.append("\n–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: —Ö–ª–µ–± 2):")
    players[user_id]["state"] = STATE_TRADER_SELL
    save_data()
    send_message(user_id, "\n".join(msg_lines), create_back_only_keyboard(), vk_session)
def show_sell_artifacts_menu(user_id, vk_session):
    p = players[user_id]
    backpack = p.get("backpack", {})
    available_arts = []
    for art in ALL_ARTIFACTS:
        if backpack.get(art, 0) > 0:
            available_arts.append((art, backpack[art]))
    if not available_arts:
        send_message(user_id, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏.", create_trader_sell_category_keyboard(), vk_session)
        return
    msg_lines = ["üåï –í–∞—à–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏:", ""]
    for art, count in available_arts:
        price = ARTIFACT_PRICES.get(art, 15)
        msg_lines.append(f"{art} x{count} ‚Äî {price}—Ä/—à—Ç")
    msg_lines.append("")
    msg_lines.append("–ù–∞–ø–∏—à–∏—Ç–µ: [–Ω–∞–∑–≤–∞–Ω–∏–µ] [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ]")
    msg_lines.append("–ü—Ä–∏–º–µ—Ä: –ú–µ–¥—É–∑–∞ 2")

    players[user_id]["state"] = STATE_TRADER_SELL_ARTIFACTS
    save_data()
    send_message(user_id, "\n".join(msg_lines), create_back_only_keyboard(), vk_session)
def handle_trader_buy(user_id, text, vk_session):
    parts = text.strip().lower().split()
    if len(parts) < 2:
        send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.", create_back_only_keyboard(), vk_session)
        return
    item_name = " ".join(parts[:-1])
    try:
        count = int(parts[-1])
    except:
        send_message(user_id, "‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º.", create_back_only_keyboard(), vk_session)
        return
    if item_name not in BUY_PRICES:
        send_message(user_id, "‚ùå –¢–∞–∫–æ–π —Ç–æ–≤–∞—Ä –Ω–µ –ø—Ä–æ–¥–∞—ë—Ç—Å—è.", create_back_only_keyboard(), vk_session)
        return
    price = BUY_PRICES[item_name] * count
    if players[user_id]["money"] < price:
        send_message(user_id, f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥. –ù—É–∂–Ω–æ {price}—Ä, —É –≤–∞—Å {players[user_id]['money']}—Ä.", create_back_only_keyboard(), vk_session)
        return
    players[user_id]["money"] -= price
    players[user_id]["backpack"][item_name] = players[user_id]["backpack"].get(item_name, 0) + count
    save_data()
    send_message(user_id, f"‚úÖ –ö—É–ø–ª–µ–Ω–æ: {item_name} x{count} –∑–∞ {price}—Ä.", create_trader_category_keyboard(), vk_session)
def handle_trader_sell(user_id, text, vk_session):
    parts = text.strip().lower().split()
    if len(parts) < 2:
        send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.", create_back_only_keyboard(), vk_session)
        return
    item_name = " ".join(parts[:-1])
    try:
        count = int(parts[-1])
    except:
        send_message(user_id, "‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º.", create_back_only_keyboard(), vk_session)
        return
    if item_name not in SELL_PRICES:
        send_message(user_id, "‚ùå –¢–∞–∫–æ–π —Ç–æ–≤–∞—Ä –Ω–µ–ª—å–∑—è –ø—Ä–æ–¥–∞—Ç—å.", create_back_only_keyboard(), vk_session)
        return
    if count <= 0:
        send_message(user_id, "‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0.", create_back_only_keyboard(), vk_session)
        return
    if players[user_id]["backpack"].get(item_name, 0) < count:
        send_message(user_id, f"‚ùå –£ –≤–∞—Å –Ω–µ—Ç {count} —à—Ç. —ç—Ç–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞.", create_back_only_keyboard(), vk_session)
        return
    price = SELL_PRICES[item_name] * count
    players[user_id]["money"] += price
    players[user_id]["backpack"][item_name] -= count
    if players[user_id]["backpack"][item_name] <= 0:
        del players[user_id]["backpack"][item_name]
    save_data()
    p = players[user_id]
    backpack = p.get("backpack", {})
    all_provisions = (CATEGORIES["–µ–¥–∞"] + CATEGORIES["–º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã"] +
                      CATEGORIES["–∞–Ω—Ç–∏—Ä–∞–¥"] + CATEGORIES["—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∏"] + CATEGORIES["–ø—Ä–æ—á–µ–µ"])
    msg_lines = [f"‚úÖ –ü—Ä–æ–¥–∞–Ω–æ: {item_name} x{count} –∑–∞ {price}—Ä.\n", f"üí≤ –í–∞—à–∏ –¥–µ–Ω—å–≥–∏: {p.get('money', 0)}—Ä\n", "üì¶ –í–∞—à–∞ –ø—Ä–æ–≤–∏–∑–∏—è:"]
    has_items = False
    for item in all_provisions:
        cnt = backpack.get(item, 0)
        if cnt > 0:
            sell_price = SELL_PRICES.get(item, 0)
            msg_lines.append(f"{item} x{cnt} ‚Äî {sell_price}—Ä/—à—Ç")
            has_items = True
    if not has_items:
        msg_lines.append("–ü—É—Å—Ç–æ")
    msg_lines.append("\n–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: —Ö–ª–µ–± 2):")
    send_message(user_id, "\n".join(msg_lines), create_back_only_keyboard(), vk_session)
def handle_trader_sell_artifact(user_id, text, vk_session):
    parts = text.strip().split()
    if len(parts) < 2:
        send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.", create_back_only_keyboard(), vk_session)
        return
    try:
        count = int(parts[-1])
        item_name = " ".join(parts[:-1])
    except:
        send_message(user_id, "‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º.", create_back_only_keyboard(), vk_session)
        return
    found_art = None
    for art in ALL_ARTIFACTS:
        if art.lower() == item_name.lower():
            found_art = art
            break
    if not found_art:
        send_message(user_id, "‚ùå –¢–∞–∫–æ–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.", create_back_only_keyboard(), vk_session)
        return
    if players[user_id]["backpack"].get(found_art, 0) < count:
        send_message(user_id, f"‚ùå –£ –≤–∞—Å –Ω–µ—Ç {count} —à—Ç. —ç—Ç–æ–≥–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞.", create_back_only_keyboard(), vk_session)
        return
    price = ARTIFACT_PRICES.get(found_art, 15) * count
    players[user_id]["money"] += price
    players[user_id]["backpack"][found_art] -= count
    if players[user_id]["backpack"][found_art] <= 0:
        del players[user_id]["backpack"][found_art]
    save_data()
    send_message(user_id, f"‚úÖ –ü—Ä–æ–¥–∞–Ω–æ: {found_art} x{count} –∑–∞ {price}—Ä.", create_trader_sell_category_keyboard(), vk_session)
def handle_equipment_sell_confirmation(user_id, text, vk_session):
    p = players[user_id]
    if text == "üîö –ù–∞–∑–∞–¥":
        p["state"] = STATE_TRADER_SELL_CATEGORY
        save_data()
        send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:", create_trader_sell_category_keyboard(), vk_session)
        return
    if text == "üî´ –û—Ä—É–∂–∏–µ":
        if not p.get("weapon"):
            send_message(user_id, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –æ—Ä—É–∂–∏—è –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏.", create_equipment_sell_keyboard(), vk_session)
            return
        p["pending_sell"] = "weapon"
        weapon_name = p["weapon"]
        price = 0
        for item in EQUIPMENT[p["faction"]]["weapon"]:
            if item[0] == weapon_name:
                price = item[4] // 2
                break
        send_message(user_id, f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–∞—Ç—å {weapon_name} –∑–∞ {price}—Ä?", create_confirmation_keyboard(), vk_session)
        p["state"] = STATE_CONFIRMING_EQUIPMENT_SELL
        save_data()
        return
    elif text == "ü¶∫ –ë—Ä–æ–Ω—è":
        if not p.get("armor"):
            send_message(user_id, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –±—Ä–æ–Ω–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏.", create_equipment_sell_keyboard(), vk_session)
            return
        p["pending_sell"] = "armor"
        armor_name = p["armor"]
        price = 0
        for item in EQUIPMENT[p["faction"]]["armor"]:
            if item[0] == armor_name:
                price = item[5] // 2
                break
        send_message(user_id, f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–∞—Ç—å {armor_name} –∑–∞ {price}—Ä?", create_confirmation_keyboard(), vk_session)
        p["state"] = STATE_CONFIRMING_EQUIPMENT_SELL
        save_data()
        return
    elif text == "üìü –î–µ—Ç–µ–∫—Ç–æ—Ä—ã":
        if not p.get("detector"):
            send_message(user_id, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏.", create_equipment_sell_keyboard(), vk_session)
            return
        p["pending_sell"] = "detector"
        det_name = p["detector"]
        price = DETECTORS[det_name]["price"] // 2
        send_message(user_id, f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–∞—Ç—å {det_name} –∑–∞ {price}—Ä?", create_confirmation_keyboard(), vk_session)
        p["state"] = STATE_CONFIRMING_EQUIPMENT_SELL
        save_data()
        return
    else:
        send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏:", create_equipment_sell_keyboard(), vk_session)
        save_data()
def handle_equipment_sell_final(user_id, text, vk_session):
    p = players[user_id]
    if text == "‚úÖ –î–∞":
        sell_type = p.get("pending_sell")
        msg = ""
        if sell_type == "weapon":
            weapon_name = p["weapon"]
            for item in EQUIPMENT[p["faction"]]["weapon"]:
                if item[0] == weapon_name:
                    price = item[4] // 2
                    p["money"] += price
                    p["weapon"] = None
                    p["weapon_durability"] = 0
                    p["weapon_max_durability"] = 0
                    p["weapon_damage"] = 0
                    p["weapon_accuracy"] = 0
                    msg = f"‚úÖ –ü—Ä–æ–¥–∞–Ω–æ: {weapon_name} –∑–∞ {price}—Ä."
                    break
        elif sell_type == "armor":
            armor_name = p["armor"]
            for item in EQUIPMENT[p["faction"]]["armor"]:
                if item[0] == armor_name:
                    price = item[5] // 2
                    p["money"] += price
                    p["armor"] = None
                    p["armor_durability"] = 0
                    p["armor_max_durability"] = 0
                    p["bullet_resist"] = 0
                    p["blast_resist"] = 0
                    p["anomaly_resist"] = 0
                    msg = f"‚úÖ –ü—Ä–æ–¥–∞–Ω–æ: {armor_name} –∑–∞ {price}—Ä."
                    break
        elif sell_type == "detector":
            det_name = p["detector"]
            price = DETECTORS[det_name]["price"] // 2
            p["money"] += price
            p["detector"] = None
            p["detector_charge"] = 0
            p["detector_max_charge"] = 0
            msg = f"‚úÖ –ü—Ä–æ–¥–∞–Ω–æ: {det_name} –∑–∞ {price}—Ä."
        p["pending_sell"] = None
        p["state"] = STATE_TRADER_SELL_EQUIPMENT_CONFIRM
        save_data()
        send_message(user_id, msg, create_equipment_sell_keyboard(), vk_session)
    elif text == "‚ùå –ù–µ—Ç":
        p["pending_sell"] = None
        p["state"] = STATE_TRADER_SELL_EQUIPMENT_CONFIRM
        save_data()
        send_message(user_id, "–ü—Ä–æ–¥–∞–∂–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.", create_equipment_sell_keyboard(), vk_session)
def handle_repair(user_id, text, vk_session):
    p = players[user_id]
    if text == "üîö –ù–∞–∑–∞–¥":
        p["state"] = STATE_TRADER_MAIN
        save_data()
        send_message(user_id, "–í—ã —Ö–æ—Ç–∏—Ç–µ —á—Ç–æ –ª–∏–±–æ üí≤ –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –∏–ª–∏ üí± –ø—Ä–æ–¥–∞—Ç—å?", create_trader_main_keyboard(), vk_session)
        return
    if text == "üî´ –û—Ä—É–∂–∏–µ":
        if not p.get("weapon"):
            send_message(user_id, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –æ—Ä—É–∂–∏—è –¥–ª—è —Ä–µ–º–æ–Ω—Ç–∞.", create_repair_keyboard(user_id), vk_session)
            return
        if p["money"] < 15:
            send_message(user_id, "‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥ –¥–ª—è —Ä–µ–º–æ–Ω—Ç–∞.", create_repair_keyboard(user_id), vk_session)
            return
        if p["weapon_durability"] >= p["weapon_max_durability"]:
            send_message(user_id, "üî´ –û—Ä—É–∂–∏–µ —É–∂–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ.", create_repair_keyboard(user_id), vk_session)
            return
        p["money"] -= 15
        p["weapon_durability"] = min(p["weapon_max_durability"], p["weapon_durability"] + 1)
        save_data()
        send_message(user_id, f"‚úÖ –û—Ä—É–∂–∏–µ –æ—Ç—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ. –¢–µ–∫—É—â–∞—è –ø—Ä–æ—á–Ω–æ—Å—Ç—å: {p['weapon_durability']}/{p['weapon_max_durability']}", create_repair_keyboard(user_id), vk_session)
        return
    if text == "ü¶∫ –ë—Ä–æ–Ω—è":
        if not p.get("armor"):
            send_message(user_id, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –±—Ä–æ–Ω–∏ –¥–ª—è —Ä–µ–º–æ–Ω—Ç–∞.", create_repair_keyboard(user_id), vk_session)
            return
        if p["money"] < 15:
            send_message(user_id, "‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥ –¥–ª—è —Ä–µ–º–æ–Ω—Ç–∞.", create_repair_keyboard(user_id), vk_session)
            return
        if p["armor_durability"] >= p["armor_max_durability"]:
            send_message(user_id, "ü¶∫ –ë—Ä–æ–Ω—è —É–∂–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞.", create_repair_keyboard(user_id), vk_session)
            return
        p["money"] -= 15
        p["armor_durability"] = min(p["armor_max_durability"], p["armor_durability"] + 1)
        save_data()
        send_message(user_id, f"‚úÖ –ë—Ä–æ–Ω—è –æ—Ç—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞. –¢–µ–∫—É—â–∞—è –ø—Ä–æ—á–Ω–æ—Å—Ç—å: {p['armor_durability']}/{p['armor_max_durability']}", create_repair_keyboard(user_id), vk_session)
        return
def handle_equipment_buy_confirmation(user_id, text, vk_session):
    p = players[user_id]
    if text == "‚úÖ –î–∞":
        item_name = p.get("pending_buy_item")
        item_type = p.get("pending_buy_type")
        faction = p["faction"]
        if item_type == "detector" and p.get("detector"):
            send_message(user_id, f"‚ùå –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –¥–µ—Ç–µ–∫—Ç–æ—Ä: {p['detector']}. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–¥–∞–π—Ç–µ –µ–≥–æ.", create_equipment_category_keyboard(), vk_session)
            p["state"] = STATE_TRADER_BUY_EQUIPMENT
            p["pending_buy_item"] = None
            p["pending_buy_type"] = None
            save_data()
            return
        if item_type == "weapon" and p.get("weapon"):
            send_message(user_id, f"‚ùå –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –æ—Ä—É–∂–∏–µ: {p['weapon']}. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–¥–∞–π—Ç–µ –µ–≥–æ.", create_equipment_category_keyboard(), vk_session)
            p["state"] = STATE_TRADER_BUY_EQUIPMENT
            p["pending_buy_item"] = None
            p["pending_buy_type"] = None
            save_data()
            return
        if item_type == "armor" and p.get("armor"):
            send_message(user_id, f"‚ùå –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –±—Ä–æ–Ω—è: {p['armor']}. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–¥–∞–π—Ç–µ –µ—ë.", create_equipment_category_keyboard(), vk_session)
            p["state"] = STATE_TRADER_BUY_EQUIPMENT
            p["pending_buy_item"] = None
            p["pending_buy_type"] = None
            save_data()
            return
        price = None
        if item_type == "detector":
            price = DETECTORS[item_name]["price"]
            p["detector"] = item_name
            p["detector_charge"] = DETECTORS[item_name]["charge"]
            p["detector_max_charge"] = DETECTORS[item_name]["charge"]
        else:
            for item in EQUIPMENT[faction][item_type]:
                if item[0] == item_name:
                    if item_type == "weapon":
                        _, dur, dmg, acc, price = item
                        p["weapon"] = item_name
                        p["weapon_durability"] = dur
                        p["weapon_max_durability"] = dur
                        p["weapon_damage"] = dmg
                        p["weapon_accuracy"] = acc
                    else:
                        _, dur, shield, blast, anom, price = item
                        p["armor"] = item_name
                        p["armor_durability"] = dur
                        p["armor_max_durability"] = dur
                        p["bullet_resist"] = shield
                        p["blast_resist"] = blast
                        p["anomaly_resist"] = anom
                    break
        if price is not None:
            p["money"] -= price
            p["pending_buy_item"] = None
            p["pending_buy_type"] = None
            p["state"] = STATE_TRADER_BUY_EQUIPMENT
            save_data()
            send_message(user_id, f"‚úÖ –ö—É–ø–ª–µ–Ω–æ: {item_name} –∑–∞ {price}—Ä.", create_equipment_category_keyboard(), vk_session)
        else:
            p["state"] = STATE_TRADER_BUY_EQUIPMENT
            save_data()
            send_message(user_id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ.", create_equipment_category_keyboard(), vk_session)
    elif text == "‚ùå –ù–µ—Ç":
        p["pending_buy_item"] = None
        p["pending_buy_type"] = None
        p["state"] = STATE_TRADER_BUY_EQUIPMENT
        save_data()
        send_message(user_id, "–ü–æ–∫—É–ø–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.", create_equipment_category_keyboard(), vk_session)
def handle_warehouse_action(user_id, text, vk_session):
    global shared_warehouse, shared_warehouse_money, faction_warehouses, faction_warehouse_money
    if LAST_STAND_MODE:
        faction = players[user_id].get("faction")
        warehouse = faction_warehouses.get(faction, {})
        warehouse_money = faction_warehouse_money.get(faction, 0)
    else:
        warehouse = shared_warehouse
        warehouse_money = shared_warehouse_money
    parts = text.strip().lower().split()
    if len(parts) < 2:
        send_message(user_id, "‚ùå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: –ø–æ–ª–æ–∂–∏—Ç—å/–∑–∞–±—Ä–∞—Ç—å (–ø—Ä–µ–¥–º–µ—Ç) (–∫–æ–ª-–≤–æ)", create_warehouse_keyboard(), vk_session)
        return
    action = parts[0]
    if action not in ["–ø–æ–ª–æ–∂–∏—Ç—å", "–∑–∞–±—Ä–∞—Ç—å"]:
        send_message(user_id, "‚ùå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: –ø–æ–ª–æ–∂–∏—Ç—å/–∑–∞–±—Ä–∞—Ç—å (–ø—Ä–µ–¥–º–µ—Ç) (–∫–æ–ª-–≤–æ)", create_warehouse_keyboard(), vk_session)
        return
    if parts[1] == "–¥–µ–Ω—å–≥–∏":
        try:
            amount = int(parts[2])
        except:
            send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É.", create_warehouse_keyboard(), vk_session)
            return
        if action == "–ø–æ–ª–æ–∂–∏—Ç—å":
            if players[user_id]["money"] < amount:
                send_message(user_id, "‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥.", create_warehouse_keyboard(), vk_session)
                return
            players[user_id]["money"] -= amount
            if LAST_STAND_MODE:
                faction_warehouse_money[faction] = faction_warehouse_money.get(faction, 0) + amount
            else:
                shared_warehouse_money += amount
        else:
            current_money = faction_warehouse_money.get(faction, 0) if LAST_STAND_MODE else shared_warehouse_money
            if current_money < amount:
                send_message(user_id, "‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥ –Ω–∞ —Å–∫–ª–∞–¥–µ.", create_warehouse_keyboard(), vk_session)
                return
            if LAST_STAND_MODE:
                faction_warehouse_money[faction] -= amount
            else:
                shared_warehouse_money -= amount
            players[user_id]["money"] += amount
    else:
        item_name = " ".join(parts[1:-1]) if len(parts) > 3 else parts[1]
        try:
            count = int(parts[-1])
        except:
            send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.", create_warehouse_keyboard(), vk_session)
            return
        if item_name not in ITEM_EFFECTS and item_name not in [a.lower() for a in ALL_ARTIFACTS]:
            send_message(user_id, "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç.", create_warehouse_keyboard(), vk_session)
            return
        if action == "–ø–æ–ª–æ–∂–∏—Ç—å":
            if players[user_id]["backpack"].get(item_name, 0) < count:
                send_message(user_id, f"‚ùå –£ –≤–∞—Å –Ω–µ—Ç {count} —à—Ç. —ç—Ç–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞.", create_warehouse_keyboard(), vk_session)
                return
            players[user_id]["backpack"][item_name] -= count
            warehouse[item_name] = warehouse.get(item_name, 0) + count
            if players[user_id]["backpack"][item_name] <= 0:
                del players[user_id]["backpack"][item_name]
        else:
            if warehouse.get(item_name, 0) < count:
                send_message(user_id, f"‚ùå –ù–∞ —Å–∫–ª–∞–¥–µ –Ω–µ—Ç {count} —à—Ç. —ç—Ç–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞.", create_warehouse_keyboard(), vk_session)
                return
            warehouse[item_name] -= count
            players[user_id]["backpack"][item_name] = players[user_id]["backpack"].get(item_name, 0) + count
            if warehouse[item_name] <= 0:
                del warehouse[item_name]
        if LAST_STAND_MODE:
            faction_warehouses[faction] = warehouse
        else:
            shared_warehouse = warehouse
    save_data()
    upload_and_send_warehouse_global(user_id, vk_session)
def handle_photo_upload(user_id, photo_url, vk_session):
    if user_id != 353430025:
        return
    target_uid = players[user_id].get("pending_photo_target")
    if not target_uid:
        return
    players[user_id].pop("pending_photo_target", None)
    try:
        img_data = vk_session.http.get(photo_url).content
        img = Image.open(io.BytesIO(img_data)).convert("RGBA")
        img.save(os.path.join(AVATAR_DIR, f"{target_uid}.png"))
        send_message(user_id, f"‚úÖ –§–æ—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–≥—Ä–æ–∫—É {players[target_uid]['nickname']}.", None, vk_session)
        send_message(target_uid, "üñºÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É—Å—Ç–∞–Ω–æ–≤–∏–ª –≤–∞–º –Ω–æ–≤—É—é –∞–≤–∞—Ç–∞—Ä–∫—É!", None, vk_session)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ: {e}")
        send_message(user_id, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ.", None, vk_session)
def check_pending_states(vk_session):
    global emission_counter
    current_time = time.time()
    updated_any = False
    if emission_counter >= EMISSION_WARNING:
        emission_counter += 2
        if emission_counter >= EMISSION_MAX:
            trigger_emission(vk_session)
        else:
            save_data()
    for user_id, data in list(players.items()):
        faction = data.get("faction")
        if not faction or faction == "None" or faction is None:
            continue
        if data.get("donation_end_time") and current_time >= data.get("donation_end_time"):
            remove_donation(user_id, vk_session)
        if data.get("health", 10) <= 0:
            if not data.get("death_notified", False):
                lose_random_items_on_death(user_id, vk_session)
                continue
        if data.get("state") == STATE_TRANSITION_WAIT:
            end_time = data.get("transition_end_time")
            if end_time and current_time >= end_time:
                data["previous_location"] = None
                data["previous_point"] = None
                if random.randint(1, 100) <= 30:
                    money_found = random.randint(5, 15)
                    data["money"] = data.get("money", 0) + money_found
                    transition_msg = f"‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –∑–∞–≤–µ—Ä—à—ë–Ω!\nüí≤ –ü–æ –ø—É—Ç–∏ –Ω–∞—à–ª–∏: {money_found}—Ä"
                elif random.randint(1, 100) <= 20:
                    rad_gain = round(random.uniform(0.5, 1.5), 1)
                    data["radiation"] = min(10, data["radiation"] + rad_gain)
                    transition_msg = f"‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –∑–∞–≤–µ—Ä—à—ë–Ω!\n‚ò¢Ô∏è –ü–æ–ª—É—á–µ–Ω–æ –æ–±–ª—É—á–µ–Ω–∏–µ: +{rad_gain}"
                else:
                    transition_msg = "‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –∑–∞–≤–µ—Ä—à—ë–Ω!"
                data["transition_end_time"] = None
                data["state"] = STATE_IN_MENU
                data["backpack"]["–±–∞—Ç–∞—Ä–µ–π–∫–∏"] = data["backpack"].get("–±–∞—Ç–∞—Ä–µ–π–∫–∏", 0) - 2
                if data["backpack"]["–±–∞—Ç–∞—Ä–µ–π–∫–∏"] <= 0:
                    del data["backpack"]["–±–∞—Ç–∞—Ä–µ–π–∫–∏"]
                transition_msg += "\nüîã –ü–æ—Ç—Ä–∞—á–µ–Ω–æ 2 –±–∞—Ç–∞—Ä–µ–π–∫–∏."
                current_location = data["location"]
                current_point = data["point"]
                if (current_location, current_point) in TRANSITION_ROUTES:
                    destinations = TRANSITION_ROUTES[(current_location, current_point)]
                    transition_msg += "\n\nüìç –í—ã –Ω–∞ —Ç–æ—á–∫–µ –ø–µ—Ä–µ—Ö–æ–¥–∞!"
                    for dest_loc, dest_point in destinations:
                        transition_msg += f"\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ø–∞—Å—Ç—å –Ω–∞ {dest_loc} {dest_point}"
                send_location_image(user_id, current_location, current_point, transition_msg, create_main_menu_keyboard(user_id), vk_session)
                updated_any = True
        elif data.get("state") == STATE_RESTING:
            start_time = data.get("rest_start_time")
            if start_time:
                elapsed_minutes = int((current_time - start_time) // 360)
                initial = data.get("initial_stamina", data["stamina"])
                belt_bonus = apply_belt_effects_on_rest(user_id)
                donation_bonus = 1 if has_active_donation(user_id) else 0
                new_stamina = min(10, initial + elapsed_minutes * (1 + belt_bonus + donation_bonus))
                if new_stamina > data["stamina"]:
                    data["stamina"] = new_stamina
                    updated_any = True
                if data["stamina"] >= 10:
                    data["stamina"] = 10
                    data["state"] = STATE_IN_CAMP
                    data["rest_start_time"] = None
                    data.pop("initial_stamina", None)
                    send_message(user_id, "üò¥ –í—ã –æ—Ç–¥–æ—Ö–Ω—É–ª–∏ –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å.", create_camp_menu_keyboard(), vk_session)
                    updated_any = True
    if updated_any:
        save_data()
def handle_message(event, vk_session):
 if not hasattr(event, 'text'):
  return
 if not hasattr(event, 'user_id') or event.from_chat:
  return
 user_id = event.user_id
 text = event.text.strip() if hasattr(event, 'text') else ""
 if user_id in banned_users:
  reason = banned_users.get(user_id, "–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞")
  send_message(user_id, f"üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ –∏–≥—Ä–µ.\nüìù –ü—Ä–∏—á–∏–Ω–∞: {reason}", None, vk_session)
  return
 if user_id in players and players[user_id].get("state") == STATE_WAITING_QUOTE_PHOTO:
  return
 if user_id in players:
  state = players[user_id].get("state")
  registration_states = [STATE_WAITING_FOR_START, STATE_READING_INSTRUCTIONS, STATE_CHOOSING_FACTION, STATE_ENTERING_NICKNAME]
  if state not in registration_states:
   if handle_global_commands(user_id, text, vk_session):
    return
 if text.lower() == "/skip_cd" and is_admin(user_id):
  if user_id in players and players[user_id].get("state") == STATE_TRANSITION_WAIT:
   players[user_id]["state"] = STATE_IN_MENU
   players[user_id]["transition_end_time"] = None
   save_data()
   send_message(user_id, "‚è±Ô∏è –¢–∞–π–º–µ—Ä –ø–µ—Ä–µ—Ö–æ–¥–∞ —Å–±—Ä–æ—à–µ–Ω.", None, vk_session)
  else:
   send_message(user_id, "–í—ã –Ω–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞.", None, vk_session)
  return
 if text.lower() == "/reset_all":
  if user_id == 353430025:
   reset_all_data()
   send_message(user_id, "üîÑ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã.", None, vk_session)
  else:
   send_message(user_id, "‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.", None, vk_session)
  return
 if user_id in players and players[user_id].get("state") == STATE_TRANSITION_WAIT:
  end_time = players[user_id]["transition_end_time"]
  if end_time and time.time() < end_time:
   remaining = end_time - time.time()
   minutes = int(remaining // 60)
   seconds = int(remaining % 60)
   send_message(user_id, f"‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–∞: {minutes} –º–∏–Ω {seconds} —Å–µ–∫", None, vk_session)
  return
 time.sleep(0.3)
 if user_id not in players:
  name, screen_name = get_user_info(user_id, vk_session)
  players[user_id] = {
   "state": STATE_WAITING_FOR_START,
   "name": name,
   "screen_name": screen_name,
   "faction": None,
   "nickname": None,
   "location": "–õ–∞–≥–µ—Ä—å",
   "point": "–ë1",
   "health": 10,
   "radiation": 0,
   "hunger": 0,
   "stamina": 10,
   "detector": None,
   "detector_charge": 0,
   "detector_max_charge": 0,
   "armor": None,
   "armor_durability": 0,
   "armor_max_durability": 0,
   "bullet_resist": 0,
   "blast_resist": 0,
   "anomaly_resist": 0,
   "weapon": None,
   "weapon_durability": 0,
   "weapon_max_durability": 0,
   "weapon_damage": 0,
   "weapon_accuracy": 0,
   "money": 0,
   "backpack": {"–±–∞—Ç–∞—Ä–µ–π–∫–∏": 4},
   "transition_end_time": None,
   "rest_start_time": None,
   "backpack_sort": 0,
   "death_notified": False,
   "belt": [None, None, None],
   "anomaly_map": None,
   "player_pos": None,
   "artifact_positions": [],
   "anomaly_positions": [],
   "current_anomaly_type": None,
   "squads": 0,
   "food_units": 0,
   "med_units": 0,
   "rad_units": 0,
   "donation_end_time": None,
   "hidden_anomaly_positions": [],
   "previous_location": None,
   "previous_point": None,
   "donation_artifact": None
  }
  save_data()
  send_message(user_id, f"–ü—Ä–∏–≤–µ—Ç, {name}! üëã\n–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É ¬´–°—Ç–∞—Ä—Ç¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É.", create_start_keyboard(), vk_session)
  return
 _, current_screen = get_user_info(user_id, vk_session)
 if players[user_id].get("screen_name") != current_screen:
  players[user_id]["screen_name"] = current_screen
  save_data()
 state = players[user_id]["state"]
 if state == STATE_ANOMALY_EXPLORE:
  p = players[user_id]
  if p.get("anomaly_path_choosing") == True:
   if text == "üö™ –£–π—Ç–∏":
    p["state"] = STATE_IN_MENU
    p["anomaly_path_choosing"] = False
    p["anomaly_safe_path"] = None
    save_data()
    send_message(user_id, "–í—ã –æ—Ç—Å—Ç—É–ø–∏–ª–∏ –æ—Ç –∞–Ω–æ–º–∞–ª—å–Ω–æ–π –∑–æ–Ω—ã.", create_main_menu_keyboard(user_id), vk_session)
    return
   chosen_path = 0
   if text == "üåÄ –ü—É—Ç—å 1":
    chosen_path = 1
   elif text == "üåÄ –ü—É—Ç—å 2":
    chosen_path = 2
   elif text == "üåÄ –ü—É—Ç—å 3":
    chosen_path = 3
   if chosen_path == 0:
    send_message(user_id, "‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –ø—É—Ç–µ–π –∏–ª–∏ —É–π–¥–∏—Ç–µ.", create_anomaly_path_keyboard(), vk_session)
    return
   safe_path = p.get("anomaly_safe_path", 1)
   messages = []
   if chosen_path != safe_path:
    atype = p.get("current_anomaly_type", "–≥—Ä–∞–≤–∏")
    min_dmg, max_dmg = ANOMALY_DAMAGE[atype]
    raw_damage = round(random.uniform(min_dmg, max_dmg), 1)
    anomaly_resist = get_total_anomaly_resist(user_id)
    actual_damage = max(0, round(raw_damage - anomaly_resist, 1))
    p["health"] = max(0, p["health"] - actual_damage)
    if actual_damage > 0:
     messages.append(f"üí• –û–ø–∞—Å–Ω—ã–π –ø—É—Ç—å! –í—ã –ø–æ–ø–∞–ª–∏ –≤ –∞–Ω–æ–º–∞–ª–∏—é!")
     messages.append(f"‚ù§Ô∏è –ü–æ–ª—É—á–µ–Ω–æ {actual_damage} —É—Ä–æ–Ω–∞ (–∑–∞—â–∏—Ç–∞: {anomaly_resist})")
     messages.append(f"‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ: {p['health']}/10")
    else:
     messages.append("üõ°Ô∏è –í—ã –ø–æ–ø–∞–ª–∏ –≤ –∞–Ω–æ–º–∞–ª–∏—é, –Ω–æ –∑–∞—â–∏—Ç–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≥–ª–æ—Ç–∏–ª–∞ —É—Ä–æ–Ω!")
    if random.randint(1, 100) <= 25 and p.get("armor"):
     p["armor_durability"] = max(0, p["armor_durability"] - 1)
     messages.append("üîß –ë—Ä–æ–Ω—è –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ (-1)!")
    save_data()
    if p["health"] <= 0:
     messages.append("\nüíÄ –í—ã –ø–æ–≥–∏–±–ª–∏ –≤ –∞–Ω–æ–º–∞–ª–∏–∏!")
     lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=5, max_money=50)
     messages.extend(format_death_losses(lost_items, money_lost))
     p["state"] = STATE_IN_MENU
     p["death_notified"] = True
     p["anomaly_path_choosing"] = False
     p["anomaly_safe_path"] = None
     save_data()
     send_message(user_id, "\n".join(messages), create_main_menu_keyboard(user_id), vk_session)
     return
    messages.append("")
   else:
    messages.append("‚úÖ –í—ã –≤—ã–±—Ä–∞–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø—É—Ç—å!")
    messages.append("")
   start_anomaly_map(user_id)
   p["state"] = STATE_ANOMALY_EXPLORE
   save_data()
   atype = p.get("current_anomaly_type", "–≥—Ä–∞–≤–∏")
   messages.append(f"üåÄ –í—ã –≤–æ—à–ª–∏ –≤ –∞–Ω–æ–º–∞–ª—å–Ω—É—é –∑–æ–Ω—É ({atype})")
   messages.append("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏—è.")
   messages.append("–ù–∞–π–¥–∏—Ç–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –∏ –∏–∑–±–µ–≥–∞–π—Ç–µ –∞–Ω–æ–º–∞–ª–∏–π!")
   alerts = get_detector_alerts(user_id)
   if alerts:
    messages.append(alerts)
   try:
    img_buffer = generate_anomaly_map_image(user_id)
    upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
    response = vk_session.http.post(upload_url, files={"photo": ("map.png", img_buffer, "image/png")})
    result = response.json()
    photo_data = vk_session.method("photos.saveMessagesPhoto", {"photo": result["photo"], "server": result["server"], "hash": result["hash"]})[0]
    vk_session.method("messages.send", {"user_id": user_id, "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}", "random_id": 0, "message": "\n".join(messages), "keyboard": create_anomaly_movement_keyboard().get_keyboard()})
   except Exception as e:
    logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã: {e}")
    send_message(user_id, "\n".join(messages), create_anomaly_movement_keyboard(), vk_session)
   return
  if text == "üö™ –£–π—Ç–∏":
   p["state"] = STATE_IN_MENU
   p["artifact_positions"] = []
   p["anomaly_positions"] = []
   p["anomaly_path_choosing"] = False
   save_data()
   send_message(user_id, "–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∞–Ω–æ–º–∞–ª—å–Ω—É—é –∑–æ–Ω—É.", create_main_menu_keyboard(user_id), vk_session)
   return
  elif text in ["‚¨ÜÔ∏è", "‚¨áÔ∏è", "‚¨ÖÔ∏è", "‚û°Ô∏è"]:
   handle_anomaly_move(user_id, text, vk_session)
   return
  else:
   send_message(user_id, "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏—è.", create_anomaly_movement_keyboard(), vk_session)
   return
 if state == STATE_BELT_MAIN:
  if text == "‚ûï –ü–æ–≤–µ—Å–∏—Ç—å":
   players[user_id]["state"] = STATE_BELT_SELECT_SLOT
   players[user_id]["belt_action"] = "equip"
   save_data()
   send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—è—Å:", create_belt_slot_keyboard(), vk_session)
   return
  elif text == "‚ûñ –°–Ω—è—Ç—å":
   players[user_id]["state"] = STATE_BELT_SELECT_SLOT
   players[user_id]["belt_action"] = "unequip"
   save_data()
   send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—è—Å –¥–ª—è —Å–Ω—è—Ç–∏—è:", create_belt_slot_keyboard(), vk_session)
   return
  elif text == "üí° –ò–Ω—Ñ–æ –æ–± –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞—Ö":
   send_artifacts_info_with_image(user_id, create_belt_main_keyboard(), vk_session)
   return
  elif text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = STATE_IN_CAMP
   save_data()
   send_message(user_id, format_camp_info(user_id), create_camp_menu_keyboard(), vk_session)
   return
  elif text.lower().startswith("–ø–æ–≤–µ—Å–∏—Ç—å "):
   art_name = text[9:].strip()
   for art in ALL_ARTIFACTS:
    if art.lower() == art_name.lower():
     if players[user_id]["backpack"].get(art, 0) > 0:
      belt = players[user_id].get("belt", [None, None, None])
      for i in range(3):
       if belt[i] is None:
        belt[i] = art
        players[user_id]["belt"] = belt
        players[user_id]["backpack"][art] -= 1
        if players[user_id]["backpack"][art] <= 0:
         del players[user_id]["backpack"][art]
        save_data()
        send_message(user_id, f"‚úÖ {art} –ø–æ–≤–µ—à–µ–Ω –Ω–∞ –ø–æ—è—Å {i+1}.", create_belt_main_keyboard(), vk_session)
        return
      send_message(user_id, "‚ùå –í—Å–µ –ø–æ—è—Å–∞ –∑–∞–Ω—è—Ç—ã.", create_belt_main_keyboard(), vk_session)
      return
     else:
      send_message(user_id, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç —ç—Ç–æ–≥–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞.", create_belt_main_keyboard(), vk_session)
      return
   send_message(user_id, "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç.", create_belt_main_keyboard(), vk_session)
   return
  elif text.lower().startswith("—Å–Ω—è—Ç—å "):
   art_name = text[6:].strip()
   belt = players[user_id].get("belt", [None, None, None])
   for i in range(3):
    if belt[i] and belt[i].lower() == art_name.lower():
     art = belt[i]
     belt[i] = None
     players[user_id]["belt"] = belt
     players[user_id]["backpack"][art] = players[user_id]["backpack"].get(art, 0) + 1
     save_data()
     send_message(user_id, f"‚úÖ {art} —Å–Ω—è—Ç —Å –ø–æ—è—Å–∞ {i+1}.", create_belt_main_keyboard(), vk_session)
     return
   send_message(user_id, "‚ùå –≠—Ç–æ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –Ω–µ –Ω–∞ –ø–æ—è—Å–µ.", create_belt_main_keyboard(), vk_session)
   return
 if state == STATE_BELT_SELECT_SLOT:
  slot = -1
  if text == "1Ô∏è‚É£ –ü–æ—è—Å":
   slot = 0
  elif text == "2Ô∏è‚É£ –ü–æ—è—Å":
   slot = 1
  elif text == "3Ô∏è‚É£ –ü–æ—è—Å":
   slot = 2
  elif text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = STATE_BELT_MAIN
   save_data()
   belt = players[user_id].get("belt", [None, None, None])
   belt_info = (f"üü° –ü–æ—è—Å:\n1Ô∏è‚É£ {belt[0] or '–ø—É—Å—Ç–æ'}\n2Ô∏è‚É£ {belt[1] or '–ø—É—Å—Ç–æ'}\n3Ô∏è‚É£ {belt[2] or '–ø—É—Å—Ç–æ'}\nüí° –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n¬´–ü–æ–≤–µ—Å–∏—Ç—å [–∞—Ä—Ç–µ—Ñ–∞–∫—Ç]¬ª\n¬´–°–Ω—è—Ç—å [–∞—Ä—Ç–µ—Ñ–∞–∫—Ç]¬ª")
   send_message(user_id, belt_info, create_belt_main_keyboard(), vk_session)
   return
  if slot >= 0:
   action = players[user_id].get("belt_action", "equip")
   belt = players[user_id].get("belt", [None, None, None])
   if action == "equip":
    if belt[slot] is not None:
     send_message(user_id, f"‚ùå –ü–æ—è—Å {slot+1} —É–∂–µ –∑–∞–Ω—è—Ç ({belt[slot]}).", create_belt_slot_keyboard(), vk_session)
     return
    available_arts = [art for art in ALL_ARTIFACTS if players[user_id]["backpack"].get(art, 0) > 0]
    if not available_arts:
     send_message(user_id, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ.", create_belt_slot_keyboard(), vk_session)
     return
    players[user_id]["pending_belt_slot"] = slot
    players[user_id]["state"] = STATE_BELT_SELECT_ARTIFACT
    players[user_id]["artifact_page"] = 0
    save_data()
    send_message(user_id, f"üü° –ö–∞–∫–æ–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –ø–æ–≤–µ—Å–∏—Ç–µ –Ω–∞ –ø–æ—è—Å {slot + 1}?\n–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö:", create_artifact_selection_keyboard(available_arts, 0), vk_session)
    return
   else:
    if belt[slot] is None:
     send_message(user_id, f"‚ùå –ü–æ—è—Å {slot+1} –ø—É—Å—Ç.", create_belt_slot_keyboard(), vk_session)
     return
    art = belt[slot]
    belt[slot] = None
    players[user_id]["belt"] = belt
    players[user_id]["backpack"][art] = players[user_id]["backpack"].get(art, 0) + 1
    players[user_id]["state"] = STATE_BELT_MAIN
    save_data()
    send_message(user_id, f"‚úÖ {art} —Å–Ω—è—Ç —Å –ø–æ—è—Å–∞ {slot+1}.", create_belt_main_keyboard(), vk_session)
    return
 if state == STATE_BELT_SELECT_ARTIFACT:
  if text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = STATE_BELT_SELECT_SLOT
   players[user_id].pop("artifact_page", None)
   save_data()
   send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—è—Å:", create_belt_slot_keyboard(), vk_session)
   return
  available_arts = [art for art in ALL_ARTIFACTS if players[user_id]["backpack"].get(art, 0) > 0]
  current_page = players[user_id].get("artifact_page", 0)
  if text == "‚óÄÔ∏è –¢—É–¥–∞":
   if current_page > 0:
    current_page -= 1
    players[user_id]["artifact_page"] = current_page
    save_data()
   slot = players[user_id].get("pending_belt_slot", 0)
   send_message(user_id, f"üü° –ö–∞–∫–æ–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –ø–æ–≤–µ—Å–∏—Ç–µ –Ω–∞ –ø–æ—è—Å {slot + 1}?\n–°—Ç—Ä–∞–Ω–∏—Ü–∞ {current_page + 1}:", create_artifact_selection_keyboard(available_arts, current_page), vk_session)
   return
  if text == "‚ñ∂Ô∏è –°—é–¥–∞":
   items_per_page = 6
   total_pages = (len(available_arts) + items_per_page - 1) // items_per_page
   if current_page < total_pages - 1:
    current_page += 1
    players[user_id]["artifact_page"] = current_page
    save_data()
   slot = players[user_id].get("pending_belt_slot", 0)
   send_message(user_id, f"üü° –ö–∞–∫–æ–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –ø–æ–≤–µ—Å–∏—Ç–µ –Ω–∞ –ø–æ—è—Å {slot + 1}?\n–°—Ç—Ä–∞–Ω–∏—Ü–∞ {current_page + 1}:", create_artifact_selection_keyboard(available_arts, current_page), vk_session)
   return
  for art in ALL_ARTIFACTS:
   if art.lower() == text.lower() or art[:20].lower() == text.lower():
    if players[user_id]["backpack"].get(art, 0) > 0:
     slot = players[user_id].get("pending_belt_slot", 0)
     belt = players[user_id].get("belt", [None, None, None])
     belt[slot] = art
     players[user_id]["belt"] = belt
     players[user_id]["backpack"][art] -= 1
     if players[user_id]["backpack"][art] <= 0:
      del players[user_id]["backpack"][art]
     players[user_id]["state"] = STATE_BELT_MAIN
     players[user_id].pop("artifact_page", None)
     save_data()
     send_message(user_id, f"‚úÖ {art} –ø–æ–≤–µ—à–µ–Ω –Ω–∞ –ø–æ—è—Å {slot + 1}.", create_belt_main_keyboard(), vk_session)
     return
  slot = players[user_id].get("pending_belt_slot", 0)
  send_message(user_id, f"‚ùå –ê—Ä—Ç–µ—Ñ–∞–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –µ–≥–æ –Ω–µ—Ç –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ.\nüü° –ö–∞–∫–æ–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –ø–æ–≤–µ—Å–∏—Ç–µ –Ω–∞ –ø–æ—è—Å {slot + 1}?", create_artifact_selection_keyboard(available_arts, current_page), vk_session)
  return
 if state == STATE_USING_ITEM:
  if text.lower() == "–æ—Ç–º–µ–Ω–∞":
   players[user_id]["state"] = STATE_IN_BACKPACK
   save_data()
   send_message(user_id, format_backpack_info(user_id), create_backpack_menu_keyboard(), vk_session)
   return
  else:
   use_item(user_id, text, vk_session)
   players[user_id]["state"] = STATE_IN_BACKPACK
   save_data()
   return
 if state == STATE_TRADER_MAIN:
  if not is_player_on_own_territory(user_id) and not has_active_donation(user_id):
   send_message(user_id, "‚ùå –¢–æ—Ä–≥–æ–≤–µ—Ü –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –≤—Ä–∞–∂–µ—Å–∫–æ–π —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏.", create_main_menu_keyboard(user_id), vk_session)
   players[user_id]["state"] = STATE_IN_MENU
   save_data()
   return
  if text == "üí≤ –ü—Ä–∏–æ–±—Ä–µ—Å—Ç–∏":
   players[user_id]["state"] = STATE_TRADER_BUY_CATEGORY
   save_data()
   send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:", create_trader_category_keyboard(), vk_session)
   return
  elif text == "üí± –ü—Ä–æ–¥–∞—Ç—å":
   players[user_id]["state"] = STATE_TRADER_SELL_CATEGORY
   save_data()
   send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:", create_trader_sell_category_keyboard(), vk_session)
   return
  elif text == "‚öôÔ∏è –ü–æ—á–∏–Ω–∏—Ç—å":
   players[user_id]["state"] = STATE_TRADER_REPAIR
   save_data()
   p = players[user_id]
   money = p.get("money", 0)
   weapon = p.get("weapon", None)
   weapon_dur = p.get("weapon_durability", 0)
   weapon_max_dur = p.get("weapon_max_durability", 0)
   armor = p.get("armor", None)
   armor_dur = p.get("armor_durability", 0)
   armor_max_dur = p.get("armor_max_durability", 0)
   repair_text = (f"‚öôÔ∏è –ß—Ç–æ —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –ø–æ—á–∏–Ω–∏—Ç—å? üßê\n‚ùóÔ∏è –†–µ–º–æ–Ω—Ç –Ω–∞ 1 –µ–¥–∏–Ω–∏—Ü—É –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –∑–∞ 15—Ä\nüí≤ –î–µ–Ω—å–≥–∏: {money}—Ä\n¬´ü™ñ –ë—Ä–æ–Ω—è: {'–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç' if not armor else armor} üîß{armor_dur}/{armor_max_dur}\n¬´üî´ –û—Ä—É–∂–∏–µ: {'–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç' if not weapon else weapon} üîß{weapon_dur}/{weapon_max_dur}")
   send_message(user_id, repair_text, create_repair_keyboard(user_id), vk_session)
   return
  elif text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = STATE_IN_MENU
   save_data()
   send_message(user_id, MAIN_MENU_TEXT, create_main_menu_keyboard(user_id), vk_session)
   return
 if state == STATE_TRADER_BUY_CATEGORY:
  if text == "ü•´ –ü—Ä–æ–≤–∏–∑–∏—è":
   show_buy_provisions_menu(user_id, vk_session)
   return
  elif text == "ü™ñ –°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ":
   players[user_id]["state"] = STATE_TRADER_BUY_EQUIPMENT
   save_data()
   send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è:", create_equipment_category_keyboard(), vk_session)
   return
  elif text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = STATE_TRADER_MAIN
   save_data()
   send_message(user_id, "–í—ã —Ö–æ—Ç–∏—Ç–µ —á—Ç–æ –ª–∏–±–æ üí≤ –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –∏–ª–∏ üí± –ø—Ä–æ–¥–∞—Ç—å?", create_trader_main_keyboard(), vk_session)
   return
 if state == STATE_TRADER_SELL_CATEGORY:
  if text == "ü•´ –ü—Ä–æ–≤–∏–∑–∏—è":
   show_sell_provisions_menu(user_id, vk_session)
   return
  elif text == "ü™ñ –°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ":
   players[user_id]["state"] = STATE_TRADER_SELL_EQUIPMENT_CONFIRM
   save_data()
   send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏:", create_equipment_sell_keyboard(), vk_session)
   return
  elif text == "üåï –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã":
   show_sell_artifacts_menu(user_id, vk_session)
   return
  elif text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = STATE_TRADER_MAIN
   save_data()
   send_message(user_id, "–í—ã —Ö–æ—Ç–∏—Ç–µ —á—Ç–æ –ª–∏–±–æ üí≤ –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –∏–ª–∏ üí± –ø—Ä–æ–¥–∞—Ç—å?", create_trader_main_keyboard(), vk_session)
   return
 if state == STATE_TRADER_SELL_ARTIFACTS:
  if text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = STATE_TRADER_SELL_CATEGORY
   save_data()
   send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:", create_trader_sell_category_keyboard(), vk_session)
   return
  else:
   handle_trader_sell_artifact(user_id, text, vk_session)
   return
 if state == STATE_TRADER_BUY:
  if text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = STATE_TRADER_BUY_CATEGORY
   save_data()
   send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:", create_trader_category_keyboard(), vk_session)
   return
  else:
   handle_trader_buy(user_id, text, vk_session)
   return
 if state == STATE_TRADER_SELL:
  if text == "üéí –†—é–∫–∑–∞–∫":
   upload_and_send_inventory(user_id, vk_session)
   return
  elif text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = STATE_TRADER_SELL_CATEGORY
   save_data()
   send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:", create_trader_sell_category_keyboard(), vk_session)
   return
  else:
   handle_trader_sell(user_id, text, vk_session)
   return
 if state == STATE_TRADER_BUY_EQUIPMENT:
  if text == "üî´ –û—Ä—É–∂–∏–µ":
   eq_type = "weapon"
  elif text == "ü¶∫ –ë—Ä–æ–Ω—è":
   eq_type = "armor"
  elif text == "üìü –î–µ—Ç–µ–∫—Ç–æ—Ä—ã":
   eq_type = "detector"
  elif text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = STATE_TRADER_BUY_CATEGORY
   save_data()
   send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:", create_trader_category_keyboard(), vk_session)
   return
  else:
   send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è:", create_equipment_category_keyboard(), vk_session)
   return
  faction = players[user_id]["faction"]
  money = players[user_id].get("money", 0)
  if eq_type == "detector":
   msg_lines = [f"üí≤ –í–∞—à–∏ –¥–µ–Ω—å–≥–∏: {money}—Ä", "", "üìü –î–ï–¢–ï–ö–¢–û–†–´", ""]
   sorted_detectors = sorted(DETECTORS.items(), key=lambda x: x[1]["price"])
   num = 1
   for name, data in sorted_detectors:
    msg_lines.append(f"{num}Ô∏è‚É£ ¬´{name}¬ª ‚Äî üí∞{data['price']}—Ä (‚ö°{data['charge']})")
    num += 1
   msg_lines.append("")
   msg_lines.append("üìå ‚ö° ‚Äî –∑–∞—Ä—è–¥")
   msg_lines.append("")
   msg_lines.append("‚úçÔ∏è –ù–∞–ø–∏—à–∏—Ç–µ —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏:")
   send_message(user_id, "\n".join(msg_lines), create_back_only_keyboard(), vk_session)
   players[user_id]["pending_buy_type"] = "detector"
   players[user_id]["state"] = STATE_TRADER_BUY_EQUIPMENT_CONFIRM
   save_data()
   return
  items = EQUIPMENT[faction][eq_type]
  if eq_type == "weapon":
   sorted_items = sorted(items, key=lambda x: x[4])
   msg_lines = [f"üí≤ –í–∞—à–∏ –¥–µ–Ω—å–≥–∏: {money}—Ä", "", f"üî´ –û–†–£–ñ–ò–ï ({faction})", ""]
   for i, item in enumerate(sorted_items, 1):
    name, dur, dmg, acc, price = item
    msg_lines.append(f"{i}Ô∏è‚É£ {name} ‚Äî üí∞{price}—Ä")
    msg_lines.append(f"   üîß[{dur}/{dur}] ; üí¢[{dmg}] ; üéØ[{acc}]")
   msg_lines.append("")
   msg_lines.append("‚úçÔ∏è –ù–∞–ø–∏—à–∏—Ç–µ —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –ø–æ–∫—É–ø–∫–∏:")
  else:
   sorted_items = sorted(items, key=lambda x: x[5])
   msg_lines = [f"üí≤ –í–∞—à–∏ –¥–µ–Ω—å–≥–∏: {money}—Ä", "", f"ü¶∫ –ë–†–û–ù–Ø ({faction})", ""]
   for i, item in enumerate(sorted_items, 1):
    name, dur, shield, blast, anom, price = item
    msg_lines.append(f"{i}Ô∏è‚É£ {name} ‚Äî üí∞{price}—Ä")
    msg_lines.append(f"   üîß[{dur}/{dur}] ; üõ°Ô∏è[{shield}] ; üêæ[{blast}] ; üí•[{anom}]")
   msg_lines.append("")
   msg_lines.append("‚úçÔ∏è –ù–∞–ø–∏—à–∏—Ç–µ —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –ø–æ–∫—É–ø–∫–∏:")
  send_message(user_id, "\n".join(msg_lines), create_back_only_keyboard(), vk_session)
  players[user_id]["pending_buy_type"] = eq_type
  players[user_id]["state"] = STATE_TRADER_BUY_EQUIPMENT_CONFIRM
  save_data()
  return
 if state == STATE_TRADER_BUY_EQUIPMENT_CONFIRM:
  if text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = STATE_TRADER_BUY_EQUIPMENT
   players[user_id]["pending_buy_type"] = None
   save_data()
   send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è:", create_equipment_category_keyboard(), vk_session)
   return
  item_name = text.strip()
  item_type = players[user_id].get("pending_buy_type")
  faction = players[user_id]["faction"]
  valid_names = []
  if item_type == "detector":
   valid_names = list(DETECTORS.keys())
  else:
   valid_names = [item[0] for item in EQUIPMENT[faction][item_type]]
  if item_name in valid_names:
   price = None
   if item_type == "detector":
    price = DETECTORS[item_name]["price"]
   else:
    for item in EQUIPMENT[faction][item_type]:
     if item[0] == item_name:
      price = item[4] if item_type == "weapon" else item[5]
      break
   if players[user_id]["money"] < price:
    send_message(user_id, f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥. –ù—É–∂–Ω–æ {price}—Ä.", create_back_only_keyboard(), vk_session)
    return
   players[user_id]["pending_buy_item"] = item_name
   send_message(user_id, f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å {item_name} –∑–∞ {price}—Ä?", create_confirmation_keyboard(), vk_session)
   players[user_id]["state"] = "confirming_equipment_buy"
   save_data()
  else:
   send_message(user_id, "‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:", create_back_only_keyboard(), vk_session)
  return
 if state == "confirming_equipment_buy":
  handle_equipment_buy_confirmation(user_id, text, vk_session)
  return
 if state == STATE_TRADER_SELL_EQUIPMENT_CONFIRM:
  handle_equipment_sell_confirmation(user_id, text, vk_session)
  return
 if state == STATE_TRADER_SELL_EQUIPMENT:
  if text == "‚úÖ –î–∞" or text == "‚ùå –ù–µ—Ç":
   handle_equipment_sell_final(user_id, text, vk_session)
   return
  else:
   send_message(user_id, "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", create_confirmation_keyboard(), vk_session)
  return
 if state == STATE_TRADER_REPAIR:
  handle_repair(user_id, text, vk_session)
  return
 if text.lower() == "/start":
  players[user_id]["state"] = STATE_WAITING_FOR_START
  save_data()
  send_message(user_id, f"–ü—Ä–∏–≤–µ—Ç, {players[user_id]['name']}! üëã\n–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É ¬´–°—Ç–∞—Ä—Ç¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É.", create_start_keyboard(), vk_session)
  return
 if state == STATE_WAITING_FOR_START:
  if text == "–°—Ç–∞—Ä—Ç":
   players[user_id]["state"] = STATE_READING_INSTRUCTIONS
   save_data()
   send_message(user_id, GAME_INFO_TEXT, create_next_keyboard(), vk_session)
   return
 if state == STATE_READING_INSTRUCTIONS:
  if text == "–î–∞–ª–µ–µ":
   players[user_id]["state"] = STATE_CHOOSING_FACTION
   save_data()
   send_message(user_id, "–í—ã–±–µ—Ä–∏ —Å–≤–æ—é –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É:", create_faction_keyboard(), vk_session)
   return
 if state == STATE_CHOOSING_FACTION:
  faction_name = None
  if "–î–æ–ª–≥" in text:
   faction_name = "üõ°Ô∏è –î–æ–ª–≥"
  elif "–ì—Ä–µ—Ö" in text:
   faction_name = "‚ò¶Ô∏è –ì—Ä–µ—Ö"
  elif "–û–¥–∏–Ω–æ—á–∫–∏" in text:
   faction_name = "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏"
  if faction_name:
   if len(factions[faction_name]) >= MAX_FACTION_SIZES[faction_name]:
    all_full = True
    for f in factions:
     if len(factions[f]) < MAX_FACTION_SIZES[f]:
      all_full = False
      break
    if all_full:
     send_message(user_id, "‚è≥ –í—Å–µ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã. –î–æ–∂–¥–∏—Ç–µ—Å—å –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–æ–≤—ã—Ö –º–µ—Å—Ç.", create_faction_keyboard(), vk_session)
    else:
     send_message(user_id, f"‚ùå –í –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–µ ¬´{faction_name}¬ª —É–∂–µ –º–∞–∫—Å–∏–º—É–º –∏–≥—Ä–æ–∫–æ–≤. –í—ã–±–µ—Ä–∏ –¥—Ä—É–≥—É—é.", create_faction_keyboard(), vk_session)
   else:
    was_closed = not is_game_open()
    factions[faction_name].append(user_id)
    players[user_id]["faction"] = faction_name
    start_loc, start_point = find_start_position(faction_name)
    players[user_id]["location"] = start_loc
    players[user_id]["point"] = start_point
    players[user_id]["state"] = STATE_ENTERING_NICKNAME
    save_data()
    chat_link = FACTION_CHAT_LINKS.get(faction_name, "")
    send_message(user_id, f"‚úÖ –í—ã –≤—Å—Ç—É–ø–∏–ª–∏ –≤ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É {faction_name}!\n\nüí¨ –°—Å—ã–ª–∫–∞ –Ω–∞ –±–µ—Å–µ–¥—É –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏:\n{chat_link}\n\n–¢–µ–ø–µ—Ä—å –ø—Ä–∏–¥—É–º–∞–π —Å–µ–±–µ –∫–ª–∏—á–∫—É –≤ –ó–æ–Ω–µ:", None, vk_session)
   return
 if state == STATE_ENTERING_NICKNAME:
  nickname = text.strip()
  if nickname:
   players[user_id]["nickname"] = nickname
   players[user_id]["state"] = STATE_IN_MENU
   save_data()
   send_message(user_id, f"–£–¥–∞—á–Ω–æ–π –æ—Ö–æ—Ç—ã, {nickname}! üéØ\n{MAIN_MENU_TEXT}", create_main_menu_keyboard(user_id), vk_session)
  return
 if state == STATE_IN_MENU:
  if text == "üèïÔ∏è –õ–∞–≥–µ—Ä—å":
   players[user_id]["state"] = STATE_IN_CAMP
   save_data()
   send_message(user_id, format_camp_info(user_id), create_camp_menu_keyboard(), vk_session)
  elif text == "üë£ –ü–µ—Ä–µ—Ö–æ–¥":
   players[user_id]["state"] = STATE_IN_TRANSITION_MENU
   save_data()
   current_loc = players[user_id]["location"]
   current_point = players[user_id]["point"]
   send_location_image(user_id, current_loc, current_point, f"üìç –í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: {current_loc} {current_point}\n–í—ã–±–µ—Ä–∏ –ª–æ–∫–∞—Ü–∏—é –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞:", create_transition_keyboard(user_id), vk_session)
  elif text == get_main_menu_button(players[user_id]["point"], players[user_id]["location"]):
   handle_exploration(user_id, vk_session)
   return
  elif text == "üõí –¢–æ—Ä–≥–æ–≤–µ—Ü":
   players[user_id]["state"] = STATE_TRADER_MAIN
   save_data()
   send_message(user_id, "–í—ã —Ö–æ—Ç–∏—Ç–µ —á—Ç–æ –ª–∏–±–æ üí≤ –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –∏–ª–∏ üí± –ø—Ä–æ–¥–∞—Ç—å?", create_trader_main_keyboard(), vk_session)
   return
  elif text == "üß∞ –°–∫–ª–∞–¥":
   players[user_id]["state"] = STATE_WAREHOUSE
   save_data()
   upload_and_send_warehouse_global(user_id, vk_session)
   return
  elif text == "‚öîÔ∏è –í–æ–π–Ω–∞ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–æ–∫":
   players[user_id]["state"] = STATE_WAR_MAIN
   save_data()
   send_message(user_id, "‚öîÔ∏è –í–æ–π–Ω–∞ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–æ–∫ ‚Äî –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–π —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –∏ —Ä–∞–∑–≤–∏–≤–∞–π —Å–≤–æ—é –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É!", create_war_main_keyboard(), vk_session)
   return
  else:
   send_message(user_id, MAIN_MENU_TEXT, create_main_menu_keyboard(user_id), vk_session)
  return
 if state == STATE_IN_TRANSITION_MENU:
  if text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = STATE_IN_MENU
   save_data()
   send_message(user_id, MAIN_MENU_TEXT, create_main_menu_keyboard(user_id), vk_session)
   return
  current_loc = players[user_id]["location"]
  current_point = players[user_id]["point"]
  if text == f"‚ñ∂Ô∏è {current_loc} ‚óÄÔ∏è":
   players[user_id]["state"] = STATE_WAITING_FOR_POINT
   save_data()
   if not send_location_map(user_id, current_loc, vk_session):
    send_message(user_id, 'üåê –í–ø–∏—à–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –ø–µ—Ä–µ–π—Ç–∏:\n‚ùï –ü—Ä–∏–º–µ—Ä: "–¢–†1", "–ë1".', None, vk_session)
   return
  elif text in ["–ö–æ—Ä–¥–æ–Ω", "–°–≤–∞–ª–∫–∞", "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "–ü–æ–ª—è–Ω–∞"]:
   if text == current_loc:
    send_message(user_id, "–í—ã —É–∂–µ –∑–¥–µ—Å—å.", create_transition_keyboard(user_id), vk_session)
    return
   if can_transition_from(current_loc, current_point):
    transitions = get_available_transitions(current_loc, current_point)
    target = None
    for (tloc, tpoint) in transitions:
     if tloc == text:
      target = (tloc, tpoint)
      break
    if target:
     players[user_id]["pending_transition"] = target
     players[user_id]["state"] = STATE_CONFIRMING_TRANSITION
     save_data()
     send_message(user_id, f"–í—ã —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ {target[0]} {target[1]}?", create_confirmation_keyboard(), vk_session)
    else:
     send_message(user_id, "‚ùå –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —ç—Ç—É –ª–æ–∫–∞—Ü–∏—é –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–∞.", create_transition_keyboard(user_id), vk_session)
   else:
    send_message(user_id, "‚ùå –ò–∑ —ç—Ç–æ–π —Ç–æ—á–∫–∏ –Ω–µ–ª—å–∑—è –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –¥—Ä—É–≥—É—é –ª–æ–∫–∞—Ü–∏—é.", create_transition_keyboard(user_id), vk_session)
   return
  return
 if state == STATE_CONFIRMING_TRANSITION:
  pending = players[user_id].get("pending_transition")
  if not pending:
   players[user_id]["state"] = STATE_IN_TRANSITION_MENU
   save_data()
   send_message(user_id, "–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.", create_transition_keyboard(user_id), vk_session)
   return
  if text == "‚úÖ –î–∞":
   target_loc, target_point = pending
   target_owner = get_territory_owner(target_loc, target_point)
   player_faction = players[user_id]["faction"]
   if target_owner is not None and target_owner != player_faction:
    send_message(user_id, "‚ùå –≠—Ç–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –≤–∞—à–µ–π –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–µ. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.", create_transition_keyboard(user_id), vk_session)
    players[user_id]["state"] = STATE_IN_TRANSITION_MENU
    players[user_id].pop("pending_transition", None)
    save_data()
    return
   ok, msg = check_vital_conditions(user_id, "–ø–µ—Ä–µ—Ö–æ–¥")
   if not ok:
    send_message(user_id, msg, create_transition_keyboard(user_id), vk_session)
    players[user_id]["state"] = STATE_IN_TRANSITION_MENU
    players[user_id].pop("pending_transition", None)
    save_data()
    return
   players[user_id]["previous_location"] = players[user_id]["location"]
   players[user_id]["previous_point"] = players[user_id]["point"]
   players[user_id]["stamina"] -= 3
   players[user_id]["hunger"] += 2
   players[user_id]["location"], players[user_id]["point"] = target_loc, target_point
   transition_time = 1800
   if has_active_donation(user_id):
    transition_time = 900
   players[user_id]["transition_end_time"] = time.time() + transition_time
   players[user_id]["state"] = STATE_TRANSITION_WAIT
   save_data()
   time_text = "30 –º–∏–Ω—É—Ç" if transition_time == 1800 else "15 –º–∏–Ω—É—Ç"
   send_message(user_id, f"üö∂‚Äç‚ôÇÔ∏è –í—ã –Ω–∞—á–∞–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ {target_loc} {target_point}. –û–∂–∏–¥–∞–Ω–∏–µ: {time_text}.", None, vk_session)
   return
  elif text == "‚ùå –ù–µ—Ç":
   players[user_id]["state"] = STATE_IN_TRANSITION_MENU
   players[user_id].pop("pending_transition", None)
   save_data()
   send_message(user_id, "–í—ã–±–µ—Ä–∏ –ª–æ–∫–∞—Ü–∏—é –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞:", create_transition_keyboard(user_id), vk_session)
   return
  return
 if state == STATE_WAITING_FOR_POINT:
  point = text.upper().strip()
  current_loc = players[user_id]["location"]
  current_point = players[user_id]["point"]
  if point == current_point:
   send_message(user_id, "‚ùå –í—ã —É–∂–µ –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –Ω–∞ —ç—Ç–æ–π —Ç–æ—á–∫–µ.", create_main_menu_keyboard(user_id), vk_session)
   players[user_id]["state"] = STATE_IN_MENU
   save_data()
   return
  if is_valid_point(current_loc, point):
   target_owner = get_territory_owner(current_loc, point)
   player_faction = players[user_id]["faction"]
   if target_owner is not None and target_owner != player_faction:
    send_message(user_id, "‚ùå –≠—Ç–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –≤–∞—à–µ–π –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–µ. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.", create_main_menu_keyboard(user_id), vk_session)
    players[user_id]["state"] = STATE_IN_MENU
    save_data()
    return
   ok, msg = check_vital_conditions(user_id, "–ø–µ—Ä–µ—Ö–æ–¥")
   if not ok:
    send_message(user_id, msg, create_main_menu_keyboard(user_id), vk_session)
    players[user_id]["state"] = STATE_IN_MENU
    save_data()
    return
   players[user_id]["previous_location"] = players[user_id]["location"]
   players[user_id]["previous_point"] = players[user_id]["point"]
   players[user_id]["stamina"] -= 3
   players[user_id]["hunger"] += 2
   players[user_id]["point"] = point
   transition_time = 1800
   if has_active_donation(user_id):
    transition_time = 900
   players[user_id]["transition_end_time"] = time.time() + transition_time
   players[user_id]["state"] = STATE_TRANSITION_WAIT
   save_data()
   time_text = "30 –º–∏–Ω—É—Ç" if transition_time == 1800 else "15 –º–∏–Ω—É—Ç"
   send_message(user_id, f"üö∂‚Äç‚ôÇÔ∏è –í—ã –Ω–∞—á–∞–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ {current_loc} {point}. –û–∂–∏–¥–∞–Ω–∏–µ: {time_text}.", None, vk_session)
  else:
   send_message(user_id, f"‚ùå –¢–∞–∫–æ–π —Ç–æ—á–∫–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ª–æ–∫–∞—Ü–∏–∏ ¬´{current_loc}¬ª.", create_main_menu_keyboard(user_id), vk_session)
   players[user_id]["state"] = STATE_IN_MENU
   save_data()
  return
 if state == STATE_IN_CAMP:
  if text == "üéí –†—é–∫–∑–∞–∫":
   players[user_id]["state"] = STATE_IN_BACKPACK
   save_data()
   upload_and_send_inventory(user_id, vk_session)
   return
  elif text == "üü° –ü–æ—è—Å":
   players[user_id]["state"] = STATE_BELT_MAIN
   save_data()
   belt = players[user_id].get("belt", [None, None, None])
   belt_info = (f"üü° –ü–æ—è—Å:\n1Ô∏è‚É£ {belt[0] or '–ø—É—Å—Ç–æ'}\n2Ô∏è‚É£ {belt[1] or '–ø—É—Å—Ç–æ'}\n3Ô∏è‚É£ {belt[2] or '–ø—É—Å—Ç–æ'}\nüí° –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n¬´–ü–æ–≤–µ—Å–∏—Ç—å [–∞—Ä—Ç–µ—Ñ–∞–∫—Ç]¬ª\n¬´–°–Ω—è—Ç—å [–∞—Ä—Ç–µ—Ñ–∞–∫—Ç]¬ª")
   send_message(user_id, belt_info, create_belt_main_keyboard(), vk_session)
   return
  elif text == "üí§ –û—Ç–¥—ã—Ö":
   players[user_id]["state"] = STATE_RESTING
   players[user_id]["rest_start_time"] = time.time()
   players[user_id]["initial_stamina"] = players[user_id]["stamina"]
   save_data()
   stamina = players[user_id]["stamina"]
   rest_text = (f"‚ö° –í–∞—à–∞ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å: {stamina}/10\nüò¥ –í–æ –≤—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞, –≤–∞—à–∞ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å –ø–æ–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ 1 –∫–∞–∂–¥—ã–µ 6 –º–∏–Ω—É—Ç.\n‚ö° –í—ã–ø–∏–≤ —Å—Ç–∏–º—É–ª–∏—Ä—É—é—â–∏–π –Ω–∞–ø–∏—Ç–æ–∫, –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ø–æ–ª–Ω–∏—Ç—å —Å–≤–æ—é –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å\nüåï –¢–∞–∫–∂–µ, –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –º–æ–≥—É—Ç –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ")
   send_message(user_id, rest_text, create_resting_keyboard(), vk_session)
   return
  elif text == "üîã –ü–æ–¥–∑–∞—Ä—è–¥–∫–∞":
   p = players[user_id]
   detector = p.get("detector")
   detector_charge = p.get("detector_charge", 0)
   detector_max_charge = p.get("detector_max_charge", 0)
   if not detector or detector_max_charge <= 0:
    send_message(user_id, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞.", create_camp_menu_keyboard(), vk_session)
    return
   if detector_charge >= detector_max_charge:
    send_message(user_id, "üîã –î–µ—Ç–µ–∫—Ç–æ—Ä —É–∂–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞—Ä—è–∂–µ–Ω.", create_camp_menu_keyboard(), vk_session)
    return
   batteries_needed = detector_max_charge - detector_charge
   batteries_have = p["backpack"].get("–±–∞—Ç–∞—Ä–µ–π–∫–∏", 0)
   if batteries_have <= 0:
    send_message(user_id, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –±–∞—Ç–∞—Ä–µ–µ–∫ –¥–ª—è –ø–æ–¥–∑–∞—Ä—è–¥–∫–∏.", create_camp_menu_keyboard(), vk_session)
    return
   batteries_used = min(batteries_needed, batteries_have)
   p["detector_charge"] = detector_charge + batteries_used
   p["backpack"]["–±–∞—Ç–∞—Ä–µ–π–∫–∏"] -= batteries_used
   if p["backpack"]["–±–∞—Ç–∞—Ä–µ–π–∫–∏"] <= 0:
    del p["backpack"]["–±–∞—Ç–∞—Ä–µ–π–∫–∏"]
   save_data()
   send_message(user_id, f"‚úÖ –î–µ—Ç–µ–∫—Ç–æ—Ä –∑–∞—Ä—è–∂–µ–Ω –Ω–∞ {batteries_used} –µ–¥–∏–Ω–∏—Ü.\nüìü –ó–∞—Ä—è–¥: {p['detector_charge']}/{detector_max_charge}", create_camp_menu_keyboard(), vk_session)
   return
  elif text.startswith("üìä –°—Ç–∞—Ç—É—Å –≤—ã–±—Ä–æ—Å–∞:"):
   status = get_emission_status()
   restored_text = ", ".join(last_restored_categories) if last_restored_categories else "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
   msg = (f"üìä –°—Ç–∞—Ç—É—Å –≤—ã–±—Ä–æ—Å–∞: {status}\n–û—á–∫–æ–≤: {emission_counter}/{EMISSION_MAX}\n‚ôªÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:\n{restored_text}")
   send_message(user_id, msg, create_camp_menu_keyboard(), vk_session)
   return
  elif text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = STATE_IN_MENU
   save_data()
   send_message(user_id, MAIN_MENU_TEXT, create_main_menu_keyboard(user_id), vk_session)
   return
 if state == STATE_IN_BACKPACK:
  if text in ["–ù–∞–∑–∞–¥", "üîö –ù–∞–∑–∞–¥"]:
   players[user_id]["state"] = STATE_IN_CAMP
   save_data()
   send_message(user_id, format_camp_info(user_id), create_camp_menu_keyboard(), vk_session)
   return
  elif text == "‚ùáÔ∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å":
   players[user_id]["state"] = STATE_USING_ITEM
   save_data()
   send_message(user_id, "–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: —Ö–ª–µ–± 2):", create_use_item_keyboard(), vk_session)
   return
  elif text == "‚ôªÔ∏è –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞":
   current = get_sort_mode(user_id)
   set_sort_mode(user_id, current + 1)
   mode_names = ["–æ–±—ã—á–Ω–∞—è", "–ø–æ —Ç–∏–ø—É", "–ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É"]
   new_mode = mode_names[players[user_id]["backpack_sort"]]
   send_message(user_id, f"üîÑ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞: {new_mode}", None, vk_session)
   upload_and_send_inventory(user_id, vk_session)
   return
  elif text == "üîÑ –û–±–Ω–æ–≤–∏—Ç—å":
   upload_and_send_inventory(user_id, vk_session)
   return
  elif text == "üí° –∏–Ω—Ñ–æ":
   send_message(user_id, format_minimal_info(user_id), create_backpack_menu_keyboard(), vk_session)
   return
  return
 if state == STATE_WAREHOUSE:
  if text in ["–ù–∞–∑–∞–¥", "üîö –ù–∞–∑–∞–¥", "üß∞ –°–∫–ª–∞–¥"]:
   players[user_id]["state"] = STATE_IN_MENU
   save_data()
   send_message(user_id, MAIN_MENU_TEXT, create_main_menu_keyboard(user_id), vk_session)
   return
  else:
   handle_warehouse_action(user_id, text, vk_session)
   return
 if state == STATE_CONFIRMING_EQUIPMENT_SELL:
  handle_equipment_sell_final(user_id, text, vk_session)
  return
 if state == STATE_RESTING:
  if text == "‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—Ç–¥—ã—Ö–∞":
   players[user_id]["state"] = STATE_IN_CAMP
   players[user_id]["rest_start_time"] = None
   players[user_id].pop("initial_stamina", None)
   save_data()
   send_message(user_id, format_camp_info(user_id), create_camp_menu_keyboard(), vk_session)
   return
  start_time = players[user_id].get("rest_start_time")
  if start_time:
   elapsed = time.time() - start_time
   initial = players[user_id].get("initial_stamina", players[user_id]["stamina"])
   belt_bonus = apply_belt_effects_on_rest(user_id)
   donation_bonus = 1 if has_active_donation(user_id) else 0
   new_stamina = min(10, initial + int(elapsed // 360) * (1 + belt_bonus + donation_bonus))
   if new_stamina > players[user_id]["stamina"]:
    players[user_id]["stamina"] = new_stamina
    save_data()
    if new_stamina == 5:
     send_message(user_id, "‚ö° –í–∞—à–∞ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å –¥–æ—Å—Ç–∏–≥–ª–∞ 5/10.", create_resting_keyboard(), vk_session)
    elif new_stamina >= 10:
     players[user_id]["stamina"] = 10
     players[user_id]["state"] = STATE_IN_CAMP
     players[user_id]["rest_start_time"] = None
     players[user_id].pop("initial_stamina", None)
     save_data()
     send_message(user_id, "üò¥ –í—ã –æ—Ç–¥–æ—Ö–Ω—É–ª–∏ –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å.", create_camp_menu_keyboard(), vk_session)
     return
   stamina = players[user_id]["stamina"]
   rest_text = (f"‚ö° –í–∞—à–∞ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å: {stamina}/10\nüò¥ –í–æ –≤—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞, –≤–∞—à–∞ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å –ø–æ–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ 1 –∫–∞–∂–¥—ã–µ 6 –º–∏–Ω—É—Ç.\n‚ö° –í—ã–ø–∏–≤ —Å—Ç–∏–º—É–ª–∏—Ä—É—é—â–∏–π –Ω–∞–ø–∏—Ç–æ–∫, –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ø–æ–ª–Ω–∏—Ç—å —Å–≤–æ—é –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å\nüåï –¢–∞–∫–∂–µ, –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –º–æ–≥—É—Ç –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ")
   send_message(user_id, rest_text, create_resting_keyboard(), vk_session)
   return
 if state == STATE_WAR_MAIN:
  if text == "üó∫Ô∏è –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –∑–æ–Ω—ã üó∫Ô∏è":
   players[user_id]["state"] = STATE_WAR_TERRITORIES
   save_data()
   send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:", create_war_territories_keyboard(), vk_session)
   return
  elif text == "üí≤ –ü—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ —Å–∫–≤–∞–¥":
   p = players[user_id]
   msg = (f"üí≤ –î–µ–Ω—å–≥–∏: {p.get('money', 0)}—Ä\nüçñ –ï–¥–∞: {p.get('food_units', 0)} –µ–¥–∏–Ω–∏—Ü\n‚öï –ú–µ–¥–∏—Ü–∏–Ω–∞: {p.get('med_units', 0)} –µ–¥–∏–Ω–∏—Ü\n‚ò¢ –†–∞–¥. –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã: {p.get('rad_units', 0)} –µ–¥–∏–Ω–∏—Ü\n–ö–∞–∫–æ–π —Å–∫–≤–∞–¥ –ø—Ä–∏–æ–±—Ä–µ—Ç–µ—Ç–µ?\nüë®‚Äçüë¶ 1 —Å–∫–≤–∞–¥ 1 —Å–∏–ª–∞ - üí≤100—Ä, üçñ 5 –µ–¥. –µ–¥—ã, ‚öï 5 –µ–¥. –º–µ–¥., ‚ò¢ 5 –µ–¥. —Ä–∞–¥.\nüë®‚Äçüë¶‚Äçüë¶ 3 —Å–∫–≤–∞–¥–∞ 3 —Å–∏–ª—ã - üí≤300—Ä, üçñ 10 –µ–¥. –µ–¥—ã, ‚öï 10 –µ–¥. –º–µ–¥., ‚ò¢ 10 –µ–¥. —Ä–∞–¥.\nüë®‚Äçüë®‚Äçüë¶‚Äçüë¶ 5 —Å–∫–≤–∞–¥–æ–≤ 5 —Å–∏–ª - üí≤500—Ä, üçñ 15 –µ–¥. –µ–¥—ã, ‚öï 15 –µ–¥. –º–µ–¥., ‚ò¢ 15 –µ–¥. —Ä–∞–¥.")
   players[user_id]["state"] = STATE_WAR_BUY_SQUAD
   save_data()
   send_message(user_id, msg, create_war_buy_squad_keyboard(), vk_session)
   return
  elif text == "‚ôªÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–≤–∞–¥–∞–º–∏":
   p = players[user_id]
   msg = (f"üë®‚Äçüë®‚Äçüë¶‚Äçüë¶ –í–∞—à–∏ —Å–∫–≤–∞–¥—ã: {p.get('squads', 0)}\n–ö–∞–∫ —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –∏–º–∏ —Ä–∞—Å–ø–æ—Ä—è–¥–∏—Ç—å—Å—è?\n\nüí° –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å —Å–∫–≤–∞–¥—ã –Ω–∞ —Å–≤–æ–µ–π —Ç–æ—á–∫–µ:\n–∏–Ω—Ñ–æ [–ª–æ–∫–∞—Ü–∏—è] [—Ç–æ—á–∫–∞]\n–ü—Ä–∏–º–µ—Ä: –∏–Ω—Ñ–æ –∫–æ—Ä–¥–æ–Ω –±1")
   players[user_id]["state"] = STATE_WAR_MANAGE_SQUADS
   save_data()
   send_message(user_id, msg, create_war_manage_keyboard(), vk_session)
   return
  elif text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = STATE_IN_MENU
   save_data()
   send_message(user_id, MAIN_MENU_TEXT, create_main_menu_keyboard(user_id), vk_session)
   return
  return
 if state == STATE_WAR_TERRITORIES:
  if text in ["–ö–æ—Ä–¥–æ–Ω", "–°–≤–∞–ª–∫–∞", "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "–ü–æ–ª—è–Ω–∞"]:
   send_war_map(user_id, text, f"üìç –õ–æ–∫–∞—Ü–∏—è: {text}", create_war_territories_keyboard(), vk_session)
   return
  elif text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = STATE_WAR_MAIN
   save_data()
   send_message(user_id, "‚öîÔ∏è –í–æ–π–Ω–∞ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–æ–∫", create_war_main_keyboard(), vk_session)
   return
  return
 if state == STATE_WAR_BUY_SQUAD:
  if text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = STATE_WAR_MAIN
   save_data()
   send_message(user_id, "‚öîÔ∏è –í–æ–π–Ω–∞ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–æ–∫", create_war_main_keyboard(), vk_session)
   return
  elif text == "‚ôªÔ∏è –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –ø—Ä–æ–≤–∏–∑–∏–∏":
   p = players[user_id]
   msg = (f"‚ôª –ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –µ–¥–∏–Ω–∏—Ü—ã?\n‚ùï –ü—Ä–∏–º–µ—Ä: –•–ª–µ–± 1; –ë–∏–Ω—Ç 2; –í–æ–¥–∫–∞ 3.\n\nüçñ –ï–¥–∞: {p.get('food_units', 0)} –µ–¥–∏–Ω–∏—Ü\n‚öï –ú–µ–¥–∏—Ü–∏–Ω–∞: {p.get('med_units', 0)} –µ–¥–∏–Ω–∏—Ü\n‚ò¢ –†–∞–¥. –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã: {p.get('rad_units', 0)} –µ–¥–∏–Ω–∏—Ü\n\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã:\nüçñ —à–æ–∫–æ–ª–∞–¥–Ω—ã–π –±–∞—Ç–æ–Ω—á–∏–∫(1), —Ö–ª–µ–±(2), –∫–æ–ª–±–∞—Å–∞(3), –∫–æ–Ω—Å–µ—Ä–≤–∞(4)\n‚öï –±–∏–Ω—Ç(1), –∞–ø—Ç–µ—á–∫–∞(2), –∞—Ä–º–µ–π—Å–∫–∞—è –∞–ø—Ç–µ—á–∫–∞(3), –Ω–∞—É—á–Ω–∞—è –∞–ø—Ç–µ—á–∫–∞(3+1‚ò¢)\n‚ò¢ —Å–∏–≥–∞—Ä–µ—Ç—ã(1), –≤–æ–¥–∫–∞(2), —Ä–∞–¥–∏–æ–ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä(3), –∞–Ω—Ç–∏—Ä–∞–¥(4)")
   players[user_id]["state"] = STATE_WAR_CONVERT
   save_data()
   send_message(user_id, msg, create_back_only_keyboard(), vk_session)
   return
  elif text == "1 —Å–∫–≤–∞–¥":
   p = players[user_id]
   squad_count = 1
   cost = SQUAD_COSTS[squad_count]
   if p.get("money", 0) < cost["money"]:
    send_message(user_id, f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥. –ù—É–∂–Ω–æ {cost['money']}—Ä.", create_war_buy_squad_keyboard(), vk_session)
    return
   if p.get("food_units", 0) < cost["food"]:
    send_message(user_id, f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –µ–¥—ã. –ù—É–∂–Ω–æ {cost['food']} –µ–¥–∏–Ω–∏—Ü.", create_war_buy_squad_keyboard(), vk_session)
    return
   if p.get("med_units", 0) < cost["med"]:
    send_message(user_id, f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ–¥–∏—Ü–∏–Ω—ã. –ù—É–∂–Ω–æ {cost['med']} –µ–¥–∏–Ω–∏—Ü.", create_war_buy_squad_keyboard(), vk_session)
    return
   if p.get("rad_units", 0) < cost["rad"]:
    send_message(user_id, f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–∞–¥. –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤. –ù—É–∂–Ω–æ {cost['rad']} –µ–¥–∏–Ω–∏—Ü.", create_war_buy_squad_keyboard(), vk_session)
    return
   p["money"] -= cost["money"]
   p["food_units"] -= cost["food"]
   p["med_units"] -= cost["med"]
   p["rad_units"] -= cost["rad"]
   p["squads"] = p.get("squads", 0) + squad_count
   save_data()
   send_message(user_id, f"‚úÖ –ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–æ {squad_count} —Å–∫–≤–∞–¥! –í—Å–µ–≥–æ: {p['squads']}", create_war_buy_squad_keyboard(), vk_session)
   return
  elif text == "3 —Å–∫–≤–∞–¥–∞":
   p = players[user_id]
   squad_count = 3
   cost = SQUAD_COSTS[squad_count]
   if p.get("money", 0) < cost["money"]:
    send_message(user_id, f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥. –ù—É–∂–Ω–æ {cost['money']}—Ä.", create_war_buy_squad_keyboard(), vk_session)
    return
   if p.get("food_units", 0) < cost["food"]:
    send_message(user_id, f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –µ–¥—ã. –ù—É–∂–Ω–æ {cost['food']} –µ–¥–∏–Ω–∏—Ü.", create_war_buy_squad_keyboard(), vk_session)
    return
   if p.get("med_units", 0) < cost["med"]:
    send_message(user_id, f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ–¥–∏—Ü–∏–Ω—ã. –ù—É–∂–Ω–æ {cost['med']} –µ–¥–∏–Ω–∏—Ü.", create_war_buy_squad_keyboard(), vk_session)
    return
   if p.get("rad_units", 0) < cost["rad"]:
    send_message(user_id, f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–∞–¥. –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤. –ù—É–∂–Ω–æ {cost['rad']} –µ–¥–∏–Ω–∏—Ü.", create_war_buy_squad_keyboard(), vk_session)
    return
   p["money"] -= cost["money"]
   p["food_units"] -= cost["food"]
   p["med_units"] -= cost["med"]
   p["rad_units"] -= cost["rad"]
   p["squads"] = p.get("squads", 0) + squad_count
   save_data()
   send_message(user_id, f"‚úÖ –ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–æ {squad_count} —Å–∫–≤–∞–¥–∞! –í—Å–µ–≥–æ: {p['squads']}", create_war_buy_squad_keyboard(), vk_session)
   return
  elif text == "5 —Å–∫–≤–∞–¥–æ–≤":
   p = players[user_id]
   squad_count = 5
   cost = SQUAD_COSTS[squad_count]
   if p.get("money", 0) < cost["money"]:
    send_message(user_id, f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥. –ù—É–∂–Ω–æ {cost['money']}—Ä.", create_war_buy_squad_keyboard(), vk_session)
    return
   if p.get("food_units", 0) < cost["food"]:
    send_message(user_id, f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –µ–¥—ã. –ù—É–∂–Ω–æ {cost['food']} –µ–¥–∏–Ω–∏—Ü.", create_war_buy_squad_keyboard(), vk_session)
    return
   if p.get("med_units", 0) < cost["med"]:
    send_message(user_id, f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ–¥–∏—Ü–∏–Ω—ã. –ù—É–∂–Ω–æ {cost['med']} –µ–¥–∏–Ω–∏—Ü.", create_war_buy_squad_keyboard(), vk_session)
    return
   if p.get("rad_units", 0) < cost["rad"]:
    send_message(user_id, f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–∞–¥. –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤. –ù—É–∂–Ω–æ {cost['rad']} –µ–¥–∏–Ω–∏—Ü.", create_war_buy_squad_keyboard(), vk_session)
    return
   p["money"] -= cost["money"]
   p["food_units"] -= cost["food"]
   p["med_units"] -= cost["med"]
   p["rad_units"] -= cost["rad"]
   p["squads"] = p.get("squads", 0) + squad_count
   save_data()
   send_message(user_id, f"‚úÖ –ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–æ {squad_count} —Å–∫–≤–∞–¥–æ–≤! –í—Å–µ–≥–æ: {p['squads']}", create_war_buy_squad_keyboard(), vk_session)
   return
  else:
   p = players[user_id]
   msg = (f"‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞.\n\nüí≤ –î–µ–Ω—å–≥–∏: {p.get('money', 0)}—Ä\nüçñ –ï–¥–∞: {p.get('food_units', 0)} –µ–¥–∏–Ω–∏—Ü\n‚öï –ú–µ–¥–∏—Ü–∏–Ω–∞: {p.get('med_units', 0)} –µ–¥–∏–Ω–∏—Ü\n‚ò¢ –†–∞–¥. –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã: {p.get('rad_units', 0)} –µ–¥–∏–Ω–∏—Ü\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–≤–∞–¥ –¥–ª—è –ø–æ–∫—É–ø–∫–∏:")
   send_message(user_id, msg, create_war_buy_squad_keyboard(), vk_session)
   return
 if state == STATE_WAR_CONVERT:
  if text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = STATE_WAR_BUY_SQUAD
   save_data()
   p = players[user_id]
   msg = f"üí≤ –î–µ–Ω—å–≥–∏: {p.get('money', 0)}—Ä\nüçñ –ï–¥–∞: {p.get('food_units', 0)} –µ–¥–∏–Ω–∏—Ü\n‚öï –ú–µ–¥–∏—Ü–∏–Ω–∞: {p.get('med_units', 0)} –µ–¥–∏–Ω–∏—Ü\n‚ò¢ –†–∞–¥. –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã: {p.get('rad_units', 0)} –µ–¥–∏–Ω–∏—Ü\n–ö–∞–∫–æ–π —Å–∫–≤–∞–¥ –ø—Ä–∏–æ–±—Ä–µ—Ç–µ—Ç–µ?"
   send_message(user_id, msg, create_war_buy_squad_keyboard(), vk_session)
   return
  p = players[user_id]
  conversions = text.split(";")
  total_converted = {"food": 0, "med": 0, "rad": 0}
  errors = []
  for conv in conversions:
   conv = conv.strip()
   if not conv:
    continue
   words = conv.split()
   if len(words) < 2:
    errors.append(f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: '{conv}'")
    continue
   try:
    count = int(words[-1])
    item_name = " ".join(words[:-1]).lower()
   except:
    errors.append(f"‚ùå '{words[-1]}' –Ω–µ —á–∏—Å–ª–æ")
    continue
   if count <= 0:
    errors.append("‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0")
    continue
   if item_name not in CONVERSION_VALUES:
    errors.append(f"‚ùå '{' '.join(words[:-1])}' –Ω–µ–ª—å–∑—è –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å")
    continue
   if p["backpack"].get(item_name, 0) < count:
    errors.append(f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ '{' '.join(words[:-1])}' (–µ—Å—Ç—å: {p['backpack'].get(item_name, 0)})")
    continue
   conv_data = CONVERSION_VALUES[item_name]
   p["backpack"][item_name] -= count
   if p["backpack"][item_name] <= 0:
    del p["backpack"][item_name]
   if conv_data["type"] == "special":
    med_value = conv_data.get("med", 0) * count
    rad_value = conv_data.get("rad", 0) * count
    p["med_units"] = p.get("med_units", 0) + med_value
    p["rad_units"] = p.get("rad_units", 0) + rad_value
    total_converted["med"] += med_value
    total_converted["rad"] += rad_value
   else:
    unit_type = conv_data["type"]
    unit_value = conv_data["value"] * count
    if unit_type == "food":
     p["food_units"] = p.get("food_units", 0) + unit_value
    elif unit_type == "med":
     p["med_units"] = p.get("med_units", 0) + unit_value
    elif unit_type == "rad":
     p["rad_units"] = p.get("rad_units", 0) + unit_value
    total_converted[unit_type] += unit_value
  save_data()
  msg_parts = []
  if total_converted["food"] > 0 or total_converted["med"] > 0 or total_converted["rad"] > 0:
   msg_parts.append("‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ:")
   if total_converted["food"] > 0:
    msg_parts.append(f"üçñ –ï–¥–∞: +{total_converted['food']} –µ–¥–∏–Ω–∏—Ü")
   if total_converted["med"] > 0:
    msg_parts.append(f"‚öï –ú–µ–¥–∏—Ü–∏–Ω–∞: +{total_converted['med']} –µ–¥–∏–Ω–∏—Ü")
   if total_converted["rad"] > 0:
    msg_parts.append(f"‚ò¢ –†–∞–¥. –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã: +{total_converted['rad']} –µ–¥–∏–Ω–∏—Ü")
  if errors:
   msg_parts.append("")
   msg_parts.extend(errors)
  msg_parts.append("")
  msg_parts.append(f"–¢–µ–∫—É—â–∏–µ –∑–∞–ø–∞—Å—ã:\nüçñ –ï–¥–∞: {p.get('food_units', 0)} –µ–¥–∏–Ω–∏—Ü\n‚öï –ú–µ–¥–∏—Ü–∏–Ω–∞: {p.get('med_units', 0)} –µ–¥–∏–Ω–∏—Ü\n‚ò¢ –†–∞–¥. –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã: {p.get('rad_units', 0)} –µ–¥–∏–Ω–∏—Ü")
  msg_parts.append("\n–í–≤–µ–¥–∏—Ç–µ –µ—â—ë –ø—Ä–µ–¥–º–µ—Ç—ã –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –ù–∞–∑–∞–¥")
  send_message(user_id, "\n".join(msg_parts), create_back_only_keyboard(), vk_session)
  return
 if state == STATE_WAR_MANAGE_SQUADS:
  if text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = STATE_WAR_MAIN
   save_data()
   send_message(user_id, "‚öîÔ∏è –í–æ–π–Ω–∞ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–æ–∫", create_war_main_keyboard(), vk_session)
   return
  elif text == "üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å":
   p = players[user_id]
   current_loc = p["location"]
   players[user_id]["state"] = STATE_WAR_SEND_SQUAD_LOCATION
   players[user_id]["squad_action"] = "send"
   save_data()
   send_message(user_id, f"üó∫Ô∏è –í—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –Ω–∞ –ª–æ–∫–∞—Ü–∏–∏: {current_loc}\n–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∫–≤–∞–¥–æ–≤:", create_war_send_location_keyboard(user_id), vk_session)
   return
  elif text == "üì• –í—ã–≤–µ—Å—Ç–∏":
   players[user_id]["state"] = STATE_WAR_SEND_SQUAD_LOCATION
   players[user_id]["squad_action"] = "withdraw"
   save_data()
   send_message(user_id, "üó∫Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–∫–≤–∞–¥–æ–≤:", create_war_send_location_keyboard(user_id), vk_session)
   return
  elif text == "üë• –û–±—â–∏–µ —Å–∫–≤–∞–¥—ã":
   p = players[user_id]
   faction = p["faction"]
   shared = faction_shared_squads.get(faction, 0)
   players[user_id]["state"] = STATE_WAR_SHARED_SQUADS
   save_data()
   msg = f"üë• –û–±—â–∏–µ —Å–∫–≤–∞–¥—ã –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ {faction}: {shared}\n–í–∞—à–∏ —Å–∫–≤–∞–¥—ã: {p.get('squads', 0)}"
   send_message(user_id, msg, create_shared_squads_keyboard(), vk_session)
   return
  return
 if state == STATE_WAR_SEND_SQUAD_LOCATION:
  if text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = STATE_WAR_MANAGE_SQUADS
   save_data()
   p = players[user_id]
   msg = f"üë®‚Äçüë®‚Äçüë¶‚Äçüë¶ –í–∞—à–∏ —Å–∫–≤–∞–¥—ã: {p.get('squads', 0)}\n–ö–∞–∫ —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –∏–º–∏ —Ä–∞—Å–ø–æ—Ä—è–¥–∏—Ç—å—Å—è?"
   send_message(user_id, msg, create_war_manage_keyboard(), vk_session)
   return
  if text in ["–ö–æ—Ä–¥–æ–Ω", "–°–≤–∞–ª–∫–∞", "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "–ü–æ–ª—è–Ω–∞"]:
   p = players[user_id]
   action = p.get("squad_action", "send")
   current_loc = p["location"]
   current_point = p["point"]
   if action == "send":
    if text != current_loc:
     available_transitions = get_available_transitions(current_loc, current_point)
     valid_border_points = [tp for tl, tp in available_transitions if tl == text]
     if valid_border_points:
      players[user_id]["pending_squad_location"] = text
      players[user_id]["pending_border_points"] = valid_border_points
      players[user_id]["state"] = STATE_WAR_SEND_SQUAD_POINT
      save_data()
      border_info = ", ".join(valid_border_points)
      msg = f"üó∫Ô∏è –õ–æ–∫–∞—Ü–∏—è: {text}\nüìç –í—ã –Ω–∞ —Ç–æ—á–∫–µ –ø–µ—Ä–µ—Ö–æ–¥–∞! –î–æ—Å—Ç—É–ø–Ω—ã–µ –≥—Ä–∞–Ω–∏—á–∞—â–∏–µ —Ç–æ—á–∫–∏: {border_info}\n–í–≤–µ–¥–∏—Ç–µ —Ç–æ—á–∫—É –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∫–≤–∞–¥–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä: {valid_border_points[0]} 5):"
      send_war_map(user_id, text, msg, create_back_only_keyboard(), vk_session)
      return
     else:
      send_message(user_id, f"‚ùå –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–∫–≤–∞–¥—ã —Ç–æ–ª—å–∫–æ –Ω–∞ –ª–æ–∫–∞—Ü–∏—é, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å ({current_loc}), –∏–ª–∏ –Ω–∞ –≥—Ä–∞–Ω–∏—á–∞—â–∏–µ —Ç–æ—á–∫–∏ —Å —Ç–æ—á–µ–∫ –ø–µ—Ä–µ—Ö–æ–¥–∞.", create_war_send_location_keyboard(user_id), vk_session)
      return
   players[user_id]["pending_squad_location"] = text
   players[user_id]["pending_border_points"] = None
   players[user_id]["state"] = STATE_WAR_SEND_SQUAD_POINT
   save_data()
   if action == "send":
    msg = f"üó∫Ô∏è –õ–æ–∫–∞—Ü–∏—è: {text}\n–í–≤–µ–¥–∏—Ç–µ —Ç–æ—á–∫—É –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∫–≤–∞–¥–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ë1 5):"
   else:
    msg = f"üó∫Ô∏è –õ–æ–∫–∞—Ü–∏—è: {text}\n–í–≤–µ–¥–∏—Ç–µ —Ç–æ—á–∫—É –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∫–≤–∞–¥–æ–≤ –¥–ª—è –≤—ã–≤–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ë1 3):"
   send_war_map(user_id, text, msg, create_back_only_keyboard(), vk_session)
   return
  return
 if state == STATE_WAR_SEND_SQUAD_POINT:
  if text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = STATE_WAR_SEND_SQUAD_LOCATION
   save_data()
   send_message(user_id, "üó∫Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é:", create_war_send_location_keyboard(user_id), vk_session)
   return
  text_lower = text.lower()
  if text_lower.startswith("–∏–Ω—Ñ–æ "):
   info_parts = text_lower[5:].strip().split()
   if len(info_parts) < 2:
    send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: –∏–Ω—Ñ–æ [–ª–æ–∫–∞—Ü–∏—è] [—Ç–æ—á–∫–∞]\n–ü—Ä–∏–º–µ—Ä: –∏–Ω—Ñ–æ –∫–æ—Ä–¥–æ–Ω –±1\n–°–æ–∫—Ä–∞—â–µ–Ω–∏—è: —Ç–¥ = –¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", create_back_only_keyboard(), vk_session)
    return
   info_point = info_parts[-1].upper()
   info_loc_input = " ".join(info_parts[:-1])
   location_map = {"–∫–æ—Ä–¥–æ–Ω": "–ö–æ—Ä–¥–æ–Ω", "—Å–≤–∞–ª–∫–∞": "–°–≤–∞–ª–∫–∞", "—Ç—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞": "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "—Ç–µ–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞": "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "—Ç–¥": "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "–ø–æ–ª—è–Ω–∞": "–ü–æ–ª—è–Ω–∞"}
   info_location = location_map.get(info_loc_input)
   if not info_location:
    send_message(user_id, "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è.\n–î–æ—Å—Ç—É–ø–Ω–æ: –ö–æ—Ä–¥–æ–Ω, –°–≤–∞–ª–∫–∞, —Ç–¥, –ü–æ–ª—è–Ω–∞", create_back_only_keyboard(), vk_session)
    return
   if not is_valid_point(info_location, info_point):
    send_message(user_id, f"‚ùå –¢–æ—á–∫–∞ {info_point} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ –ª–æ–∫–∞—Ü–∏–∏ {info_location}.", create_back_only_keyboard(), vk_session)
    return
   owner = get_territory_owner(info_location, info_point)
   player_faction = players[user_id]["faction"]
   if owner != player_faction:
    send_message(user_id, "‚ùå –≠—Ç–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –≤–∞—à–µ–π –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–µ.", create_back_only_keyboard(), vk_session)
    return
   squads_on_point = get_territory_squads(info_location, info_point)
   ptype = POINT_TYPES.get(info_point, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è")
   min_req = MIN_SQUADS_FOR_POINT.get(ptype, 1)
   send_message(user_id, f"üìç {info_location} {info_point}\nüë• –°–∫–≤–∞–¥–æ–≤: {squads_on_point}\nüè∑Ô∏è –¢–∏–ø: {ptype}\nüìã –ú–∏–Ω–∏–º—É–º –¥–ª—è —É–¥–µ—Ä–∂–∞–Ω–∏—è: {min_req}", create_back_only_keyboard(), vk_session)
   return
  parts = text.upper().split()
  if len(parts) != 2:
   send_message(user_id, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü—Ä–∏–º–µ—Ä: –ë1 5\n\nüí° –ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å —Å–∫–≤–∞–¥—ã –Ω–∞ —Å–≤–æ–µ–π —Ç–æ—á–∫–µ:\n–∏–Ω—Ñ–æ [–ª–æ–∫–∞—Ü–∏—è] [—Ç–æ—á–∫–∞]\n–ü—Ä–∏–º–µ—Ä: –∏–Ω—Ñ–æ –∫–æ—Ä–¥–æ–Ω –±1", create_back_only_keyboard(), vk_session)
   return
  point = parts[0]
  try:
   squad_count = int(parts[1])
  except:
   send_message(user_id, "‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º.", create_back_only_keyboard(), vk_session)
   return
  if squad_count <= 0:
   send_message(user_id, "‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∫–≤–∞–¥–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0.", create_back_only_keyboard(), vk_session)
   return
  p = players[user_id]
  location = p.get("pending_squad_location")
  action = p.get("squad_action", "send")
  border_points = p.get("pending_border_points")
  if not is_valid_point(location, point):
   send_message(user_id, "‚ùå –¢–∞–∫–æ–π —Ç–æ—á–∫–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.", create_back_only_keyboard(), vk_session)
   return
  if border_points is not None and point not in border_points:
   border_info = ", ".join(border_points)
   send_message(user_id, f"‚ùå –° –≤–∞—à–µ–π –ø–æ–∑–∏—Ü–∏–∏ –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∫–≤–∞–¥—ã —Ç–æ–ª—å–∫–æ –Ω–∞ –≥—Ä–∞–Ω–∏—á–∞—â–∏–µ —Ç–æ—á–∫–∏: {border_info}", create_back_only_keyboard(), vk_session)
   return
  if action == "withdraw":
   owner = get_territory_owner(location, point)
   if owner != p["faction"]:
    send_message(user_id, "‚ùå –í—ã –º–æ–∂–µ—Ç–µ –≤—ã–≤–æ–¥–∏—Ç—å —Å–∫–≤–∞–¥—ã —Ç–æ–ª—å–∫–æ —Å–æ —Å–≤–æ–∏—Ö —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π.", create_back_only_keyboard(), vk_session)
    return
   current_squads = get_territory_squads(location, point)
   ptype = POINT_TYPES.get(point, "–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è")
   min_squads = MIN_SQUADS_FOR_POINT.get(ptype, 1)
   available = current_squads - min_squads
   if squad_count > available:
    send_message(user_id, f"‚ùå –ú–æ–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ –º–∞–∫—Å–∏–º—É–º {available} —Å–∫–≤–∞–¥–æ–≤ (–Ω–∞ —Ç–æ—á–∫–µ {current_squads}, –º–∏–Ω–∏–º—É–º {min_squads}).", create_back_only_keyboard(), vk_session)
    return
   territory_control[location][point]["squads"] -= squad_count
   p["squads"] = p.get("squads", 0) + squad_count
   players[user_id]["state"] = STATE_WAR_MANAGE_SQUADS
   players[user_id]["pending_border_points"] = None
   save_data()
   send_message(user_id, f"‚úÖ –í—ã–≤–µ–¥–µ–Ω–æ {squad_count} —Å–∫–≤–∞–¥–æ–≤ —Å {location} {point}. –£ –≤–∞—Å —Ç–µ–ø–µ—Ä—å {p['squads']} —Å–∫–≤–∞–¥–æ–≤.", create_war_manage_keyboard(), vk_session)
   return
  if p.get("squads", 0) < squad_count:
   send_message(user_id, f"‚ùå –£ –≤–∞—Å —Ç–æ–ª—å–∫–æ {p.get('squads', 0)} —Å–∫–≤–∞–¥–æ–≤.", create_back_only_keyboard(), vk_session)
   return
  owner = get_territory_owner(location, point)
  if owner is None or owner == p["faction"]:
   result = process_attack(user_id, location, point, squad_count, False, vk_session)
   players[user_id]["state"] = STATE_WAR_MANAGE_SQUADS
   players[user_id]["pending_border_points"] = None
   save_data()
   send_message(user_id, result, create_war_manage_keyboard(), vk_session)
   return
  else:
   players[user_id]["pending_attack_point"] = point
   players[user_id]["pending_attack_squads"] = squad_count
   players[user_id]["state"] = STATE_WAR_ATTACK_CONFIRM
   save_data()
   enemy_squads = get_territory_squads(location, point)
   send_message(user_id, f"‚öîÔ∏è –ù–∞–ø–∞—Å—Ç—å –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é –∑–∞–Ω–∏–º–∞–µ–º—É—é {owner}?", create_attack_confirm_keyboard(), vk_session)
   return
  return
 if state == STATE_WAR_ATTACK_CONFIRM:
  p = players[user_id]
  location = p.get("pending_squad_location")
  point = p.get("pending_attack_point")
  squad_count = p.get("pending_attack_squads", 0)
  if text == "‚ùå –ù–µ—Ç":
   players[user_id]["state"] = STATE_WAR_MANAGE_SQUADS
   save_data()
   msg = f"üë®‚Äçüë®‚Äçüë¶‚Äçüë¶ –í–∞—à–∏ —Å–∫–≤–∞–¥—ã: {p.get('squads', 0)}\n–ö–∞–∫ —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –∏–º–∏ —Ä–∞—Å–ø–æ—Ä—è–¥–∏—Ç—å—Å—è?\n\nüí° –∏–Ω—Ñ–æ [–ª–æ–∫–∞—Ü–∏—è] [—Ç–æ—á–∫–∞] ‚Äî —É–∑–Ω–∞—Ç—å —Å–∫–≤–∞–¥—ã"
   send_message(user_id, msg, create_war_manage_keyboard(), vk_session)
   return
  elif text == "‚úÖ –î–∞":
   result = process_attack(user_id, location, point, squad_count, False, vk_session)
   players[user_id]["state"] = STATE_WAR_MANAGE_SQUADS
   save_data()
   send_message(user_id, result, create_war_manage_keyboard(), vk_session)
   return
  elif text == "‚öîÔ∏è –ù–∞–ø–∞—Å—Ç—å —Å–æ —Å–∫–≤–∞–¥–∞–º–∏":
   result = process_attack(user_id, location, point, squad_count, True, vk_session)
   players[user_id]["state"] = STATE_WAR_MANAGE_SQUADS
   save_data()
   send_message(user_id, result, create_war_manage_keyboard(), vk_session)
   return
  return
 if state == STATE_WAR_SHARED_SQUADS:
  p = players[user_id]
  faction = p["faction"]
  if text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = STATE_WAR_MANAGE_SQUADS
   save_data()
   msg = f"üë®‚Äçüë®‚Äçüë¶‚Äçüë¶ –í–∞—à–∏ —Å–∫–≤–∞–¥—ã: {p.get('squads', 0)}\n–ö–∞–∫ —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –∏–º–∏ —Ä–∞—Å–ø–æ—Ä—è–¥–∏—Ç—å—Å—è?\n\nüí° –∏–Ω—Ñ–æ [–ª–æ–∫–∞—Ü–∏—è] [—Ç–æ—á–∫–∞] ‚Äî —É–∑–Ω–∞—Ç—å —Å–∫–≤–∞–¥—ã"
   send_message(user_id, msg, create_war_manage_keyboard(), vk_session)
   return
  elif text == "üì• –ü–æ–ø–æ–ª–Ω–∏—Ç—å":
   send_message(user_id, "–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∫–≤–∞–¥–æ–≤ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –æ–±—â–∏—Ö:", create_back_only_keyboard(), vk_session)
   players[user_id]["shared_squad_action"] = "deposit"
   return
  elif text == "üì§ –í—ã–≤–µ—Å—Ç–∏":
   send_message(user_id, "–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∫–≤–∞–¥–æ–≤ –¥–ª—è –≤—ã–≤–æ–¥–∞ –∏–∑ –æ–±—â–∏—Ö:", create_back_only_keyboard(), vk_session)
   players[user_id]["shared_squad_action"] = "withdraw"
   return
  action = p.get("shared_squad_action")
  if action:
   try:
    count = int(text)
   except:
    send_message(user_id, "‚ùå –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ.", create_shared_squads_keyboard(), vk_session)
    return
   if action == "deposit":
    if p.get("squads", 0) < count:
     send_message(user_id, f"‚ùå –£ –≤–∞—Å —Ç–æ–ª—å–∫–æ {p.get('squads', 0)} —Å–∫–≤–∞–¥–æ–≤.", create_shared_squads_keyboard(), vk_session)
     return
    p["squads"] -= count
    faction_shared_squads[faction] = faction_shared_squads.get(faction, 0) + count
    save_data()
    send_message(user_id, f"‚úÖ –ü–æ–ø–æ–ª–Ω–µ–Ω–æ {count} —Å–∫–≤–∞–¥–æ–≤ –≤ –æ–±—â–∏–µ. –û–±—â–∏–µ —Å–∫–≤–∞–¥—ã: {faction_shared_squads[faction]}", create_shared_squads_keyboard(), vk_session)
   elif action == "withdraw":
    if faction_shared_squads.get(faction, 0) < count:
     send_message(user_id, f"‚ùå –í –æ–±—â–∏—Ö —Ç–æ–ª—å–∫–æ {faction_shared_squads.get(faction, 0)} —Å–∫–≤–∞–¥–æ–≤.", create_shared_squads_keyboard(), vk_session)
     return
    faction_shared_squads[faction] -= count
    p["squads"] = p.get("squads", 0) + count
    save_data()
    send_message(user_id, f"‚úÖ –í—ã–≤–µ–¥–µ–Ω–æ {count} —Å–∫–≤–∞–¥–æ–≤. –í–∞—à–∏ —Å–∫–≤–∞–¥—ã: {p['squads']}", create_shared_squads_keyboard(), vk_session)
   p["shared_squad_action"] = None
   return
  return
 if state == STATE_HUNTING:
  if text == "üèÉ –ü–æ–±–µ–≥":
   handle_hunting_escape(user_id, vk_session)
   return
  elif text.startswith("üéØ "):
   try:
    shot_num = int(text.split()[-1])
    if 1 <= shot_num <= 9:
     players[user_id]["state"] = STATE_HUNTING_SHOOTING
     players[user_id]["shot_button"] = shot_num
     save_data()
     handle_shooting(user_id, vk_session)
     return
   except ValueError:
    pass
   send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å –∏–ª–∏ —Å–±–µ–≥–∏—Ç–µ.", create_hunting_keyboard(), vk_session)
  else:
   send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å –∏–ª–∏ —Å–±–µ–≥–∏—Ç–µ.", create_hunting_keyboard(), vk_session)
  return
 if state == STATE_HUNTING_SHOOTING:
  players[user_id]["state"] = STATE_HUNTING
  save_data()
  if players[user_id].get("mutant_hp", 0) > 0:
   send_message(user_id, "–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –æ—Ö–æ—Ç—É:", create_hunting_keyboard(), vk_session)
   return
 if state == "zombie_control":
  if text == "‚öîÔ∏è –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –∑–∞—Ö–≤–∞—Ç":
   zombie_bot["mode"] = "aggressive"
   save_data()
   send_message(user_id, "‚úÖ –†–µ–∂–∏–º: –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –∑–∞—Ö–≤–∞—Ç\n–ë–æ—Ç –±—É–¥–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ –∞—Ç–∞–∫–æ–≤–∞—Ç—å.", create_zombie_control_keyboard(), vk_session)
   return
  elif text == "‚öñÔ∏è –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º":
   zombie_bot["mode"] = "normal"
   save_data()
   send_message(user_id, "‚úÖ –†–µ–∂–∏–º: –û–±—ã—á–Ω—ã–π\n–ë–æ—Ç –±—É–¥–µ—Ç —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è.", create_zombie_control_keyboard(), vk_session)
   return
  elif text == "üì¶ –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤":
   zombie_bot["mode"] = "loot"
   save_data()
   send_message(user_id, "‚úÖ –†–µ–∂–∏–º: –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤\n–ë–æ—Ç –±—É–¥–µ—Ç –ª—É—Ç–∞—Ç—å –∏ –∫–æ–ø–∏—Ç—å, –Ω–µ –∞—Ç–∞–∫—É—è.", create_zombie_control_keyboard(), vk_session)
   return
  elif text == "üéØ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç":
   send_message(user_id, "–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ: [–ª–æ–∫–∞—Ü–∏—è] [—Ç–æ—á–∫–∞]\n–ü—Ä–∏–º–µ—Ä: –ö–æ—Ä–¥–æ–Ω –ë1", create_back_only_keyboard(), vk_session)
   players[user_id]["state"] = "zombie_set_priority"
   save_data()
   return
  elif text == "‚ùå –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç":
   zombie_bot["priority_target"] = None
   save_data()
   send_message(user_id, "‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è —Ü–µ–ª—å —Å–±—Ä–æ—à–µ–Ω–∞.", create_zombie_control_keyboard(), vk_session)
   return
  elif text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = STATE_IN_MENU
   save_data()
   send_message(user_id, MAIN_MENU_TEXT, create_main_menu_keyboard(user_id), vk_session)
   return
  return
 if state == "zombie_set_priority":
  if text == "üîö –ù–∞–∑–∞–¥":
   players[user_id]["state"] = "zombie_control"
   save_data()
   send_message(user_id, "üßü –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–æ–º–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏:", create_zombie_control_keyboard(), vk_session)
   return
  parts = text.split()
  if len(parts) < 2:
   send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: [–ª–æ–∫–∞—Ü–∏—è] [—Ç–æ—á–∫–∞]\n–ü—Ä–∏–º–µ—Ä: –ö–æ—Ä–¥–æ–Ω –ë1", create_back_only_keyboard(), vk_session)
   return
  point = parts[-1].upper()
  loc_input = " ".join(parts[:-1]).lower()
  location_map = {"–∫–æ—Ä–¥–æ–Ω": "–ö–æ—Ä–¥–æ–Ω", "—Å–≤–∞–ª–∫–∞": "–°–≤–∞–ª–∫–∞", "—Ç—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞": "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "—Ç–µ–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞": "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "—Ç–¥": "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "–ø–æ–ª—è–Ω–∞": "–ü–æ–ª—è–Ω–∞"}
  location = location_map.get(loc_input)
  if not location:
   send_message(user_id, "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è.", create_back_only_keyboard(), vk_session)
   return
  if not is_valid_point(location, point):
   send_message(user_id, f"‚ùå –¢–æ—á–∫–∞ {point} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.", create_back_only_keyboard(), vk_session)
   return
  zombie_bot["priority_target"] = (location, point)
  players[user_id]["state"] = "zombie_control"
  save_data()
  send_message(user_id, f"‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è —Ü–µ–ª—å: {location} {point}", create_zombie_control_keyboard(), vk_session)
  return
 if state == STATE_WAITING_QUOTE_PHOTO:
  p = players[user_id]
  quote_data = p.get("pending_quote")
  if not quote_data:
   players[user_id]["state"] = STATE_IN_MENU
   save_data()
   send_message(user_id, "‚ùå –î–∞–Ω–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã –ø–æ—Ç–µ—Ä—è–Ω—ã.", create_main_menu_keyboard(user_id), vk_session)
   return
  if text.lower() == "–Ω–µ—Ç":
   background_img = None
  else:
   send_message(user_id, "‚ùå –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –¥–ª—è —Ñ–æ–Ω–∞ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ ¬´–Ω–µ—Ç¬ª –¥–ª—è —á—ë—Ä–Ω–æ–≥–æ —Ñ–æ–Ω–∞.", None, vk_session)
   return
  quote_text = quote_data.get("text", "")
  quote_user_id = quote_data.get("user_id")
  quote_date = quote_data.get("date", "")
  try:
   user_info = vk_session.method("users.get", {"user_ids": quote_user_id, "fields": "first_name"})[0]
   user_name = user_info.get("first_name", "–ê–Ω–æ–Ω–∏–º")
  except:
   user_name = "–ê–Ω–æ–Ω–∏–º"
  avatar_img = get_user_avatar(quote_user_id, vk_session)
  img_buffer = generate_quote_image(quote_text, user_name, avatar_img, quote_date, background_img)
  try:
   upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
   response = vk_session.http.post(upload_url, files={"photo": ("quote.png", img_buffer, "image/png")})
   result = response.json()
   photo_data = vk_session.method("photos.saveMessagesPhoto", {"photo": result["photo"], "server": result["server"], "hash": result["hash"]})[0]
   vk_session.method("messages.send", {"user_id": user_id, "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}", "random_id": 0, "message": "üñº –í–∞—à–∞ —Ü–∏—Ç–∞—Ç–∞ –≥–æ—Ç–æ–≤–∞!"})
  except Exception as e:
   logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ü–∏—Ç–∞—Ç—ã: {e}")
   send_message(user_id, "‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ü–∏—Ç–∞—Ç—ã.", None, vk_session)
  players[user_id]["state"] = STATE_IN_MENU
  players[user_id].pop("pending_quote", None)
  save_data()
  return
def handle_chat_message(event, vk_session):
    message = event.obj.message
    user_id = message['from_id']
    if user_id in banned_users:
        return
    text = message.get('text', '').strip()
    peer_id = message['peer_id']
    if not text:
        return
    if user_id not in players:
        return
    reply_user_id = None
    if 'reply_message' in message and message['reply_message']:
        reply_user_id = message['reply_message'].get('from_id')
        if reply_user_id and reply_user_id not in players:
            reply_user_id = None
    text_lower = text.lower()
    words = text.split()
    words_lower = text_lower.split()
    if not words:
        return
    if words_lower[0] == "–ø–µ—Ä–µ–≤–µ—Å—Ç–∏":
        if reply_user_id and len(words) >= 2:
            try:
                amount = int(words[1])
            except:
                send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ [—Å—É–º–º–∞] (–æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)", None, vk_session, peer_id)
                return
            target_uid = reply_user_id
        elif len(words) >= 3:
            try:
                amount = int(words[1])
                target_str = " ".join(words[2:])
            except:
                send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ [—Å—É–º–º–∞] [–Ω–∏–∫]", None, vk_session, peer_id)
                return
            target_uid = find_player_by_mention_or_nickname(target_str, vk_session)
        else:
            send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ [—Å—É–º–º–∞] [–Ω–∏–∫] –∏–ª–∏ –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ", None, vk_session, peer_id)
            return
        if amount <= 0:
            send_message(user_id, "‚ùå –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0.", None, vk_session, peer_id)
            return
        if not target_uid:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session, peer_id)
            return
        if target_uid == user_id:
            send_message(user_id, "‚ùå –ù–µ–ª—å–∑—è –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å–µ–±–µ.", None, vk_session, peer_id)
            return
        if target_uid in banned_users:
            send_message(user_id, "‚ùå –≠—Ç–æ—Ç –∏–≥—Ä–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.", None, vk_session, peer_id)
            return
        if players[user_id]["money"] < amount:
            send_message(user_id, f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥. –£ –≤–∞—Å {players[user_id]['money']}—Ä.", None, vk_session, peer_id)
            return
        players[user_id]["money"] -= amount
        players[target_uid]["money"] = players[target_uid].get("money", 0) + amount
        sender_nickname = players[user_id]["nickname"]
        save_data()
        send_message(user_id, f"‚úÖ –ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ {amount}—Ä –∏–≥—Ä–æ–∫—É {players[target_uid]['nickname']}.", None, vk_session, peer_id)
        send_message(target_uid, f"üì• –í–∞–º –ø–µ—Ä–µ–≤—ë–ª(–∞) {sender_nickname}: {amount}—Ä", None, vk_session)
        return
    if words_lower[0] == "–æ—Ç–ø—Ä–∞–≤–∏—Ç—å":
        if reply_user_id and len(words) >= 3:
            try:
                amount = int(words[-1])
                item_name_original = " ".join(words[1:-1])
            except:
                send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å [–ø—Ä–µ–¥–º–µ—Ç] [–∫–æ–ª-–≤–æ] (–æ—Ç–≤–µ—Ç–æ–º)", None, vk_session, peer_id)
                return
            target_uid = reply_user_id
        elif len(words) >= 4:
            item_parts = []
            amount = None
            target_str = None
            for i in range(len(words) - 1, 0, -1):
                if target_str is None:
                    target_str = words[i]
                elif amount is None:
                    try:
                        amount = int(words[i])
                    except:
                        send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å [–ø—Ä–µ–¥–º–µ—Ç] [–∫–æ–ª-–≤–æ] [–Ω–∏–∫]", None, vk_session, peer_id)
                        return
                else:
                    item_parts = words[1:i+1]
                    break
            if not item_parts or amount is None or target_str is None:
                send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å [–ø—Ä–µ–¥–º–µ—Ç] [–∫–æ–ª-–≤–æ] [–Ω–∏–∫]", None, vk_session, peer_id)
                return
            item_name_original = " ".join(item_parts)
            target_uid = find_player_by_mention_or_nickname(target_str, vk_session)
        else:
            send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å [–ø—Ä–µ–¥–º–µ—Ç] [–∫–æ–ª-–≤–æ] [–Ω–∏–∫] –∏–ª–∏ –æ—Ç–≤–µ—Ç–æ–º", None, vk_session, peer_id)
            return
        if not target_uid:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session, peer_id)
            return
        if target_uid == user_id:
            send_message(user_id, "‚ùå –ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–µ–±–µ.", None, vk_session, peer_id)
            return
        found_item = None
        for item in ITEM_EFFECTS.keys():
            if item.lower() == item_name_original.lower():
                found_item = item
                break
        if not found_item:
            for art in ALL_ARTIFACTS:
                if art.lower() == item_name_original.lower():
                    found_item = art
                    break
        if not found_item:
            send_message(user_id, "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç.", None, vk_session, peer_id)
            return
        backpack = players[user_id]["backpack"]
        current_count = backpack.get(found_item, 0)
        if current_count < amount:
            send_message(user_id, f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤. –ï—Å—Ç—å: {current_count}.", None, vk_session, peer_id)
            return
        backpack[found_item] -= amount
        if backpack[found_item] <= 0:
            del backpack[found_item]
        players[target_uid]["backpack"][found_item] = players[target_uid]["backpack"].get(found_item, 0) + amount
        sender_nickname = players[user_id]["nickname"]
        save_data()
        send_message(user_id, f"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {found_item} x{amount} –∏–≥—Ä–æ–∫—É {players[target_uid]['nickname']}.", None, vk_session, peer_id)
        send_message(target_uid, f"üì• –í–∞–º –æ—Ç–ø—Ä–∞–≤–∏–ª(–∞) {sender_nickname}: {found_item} x{amount}", None, vk_session)
        return
    if not is_admin(user_id):
        return
    if text_lower == "/–±–æ–≥":
        p = players[user_id]
        p["money"] += 1000
        p["health"] = 10
        p["radiation"] = 0
        p["hunger"] = 0
        p["stamina"] = 10
        save_data()
        send_message(user_id, "‚úÖ –í—ã –ø–æ–ª—É—á–∏–ª–∏ 1000—Ä –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –≤—Å–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏.", None, vk_session, peer_id)
        return
    if text_lower.startswith("/–ª–∏–¥–µ—Ä "):
        if reply_user_id and len(words) == 1:
            target_uid = reply_user_id
        else:
            parts = text.split(maxsplit=1)
            if len(parts) < 2:
                send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–∏–∫ –∏–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ.", None, vk_session, peer_id)
                return
            target_uid = find_player_by_mention_or_nickname(parts[1].strip(), vk_session)
        if not target_uid:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session, peer_id)
            return
        target_faction = players[target_uid]["faction"]
        set_faction_leader(target_faction, target_uid)
        send_message(user_id, f"‚úÖ {players[target_uid]['nickname']} –Ω–∞–∑–Ω–∞—á–µ–Ω –ª–∏–¥–µ—Ä–æ–º {target_faction}.", None, vk_session, peer_id)
        send_message(target_uid, f"üëë –í—ã –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –ª–∏–¥–µ—Ä–æ–º –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ {target_faction}!", None, vk_session)
        return
    if text_lower.startswith("/–ª–∏–¥–µ—Ä") and reply_user_id:
        target_uid = reply_user_id
        target_faction = players[target_uid]["faction"]
        set_faction_leader(target_faction, target_uid)
        send_message(user_id, f"‚úÖ {players[target_uid]['nickname']} –Ω–∞–∑–Ω–∞—á–µ–Ω –ª–∏–¥–µ—Ä–æ–º {target_faction}.", None, vk_session, peer_id)
        send_message(target_uid, f"üëë –í—ã –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –ª–∏–¥–µ—Ä–æ–º –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ {target_faction}!", None, vk_session)
        return
    if text_lower.startswith("/–≥–∏–≤ "):
        parts = text.split()
        if reply_user_id and len(parts) >= 3:
            try:
                count = int(parts[-1])
                item_name = " ".join(parts[1:-1]).lower()
                target_uid = reply_user_id
            except:
                send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: /–≥–∏–≤ [–ø—Ä–µ–¥–º–µ—Ç] [–∫–æ–ª-–≤–æ] (–æ—Ç–≤–µ—Ç–æ–º)", None, vk_session, peer_id)
                return
        elif len(parts) >= 3:
            target_uid = None
            count = None
            item_end_index = len(parts)
            for i in range(len(parts) - 1, 1, -1):
                potential_nick = " ".join(parts[i:])
                found_uid = find_player_by_mention_or_nickname(potential_nick, vk_session)
                if found_uid:
                    target_uid = found_uid
                    try:
                        count = int(parts[i - 1])
                        item_end_index = i - 1
                        break
                    except:
                        continue
            if target_uid is None:
                try:
                    count = int(parts[-1])
                    item_end_index = len(parts) - 1
                    target_uid = user_id
                except:
                    send_message(user_id, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.", None, vk_session, peer_id)
                    return
            item_name = " ".join(parts[1:item_end_index]).lower()
        else:
            send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: /–≥–∏–≤ [–ø—Ä–µ–¥–º–µ—Ç] [–∫–æ–ª-–≤–æ] [–Ω–∏–∫]", None, vk_session, peer_id)
            return
        if count is None or count <= 0:
            send_message(user_id, "‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º.", None, vk_session, peer_id)
            return
        if item_name == "–¥–µ–Ω—å–≥–∏":
            players[target_uid]["money"] = players[target_uid].get("money", 0) + count
            save_data()
            send_message(user_id, f"‚úÖ –í—ã–¥–∞–Ω–æ {count}—Ä –∏–≥—Ä–æ–∫—É {players[target_uid]['nickname']}.", None, vk_session, peer_id)
            return
        found_item = None
        for item in ITEM_EFFECTS.keys():
            if item.lower() == item_name:
                found_item = item
                break
        if not found_item:
            for art in ALL_ARTIFACTS:
                if art.lower() == item_name:
                    found_item = art
                    break
        if not found_item:
            send_message(user_id, "‚ùå –ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session, peer_id)
            return
        players[target_uid]["backpack"][found_item] = players[target_uid]["backpack"].get(found_item, 0) + count
        save_data()
        send_message(user_id, f"‚úÖ –í—ã–¥–∞–Ω–æ {found_item} x{count} –∏–≥—Ä–æ–∫—É {players[target_uid]['nickname']}.", None, vk_session, peer_id)
        return
    if text_lower.startswith("/–¥—ç–ª "):
        parts = text.split()
        if reply_user_id and len(parts) >= 3:
            try:
                count = int(parts[-1])
                item_name = " ".join(parts[1:-1]).lower()
                target_uid = reply_user_id
            except:
                send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: /–¥—ç–ª [–ø—Ä–µ–¥–º–µ—Ç] [–∫–æ–ª-–≤–æ] (–æ—Ç–≤–µ—Ç–æ–º)", None, vk_session, peer_id)
                return
        elif len(parts) >= 3:
            target_uid = None
            count = None
            item_end_index = len(parts)
            for i in range(len(parts) - 1, 1, -1):
                potential_nick = " ".join(parts[i:])
                found_uid = find_player_by_mention_or_nickname(potential_nick, vk_session)
                if found_uid:
                    target_uid = found_uid
                    try:
                        count = int(parts[i - 1])
                        item_end_index = i - 1
                        break
                    except:
                        continue
            if target_uid is None:
                try:
                    count = int(parts[-1])
                    item_end_index = len(parts) - 1
                    target_uid = user_id
                except:
                    send_message(user_id, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.", None, vk_session, peer_id)
                    return
            item_name = " ".join(parts[1:item_end_index]).lower()
        else:
            send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: /–¥—ç–ª [–ø—Ä–µ–¥–º–µ—Ç] [–∫–æ–ª-–≤–æ] [–Ω–∏–∫]", None, vk_session, peer_id)
            return
        if count is None or count <= 0:
            send_message(user_id, "‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º.", None, vk_session, peer_id)
            return
        if item_name == "–¥–µ–Ω—å–≥–∏":
            players[target_uid]["money"] = max(0, players[target_uid].get("money", 0) - count)
            save_data()
            send_message(user_id, f"‚úÖ –£–¥–∞–ª–µ–Ω–æ {count}—Ä —É –∏–≥—Ä–æ–∫–∞ {players[target_uid]['nickname']}.", None, vk_session, peer_id)
            return
        found_item = None
        for item in ITEM_EFFECTS.keys():
            if item.lower() == item_name:
                found_item = item
                break
        if not found_item:
            for art in ALL_ARTIFACTS:
                if art.lower() == item_name:
                    found_item = art
                    break
        if not found_item:
            send_message(user_id, "‚ùå –ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session, peer_id)
            return
        current = players[target_uid]["backpack"].get(found_item, 0)
        players[target_uid]["backpack"][found_item] = max(0, current - count)
        if players[target_uid]["backpack"][found_item] <= 0:
            del players[target_uid]["backpack"][found_item]
        save_data()
        send_message(user_id, f"‚úÖ –£–¥–∞–ª–µ–Ω–æ {found_item} x{count} —É –∏–≥—Ä–æ–∫–∞ {players[target_uid]['nickname']}.", None, vk_session, peer_id)
        return
    if text_lower.startswith("/—Å–µ—Ç"):
        if reply_user_id and len(words) == 1:
            target_uid = reply_user_id
        elif len(words) >= 2:
            target_uid = find_player_by_mention_or_nickname(" ".join(words[1:]), vk_session)
        else:
            send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–∏–∫ –∏–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ.", None, vk_session, peer_id)
            return
        if not target_uid:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session, peer_id)
            return
        all_items = list(ITEM_EFFECTS.keys()) + ALL_ARTIFACTS
        for item in all_items:
            players[target_uid]["backpack"][item] = players[target_uid]["backpack"].get(item, 0) + 1
        save_data()
        send_message(user_id, f"‚úÖ –ò–≥—Ä–æ–∫—É {players[target_uid]['nickname']} –≤—ã–¥–∞–Ω—ã –≤—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã.", None, vk_session, peer_id)
        return
    if text_lower == "/–≤—ã–±—Ä–æ—Å":
        global emission_counter
        emission_counter = 284
        save_data()
        send_message(user_id, "‚úÖ –®–∫–∞–ª–∞ –≤—ã–±—Ä–æ—Å–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ 284.", None, vk_session, peer_id)
        return
    if text_lower.startswith("/–¥–æ–Ω–∞—Ç "):
        parts = text.split()
        if len(parts) < 3:
            send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: /–¥–æ–Ω–∞—Ç [–¥–µ–Ω—å/–Ω–µ–¥–µ–ª—è/–º–µ—Å—è—Ü] [–ø–æ–Ω—á–∏–∫/—Å—Ç–µ–π–∫] [–Ω–∏–∫]", None, vk_session, peer_id)
            return
        duration_str = parts[1].lower()
        if duration_str not in DONATION_DURATIONS:
            send_message(user_id, "‚ùå –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –¥–µ–Ω—å, –Ω–µ–¥–µ–ª—è, –º–µ—Å—è—Ü", None, vk_session, peer_id)
            return
        artifact_input = parts[2].lower()
        artifact = None
        for art in DONATION_ARTIFACTS:
            if art.lower() == artifact_input:
                artifact = art
                break
        if not artifact:
            send_message(user_id, "‚ùå –ê—Ä—Ç–µ—Ñ–∞–∫—Ç: –ü–æ–Ω—á–∏–∫, –°—Ç–µ–π–∫", None, vk_session, peer_id)
            return
        if reply_user_id and len(parts) == 3:
            target_uid = reply_user_id
        elif len(parts) >= 4:
            target_uid = find_player_by_mention_or_nickname(parts[3].strip(), vk_session)
        else:
            target_uid = user_id
        if not target_uid:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session, peer_id)
            return
        duration = DONATION_DURATIONS[duration_str]
        p = players[target_uid]
        p["donation_end_time"] = time.time() + duration
        p["donation_artifact"] = artifact
        p["backpack"][artifact] = p["backpack"].get(artifact, 0) + 1
        save_data()
        end_time_str = time.strftime('%d.%m.%Y %H:%M', time.localtime(p["donation_end_time"]))
        send_message(user_id, f"‚úÖ –î–æ–Ω–∞—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –∏–≥—Ä–æ–∫—É {players[target_uid]['nickname']} –Ω–∞ {duration_str}!\nüéÅ {artifact}\n‚è∞ –î–æ: {end_time_str}", None, vk_session, peer_id)
        if target_uid != user_id:
            send_message(target_uid, f"üéÅ –î–æ–Ω–∞—Ç –Ω–∞ {duration_str}!\nüåï {artifact}\n‚è∞ –î–æ: {end_time_str}", None, vk_session)
        return
    if text_lower == "/–∫–æ–º–∞–Ω–¥—ã":
        faction_info = "üë• –ì–†–£–ü–ü–ò–†–û–í–ö–ò:\n"
        for faction in ["üõ°Ô∏è –î–æ–ª–≥", "‚ò¶Ô∏è –ì—Ä–µ—Ö", "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏"]:
            current = len(factions.get(faction, []))
            limit = MAX_FACTION_SIZES.get(faction, 5)
            faction_info += f"{faction}: {current}/{limit}\n"
        admin_help = f"üìã –ê–î–ú–ò–ù –ö–û–ú–ê–ù–î–´:\n\n{faction_info}\n/–±–æ–≥\n/–ª–∏–¥–µ—Ä [–Ω–∏–∫]\n/—Å–µ—Ç [–Ω–∏–∫]\n/–≥–∏–≤ [–ø—Ä–µ–¥–º–µ—Ç] [–∫–æ–ª-–≤–æ] [–Ω–∏–∫]\n/–¥—ç–ª [–ø—Ä–µ–¥–º–µ—Ç] [–∫–æ–ª-–≤–æ] [–Ω–∏–∫]\n/–≤—ã–±—Ä–æ—Å\n/–¥–æ–Ω–∞—Ç [–¥–µ–Ω—å/–Ω–µ–¥–µ–ª—è/–º–µ—Å—è—Ü] [–∞—Ä—Ç–µ—Ñ–∞–∫—Ç] [–Ω–∏–∫]\n/–ª–∏–º–∏—Ç [–≥–ø] [—á–∏—Å–ª–æ]\n/—Å–º–µ–Ω–∏—Ç—å–≥–ø [–Ω–∏–∫] [–≥–ø]\n/—Ç–µ–ª–µ–ø–æ—Ä—Ç [–Ω–∏–∫] [–ª–æ–∫–∞—Ü–∏—è] [—Ç–æ—á–∫–∞]\n/–Ω–∏–∫ [—Å—Ç–∞—Ä—ã–π] [–Ω–æ–≤—ã–π]\n/–±–∞–Ω [–Ω–∏–∫] [–ø—Ä–∏—á–∏–Ω–∞]\n/—Ä–∞–∑–±–∞–Ω [–Ω–∏–∫]\n/skip_cd\n\nüí° –ú–æ–∂–Ω–æ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –Ω–∏–∫–∞"
        send_message(user_id, admin_help, None, vk_session, peer_id)
        return
    if text_lower.startswith("/–ª–∏–º–∏—Ç "):
        parts = text.split()
        if len(parts) < 3:
            send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: /–ª–∏–º–∏—Ç [–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞] [—á–∏—Å–ª–æ]", None, vk_session, peer_id)
            return
        faction_input = parts[1].lower()
        try:
            new_limit = int(parts[2])
        except:
            send_message(user_id, "‚ùå –õ–∏–º–∏—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.", None, vk_session, peer_id)
            return
        if new_limit < 1 or new_limit > 50:
            send_message(user_id, "‚ùå –õ–∏–º–∏—Ç –æ—Ç 1 –¥–æ 50.", None, vk_session, peer_id)
            return
        faction_map = {"–¥–æ–ª–≥": "üõ°Ô∏è –î–æ–ª–≥", "–≥—Ä–µ—Ö": "‚ò¶Ô∏è –ì—Ä–µ—Ö", "–æ–¥–∏–Ω–æ—á–∫–∏": "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏"}
        if faction_input not in faction_map:
            send_message(user_id, "‚ùå –ì–ü: –¥–æ–ª–≥, –≥—Ä–µ—Ö, –æ–¥–∏–Ω–æ—á–∫–∏", None, vk_session, peer_id)
            return
        faction_name = faction_map[faction_input]
        MAX_FACTION_SIZES[faction_name] = new_limit
        save_data()
        send_message(user_id, f"‚úÖ –õ–∏–º–∏—Ç {faction_name} ‚Üí {new_limit}.", None, vk_session, peer_id)
        return
    if text_lower.startswith("/—Å–º–µ–Ω–∏—Ç—å–≥–ø"):
        parts = text.split()
        if reply_user_id and reply_user_id in players and len(parts) == 2:
            target_uid = reply_user_id
            faction_input = parts[1].lower()
        elif len(parts) >= 3:
            target_nick = " ".join(parts[1:-1])
            faction_input = parts[-1].lower()
            target_uid = find_player_by_mention_or_nickname(target_nick, vk_session)
        else:
            send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: /—Å–º–µ–Ω–∏—Ç—å–≥–ø [–Ω–∏–∫] [–≥–ø] –∏–ª–∏ –æ—Ç–≤–µ—Ç–æ–º: /—Å–º–µ–Ω–∏—Ç—å–≥–ø [–≥–ø]", None, vk_session, peer_id)
            return
        if not target_uid:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session, peer_id)
            return
        faction_map = {"–¥–æ–ª–≥": "üõ°Ô∏è –î–æ–ª–≥", "–≥—Ä–µ—Ö": "‚ò¶Ô∏è –ì—Ä–µ—Ö", "–æ–¥–∏–Ω–æ—á–∫–∏": "‚ò¢Ô∏è –û–¥–∏–Ω–æ—á–∫–∏", "–∑–æ–º–±–∏": ZOMBIE_FACTION, "–∑–æ–º–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ": ZOMBIE_FACTION}
        if faction_input not in faction_map:
            send_message(user_id, "‚ùå –ì–ü: –¥–æ–ª–≥, –≥—Ä–µ—Ö, –æ–¥–∏–Ω–æ—á–∫–∏, –∑–æ–º–±–∏", None, vk_session, peer_id)
            return
        new_faction = faction_map[faction_input]
        old_faction = players[target_uid].get("faction")
        if old_faction and target_uid in factions.get(old_faction, []):
            factions[old_faction].remove(target_uid)
        players[target_uid]["faction"] = new_faction
        if new_faction not in factions:
            factions[new_faction] = []
        if target_uid not in factions[new_faction]:
            factions[new_faction].append(target_uid)
        save_data()
        send_message(user_id, f"‚úÖ {players[target_uid]['nickname']} ‚Üí {new_faction}.", None, vk_session, peer_id)
        send_message(target_uid, f"‚ö†Ô∏è –í–∞—Å –ø–µ—Ä–µ–≤–µ–ª–∏ –≤ {new_faction}!", None, vk_session)
        return
    if text_lower.startswith("/—Ç–µ–ª–µ–ø–æ—Ä—Ç "):
        parts = text.split()
        if reply_user_id and len(parts) >= 3:
            target_uid = reply_user_id
            point = parts[-1].upper()
            location_input = " ".join(parts[1:-1]).lower()
        elif len(parts) >= 4:
            target_uid = find_player_by_mention_or_nickname(parts[1], vk_session)
            point = parts[-1].upper()
            location_input = " ".join(parts[2:-1]).lower()
        else:
            send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç: /—Ç–µ–ª–µ–ø–æ—Ä—Ç [–Ω–∏–∫] [–ª–æ–∫–∞—Ü–∏—è] [—Ç–æ—á–∫–∞]", None, vk_session, peer_id)
            return
        if not target_uid:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session, peer_id)
            return
        location_map = {"–∫–æ—Ä–¥–æ–Ω": "–ö–æ—Ä–¥–æ–Ω", "—Å–≤–∞–ª–∫–∞": "–°–≤–∞–ª–∫–∞", "—Ç—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞": "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "—Ç–µ–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞": "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "—Ç–¥": "–¢—ë–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "–ø–æ–ª—è–Ω–∞": "–ü–æ–ª—è–Ω–∞"}
        location = location_map.get(location_input)
        if not location:
            send_message(user_id, "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è.", None, vk_session, peer_id)
            return
        if not is_valid_point(location, point):
            send_message(user_id, f"‚ùå –¢–æ—á–∫–∞ {point} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.", None, vk_session, peer_id)
            return
        players[target_uid]["location"] = location
        players[target_uid]["point"] = point
        players[target_uid]["transition_end_time"] = None
        if players[target_uid].get("state") == STATE_TRANSITION_WAIT:
            players[target_uid]["state"] = STATE_IN_MENU
        save_data()
        send_message(user_id, f"‚úÖ {players[target_uid]['nickname']} ‚Üí {location} {point}.", None, vk_session, peer_id)
        send_message(target_uid, f"‚ö° –í–∞—Å —Ç–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∏ –Ω–∞ {location} {point}!", None, vk_session)
        return
    if text_lower.startswith("/–Ω–∏–∫ "):
     content = text[5:].strip()
     if " > " in content:
        parts = content.split(" > ", 1)
        old_nick = parts[0].strip()
        new_nick = parts[1].strip()
        
        target_uid = None
        for uid, data in players.items():
            if data.get("nickname", "").lower() == old_nick.lower():
                target_uid = uid
                break
        
        if not target_uid:
            for uid, data in players.items():
                if old_nick.lower() in data.get("nickname", "").lower():
                    target_uid = uid
                    break
        if not target_uid:
            send_message(user_id, f"‚ùå –ò–≥—Ä–æ–∫ '{old_nick}' –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session, peer_id)
            return
        old_nickname = players[target_uid]["nickname"]
        players[target_uid]["nickname"] = new_nick
        save_data()
        send_message(user_id, f"‚úÖ {old_nickname} ‚Üí {new_nick}", None, vk_session, peer_id)
        send_message(target_uid, f"üìù –í–∞—à –Ω–∏–∫ –∏–∑–º–µ–Ω—ë–Ω –Ω–∞: {new_nick}", None, vk_session)
        return
     if reply_user_id and reply_user_id in players:
        new_nick = content
        if not new_nick:
            send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–æ–≤—ã–π –Ω–∏–∫.", None, vk_session, peer_id)
            return
        old_nickname = players[reply_user_id]["nickname"]
        players[reply_user_id]["nickname"] = new_nick
        save_data()
        send_message(user_id, f"‚úÖ {old_nickname} ‚Üí {new_nick}", None, vk_session, peer_id)
        send_message(reply_user_id, f"üìù –í–∞—à –Ω–∏–∫ –∏–∑–º–µ–Ω—ë–Ω –Ω–∞: {new_nick}", None, vk_session)
        return
     send_message(user_id, "‚ùå –§–æ—Ä–º–∞—Ç:\n/–Ω–∏–∫ —Å—Ç–∞—Ä—ã–π > –Ω–æ–≤—ã–π\n–∏–ª–∏ –æ—Ç–≤–µ—Ç–æ–º: /–Ω–∏–∫ –Ω–æ–≤—ã–π", None, vk_session, peer_id)
     return
    if text_lower.startswith("/–±–∞–Ω "):
        content = text[5:].strip()
        if not content:
            send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–∏–∫.", None, vk_session, peer_id)
            return
        if reply_user_id:
            target_uid = reply_user_id
            reason = content if content else "–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"
        else:
            parts = content.split(maxsplit=1)
            target_uid = find_player_by_mention_or_nickname(parts[0], vk_session)
            reason = parts[1] if len(parts) > 1 else "–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"
        if not target_uid:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session, peer_id)
            return
        if target_uid == user_id:
            send_message(user_id, "‚ùå –ù–µ–ª—å–∑—è –∑–∞–±–∞–Ω–∏—Ç—å —Å–µ–±—è.", None, vk_session, peer_id)
            return
        if target_uid == 353430025:
            send_message(user_id, "‚ùå –ù–µ–ª—å–∑—è –∑–∞–±–∞–Ω–∏—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞.", None, vk_session, peer_id)
            return
        if target_uid in banned_users:
            send_message(user_id, "‚ùå –£–∂–µ –∑–∞–±–∞–Ω–µ–Ω.", None, vk_session, peer_id)
            return
        banned_users[target_uid] = reason
        save_data()
        send_message(user_id, f"‚úÖ {players[target_uid]['nickname']} –∑–∞–±–∞–Ω–µ–Ω.\nüìù {reason}", None, vk_session, peer_id)
        send_message(target_uid, f"üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.\nüìù {reason}", None, vk_session)
        return
    if text_lower.startswith("/—Ä–∞–∑–±–∞–Ω"):
        if reply_user_id and len(words) == 1:
            target_uid = reply_user_id
        elif len(words) >= 2:
            target_uid = find_player_by_mention_or_nickname(" ".join(words[1:]), vk_session)
        else:
            send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–∏–∫ –∏–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ.", None, vk_session, peer_id)
            return
        if not target_uid:
            send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session, peer_id)
            return
        if target_uid not in banned_users:
            send_message(user_id, "‚ùå –ù–µ –∑–∞–±–∞–Ω–µ–Ω.", None, vk_session, peer_id)
            return
        del banned_users[target_uid]
        save_data()
        send_message(user_id, f"‚úÖ {players[target_uid]['nickname']} —Ä–∞–∑–±–∞–Ω–µ–Ω.", None, vk_session, peer_id)
        send_message(target_uid, "‚úÖ –í—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.", None, vk_session)
        return
    if text_lower == "/skip_cd":
        if user_id in players and players[user_id].get("state") == STATE_TRANSITION_WAIT:
            players[user_id]["state"] = STATE_IN_MENU
            players[user_id]["transition_end_time"] = None
            save_data()
            send_message(user_id, "‚è±Ô∏è –¢–∞–π–º–µ—Ä —Å–±—Ä–æ—à–µ–Ω.", None, vk_session, peer_id)
        else:
            send_message(user_id, "–í—ã –Ω–µ –≤ –ø–µ—Ä–µ—Ö–æ–¥–µ.", None, vk_session, peer_id)
        return
    if user_id == 353430025:
        if text_lower.startswith("/–∞–¥–º–∏–Ω"):
            if reply_user_id and len(words) == 1:
                target_uid = reply_user_id
            elif len(words) >= 2:
                target_uid = find_player_by_mention_or_nickname(" ".join(words[1:]), vk_session)
            else:
                send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–∏–∫ –∏–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ.", None, vk_session, peer_id)
                return
            if not target_uid:
                send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session, peer_id)
                return
            if target_uid == user_id:
                send_message(user_id, "‚ùå –í—ã —É–∂–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫.", None, vk_session, peer_id)
                return
            if target_uid in admin_users:
                send_message(user_id, "‚ùå –£–∂–µ –∞–¥–º–∏–Ω.", None, vk_session, peer_id)
                return
            admin_users.append(target_uid)
            save_data()
            send_message(user_id, f"‚úÖ {players[target_uid]['nickname']} ‚Äî –∞–¥–º–∏–Ω.", None, vk_session, peer_id)
            send_message(target_uid, "üëë –í—ã –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –∞–¥–º–∏–Ω–æ–º!", None, vk_session)
            return
        if text_lower.startswith("/–¥–µ–ª–∞–¥–º–∏–Ω"):
            if reply_user_id and len(words) == 1:
                target_uid = reply_user_id
            elif len(words) >= 2:
                target_uid = find_player_by_mention_or_nickname(" ".join(words[1:]), vk_session)
            else:
                send_message(user_id, "‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–∏–∫ –∏–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ.", None, vk_session, peer_id)
                return
            if not target_uid:
                send_message(user_id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", None, vk_session, peer_id)
                return
            if target_uid not in admin_users:
                send_message(user_id, "‚ùå –ù–µ –∞–¥–º–∏–Ω.", None, vk_session, peer_id)
                return
            admin_users.remove(target_uid)
            save_data()
            send_message(user_id, f"‚úÖ {players[target_uid]['nickname']} —Å–Ω—è—Ç —Å –∞–¥–º–∏–Ω–∫–∏.", None, vk_session, peer_id)
            send_message(target_uid, "‚ö†Ô∏è –í—ã –±–æ–ª—å—à–µ –Ω–µ –∞–¥–º–∏–Ω.", None, vk_session)
            return
def background_checker(vk_session):
    while True:
        try:
            current_time = time.time()
            for user_id, data in list(players.items()):
                faction = data.get("faction")
                if not faction or faction == "None" or faction is None:
                    continue
                if data.get("donation_end_time") and current_time >= data.get("donation_end_time"):
                    remove_donation(user_id, vk_session)
                if data.get("health", 10) <= 0:
                    if not data.get("death_notified", False):
                        lose_random_items_on_death(user_id, vk_session)
                        continue
                if data.get("state") == STATE_TRANSITION_WAIT:
                    end_time = data.get("transition_end_time")
                    if end_time and current_time >= end_time:
                        data["previous_location"] = None
                        data["previous_point"] = None
                        if random.randint(1, 100) <= 30:
                            money_found = random.randint(5, 15)
                            data["money"] = data.get("money", 0) + money_found
                            transition_msg = f"‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –∑–∞–≤–µ—Ä—à—ë–Ω!\nüí≤ –ü–æ –ø—É—Ç–∏ –Ω–∞—à–ª–∏: {money_found}—Ä"
                        elif random.randint(1, 100) <= 20:
                            rad_gain = round(random.uniform(0.5, 1.5), 1)
                            data["radiation"] = min(10, data["radiation"] + rad_gain)
                            transition_msg = f"‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –∑–∞–≤–µ—Ä—à—ë–Ω!\n‚ò¢Ô∏è –ü–æ–ª—É—á–µ–Ω–æ –æ–±–ª—É—á–µ–Ω–∏–µ: +{rad_gain}"
                        else:
                            transition_msg = "‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –∑–∞–≤–µ—Ä—à—ë–Ω!"
                        data["transition_end_time"] = None
                        data["state"] = STATE_IN_MENU
                        data["backpack"]["–±–∞—Ç–∞—Ä–µ–π–∫–∏"] = data["backpack"].get("–±–∞—Ç–∞—Ä–µ–π–∫–∏", 0) - 2
                        if data["backpack"]["–±–∞—Ç–∞—Ä–µ–π–∫–∏"] <= 0:
                            del data["backpack"]["–±–∞—Ç–∞—Ä–µ–π–∫–∏"]
                        transition_msg += "\nüîã –ü–æ—Ç—Ä–∞—á–µ–Ω–æ 2 –±–∞—Ç–∞—Ä–µ–π–∫–∏."
                        current_location = data["location"]
                        current_point = data["point"]
                        if (current_location, current_point) in TRANSITION_ROUTES:
                            destinations = TRANSITION_ROUTES[(current_location, current_point)]
                            transition_msg += "\n\nüìç –í—ã –Ω–∞ —Ç–æ—á–∫–µ –ø–µ—Ä–µ—Ö–æ–¥–∞!"
                            for dest_loc, dest_point in destinations:
                                transition_msg += f"\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ø–∞—Å—Ç—å –Ω–∞ {dest_loc} {dest_point}"
                        send_location_image(user_id, current_location, current_point, transition_msg, create_main_menu_keyboard(user_id), vk_session)
                        save_data()
                elif data.get("state") == STATE_RESTING:
                    start_time = data.get("rest_start_time")
                    if start_time:
                        elapsed = current_time - start_time
                        initial = data.get("initial_stamina", data["stamina"])
                        belt_bonus = apply_belt_effects_on_rest(user_id)
                        donation_bonus = 1 if has_active_donation(user_id) else 0
                        total_bonus = 1 + belt_bonus + donation_bonus
                        elapsed_intervals = int(elapsed // 360)
                        new_stamina = min(10, initial + elapsed_intervals * total_bonus)
                        if new_stamina > data["stamina"]:
                            data["stamina"] = new_stamina
                            save_data()
                        if data["stamina"] >= 10:
                            data["stamina"] = 10
                            data["state"] = STATE_IN_CAMP
                            data["rest_start_time"] = None
                            data.pop("initial_stamina", None)
                            save_data()
                            send_message(user_id, "üò¥ –í—ã –æ—Ç–¥–æ—Ö–Ω—É–ª–∏ –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å.", create_camp_menu_keyboard(), vk_session)
            if LAST_STAND_MODE:
                next_action_time = zombie_bot.get("last_action_time", 0) + ZOMBIE_ACTION_INTERVAL
                if current_time >= next_action_time:
                    zombie_take_action(vk_session)
            time.sleep(10)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º –ø–æ—Ç–æ–∫–µ: {e}")
            time.sleep(30)
if __name__ == "__main__":
    load_data()
    while True:
        try:
            logger.info("üîÅ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è VK —Å–µ—Å—Å–∏–∏...")
            vk_session = vk_api.VkApi(token=TOKEN)
            longpoll = VkBotLongPoll(vk_session, GROUP_ID)
            logger.info("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –æ–∂–∏–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π...")
            checker_thread = threading.Thread(target=background_checker, args=(vk_session,), daemon=True)
            checker_thread.start()
            logger.info("‚úÖ –§–æ–Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø—É—â–µ–Ω...")
            for event in longpoll.listen():
                if event.type == VkBotEventType.MESSAGE_NEW:
                    message = event.obj.message
                    from_id = message.get('from_id', 0)
                    peer_id = message.get('peer_id', 0)
                    msg_text = message.get('text', '').strip()
                    if from_id < 0:
                        continue
                    attachments = message.get('attachments', [])
                    fwd_messages = message.get('fwd_messages', [])
                    reply_message = message.get('reply_message')
                    if from_id in players and players[from_id].get("state") == STATE_WAITING_QUOTE_PHOTO:
                        photo_att = None
                        for att in attachments:
                            if att.get('type') == 'photo':
                                photo_att = att.get('photo', {})
                                break
                        if photo_att or msg_text.lower().startswith("–Ω–µ—Ç"):
                            process_quote_photo(from_id, msg_text, photo_att, peer_id, vk_session)
                            continue
                        else:
                            send_message(from_id, "üì∑ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ ¬´–Ω–µ—Ç¬ª.", None, vk_session, peer_id)
                            continue
                    if msg_text.lower() == "/—Ü–∏—Ç–∞—Ç–∞":
                        source_msg = reply_message if reply_message else (fwd_messages[0] if fwd_messages else None)
                        if source_msg:
                            process_quote_request(from_id, source_msg.get('text', ''), source_msg.get('from_id', 0), source_msg.get('date', 0), peer_id, vk_session)
                        else:
                            send_message(from_id, "‚ùå –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –ø–µ—Ä–µ—à–ª–∏—Ç–µ –µ–≥–æ —Å –∫–æ–º–∞–Ω–¥–æ–π /—Ü–∏—Ç–∞—Ç–∞", None, vk_session, peer_id)
                        continue
                    if attachments and from_id in players:
                        pending_target = players[from_id].get("pending_photo_target")
                        if pending_target and is_admin(from_id):
                            for att in attachments:
                                if att.get('type') == 'photo':
                                    photo = att.get('photo', {})
                                    sizes = photo.get('sizes', [])
                                    if sizes:
                                        best_size = max(sizes, key=lambda x: x.get('width', 0) * x.get('height', 0))
                                        photo_url = best_size.get('url')
                                        if photo_url:
                                            handle_photo_upload(from_id, photo_url, vk_session)
                                            break
                            continue
                    if peer_id != from_id:
                        try:
                            handle_chat_message(event, vk_session)
                        except Exception as e:
                            logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –±–µ—Å–µ–¥–µ: {e}")
                    else:
                        try:
                            class SimpleEvent:
                                def __init__(self, msg):
                                    self.user_id = msg.get('from_id')
                                    self.text = msg.get('text', '')
                                    self.from_chat = False
                                    self.from_me = False
                            simple_event = SimpleEvent(message)
                            handle_message(simple_event, vk_session)
                        except Exception as e:
                            logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        except (KeyboardInterrupt, SystemExit):
            logger.info("üõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤—Ä—É—á–Ω—É—é.")
            break
        except Exception as e:
            logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
            logger.info("‚è≥ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...")
            time.sleep(5)
