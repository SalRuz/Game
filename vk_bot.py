import vk_api
import time
import logging
import json
import os
import random
import io
import sqlite3
import threading
from pathlib import Path
from PIL import Image, ImageDraw, ImageFont, ImageEnhance
from vk_api.longpoll import VkLongPoll, VkEventType
from vk_api.keyboard import VkKeyboard, VkKeyboardColor
from vk_api.bot_longpoll import VkBotLongPoll, VkBotEventType
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)
TOKEN = "vk1.a.CU2M1F0_9rxlYYuzK57JMRnY3XO2WmOP_TpXDxHbki0AM_mwV-_eBjjfF8ByZHz--fIHilfQD6oS4_bcqG-cc_GUaDln_X87jt6lG8bVX5MJUribi1nPEbY9pY1X3j-FGoq2Hc-CF2GDvAzalh9VmYtT-iFmyTDepaeJwZXZyYU0eFZg7BwhHnuqmIhQrdiG5LqhWWf9Pn536k1MVKAknQ"
GROUP_ID = 233350137
DATA_DIR = Path("data")
DATA_DIR.mkdir(parents=True, exist_ok=True)
DB_PATH = DATA_DIR / "bot.db"
AVATAR_DIR = "custom_avatars"
os.makedirs(AVATAR_DIR, exist_ok=True)
CELL_SIZE = 60
MARGIN = 5
COLUMNS = 5
ROWS = 10
INVENTORY_SIZE = COLUMNS * ROWS
LOCATION_MAPS = {"ÐšÐ¾Ñ€Ð´Ð¾Ð½": "backgrounds/ÐºÐ°Ñ€Ñ‚Ð°_ÐºÐ¾Ñ€Ð´Ð¾Ð½Ð°.png", "Ð¡Ð²Ð°Ð»ÐºÐ°": "backgrounds/ÐºÐ°Ñ€Ñ‚Ð°_ÑÐ²Ð°Ð»ÐºÐ¸.png", "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°": "backgrounds/ÐºÐ°Ñ€Ñ‚Ð°_Ñ‚ÐµÐ¼Ð½Ð¾Ð¹_Ð´Ð¾Ð»Ð¸Ð½Ñ‹.png", "ÐŸÐ¾Ð»ÑÐ½Ð°": "backgrounds/ÐºÐ°Ñ€Ñ‚Ð°_Ð¿Ð¾Ð»ÑÐ½Ñ‹.png"}
ITEM_ICONS = {"ÑˆÐ¾ÐºÐ¾Ð»Ð°Ð´Ð½Ñ‹Ð¹ Ð±Ð°Ñ‚Ð¾Ð½Ñ‡Ð¸Ðº": "icons/chocolate.png", "Ñ…Ð»ÐµÐ±": "icons/bread.png", "ÐºÐ¾Ð»Ð±Ð°ÑÐ°": "icons/sausage.png", "ÐºÐ¾Ð½ÑÐµÑ€Ð²Ð°": "icons/canned_food.png", "Ð±Ð¸Ð½Ñ‚": "icons/bandage.png", "Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": "icons/first_aid.png", "Ð°Ñ€Ð¼ÐµÐ¹ÑÐºÐ°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": "icons/army_medkit.png", "Ð½Ð°ÑƒÑ‡Ð½Ð°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": "icons/science_medkit.png", "ÑÐ¸Ð³Ð°Ñ€ÐµÑ‚Ñ‹": "icons/cigarettes.png", "Ð²Ð¾Ð´ÐºÐ°": "icons/vodka.png", "Ñ€Ð°Ð´Ð¸Ð¾Ð¿Ñ€Ð¾Ñ‚ÐµÐºÑ‚Ð¾Ñ€": "icons/radioprotector.png", "Ð°Ð½Ñ‚Ð¸Ñ€Ð°Ð´": "icons/antirad.png", "ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸Ðº Ð½Ð¾Ð½ÑÑ‚Ð¾Ð¿": "icons/energy_nostop.png", "ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸Ðº ÑÑ‚Ð°Ð»ÐºÐµÑ€": "icons/energy_stalker.png", "Ð³ÐµÑ€ÐºÑƒÐ»ÐµÑ": "icons/hercules.png", "Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸": "icons/battery.png", "Ð¿Ð¾Ð½Ñ‡Ð¸Ðº": "icons/ÐŸÐ¾Ð½Ñ‡Ð¸Ðº.png", "ÑÑ‚ÐµÐ¹Ðº": "icons/Ð¡Ñ‚ÐµÐ¹Ðº.png", "Ð¶ÐµÐ»ÑƒÐ´ÑŒ": "icons/Ð–ÐµÐ»ÑƒÐ´ÑŒ.png"}
SPECIAL_WEAPONS = {"Ð¡Ð“Ð˜ 5Ðº": {"mutant_bonus": 0.5, "radiation_reduce": 0.5}, "Ð“Ñ€Ð¾Ð¼ Ð¡14": {"mutant_bonus": 1}, "ÐÐšÐ¡-103": {"war_bonus_chance": 30, "war_bonus_damage": 1}, "ÐžÐ±Ñ€ÐµÐ· Ð´Ð²ÑƒÑÑ‚Ð²Ð¾Ð»ÐºÐ¸": {"shotgun_spread": True}, "Ð¢ÐžÐ—-34": {"shotgun_spread": True}, "Ð¡ÐŸÐ¡Ð-14": {"shotgun_spread": True}}
DETECTORS = {"ÐžÑ‚ÐºÐ»Ð¸Ðº": {"charge": 10, "price": 70}, "ÐœÐµÐ´Ð²ÐµÐ´ÑŒ": {"charge": 15, "price": 170}, "Ð’ÐµÐ»ÐµÑ": {"charge": 20, "price": 320}, "Ð¡Ð²Ð°Ñ€Ð¾Ð³": {"charge": 24, "price": 500}}
ANOMALY_ZONES = {"ÐšÐ¾Ñ€Ð´Ð¾Ð½": {"Ð1": "Ð³Ñ€Ð°Ð²Ð¸", "Ð2": "ÑÐ»ÐµÐºÑ‚Ñ€Ð¾", "Ð3": "Ñ…Ð¸Ð¼"}, "Ð¡Ð²Ð°Ð»ÐºÐ°": {"Ð1": "Ñ‚ÐµÑ€Ð¼Ð¾", "Ð2": "Ð³Ñ€Ð°Ð²Ð¸", "Ð3": "Ð³Ñ€Ð°Ð²Ð¸"}, "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°": {"Ð1": "ÑÐ»ÐµÐºÑ‚Ñ€Ð¾", "Ð2": "Ð³Ñ€Ð°Ð²Ð¸"}, "ÐŸÐ¾Ð»ÑÐ½Ð°": {"Ð1": "Ð³Ñ€Ð°Ð²Ð¸", "Ð2": "ÑÐ»ÐµÐºÑ‚Ñ€Ð¾", "Ð3": "Ñ‚ÐµÑ€Ð¼Ð¾"}}
ANOMALY_BUTTONS = {"Ð³Ñ€Ð°Ð²Ð¸": "ðŸŒªï¸ Ð“Ñ€Ð°Ð²Ð¸ Ð°Ð½Ð¾Ð¼Ð°Ð»Ð¸Ð¸", "ÑÐ»ÐµÐºÑ‚Ñ€Ð¾": "âš¡ Ð­Ð»ÐµÐºÑ‚Ñ€Ð¾ Ð°Ð½Ð¾Ð¼Ð°Ð»Ð¸Ð¸", "Ñ…Ð¸Ð¼": "â˜£ï¸ Ð¥Ð¸Ð¼ Ð°Ð½Ð¾Ð¼Ð°Ð»Ð¸Ð¸", "Ñ‚ÐµÑ€Ð¼Ð¾": "ðŸ”¥ Ð¢ÐµÑ€Ð¼Ð¾ Ð°Ð½Ð¾Ð¼Ð°Ð»Ð¸Ð¸"}
ANOMALY_DAMAGE = {"Ð³Ñ€Ð°Ð²Ð¸": (3, 4.5), "ÑÐ»ÐµÐºÑ‚Ñ€Ð¾": (3, 5), "Ñ…Ð¸Ð¼": (3.5, 5.5), "Ñ‚ÐµÑ€Ð¼Ð¾": (3.5, 6)}
ARTIFACTS = {"Ð³Ñ€Ð°Ð²Ð¸": ["Ð’ÑÐ¿Ñ‹ÑˆÐºÐ°", "ÐšÑ€Ð¾Ð²ÑŒ ÐºÐ°Ð¼Ð½Ñ", "Ð›Ð¾Ð¼Ð¾Ñ‚ÑŒ Ð¼ÑÑÐ°", "ÐšÐ¾Ð»ÑŽÑ‡ÐºÐ°", "Ð“Ð»Ð°Ð·", "Ð“Ñ€Ð°Ð²Ð¸", "ÐœÐ°Ð¼Ð¸Ð½Ñ‹ Ð±ÑƒÑÑ‹", "Ð—Ð¾Ð»Ð¾Ñ‚Ð°Ñ Ñ€Ñ‹Ð±ÐºÐ°"], "ÑÐ»ÐµÐºÑ‚Ñ€Ð¾": ["ÐœÐµÐ´ÑƒÐ·Ð°", "Ð¡Ð»Ð¸Ð·ÑŒ", "Ð‘ÐµÐ½Ð³Ð°Ð»ÑŒÑÐºÐ¸Ð¹ Ð¾Ð³Ð¾Ð½ÑŒ", "Ð”ÑƒÑˆÐ°", "Ð¡Ð»ÑŽÐ´Ð°", "ÐŸÐ»Ð°Ð¼Ñ", "ÐÐ¾Ñ‡Ð½Ð°Ñ Ð·Ð²ÐµÐ·Ð´Ð°", "Ð‘Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ°"], "Ñ…Ð¸Ð¼": ["ÐšÐ¾Ð»Ð¾Ð±Ð¾Ðº", "ÐŸÑƒÑÑ‚Ñ‹ÑˆÐºÐ°", "ÐšÐ°Ð¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ†Ð²ÐµÑ‚Ð¾Ðº", "ÐšÐ°Ð¿Ð»Ð¸", "ÐšÑ€Ð¸ÑÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ ÐºÐ¾Ð»ÑŽÑ‡ÐºÐ°", "Ð›ÑƒÐ½Ð½Ñ‹Ð¹ ÑÐ²ÐµÑ‚", "ÐŸÑƒÐ·Ñ‹Ñ€ÑŒ", "ÐŸÐ»Ñ‘Ð½ÐºÐ°"], "Ñ‚ÐµÑ€Ð¼Ð¾": ["Ð’Ñ‹Ð²ÐµÑ€Ñ‚", "Ð¡Ð½ÐµÐ¶Ð¸Ð½ÐºÐ°", "ÐžÐ³Ð½ÐµÐ½Ð½Ñ‹Ð¹ ÑˆÐ°Ñ€", "Ð¡Ð»Ð¸Ð·Ð½ÑÐº", "ÐŸÑ€ÑƒÐ¶Ð¸Ð½Ð°", "Ð¡Ð²ÐµÑ‚Ð»ÑÐº", "ÐšÑ€Ð¸ÑÑ‚Ð°Ð»Ð»", "ÐœÐ¾Ñ€ÑÐºÐ¾Ð¹ Ñ‘Ð¶"]}
DONATION_ARTIFACTS = ["ÐŸÐ¾Ð½Ñ‡Ð¸Ðº", "Ð¡Ñ‚ÐµÐ¹Ðº"]
ALL_ARTIFACTS = []
for arts in ARTIFACTS.values():
    ALL_ARTIFACTS.extend(arts)
ALL_ARTIFACTS = list(set(ALL_ARTIFACTS + DONATION_ARTIFACTS))
ARTIFACT_EFFECTS = {"ÐšÑ€Ð¾Ð²ÑŒ ÐºÐ°Ð¼Ð½Ñ": {"health_regen": 0.25}, "Ð›Ð¾Ð¼Ð¾Ñ‚ÑŒ Ð¼ÑÑÐ°": {"health_regen": 0.5}, "Ð”ÑƒÑˆÐ°": {"health_regen": 0.75}, "Ð¡Ð²ÐµÑ‚Ð»ÑÐº": {"health_regen": 1}, "ÐšÐ¾Ð»Ð¾Ð±Ð¾Ðº": {"radiation_reduce": 0.25}, "ÐœÐµÐ´ÑƒÐ·Ð°": {"radiation_reduce": 0.5}, "Ð¡Ð»Ð¸Ð·Ð½ÑÐº": {"radiation_reduce": 0.75}, "ÐŸÑƒÐ·Ñ‹Ñ€ÑŒ": {"radiation_reduce": 1}, "Ð’ÑÐ¿Ñ‹ÑˆÐºÐ°": {"stamina_regen": 0.5}, "Ð¡Ð½ÐµÐ¶Ð¸Ð½ÐºÐ°": {"stamina_regen": 1}, "Ð›ÑƒÐ½Ð½Ñ‹Ð¹ ÑÐ²ÐµÑ‚": {"stamina_regen": 1.5}, "Ð‘Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ°": {"stamina_regen": 2}, "Ð‘ÐµÐ½Ð³Ð°Ð»ÑŒÑÐºÐ¸Ð¹ Ð¾Ð³Ð¾Ð½ÑŒ": {"blast_resist": 0.25}, "Ð’Ñ‹Ð²ÐµÑ€Ñ‚": {"blast_resist": 0.5}, "Ð“Ñ€Ð°Ð²Ð¸": {"blast_resist": 0.75}, "Ð—Ð¾Ð»Ð¾Ñ‚Ð°Ñ Ñ€Ñ‹Ð±ÐºÐ°": {"blast_resist": 1}, "ÐŸÑƒÑÑ‚Ñ‹ÑˆÐºÐ°": {"bullet_resist": 0.5}, "ÐšÐ°Ð¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ†Ð²ÐµÑ‚Ð¾Ðº": {"bullet_resist": 1}, "ÐÐ¾Ñ‡Ð½Ð°Ñ Ð·Ð²ÐµÐ·Ð´Ð°": {"bullet_resist": 1.5}, "ÐšÑ€Ð¸ÑÑ‚Ð°Ð»Ð»": {"bullet_resist": 2}, "ÐšÐ¾Ð»ÑŽÑ‡ÐºÐ°": {"anomaly_resist": 0.25}, "ÐŸÐ»Ð°Ð¼Ñ": {"anomaly_resist": 0.5}, "ÐžÐ³Ð½ÐµÐ½Ð½Ñ‹Ð¹ ÑˆÐ°Ñ€": {"anomaly_resist": 0.75}, "ÐŸÐ»Ñ‘Ð½ÐºÐ°": {"anomaly_resist": 1}, "Ð“Ð»Ð°Ð·": {"weapon_damage": 0.5}, "ÐšÐ°Ð¿Ð»Ð¸": {"weapon_damage": 1}, "ÐšÑ€Ð¸ÑÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ ÐºÐ¾Ð»ÑŽÑ‡ÐºÐ°": {"weapon_damage": 1.5}, "ÐŸÑ€ÑƒÐ¶Ð¸Ð½Ð°": {"weapon_damage": 2}, "Ð¡Ð»Ð¸Ð·ÑŒ": {"weapon_accuracy": 0.5}, "Ð¡Ð»ÑŽÐ´Ð°": {"weapon_accuracy": 1}, "ÐœÐ°Ð¼Ð¸Ð½Ñ‹ Ð±ÑƒÑÑ‹": {"weapon_accuracy": 1.5}, "ÐœÐ¾Ñ€ÑÐºÐ¾Ð¹ Ñ‘Ð¶": {"weapon_accuracy": 2}}
ARTIFACT_PRICES = {"ÐšÑ€Ð¾Ð²ÑŒ ÐºÐ°Ð¼Ð½Ñ": 15, "ÐšÐ¾Ð»Ð¾Ð±Ð¾Ðº": 15, "Ð’ÑÐ¿Ñ‹ÑˆÐºÐ°": 15, "Ð‘ÐµÐ½Ð³Ð°Ð»ÑŒÑÐºÐ¸Ð¹ Ð¾Ð³Ð¾Ð½ÑŒ": 15, "ÐŸÑƒÑÑ‚Ñ‹ÑˆÐºÐ°": 15, "ÐšÐ¾Ð»ÑŽÑ‡ÐºÐ°": 15, "Ð“Ð»Ð°Ð·": 15, "Ð¡Ð»Ð¸Ð·ÑŒ": 15, "Ð›Ð¾Ð¼Ð¾Ñ‚ÑŒ Ð¼ÑÑÐ°": 25, "ÐœÐµÐ´ÑƒÐ·Ð°": 25, "Ð¡Ð½ÐµÐ¶Ð¸Ð½ÐºÐ°": 25, "Ð’Ñ‹Ð²ÐµÑ€Ñ‚": 25, "ÐšÐ°Ð¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ†Ð²ÐµÑ‚Ð¾Ðº": 25, "ÐŸÐ»Ð°Ð¼Ñ": 25, "ÐšÐ°Ð¿Ð»Ð¸": 25, "Ð¡Ð»ÑŽÐ´Ð°": 25, "Ð”ÑƒÑˆÐ°": 35, "Ð¡Ð»Ð¸Ð·Ð½ÑÐº": 35, "Ð›ÑƒÐ½Ð½Ñ‹Ð¹ ÑÐ²ÐµÑ‚": 35, "Ð“Ñ€Ð°Ð²Ð¸": 35, "ÐÐ¾Ñ‡Ð½Ð°Ñ Ð·Ð²ÐµÐ·Ð´Ð°": 35, "ÐžÐ³Ð½ÐµÐ½Ð½Ñ‹Ð¹ ÑˆÐ°Ñ€": 35, "ÐšÑ€Ð¸ÑÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ ÐºÐ¾Ð»ÑŽÑ‡ÐºÐ°": 35, "ÐœÐ°Ð¼Ð¸Ð½Ñ‹ Ð±ÑƒÑÑ‹": 35, "Ð¡Ð²ÐµÑ‚Ð»ÑÐº": 45, "ÐŸÑƒÐ·Ñ‹Ñ€ÑŒ": 45, "Ð‘Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ°": 45, "Ð—Ð¾Ð»Ð¾Ñ‚Ð°Ñ Ñ€Ñ‹Ð±ÐºÐ°": 45, "ÐšÑ€Ð¸ÑÑ‚Ð°Ð»Ð»": 45, "ÐŸÐ»Ñ‘Ð½ÐºÐ°": 45, "ÐŸÑ€ÑƒÐ¶Ð¸Ð½Ð°": 45, "ÐœÐ¾Ñ€ÑÐºÐ¾Ð¹ Ñ‘Ð¶": 45}
ARTIFACT_ICONS = {"Ð’ÑÐ¿Ñ‹ÑˆÐºÐ°": "icons/Ð’ÑÐ¿Ñ‹ÑˆÐºÐ°.png", "ÐšÑ€Ð¾Ð²ÑŒ ÐºÐ°Ð¼Ð½Ñ": "icons/ÐšÑ€Ð¾Ð²ÑŒ_ÐºÐ°Ð¼Ð½Ñ.png", "Ð›Ð¾Ð¼Ð¾Ñ‚ÑŒ Ð¼ÑÑÐ°": "icons/Ð›Ð¾Ð¼Ð¾Ñ‚ÑŒ_Ð¼ÑÑÐ°.png", "ÐšÐ¾Ð»ÑŽÑ‡ÐºÐ°": "icons/ÐšÐ¾Ð»ÑŽÑ‡ÐºÐ°.png", "Ð“Ð»Ð°Ð·": "icons/Ð“Ð»Ð°Ð·.png", "Ð“Ñ€Ð°Ð²Ð¸": "icons/Ð“Ñ€Ð°Ð²Ð¸.png", "ÐœÐ°Ð¼Ð¸Ð½Ñ‹ Ð±ÑƒÑÑ‹": "icons/ÐœÐ°Ð¼Ð¸Ð½Ñ‹_Ð±ÑƒÑÑ‹.png", "Ð—Ð¾Ð»Ð¾Ñ‚Ð°Ñ Ñ€Ñ‹Ð±ÐºÐ°": "icons/Ð—Ð¾Ð»Ð¾Ñ‚Ð°Ñ_Ñ€Ñ‹Ð±ÐºÐ°.png", "ÐœÐµÐ´ÑƒÐ·Ð°": "icons/ÐœÐµÐ´ÑƒÐ·Ð°.png", "Ð¡Ð»Ð¸Ð·ÑŒ": "icons/Ð¡Ð»Ð¸Ð·ÑŒ.png", "Ð‘ÐµÐ½Ð³Ð°Ð»ÑŒÑÐºÐ¸Ð¹ Ð¾Ð³Ð¾Ð½ÑŒ": "icons/Ð‘ÐµÐ½Ð³Ð°Ð»ÑŒÑÐºÐ¸Ð¹_Ð¾Ð³Ð¾Ð½ÑŒ.png", "Ð”ÑƒÑˆÐ°": "icons/Ð”ÑƒÑˆÐ°.png", "Ð¡Ð»ÑŽÐ´Ð°": "icons/Ð¡Ð»ÑŽÐ´Ð°.png", "ÐŸÐ»Ð°Ð¼Ñ": "icons/ÐŸÐ»Ð°Ð¼Ñ.png", "ÐÐ¾Ñ‡Ð½Ð°Ñ Ð·Ð²ÐµÐ·Ð´Ð°": "icons/ÐÐ¾Ñ‡Ð½Ð°Ñ_Ð·Ð²ÐµÐ·Ð´Ð°.png", "Ð‘Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ°": "icons/Ð‘Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ°.png", "ÐšÐ¾Ð»Ð¾Ð±Ð¾Ðº": "icons/ÐšÐ¾Ð»Ð¾Ð±Ð¾Ðº.png", "ÐŸÑƒÑÑ‚Ñ‹ÑˆÐºÐ°": "icons/ÐŸÑƒÑÑ‚Ñ‹ÑˆÐºÐ°.png", "ÐšÐ°Ð¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ†Ð²ÐµÑ‚Ð¾Ðº": "icons/ÐšÐ°Ð¼ÐµÐ½Ð½Ñ‹Ð¹_Ñ†Ð²ÐµÑ‚Ð¾Ðº.png", "ÐšÐ°Ð¿Ð»Ð¸": "icons/ÐšÐ°Ð¿Ð»Ð¸.png", "ÐšÑ€Ð¸ÑÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ ÐºÐ¾Ð»ÑŽÑ‡ÐºÐ°": "icons/ÐšÑ€Ð¸ÑÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ_ÐºÐ¾Ð»ÑŽÑ‡ÐºÐ°.png", "Ð›ÑƒÐ½Ð½Ñ‹Ð¹ ÑÐ²ÐµÑ‚": "icons/Ð›ÑƒÐ½Ð½Ñ‹Ð¹_ÑÐ²ÐµÑ‚.png", "ÐŸÑƒÐ·Ñ‹Ñ€ÑŒ": "icons/ÐŸÑƒÐ·Ñ‹Ñ€ÑŒ.png", "ÐŸÐ»Ñ‘Ð½ÐºÐ°": "icons/ÐŸÐ»ÐµÐ½ÐºÐ°.png", "Ð’Ñ‹Ð²ÐµÑ€Ñ‚": "icons/Ð’Ñ‹Ð²ÐµÑ€Ñ‚.png", "Ð¡Ð½ÐµÐ¶Ð¸Ð½ÐºÐ°": "icons/Ð¡Ð½ÐµÐ¶Ð¸Ð½ÐºÐ°.png", "ÐžÐ³Ð½ÐµÐ½Ð½Ñ‹Ð¹ ÑˆÐ°Ñ€": "icons/ÐžÐ³Ð½ÐµÐ½Ð½Ñ‹Ð¹_ÑˆÐ°Ñ€.png", "Ð¡Ð»Ð¸Ð·Ð½ÑÐº": "icons/Ð¡Ð»Ð¸Ð·Ð½ÑÐº.png", "ÐŸÑ€ÑƒÐ¶Ð¸Ð½Ð°": "icons/ÐŸÑ€ÑƒÐ¶Ð¸Ð½Ð°.png", "Ð¡Ð²ÐµÑ‚Ð»ÑÐº": "icons/Ð¡Ð²ÐµÑ‚Ð»ÑÐº.png", "ÐšÑ€Ð¸ÑÑ‚Ð°Ð»Ð»": "icons/ÐšÑ€Ð¸ÑÑ‚Ð°Ð»Ð».png", "ÐœÐ¾Ñ€ÑÐºÐ¾Ð¹ Ñ‘Ð¶": "icons/ÐœÐ¾Ñ€ÑÐºÐ¾Ð¹_ÐµÐ¶.png"}
ARTIFACT_ICONS["ÐŸÐ¾Ð½Ñ‡Ð¸Ðº"] = "icons/ÐŸÐ¾Ð½Ñ‡Ð¸Ðº.png"
ARTIFACT_ICONS["Ð¡Ñ‚ÐµÐ¹Ðº"] = "icons/Ð¡Ñ‚ÐµÐ¹Ðº.png"
ARTIFACT_EFFECTS["ÐŸÐ¾Ð½Ñ‡Ð¸Ðº"] = {"heal_on_consume": 0.5}
ARTIFACT_EFFECTS["Ð¡Ñ‚ÐµÐ¹Ðº"] = {"hunger_on_consume": 0.5}
DONATION_DURATIONS = {"Ð´ÐµÐ½ÑŒ": 86400,"Ð½ÐµÐ´ÐµÐ»Ñ": 604800,"Ð¼ÐµÑÑÑ†": 2592000}
DONATION_EXCLUDED_ITEMS = ["ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸Ðº Ð½Ð¾Ð½ÑÑ‚Ð¾Ð¿", "ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸Ðº ÑÑ‚Ð°Ð»ÐºÐµÑ€", "Ð³ÐµÑ€ÐºÑƒÐ»ÐµÑ"]
players = {}
factions = {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": [], "â˜¦ï¸ Ð“Ñ€ÐµÑ…": [], "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": []}
MAX_FACTION_SIZES = {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": 5, "â˜¦ï¸ Ð“Ñ€ÐµÑ…": 5, "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": 5}
STATE_WAITING_FOR_START = "waiting_for_start"
STATE_READING_INSTRUCTIONS = "reading_instructions"
STATE_CHOOSING_FACTION = "choosing_faction"
STATE_ENTERING_NICKNAME = "entering_nickname"
STATE_IN_MENU = "in_menu"
STATE_IN_CAMP = "in_camp"
STATE_IN_BACKPACK = "in_backpack"
STATE_TRANSITION_WAIT = "transition_wait"
STATE_IN_TRANSITION_MENU = "in_transition_menu"
STATE_WAITING_FOR_POINT = "waiting_for_point"
STATE_CONFIRMING_TRANSITION = "confirming_transition"
STATE_RESTING = "resting"
STATE_USING_ITEM = "using_item"
STATE_EXPLORING = "exploring"
STATE_TRADER_MAIN = "trader_main"
STATE_TRADER_BUY = "trader_buy"
STATE_TRADER_SELL = "trader_sell"
STATE_TRADER_BUY_CATEGORY = "trader_buy_category"
STATE_TRADER_SELL_CATEGORY = "trader_sell_category"
STATE_TRADER_BUY_EQUIPMENT = "trader_buy_equipment"
STATE_TRADER_SELL_EQUIPMENT = "trader_sell_equipment"
STATE_TRADER_SELL_EQUIPMENT_CONFIRM = "trader_sell_equipment_confirm"
STATE_TRADER_BUY_EQUIPMENT_CONFIRM = "trader_buy_equipment_confirm"
STATE_TRADER_REPAIR = "trader_repair"
STATE_TRADER_REPAIR_CONFIRM = "trader_repair_confirm"
STATE_WAREHOUSE = "in_warehouse"
STATE_DEAD = "dead"
STATE_CONFIRMING_EQUIPMENT_SELL = "confirming_equipment_sell"
STATE_WAR_MAIN = "war_main"
STATE_WAR_TERRITORIES = "war_territories"
STATE_HUNTING = "hunting"
STATE_HUNTING_SHOOTING = "hunting_shooting"
STATE_ANOMALY_EXPLORE = "anomaly_explore"
STATE_BELT_MAIN = "belt_main"
STATE_BELT_EQUIP = "belt_equip"
STATE_BELT_UNEQUIP = "belt_unequip"
STATE_BELT_SELECT_SLOT = "belt_select_slot"
STATE_BELT_SELECT_ARTIFACT = "belt_select_artifact"
STATE_TRADER_SELL_ARTIFACTS = "trader_sell_artifacts"
STATE_WAR_BUY_SQUAD = "war_buy_squad"
STATE_WAR_CONVERT = "war_convert"
STATE_WAR_MANAGE_SQUADS = "war_manage_squads"
STATE_WAR_SEND_SQUAD = "war_send_squad"
STATE_WAR_SEND_SQUAD_LOCATION = "war_send_squad_location"
STATE_WAR_SEND_SQUAD_POINT = "war_send_squad_point"
STATE_WAR_WITHDRAW_SQUAD = "war_withdraw_squad"
STATE_WAR_ATTACK_CONFIRM = "war_attack_confirm"
STATE_WAR_SHARED_SQUADS = "war_shared_squads"
STATE_WAITING_QUOTE_PHOTO = "waiting_quote_photo"
POINT_COORDINATES = {"ÐšÐ¾Ñ€Ð´Ð¾Ð½": {"Ð‘1": (136, 866), "Ð‘2": (100, 693), "Ð‘3": (322, 604), "Ð‘4": (256, 92), "Ð¢1": (85, 791), "Ð¢2": (283, 491), "Ð¢3": (482, 615), "Ð¢4": (130, 434), "Ð¢5": (343, 370), "Ð›1": (174, 748), "Ð›2": (142, 573), "Ð›3": (425, 510), "Ð›4": (420, 373), "Ð›5": (325, 253), "Ð¢Ð 1": (180, 648), "Ð¢Ð 2": (236, 546), "Ð¢Ð 3": (245, 400), "Ð1": (62, 611), "Ð2": (190, 483), "Ð3": (500, 413)}, "Ð¡Ð²Ð°Ð»ÐºÐ°": {"Ð‘1": (413, 406), "Ð‘2": (661, 192), "Ð¢1": (608, 906), "Ð¢2": (667, 642), "Ð¢3": (227, 451), "Ð›1": (666, 765), "Ð›2": (869, 664), "Ð›3": (879, 390), "Ð›4": (358, 177), "Ð¢Ð 1": (407, 727), "Ð¢Ð 2": (207, 628), "Ð¢Ð 3": (593, 86), "Ð1": (471, 578), "Ð2": (683, 387), "Ð3": (448, 262)}, "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°": {"Ð‘1": (288, 858), "Ð‘2": (626, 516), "Ð‘3": (486, 238), "Ð¢1": (503, 441), "Ð¢2": (363, 180), "Ð¢3": (593, 201), "Ð›1": (583, 790), "Ð›2": (509, 650), "Ð›3": (307, 643), "Ð›4": (308, 452), "Ð¢Ð 1": (381, 374), "Ð¢Ð 2": (464, 136), "Ð1": (439, 517), "Ð2": (627, 410)}, "ÐŸÐ¾Ð»ÑÐ½Ð°": {"Ð‘1": (451, 751), "Ð‘2": (1203, 495), "Ð‘3": (915, 279), "Ð¢1": (205, 761), "Ð¢2": (1051, 401), "Ð›1": (135, 575), "Ð›2": (557, 143), "Ð¢Ð 1": (985, 649), "Ð¢Ð 2": (521, 527), "Ð¢Ð 3": (423, 331), "Ð1": (743, 633), "Ð2": (373, 499), "Ð3": (607, 327)}}
SQUAD_COSTS = {1: {"money": 100, "food": 5, "med": 5, "rad": 5}, 3: {"money": 300, "food": 10, "med": 10, "rad": 10}, 5: {"money": 500, "food": 15, "med": 15, "rad": 15}}
MIN_SQUADS_FOR_POINT = {"Ð‘Ð°Ð·Ð°": 5,"Ð¢Ð¾Ñ‡ÐºÐ° Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²": 4,"ÐÐ½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð¾Ð½Ð°": 3,"Ð›Ð¾Ð³Ð¾Ð²Ð¾": 2,"Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ": 1}
CONVERSION_VALUES = {"ÑˆÐ¾ÐºÐ¾Ð»Ð°Ð´Ð½Ñ‹Ð¹ Ð±Ð°Ñ‚Ð¾Ð½Ñ‡Ð¸Ðº": {"type": "food", "value": 1},"Ñ…Ð»ÐµÐ±": {"type": "food", "value": 2},"ÐºÐ¾Ð»Ð±Ð°ÑÐ°": {"type": "food", "value": 3},"ÐºÐ¾Ð½ÑÐµÑ€Ð²Ð°": {"type": "food", "value": 4},"Ð±Ð¸Ð½Ñ‚": {"type": "med", "value": 1},"Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": {"type": "med", "value": 2},"Ð°Ñ€Ð¼ÐµÐ¹ÑÐºÐ°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": {"type": "med", "value": 3},"Ð½Ð°ÑƒÑ‡Ð½Ð°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": {"type": "special", "med": 3, "rad": 1},"ÑÐ¸Ð³Ð°Ñ€ÐµÑ‚Ñ‹": {"type": "rad", "value": 1},"Ð²Ð¾Ð´ÐºÐ°": {"type": "rad", "value": 2},"Ñ€Ð°Ð´Ð¸Ð¾Ð¿Ñ€Ð¾Ñ‚ÐµÐºÑ‚Ð¾Ñ€": {"type": "rad", "value": 3},"Ð°Ð½Ñ‚Ð¸Ñ€Ð°Ð´": {"type": "rad", "value": 4}}
FACTION_ICONS = {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": "icons/dolg.png","â˜¦ï¸ Ð“Ñ€ÐµÑ…": "icons/greh.png","â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": "icons/odinochki.png"}
ZOMBIE_FACTION = "ðŸ§Ÿ Ð—Ð¾Ð¼Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ"
FACTION_ICONS[ZOMBIE_FACTION] = "icons/Ð·Ð¾Ð¼Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ.png"
LAST_STAND_MODE = False
LAST_STAND_START_POSITIONS = {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": ("ÐšÐ¾Ñ€Ð´Ð¾Ð½", "Ð‘1"), "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": ("ÐšÐ¾Ñ€Ð´Ð¾Ð½", "Ð‘2"), "â˜¦ï¸ Ð“Ñ€ÐµÑ…": ("ÐšÐ¾Ñ€Ð´Ð¾Ð½", "Ð‘3"), ZOMBIE_FACTION: [("Ð¡Ð²Ð°Ð»ÐºÐ°", "Ð‘1"), ("ÐŸÐ¾Ð»ÑÐ½Ð°", "Ð‘1"), ("Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ð‘3")]}
faction_warehouses = {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": {}, "â˜¦ï¸ Ð“Ñ€ÐµÑ…": {}, "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": {}, ZOMBIE_FACTION: {}}
faction_warehouse_money = {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": 0, "â˜¦ï¸ Ð“Ñ€ÐµÑ…": 0, "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": 0, ZOMBIE_FACTION: 0}
zombie_bot = {"money": 0, "squads": 0, "food_units": 0, "med_units": 0, "rad_units": 0, "last_action_time": 0, "next_action": "", "backpack": {}, "mode": "normal", "priority_target": None, "agro_points": [], "last_attacked_by": None}
ZOMBIE_ACTION_INTERVAL = 1800
POINT_STRENGTH = {"Ð‘Ð°Ð·Ð°": 5, "Ð¢Ð¾Ñ‡ÐºÐ° Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²": 4, "ÐÐ½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð¾Ð½Ð°": 3, "Ð›Ð¾Ð³Ð¾Ð²Ð¾": 2, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ": 1}
ZOMBIE_PHASES = {15: {"name": "Ð¡Ñ‚Ð°Ñ€Ñ‚Ð¾Ð²Ñ‹Ðµ ÑÐ¸Ð»Ñ‹", "territories": 1, "loot_times": 5, "cooldown": 1500}, 30: {"name": "ÐÐ¸Ð·ÐºÐ¸Ð¹ ÑÑ‚Ð°Ñ€Ñ‚", "territories": 1, "loot_times": 10, "cooldown": 2100}, 45: {"name": "ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð°Ñ Ñ„Ð°Ð·Ð° Ð°Ð¿Ð¾ÐºÐ°Ð»Ð¸Ð¿ÑÐ¸ÑÐ°", "territories": 2, "loot_times": 10, "cooldown": 2700}, 60: {"name": "ÐÐµÑƒÐ´ÐµÑ€Ð¶Ð¸Ð¼Ñ‹Ð¹ Ð¼Ð°Ñ€Ñˆ ÑÐ¼ÐµÑ€Ñ‚Ð¸", "territories": 3, "loot_times": 10, "cooldown": 3300}, 75: {"name": "Ð¥Ð°Ð¾Ñ Ð²Ð¾Ð¿Ð»Ð¾Ñ‚Ð¸", "territories": 4, "loot_times": 10, "cooldown": 3900}, 100: {"name": "ÐÑ€Ð¼Ð°Ð³ÐµÐ´Ð´Ð¾Ð½", "territories": 5, "loot_times": 10, "cooldown": 3900}}
FACTION_START_LOCATIONS = {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": ("ÐšÐ¾Ñ€Ð´Ð¾Ð½", "Ð‘1"),"â˜¦ï¸ Ð“Ñ€ÐµÑ…": ("Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ð‘1"),"â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": ("Ð¡Ð²Ð°Ð»ÐºÐ°", "Ð‘1")}
FACTION_CHAT_LINKS = {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": "https://vk.me/join//eWcWfZ3Kcr3PZtkGLF91BIxJq4GnZ4aeB8=", "â˜¦ï¸ Ð“Ñ€ÐµÑ…": "https://vk.me/join/gO2fqOqDnL756hWkhjvMm9P2ypNTz7/r2vw=", "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": "https://vk.me/join/ynzBEUOPUmsKVaB0K0BhSFnzGZsNJlrFGNY="}
POINT_TYPES = {"Ð‘1": "Ð‘Ð°Ð·Ð°", "Ð‘2": "Ð‘Ð°Ð·Ð°", "Ð‘3": "Ð‘Ð°Ð·Ð°", "Ð‘4": "Ð‘Ð°Ð·Ð°", "Ð¢1": "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ", "Ð¢2": "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ", "Ð¢3": "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ", "Ð¢4": "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ", "Ð¢5": "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ", "Ð¢Ð 1": "Ð¢Ð¾Ñ‡ÐºÐ° Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²", "Ð¢Ð 2": "Ð¢Ð¾Ñ‡ÐºÐ° Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²", "Ð¢Ð 3": "Ð¢Ð¾Ñ‡ÐºÐ° Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²", "Ð1": "ÐÐ½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð¾Ð½Ð°", "Ð2": "ÐÐ½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð¾Ð½Ð°", "Ð3": "ÐÐ½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð¾Ð½Ð°", "Ð›1": "Ð›Ð¾Ð³Ð¾Ð²Ð¾", "Ð›2": "Ð›Ð¾Ð³Ð¾Ð²Ð¾", "Ð›3": "Ð›Ð¾Ð³Ð¾Ð²Ð¾", "Ð›4": "Ð›Ð¾Ð³Ð¾Ð²Ð¾", "Ð›5": "Ð›Ð¾Ð³Ð¾Ð²Ð¾"}
LOCATIONS = {"ÐšÐ¾Ñ€Ð´Ð¾Ð½": ["Ð¢1", "Ð¢2", "Ð¢3", "Ð¢4", "Ð¢5", "Ð¢Ð 1", "Ð¢Ð 2", "Ð¢Ð 3", "Ð‘1", "Ð‘2", "Ð‘3", "Ð‘4", "Ð1", "Ð2", "Ð3", "Ð›1", "Ð›2", "Ð›3", "Ð›4", "Ð›5"], "Ð¡Ð²Ð°Ð»ÐºÐ°": ["Ð¢1", "Ð¢2", "Ð¢3", "Ð¢Ð 1", "Ð¢Ð 2", "Ð¢Ð 3", "Ð‘1", "Ð‘2", "Ð1", "Ð2", "Ð3", "Ð›1", "Ð›2", "Ð›3", "Ð›4"], "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°": ["Ð¢1", "Ð¢2", "Ð¢3", "Ð¢Ð 1", "Ð¢Ð 2", "Ð‘1", "Ð‘2", "Ð‘3", "Ð1", "Ð2", "Ð›1", "Ð›2", "Ð›3", "Ð›4"], "ÐŸÐ¾Ð»ÑÐ½Ð°": ["Ð¢1", "Ð¢2", "Ð¢Ð 1", "Ð¢Ð 2", "Ð¢Ð 3", "Ð‘1", "Ð‘2", "Ð‘3", "Ð1", "Ð2", "Ð3", "Ð›1", "Ð›2"]}
BASE_POINTS = {"ÐšÐ¾Ñ€Ð´Ð¾Ð½": "Ð‘1", "Ð¡Ð²Ð°Ð»ÐºÐ°": "Ð‘1", "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°": "Ð‘1"}
TRANSITION_ROUTES = {("ÐšÐ¾Ñ€Ð´Ð¾Ð½", "Ð¢3"): [("Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ð‘1")], ("ÐšÐ¾Ñ€Ð´Ð¾Ð½", "Ð›3"): [("ÐŸÐ¾Ð»ÑÐ½Ð°", "Ð¢1")], ("ÐšÐ¾Ñ€Ð´Ð¾Ð½", "Ð‘4"): [("Ð¡Ð²Ð°Ð»ÐºÐ°", "Ð¢1")], ("Ð¡Ð²Ð°Ð»ÐºÐ°", "Ð¢1"): [("ÐšÐ¾Ñ€Ð´Ð¾Ð½", "Ð‘4")], ("Ð¡Ð²Ð°Ð»ÐºÐ°", "Ð›2"): [("ÐŸÐ¾Ð»ÑÐ½Ð°", "Ð›2")], ("Ð¡Ð²Ð°Ð»ÐºÐ°", "Ð›3"): [("Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ð›4")], ("Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ð‘1"): [("ÐšÐ¾Ñ€Ð´Ð¾Ð½", "Ð¢3")], ("Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ð›4"): [("Ð¡Ð²Ð°Ð»ÐºÐ°", "Ð›3")], ("Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ð›3"): [("ÐŸÐ¾Ð»ÑÐ½Ð°", "Ð¢Ð 1")], ("ÐŸÐ¾Ð»ÑÐ½Ð°", "Ð¢Ð 1"): [("Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ð›3")], ("ÐŸÐ¾Ð»ÑÐ½Ð°", "Ð¢1"): [("ÐšÐ¾Ñ€Ð´Ð¾Ð½", "Ð›3")], ("ÐŸÐ¾Ð»ÑÐ½Ð°", "Ð›2"): [("Ð¡Ð²Ð°Ð»ÐºÐ°", "Ð›2")]}
ITEM_EFFECTS = {"ÑˆÐ¾ÐºÐ¾Ð»Ð°Ð´Ð½Ñ‹Ð¹ Ð±Ð°Ñ‚Ð¾Ð½Ñ‡Ð¸Ðº": {"hunger": -0.5}, "Ñ…Ð»ÐµÐ±": {"hunger": -1}, "ÐºÐ¾Ð»Ð±Ð°ÑÐ°": {"hunger": -1.5}, "ÐºÐ¾Ð½ÑÐµÑ€Ð²Ð°": {"hunger": -2}, "Ð±Ð¸Ð½Ñ‚": {"health": 0.5}, "Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": {"health": 1}, "Ð°Ñ€Ð¼ÐµÐ¹ÑÐºÐ°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": {"health": 1.5}, "Ð½Ð°ÑƒÑ‡Ð½Ð°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": {"health": 1.5, "radiation": -0.5}, "ÑÐ¸Ð³Ð°Ñ€ÐµÑ‚Ñ‹": {"radiation": -0.5}, "Ð²Ð¾Ð´ÐºÐ°": {"radiation": -1}, "Ñ€Ð°Ð´Ð¸Ð¾Ð¿Ñ€Ð¾Ñ‚ÐµÐºÑ‚Ð¾Ñ€": {"radiation": -1.5}, "Ð°Ð½Ñ‚Ð¸Ñ€Ð°Ð´": {"radiation": -2}, "ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸Ðº Ð½Ð¾Ð½ÑÑ‚Ð¾Ð¿": {"stamina": 3}, "ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸Ðº ÑÑ‚Ð°Ð»ÐºÐµÑ€": {"stamina": 5}, "Ð³ÐµÑ€ÐºÑƒÐ»ÐµÑ": {"stamina": 7}, "Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸": {}, "Ð¶ÐµÐ»ÑƒÐ´ÑŒ": {"random_effect": True}}
CATEGORIES = {"ÐµÐ´Ð°": ["ÑˆÐ¾ÐºÐ¾Ð»Ð°Ð´Ð½Ñ‹Ð¹ Ð±Ð°Ñ‚Ð¾Ð½Ñ‡Ð¸Ðº", "Ñ…Ð»ÐµÐ±", "ÐºÐ¾Ð»Ð±Ð°ÑÐ°", "ÐºÐ¾Ð½ÑÐµÑ€Ð²Ð°", "Ð³ÐµÑ€ÐºÑƒÐ»ÐµÑ"], "Ð¼ÐµÐ´Ð¸ÐºÐ°Ð¼ÐµÐ½Ñ‚Ñ‹": ["Ð±Ð¸Ð½Ñ‚", "Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°", "Ð°Ñ€Ð¼ÐµÐ¹ÑÐºÐ°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°", "Ð½Ð°ÑƒÑ‡Ð½Ð°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°"], "Ð°Ð½Ñ‚Ð¸Ñ€Ð°Ð´": ["ÑÐ¸Ð³Ð°Ñ€ÐµÑ‚Ñ‹", "Ð²Ð¾Ð´ÐºÐ°", "Ñ€Ð°Ð´Ð¸Ð¾Ð¿Ñ€Ð¾Ñ‚ÐµÐºÑ‚Ð¾Ñ€", "Ð°Ð½Ñ‚Ð¸Ñ€Ð°Ð´"], "ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸ÐºÐ¸": ["ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸Ðº Ð½Ð¾Ð½ÑÑ‚Ð¾Ð¿", "ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸Ðº ÑÑ‚Ð°Ð»ÐºÐµÑ€"], "Ð¿Ñ€Ð¾Ñ‡ÐµÐµ": ["Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸", "Ð¶ÐµÐ»ÑƒÐ´ÑŒ"], "Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹": ALL_ARTIFACTS}
BUY_PRICES = {"ÑˆÐ¾ÐºÐ¾Ð»Ð°Ð´Ð½Ñ‹Ð¹ Ð±Ð°Ñ‚Ð¾Ð½Ñ‡Ð¸Ðº": 5, "Ñ…Ð»ÐµÐ±": 10, "ÐºÐ¾Ð»Ð±Ð°ÑÐ°": 15, "ÐºÐ¾Ð½ÑÐµÑ€Ð²Ð°": 20, "Ð±Ð¸Ð½Ñ‚": 10, "Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": 15, "Ð°Ñ€Ð¼ÐµÐ¹ÑÐºÐ°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": 20, "Ð½Ð°ÑƒÑ‡Ð½Ð°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": 34, "ÑÐ¸Ð³Ð°Ñ€ÐµÑ‚Ñ‹": 5, "Ð²Ð¾Ð´ÐºÐ°": 10, "Ñ€Ð°Ð´Ð¸Ð¾Ð¿Ñ€Ð¾Ñ‚ÐµÐºÑ‚Ð¾Ñ€": 15, "Ð°Ð½Ñ‚Ð¸Ñ€Ð°Ð´": 20, "ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸Ðº Ð½Ð¾Ð½ÑÑ‚Ð¾Ð¿": 21, "ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸Ðº ÑÑ‚Ð°Ð»ÐºÐµÑ€": 35, "Ð³ÐµÑ€ÐºÑƒÐ»ÐµÑ": 50, "Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸": 3}
SELL_PRICES = {"ÑˆÐ¾ÐºÐ¾Ð»Ð°Ð´Ð½Ñ‹Ð¹ Ð±Ð°Ñ‚Ð¾Ð½Ñ‡Ð¸Ðº": 2, "Ñ…Ð»ÐµÐ±": 5, "ÐºÐ¾Ð»Ð±Ð°ÑÐ°": 7, "ÐºÐ¾Ð½ÑÐµÑ€Ð²Ð°": 10, "Ð±Ð¸Ð½Ñ‚": 5, "Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": 7, "Ð°Ñ€Ð¼ÐµÐ¹ÑÐºÐ°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": 10, "Ð½Ð°ÑƒÑ‡Ð½Ð°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": 17, "ÑÐ¸Ð³Ð°Ñ€ÐµÑ‚Ñ‹": 2, "Ð²Ð¾Ð´ÐºÐ°": 5, "Ñ€Ð°Ð´Ð¸Ð¾Ð¿Ñ€Ð¾Ñ‚ÐµÐºÑ‚Ð¾Ñ€": 7, "Ð°Ð½Ñ‚Ð¸Ñ€Ð°Ð´": 10, "ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸Ðº Ð½Ð¾Ð½ÑÑ‚Ð¾Ð¿": 5, "ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸Ðº ÑÑ‚Ð°Ð»ÐºÐµÑ€": 10, "Ð³ÐµÑ€ÐºÑƒÐ»ÐµÑ": 20, "Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸": 0.5}
EQUIPMENT = {"â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": {"weapon": [("ÐŸÐ‘-1Ñ", 2, 1, 1, 200), ("ÐšÐ¾Ñ€Ð°-919", 3, 1, 2, 300), ("ÐžÐ±Ñ€ÐµÐ· Ð´Ð²ÑƒÑÑ‚Ð²Ð¾Ð»ÐºÐ¸", 3.5, 2, 1, 730), ("Ð“Ð°Ð´ÑŽÐºÐ°", 4, 1, 5, 770), ("Ð¢Ð Ñ", 3.5, 2, 2, 780), ("ÐÐšÐœ-74/2", 4, 2, 3, 870), ("Ð¢ÐžÐ—-34", 4, 3, 1, 970), ("Ð¡ÐŸÐ¡Ð-14", 4.5, 4, 1, 1210), ("Ð¡Ð“Ð˜ 5Ðº", 4.5, 4, 3, 1410)], "armor": [("ÐšÐ¾Ð¶Ð°Ð½Ð°Ñ ÐºÑƒÑ€Ñ‚ÐºÐ°", 3, 0, 1, 0, 250), ("ÐšÐ¾Ð¼Ð±Ð¸Ð½ÐµÐ·Ð¾Ð½ Â«Ð—Ð°Ñ€ÑÂ»", 4, 0, 1, 1, 500), ("ÐšÐ¾Ð¼Ð±Ð¸Ð½ÐµÐ·Ð¾Ð½ Â«Ð¡Ð•Ð’ÐÂ»", 5, 1, 1, 3, 1300), ("Ð¢ÑÐ¶Ñ‘Ð»Ñ‹Ð¹ Ð±Ñ€Ð¾Ð½ÐµÐºÐ¾ÑÑ‚ÑŽÐ¼ Â«Ð¢Ð‘Â»", 6, 3, 3, 2, 2350), ("Ð­ÐºÐ·Ð¾ÑÐºÐµÐ»ÐµÑ‚ Ð½ÐµÐ¹Ñ‚Ñ€Ð°Ð»Ð¾Ð²", 7, 4, 4, 2, 3000)]}, "ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": {"weapon": [("ÐŸÐœ", 1.5, 1, 1, 150), ("Ð¤Ð¾Ñ€Ð°-12", 2.5, 1, 1, 250), ("Ð“Ð°Ð´ÑŽÐºÐ°", 4, 1, 5, 770), ("ÐÐšÐ¡-74Ñƒ", 4, 2, 2, 770), ("Ð˜Ð›-85", 4, 2, 3, 870), ("ÐÐ¡ Ð’ÐÐ›", 4.5, 2, 5, 1010), ("ÐÐ±Ð°ÐºÐ°Ð½", 4, 3, 3, 1070), ("Ð¡ÐŸÐ¡Ð-14", 4.5, 4, 1, 1210), ("Ð“Ñ€Ð¾Ð¼ Ð¡14", 4.5, 4, 3, 1410)], "armor": [("ÐšÑƒÑ€Ñ‚ÐºÐ° Ð”Ð¾Ð»Ð³Ð°", 3, 0, 1, 0, 250), ("ÐŸÐ¡5-Ðœ Â«Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ð°Ñ Ð·Ð°Ñ‰Ð¸Ñ‚Ð°Â»", 4, 1, 1, 0, 750), ("ÐŸÐ¡Ð—-9ÐœÐ´ Â«Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ð°Ñ Ð·Ð°Ñ‰Ð¸Ñ‚Ð°Â»", 5, 2, 2, 1, 1550), ("ÐŸÐ¡Ð—-9Ð´ Ð‘Ñ€Ð¾Ð½Ñ Â«Ð”Ð¾Ð»Ð³Ð°Â»", 6, 3, 4, 1, 2350), ("Ð­ÐºÐ·Ð¾ÑÐºÐµÐ»ÐµÑ‚ Â«Ð”Ð¾Ð»Ð³Ð°Â»", 7, 4, 5, 1, 3000)]}, "â˜¦ï¸ Ð“Ñ€ÐµÑ…": {"weapon": [("ÐŸÐ‘-1Ñ", 2, 1, 1, 200), ("ÐšÐ¾Ñ€Ð°-919", 3, 1, 2, 300), ("ÐžÐ±Ñ€ÐµÐ· Ð´Ð²ÑƒÑÑ‚Ð²Ð¾Ð»ÐºÐ¸", 3.5, 2, 1, 730), ("Ð“Ð°Ð´ÑŽÐºÐ°", 4, 1, 5, 770), ("ÐÐšÐœ-74/2", 4, 2, 3, 870), ("Ð¢ÐžÐ—-34", 4, 3, 1, 970), ("ÐÐšÐ¡-103", 5, 2, 4, 1000), ("ÐÐ¡ Ð’ÐÐ›", 4.5, 2, 5, 1010), ("Ð¡ÐŸÐ¡Ð-14", 4.5, 4, 1, 1210)], "armor": [("ÐŸÐ»Ð°Ñ‰ Â«Ð“Ñ€ÐµÑ…Ð¾Ð²Ñ†Ð°Â»", 3, 0, 0, 1, 250), ("ÐšÐµÐ²Ð»Ð°Ñ€Ð¾Ð²Ñ‹Ð¹ Ð¿Ð»Ð°Ñ‰ Â«Ð“Ñ€ÐµÑ…Ð°Â»", 4, 0, 1, 1, 500), ("ÐÐ½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð±Ñ€Ð¾Ð½Ñ Â«Ð’ÐµÐ»ÐµÑÂ»", 5, 1, 2, 2, 1300), ("Ð‘Ñ€Ð¾Ð½ÐµÐ¶Ð¸Ð»ÐµÑ‚ Â«ÐŸÐµÐ¿ÐµÐ»Â»", 6, 3, 2, 3, 2350), ("Ð­ÐºÐ·Ð¾ÑÐºÐµÐ»ÐµÑ‚ Â«Ð˜Ñ€Ð¸Ð¹Â»", 7, 4, 3, 3, 3000)]}}
EQUIPMENT[ZOMBIE_FACTION] = EQUIPMENT["â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸"].copy()
DROP_T = {"Ð”ÐµÐ½ÑŒÐ³Ð¸": {"chance": 30, "min": 5, "max": 15, "type": "money"}, "ÑˆÐ¾ÐºÐ¾Ð»Ð°Ð´Ð½Ñ‹Ð¹ Ð±Ð°Ñ‚Ð¾Ð½Ñ‡Ð¸Ðº": {"chance": 33, "min": 1, "max": 3}, "Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸": {"chance": 33, "min": 1, "max": 10}, "Ñ…Ð»ÐµÐ±": {"chance": 20, "min": 1, "max": 3}, "ÐºÐ¾Ð»Ð±Ð°ÑÐ°": {"chance": 10, "min": 1, "max": 3}, "ÐºÐ¾Ð½ÑÐµÑ€Ð²Ð°": {"chance": 5, "min": 1, "max": 3}, "Ð±Ð¸Ð½Ñ‚": {"chance": 33, "min": 1, "max": 3}, "Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": {"chance": 20, "min": 1, "max": 3}, "Ð°Ñ€Ð¼ÐµÐ¹ÑÐºÐ°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": {"chance": 10, "min": 1, "max": 3}, "Ð½Ð°ÑƒÑ‡Ð½Ð°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": {"chance": 5, "min": 1, "max": 3}, "ÑÐ¸Ð³Ð°Ñ€ÐµÑ‚Ñ‹": {"chance": 33, "min": 1, "max": 3}, "Ð²Ð¾Ð´ÐºÐ°": {"chance": 20, "min": 1, "max": 3}, "Ñ€Ð°Ð´Ð¸Ð¾Ð¿Ñ€Ð¾Ñ‚ÐµÐºÑ‚Ð¾Ñ€": {"chance": 10, "min": 1, "max": 3}, "Ð°Ð½Ñ‚Ð¸Ñ€Ð°Ð´": {"chance": 5, "min": 1, "max": 3}, "ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸Ðº Ð½Ð¾Ð½ÑÑ‚Ð¾Ð¿": {"chance": 10, "min": 1, "max": 3}, "ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸Ðº ÑÑ‚Ð°Ð»ÐºÐµÑ€": {"chance": 5, "min": 1, "max": 2}, "Ð³ÐµÑ€ÐºÑƒÐ»ÐµÑ": {"chance": 1, "min": 1, "max": 1}}
DROP_TR = {"Ð”ÐµÐ½ÑŒÐ³Ð¸": {"chance": 29, "min": 5, "max": 30, "type": "money"}, "ÑˆÐ¾ÐºÐ¾Ð»Ð°Ð´Ð½Ñ‹Ð¹ Ð±Ð°Ñ‚Ð¾Ð½Ñ‡Ð¸Ðº": {"chance": 23, "min": 1, "max": 3}, "Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸": {"chance": 30, "min": 1, "max": 15}, "Ñ…Ð»ÐµÐ±": {"chance": 30, "min": 1, "max": 3}, "ÐºÐ¾Ð»Ð±Ð°ÑÐ°": {"chance": 20, "min": 1, "max": 3}, "ÐºÐ¾Ð½ÑÐµÑ€Ð²Ð°": {"chance": 10, "min": 1, "max": 3}, "Ð±Ð¸Ð½Ñ‚": {"chance": 23, "min": 1, "max": 3}, "Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": {"chance": 25, "min": 1, "max": 3}, "Ð°Ñ€Ð¼ÐµÐ¹ÑÐºÐ°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": {"chance": 20, "min": 1, "max": 3}, "Ð½Ð°ÑƒÑ‡Ð½Ð°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": {"chance": 10, "min": 1, "max": 3}, "ÑÐ¸Ð³Ð°Ñ€ÐµÑ‚Ñ‹": {"chance": 23, "min": 1, "max": 3}, "Ð²Ð¾Ð´ÐºÐ°": {"chance": 30, "min": 1, "max": 3}, "Ñ€Ð°Ð´Ð¸Ð¾Ð¿Ñ€Ð¾Ñ‚ÐµÐºÑ‚Ð¾Ñ€": {"chance": 20, "min": 1, "max": 3}, "Ð°Ð½Ñ‚Ð¸Ñ€Ð°Ð´": {"chance": 10, "min": 1, "max": 3}, "ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸Ðº Ð½Ð¾Ð½ÑÑ‚Ð¾Ð¿": {"chance": 15, "min": 1, "max": 3}, "ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸Ðº ÑÑ‚Ð°Ð»ÐºÐµÑ€": {"chance": 10, "min": 1, "max": 2}, "Ð³ÐµÑ€ÐºÑƒÐ»ÐµÑ": {"chance": 5, "min": 1, "max": 1}}
DROP_B = {"Ð”ÐµÐ½ÑŒÐ³Ð¸": {"chance": 30, "min": 5, "max": 45, "type": "money"}, "ÑˆÐ¾ÐºÐ¾Ð»Ð°Ð´Ð½Ñ‹Ð¹ Ð±Ð°Ñ‚Ð¾Ð½Ñ‡Ð¸Ðº": {"chance": 13, "min": 1, "max": 3}, "Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸": {"chance": 30, "min": 1, "max": 20}, "Ñ…Ð»ÐµÐ±": {"chance": 30, "min": 1, "max": 3}, "ÐºÐ¾Ð»Ð±Ð°ÑÐ°": {"chance": 30, "min": 1, "max": 3}, "ÐºÐ¾Ð½ÑÐµÑ€Ð²Ð°": {"chance": 20, "min": 1, "max": 3}, "Ð±Ð¸Ð½Ñ‚": {"chance": 9, "min": 1, "max": 3}, "Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": {"chance": 13, "min": 1, "max": 3}, "Ð°Ñ€Ð¼ÐµÐ¹ÑÐºÐ°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": {"chance": 13, "min": 1, "max": 3}, "Ð½Ð°ÑƒÑ‡Ð½Ð°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°": {"chance": 13, "min": 1, "max": 3}, "ÑÐ¸Ð³Ð°Ñ€ÐµÑ‚Ñ‹": {"chance": 13, "min": 1, "max": 3}, "Ð²Ð¾Ð´ÐºÐ°": {"chance": 30, "min": 1, "max": 3}, "Ñ€Ð°Ð´Ð¸Ð¾Ð¿Ñ€Ð¾Ñ‚ÐµÐºÑ‚Ð¾Ñ€": {"chance": 25, "min": 1, "max": 3}, "Ð°Ð½Ñ‚Ð¸Ñ€Ð°Ð´": {"chance": 20, "min": 1, "max": 3}, "ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸Ðº Ð½Ð¾Ð½ÑÑ‚Ð¾Ð¿": {"chance": 10, "min": 1, "max": 3}, "ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸Ðº ÑÑ‚Ð°Ð»ÐºÐµÑ€": {"chance": 5, "min": 1, "max": 2}, "Ð³ÐµÑ€ÐºÑƒÐ»ÐµÑ": {"chance": 5, "min": 1, "max": 1}}
DROP_POLYANA_T = {"Ð¶ÐµÐ»ÑƒÐ´ÑŒ": {"chance": 5, "min": 1, "max": 1}}
GAME_INFO_TEXT = "ðŸŒŒ Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ð—Ð¾Ð½Ñƒ, ÑÑ‚Ð°Ð»ÐºÐµÑ€!\n\nÐ­Ñ‚Ð¾ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð°Ñ RPG Ð¿Ð¾ Ð¼Ð¾Ñ‚Ð¸Ð²Ð°Ð¼ S.T.A.L.K.E.R. Ð—Ð´ÐµÑÑŒ Ñ‚ÐµÐ±Ðµ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð¾Ð¸Ñ‚ Ð²Ñ‹Ð¶Ð¸Ð²Ð°Ñ‚ÑŒ, Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÑŒ Ð°Ð½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ‚ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸, Ð¾Ñ…Ð¾Ñ‚Ð¸Ñ‚ÑŒÑÑ Ð½Ð° Ð¼ÑƒÑ‚Ð°Ð½Ñ‚Ð¾Ð² Ð¸ ÑÑ€Ð°Ð¶Ð°Ñ‚ÑŒÑÑ Ð·Ð° Ñ‚ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸ ÑÐ²Ð¾ÐµÐ¹ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¸.\n\nðŸ›ï¸ Ð“Ð Ð£ÐŸÐŸÐ˜Ð ÐžÐ’ÐšÐ˜\n\nÐ’ Ð¸Ð³Ñ€Ðµ Ñ‚Ñ€Ð¸ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¸: Ð”Ð¾Ð»Ð³, Ð“Ñ€ÐµÑ… Ð¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸. ÐšÐ°Ð¶Ð´Ð°Ñ Ð¸Ð¼ÐµÐµÑ‚ ÑÐ²Ð¾Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ð¾Ð²Ñ‹Ðµ Ñ‚ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸ Ð¸ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ½Ð°Ñ€ÑÐ¶ÐµÐ½Ð¸Ðµ. ÐŸÐ¾ÑÐ»Ðµ Ð²Ñ‹Ð±Ð¾Ñ€Ð° Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¸ Ñ‚Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑˆÑŒ ÑÑ‚Ð°Ñ€Ñ‚Ð¾Ð²ÑƒÑŽ Ð»Ð¾ÐºÐ°Ñ†Ð¸ÑŽ Ð¸ Ð¼Ð¾Ð¶ÐµÑˆÑŒ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð¸Ð³Ñ€Ñƒ.\n\nðŸ“Š Ð¥ÐÐ ÐÐšÐ¢Ð•Ð Ð˜Ð¡Ð¢Ð˜ÐšÐ˜\n\nÂ· â¤ï¸ Ð—Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ: Ð¿Ñ€Ð¸ Ð´Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ð¸ 0 Ñ‚Ñ‹ ÑƒÐ¼Ð¸Ñ€Ð°ÐµÑˆÑŒ Ð¸ Ñ‚ÐµÑ€ÑÐµÑˆÑŒ Ñ‡Ð°ÑÑ‚ÑŒ Ð²ÐµÑ‰ÐµÐ¹\nÂ· â˜¢ï¸ Ð Ð°Ð´Ð¸Ð°Ñ†Ð¸Ñ: Ð¿Ñ€Ð¸ Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼Ðµ Ð½Ð°Ð½Ð¾ÑÐ¸Ñ‚ ÑƒÑ€Ð¾Ð½ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑŽ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ…Ð¾Ð´\nÂ· ðŸ– Ð“Ð¾Ð»Ð¾Ð´: Ð¿Ñ€Ð¸ Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼Ðµ ÑÐ½Ð¸Ð¶Ð°ÐµÑ‚ Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ Ð¸ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ\nÂ· âš¡ Ð’Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ: Ñ‚Ñ€Ð°Ñ‚Ð¸Ñ‚ÑÑ Ð½Ð° Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¸ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ñ‹, Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð¾Ñ‚Ð´Ñ‹Ñ…Ð¾Ð¼\n\nðŸŽ’ Ð˜ÐÐ’Ð•ÐÐ¢ÐÐ Ð¬ Ð˜ ÐŸÐ Ð•Ð”ÐœÐ•Ð¢Ð«\n\nÐ’ Ñ€ÑŽÐºÐ·Ð°ÐºÐµ Ñ…Ñ€Ð°Ð½ÑÑ‚ÑÑ Ð²ÑÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ñ‹.\n\nÂ· ðŸž Ð•Ð´Ð° ÑÐ½Ð¸Ð¶Ð°ÐµÑ‚ Ð³Ð¾Ð»Ð¾Ð´\nÂ· ðŸ’Š ÐœÐµÐ´Ð¸ÐºÐ°Ð¼ÐµÐ½Ñ‚Ñ‹ Ð»ÐµÑ‡Ð°Ñ‚ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ\nÂ· ðŸ§ª ÐÐ½Ñ‚Ð¸Ñ€Ð°Ð´ Ð²Ñ‹Ð²Ð¾Ð´Ð¸Ñ‚ Ñ€Ð°Ð´Ð¸Ð°Ñ†Ð¸ÑŽ\nÂ· ðŸ”‹ Ð­Ð½ÐµÑ€Ð³ÐµÑ‚Ð¸ÐºÐ¸ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÑŽÑ‚ Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ\nÂ· ðŸ”Œ Ð‘Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸ Ð½ÑƒÐ¶Ð½Ñ‹ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¾Ð² Ð¼ÐµÐ¶Ð´Ñƒ Ñ‚Ð¾Ñ‡ÐºÐ°Ð¼Ð¸\n\nðŸ›¡ï¸ Ð¡ÐÐÐ Ð¯Ð–Ð•ÐÐ˜Ð•\n\nÂ· ðŸ”« ÐžÑ€ÑƒÐ¶Ð¸Ðµ: Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚ ÑƒÑ€Ð¾Ð½ Ð¸ Ñ‚Ð¾Ñ‡Ð½Ð¾ÑÑ‚ÑŒ Ð² Ð±Ð¾ÑŽ Ñ Ð¼ÑƒÑ‚Ð°Ð½Ñ‚Ð°Ð¼Ð¸\nÂ· ðŸ¦º Ð‘Ñ€Ð¾Ð½Ñ: Ð·Ð°Ñ‰Ð¸Ñ‰Ð°ÐµÑ‚ Ð¾Ñ‚ ÑƒÑ€Ð¾Ð½Ð° Ð¼ÑƒÑ‚Ð°Ð½Ñ‚Ð¾Ð² Ð¸ Ð°Ð½Ð¾Ð¼Ð°Ð»Ð¸Ð¹\nÂ· ðŸ“¡ Ð”ÐµÑ‚ÐµÐºÑ‚Ð¾Ñ€: Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð¸ÑÐºÐ°Ñ‚ÑŒ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ Ð² Ð°Ð½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ð·Ð¾Ð½Ð°Ñ…\n\nðŸ—ºï¸ Ð›ÐžÐšÐÐ¦Ð˜Ð˜ Ð˜ Ð¢ÐžÐ§ÐšÐ˜\n\nÐ—Ð¾Ð½Ð° Ñ€Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ð° Ð½Ð° 4 Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸:\n\n1. ÐšÐ¾Ñ€Ð´Ð¾Ð½ \n2. Ð¡Ð²Ð°Ð»ÐºÐ° \n3. Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°\n4. ÐŸÐ¾Ð»ÑÐ½Ð° \n\nÐšÐ°Ð¶Ð´Ð°Ñ Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ñ‚Ð¾Ñ‡ÐºÐ¸ Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ñ‚Ð¸Ð¿Ð¾Ð²:\n\nÂ· ðŸ  Ð‘Ð°Ð·Ñ‹: Ð¼Ð½Ð¾Ð³Ð¾ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð², Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº ÑÐºÐ»Ð°Ð´Ñƒ\nÂ· ðŸ“¦ Ð¢Ð¾Ñ‡ÐºÐ¸ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²: ÑÑ€ÐµÐ´Ð½Ð¸Ð¹ Ð»ÑƒÑ‚\nÂ· ðŸ—ºï¸ Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸: Ð±Ð°Ð·Ð¾Ð²Ñ‹Ð¹ Ð»ÑƒÑ‚\nÂ· ðŸ¾ Ð›Ð¾Ð³Ð¾Ð²Ð°: Ð¾Ñ…Ð¾Ñ‚Ð° Ð½Ð° Ð¼ÑƒÑ‚Ð°Ð½Ñ‚Ð¾Ð² Ð·Ð° Ð´ÐµÐ½ÑŒÐ³Ð¸\nÂ· âš¡ ÐÐ½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð·Ð¾Ð½Ñ‹: Ð¿Ð¾Ð¸ÑÐº Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²\n\nðŸš¶ ÐŸÐ•Ð Ð•Ð¥ÐžÐ”Ð«\n\nÐ”Ð»Ñ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð° Ð¼ÐµÐ¶Ð´Ñƒ Ñ‚Ð¾Ñ‡ÐºÐ°Ð¼Ð¸ Ð½ÑƒÐ¶Ð½Ñ‹ Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸ Ð¸ Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ. ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð½Ð° Ð´Ñ€ÑƒÐ³ÑƒÑŽ Ð»Ð¾ÐºÐ°Ñ†Ð¸ÑŽ Ð²Ð¾Ð·Ð¼Ð¾Ð¶ÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡ÐµÑ€ÐµÐ· ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ‚Ð¾Ñ‡ÐºÐ¸ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð°.\n\nðŸ” Ð˜Ð¡Ð¡Ð›Ð•Ð”ÐžÐ’ÐÐÐ˜Ð•\n\nÂ· ðŸ” ÐÐ° Ñ‚ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸ÑÑ… Ð¸Ñ‰Ð¸ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ñ‹\nÂ· ðŸº Ð’ Ð»Ð¾Ð³Ð¾Ð²Ð°Ñ… Ð¾Ñ…Ð¾Ñ‚Ð¸ÑÑŒ Ð½Ð° Ð¼ÑƒÑ‚Ð°Ð½Ñ‚Ð¾Ð²\nÂ· âš¡ Ð’ Ð°Ð½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ð·Ð¾Ð½Ð°Ñ… Ð¸Ñ‰Ð¸ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ Ñ Ð´ÐµÑ‚ÐµÐºÑ‚Ð¾Ñ€Ð¾Ð¼\n\nðŸ¾ ÐžÐ¥ÐžÐ¢Ð ÐÐ ÐœÐ£Ð¢ÐÐÐ¢ÐžÐ’\n\nÐ’ Ð»Ð¾Ð³Ð¾Ð²Ð°Ñ… Ð¾Ð±Ð¸Ñ‚Ð°ÑŽÑ‚ Ð¼ÑƒÑ‚Ð°Ð½Ñ‚Ñ‹ Ñ€Ð°Ð·Ð½Ð¾Ð¹ ÑÐ¸Ð»Ñ‹. Ð’ Ð±Ð¾ÑŽ Ñ‚Ñ‹ Ð²Ñ‹Ð±Ð¸Ñ€Ð°ÐµÑˆÑŒ Ð¾Ð´Ð½Ñƒ Ð¸Ð· 9 Ð¼Ð¸ÑˆÐµÐ½ÐµÐ¹. Ð¢Ð¾Ñ‡Ð½Ð¾ÑÑ‚ÑŒ Ð¾Ñ€ÑƒÐ¶Ð¸Ñ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚, ÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¼Ð¸ÑˆÐµÐ½ÐµÐ¹ Ð±ÑƒÐ´ÑƒÑ‚ Ð¿Ð¾Ð¿Ð°Ð´Ð°Ð½Ð¸ÑÐ¼Ð¸. Ð—Ð° ÑƒÐ±Ð¸Ð¹ÑÑ‚Ð²Ð¾ Ð¼ÑƒÑ‚Ð°Ð½Ñ‚Ð° Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑˆÑŒ Ð´ÐµÐ½ÑŒÐ³Ð¸.\n\nâš¡ ÐÐÐžÐœÐÐ›Ð¬ÐÐ«Ð• Ð—ÐžÐÐ«\n\nÐ”Ð»Ñ Ð²Ñ…Ð¾Ð´Ð° Ð½ÑƒÐ¶ÐµÐ½ Ð´ÐµÑ‚ÐµÐºÑ‚Ð¾Ñ€. Ð¢Ñ‹ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰Ð°ÐµÑˆÑŒÑÑ Ð¿Ð¾ ÑÐµÑ‚ÐºÐµ 6x6, Ð¸Ñ‰ÐµÑˆÑŒ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ Ð¸ Ð¸Ð·Ð±ÐµÐ³Ð°ÐµÑˆÑŒ Ð°Ð½Ð¾Ð¼Ð°Ð»Ð¸Ð¹. Ð Ð°Ð·Ð½Ñ‹Ðµ Ð´ÐµÑ‚ÐµÐºÑ‚Ð¾Ñ€Ñ‹ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÑŽÑ‚ Ñ€Ð°Ð·Ð½ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾Ð± Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑÑ….\n\nðŸ’Ž ÐÐ Ð¢Ð•Ð¤ÐÐšÐ¢Ð« Ð˜ ÐŸÐžÐ¯Ð¡\n\nÐÐ°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ð¾Ð²ÐµÑÐ¸Ñ‚ÑŒ Ð½Ð° Ð¿Ð¾ÑÑ (3 ÑÐ»Ð¾Ñ‚Ð°). ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ Ð´Ð°Ñ‘Ñ‚ Ð¿Ð°ÑÑÐ¸Ð²Ð½Ñ‹Ðµ Ð±Ð¾Ð½ÑƒÑÑ‹:\n\nÂ· â¤ï¸ Ð ÐµÐ³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ\nÂ· â˜¢ï¸ Ð’Ñ‹Ð²Ð¾Ð´ Ñ€Ð°Ð´Ð¸Ð°Ñ†Ð¸Ð¸\nÂ· ðŸ›¡ï¸ Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ ÑƒÑ€Ð¾Ð½Ð°\nÂ· âš¡ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚Ð¸\n\nðŸ›’ Ð¢ÐžÐ Ð“ÐžÐ’Ð•Ð¦\n\nÂ· ðŸ›’ ÐŸÐ¾ÐºÑƒÐ¿Ð°Ð¹ Ð¿Ñ€Ð¾Ð²Ð¸Ð·Ð¸ÑŽ Ð¸ ÑÐ½Ð°Ñ€ÑÐ¶ÐµÐ½Ð¸Ðµ Ð·Ð° Ð´ÐµÐ½ÑŒÐ³Ð¸\nÂ· ðŸ’° ÐŸÑ€Ð¾Ð´Ð°Ð²Ð°Ð¹ Ð»Ð¸ÑˆÐ½Ð¸Ðµ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ñ‹ Ð¸ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹\nÂ· ðŸ”§ Ð ÐµÐ¼Ð¾Ð½Ñ‚Ð¸Ñ€ÑƒÐ¹ ÑÐ»Ð¾Ð¼Ð°Ð½Ð½Ð¾Ðµ Ð¾Ñ€ÑƒÐ¶Ð¸Ðµ Ð¸ Ð±Ñ€Ð¾Ð½ÑŽ\n\nâš”ï¸ Ð’ÐžÐ™ÐÐ Ð“Ð Ð£ÐŸÐŸÐ˜Ð ÐžÐ’ÐžÐš\n\nÂ· ðŸ‘¥ ÐŸÐ¾ÐºÑƒÐ¿Ð°Ð¹ ÑÐºÐ²Ð°Ð´Ñ‹ Ð·Ð° Ð´ÐµÐ½ÑŒÐ³Ð¸ Ð¸ Ñ€ÐµÑÑƒÑ€ÑÑ‹\nÂ· âš”ï¸ ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐ¹ Ð¸Ñ… Ð½Ð° Ð·Ð°Ñ…Ð²Ð°Ñ‚ Ñ‚ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹\nÂ· ðŸ›¡ï¸ Ð—Ð°Ñ‰Ð¸Ñ‰Ð°Ð¹ ÑÐ²Ð¾Ð¸ Ñ‚Ð¾Ñ‡ÐºÐ¸ Ð¾Ñ‚ Ð°Ñ‚Ð°Ðº Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²Ð¾Ðº\nÂ· ðŸ”¥ ÐÑ‚Ð°ÐºÑƒÐ¹ Ð»Ð¸Ñ‡Ð½Ð¾ Ð²Ð¼ÐµÑÑ‚Ðµ ÑÐ¾ ÑÐºÐ²Ð°Ð´Ð°Ð¼Ð¸ Ð´Ð»Ñ ÑƒÑÐ¸Ð»ÐµÐ½Ð¸Ñ ÑƒÑ€Ð¾Ð½Ð°\n\nðŸŒªï¸ Ð’Ð«Ð‘Ð ÐžÐ¡\n\nÐ¨ÐºÐ°Ð»Ð° Ð²Ñ‹Ð±Ñ€Ð¾ÑÐ° Ð·Ð°Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ñ ÐºÐ°Ð¶Ð´Ñ‹Ð¼ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸ÐµÐ¼ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð². ÐŸÑ€Ð¸ Ð´Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ð¸ Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼Ð° Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚ Ð²Ñ‹Ð±Ñ€Ð¾Ñ: Ð²ÑÐµ, ÐºÑ‚Ð¾ Ð½Ðµ Ð² ÑƒÐºÑ€Ñ‹Ñ‚Ð¸Ð¸, Ð¿Ð¾Ð³Ð¸Ð±Ð°ÑŽÑ‚, Ð° Ñ‡Ð°ÑÑ‚ÑŒ Ñ‚ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ Ñ€ÐµÑÑƒÑ€ÑÑ‹.\n\nðŸ’Ž Ð”ÐžÐÐÐ¢\n\nÐ”Ð¾Ð½Ð°Ñ‚ÐµÑ€Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÑŽÑ‚ Ð¾ÑÐ¾Ð±Ñ‹Ðµ Ð¿Ñ€ÐµÐ¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð²Ð°:\n\nÂ· ðŸ© ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ \"ÐŸÐ¾Ð½Ñ‡Ð¸Ðº\" Ð¸Ð»Ð¸ \"Ð¡Ñ‚ÐµÐ¹Ðº\"\nÂ· âš¡ Ð£ÑÐºÐ¾Ñ€ÐµÐ½Ð½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ñ‹\nÂ· ðŸ›’ Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ñ‚Ð¾Ñ€Ð³Ð¾Ð²Ñ†Ñƒ Ð²ÐµÐ·Ð´Ðµ\nÂ· ðŸ›¡ï¸ Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð° Ð¾Ñ‚ Ð¿Ð¾Ñ‚ÐµÑ€Ð¸\n\nÐ£Ð´Ð°Ñ‡Ð½Ð¾Ð¹ Ð¾Ñ…Ð¾Ñ‚Ñ‹, ÑÑ‚Ð°Ð»ÐºÐµÑ€! Ð’Ñ‹Ð¶Ð¸Ð²Ð¸ Ð¸ ÑÑ‚Ð°Ð½ÑŒ Ð»ÐµÐ³ÐµÐ½Ð´Ð¾Ð¹ Ð—Ð¾Ð½Ñ‹. ðŸºâš¡"
MAIN_MENU_TEXT = "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ:\n\nðŸ’¡ ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° \"2604\" Ð±Ñ‹ÑÑ‚Ñ€Ð¾ Ð²ÐµÑ€Ð½Ñ‘Ñ‚ Ð²Ð°Ñ Ð² Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ\n\nâ“ ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¸Ð³Ñ€Ñ‹ Ð¿Ð¾ ÐºÐ¾Ð¼Ð°Ð½Ð´Ðµ \"Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ\"\n\nÂ«ðŸ•ï¸ Ð›Ð°Ð³ÐµÑ€ÑŒ - Ð¼ÐµÑÑ‚Ð¾ Ð²Ð°ÑˆÐµÐ³Ð¾ ÑƒÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð¸ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nÂ«ðŸ‘£ ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ - Ð¿ÐµÑ€ÐµÐ´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ðµ Ð¿Ð¾ Ð»Ð¾ÐºÐ°Ñ†Ð¸ÑÐ¼\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nÂ«ðŸ”Ž Ð˜ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ - Ð¿Ð¾Ð¸ÑÐº Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð² Ð¸ Ð¼Ð¾Ð±Ð¾Ð² \nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nÂ«ðŸ›’ Ð¢Ð¾Ñ€Ð³Ð¾Ð²ÐµÑ† - Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð° Ð¸ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ° Ð²ÐµÑ‰ÐµÐ¹\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nÂ«âš”ï¸ Ð’Ð¾Ð¹Ð½Ð° Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²Ð¾Ðº - Ð·Ð°Ñ…Ð²Ð°Ñ‚ Ñ‚ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐºÐ²Ð°Ð´Ð°Ð¼Ð¸"
MUTANTS = {"Ñ‚ÑƒÑˆÐºÐ°Ð½Ñ‡Ð¸Ðº": [{"name": "Ð¡Ð»Ð°Ð±Ñ‹Ð¹ Ñ‚ÑƒÑˆÐºÐ°Ð½Ñ‡Ð¸Ðº", "hp": 1, "damage": 0.5, "reward": 5}, {"name": "ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹ Ñ‚ÑƒÑˆÐºÐ°Ð½Ñ‡Ð¸Ðº", "hp": 1.5, "damage": 1, "reward": 10}, {"name": "ÐœÐ°Ñ‚Ñ‘Ñ€Ñ‹Ð¹ Ñ‚ÑƒÑˆÐºÐ°Ð½Ñ‡Ð¸Ðº", "hp": 2, "damage": 1.5, "reward": 15}], "ÑÐ»ÐµÐ¿Ð¾Ð¹ Ð¿Ñ‘Ñ": [{"name": "Ð¡Ð»Ð°Ð±Ñ‹Ð¹ ÑÐ»ÐµÐ¿Ð¾Ð¹ Ð¿Ñ‘Ñ", "hp": 2.5, "damage": 1.5, "reward": 15}, {"name": "ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹ ÑÐ»ÐµÐ¿Ð¾Ð¹ Ð¿Ñ‘Ñ", "hp": 2.5, "damage": 2, "reward": 20}, {"name": "ÐœÐ°Ñ‚Ñ‘Ñ€Ñ‹Ð¹ ÑÐ»ÐµÐ¿Ð¾Ð¹ Ð¿Ñ‘Ñ", "hp": 3, "damage": 2.5, "reward": 25}], "Ð¿ÑÐµÐ²Ð´Ð¾Ð¿Ñ‘Ñ": [{"name": "Ð¡Ð»Ð°Ð±Ñ‹Ð¹ Ð¿ÑÐµÐ²Ð´Ð¾Ð¿Ñ‘Ñ", "hp": 3.5, "damage": 3.5, "reward": 35}, {"name": "ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹ Ð¿ÑÐµÐ²Ð´Ð¾Ð¿Ñ‘Ñ", "hp": 3.5, "damage": 4, "reward": 40}, {"name": "ÐœÐ°Ñ‚Ñ‘Ñ€Ñ‹Ð¹ Ð¿ÑÐµÐ²Ð´Ð¾Ð¿Ñ‘Ñ", "hp": 4, "damage": 4, "reward": 45}], "Ð¿Ð»Ð¾Ñ‚ÑŒ": [{"name": "Ð¡Ð»Ð°Ð±Ð°Ñ Ð¿Ð»Ð¾Ñ‚ÑŒ", "hp": 4, "damage": 2.5, "reward": 25}, {"name": "ÐžÐ±Ñ‹Ñ‡Ð½Ð°Ñ Ð¿Ð»Ð¾Ñ‚ÑŒ", "hp": 4.5, "damage": 3, "reward": 30}, {"name": "ÐœÐ°Ñ‚Ñ‘Ñ€Ð°Ñ Ð¿Ð»Ð¾Ñ‚ÑŒ", "hp": 5, "damage": 3, "reward": 35}], "ÐºÐ°Ð±Ð°Ð½": [{"name": "Ð¡Ð»Ð°Ð±Ñ‹Ð¹ ÐºÐ°Ð±Ð°Ð½", "hp": 4, "damage": 3, "reward": 30}, {"name": "ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹ ÐºÐ°Ð±Ð°Ð½", "hp": 4.5, "damage": 3.5, "reward": 35}, {"name": "ÐœÐ°Ñ‚Ñ‘Ñ€Ñ‹Ð¹ ÐºÐ°Ð±Ð°Ð½", "hp": 5, "damage": 4, "reward": 40}], "ÐºÑ€Ð¾Ð²Ð¾ÑÐ¾Ñ": [{"name": "Ð¡Ð»Ð°Ð±Ñ‹Ð¹ ÐºÑ€Ð¾Ð²Ð¾ÑÐ¾Ñ", "hp": 5, "damage": 4, "reward": 40}, {"name": "ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹ ÐºÑ€Ð¾Ð²Ð¾ÑÐ¾Ñ", "hp": 6, "damage": 4.5, "reward": 45}, {"name": "ÐœÐ°Ñ‚Ñ‘Ñ€Ñ‹Ð¹ ÐºÑ€Ð¾Ð²Ð¾ÑÐ¾Ñ", "hp": 7, "damage": 4.5, "reward": 50}]}
MUTANT_SPAWN_CHANCES = {"ÐšÐ¾Ñ€Ð´Ð¾Ð½": {"Ð›1": {"Ñ‚ÑƒÑˆÐºÐ°Ð½Ñ‡Ð¸Ðº": 20, "ÑÐ»ÐµÐ¿Ð¾Ð¹ Ð¿Ñ‘Ñ": 5, "Ð¿ÑÐµÐ²Ð´Ð¾Ð¿Ñ‘Ñ": 0, "Ð¿Ð»Ð¾Ñ‚ÑŒ": 10, "ÐºÐ°Ð±Ð°Ð½": 15, "ÐºÑ€Ð¾Ð²Ð¾ÑÐ¾Ñ": 0}, "Ð›2": {"Ñ‚ÑƒÑˆÐºÐ°Ð½Ñ‡Ð¸Ðº": 15, "ÑÐ»ÐµÐ¿Ð¾Ð¹ Ð¿Ñ‘Ñ": 20, "Ð¿ÑÐµÐ²Ð´Ð¾Ð¿Ñ‘Ñ": 0, "Ð¿Ð»Ð¾Ñ‚ÑŒ": 5, "ÐºÐ°Ð±Ð°Ð½": 20, "ÐºÑ€Ð¾Ð²Ð¾ÑÐ¾Ñ": 0}, "Ð›3": {"Ñ‚ÑƒÑˆÐºÐ°Ð½Ñ‡Ð¸Ðº": 10, "ÑÐ»ÐµÐ¿Ð¾Ð¹ Ð¿Ñ‘Ñ": 20, "Ð¿ÑÐµÐ²Ð´Ð¾Ð¿Ñ‘Ñ": 10, "Ð¿Ð»Ð¾Ñ‚ÑŒ": 10, "ÐºÐ°Ð±Ð°Ð½": 15, "ÐºÑ€Ð¾Ð²Ð¾ÑÐ¾Ñ": 0}, "Ð›4": {"Ñ‚ÑƒÑˆÐºÐ°Ð½Ñ‡Ð¸Ðº": 10, "ÑÐ»ÐµÐ¿Ð¾Ð¹ Ð¿Ñ‘Ñ": 20, "Ð¿ÑÐµÐ²Ð´Ð¾Ð¿Ñ‘Ñ": 15, "Ð¿Ð»Ð¾Ñ‚ÑŒ": 10, "ÐºÐ°Ð±Ð°Ð½": 15, "ÐºÑ€Ð¾Ð²Ð¾ÑÐ¾Ñ": 0}, "Ð›5": {"Ñ‚ÑƒÑˆÐºÐ°Ð½Ñ‡Ð¸Ðº": 5, "ÑÐ»ÐµÐ¿Ð¾Ð¹ Ð¿Ñ‘Ñ": 25, "Ð¿ÑÐµÐ²Ð´Ð¾Ð¿Ñ‘Ñ": 15, "Ð¿Ð»Ð¾Ñ‚ÑŒ": 10, "ÐºÐ°Ð±Ð°Ð½": 15, "ÐºÑ€Ð¾Ð²Ð¾ÑÐ¾Ñ": 0}}, "Ð¡Ð²Ð°Ð»ÐºÐ°": {"Ð›1": {"Ñ‚ÑƒÑˆÐºÐ°Ð½Ñ‡Ð¸Ðº": 20, "ÑÐ»ÐµÐ¿Ð¾Ð¹ Ð¿Ñ‘Ñ": 15, "Ð¿ÑÐµÐ²Ð´Ð¾Ð¿Ñ‘Ñ": 10, "Ð¿Ð»Ð¾Ñ‚ÑŒ": 5, "ÐºÐ°Ð±Ð°Ð½": 5, "ÐºÑ€Ð¾Ð²Ð¾ÑÐ¾Ñ": 0}, "Ð›2": {"Ñ‚ÑƒÑˆÐºÐ°Ð½Ñ‡Ð¸Ðº": 10, "ÑÐ»ÐµÐ¿Ð¾Ð¹ Ð¿Ñ‘Ñ": 20, "Ð¿ÑÐµÐ²Ð´Ð¾Ð¿Ñ‘Ñ": 15, "Ð¿Ð»Ð¾Ñ‚ÑŒ": 5, "ÐºÐ°Ð±Ð°Ð½": 5, "ÐºÑ€Ð¾Ð²Ð¾ÑÐ¾Ñ": 0}, "Ð›3": {"Ñ‚ÑƒÑˆÐºÐ°Ð½Ñ‡Ð¸Ðº": 15, "ÑÐ»ÐµÐ¿Ð¾Ð¹ Ð¿Ñ‘Ñ": 20, "Ð¿ÑÐµÐ²Ð´Ð¾Ð¿Ñ‘Ñ": 10, "Ð¿Ð»Ð¾Ñ‚ÑŒ": 10, "ÐºÐ°Ð±Ð°Ð½": 10, "ÐºÑ€Ð¾Ð²Ð¾ÑÐ¾Ñ": 0}, "Ð›4": {"Ñ‚ÑƒÑˆÐºÐ°Ð½Ñ‡Ð¸Ðº": 10, "ÑÐ»ÐµÐ¿Ð¾Ð¹ Ð¿Ñ‘Ñ": 10, "Ð¿ÑÐµÐ²Ð´Ð¾Ð¿Ñ‘Ñ": 0, "Ð¿Ð»Ð¾Ñ‚ÑŒ": 30, "ÐºÐ°Ð±Ð°Ð½": 10, "ÐºÑ€Ð¾Ð²Ð¾ÑÐ¾Ñ": 0}}, "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°": {"Ð›1": {"Ñ‚ÑƒÑˆÐºÐ°Ð½Ñ‡Ð¸Ðº": 5, "ÑÐ»ÐµÐ¿Ð¾Ð¹ Ð¿Ñ‘Ñ": 10, "Ð¿ÑÐµÐ²Ð´Ð¾Ð¿Ñ‘Ñ": 20, "Ð¿Ð»Ð¾Ñ‚ÑŒ": 0, "ÐºÐ°Ð±Ð°Ð½": 5, "ÐºÑ€Ð¾Ð²Ð¾ÑÐ¾Ñ": 15}, "Ð›2": {"Ñ‚ÑƒÑˆÐºÐ°Ð½Ñ‡Ð¸Ðº": 10, "ÑÐ»ÐµÐ¿Ð¾Ð¹ Ð¿Ñ‘Ñ": 5, "Ð¿ÑÐµÐ²Ð´Ð¾Ð¿Ñ‘Ñ": 5, "Ð¿Ð»Ð¾Ñ‚ÑŒ": 15, "ÐºÐ°Ð±Ð°Ð½": 10, "ÐºÑ€Ð¾Ð²Ð¾ÑÐ¾Ñ": 5}, "Ð›3": {"Ñ‚ÑƒÑˆÐºÐ°Ð½Ñ‡Ð¸Ðº": 15, "ÑÐ»ÐµÐ¿Ð¾Ð¹ Ð¿Ñ‘Ñ": 10, "Ð¿ÑÐµÐ²Ð´Ð¾Ð¿Ñ‘Ñ": 15, "Ð¿Ð»Ð¾Ñ‚ÑŒ": 5, "ÐºÐ°Ð±Ð°Ð½": 10, "ÐºÑ€Ð¾Ð²Ð¾ÑÐ¾Ñ": 5}, "Ð›4": {"Ñ‚ÑƒÑˆÐºÐ°Ð½Ñ‡Ð¸Ðº": 15, "ÑÐ»ÐµÐ¿Ð¾Ð¹ Ð¿Ñ‘Ñ": 20, "Ð¿ÑÐµÐ²Ð´Ð¾Ð¿Ñ‘Ñ": 15, "Ð¿Ð»Ð¾Ñ‚ÑŒ": 5, "ÐºÐ°Ð±Ð°Ð½": 10, "ÐºÑ€Ð¾Ð²Ð¾ÑÐ¾Ñ": 0}}, "ÐŸÐ¾Ð»ÑÐ½Ð°": {"Ð›1": {"Ñ‚ÑƒÑˆÐºÐ°Ð½Ñ‡Ð¸Ðº": 15, "ÑÐ»ÐµÐ¿Ð¾Ð¹ Ð¿Ñ‘Ñ": 10, "Ð¿ÑÐµÐ²Ð´Ð¾Ð¿Ñ‘Ñ": 15, "Ð¿Ð»Ð¾Ñ‚ÑŒ": 10, "ÐºÐ°Ð±Ð°Ð½": 10, "ÐºÑ€Ð¾Ð²Ð¾ÑÐ¾Ñ": 5}, "Ð›2": {"Ñ‚ÑƒÑˆÐºÐ°Ð½Ñ‡Ð¸Ðº": 15, "ÑÐ»ÐµÐ¿Ð¾Ð¹ Ð¿Ñ‘Ñ": 20, "Ð¿ÑÐµÐ²Ð´Ð¾Ð¿Ñ‘Ñ": 10, "Ð¿Ð»Ð¾Ñ‚ÑŒ": 10, "ÐºÐ°Ð±Ð°Ð½": 10, "ÐºÑ€Ð¾Ð²Ð¾ÑÐ¾Ñ": 0}}}
ARTIFACT_INFO_TEXT = "ðŸ’¡ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾Ð± Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð°Ñ…: \n \nâž– Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ:\n \nðŸŒ’ ÐšÑ€Ð¾Ð²ÑŒ ÐºÐ°Ð¼Ð½Ñ +0.25â¤ï¸\nðŸŒ“ Ð›Ð¾Ð¼Ð¾Ñ‚ÑŒ Ð¼ÑÑÐ° +0.5â¤ï¸\nðŸŒ” Ð”ÑƒÑˆÐ° +0.75â¤ï¸\nðŸŒ• Ð¡Ð²ÐµÑ‚Ð»ÑÐº +1â¤ï¸\n \nâž– Ð’Ñ‹Ð²Ð¾Ð´ Ñ€Ð°Ð´Ð¸Ð°Ñ†Ð¸Ð¸:\n \nðŸŒ’ ÐšÐ¾Ð»Ð¾Ð±Ð¾Ðº -0.25â˜¢ï¸\nðŸŒ“ ÐœÐµÐ´ÑƒÐ·Ð° -0.5â˜¢ï¸\nðŸŒ” Ð¡Ð»Ð¸Ð·Ð½ÑÐº -0.75â˜¢ï¸\nðŸŒ• ÐŸÑƒÐ·Ñ‹Ñ€ÑŒ -1â˜¢ï¸\n \nâž– Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸Ð» Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð´Ñ‹Ñ…Ðµ: \n \nðŸŒ’ Ð’ÑÐ¿Ñ‹ÑˆÐºÐ° +0.5âš¡\nðŸŒ“ Ð¡Ð½ÐµÐ¶Ð¸Ð½ÐºÐ° +1âš¡\nðŸŒ” Ð›ÑƒÐ½Ð½Ñ‹Ð¹ ÑÐ²ÐµÑ‚ +1.5âš¡\nðŸŒ• Ð‘Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ° +2âš¡\n \nâž– Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ Ñ€Ð°Ð·Ñ€Ñ‹Ð²Ð°:\n \nðŸŒ’ Ð‘ÐµÐ½Ð³Ð°Ð»ÑŒÑÐºÐ¸Ð¹ Ð¾Ð³Ð¾Ð½ÑŒ +0.25ðŸ¾\nðŸŒ“ Ð’Ñ‹Ð²ÐµÑ€Ñ‚ +0.5ðŸ¾\nðŸŒ” Ð“Ñ€Ð°Ð²Ð¸ +0.75ðŸ¾\nðŸŒ• Ð—Ð¾Ð»Ð¾Ñ‚Ð°Ñ Ñ€Ñ‹Ð±ÐºÐ° +1ðŸ¾\n \nâž– ÐŸÑƒÐ»ÐµÑÑ‚Ð¾Ð¹ÐºÐ¾ÑÑ‚ÑŒ:\n \nðŸŒ’ ÐŸÑƒÑÑ‚Ñ‹ÑˆÐºÐ° +0.5ðŸ›¡ï¸\nðŸŒ“ ÐšÐ°Ð¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ†Ð²ÐµÑ‚Ð¾Ðº +1ðŸ›¡ï¸\nðŸŒ” ÐÐ¾Ñ‡Ð½Ð°Ñ Ð·Ð²ÐµÐ·Ð´Ð° +1.5ðŸ›¡ï¸\nðŸŒ• ÐšÑ€Ð¸ÑÑ‚Ð°Ð»Ð» +2ðŸ›¡ï¸\n \nâž– ÐÐ½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð°Ñ‰Ð¸Ñ‚Ð°:\n \nðŸŒ’ ÐšÐ¾Ð»ÑŽÑ‡ÐºÐ° +0.25ðŸ’¥\nðŸŒ“ ÐŸÐ»Ð°Ð¼Ñ +0.5ðŸ’¥\nðŸŒ” ÐžÐ³Ð½ÐµÐ½Ð½Ñ‹Ð¹ ÑˆÐ°Ñ€ +0.75ðŸ’¥\nðŸŒ• ÐŸÐ»Ñ‘Ð½ÐºÐ° +1ðŸ’¥\n \nâž– ÐÐ°Ð½ÐµÑÐµÐ½Ð¸Ðµ ÑƒÑ€Ð¾Ð½Ð°:\n \nðŸŒ’ Ð“Ð»Ð°Ð· +0.5ðŸ’¢\nðŸŒ“ ÐšÐ°Ð¿Ð»Ð¸ +1ðŸ’¢\nðŸŒ” ÐšÑ€Ð¸ÑÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ ÐºÐ¾Ð»ÑŽÑ‡ÐºÐ° +1.5ðŸ’¢\nðŸŒ• ÐŸÑ€ÑƒÐ¶Ð¸Ð½Ð° +2ðŸ’¢\n \nâž– Ð¢Ð¾Ñ‡Ð½Ð¾ÑÑ‚ÑŒ Ð¿Ð¾Ð¿Ð°Ð´Ð°Ð½Ð¸Ñ: \n \nðŸŒ’ Ð¡Ð»Ð¸Ð·ÑŒ +0.5ðŸŽ¯\nðŸŒ“ Ð¡Ð»ÑŽÐ´Ð° +1ðŸŽ¯\nðŸŒ” ÐœÐ°Ð¼Ð¸Ð½Ñ‹ Ð±ÑƒÑÑ‹ +1.5ðŸŽ¯\nðŸŒ• ÐœÐ¾Ñ€ÑÐºÐ¾Ð¹ Ñ‘Ð¶ +2ðŸŽ¯"
EXHAUSTION_LIMITS = {"Ð‘Ð°Ð·Ð°": 200,"Ð¢Ð¾Ñ‡ÐºÐ° Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²": 150,"Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ": 100,"Ð›Ð¾Ð³Ð¾Ð²Ð¾": 30, "ÐÐ½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð¾Ð½Ð°": 10}
GAME_CHAT_ID = 2000000005 
shared_warehouse = {}
territory_control = {}
faction_leaders = {}
territory_exhaustion = {}
emission_schedule = []
emission_warned = []
last_restored_categories = []
def generate_emission_schedule():
    global emission_schedule, emission_warned
    now = time.time()
    emission_schedule = [t for t in emission_schedule if t > now]
    if emission_schedule:
        return
    moscow_offset = 3 * 3600
    moscow_now = now + moscow_offset
    moscow_midnight = moscow_now - (moscow_now % 86400)
    utc_midnight = moscow_midnight - moscow_offset
    for day_offset in range(3):
        day_start = utc_midnight + day_offset * 86400
        window_start = day_start + 8 * 3600
        window_end = day_start + 23 * 3600
        if window_end <= now:
            continue
        effective_start = max(window_start, now + 900)
        if effective_start >= window_end:
            continue
        num = random.randint(2, 4)
        day_times = []
        for _ in range(200):
            t = random.uniform(effective_start, window_end)
            ok = True
            for existing in day_times:
                if abs(t - existing) < 7200:
                    ok = False
                    break
            if ok:
                day_times.append(t)
            if len(day_times) >= num:
                break
        emission_schedule.extend(day_times)
        break
    emission_schedule.sort()
    emission_warned = []
    save_data()
def get_next_emission_time():
    now = time.time()
    for t in emission_schedule:
        if t > now:
            return t
    return None
def check_emissions(vk_session):
    global emission_schedule, emission_warned
    now = time.time()
    if not emission_schedule:
        generate_emission_schedule()
        return
    for emission_time in list(emission_schedule):
        remaining = emission_time - now
        if remaining <= 0:
            trigger_emission(vk_session)
            if emission_time in emission_schedule:
                emission_schedule.remove(emission_time)
            if emission_time in emission_warned:
                emission_warned.remove(emission_time)
            save_data()
            if not emission_schedule:
                generate_emission_schedule()
            return
        elif remaining <= 600 and emission_time not in emission_warned:
            emission_warned.append(emission_time)
            mins_left = int(remaining // 60)
            for uid in players:
                if uid in banned_users:
                    continue
                p = players[uid]
                faction = p.get("faction")
                if not faction or faction == "None" or faction is None:
                    continue
                state = p.get("state")
                if state in [STATE_WAITING_FOR_START, STATE_READING_INSTRUCTIONS, STATE_CHOOSING_FACTION, STATE_ENTERING_NICKNAME]:
                    continue
                send_message(uid, f"âš ï¸ Ð’ÐÐ˜ÐœÐÐÐ˜Ð•! Ð’Ñ‹Ð±Ñ€Ð¾Ñ Ñ‡ÐµÑ€ÐµÐ· ~{mins_left} Ð¼Ð¸Ð½ÑƒÑ‚! Ð£ÐºÑ€Ð¾Ð¹Ñ‚ÐµÑÑŒ Ð² Ð»Ð°Ð³ÐµÑ€Ðµ!", None, vk_session)
            save_data()
            return
faction_shared_squads = {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": 0, "â˜¦ï¸ Ð“Ñ€ÐµÑ…": 0, "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": 0}
banned_users = {}
admin_users = []
shared_warehouse_money = 0
def init_database():
    conn = None
    try:
        conn = sqlite3.connect(str(DB_PATH))
        cursor = conn.cursor()
        cursor.execute('''CREATE TABLE IF NOT EXISTS players (
            user_id INTEGER PRIMARY KEY,
            data TEXT NOT NULL
        )''')
        cursor.execute('''CREATE TABLE IF NOT EXISTS game_state (
            key TEXT PRIMARY KEY,
            value TEXT NOT NULL
        )''')
        conn.commit()
        conn.close()
        logger.info(f"Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°: {DB_PATH}")
    except sqlite3.DatabaseError as e:
        logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…: {e}")
        if conn:
            conn.close()
        if os.path.exists(DB_PATH):
            os.remove(DB_PATH)
            logger.info("ÐŸÐ¾Ð²Ñ€ÐµÐ¶Ð´Ñ‘Ð½Ð½Ð°Ñ Ð±Ð°Ð·Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ð°, ÑÐ¾Ð·Ð´Ð°Ñ‘Ð¼ Ð½Ð¾Ð²ÑƒÑŽ...")
            conn = sqlite3.connect(str(DB_PATH))
            cursor = conn.cursor()
            cursor.execute('''CREATE TABLE IF NOT EXISTS players (
                user_id INTEGER PRIMARY KEY,
                data TEXT NOT NULL
            )''')
            cursor.execute('''CREATE TABLE IF NOT EXISTS game_state (
                key TEXT PRIMARY KEY,
                value TEXT NOT NULL
            )''')
            conn.commit()
            conn.close()
            logger.info("ÐÐ¾Ð²Ð°Ñ Ð±Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐ¾Ð·Ð´Ð°Ð½Ð°")
def create_start_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("Ð¡Ñ‚Ð°Ñ€Ñ‚", color=VkKeyboardColor.POSITIVE)
    return k
def create_next_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("Ð”Ð°Ð»ÐµÐµ", color=VkKeyboardColor.PRIMARY)
    return k
def create_faction_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button(f"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³ ({len(factions['ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³'])}/{MAX_FACTION_SIZES['ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³']})", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button(f"â˜¦ï¸ Ð“Ñ€ÐµÑ… ({len(factions['â˜¦ï¸ Ð“Ñ€ÐµÑ…'])}/{MAX_FACTION_SIZES['â˜¦ï¸ Ð“Ñ€ÐµÑ…']})", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button(f"â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸ ({len(factions['â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸'])}/{MAX_FACTION_SIZES['â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸']})", color=VkKeyboardColor.POSITIVE)
    return k
def get_main_menu_button(point, location=None):
    ptype = POINT_TYPES.get(point, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ")
    if ptype == "Ð‘Ð°Ð·Ð°":
        return "ðŸ•‹ Ð‘Ð°Ð·Ð°"
    elif ptype == "Ð¢Ð¾Ñ‡ÐºÐ° Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²":
        return "ðŸ—ï¸ Ð¢Ð¾Ñ‡ÐºÐ° Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²"
    elif ptype == "ÐÐ½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð¾Ð½Ð°":
        if location and location in ANOMALY_ZONES and point in ANOMALY_ZONES[location]:
            atype = ANOMALY_ZONES[location][point]
            return ANOMALY_BUTTONS[atype]
        return "ðŸŒ• ÐÐ½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð¾Ð½Ð°"
    elif ptype == "Ð›Ð¾Ð³Ð¾Ð²Ð¾":
        return "â˜ ï¸ Ð›Ð¾Ð³Ð¾Ð²Ð¾"
    else:
        return "ðŸ§± Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ"
def create_main_menu_keyboard(user_id):
    p = players[user_id]
    point = p.get("point", "Ð‘1")
    location = p.get("location", "Ð›Ð°Ð³ÐµÑ€ÑŒ")
    k = VkKeyboard(one_time=False)
    k.add_button("ðŸ•ï¸ Ð›Ð°Ð³ÐµÑ€ÑŒ", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("ðŸ‘£ ÐŸÐµÑ€ÐµÑ…Ð¾Ð´", color=VkKeyboardColor.POSITIVE)
    k.add_button(get_main_menu_button(point, location), color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("ðŸ›’ Ð¢Ð¾Ñ€Ð³Ð¾Ð²ÐµÑ†", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("âš”ï¸ Ð’Ð¾Ð¹Ð½Ð° Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²Ð¾Ðº", color=VkKeyboardColor.NEGATIVE)
    if location in BASE_POINTS and point == BASE_POINTS[location]:
        k.add_line()
        k.add_button("ðŸ§° Ð¡ÐºÐ»Ð°Ð´", color=VkKeyboardColor.SECONDARY)
    return k
def create_camp_menu_keyboard():
    status = get_emission_status()
    k = VkKeyboard(one_time=False)
    k.add_button("ðŸŽ’ Ð ÑŽÐºÐ·Ð°Ðº", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("ðŸŸ¡ ÐŸÐ¾ÑÑ", color=VkKeyboardColor.POSITIVE)
    k.add_button("ðŸ’¤ ÐžÑ‚Ð´Ñ‹Ñ…", color=VkKeyboardColor.POSITIVE)
    k.add_button("ðŸ”‹ ÐŸÐ¾Ð´Ð·Ð°Ñ€ÑÐ´ÐºÐ°", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button(f"ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð²Ñ‹Ð±Ñ€Ð¾ÑÐ°: {status}", color=VkKeyboardColor.NEGATIVE)
    k.add_line()
    k.add_button("ðŸ”š ÐÐ°Ð·Ð°Ð´", color=VkKeyboardColor.SECONDARY)
    return k
def create_backpack_menu_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("â‡ï¸ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("â™»ï¸ Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ°", color=VkKeyboardColor.SECONDARY)
    k.add_line()
    k.add_button("ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ", color=VkKeyboardColor.POSITIVE)
    k.add_button("ðŸ’¡ Ð¸Ð½Ñ„Ð¾", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("ðŸ”š ÐÐ°Ð·Ð°Ð´", color=VkKeyboardColor.NEGATIVE)
    return k
def create_warehouse_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("ðŸ”š ÐÐ°Ð·Ð°Ð´", color=VkKeyboardColor.NEGATIVE)
    return k
def create_trader_main_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("ðŸ’² ÐŸÑ€Ð¸Ð¾Ð±Ñ€ÐµÑÑ‚Ð¸", color=VkKeyboardColor.POSITIVE)
    k.add_button("ðŸ’± ÐŸÑ€Ð¾Ð´Ð°Ñ‚ÑŒ", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("âš™ï¸ ÐŸÐ¾Ñ‡Ð¸Ð½Ð¸Ñ‚ÑŒ", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("ðŸ”š ÐÐ°Ð·Ð°Ð´", color=VkKeyboardColor.SECONDARY)
    return k
def create_trader_category_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("ðŸ¥« ÐŸÑ€Ð¾Ð²Ð¸Ð·Ð¸Ñ", color=VkKeyboardColor.POSITIVE)
    k.add_button("ðŸª– Ð¡Ð½Ð°Ñ€ÑÐ¶ÐµÐ½Ð¸Ðµ", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("ðŸ”š ÐÐ°Ð·Ð°Ð´", color=VkKeyboardColor.SECONDARY)
    return k
def create_trader_sell_category_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("ðŸ¥« ÐŸÑ€Ð¾Ð²Ð¸Ð·Ð¸Ñ", color=VkKeyboardColor.POSITIVE)
    k.add_button("ðŸª– Ð¡Ð½Ð°Ñ€ÑÐ¶ÐµÐ½Ð¸Ðµ", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("ðŸŒ• ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("ðŸ”š ÐÐ°Ð·Ð°Ð´", color=VkKeyboardColor.SECONDARY)
    return k
def create_equipment_category_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("ðŸ”« ÐžÑ€ÑƒÐ¶Ð¸Ðµ", color=VkKeyboardColor.POSITIVE)
    k.add_button("ðŸ¦º Ð‘Ñ€Ð¾Ð½Ñ", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("ðŸ“Ÿ Ð”ÐµÑ‚ÐµÐºÑ‚Ð¾Ñ€Ñ‹", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("ðŸ”š ÐÐ°Ð·Ð°Ð´", color=VkKeyboardColor.SECONDARY)
    return k
def create_equipment_sell_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("ðŸ”« ÐžÑ€ÑƒÐ¶Ð¸Ðµ", color=VkKeyboardColor.POSITIVE)
    k.add_button("ðŸ¦º Ð‘Ñ€Ð¾Ð½Ñ", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("ðŸ“Ÿ Ð”ÐµÑ‚ÐµÐºÑ‚Ð¾Ñ€Ñ‹", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("ðŸ”š ÐÐ°Ð·Ð°Ð´", color=VkKeyboardColor.SECONDARY)
    return k
def create_repair_keyboard(user_id):
    p = players[user_id]
    weapon = p.get("weapon", None)
    armor = p.get("armor", None)
    k = VkKeyboard(one_time=False)
    if weapon:
        k.add_button("ðŸ”« ÐžÑ€ÑƒÐ¶Ð¸Ðµ", color=VkKeyboardColor.POSITIVE)
    else:
        k.add_button("ðŸ”« Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚", color=VkKeyboardColor.SECONDARY)
    if armor:
        k.add_button("ðŸ¦º Ð‘Ñ€Ð¾Ð½Ñ", color=VkKeyboardColor.POSITIVE)
    else:
        k.add_button("ðŸ¦º Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚", color=VkKeyboardColor.SECONDARY)
    k.add_line()
    k.add_button("ðŸ”š ÐÐ°Ð·Ð°Ð´", color=VkKeyboardColor.NEGATIVE)
    return k
def create_confirmation_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("âœ… Ð”Ð°", color=VkKeyboardColor.POSITIVE)
    k.add_button("âŒ ÐÐµÑ‚", color=VkKeyboardColor.NEGATIVE)
    return k
def create_resting_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("âœ… Ð”Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¾Ñ‚Ð´Ñ‹Ñ…Ð°", color=VkKeyboardColor.SECONDARY)
    return k
def create_use_item_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("ÐžÑ‚Ð¼ÐµÐ½Ð°", color=VkKeyboardColor.NEGATIVE)
    return k
def create_back_only_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("ðŸ”š ÐÐ°Ð·Ð°Ð´", color=VkKeyboardColor.SECONDARY)
    return k
def create_war_main_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("ðŸ—ºï¸ Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸ Ð·Ð¾Ð½Ñ‹ ðŸ—ºï¸", color=VkKeyboardColor.NEGATIVE)
    k.add_line()
    k.add_button("ðŸ’² ÐŸÑ€Ð¸Ð¾Ð±Ñ€ÐµÑÑ‚Ð¸ ÑÐºÐ²Ð°Ð´", color=VkKeyboardColor.PRIMARY)
    k.add_button("â™»ï¸ Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐºÐ²Ð°Ð´Ð°Ð¼Ð¸", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("ðŸ”š ÐÐ°Ð·Ð°Ð´", color=VkKeyboardColor.SECONDARY)
    return k
def create_war_territories_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("ÐšÐ¾Ñ€Ð´Ð¾Ð½", color=VkKeyboardColor.SECONDARY)
    k.add_button("Ð¡Ð²Ð°Ð»ÐºÐ°", color=VkKeyboardColor.SECONDARY)
    k.add_line()
    k.add_button("Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", color=VkKeyboardColor.SECONDARY)
    k.add_button("ÐŸÐ¾Ð»ÑÐ½Ð°", color=VkKeyboardColor.SECONDARY)
    k.add_line()
    k.add_button("ðŸ”š ÐÐ°Ð·Ð°Ð´", color=VkKeyboardColor.NEGATIVE)
    return k
def create_hunting_keyboard():
    k = VkKeyboard(one_time=False)
    for i in range(1, 10):
        k.add_button(f"ðŸŽ¯ {i}", color=VkKeyboardColor.SECONDARY)
        if i % 3 == 0:
            k.add_line()
    k.add_button("ðŸƒ ÐŸÐ¾Ð±ÐµÐ³", color=VkKeyboardColor.NEGATIVE)
    return k
def create_anomaly_movement_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("â¬†ï¸", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("â¬…ï¸", color=VkKeyboardColor.PRIMARY)
    k.add_button("âž¡ï¸", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("â¬‡ï¸", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("ðŸšª Ð£Ð¹Ñ‚Ð¸", color=VkKeyboardColor.NEGATIVE)
    return k
def create_belt_main_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("âž• ÐŸÐ¾Ð²ÐµÑÐ¸Ñ‚ÑŒ", color=VkKeyboardColor.POSITIVE)
    k.add_button("âž– Ð¡Ð½ÑÑ‚ÑŒ", color=VkKeyboardColor.NEGATIVE)
    k.add_line()
    k.add_button("ðŸ’¡ Ð˜Ð½Ñ„Ð¾ Ð¾Ð± Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð°Ñ…", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("ðŸ”š ÐÐ°Ð·Ð°Ð´", color=VkKeyboardColor.SECONDARY)
    return k
def create_belt_slot_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("1ï¸âƒ£ ÐŸÐ¾ÑÑ", color=VkKeyboardColor.PRIMARY)
    k.add_button("2ï¸âƒ£ ÐŸÐ¾ÑÑ", color=VkKeyboardColor.PRIMARY)
    k.add_button("3ï¸âƒ£ ÐŸÐ¾ÑÑ", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("ðŸ”š ÐÐ°Ð·Ð°Ð´", color=VkKeyboardColor.SECONDARY)
    return k
def create_artifact_selection_keyboard(artifacts, page=0):
    k = VkKeyboard(one_time=False)
    items_per_page = 6
    start = page * items_per_page
    end = start + items_per_page
    page_items = artifacts[start:end]
    count = 0
    for art in page_items:
        if count > 0 and count % 2 == 0:
            k.add_line()
        k.add_button(art[:20], color=VkKeyboardColor.SECONDARY)
        count += 1
    k.add_line()
    total_pages = (len(artifacts) + items_per_page - 1) // items_per_page
    if total_pages > 1:
        if page > 0:
            k.add_button("â—€ï¸ Ð¢ÑƒÐ´Ð°", color=VkKeyboardColor.PRIMARY)
        if page < total_pages - 1:
            k.add_button("â–¶ï¸ Ð¡ÑŽÐ´Ð°", color=VkKeyboardColor.PRIMARY)
        k.add_line()
    k.add_button("ðŸ”š ÐÐ°Ð·Ð°Ð´", color=VkKeyboardColor.NEGATIVE)
    return k
def create_transition_keyboard(user_id):
    current_loc = players[user_id]["location"]
    k = VkKeyboard(one_time=False)
    k.add_button(f"â–¶ï¸ {current_loc} â—€ï¸", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    for loc in ["ÐšÐ¾Ñ€Ð´Ð¾Ð½", "Ð¡Ð²Ð°Ð»ÐºÐ°", "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "ÐŸÐ¾Ð»ÑÐ½Ð°"]:
        if loc != current_loc:
            k.add_button(loc, color=VkKeyboardColor.SECONDARY)
    k.add_line()
    k.add_button("ðŸ”š ÐÐ°Ð·Ð°Ð´", color=VkKeyboardColor.NEGATIVE)
    return k
def create_empty_keyboard():
    k = VkKeyboard(one_time=True)
    k.add_button("â³", color=VkKeyboardColor.SECONDARY)
    return k
def create_war_buy_squad_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("1 ÑÐºÐ²Ð°Ð´", color=VkKeyboardColor.POSITIVE)
    k.add_button("3 ÑÐºÐ²Ð°Ð´Ð°", color=VkKeyboardColor.POSITIVE)
    k.add_button("5 ÑÐºÐ²Ð°Ð´Ð¾Ð²", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("â™»ï¸ ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¾Ð²Ð¸Ð·Ð¸Ð¸", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("ðŸ”š ÐÐ°Ð·Ð°Ð´", color=VkKeyboardColor.SECONDARY)
    return k
def create_war_manage_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("ðŸ“¤ ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ", color=VkKeyboardColor.POSITIVE)
    k.add_button("ðŸ“¥ Ð’Ñ‹Ð²ÐµÑÑ‚Ð¸", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("ðŸ‘¥ ÐžÐ±Ñ‰Ð¸Ðµ ÑÐºÐ²Ð°Ð´Ñ‹", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("ðŸ”š ÐÐ°Ð·Ð°Ð´", color=VkKeyboardColor.SECONDARY)
    return k
def create_war_send_location_keyboard(user_id):
    k = VkKeyboard(one_time=False)
    for loc in ["ÐšÐ¾Ñ€Ð´Ð¾Ð½", "Ð¡Ð²Ð°Ð»ÐºÐ°", "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "ÐŸÐ¾Ð»ÑÐ½Ð°"]:
        k.add_button(loc, color=VkKeyboardColor.SECONDARY)
        k.add_line()
    k.add_button("ðŸ”š ÐÐ°Ð·Ð°Ð´", color=VkKeyboardColor.NEGATIVE)
    return k
def create_attack_confirm_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("âœ… Ð”Ð°", color=VkKeyboardColor.POSITIVE)
    k.add_button("âŒ ÐÐµÑ‚", color=VkKeyboardColor.NEGATIVE)
    k.add_line()
    k.add_button("âš”ï¸ ÐÐ°Ð¿Ð°ÑÑ‚ÑŒ ÑÐ¾ ÑÐºÐ²Ð°Ð´Ð°Ð¼Ð¸", color=VkKeyboardColor.PRIMARY)
    return k
def create_shared_squads_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("ðŸ“¥ ÐŸÐ¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ", color=VkKeyboardColor.POSITIVE)
    k.add_button("ðŸ“¤ Ð’Ñ‹Ð²ÐµÑÑ‚Ð¸", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("ðŸ”š ÐÐ°Ð·Ð°Ð´", color=VkKeyboardColor.SECONDARY)
    return k
def create_anomaly_path_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("ðŸŒ€ ÐŸÑƒÑ‚ÑŒ 1", color=VkKeyboardColor.PRIMARY)
    k.add_button("ðŸŒ€ ÐŸÑƒÑ‚ÑŒ 2", color=VkKeyboardColor.PRIMARY)
    k.add_button("ðŸŒ€ ÐŸÑƒÑ‚ÑŒ 3", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("ðŸšª Ð£Ð¹Ñ‚Ð¸", color=VkKeyboardColor.NEGATIVE)
    return k
def create_zombie_control_keyboard():
    k = VkKeyboard(one_time=False)
    k.add_button("âš”ï¸ ÐÐ³Ñ€ÐµÑÑÐ¸Ð²Ð½Ñ‹Ð¹ Ð·Ð°Ñ…Ð²Ð°Ñ‚", color=VkKeyboardColor.NEGATIVE)
    k.add_line()
    k.add_button("âš–ï¸ ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼", color=VkKeyboardColor.PRIMARY)
    k.add_line()
    k.add_button("ðŸ“¦ ÐÐ°ÐºÐ¾Ð¿Ð»ÐµÐ½Ð¸Ðµ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²", color=VkKeyboardColor.POSITIVE)
    k.add_line()
    k.add_button("ðŸŽ¯ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚", color=VkKeyboardColor.SECONDARY)
    k.add_button("âŒ Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚", color=VkKeyboardColor.SECONDARY)
    k.add_line()
    k.add_button("ðŸ”š ÐÐ°Ð·Ð°Ð´", color=VkKeyboardColor.SECONDARY)
    return k
def load_data():
    global players, factions, shared_warehouse, shared_warehouse_money, territory_control, faction_leaders, territory_exhaustion, emission_counter, last_restored_categories, faction_shared_squads, banned_users, admin_users
    init_database()
    conn = sqlite3.connect(str(DB_PATH))
    cursor = conn.cursor()
    cursor.execute("SELECT user_id, data FROM players")
    rows = cursor.fetchall()
    for row in rows:
        user_id = row[0]
        try:
            p = json.loads(row[1])
            if "belt" not in p:
                p["belt"] = [None, None, None]
            if "squads" not in p:
                p["squads"] = 0
            if "food_units" not in p:
                p["food_units"] = 0
            if "med_units" not in p:
                p["med_units"] = 0
            if "rad_units" not in p:
                p["rad_units"] = 0
            if "donation_end_time" not in p:
                p["donation_end_time"] = None
            if "donation_artifact" not in p:
                p["donation_artifact"] = None
            if "hidden_anomaly_positions" not in p:
                p["hidden_anomaly_positions"] = []
            if "backpack" in p:
                new_backpack = {}
                for item, count in p["backpack"].items():
                    clean_name = item.lower() if item.lower() in ITEM_ICONS else item
                    new_backpack[clean_name] = count
                p["backpack"] = new_backpack
            players[user_id] = p
        except Exception as e:
            logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¸Ð³Ñ€Ð¾ÐºÐ° {user_id}: {e}")
    def load_state(key, default):
        cursor.execute("SELECT value FROM game_state WHERE key = ?", (key,))
        row = cursor.fetchone()
        if row:
            try:
                return json.loads(row[0])
            except:
                return default
        return default
    factions = load_state("factions", {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": [], "â˜¦ï¸ Ð“Ñ€ÐµÑ…": [], "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": []})
    for key in factions:
        factions[key] = [int(uid) for uid in factions[key]]
    shared_warehouse = load_state("shared_warehouse", {})
    shared_warehouse_money = load_state("shared_warehouse_money", 0)
    territory_control = load_state("territory_control", {})
    faction_leaders = load_state("faction_leaders", {})
    territory_exhaustion = load_state("territory_exhaustion", {})
    last_restored_categories = load_state("last_restored_categories", [])
    global emission_schedule, emission_warned
    emission_schedule = load_state("emission_schedule", [])
    emission_warned = load_state("emission_warned", [])
    faction_shared_squads = load_state("faction_shared_squads", {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": 0, "â˜¦ï¸ Ð“Ñ€ÐµÑ…": 0, "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": 0})
    global LAST_STAND_MODE, faction_warehouses, faction_warehouse_money, zombie_bot
    LAST_STAND_MODE = load_state("last_stand_mode", False)
    global EMISSION_MAX, ZOMBIE_ACTION_INTERVAL
    ZOMBIE_ACTION_INTERVAL = load_state("zombie_action_interval", 1800)
    faction_warehouses = load_state("faction_warehouses", {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": {}, "â˜¦ï¸ Ð“Ñ€ÐµÑ…": {}, "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": {}, ZOMBIE_FACTION: {}})
    faction_warehouse_money = load_state("faction_warehouse_money", {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": 0, "â˜¦ï¸ Ð“Ñ€ÐµÑ…": 0, "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": 0, ZOMBIE_FACTION: 0})
    zombie_bot = load_state("zombie_bot", {"money": 0, "squads": 0, "food_units": 0, "med_units": 0, "rad_units": 0, "last_action_time": 0, "next_action": "", "backpack": {}, "mode": "normal", "priority_target": None, "agro_points": [], "last_attacked_by": None, "pending_target": None, "last_logs": [], "bonus_squads": 0})
    if "pending_target" not in zombie_bot:
        zombie_bot["pending_target"] = None
    if "last_logs" not in zombie_bot:
        zombie_bot["last_logs"] = []
    if "bonus_squads" not in zombie_bot:
        zombie_bot["bonus_squads"] = 0
    if "revenge_target" not in zombie_bot:
        zombie_bot["revenge_target"] = None
    banned_users = load_state("banned_users", {})
    if isinstance(banned_users, list):
        banned_users = {uid: "ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð° Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°" for uid in banned_users}
    admin_users = load_state("admin_users", [])
    loaded_limits = load_state("max_faction_sizes", {})
    for faction in MAX_FACTION_SIZES:
        if faction in loaded_limits:
            MAX_FACTION_SIZES[faction] = loaded_limits[faction]
    conn.close()
    if not territory_control:
        init_territory_control()
    if not territory_exhaustion:
        init_territory_exhaustion()
    logger.info("âœ… Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ Ð¸Ð· SQLite.")
def save_data():
    try:
        conn = sqlite3.connect(str(DB_PATH))
        cursor = conn.cursor()
        for user_id, data in players.items():
            cursor.execute("INSERT OR REPLACE INTO players (user_id, data) VALUES (?, ?)", (user_id, json.dumps(data, ensure_ascii=False)))
        def save_state(key, value):
            cursor.execute("INSERT OR REPLACE INTO game_state (key, value) VALUES (?, ?)", (key, json.dumps(value, ensure_ascii=False)))
        save_state("factions", factions)
        save_state("shared_warehouse", shared_warehouse)
        save_state("shared_warehouse_money", shared_warehouse_money)
        save_state("territory_control", territory_control)
        save_state("faction_leaders", faction_leaders)
        save_state("territory_exhaustion", territory_exhaustion)
        save_state("last_restored_categories", last_restored_categories)
        save_state("emission_schedule", emission_schedule)
        save_state("emission_warned", emission_warned)
        save_state("faction_shared_squads", faction_shared_squads)
        save_state("last_stand_mode", LAST_STAND_MODE)
        save_state("faction_warehouses", faction_warehouses)
        save_state("faction_warehouse_money", faction_warehouse_money)
        save_state("zombie_bot", zombie_bot)
        save_state("zombie_action_interval", ZOMBIE_ACTION_INTERVAL)
        save_state("banned_users", banned_users)
        save_state("admin_users", admin_users)
        save_state("max_faction_sizes", MAX_FACTION_SIZES)
        conn.commit()
        conn.close()
        logger.debug("ðŸ’¾ Ð”Ð°Ð½Ð½Ñ‹Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ñ‹ Ð² SQLite.")
    except Exception as e:
        logger.error(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð² SQLite: {e}")
def has_active_donation(user_id):
    p = players.get(user_id)
    if not p:
        return False
    end_time = p.get("donation_end_time")
    if end_time and time.time() < end_time:
        return True
    return False
def get_donation_artifact(user_id):
    p = players.get(user_id)
    if not p:
        return None
    if has_active_donation(user_id):
        return p.get("donation_artifact")
    return None
def remove_donation(user_id, vk_session):
    p = players.get(user_id)
    if not p:
        return
    artifact = p.get("donation_artifact")
    if artifact:
        if p["backpack"].get(artifact, 0) > 0:
            p["backpack"][artifact] -= 1
            if p["backpack"][artifact] <= 0:
                del p["backpack"][artifact]
        belt = p.get("belt", [None, None, None])
        for i in range(3):
            if belt[i] == artifact:
                belt[i] = None
        p["belt"] = belt
    p["donation_end_time"] = None
    p["donation_artifact"] = None
    save_data()
    send_message(user_id, "â° Ð’Ð°Ñˆ Ð´Ð¾Ð½Ð°Ñ‚-ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¸ÑÑ‚Ñ‘Ðº. ÐŸÑ€Ð¸Ð²Ð¸Ð»ÐµÐ³Ð¸Ð¸ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ñ‹.", None, vk_session)
def get_random_artifact_by_rarity(anomaly_type):
    artifacts = ARTIFACTS[anomaly_type]
    weighted_artifacts = []
    for art in artifacts:
        price = ARTIFACT_PRICES.get(art, 15)
        if price <= 15:
            weight = 40
        elif price <= 25:
            weight = 30
        elif price <= 35:
            weight = 20
        else:
            weight = 10
        weighted_artifacts.append((art, weight))
    total_weight = sum(w for _, w in weighted_artifacts)
    rand = random.randint(1, total_weight)
    current = 0
    for art, weight in weighted_artifacts:
        current += weight
        if rand <= current:
            return art
    return artifacts[0]
def get_user_info(user_id, vk_session):
    try:
        user = vk_session.method("users.get", {"user_ids": user_id, "fields": "screen_name"})[0]
        first_name = user['first_name']
        screen_name = user.get("screen_name", "")
        return first_name, screen_name
    except Exception as e:
        logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¸Ð¼ÐµÐ½Ð¸: {e}")
        return "Ð´Ñ€ÑƒÐ³", ""
def get_user_avatar(user_id, vk_session):
    try:
        user = vk_session.method("users.get", {"user_ids": user_id, "fields": "photo_200"})[0]
        photo_url = user.get("photo_200")
        if photo_url:
            response = vk_session.http.get(photo_url)
            img = Image.open(io.BytesIO(response.content))
            return img
    except Exception as e:
        logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð°Ð²Ð°Ñ‚Ð°Ñ€ÐºÐ¸: {e}")
    return None
def send_message(user_id, message, keyboard=None, vk_session=None, peer_id=None):
    if vk_session is None:
        logger.error("âŒ vk_session Ð½Ðµ Ð¿ÐµÑ€ÐµÐ´Ð°Ð½ Ð² send_message")
        return
    if not message.strip():
        logger.warning("ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ")
        return
    try:
        target_id = peer_id if peer_id else user_id
        params = {"peer_id": target_id, "message": message, "random_id": 0}
        if keyboard:
            params["keyboard"] = keyboard.get_keyboard()
        vk_session.method("messages.send", params)
    except Exception as e:
        logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ: {e}")
def send_location_image(user_id, location, point, message, keyboard, vk_session):
    loc_short = location
    if location == "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°":
        loc_short = "Ð¢Ð”"
    filename_base = f"{loc_short} {point}"
    img_path = None
    for ext in ["png", "jpg", "jpeg"]:
        path = f"location/{filename_base}.{ext}"
        if os.path.exists(path):
            img_path = path
            break
    if not img_path:
        send_message(user_id, message, keyboard, vk_session)
        return
    try:
        upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
        with open(img_path, "rb") as f:
            response = vk_session.http.post(upload_url, files={"photo": f})
        result = response.json()
        photo_data = vk_session.method("photos.saveMessagesPhoto", {"photo": result["photo"], "server": result["server"], "hash": result["hash"]})[0]
        params = {"user_id": user_id, "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}", "random_id": 0, "message": message}
        if keyboard:
            params["keyboard"] = keyboard.get_keyboard()
        vk_session.method("messages.send", params)
    except Exception as e:
        logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸: {e}")
        send_message(user_id, message, keyboard, vk_session)
def reset_all_data():
    global players, factions, shared_warehouse, shared_warehouse_money, territory_control
    global faction_leaders, territory_exhaustion, last_restored_categories
    global faction_shared_squads, LAST_STAND_MODE, faction_warehouses, faction_warehouse_money, zombie_bot
    global emission_schedule, emission_warned, banned_users, admin_users
    players = {}
    factions = {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": [], "â˜¦ï¸ Ð“Ñ€ÐµÑ…": [], "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": []}
    shared_warehouse = {}
    shared_warehouse_money = 0
    territory_control = {}
    faction_leaders = {}
    territory_exhaustion = {}
    banned_users = {}
    admin_users = []
    emission_schedule = []
    emission_warned = []
    last_restored_categories = []
    faction_shared_squads = {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": 0, "â˜¦ï¸ Ð“Ñ€ÐµÑ…": 0, "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": 0}
    LAST_STAND_MODE = False
    faction_warehouses = {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": {}, "â˜¦ï¸ Ð“Ñ€ÐµÑ…": {}, "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": {}, ZOMBIE_FACTION: {}}
    faction_warehouse_money = {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": 0, "â˜¦ï¸ Ð“Ñ€ÐµÑ…": 0, "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": 0, ZOMBIE_FACTION: 0}
    zombie_bot = {"money": 0, "squads": 0, "food_units": 0, "med_units": 0, "rad_units": 0, "last_action_time": 0, "next_action": "", "backpack": {}, "mode": "normal", "priority_target": None, "agro_points": [], "last_attacked_by": None, "pending_target": None, "last_logs": [], "bonus_squads": 0}
    init_territory_control()
    init_territory_exhaustion()
    generate_emission_schedule()
    save_data()
    logger.info("âœ… Ð’ÑÐµ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑÐ±Ñ€Ð¾ÑˆÐµÐ½Ñ‹!")
def get_belt_bonus(user_id, stat):
    p = players[user_id]
    belt = p.get("belt", [None, None, None])
    total = 0
    for art in belt:
        if art and art in ARTIFACT_EFFECTS:
            total += ARTIFACT_EFFECTS[art].get(stat, 0)
    return total
def normalize_stats(user_id):
    p = players[user_id]
    p["health"] = round(max(0, min(10, p.get("health", 10))), 1)
    p["radiation"] = round(max(0, min(10, p.get("radiation", 0))), 1)
    p["hunger"] = round(max(0, min(10, p.get("hunger", 0))), 1)
    p["stamina"] = round(max(0, min(10, p.get("stamina", 10))), 1)
def get_player_position(user_id):
    p = players[user_id]
    if p.get("state") != STATE_TRANSITION_WAIT:
        return p.get("location"), p.get("point")
    end_time = p.get("transition_end_time")
    if not end_time:
        return p.get("location"), p.get("point")
    current_time = time.time()
    if current_time >= end_time:
        return p.get("location"), p.get("point")
    transition_duration = 900 if has_active_donation(user_id) else 1800
    start_time = end_time - transition_duration
    elapsed = current_time - start_time
    half_time = transition_duration / 2
    if elapsed < half_time:
        prev_loc = p.get("previous_location")
        prev_point = p.get("previous_point")
        if prev_loc and prev_point:
            return prev_loc, prev_point
    return p.get("location"), p.get("point")
def apply_belt_effects_on_exploration(user_id):
    p = players[user_id]
    health_regen = get_belt_bonus(user_id, "health_regen")
    radiation_reduce = get_belt_bonus(user_id, "radiation_reduce")
    if health_regen > 0:
        p["health"] = min(10, p["health"] + health_regen)
    if radiation_reduce > 0:
        p["radiation"] = max(0, p["radiation"] - radiation_reduce)
    normalize_stats(user_id)
def apply_belt_effects_on_rest(user_id):
    return get_belt_bonus(user_id, "stamina_regen")
def get_total_stats_with_belt(user_id):
    p = players[user_id]
    return {"blast_resist": p.get("blast_resist", 0) + get_belt_bonus(user_id, "blast_resist"), "bullet_resist": p.get("bullet_resist", 0) + get_belt_bonus(user_id, "bullet_resist"), "anomaly_resist": p.get("anomaly_resist", 0) + get_belt_bonus(user_id, "anomaly_resist"), "weapon_damage": p.get("weapon_damage", 0) + get_belt_bonus(user_id, "weapon_damage"), "weapon_accuracy": p.get("weapon_accuracy", 0) + get_belt_bonus(user_id, "weapon_accuracy")}
def get_total_weapon_damage(user_id):
    p = players[user_id]
    return p.get("weapon_damage", 0) + get_belt_bonus(user_id, "weapon_damage")
def get_total_weapon_accuracy(user_id):
    p = players[user_id]
    return int(p.get("weapon_accuracy", 0) + get_belt_bonus(user_id, "weapon_accuracy"))
def get_total_blast_resist(user_id):
    p = players[user_id]
    return p.get("blast_resist", 0) + get_belt_bonus(user_id, "blast_resist")
def get_total_anomaly_resist(user_id):
    p = players[user_id]
    return p.get("anomaly_resist", 0) + get_belt_bonus(user_id, "anomaly_resist")
def format_camp_info(user_id):
    p = players[user_id]
    nickname = p["nickname"]
    faction = p["faction"]
    location = p.get("location", "Ð›Ð°Ð³ÐµÑ€ÑŒ")
    point = p.get("point", "Ð‘1")
    full_loc = f"{location} {point}"
    health = p.get("health", 10)
    radiation = p.get("radiation", 0)
    hunger = p.get("hunger", 0)
    stamina = p.get("stamina", 10)
    detector = p.get("detector", None)
    detector_charge = p.get("detector_charge", 0)
    detector_max_charge = p.get("detector_max_charge", 0)
    armor = p.get("armor", None)
    armor_durability = p.get("armor_durability", 0)
    armor_max_durability = p.get("armor_max_durability", 0)
    bullet_resist = p.get("bullet_resist", 0) + get_belt_bonus(user_id, "bullet_resist")
    blast_resist = p.get("blast_resist", 0) + get_belt_bonus(user_id, "blast_resist")
    anomaly_resist = p.get("anomaly_resist", 0) + get_belt_bonus(user_id, "anomaly_resist")
    weapon = p.get("weapon", None)
    weapon_durability = p.get("weapon_durability", 0)
    weapon_max_durability = p.get("weapon_max_durability", 0)
    weapon_damage = p.get("weapon_damage", 0) + get_belt_bonus(user_id, "weapon_damage")
    weapon_accuracy = p.get("weapon_accuracy", 0) + get_belt_bonus(user_id, "weapon_accuracy")
    money = p.get("money", 0)
    belt = p.get("belt", [None, None, None])
    belt_str = f"1ï¸âƒ£{belt[0] or '-'} 2ï¸âƒ£{belt[1] or '-'} 3ï¸âƒ£{belt[2] or '-'}"
    lines = [f"Â«ðŸ’¬ ÐšÐ»Ð¸Ñ‡: {nickname}", f"Â«ðŸ‘¥ Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ°: {faction}", f"Â«ðŸ—º ÐœÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ: {full_loc}", "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”", f"Â«â¤ï¸ Ð—Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ: {health}/10", f"Â«â˜¢ï¸ Ð Ð°Ð´Ð¸Ð°Ñ†Ð¸Ñ: {radiation}/10", f"Â«ðŸ½ï¸ Ð“Ð¾Ð»Ð¾Ð´: {hunger}/10", f"Â«âš¡ Ð’Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ: {stamina}/10", "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”", f"Â«ðŸ“Ÿ Ð”ÐµÑ‚ÐµÐºÑ‚Ð¾Ñ€: {'Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚' if not detector else detector} {detector_charge}/{detector_max_charge}ðŸ”‹", f"Â«ðŸª– Ð‘Ñ€Ð¾Ð½Ñ: {'Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚' if not armor else armor} ðŸ”§{armor_durability}/{armor_max_durability}", f"(ðŸ›¡) {bullet_resist}", f"(ðŸ¾) {blast_resist}", f"(ðŸ’¥) {anomaly_resist}", f"Â«ðŸ”« ÐžÑ€ÑƒÐ¶Ð¸Ðµ: {'Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚' if not weapon else weapon} ðŸ”§{weapon_durability}/{weapon_max_durability}", f"(ðŸ’¢) {weapon_damage}", f"(ðŸŽ¯) {weapon_accuracy}", f"Â«ðŸŸ¡ ÐŸÐ¾ÑÑ: {belt_str}", f"Â«ðŸ’² Ð”ÐµÐ½ÑŒÐ³Ð¸: {money}Ñ€"]
    return "\n".join(lines)
def format_minimal_info(user_id):
    p = players[user_id]
    health = p.get("health", 10)
    radiation = p.get("radiation", 0)
    hunger = p.get("hunger", 0)
    stamina = p.get("stamina", 10)
    return f"Â«â¤ï¸ Ð—Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ: {health}/10\nÂ«â˜¢ï¸ Ð Ð°Ð´Ð¸Ð°Ñ†Ð¸Ñ: {radiation}/10\nÂ«ðŸ½ï¸ Ð“Ð¾Ð»Ð¾Ð´: {hunger}/10\nÂ«âš¡ Ð’Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ: {stamina}/10"
def get_sort_mode(user_id):
    return players[user_id].get("backpack_sort", 0)
def set_sort_mode(user_id, mode):
    players[user_id]["backpack_sort"] = mode % 3
def format_backpack_info(user_id):
    p = players[user_id]
    backpack = p.get("backpack", {})
    money = p.get("money", 0)
    sort_mode = get_sort_mode(user_id)
    if not backpack:
        items_str = "ÐŸÐ¾ÐºÐ° Ð¿ÑƒÑÑ‚Ð¾... ðŸ“¦"
    else:
        active_items = {k: v for k, v in backpack.items() if v > 0}
        if not active_items:
            items_str = "ÐŸÑƒÑÑ‚Ð¾"
        else:
            if sort_mode == 0:
                items_list = [f"{item}: {count}" for item, count in active_items.items()]
                items_str = ", ".join(items_list)
            else:
                clean_items = {}
                for emoji_name, count in active_items.items():
                    clean_name = emoji_name.lower()
                    clean_items[clean_name] = (emoji_name, count)
                if sort_mode == 1:
                    sorted_items = []
                    for cat in ["ÐµÐ´Ð°", "Ð¼ÐµÐ´Ð¸ÐºÐ°Ð¼ÐµÐ½Ñ‚Ñ‹", "Ð°Ð½Ñ‚Ð¸Ñ€Ð°Ð´", "ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸ÐºÐ¸", "Ð¿Ñ€Ð¾Ñ‡ÐµÐµ"]:
                        for name in CATEGORIES[cat]:
                            if name in clean_items:
                                emoji, count = clean_items[name]
                                sorted_items.append((emoji, count))
                    for name, (emoji, count) in clean_items.items():
                        if name not in [n for cat in CATEGORIES.values() for n in cat]:
                            sorted_items.append((emoji, count))
                elif sort_mode == 2:
                    sorted_items = sorted(active_items.items(), key=lambda x: x[1], reverse=True)
                items_str = "\n".join([f"{item}: {count}" for item, count in sorted_items])
    return "ðŸŽ’ Ð’Ð°ÑˆÐ¸ Ð²ÐµÑ‰Ð¸:\n" + items_str + "\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n" + f"ðŸ’² Ð’Ð°ÑˆÐ¸ Ð´ÐµÐ½ÑŒÐ³Ð¸: {money}Ñ€"
def format_warehouse_info(user_id=None):
    if LAST_STAND_MODE and user_id:
        faction = players[user_id].get("faction")
        warehouse = faction_warehouses.get(faction, {})
        money = faction_warehouse_money.get(faction, 0)
    else:
        warehouse = shared_warehouse
        money = shared_warehouse_money
    if not warehouse:
        items_str = "ÐŸÐ¾ÐºÐ° Ð¿ÑƒÑÑ‚Ð¾... ðŸ“¦"
    else:
        active_items = {k: v for k, v in warehouse.items() if v > 0}
        if not active_items:
            items_str = "ÐŸÑƒÑÑ‚Ð¾"
        else:
            items_list = [f"{item}: {count}" for item, count in active_items.items()]
            items_str = "\n".join(items_list)
    return "ðŸ§° Ð¡ÐºÐ»Ð°Ð´:\n" + items_str + "\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n" + f"ðŸ’² Ð”ÐµÐ½ÑŒÐ³Ð¸ Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ: {money}Ñ€"
def can_transition_from(loc, point):
    return (loc, point) in TRANSITION_ROUTES
def get_available_transitions(loc, point):
    return TRANSITION_ROUTES.get((loc, point), [])
def is_valid_point(loc_name, point):
    return point in LOCATIONS.get(loc_name, [])
def apply_radiation_damage(user_id):
    p = players[user_id]
    if p["radiation"] >= 10:
        p["health"] = max(0, p["health"] - 2)
        return True
    return False
def apply_hunger_damage(user_id):
    p = players[user_id]
    if p["hunger"] >= 10:
        p["health"] = max(0, p["health"] - 1)
        p["stamina"] = max(0, p["stamina"] - 2)
        return True
    return False
def get_damage_reason(user_id):
    reasons = []
    if players[user_id]["radiation"] >= 10:
        reasons.append("Ñ€Ð°Ð´Ð¸Ð°Ñ†Ð¸Ñ")
    if players[user_id]["hunger"] >= 10:
        reasons.append("Ð³Ð¾Ð»Ð¾Ð´")
    return " Ð¸ ".join(reasons) if reasons else ""
def check_vital_conditions(user_id, action="Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ"):
    p = players[user_id]
    messages = []
    if p["health"] <= 0:
        messages.append("ðŸ’€ Ð’Ñ‹ Ð² ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¸!")
        return False, "\n".join(messages)
    if action == "Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´":
        if p["stamina"] < 3:
            messages.append("âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚Ð¸ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð° (Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ 3).")
        if p["hunger"] >= 8:
            messages.append("âŒ Ð’Ñ‹ ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð³Ð¾Ð»Ð¾Ð´Ð½Ñ‹ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð° (Ð³Ð¾Ð»Ð¾Ð´ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ < 8).")
        if p["backpack"].get("Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸", 0) < 2:
            messages.append("âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð±Ð°Ñ‚Ð°Ñ€ÐµÐµÐº Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð° (Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ 2).")
    elif action == "Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ":
        if p["stamina"] <= 0:
            messages.append("ðŸ˜´ Ð£ Ð²Ð°Ñ Ð·Ð°ÐºÐ¾Ð½Ñ‡Ð¸Ð»Ð°ÑÑŒ Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ â€” Ð¿Ð¾Ñ€Ð° Ð¾Ñ‚Ð´Ð¾Ñ…Ð½ÑƒÑ‚ÑŒ.")
    elif action == "Ð¾Ñ…Ð¾Ñ‚Ð°":
        if p["stamina"] <= 0:
            messages.append("ðŸ˜´ Ð£ Ð²Ð°Ñ Ð·Ð°ÐºÐ¾Ð½Ñ‡Ð¸Ð»Ð°ÑÑŒ Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ â€” Ð¿Ð¾Ñ€Ð° Ð¾Ñ‚Ð´Ð¾Ñ…Ð½ÑƒÑ‚ÑŒ.")
        if not p.get("weapon"):
            messages.append("âŒ ÐÐµÑ‚ Ð¾Ñ€ÑƒÐ¶Ð¸Ñ â€” Ð¾Ñ…Ð¾Ñ‚Ð° Ð½ÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð°.")
        elif p.get("weapon_durability", 0) <= 0:
            messages.append("ðŸ”§ Ð’Ð°ÑˆÐµ Ð¾Ñ€ÑƒÐ¶Ð¸Ðµ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ ÑÐ»Ð¾Ð¼Ð°Ð½Ð¾ â€” ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ð¾Ñ‡Ð¸Ð½Ð¸Ñ‚Ðµ ÐµÐ³Ð¾.")
    if messages:
        return False, "\n".join(messages)
    return True, ""
def roll_drops(drop_table, point_type):
    rand = random.random()
    if rand < 0.5:
        num_types = 1
    elif rand < 0.75:
        num_types = 2
    elif rand < 0.875:
        num_types = 3
    else:
        num_types = 1
    candidates = []
    for item, data in drop_table.items():
        if random.randint(1, 100) <= data["chance"]:
            candidates.append(item)
    if not candidates:
        if random.random() < 0.1:
            all_items = list(drop_table.keys())
            candidates = random.sample(all_items, k=min(1, len(all_items)))
    if len(candidates) > num_types:
        candidates = random.sample(candidates, k=num_types)
    elif len(candidates) == 0:
        return {}
    found = {}
    for item in candidates:
        data = drop_table[item]
        amount = random.randint(data["min"], data["max"])
        found[item] = amount
    return found
def get_radiation_gain(point_type):
    if random.randint(1, 100) > 25:
        return 0
    if point_type == "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ":
        return random.choice([0.5, 1])
    elif point_type == "Ð¢Ð¾Ñ‡ÐºÐ° Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²":
        return random.choice([0.5, 1.5])
    elif point_type == "Ð‘Ð°Ð·Ð°":
        return random.choice([0.5, 2])
    elif point_type == "ÐÐ½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð¾Ð½Ð°":
        return random.choice([0.5, 2.5])
    elif point_type == "Ð›Ð¾Ð³Ð¾Ð²Ð¾":
        return random.choice([0.5, 2])
    return 0
def find_start_position(faction):
    start_loc, start_point = FACTION_START_LOCATIONS.get(faction, ("ÐšÐ¾Ñ€Ð´Ð¾Ð½", "Ð‘1"))
    owner = get_territory_owner(start_loc, start_point)
    if owner == faction:
        return start_loc, start_point
    for loc in LOCATIONS:
        for point in LOCATIONS[loc]:
            if get_territory_owner(loc, point) == faction:
                return loc, point
    return start_loc, start_point
def select_mutant(location, point):
    chances = MUTANT_SPAWN_CHANCES.get(location, {}).get(point, {})
    if not chances:
        return None
    total = sum(chances.values())
    if total == 0:
        return None
    rand = random.randint(1, total)
    cumulative = 0
    for mutant_type, prob in chances.items():
        cumulative += prob
        if rand <= cumulative:
            rank_roll = random.randint(1, 100)
            if rank_roll <= 30:
                rank = 0
            elif rank_roll <= 80:
                rank = 1
            else:
                rank = 2
            return MUTANTS[mutant_type][rank]
    return None
def calculate_and_apply_death_losses(user_id, max_items=10, max_money=100):
    p = players[user_id]
    backpack = p.get("backpack", {})
    money = p.get("money", 0)
    lost_items = {}
    items_list = []
    for item, count in backpack.items():
        if item not in DONATION_ARTIFACTS:
            items_list.extend([item] * count)
    total_items = len(items_list)
    if total_items > 0:
        num_items_to_lose = random.randint(1, min(max_items, total_items))
        random.shuffle(items_list)
        lost_list = items_list[:num_items_to_lose]
        for item in lost_list:
            lost_items[item] = lost_items.get(item, 0) + 1
        for item, count in lost_items.items():
            p["backpack"][item] -= count
            if p["backpack"][item] <= 0:
                del p["backpack"][item]
    money_lost = random.randint(1, min(max_money, money)) if money > 0 else 0
    p["money"] -= money_lost
    return lost_items, money_lost
def format_death_losses(lost_items, money_lost):
    lines = []
    if lost_items or money_lost:
        lines.append("ÐŸÐ¾Ñ‚ÐµÑ€ÑÐ½Ð¾:")
        for item, count in lost_items.items():
            lines.append(f"  {item} x{count}")
        if money_lost > 0:
            lines.append(f"  ðŸ’² {money_lost}Ñ€")
    return lines
def lose_random_items_on_death(user_id, vk_session):
    p = players[user_id]
    if p.get("death_notified", False):
        return
    lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=10, max_money=100)
    msg_lines = ["ðŸ’€ Ð’Ñ‹ Ð² ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¸!"]
    msg_lines.extend(format_death_losses(lost_items, money_lost))
    send_message(user_id, "\n".join(msg_lines), None, vk_session)
    p["death_notified"] = True
    save_data()
def handle_shooting(user_id, vk_session):
    p = players[user_id]
    mutant = p.get("current_mutant")
    if not mutant or p.get("mutant_hp", 0) <= 0:
        send_message(user_id, "ÐœÑƒÑ‚Ð°Ð½Ñ‚ ÑƒÐ¶Ðµ Ð¼Ñ‘Ñ€Ñ‚Ð².", create_main_menu_keyboard(user_id), vk_session)
        p["state"] = STATE_IN_MENU
        save_data()
        return
    if p.get("weapon_durability", 0) <= 0:
        mutant_hp = p.get("mutant_hp", 0)
        player_health = p.get("health", 10)
        blast_resist = get_total_blast_resist(user_id)
        broken_msg = f"ðŸ”§ Ð’Ð°ÑˆÐµ Ð¾Ñ€ÑƒÐ¶Ð¸Ðµ ÑÐ»Ð¾Ð¼Ð°Ð½Ð¾! Ð¡Ñ‚Ñ€ÐµÐ»ÑÑ‚ÑŒ Ð½ÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾.\nÐ•Ð´Ð¸Ð½ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ Ð²Ñ‹Ñ…Ð¾Ð´ â€” ðŸƒ ÐŸÐ¾Ð±ÐµÐ³\n\nðŸ‘¹ {mutant['name']}\nÐ¥ÐŸ Ð¼ÑƒÑ‚Ð°Ð½Ñ‚Ð°: {mutant_hp}/{mutant['hp']}\nðŸ’¢ Ð£Ñ€Ð¾Ð½ Ð¼ÑƒÑ‚Ð°Ð½Ñ‚Ð°: {mutant['damage']}\n\nâ¤ï¸ Ð’Ð°ÑˆÐµ Ð¥ÐŸ: {player_health}/10\nðŸ¾ Ð Ð°Ð·Ñ€Ñ‹Ð²: {blast_resist}"
        p["state"] = STATE_HUNTING
        save_data()
        send_message(user_id, broken_msg, create_hunting_keyboard(), vk_session)
        return
    shot_button = p.get("shot_button", 0)
    valid_shots = set(p.get("valid_targets", []))
    messages = []
    weapon_damage = get_total_weapon_damage(user_id)
    weapon_name = p.get("weapon", "")
    special = SPECIAL_WEAPONS.get(weapon_name, {})
    mutant_bonus = special.get("mutant_bonus", 0)
    total_damage = weapon_damage + mutant_bonus
    base_weapon_damage = p.get("weapon_damage", 0)
    def get_adjacent_buttons(btn):
        adjacency = {1: [2, 4, 5], 2: [1, 3, 4, 5, 6], 3: [2, 5, 6], 4: [1, 2, 5, 7, 8], 5: [1, 2, 3, 4, 6, 7, 8, 9], 6: [2, 3, 5, 8, 9], 7: [4, 5, 8], 8: [4, 5, 6, 7, 9], 9: [5, 6, 8]}
        return adjacency.get(btn, [])
    if shot_button not in valid_shots:
        shotgun_hit = False
        if special.get("shotgun_spread"):
            adjacent = get_adjacent_buttons(shot_button)
            adjacent_valid = [btn for btn in adjacent if btn in valid_shots]
            if adjacent_valid and random.randint(1, 100) <= 50:
                shotgun_hit = True
                spread_damage = base_weapon_damage / 2
                p["mutant_hp"] = max(0, p["mutant_hp"] - spread_damage)
                messages.append(f"ðŸ’¨ ÐŸÑ€Ð¾Ð¼Ð°Ñ…, Ð½Ð¾ Ð´Ñ€Ð¾Ð±ÑŒ Ð·Ð°Ñ†ÐµÐ¿Ð¸Ð»Ð°! ÐÐ°Ð½ÐµÑÐµÐ½Ð¾ {spread_damage} ÑƒÑ€Ð¾Ð½Ð°.")
                if p["mutant_hp"] <= 0:
                    reward = mutant["reward"]
                    p["money"] += reward
                    messages.append(f"â˜ ï¸ ÐœÑƒÑ‚Ð°Ð½Ñ‚ ÑƒÐ±Ð¸Ñ‚! ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ {reward}Ñ€.")
                    radiation_reduce = special.get("radiation_reduce", 0)
                    if radiation_reduce > 0:
                        p["radiation"] = max(0, p["radiation"] - radiation_reduce)
                        messages.append(f"â˜¢ï¸ Ð Ð°Ð´Ð¸Ð°Ñ†Ð¸Ñ ÑÐ½Ð¸Ð¶ÐµÐ½Ð° Ð½Ð° {radiation_reduce} (ÑÑ„Ñ„ÐµÐºÑ‚ Ð¾Ñ€ÑƒÐ¶Ð¸Ñ).")
                    p["state"] = STATE_IN_MENU
                    p.pop("current_mutant", None)
                    p.pop("mutant_hp", None)
                    p.pop("valid_targets", None)
                    save_data()
                    send_message(user_id, "\n".join(messages), create_main_menu_keyboard(user_id), vk_session)
                    return
        if not shotgun_hit:
            messages.append("ðŸ’¨ Ð’Ñ‹ Ð¿Ñ€Ð¾Ð¼Ð°Ñ…Ð½ÑƒÐ»Ð¸ÑÑŒ!")
    else:
        if random.randint(1, 100) <= 10:
            messages.append("ðŸ‘¹ ÐœÑƒÑ‚Ð°Ð½Ñ‚ ÑƒÐ²ÐµÑ€Ð½ÑƒÐ»ÑÑ Ð¾Ñ‚ Ð²Ñ‹ÑÑ‚Ñ€ÐµÐ»Ð°!")
        else:
            p["mutant_hp"] = max(0, p["mutant_hp"] - total_damage)
            if mutant_bonus > 0:
                messages.append(f"ðŸ’¥ ÐŸÐ¾Ð¿Ð°Ð´Ð°Ð½Ð¸Ðµ! ÐÐ°Ð½ÐµÑÐµÐ½Ð¾ {total_damage} ÑƒÑ€Ð¾Ð½Ð° (ðŸ”«+{mutant_bonus}).")
            else:
                messages.append(f"ðŸ’¥ ÐŸÐ¾Ð¿Ð°Ð´Ð°Ð½Ð¸Ðµ! ÐÐ°Ð½ÐµÑÐµÐ½Ð¾ {total_damage} ÑƒÑ€Ð¾Ð½Ð°.")
            if p["mutant_hp"] <= 0:
                reward = mutant["reward"]
                p["money"] += reward
                messages.append(f"â˜ ï¸ ÐœÑƒÑ‚Ð°Ð½Ñ‚ ÑƒÐ±Ð¸Ñ‚! ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ {reward}Ñ€.")
                radiation_reduce = special.get("radiation_reduce", 0)
                if radiation_reduce > 0:
                    p["radiation"] = max(0, p["radiation"] - radiation_reduce)
                    messages.append(f"â˜¢ï¸ Ð Ð°Ð´Ð¸Ð°Ñ†Ð¸Ñ ÑÐ½Ð¸Ð¶ÐµÐ½Ð° Ð½Ð° {radiation_reduce} (ÑÑ„Ñ„ÐµÐºÑ‚ Ð¾Ñ€ÑƒÐ¶Ð¸Ñ).")
                p["state"] = STATE_IN_MENU
                p.pop("current_mutant", None)
                p.pop("mutant_hp", None)
                p.pop("valid_targets", None)
                save_data()
                send_message(user_id, "\n".join(messages), create_main_menu_keyboard(user_id), vk_session)
                return
    if random.randint(1, 100) <= 10:
        messages.append("ðŸ›¡ï¸ Ð’Ñ‹ ÑƒÐºÐ»Ð¾Ð½Ð¸Ð»Ð¸ÑÑŒ Ð¾Ñ‚ Ð°Ñ‚Ð°ÐºÐ¸!")
    else:
        raw_damage = mutant["damage"]
        blast_resist = get_total_blast_resist(user_id)
        actual_damage = max(0, round(raw_damage - blast_resist, 1))
        if actual_damage <= 0:
            messages.append("ðŸ›¡ï¸ Ð‘Ñ€Ð¾Ð½Ñ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð¿Ð¾Ð³Ð»Ð¾Ñ‚Ð¸Ð»Ð° ÑƒÑ€Ð¾Ð½!")
        else:
            p["health"] = max(0, p["health"] - actual_damage)
            messages.append(f"ðŸ’” ÐœÑƒÑ‚Ð°Ð½Ñ‚ Ð½Ð°Ð½Ñ‘Ñ {actual_damage} ÑƒÑ€Ð¾Ð½Ð°!")
            if p["health"] <= 0:
                messages.append(f"\nðŸ’€ Ð’Ñ‹ Ð¿Ð¾Ð³Ð¸Ð±Ð»Ð¸ Ð² Ð±Ð¾ÑŽ Ñ {mutant['name']}!")
                lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=5, max_money=50)
                messages.extend(format_death_losses(lost_items, money_lost))
                p["state"] = STATE_IN_MENU
                p["death_notified"] = True
                p.pop("current_mutant", None)
                p.pop("mutant_hp", None)
                p.pop("valid_targets", None)
                normalize_stats(user_id)
                save_data()
                send_message(user_id, "\n".join(messages), create_main_menu_keyboard(user_id), vk_session)
                return
    if random.randint(1, 100) <= 25:
        equip_to_damage = []
        if p.get("weapon"):
            equip_to_damage.append("weapon")
        if p.get("armor"):
            equip_to_damage.append("armor")
        if equip_to_damage:
            target = random.choice(equip_to_damage)
            if target == "weapon":
                p["weapon_durability"] = max(0, p["weapon_durability"] - 0.5)
                messages.append("ðŸ”§ ÐžÑ€ÑƒÐ¶Ð¸Ðµ Ð¿Ð¾Ð²Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¾ (-0.5)!")
                if p["weapon_durability"] <= 0:
                    messages.append("âš ï¸ Ð’Ð°ÑˆÐµ Ð¾Ñ€ÑƒÐ¶Ð¸Ðµ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ ÑÐ»Ð¾Ð¼Ð°Ð½Ð¾! Ð¡Ñ‚Ñ€ÐµÐ»ÑÑ‚ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð½ÐµÐ»ÑŒÐ·Ñ â€” Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾Ð±ÐµÐ³!")
            else:
                p["armor_durability"] = max(0, p["armor_durability"] - 0.5)
                messages.append("ðŸ”§ Ð‘Ñ€Ð¾Ð½Ñ Ð¿Ð¾Ð²Ñ€ÐµÐ¶Ð´ÐµÐ½Ð° (-0.5)!")
    mutant_hp = p.get("mutant_hp", 0)
    player_health = p.get("health", 10)
    display_damage = total_damage
    accuracy = get_total_weapon_accuracy(user_id)
    blast_resist = get_total_blast_resist(user_id)
    weapon_durability = p.get("weapon_durability", 0)
    weapon_max_durability = p.get("weapon_max_durability", 0)
    armor_durability = p.get("armor_durability", 0)
    armor_max_durability = p.get("armor_max_durability", 0)
    special_info = ""
    if mutant_bonus > 0:
        special_info = f" (+{mutant_bonus}ðŸ”«)"
    battle_info = f"\nðŸ‘¹ {mutant['name']}\nÐ¥ÐŸ Ð¼ÑƒÑ‚Ð°Ð½Ñ‚Ð°: {mutant_hp}/{mutant['hp']}\nðŸ’¢ Ð£Ñ€Ð¾Ð½ Ð¼ÑƒÑ‚Ð°Ð½Ñ‚Ð°: {mutant['damage']}\n\nâ¤ï¸ Ð’Ð°ÑˆÐµ Ð¥ÐŸ: {player_health}/10\nðŸ’¢ Ð’Ð°Ñˆ ÑƒÑ€Ð¾Ð½: {display_damage}{special_info}\nðŸŽ¯ Ð¢Ð¾Ñ‡Ð½Ð¾ÑÑ‚ÑŒ: {accuracy}/9\nðŸ¾ Ð Ð°Ð·Ñ€Ñ‹Ð²: {blast_resist}\nðŸ”§ðŸ”« ÐžÑ€ÑƒÐ¶Ð¸Ðµ: {weapon_durability}/{weapon_max_durability}\nðŸ”§ðŸ¦º Ð‘Ñ€Ð¾Ð½Ñ: {armor_durability}/{armor_max_durability}"
    messages.append(battle_info)
    p["state"] = STATE_HUNTING
    save_data()
    send_message(user_id, "\n".join(messages), create_hunting_keyboard(), vk_session)
def handle_exploration(user_id, vk_session):
    p = players[user_id]
    point = p["point"]
    location = p["location"]
    ptype = POINT_TYPES.get(point, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ")
    if not is_player_on_own_territory(user_id):
        send_message(user_id, "âŒ Ð­Ñ‚Ð° Ñ‚ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ð½Ðµ Ð¿Ñ€Ð¸Ð½Ð°Ð´Ð»ÐµÐ¶Ð¸Ñ‚ Ð²Ð°ÑˆÐµÐ¹ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐµ. Ð˜ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½ÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾.", create_main_menu_keyboard(user_id), vk_session)
        return
    if not check_territory_exhaustion(location, point):
        send_message(user_id, "âŒ Ð­Ñ‚Ð° Ñ‚ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ð¸ÑÑ‚Ð¾Ñ‰ÐµÐ½Ð°. Ð”Ð¾Ð¶Ð´Ð¸Ñ‚ÐµÑÑŒ Ð²Ñ‹Ð±Ñ€Ð¾ÑÐ° Ð´Ð»Ñ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ.", create_main_menu_keyboard(user_id), vk_session)
        return
    if ptype == "ÐÐ½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð¾Ð½Ð°":
        if p["health"] <= 0:
            send_message(user_id, "ðŸ’€ Ð’Ñ‹ Ð² ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¸! Ð˜ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½ÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾.", create_main_menu_keyboard(user_id), vk_session)
            return
        if not p.get("detector"):
            send_message(user_id, "âŒ Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ Ð´ÐµÑ‚ÐµÐºÑ‚Ð¾Ñ€Ð° â€” Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÑŒ Ð°Ð½Ð¾Ð¼Ð°Ð»Ð¸Ð¸ Ð½ÐµÐ»ÑŒÐ·Ñ.", create_main_menu_keyboard(user_id), vk_session)
            return
        if p.get("detector_charge", 0) <= 0:
            send_message(user_id, "ðŸ”‹ Ð”ÐµÑ‚ÐµÐºÑ‚Ð¾Ñ€ Ñ€Ð°Ð·Ñ€ÑÐ¶ÐµÐ½ â€” ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ð¾Ð´Ð·Ð°Ñ€ÑÐ´Ð¸Ñ‚Ðµ ÐµÐ³Ð¾.", create_main_menu_keyboard(user_id), vk_session)
            return
        if p["stamina"] <= 0:
            send_message(user_id, "ðŸ˜´ Ð£ Ð²Ð°Ñ Ð·Ð°ÐºÐ¾Ð½Ñ‡Ð¸Ð»Ð°ÑÑŒ Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ â€” Ð¿Ð¾Ñ€Ð° Ð¾Ñ‚Ð´Ð¾Ñ…Ð½ÑƒÑ‚ÑŒ.", create_main_menu_keyboard(user_id), vk_session)
            return
        send_message(user_id, "ðŸ” Ð˜ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ...", create_empty_keyboard(), vk_session)
        add_territory_exhaustion(location, point)
        p["stamina"] = max(0, p["stamina"] - 1)
        p["hunger"] = min(10, p["hunger"] + 0.5)
        status_messages = []
        if p["hunger"] >= 10:
            p["stamina"] = max(0, p["stamina"] - 2)
            p["health"] = max(0, p["health"] - 0.5)
            status_messages.append("ðŸ½ï¸ Ð’Ñ‹ Ð³Ð¾Ð»Ð¾Ð´Ð°ÐµÑ‚Ðµ! (-2âš¡, -0.5â¤ï¸)")
        if p["radiation"] >= 10:
            rad_damage = random.choice([1, 1.5, 2])
            p["health"] = max(0, p["health"] - rad_damage)
            status_messages.append(f"â˜¢ï¸ Ð Ð°Ð´Ð¸Ð°Ñ†Ð¸Ñ Ñ€Ð°Ð·ÑŠÐµÐ´Ð°ÐµÑ‚ Ð²Ð°Ñ! (-{rad_damage}â¤ï¸)")
        apply_belt_effects_on_exploration(user_id)
        radiation_gain = get_radiation_gain("ÐÐ½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð¾Ð½Ð°")
        if radiation_gain > 0:
            p["radiation"] = min(10, p["radiation"] + radiation_gain)
            status_messages.append(f"â˜¢ï¸ Ð’Ñ‹ Ð¿Ð¾Ð¿Ð°Ð»Ð¸ Ð¿Ð¾Ð´ Ð¸Ð·Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ñ€Ð°Ð´Ð¸Ð°Ñ†Ð¸Ð¸! (+{radiation_gain})")
        normalize_stats(user_id)
        save_data()
        if p["health"] <= 0:
            death_msg = "\n".join(status_messages) + "\n\n" if status_messages else ""
            death_msg += "ðŸ’€ Ð’Ñ‹ Ð¿Ð¾Ð³Ð¸Ð±Ð»Ð¸ Ð¾Ñ‚ Ð¸ÑÑ‚Ð¾Ñ‰ÐµÐ½Ð¸Ñ!"
            lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=5, max_money=50)
            loss_lines = format_death_losses(lost_items, money_lost)
            if loss_lines:
                death_msg += "\n" + "\n".join(loss_lines)
            p["death_notified"] = True
            p["state"] = STATE_IN_MENU
            normalize_stats(user_id)
            save_data()
            send_message(user_id, death_msg, create_main_menu_keyboard(user_id), vk_session)
            return
        init_anomaly_exploration(user_id)
        if p.get("anomaly_path_choosing"):
            atype = p.get("current_anomaly_type", "Ð³Ñ€Ð°Ð²Ð¸")
            msg_parts = []
            if status_messages:
                msg_parts.extend(status_messages)
                msg_parts.append("")
            msg_parts.append(f"ðŸŒ€ Ð’Ñ‹ Ð¿Ð¾Ð´Ð¾ÑˆÐ»Ð¸ Ðº Ð°Ð½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð·Ð¾Ð½Ðµ ({atype})")
            msg_parts.append("âš ï¸ Ð’Ð¿ÐµÑ€ÐµÐ´Ð¸ Ð¾Ð¿Ð°ÑÐ½Ñ‹Ð¹ ÑƒÑ‡Ð°ÑÑ‚Ð¾Ðº! Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿ÑƒÑ‚ÑŒ:")
            msg_parts.append("")
            msg_parts.append("ðŸŒ€ Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð´Ð¸Ð½ Ð¿ÑƒÑ‚ÑŒ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐµÐ½...")
            send_message(user_id, "\n".join(msg_parts), create_anomaly_path_keyboard(), vk_session)
        else:
            try:
                img_buffer = generate_anomaly_map_image(user_id)
                upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
                response = vk_session.http.post(upload_url, files={"photo": ("map.png", img_buffer, "image/png")})
                result = response.json()
                photo_data = vk_session.method("photos.saveMessagesPhoto", {"photo": result["photo"], "server": result["server"], "hash": result["hash"]})[0]
                atype = p.get("current_anomaly_type", "Ð³Ñ€Ð°Ð²Ð¸")
                msg_parts = []
                if status_messages:
                    msg_parts.extend(status_messages)
                    msg_parts.append("")
                msg_parts.append(f"ðŸŒ€ Ð’Ñ‹ Ð²Ð¾ÑˆÐ»Ð¸ Ð² Ð°Ð½Ð¾Ð¼Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð·Ð¾Ð½Ñƒ ({atype})")
                msg_parts.append("Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ñ.")
                msg_parts.append("ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ Ð¸ Ð¸Ð·Ð±ÐµÐ³Ð°Ð¹Ñ‚Ðµ Ð°Ð½Ð¾Ð¼Ð°Ð»Ð¸Ð¹!")
                alerts = get_detector_alerts(user_id)
                if alerts:
                    msg_parts.append(alerts)
                vk_session.method("messages.send", {"user_id": user_id, "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}", "random_id": 0, "message": "\n".join(msg_parts), "keyboard": create_anomaly_movement_keyboard().get_keyboard()})
            except Exception as e:
                logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÐºÐ°Ñ€Ñ‚Ñ‹: {e}")
                send_message(user_id, "ðŸŒ€ Ð’Ñ‹ Ð²Ð¾ÑˆÐ»Ð¸ Ð² Ð°Ð½Ð¾Ð¼Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð·Ð¾Ð½Ñƒ. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ñ.", create_anomaly_movement_keyboard(), vk_session)
        return
    if ptype == "Ð›Ð¾Ð³Ð¾Ð²Ð¾":
        if p["health"] <= 0:
            send_message(user_id, "ðŸ’€ Ð’Ñ‹ Ð² ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¸! ÐžÑ…Ð¾Ñ‚Ð° Ð½ÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð°.", create_main_menu_keyboard(user_id), vk_session)
            return
        if not p.get("weapon"):
            send_message(user_id, "âŒ Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ Ð¾Ñ€ÑƒÐ¶Ð¸Ñ â€” Ð¾Ñ…Ð¾Ñ‚Ð¸Ñ‚ÑŒÑÑ Ð½ÐµÐ»ÑŒÐ·Ñ.", create_main_menu_keyboard(user_id), vk_session)
            return
        if p.get("weapon_durability", 0) <= 0:
            send_message(user_id, "ðŸ”§ Ð’Ð°ÑˆÐµ Ð¾Ñ€ÑƒÐ¶Ð¸Ðµ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ ÑÐ»Ð¾Ð¼Ð°Ð½Ð¾ â€” ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ð¾Ñ‡Ð¸Ð½Ð¸Ñ‚Ðµ ÐµÐ³Ð¾.", create_main_menu_keyboard(user_id), vk_session)
            return
        if p["stamina"] <= 0:
            send_message(user_id, "ðŸ˜´ Ð£ Ð²Ð°Ñ Ð·Ð°ÐºÐ¾Ð½Ñ‡Ð¸Ð»Ð°ÑÑŒ Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ â€” Ð¿Ð¾Ñ€Ð° Ð¾Ñ‚Ð´Ð¾Ñ…Ð½ÑƒÑ‚ÑŒ.", create_main_menu_keyboard(user_id), vk_session)
            return
        send_message(user_id, "ðŸ” Ð˜ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ...", create_empty_keyboard(), vk_session)
        add_territory_exhaustion(location, point)
        p["stamina"] = max(0, p["stamina"] - 1)
        p["hunger"] = min(10, p["hunger"] + 0.5)
        status_messages = []
        if p["hunger"] >= 10:
            p["stamina"] = max(0, p["stamina"] - 2)
            p["health"] = max(0, p["health"] - 0.5)
            status_messages.append("ðŸ½ï¸ Ð’Ñ‹ Ð³Ð¾Ð»Ð¾Ð´Ð°ÐµÑ‚Ðµ! (-2âš¡, -0.5â¤ï¸)")
        if p["radiation"] >= 10:
            rad_damage = random.choice([1, 1.5, 2])
            p["health"] = max(0, p["health"] - rad_damage)
            status_messages.append(f"â˜¢ï¸ Ð Ð°Ð´Ð¸Ð°Ñ†Ð¸Ñ Ñ€Ð°Ð·ÑŠÐµÐ´Ð°ÐµÑ‚ Ð²Ð°Ñ! (-{rad_damage}â¤ï¸)")
        apply_belt_effects_on_exploration(user_id)
        radiation_gain = get_radiation_gain("Ð›Ð¾Ð³Ð¾Ð²Ð¾")
        if radiation_gain > 0:
            p["radiation"] = min(10, p["radiation"] + radiation_gain)
            status_messages.append(f"â˜¢ï¸ Ð’Ñ‹ Ð¿Ð¾Ð¿Ð°Ð»Ð¸ Ð¿Ð¾Ð´ Ð¸Ð·Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ñ€Ð°Ð´Ð¸Ð°Ñ†Ð¸Ð¸! (+{radiation_gain})")
        normalize_stats(user_id)
        save_data()
        if p["health"] <= 0:
            death_msg = "\n".join(status_messages) + "\n\n" if status_messages else ""
            death_msg += "ðŸ’€ Ð’Ñ‹ Ð¿Ð¾Ð³Ð¸Ð±Ð»Ð¸ Ð¾Ñ‚ Ð¸ÑÑ‚Ð¾Ñ‰ÐµÐ½Ð¸Ñ!"
            lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=5, max_money=50)
            loss_lines = format_death_losses(lost_items, money_lost)
            if loss_lines:
                death_msg += "\n" + "\n".join(loss_lines)
            p["death_notified"] = True
            p["state"] = STATE_IN_MENU
            normalize_stats(user_id)
            save_data()
            send_message(user_id, death_msg, create_main_menu_keyboard(user_id), vk_session)
            return
        loc = p["location"]
        mutant = select_mutant(loc, point)
        if not mutant:
            msg = "âŒ Ð’ ÑÑ‚Ð¾Ð¼ Ð»Ð¾Ð³Ð¾Ð²Ðµ Ð¿ÑƒÑÑ‚Ð¾..."
            if status_messages:
                msg = "\n".join(status_messages) + "\n\n" + msg
            send_message(user_id, msg, create_main_menu_keyboard(user_id), vk_session)
            return
        p["current_mutant"] = mutant
        p["mutant_hp"] = mutant["hp"]
        weapon_accuracy = get_total_weapon_accuracy(user_id)
        all_buttons = list(range(1, 10))
        if weapon_accuracy > 0:
            valid_targets = random.sample(all_buttons, min(weapon_accuracy, 9))
        else:
            valid_targets = []
        p["valid_targets"] = valid_targets
        p["state"] = STATE_HUNTING
        save_data()
        try:
            upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
            img_path = f"mutants/{mutant['name'].lower().replace(' ', '_').replace('Ñ‘', 'Ðµ')}.png"
            if os.path.exists(img_path):
                with open(img_path, "rb") as f:
                    response = vk_session.http.post(upload_url, files={"photo": f})
                    result = response.json()
                    photo_data = vk_session.method("photos.saveMessagesPhoto", {"photo": result["photo"], "server": result["server"], "hash": result["hash"]})[0]
                    attachment = f"photo{photo_data['owner_id']}_{photo_data['id']}"
            else:
                attachment = None
        except Exception as e:
            logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð¼ÑƒÑ‚Ð°Ð½Ñ‚Ð°: {e}")
            attachment = None
        accuracy = get_total_weapon_accuracy(user_id)
        weapon_damage = get_total_weapon_damage(user_id)
        weapon_durability = p.get("weapon_durability", 0)
        weapon_max_durability = p.get("weapon_max_durability", 0)
        armor_durability = p.get("armor_durability", 0)
        armor_max_durability = p.get("armor_max_durability", 0)
        player_health = p.get("health", 10)
        blast_resist = get_total_blast_resist(user_id)
        msg_parts = []
        if status_messages:
            msg_parts.extend(status_messages)
            msg_parts.append("")
        msg_parts.append(f"ðŸ‘¹ Ð’ÑÑ‚Ñ€ÐµÑ‡ÐµÐ½ Ð¼ÑƒÑ‚Ð°Ð½Ñ‚: {mutant['name']}")
        msg_parts.append(f"Ð¥ÐŸ Ð¼ÑƒÑ‚Ð°Ð½Ñ‚Ð°: {mutant['hp']}/{mutant['hp']}")
        msg_parts.append(f"ðŸ’¢ Ð£Ñ€Ð¾Ð½ Ð¼ÑƒÑ‚Ð°Ð½Ñ‚Ð°: {mutant['damage']}")
        msg_parts.append(f"ðŸ’² ÐÐ°Ð³Ñ€Ð°Ð´Ð°: {mutant['reward']}Ñ€")
        msg_parts.append("")
        msg_parts.append(f"â¤ï¸ Ð’Ð°ÑˆÐµ Ð¥ÐŸ: {player_health}/10")
        msg_parts.append(f"ðŸ’¢ Ð’Ð°Ñˆ ÑƒÑ€Ð¾Ð½: {weapon_damage}")
        msg_parts.append(f"ðŸŽ¯ Ð¢Ð¾Ñ‡Ð½Ð¾ÑÑ‚ÑŒ: {accuracy}/9")
        msg_parts.append(f"ðŸ¾ Ð Ð°Ð·Ñ€Ñ‹Ð²: {blast_resist}")
        msg_parts.append(f"ðŸ”§ðŸ”« ÐžÑ€ÑƒÐ¶Ð¸Ðµ: {weapon_durability}/{weapon_max_durability}")
        msg_parts.append(f"ðŸ”§ðŸ¦º Ð‘Ñ€Ð¾Ð½Ñ: {armor_durability}/{armor_max_durability}")
        msg = "\n".join(msg_parts)
        keyboard = create_hunting_keyboard()
        params = {"user_id": user_id, "message": msg, "random_id": 0, "keyboard": keyboard.get_keyboard()}
        if attachment:
            params["attachment"] = attachment
        vk_session.method("messages.send", params)
        return
    ok, msg = check_vital_conditions(user_id, "Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ")
    if not ok:
        send_message(user_id, msg, create_main_menu_keyboard(user_id), vk_session)
        return
    send_message(user_id, "ðŸ” Ð˜ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ...", create_empty_keyboard(), vk_session)
    add_territory_exhaustion(location, point)
    p["stamina"] = max(0, p["stamina"] - 1)
    p["hunger"] = min(10, p["hunger"] + 0.5)
    radiation_gain = get_radiation_gain(ptype)
    result_lines = []
    if radiation_gain > 0:
        p["radiation"] = min(10, p["radiation"] + radiation_gain)
        result_lines.append(f"â˜¢ï¸ Ð’Ñ‹ Ð¿Ð¾Ð¿Ð°Ð»Ð¸ Ð¿Ð¾Ð´ Ð¸Ð·Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ñ€Ð°Ð´Ð¸Ð°Ñ†Ð¸Ð¸! (+{radiation_gain})")
    status_messages = []
    if p["hunger"] >= 10:
        p["stamina"] = max(0, p["stamina"] - 2)
        p["health"] = max(0, p["health"] - 0.5)
        status_messages.append("ðŸ½ï¸ Ð’Ñ‹ Ð³Ð¾Ð»Ð¾Ð´Ð°ÐµÑ‚Ðµ! (-2âš¡, -0.5â¤ï¸)")
    if p["radiation"] >= 10:
        rad_damage = random.choice([1, 1.5, 2])
        p["health"] = max(0, p["health"] - rad_damage)
        status_messages.append(f"â˜¢ï¸ Ð Ð°Ð´Ð¸Ð°Ñ†Ð¸Ñ Ñ€Ð°Ð·ÑŠÐµÐ´Ð°ÐµÑ‚ Ð²Ð°Ñ! (-{rad_damage}â¤ï¸)")
    apply_belt_effects_on_exploration(user_id)
    if p["health"] <= 0:
        death_msg = ""
        if status_messages:
            death_msg = "\n".join(status_messages) + "\n\n"
        death_msg += "ðŸ’€ Ð’Ñ‹ Ð¿Ð¾Ð³Ð¸Ð±Ð»Ð¸ Ð¾Ñ‚ Ð¸ÑÑ‚Ð¾Ñ‰ÐµÐ½Ð¸Ñ!"
        lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=5, max_money=50)
        loss_lines = format_death_losses(lost_items, money_lost)
        if loss_lines:
            death_msg += "\n" + "\n".join(loss_lines)
        p["death_notified"] = True
        p["state"] = STATE_IN_MENU
        normalize_stats(user_id)
        save_data()
        send_message(user_id, death_msg, create_main_menu_keyboard(user_id), vk_session)
        return
    drops = {}
    if ptype == "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ":
        drops = roll_drops(DROP_T, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ")
        if location == "ÐŸÐ¾Ð»ÑÐ½Ð°" and point.startswith("Ð¢"):
            for item, data in DROP_POLYANA_T.items():
                if random.randint(1, 100) <= data["chance"]:
                    amount = random.randint(data["min"], data["max"])
                    drops[item] = drops.get(item, 0) + amount
    elif ptype == "Ð¢Ð¾Ñ‡ÐºÐ° Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²":
        drops = roll_drops(DROP_TR, "Ð¢Ð¾Ñ‡ÐºÐ° Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²")
    elif ptype == "Ð‘Ð°Ð·Ð°":
        drops = roll_drops(DROP_B, "Ð‘Ð°Ð·Ð°")
    if status_messages:
        result_lines.extend(status_messages)
    for item, amount in drops.items():
        if item == "Ð”ÐµÐ½ÑŒÐ³Ð¸":
            p["money"] = p.get("money", 0) + amount
            result_lines.append(f"ðŸ’² ÐÐ°Ð¹Ð´ÐµÐ½Ð¾: {amount}Ñ€")
        else:
            p["backpack"][item] = p["backpack"].get(item, 0) + amount
            result_lines.append(f"ðŸ“¦ ÐÐ°Ð¹Ð´ÐµÐ½Ð¾: {item} x{amount}")
    if not drops and not result_lines:
        result_lines.append("ðŸ” Ð’Ð°Ð¼ Ð½Ðµ Ð²Ñ‹Ð¿Ð°Ð»Ð¾ Ð½Ð¸Ñ‡ÐµÐ³Ð¾.")
    save_data()
    send_message(user_id, "\n".join(result_lines), create_main_menu_keyboard(user_id), vk_session)
def init_territory_exhaustion():
    global territory_exhaustion
    territory_exhaustion = {}
    for loc in LOCATIONS:
        territory_exhaustion[loc] = {}
        for point in LOCATIONS[loc]:
            territory_exhaustion[loc][point] = 0
    save_data()
def init_last_stand_mode():
    global players, factions, territory_control, territory_exhaustion
    global last_restored_categories, faction_shared_squads, LAST_STAND_MODE
    global faction_warehouses, faction_warehouse_money, zombie_bot
    global emission_schedule, emission_warned
    LAST_STAND_MODE = True
    territory_control = {}
    territory_exhaustion = {}
    emission_schedule = []
    emission_warned = []
    last_restored_categories = []
    faction_shared_squads = {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": 0, "â˜¦ï¸ Ð“Ñ€ÐµÑ…": 0, "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": 0, ZOMBIE_FACTION: 0}
    faction_warehouses = {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": {}, "â˜¦ï¸ Ð“Ñ€ÐµÑ…": {}, "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": {}, ZOMBIE_FACTION: {}}
    faction_warehouse_money = {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": 0, "â˜¦ï¸ Ð“Ñ€ÐµÑ…": 0, "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": 0, ZOMBIE_FACTION: 0}
    zombie_bot = {"money": 0, "squads": 0, "food_units": 0, "med_units": 0, "rad_units": 0, "last_action_time": 0, "next_action": "", "backpack": {}, "mode": "normal", "priority_target": None, "agro_points": [], "last_attacked_by": None, "pending_target": None, "last_logs": [], "bonus_squads": 0}
    for loc in LOCATIONS:
        territory_control[loc] = {}
        territory_exhaustion[loc] = {}
        for point in LOCATIONS[loc]:
            territory_control[loc][point] = {"faction": None, "squads": 0}
            territory_exhaustion[loc][point] = 0
    territory_control["ÐšÐ¾Ñ€Ð´Ð¾Ð½"]["Ð‘1"] = {"faction": "ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³", "squads": 5}
    territory_control["ÐšÐ¾Ñ€Ð´Ð¾Ð½"]["Ð‘2"] = {"faction": "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸", "squads": 5}
    territory_control["ÐšÐ¾Ñ€Ð´Ð¾Ð½"]["Ð‘3"] = {"faction": "â˜¦ï¸ Ð“Ñ€ÐµÑ…", "squads": 5}
    territory_control["Ð¡Ð²Ð°Ð»ÐºÐ°"]["Ð‘1"] = {"faction": ZOMBIE_FACTION, "squads": 5}
    territory_control["ÐŸÐ¾Ð»ÑÐ½Ð°"]["Ð‘1"] = {"faction": ZOMBIE_FACTION, "squads": 5}
    territory_control["Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°"]["Ð‘3"] = {"faction": ZOMBIE_FACTION, "squads": 5}
    for uid, p in players.items():
        faction = p.get("faction")
        if faction and faction in LAST_STAND_START_POSITIONS and faction != ZOMBIE_FACTION:
            start_loc, start_point = LAST_STAND_START_POSITIONS[faction]
            p["location"] = start_loc
            p["point"] = start_point
            p["state"] = STATE_IN_MENU
            p["transition_end_time"] = None
    generate_emission_schedule()
    save_data()
def init_last_stand_mode_v2():
    global players, factions, territory_control, territory_exhaustion
    global last_restored_categories, faction_shared_squads, LAST_STAND_MODE
    global faction_warehouses, faction_warehouse_money, zombie_bot
    global emission_schedule, emission_warned
    LAST_STAND_MODE = True
    territory_control = {}
    territory_exhaustion = {}
    emission_schedule = []
    emission_warned = []
    last_restored_categories = []
    faction_shared_squads = {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": 0, "â˜¦ï¸ Ð“Ñ€ÐµÑ…": 0, "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": 0, ZOMBIE_FACTION: 0}
    faction_warehouses = {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": {}, "â˜¦ï¸ Ð“Ñ€ÐµÑ…": {}, "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": {}, ZOMBIE_FACTION: {}}
    faction_warehouse_money = {"ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³": 0, "â˜¦ï¸ Ð“Ñ€ÐµÑ…": 0, "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": 0, ZOMBIE_FACTION: 0}
    zombie_bot = {"money": 0, "squads": 85, "food_units": 0, "med_units": 0, "rad_units": 0, "last_action_time": time.time(), "next_action": "Ð»ÑƒÑ‚Ð°Ð½Ð¸Ðµ", "backpack": {}, "mode": "normal", "priority_target": None, "agro_points": [], "last_attacked_by": None, "pending_target": None, "last_logs": [], "bonus_squads": 85}
    for loc in LOCATIONS:
        territory_control[loc] = {}
        territory_exhaustion[loc] = {}
        for point in LOCATIONS[loc]:
            territory_control[loc][point] = {"faction": None, "squads": 0}
            territory_exhaustion[loc][point] = 0
    territory_control["ÐšÐ¾Ñ€Ð´Ð¾Ð½"]["Ð‘1"] = {"faction": "ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³", "squads": 5}
    territory_control["Ð¡Ð²Ð°Ð»ÐºÐ°"]["Ð‘1"] = {"faction": "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸", "squads": 5}
    territory_control["Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°"]["Ð‘1"] = {"faction": "â˜¦ï¸ Ð“Ñ€ÐµÑ…", "squads": 5}
    territory_control["ÐŸÐ¾Ð»ÑÐ½Ð°"]["Ð‘1"] = {"faction": ZOMBIE_FACTION, "squads": 5}
    for uid, p in players.items():
        faction = p.get("faction")
        if faction == "ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³":
            p["location"] = "ÐšÐ¾Ñ€Ð´Ð¾Ð½"
            p["point"] = "Ð‘1"
        elif faction == "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸":
            p["location"] = "Ð¡Ð²Ð°Ð»ÐºÐ°"
            p["point"] = "Ð‘1"
        elif faction == "â˜¦ï¸ Ð“Ñ€ÐµÑ…":
            p["location"] = "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°"
            p["point"] = "Ð‘1"
        if faction and faction != ZOMBIE_FACTION:
            p["state"] = STATE_IN_MENU
            p["transition_end_time"] = None
    generate_emission_schedule()
    save_data()
def get_zombie_controlled_locations():
    controlled = []
    for loc in LOCATIONS:
        for point in LOCATIONS[loc]:
            if get_territory_owner(loc, point) == ZOMBIE_FACTION:
                controlled.append((loc, point))
    return controlled
def get_zombie_available_targets():
    controlled = get_zombie_controlled_locations()
    if not controlled:
        return []
    available_locs = set()
    for loc, point in controlled:
        available_locs.add(loc)
        if (loc, point) in TRANSITION_ROUTES:
            for dest_loc, dest_point in TRANSITION_ROUTES[(loc, point)]:
                available_locs.add(dest_loc)
    targets = []
    for loc in available_locs:
        for point in LOCATIONS[loc]:
            owner = get_territory_owner(loc, point)
            if owner != ZOMBIE_FACTION:
                enemy_squads = get_territory_squads(loc, point)
                ptype = POINT_TYPES.get(point, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ")
                targets.append({"loc": loc, "point": point, "owner": owner, "squads": enemy_squads, "type": ptype})
    random.shuffle(targets)
    return targets
def zombie_loot_territory(loc, point, vk_session):
    global zombie_bot
    ptype = POINT_TYPES.get(point, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ")
    logs = []
    total_money = 0
    total_items = {}
    for _ in range(10):
        if not check_territory_exhaustion(loc, point):
            break
        add_territory_exhaustion(loc, point)
        if ptype == "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ":
            drops = roll_drops(DROP_T, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ")
        elif ptype == "Ð¢Ð¾Ñ‡ÐºÐ° Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²":
            drops = roll_drops(DROP_TR, "Ð¢Ð¾Ñ‡ÐºÐ° Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²")
        elif ptype == "Ð‘Ð°Ð·Ð°":
            drops = roll_drops(DROP_B, "Ð‘Ð°Ð·Ð°")
        elif ptype == "ÐÐ½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð¾Ð½Ð°":
            money_gain = random.randint(10, 30)
            total_money += money_gain
            continue
        elif ptype == "Ð›Ð¾Ð³Ð¾Ð²Ð¾":
            money_gain = random.randint(15, 40)
            total_money += money_gain
            continue
        else:
            drops = roll_drops(DROP_T, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ")
        for item, amount in drops.items():
            if item == "Ð”ÐµÐ½ÑŒÐ³Ð¸":
                total_money += amount
            else:
                total_items[item] = total_items.get(item, 0) + amount
    zombie_bot["money"] += total_money
    for item, amount in total_items.items():
        zombie_bot["backpack"][item] = zombie_bot["backpack"].get(item, 0) + amount
    logs.append(f"ðŸ“ {loc} {point}: ðŸ’²{total_money}Ñ€")
    if total_items:
        items_str = ", ".join([f"{k} x{v}" for k, v in total_items.items()])
        logs.append(f"   ðŸ“¦ {items_str}")
    save_data()
    return logs
def zombie_convert_items():
    global zombie_bot
    logs = []
    for item_name, conv_data in CONVERSION_VALUES.items():
        count = zombie_bot["backpack"].get(item_name, 0)
        if count > 0:
            if conv_data["type"] == "special":
                med_value = conv_data.get("med", 0) * count
                rad_value = conv_data.get("rad", 0) * count
                zombie_bot["med_units"] += med_value
                zombie_bot["rad_units"] += rad_value
            else:
                unit_type = conv_data["type"]
                unit_value = conv_data["value"] * count
                if unit_type == "food":
                    zombie_bot["food_units"] += unit_value
                elif unit_type == "med":
                    zombie_bot["med_units"] += unit_value
                elif unit_type == "rad":
                    zombie_bot["rad_units"] += unit_value
            del zombie_bot["backpack"][item_name]
            logs.append(f"â™»ï¸ ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾: {item_name} x{count}")
    save_data()
    return logs
def zombie_sell_items():
    global zombie_bot
    logs = []
    total_earned = 0
    always_sell = ["ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸Ðº Ð½Ð¾Ð½ÑÑ‚Ð¾Ð¿", "ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸Ðº ÑÑ‚Ð°Ð»ÐºÐµÑ€", "Ð³ÐµÑ€ÐºÑƒÐ»ÐµÑ", "Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸"]
    for item_name in always_sell:
        count = zombie_bot["backpack"].get(item_name, 0)
        if count > 0:
            price = BUY_PRICES.get(item_name, 0) * count
            zombie_bot["money"] += price
            total_earned += price
            logs.append(f"ðŸ’° {item_name} x{count} = {price}Ñ€")
            del zombie_bot["backpack"][item_name]
    for art in ALL_ARTIFACTS:
        count = zombie_bot["backpack"].get(art, 0)
        if count > 0:
            price = ARTIFACT_PRICES.get(art, 15) * count
            zombie_bot["money"] += price
            total_earned += price
            logs.append(f"ðŸ’° {art} x{count} = {price}Ñ€")
            del zombie_bot["backpack"][art]
    max_units = 50
    if zombie_bot["food_units"] > max_units:
        for item_name in ["ÐºÐ¾Ð½ÑÐµÑ€Ð²Ð°", "ÐºÐ¾Ð»Ð±Ð°ÑÐ°", "Ñ…Ð»ÐµÐ±", "ÑˆÐ¾ÐºÐ¾Ð»Ð°Ð´Ð½Ñ‹Ð¹ Ð±Ð°Ñ‚Ð¾Ð½Ñ‡Ð¸Ðº"]:
            count = zombie_bot["backpack"].get(item_name, 0)
            if count > 0:
                price = BUY_PRICES.get(item_name, 0) * count
                zombie_bot["money"] += price
                total_earned += price
                logs.append(f"ðŸ’° {item_name} x{count} = {price}Ñ€ (Ð¸Ð·Ð»Ð¸ÑˆÐºÐ¸)")
                del zombie_bot["backpack"][item_name]
    if zombie_bot["med_units"] > max_units:
        for item_name in ["Ð½Ð°ÑƒÑ‡Ð½Ð°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°", "Ð°Ñ€Ð¼ÐµÐ¹ÑÐºÐ°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°", "Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°", "Ð±Ð¸Ð½Ñ‚"]:
            count = zombie_bot["backpack"].get(item_name, 0)
            if count > 0:
                price = BUY_PRICES.get(item_name, 0) * count
                zombie_bot["money"] += price
                total_earned += price
                logs.append(f"ðŸ’° {item_name} x{count} = {price}Ñ€ (Ð¸Ð·Ð»Ð¸ÑˆÐºÐ¸)")
                del zombie_bot["backpack"][item_name]
    if zombie_bot["rad_units"] > max_units:
        for item_name in ["Ð°Ð½Ñ‚Ð¸Ñ€Ð°Ð´", "Ñ€Ð°Ð´Ð¸Ð¾Ð¿Ñ€Ð¾Ñ‚ÐµÐºÑ‚Ð¾Ñ€", "Ð²Ð¾Ð´ÐºÐ°", "ÑÐ¸Ð³Ð°Ñ€ÐµÑ‚Ñ‹"]:
            count = zombie_bot["backpack"].get(item_name, 0)
            if count > 0:
                price = BUY_PRICES.get(item_name, 0) * count
                zombie_bot["money"] += price
                total_earned += price
                logs.append(f"ðŸ’° {item_name} x{count} = {price}Ñ€ (Ð¸Ð·Ð»Ð¸ÑˆÐºÐ¸)")
                del zombie_bot["backpack"][item_name]
    if total_earned > 0:
        logs.insert(0, f"ðŸ’² ÐŸÑ€Ð¾Ð´Ð°Ð½Ð¾ Ð½Ð° {total_earned}Ñ€:")
    save_data()
    return logs
def zombie_buy_squads():
    global zombie_bot
    logs = []
    bought = 0
    while True:
        can_buy_5 = (zombie_bot["money"] >= 500 and zombie_bot["food_units"] >= 15 and zombie_bot["med_units"] >= 15 and zombie_bot["rad_units"] >= 15)
        can_buy_3 = (zombie_bot["money"] >= 300 and zombie_bot["food_units"] >= 10 and zombie_bot["med_units"] >= 10 and zombie_bot["rad_units"] >= 10)
        can_buy_1 = (zombie_bot["money"] >= 100 and zombie_bot["food_units"] >= 5 and zombie_bot["med_units"] >= 5 and zombie_bot["rad_units"] >= 5)
        if can_buy_5:
            zombie_bot["money"] -= 500
            zombie_bot["food_units"] -= 15
            zombie_bot["med_units"] -= 15
            zombie_bot["rad_units"] -= 15
            zombie_bot["squads"] += 5
            bought += 5
        elif can_buy_3:
            zombie_bot["money"] -= 300
            zombie_bot["food_units"] -= 10
            zombie_bot["med_units"] -= 10
            zombie_bot["rad_units"] -= 10
            zombie_bot["squads"] += 3
            bought += 3
        elif can_buy_1:
            zombie_bot["money"] -= 100
            zombie_bot["food_units"] -= 5
            zombie_bot["med_units"] -= 5
            zombie_bot["rad_units"] -= 5
            zombie_bot["squads"] += 1
            bought += 1
        else:
            break
    if bought > 0:
        logs.append(f"ðŸ‘¨â€ðŸ‘¨â€ðŸ‘¦â€ðŸ‘¦ ÐšÑƒÐ¿Ð»ÐµÐ½Ð¾ ÑÐºÐ²Ð°Ð´Ð¾Ð²: {bought} (Ð²ÑÐµÐ³Ð¾: {zombie_bot['squads']})")
    save_data()
    return logs
def zombie_choose_target():
    global zombie_bot
    agro_points = zombie_bot.get("agro_points", [])
    for ap in agro_points:
        if isinstance(ap, tuple):
            loc, point = ap[0], ap[1]
            attacker = None
        else:
            loc, point = ap["loc"], ap["point"]
            attacker = ap.get("attacker")
        owner = get_territory_owner(loc, point)
        if owner != ZOMBIE_FACTION:
            enemy_squads = get_territory_squads(loc, point)
            ptype = POINT_TYPES.get(point, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ")
            min_needed = MIN_SQUADS_FOR_POINT.get(ptype, 1)
            squads_needed = max(min_needed, enemy_squads + random.randint(3, 6))
            if zombie_bot["squads"] >= squads_needed:
                return loc, point, squads_needed
            else:
                zombie_bot["pending_target"] = (loc, point, squads_needed)
                return None, None, 0
    revenge_target = zombie_bot.get("revenge_target")
    if revenge_target:
        targets = get_zombie_available_targets()
        revenge_targets = [t for t in targets if t["owner"] == revenge_target]
        if revenge_targets:
            random.shuffle(revenge_targets)
            for target in revenge_targets:
                loc, point = target["loc"], target["point"]
                enemy_squads = target["squads"]
                ptype = target["type"]
                min_needed = MIN_SQUADS_FOR_POINT.get(ptype, 1)
                squads_needed = max(min_needed, enemy_squads + random.randint(2, 5))
                if zombie_bot["squads"] >= squads_needed:
                    zombie_bot["revenge_target"] = None
                    return loc, point, squads_needed
    priority = zombie_bot.get("priority_target")
    if priority:
        loc, point = priority
        current_owner = get_territory_owner(loc, point)
        if current_owner != ZOMBIE_FACTION:
            controlled = get_zombie_controlled_locations()
            can_reach = False
            for cloc, cpoint in controlled:
                if cloc == loc:
                    can_reach = True
                    break
                if (cloc, cpoint) in TRANSITION_ROUTES:
                    for dest_loc, dest_point in TRANSITION_ROUTES[(cloc, cpoint)]:
                        if dest_loc == loc:
                            can_reach = True
                            break
            if can_reach:
                enemy_squads = get_territory_squads(loc, point)
                ptype = POINT_TYPES.get(point, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ")
                min_needed = MIN_SQUADS_FOR_POINT.get(ptype, 1)
                squads_needed = max(min_needed, enemy_squads + random.randint(2, 5))
                if zombie_bot["squads"] >= squads_needed:
                    return loc, point, squads_needed
                else:
                    zombie_bot["pending_target"] = (loc, point, squads_needed)
                    return None, None, 0
            else:
                for cloc, cpoint in controlled:
                    if (cloc, cpoint) in TRANSITION_ROUTES:
                        for dest_loc, dest_point in TRANSITION_ROUTES[(cloc, cpoint)]:
                            if dest_loc == loc:
                                if get_territory_owner(dest_loc, dest_point) != ZOMBIE_FACTION:
                                    enemy_squads = get_territory_squads(dest_loc, dest_point)
                                    ptype = POINT_TYPES.get(dest_point, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ")
                                    min_needed = MIN_SQUADS_FOR_POINT.get(ptype, 1)
                                    squads_needed = max(min_needed, enemy_squads + 3)
                                    if zombie_bot["squads"] >= squads_needed:
                                        return dest_loc, dest_point, squads_needed
    pending = zombie_bot.get("pending_target")
    if pending:
        loc, point, squads_needed = pending
        if get_territory_owner(loc, point) == ZOMBIE_FACTION:
            zombie_bot["pending_target"] = None
        elif zombie_bot["squads"] >= squads_needed:
            zombie_bot["pending_target"] = None
            return loc, point, squads_needed
        else:
            return None, None, 0
    targets = get_zombie_available_targets()
    if not targets:
        return None, None, 0
    valid_targets = [t for t in targets if t["owner"] != ZOMBIE_FACTION]
    if not valid_targets:
        return None, None, 0
    selected = random.choice(valid_targets)
    loc, point = selected["loc"], selected["point"]
    owner = selected["owner"]
    enemy_squads = selected["squads"]
    ptype = selected["type"]
    min_needed = MIN_SQUADS_FOR_POINT.get(ptype, 1)
    if owner is None:
        squads_needed = min_needed
    else:
        squads_needed = max(min_needed, enemy_squads + random.randint(1, 4))
    if zombie_bot["squads"] >= squads_needed:
        return loc, point, squads_needed
    else:
        zombie_bot["pending_target"] = (loc, point, squads_needed)
        return None, None, 0
def zombie_attack(loc, point, squad_count, vk_session):
    global zombie_bot, territory_control
    logs = []
    owner = get_territory_owner(loc, point)
    if owner == ZOMBIE_FACTION:
        logs.append(f"â„¹ï¸ {loc} {point} ÑƒÐ¶Ðµ Ð¿Ð¾Ð´ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÐµÐ¼ Ð·Ð¾Ð¼Ð±Ð¸")
        return logs
    enemy_squads = get_territory_squads(loc, point)
    ptype = POINT_TYPES.get(point, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ")
    min_needed = MIN_SQUADS_FOR_POINT.get(ptype, 1)
    if owner is None:
        set_territory_control(loc, point, ZOMBIE_FACTION, squad_count)
        zombie_bot["squads"] -= squad_count
        logs.append(f"âœ… Ð—Ð°Ñ…Ð²Ð°Ñ‡ÐµÐ½Ð¾: {loc} {point} ({squad_count} ÑÐºÐ²Ð°Ð´Ð¾Ð²)")
        try:
            vk_session.method("messages.send", {"peer_id": GAME_CHAT_ID, "message": f"ðŸ§Ÿ Ð—Ð¾Ð¼Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð·Ð°Ñ…Ð²Ð°Ñ‚Ð¸Ð»Ð¸ {loc} {point}!", "random_id": 0})
        except:
            pass
        save_data()
        return logs
    if owner and owner != ZOMBIE_FACTION:
        leader = get_faction_leader(owner)
        if leader and leader in players:
            send_message(leader, f"âš ï¸ Ð—Ð¾Ð¼Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð°Ñ‚Ð°ÐºÑƒÑŽÑ‚ {loc} {point} ÑÐ¸Ð»Ð°Ð¼Ð¸ {squad_count} ÑÐºÐ²Ð°Ð´Ð¾Ð²!", None, vk_session)
    defenders = get_players_on_territory(loc, point)
    defender_players = [uid for uid in defenders if uid in players and players[uid].get("faction") == owner and players[uid].get("health", 0) > 0]
    if defender_players:
        damage_per_player = squad_count / max(1, len(defender_players))
        for def_id in defender_players:
            p = players[def_id]
            bullet_resist = get_player_bullet_resist(def_id)
            actual_damage = max(0.5, damage_per_player - bullet_resist)
            p["health"] = max(0, p["health"] - actual_damage)
            send_message(def_id, f"âš”ï¸ Ð—Ð¾Ð¼Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð°Ñ‚Ð°ÐºÑƒÑŽÑ‚ {loc} {point}!\nðŸ’” ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ {actual_damage} ÑƒÑ€Ð¾Ð½Ð° Ð¾Ñ‚ Ð°Ñ‚Ð°ÐºÐ¸.", None, vk_session)
            if random.randint(1, 100) <= 30:
                if p.get("armor") and p.get("armor_durability", 0) > 0:
                    p["armor_durability"] = max(0, p["armor_durability"] - 1)
                    send_message(def_id, "ðŸ”§ Ð‘Ñ€Ð¾Ð½Ñ Ð¿Ð¾Ð²Ñ€ÐµÐ¶Ð´ÐµÐ½Ð° (-1)!", None, vk_session)
            if p["health"] <= 0:
                p["death_notified"] = True
                lost_items, money_lost = calculate_and_apply_death_losses(def_id, max_items=10, max_money=100)
                for item, count in lost_items.items():
                    zombie_bot["backpack"][item] = zombie_bot["backpack"].get(item, 0) + count
                zombie_bot["money"] += money_lost
                msg_lines = ["ðŸ’€ Ð’Ñ‹ Ð¿Ð¾Ð³Ð¸Ð±Ð»Ð¸ Ð¾Ñ‚ Ð°Ñ‚Ð°ÐºÐ¸ Ð·Ð¾Ð¼Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ…!"]
                msg_lines.extend(format_death_losses(lost_items, money_lost))
                new_loc, new_point = find_nearest_faction_territory(def_id)
                if new_loc and new_point:
                    p["location"] = new_loc
                    p["point"] = new_point
                    msg_lines.append(f"\nðŸ“ Ð’Ñ‹ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ñ‹ Ð½Ð° {new_loc} {new_point}")
                send_message(def_id, "\n".join(msg_lines), create_main_menu_keyboard(def_id), vk_session)
                logs.append(f"ðŸ’€ Ð£Ð±Ð¸Ñ‚ Ð¸Ð³Ñ€Ð¾Ðº: {p.get('nickname', '?')}")
    remaining_after_battle = squad_count - enemy_squads
    if remaining_after_battle >= min_needed:
        set_territory_control(loc, point, ZOMBIE_FACTION, remaining_after_battle)
        zombie_bot["squads"] -= squad_count
        logs.append(f"âš”ï¸ ÐÑ‚Ð°ÐºÐ°: {loc} {point} vs {owner}")
        logs.append(f"âœ… Ð—Ð°Ñ…Ð²Ð°Ñ‡ÐµÐ½Ð¾! ÐŸÐ¾Ñ‚ÐµÑ€Ð¸: {enemy_squads}, Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¾: {remaining_after_battle}")
        try:
            vk_session.method("messages.send", {"peer_id": GAME_CHAT_ID, "message": f"ðŸ§Ÿ Ð—Ð¾Ð¼Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð·Ð°Ñ…Ð²Ð°Ñ‚Ð¸Ð»Ð¸ {loc} {point} Ñƒ {owner}!", "random_id": 0})
        except:
            pass
        if leader and leader in players:
            send_message(leader, f"ðŸ’€ Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ {loc} {point} Ð·Ð°Ñ…Ð²Ð°Ñ‡ÐµÐ½Ð° Ð·Ð¾Ð¼Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¼Ð¸!", None, vk_session)
        for def_id in defender_players:
            if players[def_id].get("health", 0) > 0:
                new_loc, new_point = find_nearest_faction_territory(def_id)
                if new_loc and new_point:
                    players[def_id]["location"] = new_loc
                    players[def_id]["point"] = new_point
                    send_message(def_id, f"ðŸ“ Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ð¿Ð¾Ñ‚ÐµÑ€ÑÐ½Ð°. Ð’Ñ‹ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ñ‹ Ð½Ð° {new_loc} {new_point}", create_main_menu_keyboard(def_id), vk_session)
    elif remaining_after_battle > 0:
        set_territory_control(loc, point, None, 0)
        zombie_bot["squads"] -= squad_count
        logs.append(f"âš”ï¸ ÐÑ‚Ð°ÐºÐ°: {loc} {point} vs {owner}")
        logs.append(f"âš ï¸ Ð¢Ð¾Ñ‡ÐºÐ° Ð¾ÑÐ²Ð¾Ð±Ð¾Ð¶Ð´ÐµÐ½Ð°, Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´Ð»Ñ ÑƒÐ´ÐµÑ€Ð¶Ð°Ð½Ð¸Ñ")
    else:
        territory_control[loc][point]["squads"] = max(0, enemy_squads - squad_count)
        zombie_bot["squads"] -= squad_count
        logs.append(f"âš”ï¸ ÐÑ‚Ð°ÐºÐ°: {loc} {point} vs {owner}")
        logs.append(f"âŒ ÐÑ‚Ð°ÐºÐ° Ð¾Ñ‚Ð±Ð¸Ñ‚Ð°. ÐŸÐ¾Ñ‚ÐµÑ€ÑÐ½Ð¾: {squad_count}")
    save_data()
    return logs
def zombie_territory_attacked(location, point, attacker_faction, vk_session):
    global zombie_bot
    agro_entry = {"loc": location, "point": point, "attacker": attacker_faction, "time": time.time(), "reinforced": False}
    agro_points = zombie_bot.get("agro_points", [])
    exists = False
    for i, ap in enumerate(agro_points):
        if isinstance(ap, dict) and ap.get("loc") == location and ap.get("point") == point:
            agro_points[i] = agro_entry
            exists = True
            break
        elif isinstance(ap, tuple) and ap[0] == location and ap[1] == point:
            agro_points[i] = agro_entry
            exists = True
            break
    if not exists:
        agro_points.append(agro_entry)
    zombie_bot["agro_points"] = agro_points
    zombie_bot["last_attacked_by"] = attacker_faction
    save_data()
    alert_msg = f"ðŸš¨ ÐÐ“Ð Ðž! {attacker_faction} Ð°Ñ‚Ð°ÐºÐ¾Ð²Ð°Ð» {location} {point}!"
    try:
        send_message(353430025, alert_msg, None, vk_session)
    except:
        pass
    zombie_leader = get_faction_leader(ZOMBIE_FACTION)
    if zombie_leader and zombie_leader != 353430025 and zombie_leader in players:
        try:
            send_message(zombie_leader, alert_msg, None, vk_session)
        except:
            pass
def zombie_reinforce():
    global zombie_bot, territory_control
    logs = []
    agro_points = zombie_bot.get("agro_points", [])
    new_agro_points = []
    for ap in agro_points:
        if isinstance(ap, tuple):
            ap = {"loc": ap[0], "point": ap[1], "attacker": None, "time": time.time(), "reinforced": False}
        loc, point = ap["loc"], ap["point"]
        owner = get_territory_owner(loc, point)
        if owner != ZOMBIE_FACTION:
            new_agro_points.append(ap)
            continue
        current_squads = get_territory_squads(loc, point)
        if current_squads >= 10:
            ap["reinforced"] = True
            if ap.get("attacker"):
                zombie_bot["revenge_target"] = ap["attacker"]
                logs.append(f"ðŸ˜¡ ÐœÐµÑÑ‚ÑŒ: Ð¸Ñ‰ÐµÐ¼ Ñ‚ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸ {ap['attacker']}")
            continue
        reinforce_amount = min(random.randint(3, 6), zombie_bot["squads"])
        if reinforce_amount > 0:
            territory_control[loc][point]["squads"] += reinforce_amount
            zombie_bot["squads"] -= reinforce_amount
            logs.append(f"ðŸ›¡ï¸ ÐÐ³Ñ€Ð¾-ÑƒÐºÑ€ÐµÐ¿Ð»ÐµÐ½Ð¸Ðµ: {loc} {point} +{reinforce_amount} (Ñ‚ÐµÐ¿ÐµÑ€ÑŒ {current_squads + reinforce_amount})")
            new_agro_points.append(ap)
    zombie_bot["agro_points"] = new_agro_points
    controlled = get_zombie_controlled_locations()
    weak_points = []
    for loc, point in controlled:
        is_agro = any((isinstance(ap, dict) and ap.get("loc") == loc and ap.get("point") == point) or (isinstance(ap, tuple) and ap[0] == loc and ap[1] == point) for ap in new_agro_points)
        if is_agro:
            continue
        current_squads = get_territory_squads(loc, point)
        ptype = POINT_TYPES.get(point, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ")
        min_needed = MIN_SQUADS_FOR_POINT.get(ptype, 1)
        if current_squads < min_needed + 1:
            weak_points.append((loc, point, current_squads, min_needed))
    random.shuffle(weak_points)
    for loc, point, current, min_needed in weak_points[:2]:
        needed = random.randint(1, 3)
        if zombie_bot["squads"] >= needed:
            territory_control[loc][point]["squads"] += needed
            zombie_bot["squads"] -= needed
            logs.append(f"ðŸ›¡ï¸ Ð£ÐºÑ€ÐµÐ¿Ð»ÐµÐ½Ð¸Ðµ: {loc} {point} +{needed} ÑÐºÐ²Ð°Ð´Ð¾Ð²")
    save_data()
    return logs
def zombie_take_action(vk_session):
    global zombie_bot
    phase = get_zombie_phase()
    strength = get_zombie_strength()
    logs = ["ðŸ§Ÿ === Ð”Ð•Ð™Ð¡Ð¢Ð’Ð˜Ð¯ Ð—ÐžÐœÐ‘Ð˜Ð ÐžÐ’ÐÐÐÐ«Ð¥ ==="]
    logs.append(f"â° {time.strftime('%H:%M:%S')}")
    logs.append(f"ðŸ’ª Ð¡Ð¸Ð»Ð°: {strength} | Ð¤Ð°Ð·Ð°: {phase['name']}")
    logs.append("")
    agro_points = zombie_bot.get("agro_points", [])
    if agro_points:
        logs.append("ðŸ˜¡ ÐÐ“Ð Ðž-Ð¢ÐžÐ§ÐšÐ˜:")
        for ap in agro_points:
            if isinstance(ap, dict):
                loc, point = ap["loc"], ap["point"]
                attacker = ap.get("attacker", "?")
                owner = get_territory_owner(loc, point)
                status = "âœ… Ð¿Ð¾Ð´ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÐµÐ¼" if owner == ZOMBIE_FACTION else f"âŒ Ñƒ {owner}"
                squads = get_territory_squads(loc, point) if owner == ZOMBIE_FACTION else 0
                logs.append(f"   {loc} {point} (Ð¾Ñ‚ {attacker}) - {status}, {squads} ÑÐºÐ²Ð°Ð´Ð¾Ð²")
        logs.append("")
    revenge = zombie_bot.get("revenge_target")
    if revenge:
        logs.append(f"ðŸ”¥ Ð¦Ð•Ð›Ð¬ ÐœÐ•Ð¡Ð¢Ð˜: {revenge}")
        logs.append("")
    controlled = get_zombie_controlled_locations()
    loot_points = []
    for loc, point in controlled:
        if check_territory_exhaustion(loc, point):
            loot_points.append((loc, point))
    random.shuffle(loot_points)
    territories_to_loot = phase["territories"]
    loot_times = phase["loot_times"]
    loot_points = loot_points[:territories_to_loot]
    logs.append(f"ðŸ“¦ Ð›Ð£Ð¢ÐÐÐ˜Ð• ({territories_to_loot} Ñ‚Ð¾Ñ‡ÐµÐº Ð¿Ð¾ {loot_times} Ñ€Ð°Ð·):")
    if loot_points:
        for loc, point in loot_points:
            loot_logs = zombie_loot_territory_custom(loc, point, loot_times, vk_session)
            logs.extend(loot_logs)
    else:
        logs.append("   ÐÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… Ñ‚Ð¾Ñ‡ÐµÐº")
        if zombie_bot.get("mode") == "loot":
            zombie_bot["mode"] = "normal"
            logs.append("   âš ï¸ Ð ÐµÐ¶Ð¸Ð¼ ÑÐ¼ÐµÐ½Ñ‘Ð½ Ð½Ð° Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ð¹")
    logs.append("")
    logs.append("ðŸ’° ÐŸÐ ÐžÐ”ÐÐ–Ð:")
    sell_logs = zombie_sell_items()
    if sell_logs:
        logs.extend(sell_logs)
    else:
        logs.append("   ÐÐµÑ‡ÐµÐ³Ð¾ Ð¿Ñ€Ð¾Ð´Ð°Ð²Ð°Ñ‚ÑŒ")
    logs.append("")
    logs.append("â™»ï¸ ÐšÐžÐÐ’Ð•Ð Ð¢ÐÐ¦Ð˜Ð¯:")
    conv_logs = zombie_convert_items()
    if conv_logs:
        logs.extend(conv_logs)
    else:
        logs.append("   ÐÐµÑ‡ÐµÐ³Ð¾ ÐºÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ")
    logs.append("")
    logs.append("ðŸ’² ÐŸÐžÐšÐ£ÐŸÐšÐ Ð¡ÐšÐ’ÐÐ”ÐžÐ’:")
    buy_logs = zombie_buy_squads()
    if buy_logs:
        logs.extend(buy_logs)
    else:
        logs.append("   ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²")
    logs.append("")
    logs.append("ðŸ›¡ï¸ Ð£ÐšÐ Ð•ÐŸÐ›Ð•ÐÐ˜Ð•:")
    reinforce_logs = zombie_reinforce()
    if reinforce_logs:
        logs.extend(reinforce_logs)
    else:
        logs.append("   ÐÐµ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ")
    priority = zombie_bot.get("priority_target")
    if priority:
        loc, point = priority
        if get_territory_owner(loc, point) == ZOMBIE_FACTION:
            current_squads = get_territory_squads(loc, point)
            reinforce = min(random.randint(2, 5), zombie_bot["squads"])
            if reinforce > 0 and current_squads < 15:
                territory_control[loc][point]["squads"] += reinforce
                zombie_bot["squads"] -= reinforce
                logs.append(f"ðŸŽ¯ ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ ÑƒÐºÑ€ÐµÐ¿Ð»Ñ‘Ð½: {loc} {point} +{reinforce} (Ñ‚ÐµÐ¿ÐµÑ€ÑŒ {current_squads + reinforce})")
    logs.append("")
    mode = zombie_bot.get("mode", "normal")
    if mode == "aggressive" or mode == "normal":
        logs.append("âš”ï¸ ÐÐ¢ÐÐšÐ:")
        pending = zombie_bot.get("pending_target")
        if pending:
            p_loc, p_point, p_squads = pending
            if get_territory_owner(p_loc, p_point) == ZOMBIE_FACTION:
                zombie_bot["pending_target"] = None
                logs.append(f"   âœ… Ð¦ÐµÐ»ÑŒ {p_loc} {p_point} ÑƒÐ¶Ðµ Ð·Ð°Ñ…Ð²Ð°Ñ‡ÐµÐ½Ð°")
            else:
                logs.append(f"   â³ ÐšÐ¾Ð¿Ð¸Ð¼ ÑÐºÐ²Ð°Ð´Ñ‹ Ð´Ð»Ñ: {p_loc} {p_point} (Ð½ÑƒÐ¶Ð½Ð¾ {p_squads}, ÐµÑÑ‚ÑŒ {zombie_bot['squads']})")
        if zombie_bot["squads"] >= 1:
            target_loc, target_point, squads_to_send = zombie_choose_target()
            if target_loc:
                target_owner = get_territory_owner(target_loc, target_point)
                if target_owner == ZOMBIE_FACTION:
                    logs.append(f"   â„¹ï¸ {target_loc} {target_point} ÑƒÐ¶Ðµ Ð¿Ð¾Ð´ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÐµÐ¼")
                else:
                    attack_logs = zombie_attack(target_loc, target_point, squads_to_send, vk_session)
                    logs.extend(attack_logs)
            else:
                if not pending or get_territory_owner(pending[0], pending[1]) == ZOMBIE_FACTION:
                    logs.append("   ÐÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… Ñ†ÐµÐ»ÐµÐ¹ Ð¸Ð»Ð¸ ÐºÐ¾Ð¿Ð¸Ð¼ ÑÐ¸Ð»Ñ‹")
        else:
            logs.append("   ÐÐµÑ‚ ÑÐºÐ²Ð°Ð´Ð¾Ð²")
    elif mode == "loot":
        logs.append("âš”ï¸ ÐÐ¢ÐÐšÐ: Ð ÐµÐ¶Ð¸Ð¼ Ð½Ð°ÐºÐ¾Ð¿Ð»ÐµÐ½Ð¸Ñ, Ð°Ñ‚Ð°ÐºÐ¸ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ñ‹")
    logs.append("")
    logs.append(f"ðŸ“Š Ð˜Ð¢ÐžÐ“Ðž:")
    logs.append(f"   ðŸ’² {zombie_bot['money']}Ñ€")
    logs.append(f"   ðŸ‘¨â€ðŸ‘¨â€ðŸ‘¦â€ðŸ‘¦ {zombie_bot['squads']} ÑÐºÐ²Ð°Ð´Ð¾Ð²")
    logs.append(f"   ðŸ– {zombie_bot['food_units']} ðŸ¥ {zombie_bot['med_units']} â˜¢ï¸ {zombie_bot['rad_units']}")
    logs.append(f"   ðŸŽ¯ Ð ÐµÐ¶Ð¸Ð¼: {mode}")
    if priority:
        owner = get_territory_owner(priority[0], priority[1])
        status = "âœ… Ð¿Ð¾Ð´ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÐµÐ¼" if owner == ZOMBIE_FACTION else f"âš”ï¸ Ñƒ {owner if owner else 'Ð½ÐµÐ¹Ñ‚Ñ€Ð°Ð»'}"
        logs.append(f"   ðŸŽ¯ ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚: {priority[0]} {priority[1]} ({status})")
    next_target = zombie_choose_target()
    if next_target[0]:
        zombie_bot["next_action"] = f"Ð°Ñ‚Ð°ÐºÐ° {next_target[0]} {next_target[1]} ({next_target[2]} ÑÐºÐ²Ð°Ð´Ð¾Ð²)"
    elif zombie_bot.get("pending_target"):
        p = zombie_bot["pending_target"]
        if get_territory_owner(p[0], p[1]) != ZOMBIE_FACTION:
            zombie_bot["next_action"] = f"Ð½Ð°ÐºÐ¾Ð¿Ð»ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ {p[0]} {p[1]} ({p[2]} ÑÐºÐ²Ð°Ð´Ð¾Ð²)"
        else:
            zombie_bot["pending_target"] = None
            zombie_bot["next_action"] = "Ð¿Ð¾Ð¸ÑÐº Ð½Ð¾Ð²Ð¾Ð¹ Ñ†ÐµÐ»Ð¸"
    else:
        zombie_bot["next_action"] = "Ð»ÑƒÑ‚Ð°Ð½Ð¸Ðµ Ð¸ Ð½Ð°ÐºÐ¾Ð¿Ð»ÐµÐ½Ð¸Ðµ"
    zombie_bot["last_action_time"] = time.time()
    zombie_bot["last_logs"] = logs.copy()
    save_data()
    try:
        send_message(353430025, "\n".join(logs), None, vk_session)
    except:
        pass
    zombie_leader = get_faction_leader(ZOMBIE_FACTION)
    if zombie_leader and zombie_leader != 353430025 and zombie_leader in players:
        try:
            send_message(zombie_leader, "\n".join(logs), None, vk_session)
        except:
            pass
    return logs
def zombie_loot_territory_custom(loc, point, times, vk_session):
    global zombie_bot
    ptype = POINT_TYPES.get(point, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ")
    logs = []
    total_money = 0
    total_items = {}
    for _ in range(times):
        if not check_territory_exhaustion(loc, point):
            break
        add_territory_exhaustion(loc, point)
        if ptype == "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ":
            drops = roll_drops(DROP_T, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ")
        elif ptype == "Ð¢Ð¾Ñ‡ÐºÐ° Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²":
            drops = roll_drops(DROP_TR, "Ð¢Ð¾Ñ‡ÐºÐ° Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²")
        elif ptype == "Ð‘Ð°Ð·Ð°":
            drops = roll_drops(DROP_B, "Ð‘Ð°Ð·Ð°")
        elif ptype == "ÐÐ½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð¾Ð½Ð°":
            money_gain = random.randint(10, 30)
            total_money += money_gain
            continue
        elif ptype == "Ð›Ð¾Ð³Ð¾Ð²Ð¾":
            money_gain = random.randint(15, 40)
            total_money += money_gain
            continue
        else:
            drops = roll_drops(DROP_T, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ")
        for item, amount in drops.items():
            if item == "Ð”ÐµÐ½ÑŒÐ³Ð¸":
                total_money += amount
            else:
                total_items[item] = total_items.get(item, 0) + amount
    zombie_bot["money"] += total_money
    for item, amount in total_items.items():
        zombie_bot["backpack"][item] = zombie_bot["backpack"].get(item, 0) + amount
    logs.append(f"ðŸ“ {loc} {point}: ðŸ’²{total_money}Ñ€")
    if total_items:
        items_str = ", ".join([f"{k} x{v}" for k, v in list(total_items.items())[:5]])
        logs.append(f"   ðŸ“¦ {items_str}")
    save_data()
    return logs
def get_zombie_status():
    controlled = get_zombie_controlled_locations()
    strength = get_zombie_strength()
    phase = get_zombie_phase()
    cooldown = get_zombie_cooldown()
    next_action_time = zombie_bot.get("last_action_time", 0) + cooldown
    remaining = max(0, next_action_time - time.time())
    mins = int(remaining // 60)
    secs = int(remaining % 60)
    lines = ["ðŸ§Ÿ === Ð¡Ð¢ÐÐ¢Ð£Ð¡ Ð—ÐžÐœÐ‘Ð˜Ð ÐžÐ’ÐÐÐÐ«Ð¥ ===", ""]
    lines.append(f"ðŸ’ª Ð¡Ð¸Ð»Ð°: {strength} | Ð¤Ð°Ð·Ð°: {phase['name']}")
    lines.append(f"â±ï¸ ÐšÐ” Ñ„Ð°Ð·Ñ‹: {cooldown // 60} Ð¼Ð¸Ð½")
    lines.append(f"ðŸ’² Ð”ÐµÐ½ÑŒÐ³Ð¸: {zombie_bot['money']}Ñ€")
    lines.append(f"ðŸ‘¨â€ðŸ‘¨â€ðŸ‘¦â€ðŸ‘¦ Ð¡ÐºÐ²Ð°Ð´Ñ‹: {zombie_bot['squads']} (Ð±Ð¾Ð½ÑƒÑ: {zombie_bot.get('bonus_squads', 0)})")
    lines.append(f"ðŸ– Ð•Ð´Ð°: {zombie_bot['food_units']}")
    lines.append(f"ðŸ¥ ÐœÐµÐ´: {zombie_bot['med_units']}")
    lines.append(f"â˜¢ï¸ Ð Ð°Ð´: {zombie_bot['rad_units']}")
    lines.append(f"ðŸŽ¯ Ð ÐµÐ¶Ð¸Ð¼: {zombie_bot.get('mode', 'normal')}")
    lines.append("")
    agro_points = zombie_bot.get("agro_points", [])
    if agro_points:
        lines.append("ðŸ˜¡ ÐÐ“Ð Ðž-Ð¢ÐžÐ§ÐšÐ˜:")
        for ap in agro_points:
            if isinstance(ap, dict):
                loc, point = ap["loc"], ap["point"]
                attacker = ap.get("attacker", "?")
                owner = get_territory_owner(loc, point)
                status = "âœ…" if owner == ZOMBIE_FACTION else "âŒ"
                lines.append(f"   {status} {loc} {point} (Ð¾Ñ‚ {attacker})")
        lines.append("")
    revenge = zombie_bot.get("revenge_target")
    if revenge:
        lines.append(f"ðŸ”¥ Ð¦Ð•Ð›Ð¬ ÐœÐ•Ð¡Ð¢Ð˜: {revenge}")
        lines.append("")
    priority = zombie_bot.get("priority_target")
    if priority:
        owner = get_territory_owner(priority[0], priority[1])
        status = "âœ… Ð¿Ð¾Ð´ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÐµÐ¼" if owner == ZOMBIE_FACTION else f"âš”ï¸ Ñƒ {owner}"
        lines.append(f"ðŸŽ¯ ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚: {priority[0]} {priority[1]} ({status})")
    pending = zombie_bot.get("pending_target")
    if pending:
        lines.append(f"â³ ÐÐ°ÐºÐ¾Ð¿Ð»ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ: {pending[0]} {pending[1]} (Ð½ÑƒÐ¶Ð½Ð¾ {pending[2]})")
    lines.append("")
    lines.append("ðŸ—ºï¸ ÐšÐžÐÐ¢Ð ÐžÐ›Ð˜Ð Ð£Ð•ÐœÐ«Ð• Ð¢ÐžÐ§ÐšÐ˜:")
    for loc, point in controlled:
        squads = get_territory_squads(loc, point)
        ptype = POINT_TYPES.get(point, "?")
        lines.append(f"   {loc} {point} ({ptype}): {squads} ÑÐºÐ²Ð°Ð´Ð¾Ð²")
    lines.append("")
    lines.append(f"â±ï¸ Ð”Ð¾ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ: {mins} Ð¼Ð¸Ð½ {secs} ÑÐµÐº")
    lines.append(f"ðŸ“‹ ÐŸÐ»Ð°Ð½Ð¸Ñ€ÑƒÐµÐ¼Ð¾Ðµ: {zombie_bot.get('next_action', '?')}")
    lines.append("")
    lines.append("ðŸ“œ ÐŸÐžÐ¡Ð›Ð•Ð”ÐÐ˜Ð• Ð”Ð•Ð™Ð¡Ð¢Ð’Ð˜Ð¯:")
    last_logs = zombie_bot.get("last_logs", [])
    if last_logs:
        for log in last_logs[-20:]:
            lines.append(log)
    else:
        lines.append("   ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…")
    return "\n".join(lines)
def get_zombie_strength():
    controlled = get_zombie_controlled_locations()
    total_strength = 0
    for loc, point in controlled:
        ptype = POINT_TYPES.get(point, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ")
        total_strength += POINT_STRENGTH.get(ptype, 1)
    return total_strength
def get_zombie_phase():
    strength = get_zombie_strength()
    current_phase = None
    for min_strength, phase_data in sorted(ZOMBIE_PHASES.items()):
        if strength >= min_strength:
            current_phase = phase_data
    if current_phase is None:
        current_phase = ZOMBIE_PHASES[15]
    return current_phase
def get_zombie_cooldown():
    phase = get_zombie_phase()
    return phase.get("cooldown", 1800)
def find_nearest_faction_territory(user_id):
    p = players[user_id]
    faction = p.get("faction")
    current_loc = p.get("location")
    priority_types = ["Ð‘Ð°Ð·Ð°", "Ð¢Ð¾Ñ‡ÐºÐ° Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²", "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ", "ÐÐ½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð¾Ð½Ð°", "Ð›Ð¾Ð³Ð¾Ð²Ð¾"]
    for ptype in priority_types:
        for point in LOCATIONS.get(current_loc, []):
            if POINT_TYPES.get(point) == ptype:
                if get_territory_owner(current_loc, point) == faction:
                    return current_loc, point
    for loc in LOCATIONS:
        for ptype in priority_types:
            for point in LOCATIONS.get(loc, []):
                if POINT_TYPES.get(point) == ptype:
                    if get_territory_owner(loc, point) == faction:
                        return loc, point
    return None, None
def get_emission_status():
    next_time = get_next_emission_time()
    if not next_time:
        return "ðŸŸ¢"
    remaining = next_time - time.time()
    if remaining > 7200:
        return "ðŸŸ¢"
    elif remaining > 3600:
        return "ðŸŸ¡"
    elif remaining > 1800:
        return "ðŸŸ "
    elif remaining > 600:
        return "ðŸ”´"
    elif remaining > 300:
        return "âš«"
    else:
        return "â˜ ï¸"
def trigger_emission(vk_session):
    global last_restored_categories, territory_exhaustion
    categories = ["Ð‘Ð°Ð·Ð°", "Ð¢Ð¾Ñ‡ÐºÐ° Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²", "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ", "Ð›Ð¾Ð³Ð¾Ð²Ð¾", "ÐÐ½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð¾Ð½Ð°"]
    num_categories = random.choice([1, 2])
    restored = random.sample(categories, num_categories)
    last_restored_categories = restored
    for loc in LOCATIONS:
        for point in LOCATIONS[loc]:
            ptype = POINT_TYPES.get(point, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ")
            if ptype in restored:
                territory_exhaustion[loc][point] = 0
    safe_states = [STATE_IN_CAMP, STATE_IN_BACKPACK, STATE_RESTING, STATE_USING_ITEM, STATE_BELT_MAIN, STATE_BELT_SELECT_SLOT, STATE_BELT_SELECT_ARTIFACT, STATE_BELT_EQUIP, STATE_BELT_UNEQUIP]
    dead_players = []
    for uid, p in players.items():
        if uid in banned_users:
            continue
        faction = p.get("faction")
        if not faction or faction == "None" or faction is None:
            continue
        state = p.get("state")
        if state in [STATE_WAITING_FOR_START, STATE_READING_INSTRUCTIONS, STATE_CHOOSING_FACTION, STATE_ENTERING_NICKNAME]:
            continue
        if state not in safe_states:
            if state == STATE_TRANSITION_WAIT:
                p["transition_end_time"] = None
                if p.get("previous_location") and p.get("previous_point"):
                    p["location"] = p["previous_location"]
                    p["point"] = p["previous_point"]
                p["previous_location"] = None
                p["previous_point"] = None
                p["state"] = STATE_IN_MENU
            elif state in [STATE_HUNTING, STATE_HUNTING_SHOOTING, STATE_ANOMALY_EXPLORE]:
                p["state"] = STATE_IN_MENU
                p["artifact_positions"] = []
                p["anomaly_positions"] = []
                p["hidden_anomaly_positions"] = []
                p["current_mutant"] = None
                p["mutant_hp"] = None
                p["anomaly_path_choosing"] = False
            p["health"] = 0
            p["hunger"] = 10
            p["radiation"] = 10
            p["death_notified"] = True
            nickname = p.get("nickname", "ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹")
            location = p.get("location", "?")
            point = p.get("point", "?")
            if faction != ZOMBIE_FACTION:
                dead_players.append(f"â€¢ {nickname} ({faction}) â€” {location} {point}")
            send_message(uid, "â˜ ï¸ Ð’Ñ‹ Ð¿Ð¾Ð³Ð¸Ð±Ð»Ð¸ Ð¾Ñ‚ Ð²Ñ‹Ð±Ñ€Ð¾ÑÐ°! ÐÑƒÐ¶Ð½Ð¾ Ð±Ñ‹Ð»Ð¾ ÑƒÐºÑ€Ñ‹Ñ‚ÑŒÑÑ Ð² Ð»Ð°Ð³ÐµÑ€Ðµ!", None, vk_session)
    restored_text = ", ".join(restored)
    for uid, p in players.items():
        if uid in banned_users:
            continue
        faction = p.get("faction")
        if not faction or faction == "None" or faction is None:
            continue
        state = p.get("state")
        if state in [STATE_WAITING_FOR_START, STATE_READING_INSTRUCTIONS, STATE_CHOOSING_FACTION, STATE_ENTERING_NICKNAME]:
            continue
        send_message(uid, f"â˜¢ï¸ Ð’Ñ‹Ð±Ñ€Ð¾Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½!\nâ™»ï¸ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹: {restored_text}", None, vk_session)
    if dead_players and GAME_CHAT_ID:
        dead_list = "\n".join(dead_players)
        chat_msg = f"â˜¢ï¸ Ð’Ð«Ð‘Ð ÐžÐ¡ Ð—ÐÐ’Ð•Ð Ð¨ÐÐ!\n\nâ˜ ï¸ ÐŸÐ¾Ð³Ð¸Ð±ÑˆÐ¸Ðµ ÑÑ‚Ð°Ð»ÐºÐµÑ€Ñ‹:\n{dead_list}\n\nâ™»ï¸ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹: {restored_text}"
        try:
            vk_session.method("messages.send", {"peer_id": GAME_CHAT_ID, "message": chat_msg, "random_id": 0})
        except Exception as e:
            logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð² Ð±ÐµÑÐµÐ´Ñƒ: {e}")
    elif GAME_CHAT_ID:
        chat_msg = f"â˜¢ï¸ Ð’Ð«Ð‘Ð ÐžÐ¡ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½!\n\nâœ… Ð’ÑÐµ ÑÑ‚Ð°Ð»ÐºÐµÑ€Ñ‹ ÑƒÐºÑ€Ñ‹Ð»Ð¸ÑÑŒ!\n\nâ™»ï¸ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹: {restored_text}"
        try:
            vk_session.method("messages.send", {"peer_id": GAME_CHAT_ID, "message": chat_msg, "random_id": 0})
        except Exception as e:
            logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð² Ð±ÐµÑÐµÐ´Ñƒ: {e}")
    save_data()
def check_territory_exhaustion(location, point):
    ptype = POINT_TYPES.get(point, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ")
    limit = EXHAUSTION_LIMITS.get(ptype, 100)
    current = territory_exhaustion.get(location, {}).get(point, 0)
    return current < limit
def add_territory_exhaustion(location, point):
    global territory_exhaustion
    if location not in territory_exhaustion:
        territory_exhaustion[location] = {}
    territory_exhaustion[location][point] = territory_exhaustion[location].get(point, 0) + 1
    save_data()
def init_territory_control():
    global territory_control
    territory_control = {}
    for loc in LOCATIONS:
        territory_control[loc] = {}
        for point in LOCATIONS[loc]:
            territory_control[loc][point] = {"faction": None, "squads": 0}
    territory_control["ÐšÐ¾Ñ€Ð´Ð¾Ð½"]["Ð‘1"] = {"faction": "ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³", "squads": 5}
    territory_control["Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°"]["Ð‘1"] = {"faction": "â˜¦ï¸ Ð“Ñ€ÐµÑ…", "squads": 5}
    territory_control["Ð¡Ð²Ð°Ð»ÐºÐ°"]["Ð‘1"] = {"faction": "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸", "squads": 5}
    save_data()
def get_territory_owner(location, point):
    if location in territory_control and point in territory_control[location]:
        return territory_control[location][point].get("faction")
    return None
def get_territory_squads(location, point):
    if location in territory_control and point in territory_control[location]:
        return territory_control[location][point].get("squads", 0)
    return 0
def set_territory_control(location, point, faction, squads):
    global territory_control
    if location not in territory_control:
        territory_control[location] = {}
    territory_control[location][point] = {"faction": faction, "squads": squads}
    save_data()
def is_player_on_own_territory(user_id):
    p = players[user_id]
    location, point = get_player_position(user_id)
    faction = p.get("faction")
    owner = get_territory_owner(location, point)
    return owner == faction
def get_faction_leader(faction):
    return faction_leaders.get(faction)
def set_faction_leader(faction, user_id):
    global faction_leaders
    faction_leaders[faction] = user_id
    save_data()
def get_players_on_territory(location, point):
    result = []
    for uid, p in players.items():
        loc, pt = get_player_position(uid)
        if loc == location and pt == point:
            result.append(uid)
    return result
def get_player_bullet_resist(user_id):
    p = players[user_id]
    return p.get("bullet_resist", 0) + get_belt_bonus(user_id, "bullet_resist")
def get_armor_category(user_id):
    p = players[user_id]
    armor = p.get("armor")
    if not armor:
        return 0
    faction = p.get("faction")
    for i, item in enumerate(EQUIPMENT[faction]["armor"]):
        if item[0] == armor:
            return i + 1
    return 0
def generate_war_map_image(location):
    map_path = LOCATION_MAPS.get(location)
    if not map_path or not os.path.exists(map_path):
        return None
    try:
        img = Image.open(map_path).convert("RGBA")
        draw = ImageDraw.Draw(img)
        icon_size = 45 if location == "ÐŸÐ¾Ð»ÑÐ½Ð°" else 30
        faction_icons = {}
        for faction, icon_path in FACTION_ICONS.items():
            try:
                faction_icons[faction] = Image.open(icon_path).convert("RGBA").resize((icon_size, icon_size))
            except:
                faction_icons[faction] = None
        if location in POINT_COORDINATES:
            for point, (x, y) in POINT_COORDINATES[location].items():
                owner = get_territory_owner(location, point)
                if owner and owner in faction_icons and faction_icons[owner]:
                    icon = faction_icons[owner]
                    img.paste(icon, (x - icon_size // 2, y - icon_size // 2), icon)
        buffer = io.BytesIO()
        img.save(buffer, format="PNG")
        buffer.seek(0)
        return buffer
    except Exception as e:
        logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÐºÐ°Ñ€Ñ‚Ñ‹ Ð²Ð¾Ð¹Ð½Ñ‹: {e}")
        return None
def send_war_map(user_id, location, message, keyboard, vk_session):
    try:
        img_buffer = generate_war_map_image(location)
        if img_buffer:
            upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
            response = vk_session.http.post(upload_url, files={"photo": ("map.png", img_buffer, "image/png")})
            result = response.json()
            photo_data = vk_session.method("photos.saveMessagesPhoto", {
                "photo": result["photo"],
                "server": result["server"],
                "hash": result["hash"]
            })[0]
            vk_session.method("messages.send", {
                "user_id": user_id,
                "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}",
                "random_id": 0,
                "message": message,
                "keyboard": keyboard.get_keyboard()
            })
            return True
    except Exception as e:
        logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÐºÐ°Ñ€Ñ‚Ñ‹ Ð²Ð¾Ð¹Ð½Ñ‹: {e}")
    send_message(user_id, message, keyboard, vk_session)
    return False
def process_attack(attacker_id, location, point, squad_count, with_player, vk_session):
    attacker = players[attacker_id]
    attacker_faction = attacker["faction"]
    defender_faction = get_territory_owner(location, point)
    if defender_faction == ZOMBIE_FACTION and LAST_STAND_MODE:
        zombie_territory_attacked(location, point, attacker_faction, vk_session)
    defender_squads = get_territory_squads(location, point)
    ptype = POINT_TYPES.get(point, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ")
    min_squads = MIN_SQUADS_FOR_POINT.get(ptype, 1)
    if defender_faction is not None and defender_faction != attacker_faction:
        if squad_count < min_squads:
            return f"âŒ Ð”Ð»Ñ Ð°Ñ‚Ð°ÐºÐ¸ Ð½Ð° {ptype} Ð½ÑƒÐ¶Ð½Ð¾ Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ {min_squads} ÑÐºÐ²Ð°Ð´Ð¾Ð²."
    def notify_faction_leader(faction, message):
        leader = get_faction_leader(faction)
        if leader and leader in players and leader != attacker_id:
            send_message(leader, message, None, vk_session)
    def damage_equipment(player_id, messages_list):
        p = players[player_id]
        if random.randint(1, 100) <= 50:
            equip_to_damage = []
            if p.get("weapon") and p.get("weapon_durability", 0) > 0:
                equip_to_damage.append("weapon")
            if p.get("armor") and p.get("armor_durability", 0) > 0:
                equip_to_damage.append("armor")
            if equip_to_damage:
                target = random.choice(equip_to_damage)
                if target == "weapon":
                    p["weapon_durability"] = max(0, p["weapon_durability"] - 1)
                    if player_id == attacker_id:
                        messages_list.append("ðŸ”§ Ð’Ð°ÑˆÐµ Ð¾Ñ€ÑƒÐ¶Ð¸Ðµ Ð¿Ð¾Ð²Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¾ (-1)!")
                    else:
                        send_message(player_id, "ðŸ”§ Ð’Ð°ÑˆÐµ Ð¾Ñ€ÑƒÐ¶Ð¸Ðµ Ð¿Ð¾Ð²Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¾ Ð² Ð±Ð¾ÑŽ (-1)!", None, vk_session)
                else:
                    p["armor_durability"] = max(0, p["armor_durability"] - 1)
                    if player_id == attacker_id:
                        messages_list.append("ðŸ”§ Ð’Ð°ÑˆÐ° Ð±Ñ€Ð¾Ð½Ñ Ð¿Ð¾Ð²Ñ€ÐµÐ¶Ð´ÐµÐ½Ð° (-1)!")
                    else:
                        send_message(player_id, "ðŸ”§ Ð’Ð°ÑˆÐ° Ð±Ñ€Ð¾Ð½Ñ Ð¿Ð¾Ð²Ñ€ÐµÐ¶Ð´ÐµÐ½Ð° Ð² Ð±Ð¾ÑŽ (-1)!", None, vk_session)
    if defender_faction is None:
        if squad_count >= min_squads:
            set_territory_control(location, point, attacker_faction, squad_count)
            attacker["squads"] -= squad_count
            save_data()
            return f"âœ… Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ {location} {point} Ð·Ð°Ñ…Ð²Ð°Ñ‡ÐµÐ½Ð°! Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¾ {squad_count} ÑÐºÐ²Ð°Ð´Ð¾Ð²."
        else:
            return f"âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÑÐºÐ²Ð°Ð´Ð¾Ð² Ð´Ð»Ñ Ð·Ð°Ñ…Ð²Ð°Ñ‚Ð°. ÐÑƒÐ¶Ð½Ð¾ Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ {min_squads}."
    if defender_faction == attacker_faction:
        territory_control[location][point]["squads"] += squad_count
        attacker["squads"] -= squad_count
        save_data()
        return f"âœ… ÐŸÐ¾Ð´ÐºÑ€ÐµÐ¿Ð»ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾. ÐÐ° Ñ‚Ð¾Ñ‡ÐºÐµ Ñ‚ÐµÐ¿ÐµÑ€ÑŒ {territory_control[location][point]['squads']} ÑÐºÐ²Ð°Ð´Ð¾Ð²."
    if with_player:
        if not attacker.get("weapon") or attacker.get("health", 0) <= 0:
            return "âŒ Ð”Ð»Ñ Ð»Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ ÑƒÑ‡Ð°ÑÑ‚Ð¸Ñ Ð½ÑƒÐ¶Ð½Ð¾ Ð¾Ñ€ÑƒÐ¶Ð¸Ðµ Ð¸ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ."
    notify_faction_leader(defender_faction, f"âš ï¸ Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ {location} {point} Ð°Ñ‚Ð°ÐºÐ¾Ð²Ð°Ð½Ð° Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¾Ð¹ {attacker_faction}!")
    all_on_territory = get_players_on_territory(location, point)
    defenders = [uid for uid in all_on_territory if players[uid].get("faction") == defender_faction and players[uid].get("health", 0) > 0]
    total_bullet_resist = sum(get_player_bullet_resist(uid) for uid in defenders)
    player_damage = 0
    bonus_msg_parts = []
    if with_player:
        player_damage = attacker.get("weapon_damage", 0) + get_belt_bonus(attacker_id, "weapon_damage")
        weapon_name = attacker.get("weapon", "")
        special = SPECIAL_WEAPONS.get(weapon_name, {})
        if ptype in ["ÐÐ½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð¾Ð½Ð°", "Ð›Ð¾Ð³Ð¾Ð²Ð¾"]:
            war_chance = special.get("war_bonus_chance", 0)
            war_bonus = special.get("war_bonus_damage", 0)
            if war_chance > 0 and random.randint(1, 100) <= war_chance:
                player_damage += war_bonus
                bonus_msg_parts.append(f"âš¡ {weapon_name}: +{war_bonus} ÑƒÑ€Ð¾Ð½Ð°!")
    defender_damage_to_attacker = squad_count / 2
    if with_player:
        defender_damage_to_attacker += player_damage
    def calculate_return_damage_to_player():
        squad_damage = round(defender_squads / 3)
        armor_cat = get_armor_category(attacker_id)
        armor_damage = [1, 1.5, 2, 2.5, 3, 3.5][min(armor_cat, 5)]
        return squad_damage + armor_damage
    effective_defender_squads = max(0, defender_squads - total_bullet_resist)
    remaining_defender_after_player = max(0, effective_defender_squads - player_damage) if with_player else effective_defender_squads
    if squad_count <= remaining_defender_after_player:
        squads_destroyed = squad_count
        remaining_attacker_squads = 0
        remaining_defender_squads = remaining_defender_after_player - squad_count
        territory_control[location][point]["squads"] = remaining_defender_squads
        global faction_shared_squads
        if remaining_defender_squads == 0:
            set_territory_control(location, point, None, 0)
            notify_faction_leader(defender_faction, f"âš ï¸ Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ {location} {point} Ð¿Ð¾Ñ‚ÐµÑ€ÑÐ½Ð° â€” Ð½Ðµ Ð¾ÑÑ‚Ð°Ð»Ð¾ÑÑŒ ÑÐºÐ²Ð°Ð´Ð¾Ð²!")
        elif remaining_defender_squads < min_squads:
            faction_shared_squads[defender_faction] = faction_shared_squads.get(defender_faction, 0) + remaining_defender_squads
            set_territory_control(location, point, None, 0)
            notify_faction_leader(defender_faction, f"âš ï¸ Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ {location} {point} Ð¿Ð¾Ñ‚ÐµÑ€ÑÐ½Ð°!\nðŸ”™ {remaining_defender_squads} ÑÐºÐ²Ð°Ð´Ð¾Ð² Ð²ÐµÑ€Ð½ÑƒÐ»Ð¾ÑÑŒ Ð² Ð¾Ð±Ñ‰ÐµÐµ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ.")
        if defenders:
            damage_per_player = defender_damage_to_attacker / len(defenders)
            for def_id in defenders:
                players[def_id]["health"] = max(0, players[def_id]["health"] - damage_per_player)
                damage_equipment(def_id, bonus_msg_parts)
                send_message(def_id, f"âš”ï¸ ÐÑ‚Ð°ÐºÐ° Ð½Ð° {location} {point} Ð¾Ñ‚Ð±Ð¸Ñ‚Ð°.", None, vk_session)
                if players[def_id]["health"] <= 0:
                    handle_war_death(def_id, attacker_id, vk_session)
        if with_player:
            return_damage = calculate_return_damage_to_player()
            attacker["health"] = max(0, attacker["health"] - return_damage)
            bonus_msg_parts.append(f"ðŸ’” Ð’Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¸ {return_damage} ÑƒÑ€Ð¾Ð½Ð°.")
            damage_equipment(attacker_id, bonus_msg_parts)
            if attacker["health"] <= 0:
                handle_war_death(attacker_id, defenders[0] if defenders else None, vk_session)
        attacker["squads"] -= squad_count
        save_data()
        bonus_msg = "\n" + "\n".join(bonus_msg_parts) if bonus_msg_parts else ""
        return f"âŒ ÐÑ‚Ð°ÐºÐ° Ð¾Ñ‚Ð±Ð¸Ñ‚Ð°. ÐŸÐ¾Ñ‚ÐµÑ€ÑÐ½Ð¾ {squads_destroyed} ÑÐºÐ²Ð°Ð´Ð¾Ð².{bonus_msg}"
    remaining_attacker_squads = squad_count - remaining_defender_after_player
    if defenders:
        damage_per_player = defender_damage_to_attacker / len(defenders)
        for def_id in defenders:
            players[def_id]["health"] = max(0, players[def_id]["health"] - damage_per_player)
            damage_equipment(def_id, bonus_msg_parts)
            send_message(def_id, f"âš”ï¸ Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ {location} {point} Ð¿Ð¾Ñ‚ÐµÑ€ÑÐ½Ð°.", None, vk_session)
            if players[def_id]["health"] <= 0:
                handle_war_death(def_id, attacker_id, vk_session)
    if with_player:
        return_damage = calculate_return_damage_to_player()
        attacker["health"] = max(0, attacker["health"] - return_damage)
        bonus_msg_parts.append(f"ðŸ’” Ð’Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¸ {return_damage} ÑƒÑ€Ð¾Ð½Ð°.")
        damage_equipment(attacker_id, bonus_msg_parts)
        if attacker["health"] <= 0:
            handle_war_death(attacker_id, defenders[0] if defenders else None, vk_session)
            attacker["squads"] -= squad_count
            save_data()
            bonus_msg = "\n" + "\n".join(bonus_msg_parts) if bonus_msg_parts else ""
            return f"ðŸ’€ Ð’Ñ‹ Ð¿Ð¾Ð³Ð¸Ð±Ð»Ð¸ Ð² Ð±Ð¾ÑŽ.{bonus_msg}"
    squads_lost = squad_count - remaining_attacker_squads
    bonus_msg_parts.append(f"ðŸ’€ ÐŸÐ¾Ñ‚ÐµÑ€ÑÐ½Ð¾ ÑÐºÐ²Ð°Ð´Ð¾Ð²: {squads_lost}")
    if remaining_attacker_squads >= min_squads:
        set_territory_control(location, point, attacker_faction, remaining_attacker_squads)
        attacker["squads"] -= squad_count
        notify_faction_leader(defender_faction, f"ðŸ’€ Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ {location} {point} Ð·Ð°Ñ…Ð²Ð°Ñ‡ÐµÐ½Ð° {attacker_faction}!")
        save_data()
        bonus_msg = "\n" + "\n".join(bonus_msg_parts) if bonus_msg_parts else ""
        return f"âœ… Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ {location} {point} Ð·Ð°Ñ…Ð²Ð°Ñ‡ÐµÐ½Ð°! Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¾ {remaining_attacker_squads} ÑÐºÐ²Ð°Ð´Ð¾Ð².{bonus_msg}"
    else:
        set_territory_control(location, point, None, 0)
        attacker["squads"] -= squad_count
        attacker["squads"] += remaining_attacker_squads
        notify_faction_leader(defender_faction, f"âš ï¸ Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ {location} {point} Ð¿Ð¾Ñ‚ÐµÑ€ÑÐ½Ð°!")
        save_data()
        bonus_msg = "\n" + "\n".join(bonus_msg_parts) if bonus_msg_parts else ""
        return f"âš ï¸ Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ð¾ÑÐ²Ð¾Ð±Ð¾Ð¶Ð´ÐµÐ½Ð°, Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÑÐºÐ²Ð°Ð´Ð¾Ð² Ð´Ð»Ñ ÑƒÐ´ÐµÑ€Ð¶Ð°Ð½Ð¸Ñ (Ð½ÑƒÐ¶Ð½Ð¾ {min_squads}).\nðŸ”™ {remaining_attacker_squads} ÑÐºÐ²Ð°Ð´Ð¾Ð² Ð²ÐµÑ€Ð½ÑƒÐ»Ð¾ÑÑŒ Ðº Ð²Ð°Ð¼.{bonus_msg}"
def handle_war_death(dead_id, killer_id, vk_session):
    dead = players[dead_id]
    dead_faction = dead.get("faction")
    backpack = dead.get("backpack", {})
    money = dead.get("money", 0)
    lost_items = {}
    lootable_items = []
    for item, count in list(backpack.items()):
        if count > 0 and item not in DONATION_ARTIFACTS:
            lootable_items.extend([item] * count)
    total_lootable = len(lootable_items)
    if total_lootable > 0:
        max_items_to_lose = max(1, int(total_lootable * 0.15))
        num_items_to_lose = random.randint(1, max_items_to_lose)
        random.shuffle(lootable_items)
        lost_list = lootable_items[:num_items_to_lose]
        for item in lost_list:
            lost_items[item] = lost_items.get(item, 0) + 1
        for item, count in lost_items.items():
            backpack[item] -= count
            if backpack[item] <= 0:
                del backpack[item]
    max_money_to_lose = max(1, int(money * 0.15))
    money_lost = random.randint(1, max_money_to_lose) if money > 0 else 0
    dead["money"] -= money_lost
    dead["health"] = 0
    dead["death_notified"] = True
    if killer_id and killer_id in players and dead_faction != ZOMBIE_FACTION:
        killer = players[killer_id]
        for item, count in lost_items.items():
            killer["backpack"][item] = killer["backpack"].get(item, 0) + count
        killer["money"] = killer.get("money", 0) + money_lost
        loot_msg = f"ðŸ’€ Ð’Ñ‹ ÑƒÐ±Ð¸Ð»Ð¸ Ð²Ñ€Ð°Ð³Ð° Ð² Ð±Ð¾ÑŽ!"
        if lost_items or money_lost:
            loot_msg += "\nÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾:"
            for item, count in lost_items.items():
                loot_msg += f"\n  {item} x{count}"
            if money_lost > 0:
                loot_msg += f"\n  ðŸ’² {money_lost}Ñ€"
        send_message(killer_id, loot_msg, None, vk_session)
    msg_lines = ["ðŸ’€ Ð’Ñ‹ Ð¿Ð¾Ð³Ð¸Ð±Ð»Ð¸ Ð² Ð±Ð¾ÑŽ!"]
    if lost_items or money_lost:
        msg_lines.append("ÐŸÐ¾Ñ‚ÐµÑ€ÑÐ½Ð¾:")
        for item, count in lost_items.items():
            msg_lines.append(f"  {item} x{count}")
        if money_lost > 0:
            msg_lines.append(f"  ðŸ’² {money_lost}Ñ€")
    send_message(dead_id, "\n".join(msg_lines), create_main_menu_keyboard(dead_id), vk_session)
    save_data()
def init_anomaly_exploration(user_id):
    p = players[user_id]
    location = p["location"]
    point = p["point"]
    atype = ANOMALY_ZONES.get(location, {}).get(point, "Ð³Ñ€Ð°Ð²Ð¸")
    p["current_anomaly_type"] = atype
    p["state"] = STATE_ANOMALY_EXPLORE
    if random.randint(1, 100) <= 70:
        safe_path = random.randint(1, 3)
        p["anomaly_safe_path"] = safe_path
        p["anomaly_path_choosing"] = True
    else:
        p["anomaly_path_choosing"] = False
        p["anomaly_safe_path"] = None
        start_anomaly_map(user_id)
    save_data()
def start_anomaly_map(user_id):
    p = players[user_id]
    player_start = (random.randint(0, 5), random.randint(0, 5))
    p["player_pos"] = player_start
    num_artifacts = random.randint(1, 3)
    num_anomalies = random.randint(3, 6)
    num_hidden_anomalies = random.randint(0, 2)
    occupied = {player_start}
    artifact_positions = []
    for _ in range(num_artifacts):
        attempts = 0
        while attempts < 50:
            pos = (random.randint(0, 5), random.randint(0, 5))
            if pos not in occupied:
                artifact_positions.append(pos)
                occupied.add(pos)
                break
            attempts += 1
    anomaly_positions = []
    for _ in range(num_anomalies):
        attempts = 0
        while attempts < 50:
            pos = (random.randint(0, 5), random.randint(0, 5))
            if pos not in occupied:
                anomaly_positions.append(pos)
                occupied.add(pos)
                break
            attempts += 1
    hidden_anomaly_positions = []
    for _ in range(num_hidden_anomalies):
        attempts = 0
        while attempts < 50:
            pos = (random.randint(0, 5), random.randint(0, 5))
            if pos not in occupied:
                hidden_anomaly_positions.append(pos)
                occupied.add(pos)
                break
            attempts += 1
    p["artifact_positions"] = artifact_positions
    p["anomaly_positions"] = anomaly_positions
    p["hidden_anomaly_positions"] = hidden_anomaly_positions
    p["anomaly_path_choosing"] = False
    p["anomaly_safe_path"] = None
def get_detector_alerts(user_id):
    p = players[user_id]
    detector = p.get("detector", None)
    px, py = p.get("player_pos", (0, 0))
    artifact_positions = [tuple(pos) for pos in p.get("artifact_positions", [])]
    anomaly_positions = [tuple(pos) for pos in p.get("anomaly_positions", [])]
    alerts = []
    if detector in ["ÐœÐµÐ´Ð²ÐµÐ´ÑŒ", "Ð’ÐµÐ»ÐµÑ", "Ð¡Ð²Ð°Ñ€Ð¾Ð³"]:
        anomaly_dirs = []
        for ax, ay in anomaly_positions:
            if abs(ax - px) <= 1 and abs(ay - py) <= 1 and (ax, ay) != (px, py):
                direction = ""
                if ay < py:
                    direction += "â¬†ï¸"
                if ay > py:
                    direction += "â¬‡ï¸"
                if ax < px:
                    direction += "â¬…ï¸"
                if ax > px:
                    direction += "âž¡ï¸"
                if direction and direction not in anomaly_dirs:
                    anomaly_dirs.append(direction)
        if anomaly_dirs:
            alerts.append("ðŸš¨" + "|".join(anomaly_dirs))
    if detector == "ÐžÑ‚ÐºÐ»Ð¸Ðº":
        for ax, ay in artifact_positions:
            if abs(ax - px) <= 1 and abs(ay - py) <= 1 and (ax, ay) != (px, py):
                alerts.append("âœ´ï¸âœ´ï¸âœ´ï¸")
                break
    elif detector == "ÐœÐµÐ´Ð²ÐµÐ´ÑŒ":
        for ax, ay in artifact_positions:
            dist = max(abs(ax - px), abs(ay - py))
            if dist == 1:
                alerts.append("âœ´ï¸âœ´ï¸âœ´ï¸")
                break
            elif dist == 2:
                alerts.append("âœ´ï¸âœ´ï¸")
                break
    return " ".join(alerts)
def generate_anomaly_map_image(user_id):
    p = players[user_id]
    player_pos = tuple(p.get("player_pos", (0, 0)))
    artifact_positions = [tuple(pos) for pos in p.get("artifact_positions", [])]
    anomaly_positions = [tuple(pos) for pos in p.get("anomaly_positions", [])]
    detector = p.get("detector", None)
    cell_size = 60
    grid_size = 6
    width = cell_size * grid_size
    height = cell_size * grid_size
    try:
        bg = Image.open("backgrounds/background.png").convert("RGBA").resize((width, height))
        enhancer = ImageEnhance.Brightness(bg)
        bg = enhancer.enhance(0.75)
    except:
        bg = Image.new("RGBA", (width, height), (40, 40, 40, 255))
    img = bg.copy()
    draw = ImageDraw.Draw(img)
    for row in range(grid_size):
        for col in range(grid_size):
            x = col * cell_size
            y = row * cell_size
            draw.rectangle([x, y, x + cell_size, y + cell_size], outline="black", width=2)
    icon_size = cell_size - 10
    try:
        player_icon = Image.open("backgrounds/Ð¸Ð³Ñ€Ð¾Ðº.png").convert("RGBA").resize((icon_size, icon_size))
    except:
        player_icon = None
    try:
        artifact_icon = Image.open("backgrounds/Ð°Ñ€Ñ‚.png").convert("RGBA").resize((icon_size, icon_size))
    except:
        artifact_icon = None
    try:
        anomaly_icon = Image.open("backgrounds/Ð°Ð½Ð¾Ð¼.png").convert("RGBA").resize((icon_size, icon_size))
    except:
        anomaly_icon = None
    px, py = player_pos
    if detector in ["Ð’ÐµÐ»ÐµÑ", "Ð¡Ð²Ð°Ñ€Ð¾Ð³"]:
        for ax, ay in artifact_positions:
            if abs(ax - px) <= 4 and abs(ay - py) <= 4:
                x = ax * cell_size + 5
                y = ay * cell_size + 5
                if artifact_icon:
                    img.paste(artifact_icon, (x, y), artifact_icon)
                else:
                    draw.ellipse([x, y, x + icon_size, y + icon_size], fill="yellow", outline="orange")
    if detector == "Ð¡Ð²Ð°Ñ€Ð¾Ð³":
        for ax, ay in anomaly_positions:
            if abs(ax - px) <= 4 and abs(ay - py) <= 4:
                x = ax * cell_size + 5
                y = ay * cell_size + 5
                if anomaly_icon:
                    img.paste(anomaly_icon, (x, y), anomaly_icon)
                else:
                    draw.ellipse([x, y, x + icon_size, y + icon_size], fill="cyan", outline="blue")
    x = px * cell_size + 5
    y = py * cell_size + 5
    if player_icon:
        img.paste(player_icon, (x, y), player_icon)
    else:
        draw.ellipse([x, y, x + icon_size, y + icon_size], fill="white", outline="gray")
    buffer = io.BytesIO()
    img.save(buffer, format="PNG")
    buffer.seek(0)
    return buffer
def handle_anomaly_move(user_id, direction, vk_session):
    p = players[user_id]
    px, py = p.get("player_pos", (0, 0))
    if direction == "â¬†ï¸" and py > 0:
        py -= 1
    elif direction == "â¬‡ï¸" and py < 5:
        py += 1
    elif direction == "â¬…ï¸" and px > 0:
        px -= 1
    elif direction == "âž¡ï¸" and px < 5:
        px += 1
    else:
        send_message(user_id, "âŒ ÐÐµÐ»ÑŒÐ·Ñ Ð´Ð²Ð¸Ð³Ð°Ñ‚ÑŒÑÑ Ð² ÑÑ‚Ð¾Ð¼ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸.", create_anomaly_movement_keyboard(), vk_session)
        return
    p["player_pos"] = (px, py)
    messages = []
    artifact_positions = [tuple(pos) for pos in p.get("artifact_positions", [])]
    anomaly_positions = [tuple(pos) for pos in p.get("anomaly_positions", [])]
    hidden_anomaly_positions = [tuple(pos) for pos in p.get("hidden_anomaly_positions", [])]
    if (px, py) in artifact_positions:
        atype = p.get("current_anomaly_type", "Ð³Ñ€Ð°Ð²Ð¸")
        found_artifact = get_random_artifact_by_rarity(atype)
        p["backpack"][found_artifact] = p["backpack"].get(found_artifact, 0) + 1
        artifact_positions.remove((px, py))
        p["artifact_positions"] = artifact_positions
        detector = p.get("detector", "ÐžÑ‚ÐºÐ»Ð¸Ðº")
        if detector == "Ð’ÐµÐ»ÐµÑ":
            charge_cost = 2
        elif detector == "Ð¡Ð²Ð°Ñ€Ð¾Ð³":
            charge_cost = 3
        else:
            charge_cost = 1
        p["detector_charge"] = max(0, p.get("detector_charge", 0) - charge_cost)
        messages.append(f"ðŸŒ• Ð’Ñ‹ Ð½Ð°ÑˆÐ»Ð¸ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚: {found_artifact}!")
        messages.append(f"ðŸ“Ÿ Ð”ÐµÑ‚ÐµÐºÑ‚Ð¾Ñ€ Ñ€Ð°Ð·Ñ€ÑÐ´Ð¸Ð»ÑÑ Ð½Ð° {charge_cost} Ð·Ð°Ñ€ÑÐ´(Ð°).")
        if not artifact_positions:
            messages.append("âœ… Ð’ÑÐµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ Ð² ÑÑ‚Ð¾Ð¹ Ð·Ð¾Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹!")
            p["state"] = STATE_IN_MENU
            save_data()
            send_message(user_id, "\n".join(messages), create_main_menu_keyboard(user_id), vk_session)
            return
        min_charge = 2 if detector == "Ð’ÐµÐ»ÐµÑ" else (3 if detector == "Ð¡Ð²Ð°Ñ€Ð¾Ð³" else 1)
        if p["detector_charge"] < min_charge:
            messages.append(f"ðŸ”‹ Ð—Ð°Ñ€ÑÐ´Ð° Ð´ÐµÑ‚ÐµÐºÑ‚Ð¾Ñ€Ð° Ð½ÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð¸ÑÐºÐ°! Ð’Ñ‹ Ð¿Ð¾ÐºÐ¸Ð´Ð°ÐµÑ‚Ðµ Ð°Ð½Ð¾Ð¼Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð·Ð¾Ð½Ñƒ.")
            p["state"] = STATE_IN_MENU
            save_data()
            send_message(user_id, "\n".join(messages), create_main_menu_keyboard(user_id), vk_session)
            return
    if (px, py) in hidden_anomaly_positions:
        atype = p.get("current_anomaly_type", "Ð³Ñ€Ð°Ð²Ð¸")
        min_dmg, max_dmg = ANOMALY_DAMAGE[atype]
        raw_damage = round(random.uniform(min_dmg, max_dmg), 1)
        anomaly_resist = get_total_anomaly_resist(user_id)
        actual_damage = max(0, round(raw_damage - anomaly_resist, 1))
        p["health"] = max(0, p["health"] - actual_damage)
        messages.append(f"ðŸ’¥ Ð’Ñ‹ Ð¿Ð¾Ð¿Ð°Ð»Ð¸ Ð² Ñ‚Ð°Ð¹Ð½ÑƒÑŽ Ð°Ð½Ð¾Ð¼Ð°Ð»Ð¸ÑŽ! ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ {actual_damage} ÑƒÑ€Ð¾Ð½Ð°. (â¤ï¸ {p['health']}/10)")
        hidden_anomaly_positions.remove((px, py))
        p["hidden_anomaly_positions"] = hidden_anomaly_positions
        if random.randint(1, 100) <= 25 and p.get("armor"):
            p["armor_durability"] = max(0, p["armor_durability"] - 1)
            messages.append("ðŸ”§ Ð‘Ñ€Ð¾Ð½Ñ Ð¿Ð¾Ð²Ñ€ÐµÐ¶Ð´ÐµÐ½Ð° (-1)!")
        if p["health"] <= 0:
            messages.append("ðŸ’€ Ð’Ñ‹ Ð¿Ð¾Ð³Ð¸Ð±Ð»Ð¸ Ð² Ð°Ð½Ð¾Ð¼Ð°Ð»Ð¸Ð¸!")
            lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=5, max_money=50)
            messages.extend(format_death_losses(lost_items, money_lost))
            p["state"] = STATE_IN_MENU
            p["death_notified"] = True
            normalize_stats(user_id)
            save_data()
            send_message(user_id, "\n".join(messages), create_main_menu_keyboard(user_id), vk_session)
            return
    if (px, py) in anomaly_positions:
        atype = p.get("current_anomaly_type", "Ð³Ñ€Ð°Ð²Ð¸")
        min_dmg, max_dmg = ANOMALY_DAMAGE[atype]
        raw_damage = round(random.uniform(min_dmg, max_dmg), 1)
        anomaly_resist = get_total_anomaly_resist(user_id)
        actual_damage = max(0, round(raw_damage - anomaly_resist, 1))
        p["health"] = max(0, p["health"] - actual_damage)
        messages.append(f"ðŸ’¥ Ð’Ñ‹ Ð¿Ð¾Ð¿Ð°Ð»Ð¸ Ð² Ð°Ð½Ð¾Ð¼Ð°Ð»Ð¸ÑŽ! ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ {actual_damage} ÑƒÑ€Ð¾Ð½Ð°. (â¤ï¸ {p['health']}/10)")
        if random.randint(1, 100) <= 25 and p.get("armor"):
            p["armor_durability"] = max(0, p["armor_durability"] - 1)
            messages.append("ðŸ”§ Ð‘Ñ€Ð¾Ð½Ñ Ð¿Ð¾Ð²Ñ€ÐµÐ¶Ð´ÐµÐ½Ð° (-1)!")
        if p["health"] <= 0:
            messages.append("ðŸ’€ Ð’Ñ‹ Ð¿Ð¾Ð³Ð¸Ð±Ð»Ð¸ Ð² Ð°Ð½Ð¾Ð¼Ð°Ð»Ð¸Ð¸!")
            lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=5, max_money=50)
            messages.extend(format_death_losses(lost_items, money_lost))
            p["state"] = STATE_IN_MENU
            p["death_notified"] = True
            normalize_stats(user_id)
            save_data()
            send_message(user_id, "\n".join(messages), create_main_menu_keyboard(user_id), vk_session)
            return
    alerts = get_detector_alerts(user_id)
    if alerts:
        messages.append(alerts)
    save_data()
    try:
        img_buffer = generate_anomaly_map_image(user_id)
        upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
        response = vk_session.http.post(upload_url, files={"photo": ("map.png", img_buffer, "image/png")})
        result = response.json()
        photo_data = vk_session.method("photos.saveMessagesPhoto", {"photo": result["photo"], "server": result["server"], "hash": result["hash"]})[0]
        msg = "\n".join(messages) if messages else "Ð’Ñ‹ Ð¿ÐµÑ€ÐµÐ¼ÐµÑÑ‚Ð¸Ð»Ð¸ÑÑŒ."
        vk_session.method("messages.send", {"user_id": user_id, "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}", "random_id": 0, "message": msg, "keyboard": create_anomaly_movement_keyboard().get_keyboard()})
    except Exception as e:
        logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÐºÐ°Ñ€Ñ‚Ñ‹: {e}")
        send_message(user_id, "\n".join(messages) if messages else "Ð’Ñ‹ Ð¿ÐµÑ€ÐµÐ¼ÐµÑÑ‚Ð¸Ð»Ð¸ÑÑŒ.", create_anomaly_movement_keyboard(), vk_session)
def send_location_map(user_id, location, vk_session):
    try:
        img_buffer = generate_war_map_image(location)
        if img_buffer:
            upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
            response = vk_session.http.post(upload_url, files={"photo": ("map.png", img_buffer, "image/png")})
            result = response.json()
            photo_data = vk_session.method("photos.saveMessagesPhoto", {
                "photo": result["photo"],
                "server": result["server"],
                "hash": result["hash"]
            })[0]
            current_point = players[user_id]["point"]
            vk_session.method("messages.send", {
                "user_id": user_id,
                "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}",
                "random_id": 0,
                "message": f"ðŸ—ºï¸ ÐšÐ°Ñ€Ñ‚Ð° Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸: {location}\nðŸ“ Ð’Ð°ÑˆÐ° Ñ‚Ð¾Ñ‡ÐºÐ°: {current_point}\n\nðŸŒ Ð’Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ð¾Ñ‡ÐºÐ¸ Ð½Ð° ÐºÐ°Ñ€Ñ‚Ðµ, Ð½Ð° ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÑ‚ÐµÑÑŒ Ð¿ÐµÑ€ÐµÐ¹Ñ‚Ð¸:\nâ• ÐŸÑ€Ð¸Ð¼ÐµÑ€: \"Ð¢Ð 1\", \"Ð‘1\"."
            })
            return True
    except Exception as e:
        logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÐºÐ°Ñ€Ñ‚Ñ‹: {e}")
    send_message(user_id, 'ðŸŒ Ð’Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ð¾Ñ‡ÐºÐ¸ Ð½Ð° ÐºÐ°Ñ€Ñ‚Ðµ, Ð½Ð° ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÑ‚ÐµÑÑŒ Ð¿ÐµÑ€ÐµÐ¹Ñ‚Ð¸:\nâ• ÐŸÑ€Ð¸Ð¼ÐµÑ€: "Ð¢Ð 1", "Ð‘1".', None, vk_session)
    return False
def handle_hunting_escape(user_id, vk_session):
    p = players[user_id]
    lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=5, max_money=50)
    msg_lines = ["ðŸ’¨ Ð’Ñ‹ ÑÐ±ÐµÐ¶Ð°Ð»Ð¸ Ñ Ð¾Ñ…Ð¾Ñ‚Ñ‹!"]
    msg_lines.extend(format_death_losses(lost_items, money_lost))
    send_message(user_id, "\n".join(msg_lines), create_main_menu_keyboard(user_id), vk_session)
    p["state"] = STATE_IN_MENU
    p.pop("current_mutant", None)
    p.pop("mutant_hp", None)
    save_data()
def use_item(user_id, item_input, vk_session, from_global_command=False):
    p = players[user_id]
    parts = item_input.strip().split()
    if not parts:
        if from_global_command:
            send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚.", None, vk_session)
        else:
            send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚.", create_backpack_menu_keyboard(), vk_session)
        return
    item_name = ""
    count = 1
    if len(parts) >= 2:
        try:
            count = int(parts[-1])
            item_name = " ".join(parts[:-1]).lower()
        except:
            item_name = item_input.strip().lower()
    else:
        item_name = item_input.strip().lower()
    if item_name == "Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸":
        if from_global_command:
            send_message(user_id, "âŒ Ð‘Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸ Ð½ÐµÐ»ÑŒÐ·Ñ ÑƒÐ¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÑŒ.", None, vk_session)
        else:
            send_message(user_id, "âŒ Ð‘Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸ Ð½ÐµÐ»ÑŒÐ·Ñ ÑƒÐ¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÑŒ.", create_backpack_menu_keyboard(), vk_session)
        return
    if item_name not in ITEM_EFFECTS:
        if from_global_command:
            send_message(user_id, "âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚.", None, vk_session)
        else:
            send_message(user_id, "âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚.", create_backpack_menu_keyboard(), vk_session)
        return
    backpack = p.get("backpack", {})
    if backpack.get(item_name, 0) < count:
        if from_global_command:
            send_message(user_id, f"âŒ Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ {count} ÑˆÑ‚. ÑÑ‚Ð¾Ð³Ð¾ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð°.", None, vk_session)
        else:
            send_message(user_id, f"âŒ Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ {count} ÑˆÑ‚. ÑÑ‚Ð¾Ð³Ð¾ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð°.", create_backpack_menu_keyboard(), vk_session)
        return
    effects = ITEM_EFFECTS[item_name]
    messages = []
    if effects.get("random_effect"):
        for _ in range(count):
            effect_msg = apply_random_effect(user_id, vk_session)
            messages.append(f"ðŸŒ° Ð–ÐµÐ»ÑƒÐ´ÑŒ: {effect_msg}")
        backpack[item_name] -= count
        if backpack[item_name] <= 0:
            del backpack[item_name]
        normalize_stats(user_id)
        save_data()
        if from_global_command:
            send_message(user_id, "\n".join(messages), None, vk_session)
        else:
            send_message(user_id, "\n".join(messages), create_backpack_menu_keyboard(), vk_session)
        return
    for attr, value in effects.items():
        total_value = value * count
        if attr == "health":
            p["health"] = min(10, p["health"] + total_value)
            if p["health"] > 0:
                p.pop("death_notified", None)
            messages.append(f"â¤ï¸ Ð—Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ Ð´Ð¾ {round(p['health'], 1)}/10")
        elif attr == "radiation":
            p["radiation"] = max(0, p["radiation"] + total_value)
            messages.append(f"â˜¢ï¸ Ð Ð°Ð´Ð¸Ð°Ñ†Ð¸Ñ ÑÐ½Ð¸Ð¶ÐµÐ½Ð° Ð´Ð¾ {round(p['radiation'], 1)}/10")
        elif attr == "hunger":
            p["hunger"] = max(0, p["hunger"] + total_value)
            messages.append(f"ðŸ½ï¸ Ð“Ð¾Ð»Ð¾Ð´ ÑÐ½Ð¸Ð¶ÐµÐ½ Ð´Ð¾ {round(p['hunger'], 1)}/10")
        elif attr == "stamina":
            p["stamina"] = min(10, p["stamina"] + total_value)
            messages.append(f"âš¡ Ð’Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð° Ð´Ð¾ {round(p['stamina'], 1)}/10")
    if has_active_donation(user_id) and item_name not in DONATION_EXCLUDED_ITEMS:
        donation_art = get_donation_artifact(user_id)
        belt = p.get("belt", [None, None, None])
        if donation_art in belt or backpack.get(donation_art, 0) > 0:
            if donation_art == "ÐŸÐ¾Ð½Ñ‡Ð¸Ðº":
                heal_bonus = 0.5 * count
                p["health"] = min(10, p["health"] + heal_bonus)
                messages.append(f"ðŸ© ÐŸÐ¾Ð½Ñ‡Ð¸Ðº: +{heal_bonus}â¤ï¸")
            elif donation_art == "Ð¡Ñ‚ÐµÐ¹Ðº":
                hunger_bonus = 0.5 * count
                p["hunger"] = max(0, p["hunger"] - hunger_bonus)
                messages.append(f"ðŸ¥© Ð¡Ñ‚ÐµÐ¹Ðº: -{hunger_bonus}ðŸ½ï¸")
    if not messages:
        messages.append(f"âœ… Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¾: {item_name} x{count}")
    backpack[item_name] -= count
    if backpack[item_name] <= 0:
        del backpack[item_name]
    normalize_stats(user_id)
    save_data()
    if from_global_command:
        send_message(user_id, "\n".join(messages), None, vk_session)
    else:
        send_message(user_id, "\n".join(messages), create_backpack_menu_keyboard(), vk_session)
def apply_random_effect(user_id, vk_session):
    p = players[user_id]
    effects = [
        ("health", 0.5, "â¤ï¸ +0.5 Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ"),
        ("health", -0.5, "ðŸ’” -0.5 Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ"),
        ("radiation", 0.5, "â˜¢ï¸ +0.5 Ñ€Ð°Ð´Ð¸Ð°Ñ†Ð¸Ð¸"),
        ("radiation", -0.5, "â˜¢ï¸ -0.5 Ñ€Ð°Ð´Ð¸Ð°Ñ†Ð¸Ð¸"),
        ("hunger", 0.5, "ðŸ½ï¸ +0.5 Ð³Ð¾Ð»Ð¾Ð´Ð°"),
        ("hunger", -0.5, "ðŸ½ï¸ -0.5 Ð³Ð¾Ð»Ð¾Ð´Ð°"),
        ("stamina", 0.5, "âš¡ +0.5 Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚Ð¸"),
        ("stamina", -0.5, "âš¡ -0.5 Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚Ð¸"),
    ]
    effect = random.choice(effects)
    attr, value, msg = effect
    if attr == "money":
        p["money"] = max(0, p.get("money", 0) + int(value))
    elif attr == "health":
        p["health"] = max(0, min(10, p["health"] + value))
    elif attr == "radiation":
        p["radiation"] = max(0, min(10, p["radiation"] + value))
    elif attr == "hunger":
        p["hunger"] = max(0, min(10, p["hunger"] + value))
    elif attr == "stamina":
        p["stamina"] = max(0, min(10, p["stamina"] + value))
    save_data()
    return msg
def find_player_by_mention_or_nickname(target, vk_session):
    target = target.strip()
    if target.startswith('@'):
        screen_name = target[1:].lower()
        for uid, data in players.items():
            if data.get("screen_name", "").lower() == screen_name:
                return uid
        return None
    target_lower = target.lower()
    for uid, data in players.items():
        nickname = data.get("nickname", "")
        if nickname.lower() == target_lower:
            return uid
    for uid, data in players.items():
        nickname = data.get("nickname", "")
        if target_lower in nickname.lower():
            return uid
    return None
def is_admin(user_id):
    return user_id == 353430025 or user_id in admin_users
def is_game_open():
    for faction in factions:
        if len(factions[faction]) < MAX_FACTION_SIZES[faction]:
            return False
    return True
def handle_global_commands(user_id, text, vk_session, reply_user_id=None):
    text_original = text.strip()
    text = text_original.lower()
    words = text.split()
    words_original = text_original.split()
    if user_id in banned_users and not is_admin(user_id):
        return True
    if text == "Ð¸Ð½Ñ„Ð¾":
        current_keyboard = None
        state = players[user_id]["state"]
        if state == STATE_IN_MENU:
            current_keyboard = create_main_menu_keyboard(user_id)
        elif state == STATE_IN_CAMP:
            current_keyboard = create_camp_menu_keyboard()
        elif state == STATE_IN_BACKPACK:
            current_keyboard = create_backpack_menu_keyboard()
        elif state == STATE_TRADER_MAIN:
            current_keyboard = create_trader_main_keyboard()
        elif state == STATE_TRADER_BUY_CATEGORY:
            current_keyboard = create_trader_category_keyboard()
        elif state == STATE_TRADER_SELL_CATEGORY:
            current_keyboard = create_trader_sell_category_keyboard()
        elif state == STATE_TRADER_BUY_EQUIPMENT:
            current_keyboard = create_equipment_category_keyboard()
        elif state == STATE_TRADER_SELL_EQUIPMENT_CONFIRM:
            current_keyboard = create_equipment_sell_keyboard()
        elif state == STATE_TRADER_REPAIR:
            current_keyboard = create_repair_keyboard(user_id)
        elif state == STATE_WAREHOUSE:
            current_keyboard = create_warehouse_keyboard()
        send_message(user_id, format_camp_info(user_id), current_keyboard, vk_session)
        return True
    if text == "*":
        state = players[user_id]["state"]
        if state in [STATE_TRANSITION_WAIT, STATE_RESTING]:
            send_message(user_id, "ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° * Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð²Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð° Ð¸Ð»Ð¸ Ð¾Ñ‚Ð´Ñ‹Ñ…Ð°.", None, vk_session)
            return True
        if state == STATE_IN_MENU:
            send_message(user_id, MAIN_MENU_TEXT, create_main_menu_keyboard(user_id), vk_session)
        elif state == STATE_IN_CAMP:
            send_message(user_id, format_camp_info(user_id), create_camp_menu_keyboard(), vk_session)
        elif state == STATE_IN_BACKPACK:
            upload_and_send_inventory(user_id, vk_session)
            return True
        elif state == STATE_WAREHOUSE:
            upload_and_send_warehouse_global(user_id, vk_session)
            return True
        elif state == STATE_TRADER_MAIN:
            send_message(user_id, "Ð’Ñ‹ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ñ‡Ñ‚Ð¾ Ð»Ð¸Ð±Ð¾ ðŸ’² Ð¿Ñ€Ð¸Ð¾Ð±Ñ€ÐµÑÑ‚Ð¸ Ð¸Ð»Ð¸ ðŸ’± Ð¿Ñ€Ð¾Ð´Ð°Ñ‚ÑŒ?", create_trader_main_keyboard(), vk_session)
        elif state == STATE_TRADER_BUY_CATEGORY:
            send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ:", create_trader_category_keyboard(), vk_session)
        elif state == STATE_TRADER_SELL_CATEGORY:
            send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ:", create_trader_sell_category_keyboard(), vk_session)
        elif state == STATE_TRADER_BUY_EQUIPMENT:
            send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‚Ð¸Ð¿ ÑÐ½Ð°Ñ€ÑÐ¶ÐµÐ½Ð¸Ñ:", create_equipment_category_keyboard(), vk_session)
        elif state == STATE_TRADER_SELL_EQUIPMENT_CONFIRM:
            send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ ÑÐ½Ð°Ñ€ÑÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð¸:", create_equipment_sell_keyboard(), vk_session)
        elif state == STATE_TRADER_BUY:
            show_buy_provisions_menu(user_id, vk_session)
            return True
        elif state == STATE_TRADER_SELL:
            show_sell_provisions_menu(user_id, vk_session)
            return True
        elif state == STATE_TRADER_REPAIR:
            p = players[user_id]
            money = p.get("money", 0)
            repair_text = (
                f"âš™ï¸ Ð§Ñ‚Ð¾ ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÑ‚ÐµÑÑŒ Ð¿Ð¾Ñ‡Ð¸Ð½Ð¸Ñ‚ÑŒ? ðŸ§\n"
                f"â— Ð ÐµÐ¼Ð¾Ð½Ñ‚ Ð½Ð° 1 ÐµÐ´Ð¸Ð½Ð¸Ñ†Ñƒ Ð¾ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð»ÑÐµÑ‚ÑÑ Ð·Ð° 15Ñ€\n"
                f"ðŸ’² Ð”ÐµÐ½ÑŒÐ³Ð¸: {money}Ñ€")
            send_message(user_id, repair_text, create_repair_keyboard(user_id), vk_session)
            return True
        else:
            send_message(user_id, "ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° * Ð½Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð² ÑÑ‚Ð¾Ð¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¸.", None, vk_session)
        return True
    if text == "2604":
        current_state = players.get(user_id, {}).get("state")
        if current_state in [STATE_TRANSITION_WAIT, STATE_HUNTING, STATE_HUNTING_SHOOTING]:
            send_message(user_id, "âŒ ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° 2604 Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð½Ð° Ð´Ð°Ð½Ð½Ñ‹Ð¹ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚.", None, vk_session)
        elif user_id in players:
            players[user_id]["state"] = STATE_IN_MENU
            save_data()
            send_message(user_id, "âœ… Ð’Ñ‹ Ð²ÐµÑ€Ð½ÑƒÐ»Ð¸ÑÑŒ Ð² Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ.", create_main_menu_keyboard(user_id), vk_session)
        else:
            send_message(user_id, "âŒ Ð’Ñ‹ Ð½Ðµ Ð² Ð¸Ð³Ñ€Ðµ.", None, vk_session)
        return True
    if words and words[0] in ["Ð¸ÑÐ¿", "Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ"] and len(words) >= 2:
        item_part = " ".join(words[1:])
        use_item(user_id, item_part, vk_session, from_global_command=True)
        return True
    if words and words[0] == "Ð¿ÐµÑ€ÐµÐ²ÐµÑÑ‚Ð¸" and len(words) >= 3:
        try:
            amount = int(words[1])
            target_str = words[2]
        except:
            send_message(user_id, "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚. ÐŸÑ€Ð¸Ð¼ÐµÑ€: Ð¿ÐµÑ€ÐµÐ²ÐµÑÑ‚Ð¸ 100 Ð½Ð¸Ðº", None, vk_session)
            return True
        if amount <= 0:
            send_message(user_id, "âŒ Ð¡ÑƒÐ¼Ð¼Ð° Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐµ 0.", None, vk_session)
            return True
        target_uid = find_player_by_mention_or_nickname(target_str, vk_session)
        if not target_uid:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¿Ð¾ Ð½Ð¸ÐºÑƒ.", None, vk_session)
            return True
        if target_uid == user_id:
            send_message(user_id, "âŒ ÐÐµÐ»ÑŒÐ·Ñ Ð¿ÐµÑ€ÐµÐ²ÐµÑÑ‚Ð¸ Ð´ÐµÐ½ÑŒÐ³Ð¸ ÑÐ°Ð¼Ð¾Ð¼Ñƒ ÑÐµÐ±Ðµ.", None, vk_session)
            return True
        if target_uid in banned_users:
            send_message(user_id, "âŒ Ð­Ñ‚Ð¾Ñ‚ Ð¸Ð³Ñ€Ð¾Ðº Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½.", None, vk_session)
            return True
        if players[user_id]["money"] < amount:
            send_message(user_id, f"âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´ÐµÐ½ÐµÐ³. Ð£ Ð²Ð°Ñ {players[user_id]['money']}Ñ€.", None, vk_session)
            return True
        players[user_id]["money"] -= amount
        players[target_uid]["money"] = players[target_uid].get("money", 0) + amount
        sender_nickname = players[user_id]["nickname"]
        save_data()
        send_message(user_id, f"âœ… ÐŸÐµÑ€ÐµÐ²ÐµÐ´ÐµÐ½Ð¾ {amount}Ñ€ Ð¸Ð³Ñ€Ð¾ÐºÑƒ {players[target_uid]['nickname']}.", None, vk_session)
        send_message(target_uid, f"ðŸ“¥ Ð’Ð°Ð¼ Ð¿ÐµÑ€ÐµÐ²Ñ‘Ð»(Ð°) {sender_nickname}: {amount}Ñ€", None, vk_session)
        return True
    if words and words[0] == "Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ":
        target_uid = None
        if reply_user_id:
            if reply_user_id in players:
                target_uid = reply_user_id
        if len(words) >= 4 and not target_uid:
            item_parts = []
            amount = None
            target_str = None
            for i in range(len(words_original) - 1, 0, -1):
                if target_str is None:
                    target_str = words_original[i]
                elif amount is None:
                    try:
                        amount = int(words_original[i])
                    except:
                        send_message(user_id, "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚. ÐŸÑ€Ð¸Ð¼ÐµÑ€: Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ñ…Ð»ÐµÐ± 2 Ð½Ð¸Ðº", None, vk_session)
                        return True
                else:
                    item_parts = words_original[1:i+1]
                    break
            if not item_parts or amount is None or target_str is None:
                send_message(user_id, "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚. ÐŸÑ€Ð¸Ð¼ÐµÑ€: Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ñ…Ð»ÐµÐ± 2 Ð½Ð¸Ðº", None, vk_session)
                return True
            item_name_original = " ".join(item_parts)
            target_uid = find_player_by_mention_or_nickname(target_str, vk_session)
        elif reply_user_id and len(words) >= 3:
            try:
                amount = int(words[-1])
                item_name_original = " ".join(words_original[1:-1])
            except:
                send_message(user_id, "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚. ÐŸÑ€Ð¸Ð¼ÐµÑ€: Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ñ…Ð»ÐµÐ± 2 (Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð¼ Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ)", None, vk_session)
                return True
        else:
            send_message(user_id, "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚. ÐŸÑ€Ð¸Ð¼ÐµÑ€: Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ñ…Ð»ÐµÐ± 2 Ð½Ð¸Ðº Ð¸Ð»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð¼ Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ", None, vk_session)
            return True
        if not target_uid:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session)
            return True
        if target_uid == user_id:
            send_message(user_id, "âŒ ÐÐµÐ»ÑŒÐ·Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚ ÑÐ°Ð¼Ð¾Ð¼Ñƒ ÑÐµÐ±Ðµ.", None, vk_session)
            return True
        if target_uid in banned_users:
            send_message(user_id, "âŒ Ð­Ñ‚Ð¾Ñ‚ Ð¸Ð³Ñ€Ð¾Ðº Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½.", None, vk_session)
            return True
        found_item = None
        for item in ITEM_EFFECTS.keys():
            if item.lower() == item_name_original.lower():
                found_item = item
                break
        if not found_item:
            for art in ALL_ARTIFACTS:
                if art.lower() == item_name_original.lower():
                    found_item = art
                    break
        if not found_item:
            for art in DONATION_ARTIFACTS:
                if art.lower() == item_name_original.lower():
                    found_item = art
                    break
        if not found_item:
            send_message(user_id, "âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚.", None, vk_session)
            return True
        backpack = players[user_id]["backpack"]
        current_count = backpack.get(found_item, 0)
        if current_count < amount:
            send_message(user_id, f"âŒ Ð£ Ð²Ð°Ñ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð¾Ð². Ð•ÑÑ‚ÑŒ: {current_count}.", None, vk_session)
            return True
        backpack[found_item] -= amount
        if backpack[found_item] <= 0:
            del backpack[found_item]
        players[target_uid]["backpack"][found_item] = players[target_uid]["backpack"].get(found_item, 0) + amount
        sender_nickname = players[user_id]["nickname"]
        save_data()
        send_message(user_id, f"âœ… ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ {found_item} x{amount} Ð¸Ð³Ñ€Ð¾ÐºÑƒ {players[target_uid]['nickname']}.", None, vk_session)
        send_message(target_uid, f"ðŸ“¥ Ð’Ð°Ð¼ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ð»(Ð°) {sender_nickname}: {found_item} x{amount}", None, vk_session)
        return True
    if text.lower().startswith("Ð¸Ð½Ñ„Ð¾ "):
        info_parts = text.lower()[5:].strip().split()
        if len(info_parts) < 2:
            send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: Ð¸Ð½Ñ„Ð¾ [Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ] [Ñ‚Ð¾Ñ‡ÐºÐ°]\nÐŸÑ€Ð¸Ð¼ÐµÑ€: Ð¸Ð½Ñ„Ð¾ ÐºÐ¾Ñ€Ð´Ð¾Ð½ Ð±1\nÐ¡Ð¾ÐºÑ€Ð°Ñ‰ÐµÐ½Ð¸Ñ: Ñ‚Ð´ = Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", None, vk_session)
            return True
        info_point = info_parts[-1].upper()
        info_loc_input = " ".join(info_parts[:-1])
        location_map = {"ÐºÐ¾Ñ€Ð´Ð¾Ð½": "ÐšÐ¾Ñ€Ð´Ð¾Ð½", "ÑÐ²Ð°Ð»ÐºÐ°": "Ð¡Ð²Ð°Ð»ÐºÐ°", "Ñ‚Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°": "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ñ‚ÐµÐ¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°": "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ñ‚Ð´": "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ð¿Ð¾Ð»ÑÐ½Ð°": "ÐŸÐ¾Ð»ÑÐ½Ð°"}
        info_location = location_map.get(info_loc_input)
        if not info_location:
            send_message(user_id, "âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ.\nÐ”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾: ÐšÐ¾Ñ€Ð´Ð¾Ð½, Ð¡Ð²Ð°Ð»ÐºÐ°, Ñ‚Ð´, ÐŸÐ¾Ð»ÑÐ½Ð°", None, vk_session)
            return True
        if not is_valid_point(info_location, info_point):
            send_message(user_id, f"âŒ Ð¢Ð¾Ñ‡ÐºÐ° {info_point} Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð½Ð° Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸ {info_location}.", None, vk_session)
            return True
        owner = get_territory_owner(info_location, info_point)
        player_faction = players[user_id]["faction"]
        if owner != player_faction:
            send_message(user_id, "âŒ Ð­Ñ‚Ð° Ñ‚ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ð½Ðµ Ð¿Ñ€Ð¸Ð½Ð°Ð´Ð»ÐµÐ¶Ð¸Ñ‚ Ð²Ð°ÑˆÐµÐ¹ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐµ.", None, vk_session)
            return True
        squads_on_point = get_territory_squads(info_location, info_point)
        ptype = POINT_TYPES.get(info_point, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ")
        min_req = MIN_SQUADS_FOR_POINT.get(ptype, 1)
        send_message(user_id, f"ðŸ“ {info_location} {info_point}\nðŸ‘¥ Ð¡ÐºÐ²Ð°Ð´Ð¾Ð²: {squads_on_point}\nðŸ·ï¸ Ð¢Ð¸Ð¿: {ptype}\nðŸ“‹ ÐœÐ¸Ð½Ð¸Ð¼ÑƒÐ¼ Ð´Ð»Ñ ÑƒÐ´ÐµÑ€Ð¶Ð°Ð½Ð¸Ñ: {min_req}", None, vk_session)
        return True
    if text.lower().startswith("Ð¿Ð¾Ð²ÐµÑÐ¸Ñ‚ÑŒ "):
        art_name = text[9:].strip()
        found_art = None
        for art in ALL_ARTIFACTS:
            if art.lower() == art_name.lower():
                found_art = art
                break
        if not found_art:
            send_message(user_id, "âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚.", None, vk_session)
            return True
        if players[user_id]["backpack"].get(found_art, 0) <= 0:
            send_message(user_id, "âŒ Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ ÑÑ‚Ð¾Ð³Ð¾ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð°.", None, vk_session)
            return True
        belt = players[user_id].get("belt", [None, None, None])
        for i in range(3):
            if belt[i] is None:
                belt[i] = found_art
                players[user_id]["belt"] = belt
                players[user_id]["backpack"][found_art] -= 1
                if players[user_id]["backpack"][found_art] <= 0:
                    del players[user_id]["backpack"][found_art]
                save_data()
                send_message(user_id, f"âœ… {found_art} Ð¿Ð¾Ð²ÐµÑˆÐµÐ½ Ð½Ð° Ð¿Ð¾ÑÑ {i + 1}.", None, vk_session)
                return True
        send_message(user_id, "âŒ Ð’ÑÐµ Ð¿Ð¾ÑÑÐ° Ð·Ð°Ð½ÑÑ‚Ñ‹.", None, vk_session)
        return True
    if text.lower().startswith("ÑÐ½ÑÑ‚ÑŒ "):
        art_name = text[6:].strip()
        belt = players[user_id].get("belt", [None, None, None])
        for i in range(3):
            if belt[i] and belt[i].lower() == art_name.lower():
                art = belt[i]
                belt[i] = None
                players[user_id]["belt"] = belt
                players[user_id]["backpack"][art] = players[user_id]["backpack"].get(art, 0) + 1
                save_data()
                send_message(user_id, f"âœ… {art} ÑÐ½ÑÑ‚ Ñ Ð¿Ð¾ÑÑÐ° {i + 1}.", None, vk_session)
                return True
        send_message(user_id, "âŒ Ð­Ñ‚Ð¾Ñ‚ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ Ð½Ðµ Ð½Ð° Ð¿Ð¾ÑÑÐµ.", None, vk_session)
        return True
    if text == "/Ð±Ð¾Ð³" and is_admin(user_id):
        p = players[user_id]
        p["money"] += 1000
        p["health"] = 10
        p["radiation"] = 0
        p["hunger"] = 0
        p["stamina"] = 10
        save_data()
        send_message(user_id, "âœ… Ð’Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¸ 1000Ñ€ Ð¸ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ð»Ð¸ Ð²ÑÐµ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸ÐºÐ¸.", None, vk_session)
        return True
    if text.startswith("/Ð»Ð¸Ð´ÐµÑ€ ") and is_admin(user_id):
        parts = text_original.split(maxsplit=1)
        if len(parts) < 2:
            send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð½Ð¸Ðº Ð¸Ð³Ñ€Ð¾ÐºÐ°.", None, vk_session)
            return True
        target_nick = parts[1].strip()
        target_uid = find_player_by_mention_or_nickname(target_nick, vk_session)
        if not target_uid:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session)
            return True
        target_faction = players[target_uid]["faction"]
        set_faction_leader(target_faction, target_uid)
        send_message(user_id, f"âœ… {target_nick} Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½ Ð»Ð¸Ð´ÐµÑ€Ð¾Ð¼ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¸ {target_faction}.", None, vk_session)
        send_message(target_uid, f"ðŸ‘‘ Ð’Ñ‹ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ñ‹ Ð»Ð¸Ð´ÐµÑ€Ð¾Ð¼ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¸ {target_faction}!", None, vk_session)
        return True
    if text.startswith("/ÑÐµÑ‚ ") and is_admin(user_id):
        parts = text_original.split(maxsplit=1)
        if len(parts) < 2:
            send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð½Ð¸Ðº Ð¸Ð³Ñ€Ð¾ÐºÐ°.", None, vk_session)
            return True
        target_nick = parts[1].strip()
        target_uid = find_player_by_mention_or_nickname(target_nick, vk_session)
        if not target_uid:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session)
            return True
        all_items = list(ITEM_EFFECTS.keys()) + ALL_ARTIFACTS
        for item in all_items:
            players[target_uid]["backpack"][item] = players[target_uid]["backpack"].get(item, 0) + 1
        save_data()
        send_message(user_id, f"âœ… Ð˜Ð³Ñ€Ð¾ÐºÑƒ {target_nick} Ð²Ñ‹Ð´Ð°Ð½Ñ‹ Ð²ÑÐµ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ñ‹ Ð¿Ð¾ 1 ÑˆÑ‚.", None, vk_session)
        return True
    if text.startswith("/Ð³Ð¸Ð² ") and is_admin(user_id):
        parts = text_original.split()
        if len(parts) < 3:
            send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: /Ð³Ð¸Ð² [Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚] [ÐºÐ¾Ð»-Ð²Ð¾] [Ð½Ð¸Ðº]\nÐÐ¸Ðº Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÐµÐ½. ÐŸÑ€Ð¸Ð¼ÐµÑ€: /Ð³Ð¸Ð² Ñ…Ð»ÐµÐ± 5", None, vk_session)
            return True
        target_uid = None
        count = None
        item_end_index = len(parts)
        for i in range(len(parts) - 1, 1, -1):
            potential_nick = " ".join(parts[i:])
            found_uid = find_player_by_mention_or_nickname(potential_nick, vk_session)
            if found_uid:
                target_uid = found_uid
                try:
                    count = int(parts[i - 1])
                    item_end_index = i - 1
                    break
                except:
                    continue
        if target_uid is None:
            try:
                count = int(parts[-1])
                item_end_index = len(parts) - 1
                target_uid = user_id
            except:
                send_message(user_id, "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚. Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾.", None, vk_session)
                return True
        if count is None or count <= 0:
            send_message(user_id, "âŒ ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼ Ñ‡Ð¸ÑÐ»Ð¾Ð¼.", None, vk_session)
            return True
        item_name = " ".join(parts[1:item_end_index]).lower()
        if item_name == "Ð´ÐµÐ½ÑŒÐ³Ð¸":
            players[target_uid]["money"] = players[target_uid].get("money", 0) + count
            save_data()
            send_message(user_id, f"âœ… Ð’Ñ‹Ð´Ð°Ð½Ð¾ {count}Ñ€ Ð¸Ð³Ñ€Ð¾ÐºÑƒ {players[target_uid]['nickname']}.", None, vk_session)
            return True
        found_item = None
        for item in ITEM_EFFECTS.keys():
            if item.lower() == item_name:
                found_item = item
                break
        if not found_item:
            for art in ALL_ARTIFACTS:
                if art.lower() == item_name:
                    found_item = art
                    break
        if not found_item:
            send_message(user_id, "âŒ ÐŸÑ€ÐµÐ´Ð¼ÐµÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session)
            return True
        players[target_uid]["backpack"][found_item] = players[target_uid]["backpack"].get(found_item, 0) + count
        save_data()
        send_message(user_id, f"âœ… Ð’Ñ‹Ð´Ð°Ð½Ð¾ {found_item} x{count} Ð¸Ð³Ñ€Ð¾ÐºÑƒ {players[target_uid]['nickname']}.", None, vk_session)
        return True
    if text.startswith("/Ð´ÑÐ» ") and is_admin(user_id):
        parts = text_original.split()
        if len(parts) < 3:
            send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: /Ð´ÑÐ» [Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚] [ÐºÐ¾Ð»-Ð²Ð¾] [Ð½Ð¸Ðº]\nÐÐ¸Ðº Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÐµÐ½. ÐŸÑ€Ð¸Ð¼ÐµÑ€: /Ð´ÑÐ» Ñ…Ð»ÐµÐ± 5", None, vk_session)
            return True
        target_uid = None
        count = None
        item_end_index = len(parts)
        for i in range(len(parts) - 1, 1, -1):
            potential_nick = " ".join(parts[i:])
            found_uid = find_player_by_mention_or_nickname(potential_nick, vk_session)
            if found_uid:
                target_uid = found_uid
                try:
                    count = int(parts[i - 1])
                    item_end_index = i - 1
                    break
                except:
                    continue
        if target_uid is None:
            try:
                count = int(parts[-1])
                item_end_index = len(parts) - 1
                target_uid = user_id
            except:
                send_message(user_id, "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚. Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾.", None, vk_session)
                return True
        if count is None or count <= 0:
            send_message(user_id, "âŒ ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼ Ñ‡Ð¸ÑÐ»Ð¾Ð¼.", None, vk_session)
            return True
        item_name = " ".join(parts[1:item_end_index]).lower()
        if item_name == "Ð´ÐµÐ½ÑŒÐ³Ð¸":
            players[target_uid]["money"] = max(0, players[target_uid].get("money", 0) - count)
            save_data()
            send_message(user_id, f"âœ… Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ {count}Ñ€ Ñƒ Ð¸Ð³Ñ€Ð¾ÐºÐ° {players[target_uid]['nickname']}.", None, vk_session)
            return True
        found_item = None
        for item in ITEM_EFFECTS.keys():
            if item.lower() == item_name:
                found_item = item
                break
        if not found_item:
            for art in ALL_ARTIFACTS:
                if art.lower() == item_name:
                    found_item = art
                    break
        if not found_item:
            send_message(user_id, "âŒ ÐŸÑ€ÐµÐ´Ð¼ÐµÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session)
            return True
        current = players[target_uid]["backpack"].get(found_item, 0)
        players[target_uid]["backpack"][found_item] = max(0, current - count)
        if players[target_uid]["backpack"][found_item] <= 0:
            del players[target_uid]["backpack"][found_item]
        save_data()
        send_message(user_id, f"âœ… Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ {found_item} x{count} Ñƒ Ð¸Ð³Ñ€Ð¾ÐºÐ° {players[target_uid]['nickname']}.", None, vk_session)
        return True
    if text.startswith("/Ð²Ñ‹Ð±Ñ€Ð¾Ñ") and is_admin(user_id):
        parts = text.split()
        if len(parts) >= 2 and parts[1].lower() == "Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ":
            if not emission_schedule:
                send_message(user_id, "ðŸ“‹ Ð Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¿ÑƒÑÑ‚Ð¾. Ð‘ÑƒÐ´ÐµÑ‚ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸.", None, vk_session)
            else:
                moscow_offset = 3 * 3600
                lines = ["ðŸ“‹ Ð Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð²Ñ‹Ð±Ñ€Ð¾ÑÐ¾Ð²:"]
                for t in emission_schedule:
                    time_str = time.strftime('%d.%m %H:%M', time.gmtime(t + moscow_offset))
                    warned = " âš ï¸" if t in emission_warned else ""
                    remaining = t - time.time()
                    if remaining > 0:
                        mins = int(remaining // 60)
                        lines.append(f"  {time_str} (Ñ‡ÐµÑ€ÐµÐ· {mins} Ð¼Ð¸Ð½){warned}")
                    else:
                        lines.append(f"  {time_str} (Ð¿Ñ€Ð¾ÑÑ€Ð¾Ñ‡ÐµÐ½)")
                send_message(user_id, "\n".join(lines), None, vk_session)
        else:
            trigger_emission(vk_session)
            send_message(user_id, "âœ… Ð’Ñ‹Ð±Ñ€Ð¾Ñ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½.", None, vk_session)
        return True
    if text.startswith("/Ð´Ð¾Ð½Ð°Ñ‚ ") and user_id == 353430025:
        parts = text_original.split()
        if len(parts) < 3:
            send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: /Ð´Ð¾Ð½Ð°Ñ‚ [Ð´ÐµÐ½ÑŒ/Ð½ÐµÐ´ÐµÐ»Ñ/Ð¼ÐµÑÑÑ†] [Ð¿Ð¾Ð½Ñ‡Ð¸Ðº/ÑÑ‚ÐµÐ¹Ðº] [Ð½Ð¸Ðº]", None, vk_session)
            return True
        duration_str = parts[1].lower()
        if duration_str not in DONATION_DURATIONS:
            send_message(user_id, "âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð´Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ. Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾: Ð´ÐµÐ½ÑŒ, Ð½ÐµÐ´ÐµÐ»Ñ, Ð¼ÐµÑÑÑ†", None, vk_session)
            return True
        artifact_input = parts[2].lower()
        artifact = None
        for art in DONATION_ARTIFACTS:
            if art.lower() == artifact_input:
                artifact = art
                break
        if not artifact:
            send_message(user_id, "âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚. Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾: ÐŸÐ¾Ð½Ñ‡Ð¸Ðº, Ð¡Ñ‚ÐµÐ¹Ðº", None, vk_session)
            return True
        target_uid = user_id
        if len(parts) >= 4:
            target_nick = parts[3].strip()
            found_uid = find_player_by_mention_or_nickname(target_nick, vk_session)
            if not found_uid:
                send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session)
                return True
            target_uid = found_uid
        duration = DONATION_DURATIONS[duration_str]
        p = players[target_uid]
        p["donation_end_time"] = time.time() + duration
        p["donation_artifact"] = artifact
        p["backpack"][artifact] = p["backpack"].get(artifact, 0) + 1
        bonus_msg = ""
        if duration_str == "Ð½ÐµÐ´ÐµÐ»Ñ":
            p["backpack"]["Ð½Ð°ÑƒÑ‡Ð½Ð°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°"] = p["backpack"].get("Ð½Ð°ÑƒÑ‡Ð½Ð°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°", 0) + 1
            p["backpack"]["Ð°Ð½Ñ‚Ð¸Ñ€Ð°Ð´"] = p["backpack"].get("Ð°Ð½Ñ‚Ð¸Ñ€Ð°Ð´", 0) + 1
            p["backpack"]["ÐºÐ¾Ð½ÑÐµÑ€Ð²Ð°"] = p["backpack"].get("ÐºÐ¾Ð½ÑÐµÑ€Ð²Ð°", 0) + 1
            p["backpack"]["Ð³ÐµÑ€ÐºÑƒÐ»ÐµÑ"] = p["backpack"].get("Ð³ÐµÑ€ÐºÑƒÐ»ÐµÑ", 0) + 1
            p["money"] = p.get("money", 0) + 100
            bonus_msg = "\n\nðŸŽ Ð‘Ð¾Ð½ÑƒÑÑ‹ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ:\nâ€¢ ÐÐ°ÑƒÑ‡Ð½Ð°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ° x1\nâ€¢ ÐÐ½Ñ‚Ð¸Ñ€Ð°Ð´ x1\nâ€¢ ÐšÐ¾Ð½ÑÐµÑ€Ð²Ð° x1\nâ€¢ Ð“ÐµÑ€ÐºÑƒÐ»ÐµÑ x1\nâ€¢ ðŸ’² 100Ñ€"
        save_data()
        target_name = players[target_uid]["nickname"]
        end_time_str = time.strftime('%d.%m.%Y %H:%M', time.localtime(p["donation_end_time"]))
        send_message(user_id, f"âœ… Ð”Ð¾Ð½Ð°Ñ‚ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð¸Ð³Ñ€Ð¾ÐºÑƒ {target_name} Ð½Ð° {duration_str}!\nðŸŽ ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚: {artifact}\nâ° Ð”ÐµÐ¹ÑÑ‚Ð²ÑƒÐµÑ‚ Ð´Ð¾: {end_time_str}{bonus_msg}", None, vk_session)
        if target_uid != user_id:
            send_message(target_uid, f"ðŸŽ Ð’Ð°Ð¼ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð´Ð¾Ð½Ð°Ñ‚ Ð½Ð° {duration_str}!\nðŸŒ• ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚: {artifact}\nâ° Ð”ÐµÐ¹ÑÑ‚Ð²ÑƒÐµÑ‚ Ð´Ð¾: {end_time_str}{bonus_msg}", None, vk_session)
        return True
    if text.startswith("/Ñ„Ð¾Ñ‚Ð¾") and user_id == 353430025:
        parts = text_original.split(maxsplit=1)
        target_uid = None
        if len(parts) >= 2:
            target_nick = parts[1].strip()
            for uid, data in players.items():
                if data.get("nickname", "").lower() == target_nick.lower():
                    target_uid = uid
                    break
            if not target_uid:
                for uid, data in players.items():
                    nickname = data.get("nickname", "")
                    if target_nick.lower() in nickname.lower():
                        target_uid = uid
                        break
            if not target_uid:
                all_nicks = [f"'{p.get('nickname', '?')}'" for p in players.values() if p.get('nickname')]
                send_message(user_id, f"âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.\n\nðŸ“‹ ÐÐ¸ÐºÐ¸:\n{', '.join(all_nicks[:15])}", None, vk_session)
                return True
        elif reply_user_id and reply_user_id in players:
            target_uid = reply_user_id
        else:
            send_message(user_id, "âŒ ÐžÑ‚Ð²ÐµÑ‚ÑŒÑ‚Ðµ Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¸Ð³Ñ€Ð¾ÐºÐ° Ð¸Ð»Ð¸ ÑƒÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð½Ð¸Ðº", None, vk_session)
            return True
        players[user_id]["pending_photo_target"] = target_uid
        send_message(user_id, f"ðŸ“· ÐŸÑ€Ð¸ÐºÑ€ÐµÐ¿Ð¸Ñ‚Ðµ Ñ„Ð¾Ñ‚Ð¾ Ð´Ð»Ñ Ð¸Ð³Ñ€Ð¾ÐºÐ° {players[target_uid]['nickname']}:", None, vk_session)
        return True
    if text == "/ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹" and is_admin(user_id):
        faction_info = "\nðŸ‘¥ Ð˜Ð“Ð ÐžÐšÐ˜ Ð’ Ð“Ð Ð£ÐŸÐŸÐ˜Ð ÐžÐ’ÐšÐÐ¥:\n"
        for faction in ["ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³", "â˜¦ï¸ Ð“Ñ€ÐµÑ…", "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸"]:
            current = len(factions.get(faction, []))
            limit = MAX_FACTION_SIZES.get(faction, 5)
            faction_info += f"\n{faction}: {current}/{limit}"
        donators_list = []
        for uid, p in players.items():
            if has_active_donation(uid):
                end_time = p.get("donation_end_time", 0)
                end_str = time.strftime('%d.%m.%Y', time.localtime(end_time))
                donators_list.append(f"â€¢ {p.get('nickname', '?')} (Ð´Ð¾ {end_str})")
        donators_info = "\n\nðŸ’Ž Ð”ÐžÐÐÐ¢Ð•Ð Ð«:\n" + ("\n".join(donators_list) if donators_list else "ÐÐµÑ‚ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ…")
        admins_list = []
        if 353430025 in players:
            admins_list.append(f"â€¢ {players[353430025].get('nickname', '?')} (Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº)")
        for uid in admin_users:
            if uid in players and uid != 353430025:
                admins_list.append(f"â€¢ {players[uid].get('nickname', '?')}")
        admins_info = "\n\nðŸ‘‘ ÐÐ”ÐœÐ˜ÐÐ«:\n" + ("\n".join(admins_list) if admins_list else "ÐÐµÑ‚")
        admin_help = f"""ðŸ“‹ ÐÐ”ÐœÐ˜Ð ÐšÐžÐœÐÐÐ”Ð«:
{faction_info}{donators_info}{admins_info}

ðŸ”¹ /Ð±Ð¾Ð³
   ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ 1000Ñ€ Ð¸ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸ÐºÐ¸

ðŸ”¹ /Ð»Ð¸Ð´ÐµÑ€ [Ð½Ð¸Ðº]
   ÐÐ°Ð·Ð½Ð°Ñ‡Ð¸Ñ‚ÑŒ Ð¸Ð³Ñ€Ð¾ÐºÐ° Ð»Ð¸Ð´ÐµÑ€Ð¾Ð¼ ÐµÐ³Ð¾ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¸

ðŸ”¹ /ÑÐµÑ‚ [Ð½Ð¸Ðº]
   Ð’Ñ‹Ð´Ð°Ñ‚ÑŒ Ð¸Ð³Ñ€Ð¾ÐºÑƒ Ð²ÑÐµ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ñ‹ Ð¿Ð¾ 1 ÑˆÑ‚

ðŸ”¹ /Ð³Ð¸Ð² [Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚] [ÐºÐ¾Ð»-Ð²Ð¾] [Ð½Ð¸Ðº]
   Ð’Ñ‹Ð´Ð°Ñ‚ÑŒ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚ Ð¸Ð³Ñ€Ð¾ÐºÑƒ (Ð½Ð¸Ðº Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
   ÐŸÑ€Ð¸Ð¼ÐµÑ€: /Ð³Ð¸Ð² Ñ…Ð»ÐµÐ± 5 ÐÐ¸ÐºÐ˜Ð³Ñ€Ð¾ÐºÐ°
   ÐŸÑ€Ð¸Ð¼ÐµÑ€: /Ð³Ð¸Ð² Ð´ÐµÐ½ÑŒÐ³Ð¸ 1000

ðŸ”¹ /Ð´ÑÐ» [Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚] [ÐºÐ¾Ð»-Ð²Ð¾] [Ð½Ð¸Ðº]
   Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚ Ñƒ Ð¸Ð³Ñ€Ð¾ÐºÐ°
   ÐŸÑ€Ð¸Ð¼ÐµÑ€: /Ð´ÑÐ» Ñ…Ð»ÐµÐ± 5 ÐÐ¸ÐºÐ˜Ð³Ñ€Ð¾ÐºÐ°

ðŸ”¹ /Ð²Ñ‹Ð±Ñ€Ð¾Ñ
   ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð±Ñ€Ð¾Ñ

ðŸ”¹ /Ð²Ñ‹Ð±Ñ€Ð¾Ñ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ
   ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð²Ñ‹Ð±Ñ€Ð¾ÑÐ¾Ð²

ðŸ”¹ /Ð´Ð¾Ð½Ð°Ñ‚ [Ð´ÐµÐ½ÑŒ/Ð½ÐµÐ´ÐµÐ»Ñ/Ð¼ÐµÑÑÑ†] [Ð¿Ð¾Ð½Ñ‡Ð¸Ðº/ÑÑ‚ÐµÐ¹Ðº] [Ð½Ð¸Ðº]
   ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð´Ð¾Ð½Ð°Ñ‚ Ð¸Ð³Ñ€Ð¾ÐºÑƒ
   ÐŸÑ€Ð¸Ð¼ÐµÑ€: /Ð´Ð¾Ð½Ð°Ñ‚ Ð´ÐµÐ½ÑŒ Ð¿Ð¾Ð½Ñ‡Ð¸Ðº ÐÐ¸ÐºÐ˜Ð³Ñ€Ð¾ÐºÐ°

ðŸ”¹ /Ñ„Ð¾Ñ‚Ð¾ [Ð½Ð¸Ðº]
   Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð°Ð²Ð°Ñ‚Ð°Ñ€ÐºÑƒ Ð¸Ð³Ñ€Ð¾ÐºÑƒ (Ð¿Ñ€Ð¸ÐºÑ€ÐµÐ¿Ð¸Ñ‚ÑŒ Ñ„Ð¾Ñ‚Ð¾ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÐµÐ¼)

ðŸ”¹ /Ð»Ð¸Ð¼Ð¸Ñ‚ [Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ°] [Ñ‡Ð¸ÑÐ»Ð¾]
   Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð»Ð¸Ð¼Ð¸Ñ‚ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð² Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐµ
   ÐŸÑ€Ð¸Ð¼ÐµÑ€: /Ð»Ð¸Ð¼Ð¸Ñ‚ Ð´Ð¾Ð»Ð³ 6
   ÐŸÑ€Ð¸Ð¼ÐµÑ€: /Ð»Ð¸Ð¼Ð¸Ñ‚ Ð¾Ð´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸ 4

ðŸ”¹ /ÑÐ¼ÐµÐ½Ð¸Ñ‚ÑŒÐ³Ð¿ [Ð½Ð¸Ðº] [Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ°]
   Ð¡Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÑƒ Ð¸Ð³Ñ€Ð¾ÐºÑƒ
   ÐŸÑ€Ð¸Ð¼ÐµÑ€: /ÑÐ¼ÐµÐ½Ð¸Ñ‚ÑŒÐ³Ð¿ ÐÐ¸ÐºÐ˜Ð³Ñ€Ð¾ÐºÐ° Ð´Ð¾Ð»Ð³

ðŸ”¹ /Ñ‚ÐµÐ»ÐµÐ¿Ð¾Ñ€Ñ‚ [Ð½Ð¸Ðº] [Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ] [Ñ‚Ð¾Ñ‡ÐºÐ°]
   ÐŸÐµÑ€ÐµÐ¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ Ð¸Ð³Ñ€Ð¾ÐºÐ° Ð½Ð° Ð»Ð¾ÐºÐ°Ñ†Ð¸ÑŽ
   ÐŸÑ€Ð¸Ð¼ÐµÑ€: /Ñ‚ÐµÐ»ÐµÐ¿Ð¾Ñ€Ñ‚ ÐÐ¸ÐºÐ˜Ð³Ñ€Ð¾ÐºÐ° ÐšÐ¾Ñ€Ð´Ð¾Ð½ Ð‘1

ðŸ”¹ /Ð½Ð¸Ðº [ÑÑ‚Ð°Ñ€Ñ‹Ð¹_Ð½Ð¸Ðº] [Ð½Ð¾Ð²Ñ‹Ð¹_Ð½Ð¸Ðº]
   Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð½Ð¸Ðº Ð¸Ð³Ñ€Ð¾ÐºÐ° (Ð°Ð²Ñ‚Ð¾Ð¿Ð¾Ð¸ÑÐº)
   ÐŸÑ€Ð¸Ð¼ÐµÑ€: /Ð½Ð¸Ðº Ð”ÐµÐ»Ð¾Ð²Ð¾Ð¹ Ð“Ð°Ð½Ð³ÑÑ‚ÐµÑ€ ÐšÑ€ÑƒÑ‚Ð¾Ð¹ Ð‘Ð¾ÑÑ

ðŸ”¹ /Ð±Ð°Ð½ [Ð½Ð¸Ðº] [Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ð°]
   Ð—Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð³Ñ€Ð¾ÐºÐ° Ð² Ð±Ð¾Ñ‚Ðµ
   ÐŸÑ€Ð¸Ð¼ÐµÑ€: /Ð±Ð°Ð½ ÐŸÐ»Ð¾Ñ…Ð¾Ð¹ Ð˜Ð³Ñ€Ð¾Ðº ÐÐ°Ñ€ÑƒÑˆÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»

ðŸ”¹ /Ñ€Ð°Ð·Ð±Ð°Ð½ [Ð½Ð¸Ðº]
   Ð Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð³Ñ€Ð¾ÐºÐ°
   ÐŸÑ€Ð¸Ð¼ÐµÑ€: /Ñ€Ð°Ð·Ð±Ð°Ð½ ÐŸÐ»Ð¾Ñ…Ð¾Ð¹ Ð˜Ð³Ñ€Ð¾Ðº

ðŸ”¹ /skip_cd
   Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ñ‚Ð°Ð¹Ð¼ÐµÑ€ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð°

ðŸ”¹ /reset_all
   Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð²ÑÐµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð³Ñ€Ñ‹

ðŸ”¹ /Ð°Ð´Ð¼Ð¸Ð½ [Ð½Ð¸Ðº]
   ÐÐ°Ð·Ð½Ð°Ñ‡Ð¸Ñ‚ÑŒ Ð¸Ð³Ñ€Ð¾ÐºÐ° Ð°Ð´Ð¼Ð¸Ð½Ð¾Ð¼ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº)

ðŸ”¹ /Ð´ÐµÐ»Ð°Ð´Ð¼Ð¸Ð½ [Ð½Ð¸Ðº]
   Ð¡Ð½ÑÑ‚ÑŒ Ð¸Ð³Ñ€Ð¾ÐºÐ° Ñ Ð°Ð´Ð¼Ð¸Ð½ÐºÐ¸ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº)

ðŸ”¹ 2604
   Ð’ÐµÑ€Ð½ÑƒÑ‚ÑŒÑÑ Ð² Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ (Ð´Ð»Ñ Ð²ÑÐµÑ…)
   
ðŸ”¹ /Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹_Ñ€ÑƒÐ±ÐµÐ¶
   ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ€ÐµÐ¶Ð¸Ð¼ Ñ Ð±Ð¾Ñ‚Ð¾Ð¼-Ð¿Ñ€Ð¾Ñ‚Ð¸Ð²Ð½Ð¸ÐºÐ¾Ð¼ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº)

ðŸ”¹ /Ð·Ð¾Ð¼Ð±Ð¸
   ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð±Ð¾Ñ‚Ð° Ð—Ð¾Ð¼Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ…

ðŸ”¹ /Ð·Ð¾Ð¼Ð±Ð¸_ÐºÐ´ [ÑÐµÐºÑƒÐ½Ð´Ñ‹]
   Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¸Ð½Ñ‚ÐµÑ€Ð²Ð°Ð» Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ Ð·Ð¾Ð¼Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ…
   ÐŸÑ€Ð¸Ð¼ÐµÑ€: /Ð·Ð¾Ð¼Ð±Ð¸_ÐºÐ´ 900 (15 Ð¼Ð¸Ð½ÑƒÑ‚)
   
ðŸ”¹ /Ñ€Ñ‹Ñ†Ð°Ñ€ÑŒ [Ð½Ð¸Ðº]
   Ð­ÐºÐ¸Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð³Ñ€Ð¾ÐºÐ° Ð»ÑƒÑ‡ÑˆÐ¸Ð¼ ÑÐ½Ð°Ñ€ÑÐ¶ÐµÐ½Ð¸ÐµÐ¼ Ð”Ð¾Ð»Ð³Ð° Ð¸ +500 ÑÐºÐ²Ð°Ð´Ð¾Ð²
   ÐŸÑ€Ð¸Ð¼ÐµÑ€: /Ñ€Ñ‹Ñ†Ð°Ñ€ÑŒ ÐÐ¸ÐºÐ˜Ð³Ñ€Ð¾ÐºÐ°

ðŸ”¹ /Ð·Ð¾Ð¼Ð±Ð¸_ÑÐ¸Ð»Ð° [+-Ñ‡Ð¸ÑÐ»Ð¾]
   Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ/ÑƒÐ±Ñ€Ð°Ñ‚ÑŒ Ð±Ð¾Ð½ÑƒÑÐ½Ñ‹Ðµ ÑÐºÐ²Ð°Ð´Ñ‹ Ð·Ð¾Ð¼Ð±Ð¸
   ÐŸÑ€Ð¸Ð¼ÐµÑ€: /Ð·Ð¾Ð¼Ð±Ð¸_ÑÐ¸Ð»Ð° +50"""
        send_message(user_id, admin_help, None, vk_session)
        return True
    if text.startswith("/Ð»Ð¸Ð¼Ð¸Ñ‚ ") and is_admin(user_id):
        parts = text_original.split()
        if len(parts) < 3:
            send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: /Ð»Ð¸Ð¼Ð¸Ñ‚ [Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ°] [Ñ‡Ð¸ÑÐ»Ð¾]\nÐ“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¸: Ð´Ð¾Ð»Ð³, Ð³Ñ€ÐµÑ…, Ð¾Ð´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸", None, vk_session)
            return True
        faction_input = parts[1].lower()
        try:
            new_limit = int(parts[2])
        except:
            send_message(user_id, "âŒ Ð›Ð¸Ð¼Ð¸Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ñ‡Ð¸ÑÐ»Ð¾Ð¼.", None, vk_session)
            return True
        if new_limit < 1 or new_limit > 50:
            send_message(user_id, "âŒ Ð›Ð¸Ð¼Ð¸Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ñ‚ 1 Ð´Ð¾ 50.", None, vk_session)
            return True
        faction_map = {"Ð´Ð¾Ð»Ð³": "ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³", "Ð³Ñ€ÐµÑ…": "â˜¦ï¸ Ð“Ñ€ÐµÑ…", "Ð¾Ð´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸"}
        if faction_input not in faction_map:
            send_message(user_id, "âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ°. Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾: Ð´Ð¾Ð»Ð³, Ð³Ñ€ÐµÑ…, Ð¾Ð´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸", None, vk_session)
            return True
        faction_name = faction_map[faction_input]
        MAX_FACTION_SIZES[faction_name] = new_limit
        save_data()
        send_message(user_id, f"âœ… Ð›Ð¸Ð¼Ð¸Ñ‚ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¸ {faction_name} Ð¸Ð·Ð¼ÐµÐ½Ñ‘Ð½ Ð½Ð° {new_limit}.", None, vk_session)
        return True
    if text.startswith("/ÑÐ¼ÐµÐ½Ð¸Ñ‚ÑŒÐ³Ð¿") and is_admin(user_id):
        parts = text_original.split()
        if len(parts) < 2:
            send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: /ÑÐ¼ÐµÐ½Ð¸Ñ‚ÑŒÐ³Ð¿ [Ð½Ð¸Ðº] [Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ°]\nÐ“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¸: Ð´Ð¾Ð»Ð³, Ð³Ñ€ÐµÑ…, Ð¾Ð´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸, Ð·Ð¾Ð¼Ð±Ð¸\nÐ˜Ð»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚ÑŒÑ‚Ðµ Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ: /ÑÐ¼ÐµÐ½Ð¸Ñ‚ÑŒÐ³Ð¿ [Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ°]", None, vk_session)
            return True
        faction_map = {"Ð´Ð¾Ð»Ð³": "ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³", "Ð³Ñ€ÐµÑ…": "â˜¦ï¸ Ð“Ñ€ÐµÑ…", "Ð¾Ð´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸", "Ð·Ð¾Ð¼Ð±Ð¸": ZOMBIE_FACTION, "Ð·Ð¾Ð¼Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ": ZOMBIE_FACTION}
        if reply_user_id and reply_user_id in players and len(parts) == 2:
            target_uid = reply_user_id
            faction_input = parts[1].lower()
        elif len(parts) >= 3:
            target_nick = " ".join(parts[1:-1])
            faction_input = parts[-1].lower()
            target_uid = find_player_by_mention_or_nickname(target_nick, vk_session)
        else:
            send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: /ÑÐ¼ÐµÐ½Ð¸Ñ‚ÑŒÐ³Ð¿ [Ð½Ð¸Ðº] [Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ°]", None, vk_session)
            return True
        if not target_uid:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session)
            return True
        if faction_input not in faction_map:
            send_message(user_id, "âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ°. Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾: Ð´Ð¾Ð»Ð³, Ð³Ñ€ÐµÑ…, Ð¾Ð´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸, Ð·Ð¾Ð¼Ð±Ð¸", None, vk_session)
            return True
        new_faction = faction_map[faction_input]
        old_faction = players[target_uid].get("faction")
        if old_faction and target_uid in factions.get(old_faction, []):
            factions[old_faction].remove(target_uid)
        players[target_uid]["faction"] = new_faction
        if new_faction not in factions:
            factions[new_faction] = []
        if target_uid not in factions[new_faction]:
            factions[new_faction].append(target_uid)
        save_data()
        send_message(user_id, f"âœ… Ð˜Ð³Ñ€Ð¾Ðº {players[target_uid]['nickname']} Ð¿ÐµÑ€ÐµÐ²ÐµÐ´Ñ‘Ð½ Ð² {new_faction}.", None, vk_session)
        send_message(target_uid, f"âš ï¸ Ð’Ð°Ñ Ð¿ÐµÑ€ÐµÐ²ÐµÐ»Ð¸ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÑƒ {new_faction}!", None, vk_session)
        return True
    if text.startswith("/Ñ‚ÐµÐ»ÐµÐ¿Ð¾Ñ€Ñ‚ ") and is_admin(user_id):
        parts = text_original.split()
        if len(parts) < 4:
            send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: /Ñ‚ÐµÐ»ÐµÐ¿Ð¾Ñ€Ñ‚ [Ð½Ð¸Ðº] [Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ] [Ñ‚Ð¾Ñ‡ÐºÐ°]\nÐ›Ð¾ÐºÐ°Ñ†Ð¸Ð¸: ÐšÐ¾Ñ€Ð´Ð¾Ð½, Ð¡Ð²Ð°Ð»ÐºÐ°, Ñ‚Ð´ (Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°), ÐŸÐ¾Ð»ÑÐ½Ð°", None, vk_session)
            return True
        target_nick = parts[1]
        point = parts[-1].upper()
        location_parts = parts[2:-1]
        location_input = " ".join(location_parts).lower()
        target_uid = find_player_by_mention_or_nickname(target_nick, vk_session)
        if not target_uid:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session)
            return True
        location_map = {
            "ÐºÐ¾Ñ€Ð´Ð¾Ð½": "ÐšÐ¾Ñ€Ð´Ð¾Ð½",
            "ÑÐ²Ð°Ð»ÐºÐ°": "Ð¡Ð²Ð°Ð»ÐºÐ°",
            "Ñ‚Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°": "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°",
            "Ñ‚ÐµÐ¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°": "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°",
            "Ñ‚Ð´": "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°",
            "Ð¿Ð¾Ð»ÑÐ½Ð°": "ÐŸÐ¾Ð»ÑÐ½Ð°"
        }
        location = location_map.get(location_input)
        if not location:
            send_message(user_id, "âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ.\nÐ”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾: ÐšÐ¾Ñ€Ð´Ð¾Ð½, Ð¡Ð²Ð°Ð»ÐºÐ°, Ñ‚Ð´ (Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°), ÐŸÐ¾Ð»ÑÐ½Ð°", None, vk_session)
            return True
        if not is_valid_point(location, point):
            send_message(user_id, f"âŒ Ð¢Ð¾Ñ‡ÐºÐ° {point} Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð½Ð° Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸ {location}.", None, vk_session)
            return True
        players[target_uid]["location"] = location
        players[target_uid]["point"] = point
        players[target_uid]["transition_end_time"] = None
        if players[target_uid].get("state") == STATE_TRANSITION_WAIT:
            players[target_uid]["state"] = STATE_IN_MENU
        save_data()
        send_message(user_id, f"âœ… Ð˜Ð³Ñ€Ð¾Ðº {target_nick} Ñ‚ÐµÐ»ÐµÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð½Ð° {location} {point}.", None, vk_session)
        send_message(target_uid, f"âš¡ Ð’Ð°Ñ Ñ‚ÐµÐ»ÐµÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð»Ð¸ Ð½Ð° {location} {point}!", None, vk_session)
        return True
    if text.startswith("/Ð½Ð¸Ðº ") and user_id == 353430025:
        content = text_original[5:].strip()
        if " > " in content:
            parts = content.split(" > ", 1)
            old_nick = parts[0].strip()
            new_nick = parts[1].strip()
            target_uid = None
            for uid, data in players.items():
                if data.get("nickname", "").lower() == old_nick.lower():
                    target_uid = uid
                    break
            if not target_uid:
                for uid, data in players.items():
                    if old_nick.lower() in data.get("nickname", "").lower():
                        target_uid = uid
                        break
            if not target_uid:
                all_nicks = [f"'{p.get('nickname', '?')}'" for p in players.values() if p.get('nickname')]
                send_message(user_id, f"âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.\n\nðŸ“‹ ÐÐ¸ÐºÐ¸: {', '.join(all_nicks[:10])}", None, vk_session)
                return True
            old_nickname = players[target_uid]["nickname"]
            players[target_uid]["nickname"] = new_nick
            save_data()
            send_message(user_id, f"âœ… ÐÐ¸Ðº Ð¸Ð·Ð¼ÐµÐ½Ñ‘Ð½:\n{old_nickname} â†’ {new_nick}", None, vk_session)
            send_message(target_uid, f"ðŸ“ Ð’Ð°Ñˆ Ð½Ð¸Ðº Ð¸Ð·Ð¼ÐµÐ½Ñ‘Ð½ Ð½Ð°: {new_nick}", None, vk_session)
            return True
        if reply_user_id and reply_user_id in players:
            new_nick = content
            if not new_nick:
                send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð½Ð¾Ð²Ñ‹Ð¹ Ð½Ð¸Ðº", None, vk_session)
                return True
            old_nickname = players[reply_user_id]["nickname"]
            players[reply_user_id]["nickname"] = new_nick
            save_data()
            send_message(user_id, f"âœ… ÐÐ¸Ðº Ð¸Ð·Ð¼ÐµÐ½Ñ‘Ð½:\n{old_nickname} â†’ {new_nick}", None, vk_session)
            send_message(reply_user_id, f"ðŸ“ Ð’Ð°Ñˆ Ð½Ð¸Ðº Ð¸Ð·Ð¼ÐµÐ½Ñ‘Ð½ Ð½Ð°: {new_nick}", None, vk_session)
            return True
        send_message(user_id, "âŒ ÐžÑ‚Ð²ÐµÑ‚ÑŒÑ‚Ðµ Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¸Ð³Ñ€Ð¾ÐºÐ° Ð¸Ð»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ:\n/Ð½Ð¸Ðº ÑÑ‚Ð°Ñ€Ñ‹Ð¹ > Ð½Ð¾Ð²Ñ‹Ð¹", None, vk_session)
        return True
    if text.lower() == "Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ":
        send_message(user_id, GAME_INFO_TEXT, None, vk_session)
        return True
    if text.startswith("/Ð±Ð°Ð½ ") and is_admin(user_id):
        content = text_original[5:].strip()
        if not content:
            send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð½Ð¸Ðº Ð¸Ð³Ñ€Ð¾ÐºÐ°.\nÐ¤Ð¾Ñ€Ð¼Ð°Ñ‚: /Ð±Ð°Ð½ [Ð½Ð¸Ðº] [Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ð°]", None, vk_session)
            return True
        parts = content.split(maxsplit=1)
        target_nick = parts[0]
        reason = parts[1] if len(parts) > 1 else "ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð° Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°"
        target_uid = find_player_by_mention_or_nickname(target_nick, vk_session)
        if not target_uid:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session)
            return True
        if target_uid == user_id:
            send_message(user_id, "âŒ ÐÐµÐ»ÑŒÐ·Ñ Ð·Ð°Ð±Ð°Ð½Ð¸Ñ‚ÑŒ ÑÐµÐ±Ñ.", None, vk_session)
            return True
        if target_uid == 353430025:
            send_message(user_id, "âŒ ÐÐµÐ»ÑŒÐ·Ñ Ð·Ð°Ð±Ð°Ð½Ð¸Ñ‚ÑŒ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ°.", None, vk_session)
            return True
        if target_uid in banned_users:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº ÑƒÐ¶Ðµ Ð·Ð°Ð±Ð°Ð½ÐµÐ½.", None, vk_session)
            return True
        target_faction = players[target_uid].get("faction")
        if target_faction and target_uid in factions.get(target_faction, []):
            factions[target_faction].remove(target_uid)
        banned_users[target_uid] = reason
        save_data()
        send_message(user_id, f"âœ… Ð˜Ð³Ñ€Ð¾Ðº {players[target_uid]['nickname']} Ð·Ð°Ð±Ð°Ð½ÐµÐ½.\nðŸ“ ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°: {reason}", None, vk_session)
        send_message(target_uid, f"ðŸš« Ð’Ñ‹ Ð±Ñ‹Ð»Ð¸ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ð² Ð¸Ð³Ñ€Ðµ.\nðŸ“ ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°: {reason}", None, vk_session)
        return True
    if text.startswith("/Ñ€Ð°Ð·Ð±Ð°Ð½ ") and is_admin(user_id):
        target_nick = text_original[8:].strip()
        if not target_nick:
            send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð½Ð¸Ðº Ð¸Ð³Ñ€Ð¾ÐºÐ°.", None, vk_session)
            return True
        target_uid = find_player_by_mention_or_nickname(target_nick, vk_session)
        if not target_uid:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session)
            return True
        if target_uid not in banned_users:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð·Ð°Ð±Ð°Ð½ÐµÐ½.", None, vk_session)
            return True
        del banned_users[target_uid]
        save_data()
        send_message(user_id, f"âœ… Ð˜Ð³Ñ€Ð¾Ðº {players[target_uid]['nickname']} Ñ€Ð°Ð·Ð±Ð°Ð½ÐµÐ½.", None, vk_session)
        send_message(target_uid, "âœ… Ð’Ñ‹ Ð±Ñ‹Ð»Ð¸ Ñ€Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ð² Ð¸Ð³Ñ€Ðµ.", None, vk_session)
        return True
    if text.startswith("/Ð°Ð´Ð¼Ð¸Ð½ ") and user_id == 353430025:
        target_nick = text_original[7:].strip()
        if not target_nick:
            send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð½Ð¸Ðº Ð¸Ð³Ñ€Ð¾ÐºÐ°.", None, vk_session)
            return True
        target_uid = find_player_by_mention_or_nickname(target_nick, vk_session)
        if not target_uid:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session)
            return True
        if target_uid == user_id:
            send_message(user_id, "âŒ Ð’Ñ‹ ÑƒÐ¶Ðµ Ð³Ð»Ð°Ð²Ð½Ñ‹Ð¹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº.", None, vk_session)
            return True
        if target_uid in admin_users:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº ÑƒÐ¶Ðµ Ð°Ð´Ð¼Ð¸Ð½.", None, vk_session)
            return True
        admin_users.append(target_uid)
        save_data()
        send_message(user_id, f"âœ… Ð˜Ð³Ñ€Ð¾Ðº {players[target_uid]['nickname']} Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½ Ð°Ð´Ð¼Ð¸Ð½Ð¾Ð¼.", None, vk_session)
        send_message(target_uid, "ðŸ‘‘ Ð’Ñ‹ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ñ‹ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼ Ð±Ð¾Ñ‚Ð°!", None, vk_session)
        return True
    if text.startswith("/Ð´ÐµÐ»Ð°Ð´Ð¼Ð¸Ð½ ") and user_id == 353430025:
        target_nick = text_original[10:].strip()
        if not target_nick:
            send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð½Ð¸Ðº Ð¸Ð³Ñ€Ð¾ÐºÐ°.", None, vk_session)
            return True
        target_uid = find_player_by_mention_or_nickname(target_nick, vk_session)
        if not target_uid:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session)
            return True
        if target_uid not in admin_users:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð°Ð´Ð¼Ð¸Ð½Ð¾Ð¼.", None, vk_session)
            return True
        admin_users.remove(target_uid)
        save_data()
        send_message(user_id, f"âœ… Ð˜Ð³Ñ€Ð¾Ðº {players[target_uid]['nickname']} ÑÐ½ÑÑ‚ Ñ Ð°Ð´Ð¼Ð¸Ð½ÐºÐ¸.", None, vk_session)
        send_message(target_uid, "âš ï¸ Ð’Ñ‹ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð½Ðµ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€ Ð±Ð¾Ñ‚Ð°.", None, vk_session)
        return True
    if text == "/Ð¸Ð½Ð²" or text == "Ð¸Ð½Ð²":
        p = players[user_id]
        backpack = p.get("backpack", {})
        money = p.get("money", 0)
        if not backpack or all(v <= 0 for v in backpack.values()):
            items_str = "ÐŸÑƒÑÑ‚Ð¾"
        else:
            items_list = []
            for item, count in backpack.items():
                if count > 0:
                    items_list.append(f"â€¢ {item}: {count}")
            items_str = "\n".join(items_list)
        msg = f"ðŸŽ’ Ð˜Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€ÑŒ Ð¸Ð³Ñ€Ð¾ÐºÐ° {p.get('nickname', 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹')}:\n\n{items_str}\n\nðŸ’² Ð”ÐµÐ½ÑŒÐ³Ð¸: {money}Ñ€"
        send_message(user_id, msg, None, vk_session)
        return True
    if text == "/ÑÐ¾Ð½" or text == "ÑÐ¾Ð½":
        p = players[user_id]
        if p.get("state") != STATE_RESTING:
            send_message(user_id, "âŒ Ð’Ñ‹ Ð½Ðµ Ð¾Ñ‚Ð´Ñ‹Ñ…Ð°ÐµÑ‚Ðµ.", None, vk_session)
            return True
        start_time = p.get("rest_start_time")
        if not start_time:
            send_message(user_id, "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð²Ñ€ÐµÐ¼Ñ Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¾Ñ‚Ð´Ñ‹Ñ…Ð° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾.", None, vk_session)
            return True
        current_time = time.time()
        elapsed = current_time - start_time
        initial = p.get("initial_stamina", p["stamina"])
        belt_bonus = apply_belt_effects_on_rest(user_id)
        donation_bonus = 1 if has_active_donation(user_id) else 0
        total_bonus = 1 + belt_bonus + donation_bonus
        elapsed_intervals = int(elapsed // 360)
        current_stamina = min(10, initial + elapsed_intervals * total_bonus)
        seconds_in_current_interval = elapsed % 360
        seconds_to_next = int(360 - seconds_in_current_interval)
        next_mins = seconds_to_next // 60
        next_secs = seconds_to_next % 60
        if current_stamina >= 10:
            total_remaining = 0
        else:
            stamina_after_next = min(10, current_stamina + total_bonus)
            if stamina_after_next >= 10:
                total_remaining = seconds_to_next
            else:
                remaining_after_next = 10 - stamina_after_next
                intervals_after_next = int(remaining_after_next / total_bonus)
                if remaining_after_next % total_bonus > 0:
                    intervals_after_next += 1
                total_remaining = seconds_to_next + intervals_after_next * 360
        total_mins = total_remaining // 60
        total_secs = total_remaining % 60
        msg = f"ðŸ˜´ Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¾Ñ‚Ð´Ñ‹Ñ…Ð°:\n"
        msg += f"âš¡ Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ: {current_stamina}/10\n"
        msg += f"ðŸ”‹ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð° 6 Ð¼Ð¸Ð½: +{total_bonus}\n"
        msg += f"â±ï¸ Ð”Ð¾ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ: {next_mins} Ð¼Ð¸Ð½ {next_secs} ÑÐµÐº\n"
        msg += f"â±ï¸ Ð”Ð¾ Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ: {total_mins} Ð¼Ð¸Ð½ {total_secs} ÑÐµÐº"
        send_message(user_id, msg, None, vk_session)
        return True
    if text == "/Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹_Ñ€ÑƒÐ±ÐµÐ¶" and user_id == 353430025:
        init_last_stand_mode()
        for uid in players:
            if uid in banned_users:
                continue
            faction = players[uid].get("faction")
            if faction and faction != ZOMBIE_FACTION:
                send_message(uid, "ðŸ§Ÿ Ð Ð•Ð–Ð˜Ðœ ÐŸÐžÐ¡Ð›Ð•Ð”ÐÐ˜Ð™ Ð Ð£Ð‘Ð•Ð– ÐÐšÐ¢Ð˜Ð’Ð˜Ð ÐžÐ’ÐÐ!\n\nâš ï¸ Ð’ÑÐµ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ñ‹ Ð½Ð° ÐšÐ¾Ñ€Ð´Ð¾Ð½!\nðŸ§Ÿ Ð—Ð¾Ð¼Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð·Ð°Ñ…Ð²Ð°Ñ‚Ð¸Ð»Ð¸ Ð¡Ð²Ð°Ð»ÐºÑƒ, ÐŸÐ¾Ð»ÑÐ½Ñƒ Ð¸ Ð¢Ñ‘Ð¼Ð½ÑƒÑŽ Ð´Ð¾Ð»Ð¸Ð½Ñƒ!\n\nâš”ï¸ ÐžÐ±ÑŠÐµÐ´Ð¸Ð½Ð¸Ñ‚ÐµÑÑŒ Ð´Ð»Ñ Ð²Ñ‹Ð¶Ð¸Ð²Ð°Ð½Ð¸Ñ!", None, vk_session)
        try:
            vk_session.method("messages.send", {"peer_id": GAME_CHAT_ID, "message": "ðŸ§Ÿ Ð Ð•Ð–Ð˜Ðœ ÐŸÐžÐ¡Ð›Ð•Ð”ÐÐ˜Ð™ Ð Ð£Ð‘Ð•Ð– ÐÐšÐ¢Ð˜Ð’Ð˜Ð ÐžÐ’ÐÐ!\n\nÐ—Ð¾Ð¼Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð°Ñ‚Ð°ÐºÑƒÑŽÑ‚ Ð—Ð¾Ð½Ñƒ!", "random_id": 0})
        except:
            pass
        send_message(user_id, "âœ… Ð ÐµÐ¶Ð¸Ð¼ ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð ÑƒÐ±ÐµÐ¶ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½!", None, vk_session)
        return True
    if text == "/Ð·Ð¾Ð¼Ð±Ð¸" and is_admin(user_id):
        if not LAST_STAND_MODE:
            send_message(user_id, "âŒ Ð ÐµÐ¶Ð¸Ð¼ ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð ÑƒÐ±ÐµÐ¶ Ð½Ðµ Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½.", None, vk_session)
            return True
        send_message(user_id, get_zombie_status(), None, vk_session)
        return True
    if text.startswith("/Ð·Ð¾Ð¼Ð±Ð¸_ÐºÐ´") and is_admin(user_id):
        global ZOMBIE_ACTION_INTERVAL
        parts = text.split()
        if len(parts) >= 2:
            try:
                new_interval = int(parts[1])
                if new_interval < 60 or new_interval > 7200:
                    send_message(user_id, "âŒ Ð˜Ð½Ñ‚ÐµÑ€Ð²Ð°Ð» Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ñ‚ 60 Ð´Ð¾ 7200 ÑÐµÐºÑƒÐ½Ð´.", None, vk_session)
                    return True
                ZOMBIE_ACTION_INTERVAL = new_interval
                save_data()
                mins = new_interval // 60
                secs = new_interval % 60
                send_message(user_id, f"âœ… Ð˜Ð½Ñ‚ÐµÑ€Ð²Ð°Ð» Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ Ð·Ð¾Ð¼Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ…: {mins} Ð¼Ð¸Ð½ {secs} ÑÐµÐº.", None, vk_session)
            except:
                send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ñ‡Ð¸ÑÐ»Ð¾ ÑÐµÐºÑƒÐ½Ð´. ÐŸÑ€Ð¸Ð¼ÐµÑ€: /Ð·Ð¾Ð¼Ð±Ð¸_ÐºÐ´ 900", None, vk_session)
            return True
        else:
            mins = ZOMBIE_ACTION_INTERVAL // 60
            secs = ZOMBIE_ACTION_INTERVAL % 60
            send_message(user_id, f"â±ï¸ Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¸Ð½Ñ‚ÐµÑ€Ð²Ð°Ð»: {mins} Ð¼Ð¸Ð½ {secs} ÑÐµÐº.\nÐ˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ: /Ð·Ð¾Ð¼Ð±Ð¸_ÐºÐ´ [ÑÐµÐºÑƒÐ½Ð´Ñ‹]", None, vk_session)
            return True
    if text == "/Ð·Ð¾Ð¼Ð±Ð¸_Ñ†ÐµÐ»ÑŒ":
        if not LAST_STAND_MODE:
            send_message(user_id, "âŒ Ð ÐµÐ¶Ð¸Ð¼ ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð ÑƒÐ±ÐµÐ¶ Ð½Ðµ Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½.", None, vk_session)
            return True
        if players[user_id].get("faction") != ZOMBIE_FACTION:
            send_message(user_id, "âŒ Ð’Ñ‹ Ð½Ðµ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐµ Ð—Ð¾Ð¼Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ….", None, vk_session)
            return True
        leader = get_faction_leader(ZOMBIE_FACTION)
        if leader != user_id and not is_admin(user_id):
            send_message(user_id, "âŒ Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð»Ð¸Ð´ÐµÑ€ Ð·Ð¾Ð¼Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ð¼Ð¾Ð¶ÐµÑ‚ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ Ð±Ð¾Ñ‚Ð¾Ð¼.", None, vk_session)
            return True
        mode = zombie_bot.get("mode", "normal")
        priority = zombie_bot.get("priority_target")
        msg = f"ðŸ§Ÿ Ð£ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð• Ð—ÐžÐœÐ‘Ð˜Ð ÐžÐ’ÐÐÐÐ«ÐœÐ˜\n\nðŸŽ¯ Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼: {mode}\nðŸŽ¯ ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ð½Ð°Ñ Ñ†ÐµÐ»ÑŒ: {priority if priority else 'Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°'}\n\nÐ’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ€ÐµÐ¶Ð¸Ð¼ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð±Ð¾Ñ‚Ð°:"
        players[user_id]["state"] = "zombie_control"
        save_data()
        send_message(user_id, msg, create_zombie_control_keyboard(), vk_session)
        return True
    if text.startswith("/Ð·Ð¾Ð¼Ð±Ð¸_Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ ") and is_admin(user_id):
        if not LAST_STAND_MODE:
            send_message(user_id, "âŒ Ð ÐµÐ¶Ð¸Ð¼ ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð ÑƒÐ±ÐµÐ¶ Ð½Ðµ Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½.", None, vk_session)
            return True
        parts = text.split()
        if len(parts) < 3:
            send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: /Ð·Ð¾Ð¼Ð±Ð¸_Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ [Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ] [Ñ‚Ð¾Ñ‡ÐºÐ°]\nÐŸÑ€Ð¸Ð¼ÐµÑ€: /Ð·Ð¾Ð¼Ð±Ð¸_Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ ÐšÐ¾Ñ€Ð´Ð¾Ð½ Ð‘1", None, vk_session)
            return True
        point = parts[-1].upper()
        loc_input = " ".join(parts[1:-1]).lower()
        location_map = {"ÐºÐ¾Ñ€Ð´Ð¾Ð½": "ÐšÐ¾Ñ€Ð´Ð¾Ð½", "ÑÐ²Ð°Ð»ÐºÐ°": "Ð¡Ð²Ð°Ð»ÐºÐ°", "Ñ‚Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°": "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ñ‚ÐµÐ¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°": "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ñ‚Ð´": "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ð¿Ð¾Ð»ÑÐ½Ð°": "ÐŸÐ¾Ð»ÑÐ½Ð°"}
        location = location_map.get(loc_input)
        if not location:
            send_message(user_id, "âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ.", None, vk_session)
            return True
        if not is_valid_point(location, point):
            send_message(user_id, f"âŒ Ð¢Ð¾Ñ‡ÐºÐ° {point} Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð½Ð° {location}.", None, vk_session)
            return True
        zombie_bot["priority_target"] = (location, point)
        save_data()
        send_message(user_id, f"âœ… ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ð½Ð°Ñ Ñ†ÐµÐ»ÑŒ: {location} {point}", None, vk_session)
        return True
    if text == "/Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹_Ñ€ÑƒÐ±ÐµÐ¶2" and user_id == 353430025:
        init_last_stand_mode_v2()
        for uid in players:
            if uid in banned_users:
                continue
            faction = players[uid].get("faction")
            if faction and faction != ZOMBIE_FACTION:
                send_message(uid, "ðŸ§Ÿ Ð Ð•Ð–Ð˜Ðœ ÐŸÐžÐ¡Ð›Ð•Ð”ÐÐ˜Ð™ Ð Ð£Ð‘Ð•Ð– v2 ÐÐšÐ¢Ð˜Ð’Ð˜Ð ÐžÐ’ÐÐ!\n\nâš ï¸ Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¸ Ð½Ð° ÑÐ²Ð¾Ð¸Ñ… Ð±Ð°Ð·Ð°Ñ…!\nðŸ§Ÿ Ð—Ð¾Ð¼Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð·Ð°Ñ…Ð²Ð°Ñ‚Ð¸Ð»Ð¸ ÐŸÐ¾Ð»ÑÐ½Ñƒ Ñ ÑÐ¸Ð»Ð¾Ð¹ 100!\n\nâš”ï¸ ÐžÐ±ÑŠÐµÐ´Ð¸Ð½Ð¸Ñ‚ÐµÑÑŒ Ð´Ð»Ñ Ð²Ñ‹Ð¶Ð¸Ð²Ð°Ð½Ð¸Ñ!", None, vk_session)
        try:
            vk_session.method("messages.send", {"peer_id": GAME_CHAT_ID, "message": "ðŸ§Ÿ Ð Ð•Ð–Ð˜Ðœ ÐŸÐžÐ¡Ð›Ð•Ð”ÐÐ˜Ð™ Ð Ð£Ð‘Ð•Ð– v2!\n\nÐ—Ð¾Ð¼Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð½Ð° ÐŸÐ¾Ð»ÑÐ½Ðµ Ñ ÑÐ¸Ð»Ð¾Ð¹ 100!", "random_id": 0})
        except:
            pass
        send_message(user_id, "âœ… Ð ÐµÐ¶Ð¸Ð¼ ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð ÑƒÐ±ÐµÐ¶ v2 Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½!", None, vk_session)
        return True
    if text.startswith("/Ð·Ð¾Ð¼Ð±Ð¸_ÑÐ¸Ð»Ð°") and is_admin(user_id):
        if not LAST_STAND_MODE:
            send_message(user_id, "âŒ Ð ÐµÐ¶Ð¸Ð¼ ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð ÑƒÐ±ÐµÐ¶ Ð½Ðµ Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½.", None, vk_session)
            return True
        parts = text.split()
        if len(parts) < 2:
            current = zombie_bot.get("bonus_squads", 0)
            send_message(user_id, f"ðŸ‘¨â€ðŸ‘¨â€ðŸ‘¦â€ðŸ‘¦ Ð‘Ð¾Ð½ÑƒÑÐ½Ñ‹Ðµ ÑÐºÐ²Ð°Ð´Ñ‹ Ð·Ð¾Ð¼Ð±Ð¸: {current}\n\nÐ˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ: /Ð·Ð¾Ð¼Ð±Ð¸_ÑÐ¸Ð»Ð° +50 Ð¸Ð»Ð¸ /Ð·Ð¾Ð¼Ð±Ð¸_ÑÐ¸Ð»Ð° -20", None, vk_session)
            return True
        try:
            value = int(parts[1])
            zombie_bot["bonus_squads"] = zombie_bot.get("bonus_squads", 0) + value
            zombie_bot["squads"] = zombie_bot.get("squads", 0) + value
            if zombie_bot["squads"] < 0:
                zombie_bot["squads"] = 0
            if zombie_bot["bonus_squads"] < 0:
                zombie_bot["bonus_squads"] = 0
            save_data()
            send_message(user_id, f"âœ… Ð¡ÐºÐ²Ð°Ð´Ñ‹ Ð·Ð¾Ð¼Ð±Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ñ‹ Ð½Ð° {value}.\nÐ¢ÐµÐºÑƒÑ‰Ð¸Ðµ ÑÐºÐ²Ð°Ð´Ñ‹: {zombie_bot['squads']}\nÐ‘Ð¾Ð½ÑƒÑ: {zombie_bot['bonus_squads']}", None, vk_session)
        except:
            send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ñ‡Ð¸ÑÐ»Ð¾. ÐŸÑ€Ð¸Ð¼ÐµÑ€: /Ð·Ð¾Ð¼Ð±Ð¸_ÑÐ¸Ð»Ð° +50", None, vk_session)
        return True
    if text.startswith("/Ñ€Ñ‹Ñ†Ð°Ñ€ÑŒ") and is_admin(user_id):
        parts = text_original.split()
        if len(parts) >= 2:
            target_nick = " ".join(parts[1:])
            target_uid = find_player_by_mention_or_nickname(target_nick, vk_session)
            if not target_uid:
                send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session)
                return True
        elif reply_user_id and reply_user_id in players:
            target_uid = reply_user_id
        else:
            target_uid = user_id
        p = players[target_uid]
        p["weapon"] = "Ð“Ñ€Ð¾Ð¼ Ð¡14"
        p["weapon_durability"] = 4
        p["weapon_max_durability"] = 4
        p["weapon_damage"] = 4.5
        p["weapon_accuracy"] = 3
        p["armor"] = "Ð­ÐºÐ·Ð¾ÑÐºÐµÐ»ÐµÑ‚ Â«Ð”Ð¾Ð»Ð³Ð°Â»"
        p["armor_durability"] = 7
        p["armor_max_durability"] = 7
        p["bullet_resist"] = 4
        p["blast_resist"] = 5
        p["anomaly_resist"] = 1
        p["detector"] = "Ð¡Ð²Ð°Ñ€Ð¾Ð³"
        p["detector_charge"] = 24
        p["detector_max_charge"] = 24
        p["squads"] = p.get("squads", 0) + 500
        p["health"] = 10
        p["radiation"] = 0
        p["hunger"] = 0
        p["stamina"] = 10
        save_data()
        target_name = players[target_uid]["nickname"]
        send_message(user_id, f"âš”ï¸ {target_name} ÑÐºÐ¸Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½ ÐºÐ°Ðº Ð Ñ‹Ñ†Ð°Ñ€ÑŒ Ð”Ð¾Ð»Ð³Ð°!\n\nðŸ”« Ð“Ñ€Ð¾Ð¼ Ð¡14\nðŸ¦º Ð­ÐºÐ·Ð¾ÑÐºÐµÐ»ÐµÑ‚ Â«Ð”Ð¾Ð»Ð³Ð°Â»\nðŸ“Ÿ Ð¡Ð²Ð°Ñ€Ð¾Ð³\nðŸ‘¨â€ðŸ‘¨â€ðŸ‘¦â€ðŸ‘¦ +500 ÑÐºÐ²Ð°Ð´Ð¾Ð²\nâ¤ï¸ ÐŸÐ¾Ð»Ð½Ð¾Ðµ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ", None, vk_session)
        if target_uid != user_id:
            send_message(target_uid, "âš”ï¸ Ð’Ñ‹ ÑÐºÐ¸Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ ÐºÐ°Ðº Ð Ñ‹Ñ†Ð°Ñ€ÑŒ Ð”Ð¾Ð»Ð³Ð°!\n\nðŸ”« Ð“Ñ€Ð¾Ð¼ Ð¡14\nðŸ¦º Ð­ÐºÐ·Ð¾ÑÐºÐµÐ»ÐµÑ‚ Â«Ð”Ð¾Ð»Ð³Ð°Â»\nðŸ“Ÿ Ð¡Ð²Ð°Ñ€Ð¾Ð³\nðŸ‘¨â€ðŸ‘¨â€ðŸ‘¦â€ðŸ‘¦ +500 ÑÐºÐ²Ð°Ð´Ð¾Ð²", None, vk_session)
        return True
    return False
def generate_inventory_image(user_id):
    p = players[user_id]
    backpack = p.get("backpack", {})
    CELL_SIZE = 50
    INV_COLS = 6
    INV_ROWS = 10
    LEFT_PANEL_WIDTH = 210
    INV_WIDTH = INV_COLS * CELL_SIZE + 15
    width = LEFT_PANEL_WIDTH + INV_WIDTH + 5
    height = INV_ROWS * CELL_SIZE + 40
    try:
        bg = Image.open("backgrounds/inventory_bg.png").convert("RGBA").resize((width, height))
    except:
        bg = Image.new("RGBA", (width, height), (20, 25, 20, 255))
    img = bg.copy()
    draw = ImageDraw.Draw(img)
    try:
        font = ImageFont.truetype("Graffiti1C.ttf", 16)
        font_small = ImageFont.truetype("Graffiti1C.ttf", 12)
        font_title = ImageFont.truetype("Graffiti1C.ttf", 18)
    except:
        try:
            font = ImageFont.truetype("arial.ttf", 16)
            font_small = ImageFont.truetype("arial.ttf", 12)
            font_title = ImageFont.truetype("arial.ttf", 18)
        except:
            font = ImageFont.load_default()
            font_small = font
            font_title = font
    COLOR_FRAME = (70, 80, 60, 255)
    COLOR_FRAME_LIGHT = (100, 110, 85, 255)
    COLOR_SLOT_EMPTY = (40, 45, 40, 180)
    COLOR_HEALTH = (200, 60, 60, 255)
    COLOR_RADIATION = (80, 200, 80, 255)
    COLOR_HUNGER = (200, 170, 60, 255)
    COLOR_STAMINA = (80, 160, 200, 255)
    all_icons = {**ITEM_ICONS, **ARTIFACT_ICONS}
    def draw_text_with_outline(x, y, text, font_used, fill=(255, 255, 255)):
        for dx, dy in [(-1, 0), (1, 0), (0, -1), (0, 1), (-1, -1), (1, 1), (-1, 1), (1, -1)]:
            draw.text((x + dx, y + dy), text, fill=(0, 0, 0), font=font_used)
        draw.text((x, y), text, fill=fill, font=font_used)
    def draw_stalker_frame(x, y, w, h, title=None):
        draw.rectangle([x, y, x + w, y + h], fill=(30, 35, 30, 200), outline=COLOR_FRAME, width=2)
        draw.line([(x, y), (x + 8, y)], fill=COLOR_FRAME_LIGHT, width=2)
        draw.line([(x, y), (x, y + 8)], fill=COLOR_FRAME_LIGHT, width=2)
        draw.line([(x + w - 8, y), (x + w, y)], fill=COLOR_FRAME_LIGHT, width=2)
        draw.line([(x + w, y), (x + w, y + 8)], fill=COLOR_FRAME_LIGHT, width=2)
        draw.line([(x, y + h - 8), (x, y + h)], fill=COLOR_FRAME_LIGHT, width=2)
        draw.line([(x, y + h), (x + 8, y + h)], fill=COLOR_FRAME_LIGHT, width=2)
        draw.line([(x + w, y + h - 8), (x + w, y + h)], fill=COLOR_FRAME_LIGHT, width=2)
        draw.line([(x + w - 8, y + h), (x + w, y + h)], fill=COLOR_FRAME_LIGHT, width=2)
        if title:
            draw_text_with_outline(x + 5, y + 3, title, font_small)
    def draw_bar_stalker(x, y, w, h, value, max_val, color, label_icon):
        draw.rectangle([x, y, x + w, y + h], fill=(20, 25, 20, 255), outline=COLOR_FRAME, width=1)
        if max_val > 0:
            fill_w = int((value / max_val) * (w - 4))
            if fill_w > 0:
                for i in range(fill_w):
                    draw.line([(x + 2 + i, y + 2), (x + 2 + i, y + h - 2)], fill=color, width=1)
        draw_text_with_outline(x + w + 5, y - 2, f"{label_icon}{value}/{max_val}", font)
    panel_x = 5
    panel_y = 5
    avatar_size = int(CELL_SIZE * 2 / 1.5)
    avatar_x = panel_x + 3
    avatar_y = panel_y + 3
    draw.rectangle([avatar_x - 2, avatar_y - 2, avatar_x + avatar_size + 2, avatar_y + avatar_size + 2], outline=COLOR_FRAME, width=2)
    avatar_path = os.path.join(AVATAR_DIR, f"{user_id}.png")
    if os.path.exists(avatar_path):
        try:
            avatar = Image.open(avatar_path).convert("RGBA").resize((avatar_size, avatar_size))
            img.paste(avatar, (avatar_x, avatar_y), avatar)
        except:
            draw.rectangle([avatar_x, avatar_y, avatar_x + avatar_size, avatar_y + avatar_size], fill=COLOR_SLOT_EMPTY)
    else:
        draw.rectangle([avatar_x, avatar_y, avatar_x + avatar_size, avatar_y + avatar_size], fill=COLOR_SLOT_EMPTY)
    info_x = avatar_x + avatar_size + 10
    info_y = avatar_y
    draw_text_with_outline(info_x, info_y, f"{p['nickname']}", font_title)
    info_y += 22
    faction = p.get("faction", "")
    faction_icon_path = FACTION_ICONS.get(faction)
    faction_icon_size = 18
    if faction_icon_path and os.path.exists(faction_icon_path):
        try:
            faction_icon = Image.open(faction_icon_path).convert("RGBA").resize((faction_icon_size, faction_icon_size))
            img.paste(faction_icon, (info_x, info_y), faction_icon)
        except:
            pass
    faction_clean = faction.replace("ðŸ›¡ï¸ ", "").replace("â˜¦ï¸ ", "").replace("â˜¢ï¸ ", "")
    draw_text_with_outline(info_x + faction_icon_size + 5, info_y, f"{faction_clean}", font)
    info_y += 22
    location = p.get("location", "Ð›Ð°Ð³ÐµÑ€ÑŒ")
    point = p.get("point", "Ð‘1")
    draw_text_with_outline(info_x, info_y, f"{location} {point}", font)
    info_y += 20
    money = p.get("money", 0)
    draw_text_with_outline(info_x, info_y, f"$ {money} RU", font)
    belt_y = height - 130
    draw_text_with_outline(panel_x + 5, belt_y - 18, "ÐŸÐžÐ¯Ð¡", font_small)
    belt = p.get("belt", [None, None, None])
    belt_cell_size = 40
    belt_spacing = 6
    for i in range(3):
        cell_x = panel_x + 5 + i * (belt_cell_size + belt_spacing)
        draw.rectangle([cell_x, belt_y, cell_x + belt_cell_size, belt_y + belt_cell_size], fill=COLOR_SLOT_EMPTY, outline=COLOR_FRAME, width=1)
        draw_text_with_outline(cell_x + 3, belt_y + 2, f"{i+1}", font_small)
        if belt[i]:
            icon_path = all_icons.get(belt[i])
            if icon_path and os.path.exists(icon_path):
                try:
                    belt_icon = Image.open(icon_path).convert("RGBA").resize((belt_cell_size - 8, belt_cell_size - 8))
                    img.paste(belt_icon, (cell_x + 4, belt_y + 4), belt_icon)
                except:
                    pass
    stats_y = belt_y + belt_cell_size + 10
    bar_x = panel_x + 5
    bar_w = 100
    bar_h = 14
    bar_spacing = 20
    health = p.get("health", 10)
    radiation = p.get("radiation", 0)
    hunger = p.get("hunger", 0)
    stamina = p.get("stamina", 10)
    draw_bar_stalker(bar_x, stats_y, bar_w, bar_h, health, 10, COLOR_HEALTH, "â¤ï¸")
    draw_bar_stalker(bar_x, stats_y + bar_spacing, bar_w, bar_h, radiation, 10, COLOR_RADIATION, "â˜¢ï¸")
    draw_bar_stalker(bar_x, stats_y + bar_spacing * 2, bar_w, bar_h, hunger, 10, COLOR_HUNGER, "ðŸ½ï¸")
    draw_bar_stalker(bar_x, stats_y + bar_spacing * 3, bar_w, bar_h, stamina, 10, COLOR_STAMINA, "âš¡")
    inv_panel_x = LEFT_PANEL_WIDTH
    inv_panel_y = 5
    inv_panel_w = INV_COLS * CELL_SIZE + 12
    inv_panel_h = INV_ROWS * CELL_SIZE + 25
    draw_stalker_frame(inv_panel_x, inv_panel_y, inv_panel_w, inv_panel_h, "Ð˜ÐÐ’Ð•ÐÐ¢ÐÐ Ð¬")
    try:
        empty_icon = Image.open("icons/empty.png").convert("RGBA").resize((CELL_SIZE - 4, CELL_SIZE - 4))
    except:
        empty_icon = None
    items_list = []
    for item, count in backpack.items():
        if count > 0 and (item in ITEM_ICONS or item in ARTIFACT_ICONS):
            items_list.append((item, count))
    max_items = INV_COLS * INV_ROWS
    while len(items_list) < max_items:
        items_list.append((None, 0))
    items_list = items_list[:max_items]
    sort_mode = get_sort_mode(user_id)
    if sort_mode != 0:
        active_items = {k: v for k, v in backpack.items() if v > 0}
        if sort_mode == 1:
            sorted_items = []
            for cat in ["ÐµÐ´Ð°", "Ð¼ÐµÐ´Ð¸ÐºÐ°Ð¼ÐµÐ½Ñ‚Ñ‹", "Ð°Ð½Ñ‚Ð¸Ñ€Ð°Ð´", "ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸ÐºÐ¸", "Ð¿Ñ€Ð¾Ñ‡ÐµÐµ"]:
                for name in CATEGORIES[cat]:
                    if name in active_items:
                        sorted_items.append((name, active_items[name]))
            for art in ALL_ARTIFACTS:
                if art in active_items:
                    sorted_items.append((art, active_items[art]))
            for name, count in active_items.items():
                if name not in [n for cat in CATEGORIES.values() for n in cat] and name not in ALL_ARTIFACTS:
                    sorted_items.append((name, count))
        elif sort_mode == 2:
            sorted_items = sorted(active_items.items(), key=lambda x: x[1], reverse=True)
        new_items_list = []
        for item, count in sorted_items:
            new_items_list.append((item, count))
        while len(new_items_list) < max_items:
            new_items_list.append((None, 0))
        items_list = new_items_list[:max_items]
    for idx, (item, count) in enumerate(items_list):
        row = idx // INV_COLS
        col = idx % INV_COLS
        x = inv_panel_x + 6 + col * CELL_SIZE
        y = inv_panel_y + 20 + row * CELL_SIZE
        draw.rectangle([x, y, x + CELL_SIZE - 2, y + CELL_SIZE - 2], fill=COLOR_SLOT_EMPTY, outline=COLOR_FRAME, width=1)
        if item:
            icon_path = all_icons.get(item)
            if icon_path and os.path.exists(icon_path):
                try:
                    icon = Image.open(icon_path).convert("RGBA").resize((CELL_SIZE - 6, CELL_SIZE - 6))
                    img.paste(icon, (x + 2, y + 2), icon)
                except:
                    pass
            text = str(count)
            text_x = x + CELL_SIZE - 15
            text_y = y + CELL_SIZE - 18
            for dx, dy in [(-1, 0), (1, 0), (0, -1), (0, 1)]:
                draw.text((text_x + dx, text_y + dy), text, fill=(0, 0, 0), font=font_small)
            draw.text((text_x, text_y), text, fill=(255, 255, 255), font=font_small)
        elif empty_icon:
            img.paste(empty_icon, (x + 2, y + 2), empty_icon)
    buffer = io.BytesIO()
    img.save(buffer, format="PNG")
    buffer.seek(0)
    return buffer
def generate_warehouse_image():
    width = COLUMNS * CELL_SIZE + (COLUMNS + 1) * MARGIN
    height = ROWS * CELL_SIZE + (ROWS + 1) * MARGIN + 40 - 10
    img = Image.new("RGBA", (width, height), (20, 20, 20, 255))
    try:
        empty_icon = Image.open("icons/empty.png").convert("RGBA").resize((CELL_SIZE, CELL_SIZE))
    except:
        empty_icon = Image.new("RGBA", (CELL_SIZE, CELL_SIZE), (40, 40, 40, 255))
    all_icons = {**ITEM_ICONS, **ARTIFACT_ICONS}
    items_list = []
    for item, count in shared_warehouse.items():
        if count > 0 and (item in ITEM_ICONS or item in ARTIFACT_ICONS):
            items_list.append((item, count))
    while len(items_list) < INVENTORY_SIZE:
        items_list.append((None, 0))
    items_list = items_list[:INVENTORY_SIZE]
    draw = ImageDraw.Draw(img)
    try:
        font = ImageFont.truetype("Graffiti1C.ttf", 16)
    except:
        try:
            font = ImageFont.truetype("arial.ttf", 16)
        except:
            font = ImageFont.load_default()
    draw.text((5, 30), f"Ð”ÐµÐ½ÑŒÐ³Ð¸: {shared_warehouse_money}Ñ€", fill="white", font=font)
    for idx, (item, count) in enumerate(items_list):
        row = idx // COLUMNS
        col = idx % COLUMNS
        x = MARGIN + col * (CELL_SIZE + MARGIN)
        y = 50 + MARGIN + row * (CELL_SIZE + MARGIN)
        img.paste(empty_icon, (x, y))
        if item:
            icon_path = all_icons.get(item)
            if icon_path:
                try:
                    icon = Image.open(icon_path).convert("RGBA").resize((CELL_SIZE, CELL_SIZE))
                    img.paste(icon, (x, y), icon)
                    text = str(count)
                    for dx, dy in [(-1, -1), (-1, 1), (1, -1), (1, 1), (0, -1), (0, 1), (-1, 0), (1, 0)]:
                        draw.text((x + 5 + dx, y + 5 + dy), text, fill="black", font=font)
                    draw.text((x + 5, y + 5), text, fill="white", font=font)
                except:
                    draw.rectangle([x, y, x + CELL_SIZE, y + CELL_SIZE], outline="gray", width=2)
                    text = str(count)
                    draw.text((x + 5, y + 5), text, fill="white", font=font)
    buffer = io.BytesIO()
    img.save(buffer, format="PNG")
    buffer.seek(0)
    return buffer
def generate_quote_image(quote_text, user_name, avatar_image, date_str, background_image=None, title=None):
    width = 800
    min_height = 300
    padding = 40
    avatar_size = 100
    try:
        font_quote = ImageFont.truetype("Graffiti1C.ttf", 28)
        font_name = ImageFont.truetype("Graffiti1C.ttf", 24)
        font_date = ImageFont.truetype("Graffiti1C.ttf", 18)
        font_title = ImageFont.truetype("Graffiti1C.ttf", 22)
    except:
        try:
            font_quote = ImageFont.truetype("arial.ttf", 28)
            font_name = ImageFont.truetype("arial.ttf", 24)
            font_date = ImageFont.truetype("arial.ttf", 18)
            font_title = ImageFont.truetype("arial.ttf", 22)
        except:
            font_quote = ImageFont.load_default()
            font_name = font_quote
            font_date = font_quote
            font_title = font_quote
    temp_img = Image.new("RGB", (1, 1))
    temp_draw = ImageDraw.Draw(temp_img)
    max_text_width = width - padding * 3 - avatar_size - 20
    words = quote_text.split()
    lines = []
    current_line = ""
    for word in words:
        test_line = current_line + " " + word if current_line else word
        bbox = temp_draw.textbbox((0, 0), test_line, font=font_quote)
        if bbox[2] - bbox[0] <= max_text_width:
            current_line = test_line
        else:
            if current_line:
                lines.append(current_line)
            current_line = word
    if current_line:
        lines.append(current_line)
    line_height = 35
    text_height = len(lines) * line_height
    title_height = 40 if title else 0
    height = max(min_height, text_height + padding * 2 + 80 + title_height)
    if background_image:
        try:
            bg = background_image.convert("RGB").resize((width, height))
            enhancer = ImageEnhance.Brightness(bg)
            bg = enhancer.enhance(0.4)
        except:
            bg = Image.new("RGB", (width, height), (20, 20, 20))
    else:
        bg = Image.new("RGB", (width, height), (20, 20, 20))
    img = bg.copy()
    draw = ImageDraw.Draw(img)
    top_offset = 0
    if title:
        title_bbox = temp_draw.textbbox((0, 0), title, font=font_title)
        title_x = (width - (title_bbox[2] - title_bbox[0])) // 2
        title_y = padding // 2
        for dx, dy in [(-1, 0), (1, 0), (0, -1), (0, 1)]:
            draw.text((title_x + dx, title_y + dy), title, fill=(0, 0, 0), font=font_title)
        draw.text((title_x, title_y), title, fill=(255, 215, 0), font=font_title)
        top_offset = title_height
    if avatar_image:
        try:
            avatar = avatar_image.convert("RGBA").resize((avatar_size, avatar_size))
            mask = Image.new("L", (avatar_size, avatar_size), 0)
            mask_draw = ImageDraw.Draw(mask)
            mask_draw.ellipse((0, 0, avatar_size, avatar_size), fill=255)
            avatar_x = padding
            avatar_y = (height - avatar_size) // 2 - 20 + top_offset // 2
            img.paste(avatar, (avatar_x, avatar_y), mask)
        except:
            avatar_x = padding
            avatar_y = (height - avatar_size) // 2 - 20 + top_offset // 2
            draw.ellipse((avatar_x, avatar_y, avatar_x + avatar_size, avatar_y + avatar_size), fill=(60, 60, 60))
    else:
        avatar_x = padding
        avatar_y = (height - avatar_size) // 2 - 20 + top_offset // 2
        draw.ellipse((avatar_x, avatar_y, avatar_x + avatar_size, avatar_y + avatar_size), fill=(60, 60, 60))
    name_bbox = temp_draw.textbbox((0, 0), user_name, font=font_name)
    name_x = avatar_x + (avatar_size - (name_bbox[2] - name_bbox[0])) // 2
    name_y = avatar_y + avatar_size + 10
    for dx, dy in [(-1, 0), (1, 0), (0, -1), (0, 1)]:
        draw.text((name_x + dx, name_y + dy), user_name, fill=(0, 0, 0), font=font_name)
    draw.text((name_x, name_y), user_name, fill=(255, 255, 255), font=font_name)
    quote_x = padding + avatar_size + 30
    quote_y = padding + top_offset
    draw.text((quote_x - 15, quote_y - 10), "Â«", fill=(150, 150, 150), font=font_quote)
    for i, line in enumerate(lines):
        y = quote_y + i * line_height
        for dx, dy in [(-1, 0), (1, 0), (0, -1), (0, 1)]:
            draw.text((quote_x + dx, y + dy), line, fill=(0, 0, 0), font=font_quote)
        draw.text((quote_x, y), line, fill=(255, 255, 255), font=font_quote)
    if lines:
        last_line = lines[-1]
        last_line_bbox = temp_draw.textbbox((0, 0), last_line, font=font_quote)
        end_quote_x = quote_x + last_line_bbox[2] - last_line_bbox[0] + 5
        end_quote_y = quote_y + (len(lines) - 1) * line_height
        draw.text((end_quote_x, end_quote_y - 10), "Â»", fill=(150, 150, 150), font=font_quote)
    watermark = "@wargroupss"
    watermark_x = padding
    watermark_y = height - padding
    for dx, dy in [(-1, 0), (1, 0), (0, -1), (0, 1)]:
        draw.text((watermark_x + dx, watermark_y + dy), watermark, fill=(0, 0, 0), font=font_date)
    draw.text((watermark_x, watermark_y), watermark, fill=(120, 120, 120), font=font_date)
    date_bbox = temp_draw.textbbox((0, 0), date_str, font=font_date)
    date_x = width - padding - (date_bbox[2] - date_bbox[0])
    date_y = height - padding
    for dx, dy in [(-1, 0), (1, 0), (0, -1), (0, 1)]:
        draw.text((date_x + dx, date_y + dy), date_str, fill=(0, 0, 0), font=font_date)
    draw.text((date_x, date_y), date_str, fill=(180, 180, 180), font=font_date)
    buffer = io.BytesIO()
    img.save(buffer, format="PNG")
    buffer.seek(0)
    return buffer
def process_quote_request(user_id, quote_text, quote_user_id, quote_timestamp, peer_id, vk_session):
    if not quote_text or quote_user_id <= 0:
        send_message(user_id, "âŒ Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¿ÑƒÑÑ‚Ð¾Ðµ Ð¸Ð»Ð¸ Ð¾Ñ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÑÑ‚Ð²Ð°.", None, vk_session, peer_id)
        return False
    moscow_time = quote_timestamp + 3 * 3600
    quote_date = time.strftime('%d.%m.%Y %H:%M', time.gmtime(moscow_time))
    if user_id not in players:
        players[user_id] = {"state": STATE_WAITING_QUOTE_PHOTO, "pending_quote": {"text": quote_text, "user_id": quote_user_id, "date": quote_date}}
    else:
        players[user_id]["state"] = STATE_WAITING_QUOTE_PHOTO
        players[user_id]["pending_quote"] = {"text": quote_text, "user_id": quote_user_id, "date": quote_date}
    save_data()
    send_message(user_id, "ðŸ“· ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ñ„Ð¾Ñ‚Ð¾ Ð´Ð»Ñ Ñ„Ð¾Ð½Ð° Ð¸Ð»Ð¸ Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Â«Ð½ÐµÑ‚Â» Ð´Ð»Ñ Ñ‡Ñ‘Ñ€Ð½Ð¾Ð³Ð¾ Ñ„Ð¾Ð½Ð°.\nðŸ’¡ Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº: Â«Ð½ÐµÑ‚ Ð¦Ð¸Ñ‚Ð°Ñ‚Ñ‹ Ð²ÐµÐ»Ð¸ÐºÐ¸Ñ…Â» Ð¸Ð»Ð¸ Ñ„Ð¾Ñ‚Ð¾ Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑŒÑŽ.", None, vk_session, peer_id)
    return True
def process_quote_photo(user_id, text, photo_attachment, peer_id, vk_session):
    p = players.get(user_id)
    if not p:
        return False
    quote_data = p.get("pending_quote")
    if not quote_data:
        return False
    background_img = None
    title = None
    if photo_attachment:
        sizes = photo_attachment.get('sizes', [])
        if sizes:
            best_size = max(sizes, key=lambda x: x.get('width', 0) * x.get('height', 0))
            photo_url = best_size.get('url')
            if photo_url:
                try:
                    resp = vk_session.http.get(photo_url)
                    background_img = Image.open(io.BytesIO(resp.content))
                except:
                    pass
        if text:
            title = text
    elif text.lower() == "Ð½ÐµÑ‚":
        background_img = None
        title = None
    elif text.lower().startswith("Ð½ÐµÑ‚ "):
        background_img = None
        title = text[4:].strip()
    else:
        return False
    quote_text = quote_data.get("text", "")
    quote_user_id = quote_data.get("user_id")
    quote_date = quote_data.get("date", "")
    try:
        user_info = vk_session.method("users.get", {"user_ids": quote_user_id, "fields": "first_name"})[0]
        user_name = user_info.get("first_name", "ÐÐ½Ð¾Ð½Ð¸Ð¼")
    except:
        user_name = "ÐÐ½Ð¾Ð½Ð¸Ð¼"
    avatar_img = get_user_avatar(quote_user_id, vk_session)
    img_buffer = generate_quote_image(quote_text, user_name, avatar_img, quote_date, background_img, title)
    try:
        upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
        resp = vk_session.http.post(upload_url, files={"photo": ("quote.png", img_buffer, "image/png")})
        result = resp.json()
        photo_data = vk_session.method("photos.saveMessagesPhoto", {"photo": result["photo"], "server": result["server"], "hash": result["hash"]})[0]
        vk_session.method("messages.send", {"peer_id": peer_id, "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}", "random_id": 0, "message": "ðŸ–¼ Ð’Ð°ÑˆÐ° Ñ†Ð¸Ñ‚Ð°Ñ‚Ð° Ð³Ð¾Ñ‚Ð¾Ð²Ð°!"})
    except Exception as e:
        logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ñ†Ð¸Ñ‚Ð°Ñ‚Ñ‹: {e}")
        send_message(user_id, "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ñ†Ð¸Ñ‚Ð°Ñ‚Ñ‹.", None, vk_session, peer_id)
    p["state"] = STATE_IN_MENU
    p.pop("pending_quote", None)
    save_data()
    return True
def generate_artifacts_info_image():
    categories = [
        ("Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ â¤ï¸", ["ÐšÑ€Ð¾Ð²ÑŒ ÐºÐ°Ð¼Ð½Ñ", "Ð›Ð¾Ð¼Ð¾Ñ‚ÑŒ Ð¼ÑÑÐ°", "Ð”ÑƒÑˆÐ°", "Ð¡Ð²ÐµÑ‚Ð»ÑÐº"], ["+0.25", "+0.5", "+0.75", "+1"]),
        ("Ð’Ñ‹Ð²Ð¾Ð´ Ñ€Ð°Ð´Ð¸Ð°Ñ†Ð¸Ð¸ â˜¢ï¸", ["ÐšÐ¾Ð»Ð¾Ð±Ð¾Ðº", "ÐœÐµÐ´ÑƒÐ·Ð°", "Ð¡Ð»Ð¸Ð·Ð½ÑÐº", "ÐŸÑƒÐ·Ñ‹Ñ€ÑŒ"], ["-0.25", "-0.5", "-0.75", "-1"]),
        ("Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸Ð» âš¡", ["Ð’ÑÐ¿Ñ‹ÑˆÐºÐ°", "Ð¡Ð½ÐµÐ¶Ð¸Ð½ÐºÐ°", "Ð›ÑƒÐ½Ð½Ñ‹Ð¹ ÑÐ²ÐµÑ‚", "Ð‘Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ°"], ["+0.5", "+1", "+1.5", "+2"]),
        ("Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ Ñ€Ð°Ð·Ñ€Ñ‹Ð²Ð° ðŸ¾", ["Ð‘ÐµÐ½Ð³Ð°Ð»ÑŒÑÐºÐ¸Ð¹ Ð¾Ð³Ð¾Ð½ÑŒ", "Ð’Ñ‹Ð²ÐµÑ€Ñ‚", "Ð“Ñ€Ð°Ð²Ð¸", "Ð—Ð¾Ð»Ð¾Ñ‚Ð°Ñ Ñ€Ñ‹Ð±ÐºÐ°"], ["+0.25", "+0.5", "+0.75", "+1"]),
        ("ÐŸÑƒÐ»ÐµÑÑ‚Ð¾Ð¹ÐºÐ¾ÑÑ‚ÑŒ ðŸ›¡ï¸", ["ÐŸÑƒÑÑ‚Ñ‹ÑˆÐºÐ°", "ÐšÐ°Ð¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ†Ð²ÐµÑ‚Ð¾Ðº", "ÐÐ¾Ñ‡Ð½Ð°Ñ Ð·Ð²ÐµÐ·Ð´Ð°", "ÐšÑ€Ð¸ÑÑ‚Ð°Ð»Ð»"], ["+0.5", "+1", "+1.5", "+2"]),
        ("ÐÐ½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð°Ñ‰Ð¸Ñ‚Ð° ðŸ’¥", ["ÐšÐ¾Ð»ÑŽÑ‡ÐºÐ°", "ÐŸÐ»Ð°Ð¼Ñ", "ÐžÐ³Ð½ÐµÐ½Ð½Ñ‹Ð¹ ÑˆÐ°Ñ€", "ÐŸÐ»Ñ‘Ð½ÐºÐ°"], ["+0.25", "+0.5", "+0.75", "+1"]),
        ("ÐÐ°Ð½ÐµÑÐµÐ½Ð¸Ðµ ÑƒÑ€Ð¾Ð½Ð° ðŸ’¢", ["Ð“Ð»Ð°Ð·", "ÐšÐ°Ð¿Ð»Ð¸", "ÐšÑ€Ð¸ÑÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ ÐºÐ¾Ð»ÑŽÑ‡ÐºÐ°", "ÐŸÑ€ÑƒÐ¶Ð¸Ð½Ð°"], ["+0.5", "+1", "+1.5", "+2"]),
        ("Ð¢Ð¾Ñ‡Ð½Ð¾ÑÑ‚ÑŒ Ð¿Ð¾Ð¿Ð°Ð´Ð°Ð½Ð¸Ñ ðŸŽ¯", ["Ð¡Ð»Ð¸Ð·ÑŒ", "Ð¡Ð»ÑŽÐ´Ð°", "ÐœÐ°Ð¼Ð¸Ð½Ñ‹ Ð±ÑƒÑÑ‹", "ÐœÐ¾Ñ€ÑÐºÐ¾Ð¹ Ñ‘Ð¶"], ["+0.5", "+1", "+1.5", "+2"])
    ]
    icon_size = 40
    padding = 10
    category_height = 60
    item_width = 140
    items_per_row = 4
    width = padding * 2 + items_per_row * item_width
    height = padding * 2 + len(categories) * category_height
    img = Image.new("RGBA", (width, height), (25, 30, 25, 255))
    draw = ImageDraw.Draw(img)
    try:
        font = ImageFont.truetype("Graffiti1C.ttf", 12)
        font_title = ImageFont.truetype("Graffiti1C.ttf", 14)
    except:
        try:
            font = ImageFont.truetype("arial.ttf", 12)
            font_title = ImageFont.truetype("arial.ttf", 14)
        except:
            font = ImageFont.load_default()
            font_title = font
    def draw_text_outline(x, y, text, used_font, fill=(255, 255, 255)):
        for dx, dy in [(-1, 0), (1, 0), (0, -1), (0, 1)]:
            draw.text((x + dx, y + dy), text, fill=(0, 0, 0), font=used_font)
        draw.text((x, y), text, fill=fill, font=used_font)
    y = padding
    for cat_name, artifacts, values in categories:
        draw_text_outline(padding, y, cat_name, font_title, fill=(200, 200, 100))
        y += 18
        x = padding
        for i, art in enumerate(artifacts):
            icon_path = ARTIFACT_ICONS.get(art)
            if icon_path and os.path.exists(icon_path):
                try:
                    icon = Image.open(icon_path).convert("RGBA").resize((icon_size, icon_size))
                    img.paste(icon, (x, y), icon)
                except:
                    pass
            text_x = x + icon_size + 3
            draw_text_outline(text_x, y + 5, art[:12], font)
            draw_text_outline(text_x, y + 20, values[i], font, fill=(150, 255, 150))
            x += item_width
        y += category_height - 18
    buffer = io.BytesIO()
    img.save(buffer, format="PNG")
    buffer.seek(0)
    return buffer
def send_artifacts_info_with_image(user_id, keyboard, vk_session):
    try:
        img_buffer = generate_artifacts_info_image()
        upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
        response = vk_session.http.post(upload_url, files={"photo": ("artifacts.png", img_buffer, "image/png")})
        result = response.json()
        photo_data = vk_session.method("photos.saveMessagesPhoto", {
            "photo": result["photo"],
            "server": result["server"],
            "hash": result["hash"]
        })[0]
        vk_session.method("messages.send", {
            "user_id": user_id,
            "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}",
            "random_id": 0,
            "message": ARTIFACT_INFO_TEXT,
            "keyboard": keyboard.get_keyboard()
        })
    except Exception as e:
        logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²: {e}")
        send_message(user_id, ARTIFACT_INFO_TEXT, keyboard, vk_session)
def upload_and_send_inventory(user_id, vk_session):
    try:
        img_buffer = generate_inventory_image(user_id)
        upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
        response = vk_session.http.post(upload_url, files={"photo": ("inventory.png", img_buffer, "image/png")})
        result = response.json()
        photo_data = vk_session.method("photos.saveMessagesPhoto", {
            "photo": result["photo"],
            "server": result["server"],
            "hash": result["hash"]
        })[0]
        vk_session.method("messages.send", {
            "user_id": user_id,
            "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}",
            "random_id": 0,
            "message": "ðŸŽ’ Ð’Ð°Ñˆ Ñ€ÑŽÐºÐ·Ð°Ðº:",
            "keyboard": create_backpack_menu_keyboard().get_keyboard()
        })
    except Exception as e:
        logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð¸Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€Ñ: {e}")
        send_message(user_id, format_backpack_info(user_id), create_backpack_menu_keyboard(), vk_session)
def upload_and_send_warehouse_global(user_id, vk_session):
    try:
        img_buffer = generate_warehouse_image()
        upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
        response = vk_session.http.post(upload_url, files={"photo": ("warehouse.png", img_buffer, "image/png")})
        result = response.json()
        photo_data = vk_session.method("photos.saveMessagesPhoto", {
            "photo": result["photo"],
            "server": result["server"],
            "hash": result["hash"]
        })[0]
        vk_session.method("messages.send", {
            "user_id": user_id,
            "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}",
            "random_id": 0,
            "message": "ðŸ§° ÐžÐ±Ñ‰Ð¸Ð¹ ÑÐºÐ»Ð°Ð´:\nÐ˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ: Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ/Ð·Ð°Ð±Ñ€Ð°Ñ‚ÑŒ (Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚) (ÐºÐ¾Ð»-Ð²Ð¾)",
            "keyboard": create_warehouse_keyboard().get_keyboard()
        })
    except Exception as e:
        logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐºÐ»Ð°Ð´Ð°: {e}")
        send_message(user_id, format_warehouse_info(), create_warehouse_keyboard(), vk_session)
def show_buy_provisions_menu(user_id, vk_session):
    img_width = 500
    line_height = 60
    padding = 10
    all_provisions = (CATEGORIES["ÐµÐ´Ð°"] + CATEGORIES["Ð¼ÐµÐ´Ð¸ÐºÐ°Ð¼ÐµÐ½Ñ‚Ñ‹"] +
                      CATEGORIES["Ð°Ð½Ñ‚Ð¸Ñ€Ð°Ð´"] + CATEGORIES["ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸ÐºÐ¸"] + CATEGORIES["Ð¿Ñ€Ð¾Ñ‡ÐµÐµ"])
    lines = []
    icons = []
    prices = []
    for item in all_provisions:
        if item in BUY_PRICES:
            price = BUY_PRICES[item]
            lines.append(item)
            prices.append(f"{price}Ñ€")
            icons.append(ITEM_ICONS.get(item, "icons/empty.png"))
    img_height = padding * 2 + len(lines) * line_height
    img = Image.new("RGB", (img_width, img_height), (30, 30, 30))
    draw = ImageDraw.Draw(img)
    try:
        font = ImageFont.truetype("Graffiti1C.ttf", 16)
    except:
        try:
            font = ImageFont.truetype("arial.ttf", 16)
        except:
            font = ImageFont.load_default()
    y = padding
    for i, line in enumerate(lines):
        icon_path = icons[i]
        try:
            icon = Image.open(icon_path).convert("RGBA").resize((40, 40))
            img.paste(icon, (padding, y), icon)
        except Exception as e:
            draw.rectangle([padding, y, padding + 40, y + 40], outline="gray", width=2)
        draw.text((padding + 50, y + 10), line, fill="white", font=font)
        draw.text((img_width - 60, y + 10), prices[i], fill="yellow", font=font)
        y += line_height
    buffer = io.BytesIO()
    img.save(buffer, format="PNG")
    buffer.seek(0)
    try:
        upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
        response = vk_session.http.post(upload_url, files={"photo": ("menu.png", buffer, "image/png")})
        result = response.json()
        photo_data = vk_session.method("photos.saveMessagesPhoto", {
            "photo": result["photo"],
            "server": result["server"],
            "hash": result["hash"]
        })[0]
        money = players[user_id].get("money", 0)
        vk_session.method("messages.send", {
            "user_id": user_id,
            "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}",
            "random_id": 0,
            "message": f"ðŸ’² Ð’Ð°ÑˆÐ¸ Ð´ÐµÐ½ÑŒÐ³Ð¸: {money}Ñ€\n\nÐ’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚ Ð¸ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´Ð»Ñ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ¸ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: Ñ…Ð»ÐµÐ± 2):",
            "keyboard": create_back_only_keyboard().get_keyboard()
        })
    except Exception as e:
        logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð¼ÐµÐ½ÑŽ Ð¿Ñ€Ð¾Ð²Ð¸Ð·Ð¸Ð¸: {e}")
        send_message(user_id, "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¼ÐµÐ½ÑŽ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.", create_back_only_keyboard(), vk_session)
    players[user_id]["state"] = STATE_TRADER_BUY
    save_data()
def show_sell_provisions_menu(user_id, vk_session):
    p = players[user_id]
    backpack = p.get("backpack", {})
    all_provisions = (CATEGORIES["ÐµÐ´Ð°"] + CATEGORIES["Ð¼ÐµÐ´Ð¸ÐºÐ°Ð¼ÐµÐ½Ñ‚Ñ‹"] +
                      CATEGORIES["Ð°Ð½Ñ‚Ð¸Ñ€Ð°Ð´"] + CATEGORIES["ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸ÐºÐ¸"] + CATEGORIES["Ð¿Ñ€Ð¾Ñ‡ÐµÐµ"])
    msg_lines = [f"ðŸ’² Ð’Ð°ÑˆÐ¸ Ð´ÐµÐ½ÑŒÐ³Ð¸: {p.get('money', 0)}Ñ€\n", "ðŸ“¦ Ð’Ð°ÑˆÐ° Ð¿Ñ€Ð¾Ð²Ð¸Ð·Ð¸Ñ:"]
    has_items = False
    for item in all_provisions:
        count = backpack.get(item, 0)
        if count > 0:
            price = SELL_PRICES.get(item, 0)
            msg_lines.append(f"{item} x{count} â€” {price}Ñ€/ÑˆÑ‚")
            has_items = True
    if not has_items:
        msg_lines.append("ÐŸÑƒÑÑ‚Ð¾")
    msg_lines.append("\nÐ’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚ Ð¸ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: Ñ…Ð»ÐµÐ± 2):")
    players[user_id]["state"] = STATE_TRADER_SELL
    save_data()
    send_message(user_id, "\n".join(msg_lines), create_back_only_keyboard(), vk_session)
def show_sell_artifacts_menu(user_id, vk_session):
    p = players[user_id]
    backpack = p.get("backpack", {})
    available_arts = []
    for art in ALL_ARTIFACTS:
        if backpack.get(art, 0) > 0:
            available_arts.append((art, backpack[art]))
    if not available_arts:
        send_message(user_id, "âŒ Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð² Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð¸.", create_trader_sell_category_keyboard(), vk_session)
        return
    msg_lines = ["ðŸŒ• Ð’Ð°ÑˆÐ¸ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð¸:", ""]
    for art, count in available_arts:
        price = ARTIFACT_PRICES.get(art, 15)
        msg_lines.append(f"{art} x{count} â€” {price}Ñ€/ÑˆÑ‚")
    msg_lines.append("")
    msg_lines.append("ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ: [Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ] [ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾]")
    msg_lines.append("ÐŸÑ€Ð¸Ð¼ÐµÑ€: ÐœÐµÐ´ÑƒÐ·Ð° 2")

    players[user_id]["state"] = STATE_TRADER_SELL_ARTIFACTS
    save_data()
    send_message(user_id, "\n".join(msg_lines), create_back_only_keyboard(), vk_session)
def handle_trader_buy(user_id, text, vk_session):
    parts = text.strip().lower().split()
    if len(parts) < 2:
        send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚ Ð¸ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾.", create_back_only_keyboard(), vk_session)
        return
    item_name = " ".join(parts[:-1])
    try:
        count = int(parts[-1])
    except:
        send_message(user_id, "âŒ ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ñ‡Ð¸ÑÐ»Ð¾Ð¼.", create_back_only_keyboard(), vk_session)
        return
    if item_name not in BUY_PRICES:
        send_message(user_id, "âŒ Ð¢Ð°ÐºÐ¾Ð¹ Ñ‚Ð¾Ð²Ð°Ñ€ Ð½Ðµ Ð¿Ñ€Ð¾Ð´Ð°Ñ‘Ñ‚ÑÑ.", create_back_only_keyboard(), vk_session)
        return
    price = BUY_PRICES[item_name] * count
    if players[user_id]["money"] < price:
        send_message(user_id, f"âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´ÐµÐ½ÐµÐ³. ÐÑƒÐ¶Ð½Ð¾ {price}Ñ€, Ñƒ Ð²Ð°Ñ {players[user_id]['money']}Ñ€.", create_back_only_keyboard(), vk_session)
        return
    players[user_id]["money"] -= price
    players[user_id]["backpack"][item_name] = players[user_id]["backpack"].get(item_name, 0) + count
    save_data()
    send_message(user_id, f"âœ… ÐšÑƒÐ¿Ð»ÐµÐ½Ð¾: {item_name} x{count} Ð·Ð° {price}Ñ€.", create_trader_category_keyboard(), vk_session)
def handle_trader_sell(user_id, text, vk_session):
    parts = text.strip().lower().split()
    if len(parts) < 2:
        send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚ Ð¸ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾.", create_back_only_keyboard(), vk_session)
        return
    item_name = " ".join(parts[:-1])
    try:
        count = int(parts[-1])
    except:
        send_message(user_id, "âŒ ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ñ‡Ð¸ÑÐ»Ð¾Ð¼.", create_back_only_keyboard(), vk_session)
        return
    if item_name not in SELL_PRICES:
        send_message(user_id, "âŒ Ð¢Ð°ÐºÐ¾Ð¹ Ñ‚Ð¾Ð²Ð°Ñ€ Ð½ÐµÐ»ÑŒÐ·Ñ Ð¿Ñ€Ð¾Ð´Ð°Ñ‚ÑŒ.", create_back_only_keyboard(), vk_session)
        return
    if count <= 0:
        send_message(user_id, "âŒ ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐµ 0.", create_back_only_keyboard(), vk_session)
        return
    if players[user_id]["backpack"].get(item_name, 0) < count:
        send_message(user_id, f"âŒ Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ {count} ÑˆÑ‚. ÑÑ‚Ð¾Ð³Ð¾ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð°.", create_back_only_keyboard(), vk_session)
        return
    price = SELL_PRICES[item_name] * count
    players[user_id]["money"] += price
    players[user_id]["backpack"][item_name] -= count
    if players[user_id]["backpack"][item_name] <= 0:
        del players[user_id]["backpack"][item_name]
    save_data()
    p = players[user_id]
    backpack = p.get("backpack", {})
    all_provisions = (CATEGORIES["ÐµÐ´Ð°"] + CATEGORIES["Ð¼ÐµÐ´Ð¸ÐºÐ°Ð¼ÐµÐ½Ñ‚Ñ‹"] +
                      CATEGORIES["Ð°Ð½Ñ‚Ð¸Ñ€Ð°Ð´"] + CATEGORIES["ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸ÐºÐ¸"] + CATEGORIES["Ð¿Ñ€Ð¾Ñ‡ÐµÐµ"])
    msg_lines = [f"âœ… ÐŸÑ€Ð¾Ð´Ð°Ð½Ð¾: {item_name} x{count} Ð·Ð° {price}Ñ€.\n", f"ðŸ’² Ð’Ð°ÑˆÐ¸ Ð´ÐµÐ½ÑŒÐ³Ð¸: {p.get('money', 0)}Ñ€\n", "ðŸ“¦ Ð’Ð°ÑˆÐ° Ð¿Ñ€Ð¾Ð²Ð¸Ð·Ð¸Ñ:"]
    has_items = False
    for item in all_provisions:
        cnt = backpack.get(item, 0)
        if cnt > 0:
            sell_price = SELL_PRICES.get(item, 0)
            msg_lines.append(f"{item} x{cnt} â€” {sell_price}Ñ€/ÑˆÑ‚")
            has_items = True
    if not has_items:
        msg_lines.append("ÐŸÑƒÑÑ‚Ð¾")
    msg_lines.append("\nÐ’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚ Ð¸ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: Ñ…Ð»ÐµÐ± 2):")
    send_message(user_id, "\n".join(msg_lines), create_back_only_keyboard(), vk_session)
def handle_trader_sell_artifact(user_id, text, vk_session):
    parts = text.strip().split()
    if len(parts) < 2:
        send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð° Ð¸ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾.", create_back_only_keyboard(), vk_session)
        return
    try:
        count = int(parts[-1])
        item_name = " ".join(parts[:-1])
    except:
        send_message(user_id, "âŒ ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ñ‡Ð¸ÑÐ»Ð¾Ð¼.", create_back_only_keyboard(), vk_session)
        return
    found_art = None
    for art in ALL_ARTIFACTS:
        if art.lower() == item_name.lower():
            found_art = art
            break
    if not found_art:
        send_message(user_id, "âŒ Ð¢Ð°ÐºÐ¾Ð¹ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", create_back_only_keyboard(), vk_session)
        return
    if players[user_id]["backpack"].get(found_art, 0) < count:
        send_message(user_id, f"âŒ Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ {count} ÑˆÑ‚. ÑÑ‚Ð¾Ð³Ð¾ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð°.", create_back_only_keyboard(), vk_session)
        return
    price = ARTIFACT_PRICES.get(found_art, 15) * count
    players[user_id]["money"] += price
    players[user_id]["backpack"][found_art] -= count
    if players[user_id]["backpack"][found_art] <= 0:
        del players[user_id]["backpack"][found_art]
    save_data()
    send_message(user_id, f"âœ… ÐŸÑ€Ð¾Ð´Ð°Ð½Ð¾: {found_art} x{count} Ð·Ð° {price}Ñ€.", create_trader_sell_category_keyboard(), vk_session)
def handle_equipment_sell_confirmation(user_id, text, vk_session):
    p = players[user_id]
    if text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
        p["state"] = STATE_TRADER_SELL_CATEGORY
        save_data()
        send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ:", create_trader_sell_category_keyboard(), vk_session)
        return
    if text == "ðŸ”« ÐžÑ€ÑƒÐ¶Ð¸Ðµ":
        if not p.get("weapon"):
            send_message(user_id, "âŒ Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ Ð¾Ñ€ÑƒÐ¶Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð¸.", create_equipment_sell_keyboard(), vk_session)
            return
        p["pending_sell"] = "weapon"
        weapon_name = p["weapon"]
        price = 0
        for item in EQUIPMENT[p["faction"]]["weapon"]:
            if item[0] == weapon_name:
                price = item[4] // 2
                break
        send_message(user_id, f"Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾Ð´Ð°Ñ‚ÑŒ {weapon_name} Ð·Ð° {price}Ñ€?", create_confirmation_keyboard(), vk_session)
        p["state"] = STATE_CONFIRMING_EQUIPMENT_SELL
        save_data()
        return
    elif text == "ðŸ¦º Ð‘Ñ€Ð¾Ð½Ñ":
        if not p.get("armor"):
            send_message(user_id, "âŒ Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ Ð±Ñ€Ð¾Ð½Ð¸ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð¸.", create_equipment_sell_keyboard(), vk_session)
            return
        p["pending_sell"] = "armor"
        armor_name = p["armor"]
        price = 0
        for item in EQUIPMENT[p["faction"]]["armor"]:
            if item[0] == armor_name:
                price = item[5] // 2
                break
        send_message(user_id, f"Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾Ð´Ð°Ñ‚ÑŒ {armor_name} Ð·Ð° {price}Ñ€?", create_confirmation_keyboard(), vk_session)
        p["state"] = STATE_CONFIRMING_EQUIPMENT_SELL
        save_data()
        return
    elif text == "ðŸ“Ÿ Ð”ÐµÑ‚ÐµÐºÑ‚Ð¾Ñ€Ñ‹":
        if not p.get("detector"):
            send_message(user_id, "âŒ Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ Ð´ÐµÑ‚ÐµÐºÑ‚Ð¾Ñ€Ð° Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð¸.", create_equipment_sell_keyboard(), vk_session)
            return
        p["pending_sell"] = "detector"
        det_name = p["detector"]
        price = DETECTORS[det_name]["price"] // 2
        send_message(user_id, f"Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾Ð´Ð°Ñ‚ÑŒ {det_name} Ð·Ð° {price}Ñ€?", create_confirmation_keyboard(), vk_session)
        p["state"] = STATE_CONFIRMING_EQUIPMENT_SELL
        save_data()
        return
    else:
        send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ ÑÐ½Ð°Ñ€ÑÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð¸:", create_equipment_sell_keyboard(), vk_session)
        save_data()
def handle_equipment_sell_final(user_id, text, vk_session):
    p = players[user_id]
    if text == "âœ… Ð”Ð°":
        sell_type = p.get("pending_sell")
        msg = ""
        if sell_type == "weapon":
            weapon_name = p["weapon"]
            for item in EQUIPMENT[p["faction"]]["weapon"]:
                if item[0] == weapon_name:
                    price = item[4] // 2
                    p["money"] += price
                    p["weapon"] = None
                    p["weapon_durability"] = 0
                    p["weapon_max_durability"] = 0
                    p["weapon_damage"] = 0
                    p["weapon_accuracy"] = 0
                    msg = f"âœ… ÐŸÑ€Ð¾Ð´Ð°Ð½Ð¾: {weapon_name} Ð·Ð° {price}Ñ€."
                    break
        elif sell_type == "armor":
            armor_name = p["armor"]
            for item in EQUIPMENT[p["faction"]]["armor"]:
                if item[0] == armor_name:
                    price = item[5] // 2
                    p["money"] += price
                    p["armor"] = None
                    p["armor_durability"] = 0
                    p["armor_max_durability"] = 0
                    p["bullet_resist"] = 0
                    p["blast_resist"] = 0
                    p["anomaly_resist"] = 0
                    msg = f"âœ… ÐŸÑ€Ð¾Ð´Ð°Ð½Ð¾: {armor_name} Ð·Ð° {price}Ñ€."
                    break
        elif sell_type == "detector":
            det_name = p["detector"]
            price = DETECTORS[det_name]["price"] // 2
            p["money"] += price
            p["detector"] = None
            p["detector_charge"] = 0
            p["detector_max_charge"] = 0
            msg = f"âœ… ÐŸÑ€Ð¾Ð´Ð°Ð½Ð¾: {det_name} Ð·Ð° {price}Ñ€."
        p["pending_sell"] = None
        p["state"] = STATE_TRADER_SELL_EQUIPMENT_CONFIRM
        save_data()
        send_message(user_id, msg, create_equipment_sell_keyboard(), vk_session)
    elif text == "âŒ ÐÐµÑ‚":
        p["pending_sell"] = None
        p["state"] = STATE_TRADER_SELL_EQUIPMENT_CONFIRM
        save_data()
        send_message(user_id, "ÐŸÑ€Ð¾Ð´Ð°Ð¶Ð° Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð°.", create_equipment_sell_keyboard(), vk_session)
def handle_repair(user_id, text, vk_session):
    p = players[user_id]
    if text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
        p["state"] = STATE_TRADER_MAIN
        save_data()
        send_message(user_id, "Ð’Ñ‹ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ñ‡Ñ‚Ð¾ Ð»Ð¸Ð±Ð¾ ðŸ’² Ð¿Ñ€Ð¸Ð¾Ð±Ñ€ÐµÑÑ‚Ð¸ Ð¸Ð»Ð¸ ðŸ’± Ð¿Ñ€Ð¾Ð´Ð°Ñ‚ÑŒ?", create_trader_main_keyboard(), vk_session)
        return
    if text == "ðŸ”« ÐžÑ€ÑƒÐ¶Ð¸Ðµ":
        if not p.get("weapon"):
            send_message(user_id, "âŒ Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ Ð¾Ñ€ÑƒÐ¶Ð¸Ñ Ð´Ð»Ñ Ñ€ÐµÐ¼Ð¾Ð½Ñ‚Ð°.", create_repair_keyboard(user_id), vk_session)
            return
        if p["money"] < 15:
            send_message(user_id, "âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´ÐµÐ½ÐµÐ³ Ð´Ð»Ñ Ñ€ÐµÐ¼Ð¾Ð½Ñ‚Ð°.", create_repair_keyboard(user_id), vk_session)
            return
        if p["weapon_durability"] >= p["weapon_max_durability"]:
            send_message(user_id, "ðŸ”« ÐžÑ€ÑƒÐ¶Ð¸Ðµ ÑƒÐ¶Ðµ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð¾Ñ‚Ñ€ÐµÐ¼Ð¾Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾.", create_repair_keyboard(user_id), vk_session)
            return
        p["money"] -= 15
        p["weapon_durability"] = min(p["weapon_max_durability"], p["weapon_durability"] + 1)
        save_data()
        send_message(user_id, f"âœ… ÐžÑ€ÑƒÐ¶Ð¸Ðµ Ð¾Ñ‚Ñ€ÐµÐ¼Ð¾Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾. Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð¿Ñ€Ð¾Ñ‡Ð½Ð¾ÑÑ‚ÑŒ: {p['weapon_durability']}/{p['weapon_max_durability']}", create_repair_keyboard(user_id), vk_session)
        return
    if text == "ðŸ¦º Ð‘Ñ€Ð¾Ð½Ñ":
        if not p.get("armor"):
            send_message(user_id, "âŒ Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ Ð±Ñ€Ð¾Ð½Ð¸ Ð´Ð»Ñ Ñ€ÐµÐ¼Ð¾Ð½Ñ‚Ð°.", create_repair_keyboard(user_id), vk_session)
            return
        if p["money"] < 15:
            send_message(user_id, "âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´ÐµÐ½ÐµÐ³ Ð´Ð»Ñ Ñ€ÐµÐ¼Ð¾Ð½Ñ‚Ð°.", create_repair_keyboard(user_id), vk_session)
            return
        if p["armor_durability"] >= p["armor_max_durability"]:
            send_message(user_id, "ðŸ¦º Ð‘Ñ€Ð¾Ð½Ñ ÑƒÐ¶Ðµ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð¾Ñ‚Ñ€ÐµÐ¼Ð¾Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°.", create_repair_keyboard(user_id), vk_session)
            return
        p["money"] -= 15
        p["armor_durability"] = min(p["armor_max_durability"], p["armor_durability"] + 1)
        save_data()
        send_message(user_id, f"âœ… Ð‘Ñ€Ð¾Ð½Ñ Ð¾Ñ‚Ñ€ÐµÐ¼Ð¾Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°. Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð¿Ñ€Ð¾Ñ‡Ð½Ð¾ÑÑ‚ÑŒ: {p['armor_durability']}/{p['armor_max_durability']}", create_repair_keyboard(user_id), vk_session)
        return
def handle_equipment_buy_confirmation(user_id, text, vk_session):
    p = players[user_id]
    if text == "âœ… Ð”Ð°":
        item_name = p.get("pending_buy_item")
        item_type = p.get("pending_buy_type")
        faction = p["faction"]
        if item_type == "detector" and p.get("detector"):
            send_message(user_id, f"âŒ Ð£ Ð²Ð°Ñ ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ Ð´ÐµÑ‚ÐµÐºÑ‚Ð¾Ñ€: {p['detector']}. Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ñ€Ð¾Ð´Ð°Ð¹Ñ‚Ðµ ÐµÐ³Ð¾.", create_equipment_category_keyboard(), vk_session)
            p["state"] = STATE_TRADER_BUY_EQUIPMENT
            p["pending_buy_item"] = None
            p["pending_buy_type"] = None
            save_data()
            return
        if item_type == "weapon" and p.get("weapon"):
            send_message(user_id, f"âŒ Ð£ Ð²Ð°Ñ ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ Ð¾Ñ€ÑƒÐ¶Ð¸Ðµ: {p['weapon']}. Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ñ€Ð¾Ð´Ð°Ð¹Ñ‚Ðµ ÐµÐ³Ð¾.", create_equipment_category_keyboard(), vk_session)
            p["state"] = STATE_TRADER_BUY_EQUIPMENT
            p["pending_buy_item"] = None
            p["pending_buy_type"] = None
            save_data()
            return
        if item_type == "armor" and p.get("armor"):
            send_message(user_id, f"âŒ Ð£ Ð²Ð°Ñ ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ Ð±Ñ€Ð¾Ð½Ñ: {p['armor']}. Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ñ€Ð¾Ð´Ð°Ð¹Ñ‚Ðµ ÐµÑ‘.", create_equipment_category_keyboard(), vk_session)
            p["state"] = STATE_TRADER_BUY_EQUIPMENT
            p["pending_buy_item"] = None
            p["pending_buy_type"] = None
            save_data()
            return
        price = None
        if item_type == "detector":
            price = DETECTORS[item_name]["price"]
            p["detector"] = item_name
            p["detector_charge"] = DETECTORS[item_name]["charge"]
            p["detector_max_charge"] = DETECTORS[item_name]["charge"]
        else:
            for item in EQUIPMENT[faction][item_type]:
                if item[0] == item_name:
                    if item_type == "weapon":
                        _, dur, dmg, acc, price = item
                        p["weapon"] = item_name
                        p["weapon_durability"] = dur
                        p["weapon_max_durability"] = dur
                        p["weapon_damage"] = dmg
                        p["weapon_accuracy"] = acc
                    else:
                        _, dur, shield, blast, anom, price = item
                        p["armor"] = item_name
                        p["armor_durability"] = dur
                        p["armor_max_durability"] = dur
                        p["bullet_resist"] = shield
                        p["blast_resist"] = blast
                        p["anomaly_resist"] = anom
                    break
        if price is not None:
            p["money"] -= price
            p["pending_buy_item"] = None
            p["pending_buy_type"] = None
            p["state"] = STATE_TRADER_BUY_EQUIPMENT
            save_data()
            send_message(user_id, f"âœ… ÐšÑƒÐ¿Ð»ÐµÐ½Ð¾: {item_name} Ð·Ð° {price}Ñ€.", create_equipment_category_keyboard(), vk_session)
        else:
            p["state"] = STATE_TRADER_BUY_EQUIPMENT
            save_data()
            send_message(user_id, "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐµ.", create_equipment_category_keyboard(), vk_session)
    elif text == "âŒ ÐÐµÑ‚":
        p["pending_buy_item"] = None
        p["pending_buy_type"] = None
        p["state"] = STATE_TRADER_BUY_EQUIPMENT
        save_data()
        send_message(user_id, "ÐŸÐ¾ÐºÑƒÐ¿ÐºÐ° Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð°.", create_equipment_category_keyboard(), vk_session)
def handle_warehouse_action(user_id, text, vk_session):
    global shared_warehouse, shared_warehouse_money, faction_warehouses, faction_warehouse_money
    if LAST_STAND_MODE:
        faction = players[user_id].get("faction")
        warehouse = faction_warehouses.get(faction, {})
        warehouse_money = faction_warehouse_money.get(faction, 0)
    else:
        warehouse = shared_warehouse
        warehouse_money = shared_warehouse_money
    parts = text.strip().lower().split()
    if len(parts) < 2:
        send_message(user_id, "âŒ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ: Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ/Ð·Ð°Ð±Ñ€Ð°Ñ‚ÑŒ (Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚) (ÐºÐ¾Ð»-Ð²Ð¾)", create_warehouse_keyboard(), vk_session)
        return
    action = parts[0]
    if action not in ["Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ", "Ð·Ð°Ð±Ñ€Ð°Ñ‚ÑŒ"]:
        send_message(user_id, "âŒ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ: Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ/Ð·Ð°Ð±Ñ€Ð°Ñ‚ÑŒ (Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚) (ÐºÐ¾Ð»-Ð²Ð¾)", create_warehouse_keyboard(), vk_session)
        return
    if parts[1] == "Ð´ÐµÐ½ÑŒÐ³Ð¸":
        try:
            amount = int(parts[2])
        except:
            send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ ÑÑƒÐ¼Ð¼Ñƒ.", create_warehouse_keyboard(), vk_session)
            return
        if action == "Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ":
            if players[user_id]["money"] < amount:
                send_message(user_id, "âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´ÐµÐ½ÐµÐ³.", create_warehouse_keyboard(), vk_session)
                return
            players[user_id]["money"] -= amount
            if LAST_STAND_MODE:
                faction_warehouse_money[faction] = faction_warehouse_money.get(faction, 0) + amount
            else:
                shared_warehouse_money += amount
        else:
            current_money = faction_warehouse_money.get(faction, 0) if LAST_STAND_MODE else shared_warehouse_money
            if current_money < amount:
                send_message(user_id, "âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´ÐµÐ½ÐµÐ³ Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ.", create_warehouse_keyboard(), vk_session)
                return
            if LAST_STAND_MODE:
                faction_warehouse_money[faction] -= amount
            else:
                shared_warehouse_money -= amount
            players[user_id]["money"] += amount
    else:
        item_name = " ".join(parts[1:-1]) if len(parts) > 3 else parts[1]
        try:
            count = int(parts[-1])
        except:
            send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾.", create_warehouse_keyboard(), vk_session)
            return
        if item_name not in ITEM_EFFECTS and item_name not in [a.lower() for a in ALL_ARTIFACTS]:
            send_message(user_id, "âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚.", create_warehouse_keyboard(), vk_session)
            return
        if action == "Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ":
            if players[user_id]["backpack"].get(item_name, 0) < count:
                send_message(user_id, f"âŒ Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ {count} ÑˆÑ‚. ÑÑ‚Ð¾Ð³Ð¾ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð°.", create_warehouse_keyboard(), vk_session)
                return
            players[user_id]["backpack"][item_name] -= count
            warehouse[item_name] = warehouse.get(item_name, 0) + count
            if players[user_id]["backpack"][item_name] <= 0:
                del players[user_id]["backpack"][item_name]
        else:
            if warehouse.get(item_name, 0) < count:
                send_message(user_id, f"âŒ ÐÐ° ÑÐºÐ»Ð°Ð´Ðµ Ð½ÐµÑ‚ {count} ÑˆÑ‚. ÑÑ‚Ð¾Ð³Ð¾ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð°.", create_warehouse_keyboard(), vk_session)
                return
            warehouse[item_name] -= count
            players[user_id]["backpack"][item_name] = players[user_id]["backpack"].get(item_name, 0) + count
            if warehouse[item_name] <= 0:
                del warehouse[item_name]
        if LAST_STAND_MODE:
            faction_warehouses[faction] = warehouse
        else:
            shared_warehouse = warehouse
    save_data()
    upload_and_send_warehouse_global(user_id, vk_session)
def handle_photo_upload(user_id, photo_url, vk_session):
    if user_id != 353430025:
        return
    target_uid = players[user_id].get("pending_photo_target")
    if not target_uid:
        return
    players[user_id].pop("pending_photo_target", None)
    try:
        img_data = vk_session.http.get(photo_url).content
        img = Image.open(io.BytesIO(img_data)).convert("RGBA")
        img.save(os.path.join(AVATAR_DIR, f"{target_uid}.png"))
        send_message(user_id, f"âœ… Ð¤Ð¾Ñ‚Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ Ð¸Ð³Ñ€Ð¾ÐºÑƒ {players[target_uid]['nickname']}.", None, vk_session)
        send_message(target_uid, "ðŸ–¼ï¸ ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ð» Ð²Ð°Ð¼ Ð½Ð¾Ð²ÑƒÑŽ Ð°Ð²Ð°Ñ‚Ð°Ñ€ÐºÑƒ!", None, vk_session)
    except Exception as e:
        logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð¾Ñ‚Ð¾: {e}")
        send_message(user_id, "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ñ„Ð¾Ñ‚Ð¾.", None, vk_session)
def check_pending_states(vk_session):
    current_time = time.time()
    updated_any = False
    for user_id, data in list(players.items()):
        faction = data.get("faction")
        if not faction or faction == "None" or faction is None:
            continue
        if data.get("donation_end_time") and current_time >= data.get("donation_end_time"):
            remove_donation(user_id, vk_session)
        if data.get("health", 10) <= 0:
            if not data.get("death_notified", False):
                lose_random_items_on_death(user_id, vk_session)
                continue
        if data.get("state") == STATE_TRANSITION_WAIT:
            end_time = data.get("transition_end_time")
            if end_time and current_time >= end_time:
                data["previous_location"] = None
                data["previous_point"] = None
                if random.randint(1, 100) <= 30:
                    money_found = random.randint(5, 15)
                    data["money"] = data.get("money", 0) + money_found
                    transition_msg = f"âœ… ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½!\nðŸ’² ÐŸÐ¾ Ð¿ÑƒÑ‚Ð¸ Ð½Ð°ÑˆÐ»Ð¸: {money_found}Ñ€"
                elif random.randint(1, 100) <= 20:
                    rad_gain = round(random.uniform(0.5, 1.5), 1)
                    data["radiation"] = min(10, data["radiation"] + rad_gain)
                    transition_msg = f"âœ… ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½!\nâ˜¢ï¸ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ Ð¾Ð±Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ: +{rad_gain}"
                else:
                    transition_msg = "âœ… ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½!"
                data["transition_end_time"] = None
                data["state"] = STATE_IN_MENU
                data["backpack"]["Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸"] = data["backpack"].get("Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸", 0) - 2
                if data["backpack"]["Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸"] <= 0:
                    del data["backpack"]["Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸"]
                transition_msg += "\nðŸ”‹ ÐŸÐ¾Ñ‚Ñ€Ð°Ñ‡ÐµÐ½Ð¾ 2 Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸."
                current_location = data["location"]
                current_point = data["point"]
                if (current_location, current_point) in TRANSITION_ROUTES:
                    destinations = TRANSITION_ROUTES[(current_location, current_point)]
                    transition_msg += "\n\nðŸ“ Ð’Ñ‹ Ð½Ð° Ñ‚Ð¾Ñ‡ÐºÐµ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð°!"
                    for dest_loc, dest_point in destinations:
                        transition_msg += f"\nÐ¢ÐµÐ¿ÐµÑ€ÑŒ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¿Ð¾Ð¿Ð°ÑÑ‚ÑŒ Ð½Ð° {dest_loc} {dest_point}"
                send_location_image(user_id, current_location, current_point, transition_msg, create_main_menu_keyboard(user_id), vk_session)
                updated_any = True
        elif data.get("state") == STATE_RESTING:
            start_time = data.get("rest_start_time")
            if start_time:
                elapsed_minutes = int((current_time - start_time) // 360)
                initial = data.get("initial_stamina", data["stamina"])
                belt_bonus = apply_belt_effects_on_rest(user_id)
                donation_bonus = 1 if has_active_donation(user_id) else 0
                new_stamina = min(10, initial + elapsed_minutes * (1 + belt_bonus + donation_bonus))
                if new_stamina > data["stamina"]:
                    data["stamina"] = new_stamina
                    updated_any = True
                if data["stamina"] >= 10:
                    data["stamina"] = 10
                    data["state"] = STATE_IN_CAMP
                    data["rest_start_time"] = None
                    data.pop("initial_stamina", None)
                    send_message(user_id, "ðŸ˜´ Ð’Ñ‹ Ð¾Ñ‚Ð´Ð¾Ñ…Ð½ÑƒÐ»Ð¸ Ð¸ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ð»Ð¸ Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ.", create_camp_menu_keyboard(), vk_session)
                    updated_any = True
    if updated_any:
        save_data()
def handle_message(event, vk_session):
 if not hasattr(event, 'text'):
  return
 if not hasattr(event, 'user_id') or event.from_chat:
  return
 user_id = event.user_id
 text = event.text.strip() if hasattr(event, 'text') else ""
 if user_id in banned_users:
  reason = banned_users.get(user_id, "ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð° Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°")
  send_message(user_id, f"ðŸš« Ð’Ñ‹ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ð² Ð¸Ð³Ñ€Ðµ.\nðŸ“ ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°: {reason}", None, vk_session)
  return
 if user_id in players and players[user_id].get("state") == STATE_WAITING_QUOTE_PHOTO:
  return
 if user_id in players:
  state = players[user_id].get("state")
  registration_states = [STATE_WAITING_FOR_START, STATE_READING_INSTRUCTIONS, STATE_CHOOSING_FACTION, STATE_ENTERING_NICKNAME]
  if state not in registration_states:
   if handle_global_commands(user_id, text, vk_session):
    return
 if text.lower() == "/skip_cd" and is_admin(user_id):
  if user_id in players and players[user_id].get("state") == STATE_TRANSITION_WAIT:
   players[user_id]["state"] = STATE_IN_MENU
   players[user_id]["transition_end_time"] = None
   save_data()
   send_message(user_id, "â±ï¸ Ð¢Ð°Ð¹Ð¼ÐµÑ€ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð° ÑÐ±Ñ€Ð¾ÑˆÐµÐ½.", None, vk_session)
  else:
   send_message(user_id, "Ð’Ñ‹ Ð½Ðµ Ð² ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¸ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð°.", None, vk_session)
  return
 if text.lower() == "/reset_all":
  if user_id == 353430025:
   reset_all_data()
   send_message(user_id, "ðŸ”„ Ð’ÑÐµ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑÐ±Ñ€Ð¾ÑˆÐµÐ½Ñ‹.", None, vk_session)
  else:
   send_message(user_id, "âŒ Ð­Ñ‚Ð° ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñƒ.", None, vk_session)
  return
 if user_id in players and players[user_id].get("state") == STATE_TRANSITION_WAIT:
  end_time = players[user_id]["transition_end_time"]
  if end_time and time.time() < end_time:
   remaining = end_time - time.time()
   minutes = int(remaining // 60)
   seconds = int(remaining % 60)
   send_message(user_id, f"â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð°: {minutes} Ð¼Ð¸Ð½ {seconds} ÑÐµÐº", None, vk_session)
  return
 time.sleep(0.3)
 if user_id not in players:
  name, screen_name = get_user_info(user_id, vk_session)
  players[user_id] = {
   "state": STATE_WAITING_FOR_START,
   "name": name,
   "screen_name": screen_name,
   "faction": None,
   "nickname": None,
   "location": "Ð›Ð°Ð³ÐµÑ€ÑŒ",
   "point": "Ð‘1",
   "health": 10,
   "radiation": 0,
   "hunger": 0,
   "stamina": 10,
   "detector": None,
   "detector_charge": 0,
   "detector_max_charge": 0,
   "armor": None,
   "armor_durability": 0,
   "armor_max_durability": 0,
   "bullet_resist": 0,
   "blast_resist": 0,
   "anomaly_resist": 0,
   "weapon": None,
   "weapon_durability": 0,
   "weapon_max_durability": 0,
   "weapon_damage": 0,
   "weapon_accuracy": 0,
   "money": 0,
   "backpack": {"Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸": 4},
   "transition_end_time": None,
   "rest_start_time": None,
   "backpack_sort": 0,
   "death_notified": False,
   "belt": [None, None, None],
   "anomaly_map": None,
   "player_pos": None,
   "artifact_positions": [],
   "anomaly_positions": [],
   "current_anomaly_type": None,
   "squads": 0,
   "food_units": 0,
   "med_units": 0,
   "rad_units": 0,
   "donation_end_time": None,
   "hidden_anomaly_positions": [],
   "previous_location": None,
   "previous_point": None,
   "donation_artifact": None
  }
  save_data()
  send_message(user_id, f"ÐŸÑ€Ð¸Ð²ÐµÑ‚, {name}! ðŸ‘‹\nÐÐ°Ð¶Ð¼Ð¸ ÐºÐ½Ð¾Ð¿ÐºÑƒ Â«Ð¡Ñ‚Ð°Ñ€Ñ‚Â», Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð¸Ð³Ñ€Ñƒ.", create_start_keyboard(), vk_session)
  return
 _, current_screen = get_user_info(user_id, vk_session)
 if players[user_id].get("screen_name") != current_screen:
  players[user_id]["screen_name"] = current_screen
  save_data()
 state = players[user_id]["state"]
 if state == STATE_ANOMALY_EXPLORE:
  p = players[user_id]
  if p.get("anomaly_path_choosing") == True:
   if text == "ðŸšª Ð£Ð¹Ñ‚Ð¸":
    p["state"] = STATE_IN_MENU
    p["anomaly_path_choosing"] = False
    p["anomaly_safe_path"] = None
    save_data()
    send_message(user_id, "Ð’Ñ‹ Ð¾Ñ‚ÑÑ‚ÑƒÐ¿Ð¸Ð»Ð¸ Ð¾Ñ‚ Ð°Ð½Ð¾Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð·Ð¾Ð½Ñ‹.", create_main_menu_keyboard(user_id), vk_session)
    return
   chosen_path = 0
   if text == "ðŸŒ€ ÐŸÑƒÑ‚ÑŒ 1":
    chosen_path = 1
   elif text == "ðŸŒ€ ÐŸÑƒÑ‚ÑŒ 2":
    chosen_path = 2
   elif text == "ðŸŒ€ ÐŸÑƒÑ‚ÑŒ 3":
    chosen_path = 3
   if chosen_path == 0:
    send_message(user_id, "âš ï¸ Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¾Ð´Ð¸Ð½ Ð¸Ð· Ð¿ÑƒÑ‚ÐµÐ¹ Ð¸Ð»Ð¸ ÑƒÐ¹Ð´Ð¸Ñ‚Ðµ.", create_anomaly_path_keyboard(), vk_session)
    return
   safe_path = p.get("anomaly_safe_path", 1)
   messages = []
   if chosen_path != safe_path:
    atype = p.get("current_anomaly_type", "Ð³Ñ€Ð°Ð²Ð¸")
    min_dmg, max_dmg = ANOMALY_DAMAGE[atype]
    raw_damage = round(random.uniform(min_dmg, max_dmg), 1)
    anomaly_resist = get_total_anomaly_resist(user_id)
    actual_damage = max(0, round(raw_damage - anomaly_resist, 1))
    p["health"] = max(0, p["health"] - actual_damage)
    if actual_damage > 0:
     messages.append(f"ðŸ’¥ ÐžÐ¿Ð°ÑÐ½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ! Ð’Ñ‹ Ð¿Ð¾Ð¿Ð°Ð»Ð¸ Ð² Ð°Ð½Ð¾Ð¼Ð°Ð»Ð¸ÑŽ!")
     messages.append(f"â¤ï¸ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ {actual_damage} ÑƒÑ€Ð¾Ð½Ð° (Ð·Ð°Ñ‰Ð¸Ñ‚Ð°: {anomaly_resist})")
     messages.append(f"â¤ï¸ Ð—Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ: {p['health']}/10")
    else:
     messages.append("ðŸ›¡ï¸ Ð’Ñ‹ Ð¿Ð¾Ð¿Ð°Ð»Ð¸ Ð² Ð°Ð½Ð¾Ð¼Ð°Ð»Ð¸ÑŽ, Ð½Ð¾ Ð·Ð°Ñ‰Ð¸Ñ‚Ð° Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð¿Ð¾Ð³Ð»Ð¾Ñ‚Ð¸Ð»Ð° ÑƒÑ€Ð¾Ð½!")
    if random.randint(1, 100) <= 25 and p.get("armor"):
     p["armor_durability"] = max(0, p["armor_durability"] - 1)
     messages.append("ðŸ”§ Ð‘Ñ€Ð¾Ð½Ñ Ð¿Ð¾Ð²Ñ€ÐµÐ¶Ð´ÐµÐ½Ð° (-1)!")
    save_data()
    if p["health"] <= 0:
     messages.append("\nðŸ’€ Ð’Ñ‹ Ð¿Ð¾Ð³Ð¸Ð±Ð»Ð¸ Ð² Ð°Ð½Ð¾Ð¼Ð°Ð»Ð¸Ð¸!")
     lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=5, max_money=50)
     messages.extend(format_death_losses(lost_items, money_lost))
     p["state"] = STATE_IN_MENU
     p["death_notified"] = True
     p["anomaly_path_choosing"] = False
     p["anomaly_safe_path"] = None
     save_data()
     send_message(user_id, "\n".join(messages), create_main_menu_keyboard(user_id), vk_session)
     return
    messages.append("")
   else:
    messages.append("âœ… Ð’Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ð»Ð¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ!")
    messages.append("")
   start_anomaly_map(user_id)
   p["state"] = STATE_ANOMALY_EXPLORE
   save_data()
   atype = p.get("current_anomaly_type", "Ð³Ñ€Ð°Ð²Ð¸")
   messages.append(f"ðŸŒ€ Ð’Ñ‹ Ð²Ð¾ÑˆÐ»Ð¸ Ð² Ð°Ð½Ð¾Ð¼Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð·Ð¾Ð½Ñƒ ({atype})")
   messages.append("Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ñ.")
   messages.append("ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ Ð¸ Ð¸Ð·Ð±ÐµÐ³Ð°Ð¹Ñ‚Ðµ Ð°Ð½Ð¾Ð¼Ð°Ð»Ð¸Ð¹!")
   alerts = get_detector_alerts(user_id)
   if alerts:
    messages.append(alerts)
   try:
    img_buffer = generate_anomaly_map_image(user_id)
    upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
    response = vk_session.http.post(upload_url, files={"photo": ("map.png", img_buffer, "image/png")})
    result = response.json()
    photo_data = vk_session.method("photos.saveMessagesPhoto", {"photo": result["photo"], "server": result["server"], "hash": result["hash"]})[0]
    vk_session.method("messages.send", {"user_id": user_id, "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}", "random_id": 0, "message": "\n".join(messages), "keyboard": create_anomaly_movement_keyboard().get_keyboard()})
   except Exception as e:
    logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÐºÐ°Ñ€Ñ‚Ñ‹: {e}")
    send_message(user_id, "\n".join(messages), create_anomaly_movement_keyboard(), vk_session)
   return
  if text == "ðŸšª Ð£Ð¹Ñ‚Ð¸":
   p["state"] = STATE_IN_MENU
   p["artifact_positions"] = []
   p["anomaly_positions"] = []
   p["anomaly_path_choosing"] = False
   save_data()
   send_message(user_id, "Ð’Ñ‹ Ð¿Ð¾ÐºÐ¸Ð½ÑƒÐ»Ð¸ Ð°Ð½Ð¾Ð¼Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð·Ð¾Ð½Ñƒ.", create_main_menu_keyboard(user_id), vk_session)
   return
  elif text in ["â¬†ï¸", "â¬‡ï¸", "â¬…ï¸", "âž¡ï¸"]:
   handle_anomaly_move(user_id, text, vk_session)
   return
  else:
   send_message(user_id, "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ñ.", create_anomaly_movement_keyboard(), vk_session)
   return
 if state == STATE_BELT_MAIN:
  if text == "âž• ÐŸÐ¾Ð²ÐµÑÐ¸Ñ‚ÑŒ":
   players[user_id]["state"] = STATE_BELT_SELECT_SLOT
   players[user_id]["belt_action"] = "equip"
   save_data()
   send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ð¾ÑÑ:", create_belt_slot_keyboard(), vk_session)
   return
  elif text == "âž– Ð¡Ð½ÑÑ‚ÑŒ":
   players[user_id]["state"] = STATE_BELT_SELECT_SLOT
   players[user_id]["belt_action"] = "unequip"
   save_data()
   send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ð¾ÑÑ Ð´Ð»Ñ ÑÐ½ÑÑ‚Ð¸Ñ:", create_belt_slot_keyboard(), vk_session)
   return
  elif text == "ðŸ’¡ Ð˜Ð½Ñ„Ð¾ Ð¾Ð± Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð°Ñ…":
   send_artifacts_info_with_image(user_id, create_belt_main_keyboard(), vk_session)
   return
  elif text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = STATE_IN_CAMP
   save_data()
   send_message(user_id, format_camp_info(user_id), create_camp_menu_keyboard(), vk_session)
   return
  elif text.lower().startswith("Ð¿Ð¾Ð²ÐµÑÐ¸Ñ‚ÑŒ "):
   art_name = text[9:].strip()
   for art in ALL_ARTIFACTS:
    if art.lower() == art_name.lower():
     if players[user_id]["backpack"].get(art, 0) > 0:
      belt = players[user_id].get("belt", [None, None, None])
      for i in range(3):
       if belt[i] is None:
        belt[i] = art
        players[user_id]["belt"] = belt
        players[user_id]["backpack"][art] -= 1
        if players[user_id]["backpack"][art] <= 0:
         del players[user_id]["backpack"][art]
        save_data()
        send_message(user_id, f"âœ… {art} Ð¿Ð¾Ð²ÐµÑˆÐµÐ½ Ð½Ð° Ð¿Ð¾ÑÑ {i+1}.", create_belt_main_keyboard(), vk_session)
        return
      send_message(user_id, "âŒ Ð’ÑÐµ Ð¿Ð¾ÑÑÐ° Ð·Ð°Ð½ÑÑ‚Ñ‹.", create_belt_main_keyboard(), vk_session)
      return
     else:
      send_message(user_id, "âŒ Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ ÑÑ‚Ð¾Ð³Ð¾ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð°.", create_belt_main_keyboard(), vk_session)
      return
   send_message(user_id, "âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚.", create_belt_main_keyboard(), vk_session)
   return
  elif text.lower().startswith("ÑÐ½ÑÑ‚ÑŒ "):
   art_name = text[6:].strip()
   belt = players[user_id].get("belt", [None, None, None])
   for i in range(3):
    if belt[i] and belt[i].lower() == art_name.lower():
     art = belt[i]
     belt[i] = None
     players[user_id]["belt"] = belt
     players[user_id]["backpack"][art] = players[user_id]["backpack"].get(art, 0) + 1
     save_data()
     send_message(user_id, f"âœ… {art} ÑÐ½ÑÑ‚ Ñ Ð¿Ð¾ÑÑÐ° {i+1}.", create_belt_main_keyboard(), vk_session)
     return
   send_message(user_id, "âŒ Ð­Ñ‚Ð¾Ñ‚ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ Ð½Ðµ Ð½Ð° Ð¿Ð¾ÑÑÐµ.", create_belt_main_keyboard(), vk_session)
   return
 if state == STATE_BELT_SELECT_SLOT:
  slot = -1
  if text == "1ï¸âƒ£ ÐŸÐ¾ÑÑ":
   slot = 0
  elif text == "2ï¸âƒ£ ÐŸÐ¾ÑÑ":
   slot = 1
  elif text == "3ï¸âƒ£ ÐŸÐ¾ÑÑ":
   slot = 2
  elif text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = STATE_BELT_MAIN
   save_data()
   belt = players[user_id].get("belt", [None, None, None])
   belt_info = (f"ðŸŸ¡ ÐŸÐ¾ÑÑ:\n1ï¸âƒ£ {belt[0] or 'Ð¿ÑƒÑÑ‚Ð¾'}\n2ï¸âƒ£ {belt[1] or 'Ð¿ÑƒÑÑ‚Ð¾'}\n3ï¸âƒ£ {belt[2] or 'Ð¿ÑƒÑÑ‚Ð¾'}\nðŸ’¡ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:\nÂ«ÐŸÐ¾Ð²ÐµÑÐ¸Ñ‚ÑŒ [Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚]Â»\nÂ«Ð¡Ð½ÑÑ‚ÑŒ [Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚]Â»")
   send_message(user_id, belt_info, create_belt_main_keyboard(), vk_session)
   return
  if slot >= 0:
   action = players[user_id].get("belt_action", "equip")
   belt = players[user_id].get("belt", [None, None, None])
   if action == "equip":
    if belt[slot] is not None:
     send_message(user_id, f"âŒ ÐŸÐ¾ÑÑ {slot+1} ÑƒÐ¶Ðµ Ð·Ð°Ð½ÑÑ‚ ({belt[slot]}).", create_belt_slot_keyboard(), vk_session)
     return
    available_arts = [art for art in ALL_ARTIFACTS if players[user_id]["backpack"].get(art, 0) > 0]
    if not available_arts:
     send_message(user_id, "âŒ Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð² Ð² Ð¸Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€Ðµ.", create_belt_slot_keyboard(), vk_session)
     return
    players[user_id]["pending_belt_slot"] = slot
    players[user_id]["state"] = STATE_BELT_SELECT_ARTIFACT
    players[user_id]["artifact_page"] = 0
    save_data()
    send_message(user_id, f"ðŸŸ¡ ÐšÐ°ÐºÐ¾Ð¹ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ Ð¿Ð¾Ð²ÐµÑÐ¸Ñ‚Ðµ Ð½Ð° Ð¿Ð¾ÑÑ {slot + 1}?\nÐ’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¸Ð· Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ…:", create_artifact_selection_keyboard(available_arts, 0), vk_session)
    return
   else:
    if belt[slot] is None:
     send_message(user_id, f"âŒ ÐŸÐ¾ÑÑ {slot+1} Ð¿ÑƒÑÑ‚.", create_belt_slot_keyboard(), vk_session)
     return
    art = belt[slot]
    belt[slot] = None
    players[user_id]["belt"] = belt
    players[user_id]["backpack"][art] = players[user_id]["backpack"].get(art, 0) + 1
    players[user_id]["state"] = STATE_BELT_MAIN
    save_data()
    send_message(user_id, f"âœ… {art} ÑÐ½ÑÑ‚ Ñ Ð¿Ð¾ÑÑÐ° {slot+1}.", create_belt_main_keyboard(), vk_session)
    return
 if state == STATE_BELT_SELECT_ARTIFACT:
  if text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = STATE_BELT_SELECT_SLOT
   players[user_id].pop("artifact_page", None)
   save_data()
   send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ð¾ÑÑ:", create_belt_slot_keyboard(), vk_session)
   return
  available_arts = [art for art in ALL_ARTIFACTS if players[user_id]["backpack"].get(art, 0) > 0]
  current_page = players[user_id].get("artifact_page", 0)
  if text == "â—€ï¸ Ð¢ÑƒÐ´Ð°":
   if current_page > 0:
    current_page -= 1
    players[user_id]["artifact_page"] = current_page
    save_data()
   slot = players[user_id].get("pending_belt_slot", 0)
   send_message(user_id, f"ðŸŸ¡ ÐšÐ°ÐºÐ¾Ð¹ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ Ð¿Ð¾Ð²ÐµÑÐ¸Ñ‚Ðµ Ð½Ð° Ð¿Ð¾ÑÑ {slot + 1}?\nÐ¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° {current_page + 1}:", create_artifact_selection_keyboard(available_arts, current_page), vk_session)
   return
  if text == "â–¶ï¸ Ð¡ÑŽÐ´Ð°":
   items_per_page = 6
   total_pages = (len(available_arts) + items_per_page - 1) // items_per_page
   if current_page < total_pages - 1:
    current_page += 1
    players[user_id]["artifact_page"] = current_page
    save_data()
   slot = players[user_id].get("pending_belt_slot", 0)
   send_message(user_id, f"ðŸŸ¡ ÐšÐ°ÐºÐ¾Ð¹ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ Ð¿Ð¾Ð²ÐµÑÐ¸Ñ‚Ðµ Ð½Ð° Ð¿Ð¾ÑÑ {slot + 1}?\nÐ¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° {current_page + 1}:", create_artifact_selection_keyboard(available_arts, current_page), vk_session)
   return
  for art in ALL_ARTIFACTS:
   if art.lower() == text.lower() or art[:20].lower() == text.lower():
    if players[user_id]["backpack"].get(art, 0) > 0:
     slot = players[user_id].get("pending_belt_slot", 0)
     belt = players[user_id].get("belt", [None, None, None])
     belt[slot] = art
     players[user_id]["belt"] = belt
     players[user_id]["backpack"][art] -= 1
     if players[user_id]["backpack"][art] <= 0:
      del players[user_id]["backpack"][art]
     players[user_id]["state"] = STATE_BELT_MAIN
     players[user_id].pop("artifact_page", None)
     save_data()
     send_message(user_id, f"âœ… {art} Ð¿Ð¾Ð²ÐµÑˆÐµÐ½ Ð½Ð° Ð¿Ð¾ÑÑ {slot + 1}.", create_belt_main_keyboard(), vk_session)
     return
  slot = players[user_id].get("pending_belt_slot", 0)
  send_message(user_id, f"âŒ ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¸Ð»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚ Ð² Ð¸Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€Ðµ.\nðŸŸ¡ ÐšÐ°ÐºÐ¾Ð¹ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ Ð¿Ð¾Ð²ÐµÑÐ¸Ñ‚Ðµ Ð½Ð° Ð¿Ð¾ÑÑ {slot + 1}?", create_artifact_selection_keyboard(available_arts, current_page), vk_session)
  return
 if state == STATE_USING_ITEM:
  if text.lower() == "Ð¾Ñ‚Ð¼ÐµÐ½Ð°":
   players[user_id]["state"] = STATE_IN_BACKPACK
   save_data()
   send_message(user_id, format_backpack_info(user_id), create_backpack_menu_keyboard(), vk_session)
   return
  else:
   use_item(user_id, text, vk_session)
   players[user_id]["state"] = STATE_IN_BACKPACK
   save_data()
   return
 if state == STATE_TRADER_MAIN:
  if not is_player_on_own_territory(user_id) and not has_active_donation(user_id):
   send_message(user_id, "âŒ Ð¢Ð¾Ñ€Ð³Ð¾Ð²ÐµÑ† Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð½Ð° Ð²Ñ€Ð°Ð¶ÐµÑÐºÐ¾Ð¹ Ñ‚ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸.", create_main_menu_keyboard(user_id), vk_session)
   players[user_id]["state"] = STATE_IN_MENU
   save_data()
   return
  if text == "ðŸ’² ÐŸÑ€Ð¸Ð¾Ð±Ñ€ÐµÑÑ‚Ð¸":
   players[user_id]["state"] = STATE_TRADER_BUY_CATEGORY
   save_data()
   send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ:", create_trader_category_keyboard(), vk_session)
   return
  elif text == "ðŸ’± ÐŸÑ€Ð¾Ð´Ð°Ñ‚ÑŒ":
   players[user_id]["state"] = STATE_TRADER_SELL_CATEGORY
   save_data()
   send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ:", create_trader_sell_category_keyboard(), vk_session)
   return
  elif text == "âš™ï¸ ÐŸÐ¾Ñ‡Ð¸Ð½Ð¸Ñ‚ÑŒ":
   players[user_id]["state"] = STATE_TRADER_REPAIR
   save_data()
   p = players[user_id]
   money = p.get("money", 0)
   weapon = p.get("weapon", None)
   weapon_dur = p.get("weapon_durability", 0)
   weapon_max_dur = p.get("weapon_max_durability", 0)
   armor = p.get("armor", None)
   armor_dur = p.get("armor_durability", 0)
   armor_max_dur = p.get("armor_max_durability", 0)
   repair_text = (f"âš™ï¸ Ð§Ñ‚Ð¾ ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÑ‚ÐµÑÑŒ Ð¿Ð¾Ñ‡Ð¸Ð½Ð¸Ñ‚ÑŒ? ðŸ§\nâ—ï¸ Ð ÐµÐ¼Ð¾Ð½Ñ‚ Ð½Ð° 1 ÐµÐ´Ð¸Ð½Ð¸Ñ†Ñƒ Ð¾ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð»ÑÐµÑ‚ÑÑ Ð·Ð° 15Ñ€\nðŸ’² Ð”ÐµÐ½ÑŒÐ³Ð¸: {money}Ñ€\nÂ«ðŸª– Ð‘Ñ€Ð¾Ð½Ñ: {'Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚' if not armor else armor} ðŸ”§{armor_dur}/{armor_max_dur}\nÂ«ðŸ”« ÐžÑ€ÑƒÐ¶Ð¸Ðµ: {'Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚' if not weapon else weapon} ðŸ”§{weapon_dur}/{weapon_max_dur}")
   send_message(user_id, repair_text, create_repair_keyboard(user_id), vk_session)
   return
  elif text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = STATE_IN_MENU
   save_data()
   send_message(user_id, MAIN_MENU_TEXT, create_main_menu_keyboard(user_id), vk_session)
   return
 if state == STATE_TRADER_BUY_CATEGORY:
  if text == "ðŸ¥« ÐŸÑ€Ð¾Ð²Ð¸Ð·Ð¸Ñ":
   show_buy_provisions_menu(user_id, vk_session)
   return
  elif text == "ðŸª– Ð¡Ð½Ð°Ñ€ÑÐ¶ÐµÐ½Ð¸Ðµ":
   players[user_id]["state"] = STATE_TRADER_BUY_EQUIPMENT
   save_data()
   send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‚Ð¸Ð¿ ÑÐ½Ð°Ñ€ÑÐ¶ÐµÐ½Ð¸Ñ:", create_equipment_category_keyboard(), vk_session)
   return
  elif text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = STATE_TRADER_MAIN
   save_data()
   send_message(user_id, "Ð’Ñ‹ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ñ‡Ñ‚Ð¾ Ð»Ð¸Ð±Ð¾ ðŸ’² Ð¿Ñ€Ð¸Ð¾Ð±Ñ€ÐµÑÑ‚Ð¸ Ð¸Ð»Ð¸ ðŸ’± Ð¿Ñ€Ð¾Ð´Ð°Ñ‚ÑŒ?", create_trader_main_keyboard(), vk_session)
   return
 if state == STATE_TRADER_SELL_CATEGORY:
  if text == "ðŸ¥« ÐŸÑ€Ð¾Ð²Ð¸Ð·Ð¸Ñ":
   show_sell_provisions_menu(user_id, vk_session)
   return
  elif text == "ðŸª– Ð¡Ð½Ð°Ñ€ÑÐ¶ÐµÐ½Ð¸Ðµ":
   players[user_id]["state"] = STATE_TRADER_SELL_EQUIPMENT_CONFIRM
   save_data()
   send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ ÑÐ½Ð°Ñ€ÑÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð¸:", create_equipment_sell_keyboard(), vk_session)
   return
  elif text == "ðŸŒ• ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹":
   show_sell_artifacts_menu(user_id, vk_session)
   return
  elif text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = STATE_TRADER_MAIN
   save_data()
   send_message(user_id, "Ð’Ñ‹ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ñ‡Ñ‚Ð¾ Ð»Ð¸Ð±Ð¾ ðŸ’² Ð¿Ñ€Ð¸Ð¾Ð±Ñ€ÐµÑÑ‚Ð¸ Ð¸Ð»Ð¸ ðŸ’± Ð¿Ñ€Ð¾Ð´Ð°Ñ‚ÑŒ?", create_trader_main_keyboard(), vk_session)
   return
 if state == STATE_TRADER_SELL_ARTIFACTS:
  if text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = STATE_TRADER_SELL_CATEGORY
   save_data()
   send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ:", create_trader_sell_category_keyboard(), vk_session)
   return
  else:
   handle_trader_sell_artifact(user_id, text, vk_session)
   return
 if state == STATE_TRADER_BUY:
  if text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = STATE_TRADER_BUY_CATEGORY
   save_data()
   send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ:", create_trader_category_keyboard(), vk_session)
   return
  else:
   handle_trader_buy(user_id, text, vk_session)
   return
 if state == STATE_TRADER_SELL:
  if text == "ðŸŽ’ Ð ÑŽÐºÐ·Ð°Ðº":
   upload_and_send_inventory(user_id, vk_session)
   return
  elif text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = STATE_TRADER_SELL_CATEGORY
   save_data()
   send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ:", create_trader_sell_category_keyboard(), vk_session)
   return
  else:
   handle_trader_sell(user_id, text, vk_session)
   return
 if state == STATE_TRADER_BUY_EQUIPMENT:
  if text == "ðŸ”« ÐžÑ€ÑƒÐ¶Ð¸Ðµ":
   eq_type = "weapon"
  elif text == "ðŸ¦º Ð‘Ñ€Ð¾Ð½Ñ":
   eq_type = "armor"
  elif text == "ðŸ“Ÿ Ð”ÐµÑ‚ÐµÐºÑ‚Ð¾Ñ€Ñ‹":
   eq_type = "detector"
  elif text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = STATE_TRADER_BUY_CATEGORY
   save_data()
   send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ:", create_trader_category_keyboard(), vk_session)
   return
  else:
   send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‚Ð¸Ð¿ ÑÐ½Ð°Ñ€ÑÐ¶ÐµÐ½Ð¸Ñ:", create_equipment_category_keyboard(), vk_session)
   return
  faction = players[user_id]["faction"]
  money = players[user_id].get("money", 0)
  if eq_type == "detector":
   msg_lines = [f"ðŸ’² Ð’Ð°ÑˆÐ¸ Ð´ÐµÐ½ÑŒÐ³Ð¸: {money}Ñ€", "", "ðŸ“Ÿ Ð”Ð•Ð¢Ð•ÐšÐ¢ÐžÐ Ð«", ""]
   sorted_detectors = sorted(DETECTORS.items(), key=lambda x: x[1]["price"])
   num = 1
   for name, data in sorted_detectors:
    msg_lines.append(f"{num}ï¸âƒ£ Â«{name}Â» â€” ðŸ’°{data['price']}Ñ€ (âš¡{data['charge']})")
    num += 1
   msg_lines.append("")
   msg_lines.append("ðŸ“Œ âš¡ â€” Ð·Ð°Ñ€ÑÐ´")
   msg_lines.append("")
   msg_lines.append("âœï¸ ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ñ‚Ð¾Ñ‡Ð½Ð¾Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð´ÐµÑ‚ÐµÐºÑ‚Ð¾Ñ€Ð° Ð´Ð»Ñ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ¸:")
   send_message(user_id, "\n".join(msg_lines), create_back_only_keyboard(), vk_session)
   players[user_id]["pending_buy_type"] = "detector"
   players[user_id]["state"] = STATE_TRADER_BUY_EQUIPMENT_CONFIRM
   save_data()
   return
  items = EQUIPMENT[faction][eq_type]
  if eq_type == "weapon":
   sorted_items = sorted(items, key=lambda x: x[4])
   msg_lines = [f"ðŸ’² Ð’Ð°ÑˆÐ¸ Ð´ÐµÐ½ÑŒÐ³Ð¸: {money}Ñ€", "", f"ðŸ”« ÐžÐ Ð£Ð–Ð˜Ð• ({faction})", ""]
   for i, item in enumerate(sorted_items, 1):
    name, dur, dmg, acc, price = item
    msg_lines.append(f"{i}ï¸âƒ£ {name} â€” ðŸ’°{price}Ñ€")
    msg_lines.append(f"   ðŸ”§[{dur}/{dur}] ; ðŸ’¢[{dmg}] ; ðŸŽ¯[{acc}]")
   msg_lines.append("")
   msg_lines.append("âœï¸ ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ñ‚Ð¾Ñ‡Ð½Ð¾Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð´Ð»Ñ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ¸:")
  else:
   sorted_items = sorted(items, key=lambda x: x[5])
   msg_lines = [f"ðŸ’² Ð’Ð°ÑˆÐ¸ Ð´ÐµÐ½ÑŒÐ³Ð¸: {money}Ñ€", "", f"ðŸ¦º Ð‘Ð ÐžÐÐ¯ ({faction})", ""]
   for i, item in enumerate(sorted_items, 1):
    name, dur, shield, blast, anom, price = item
    msg_lines.append(f"{i}ï¸âƒ£ {name} â€” ðŸ’°{price}Ñ€")
    msg_lines.append(f"   ðŸ”§[{dur}/{dur}] ; ðŸ›¡ï¸[{shield}] ; ðŸ¾[{blast}] ; ðŸ’¥[{anom}]")
   msg_lines.append("")
   msg_lines.append("âœï¸ ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ñ‚Ð¾Ñ‡Ð½Ð¾Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð´Ð»Ñ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ¸:")
  send_message(user_id, "\n".join(msg_lines), create_back_only_keyboard(), vk_session)
  players[user_id]["pending_buy_type"] = eq_type
  players[user_id]["state"] = STATE_TRADER_BUY_EQUIPMENT_CONFIRM
  save_data()
  return
 if state == STATE_TRADER_BUY_EQUIPMENT_CONFIRM:
  if text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = STATE_TRADER_BUY_EQUIPMENT
   players[user_id]["pending_buy_type"] = None
   save_data()
   send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‚Ð¸Ð¿ ÑÐ½Ð°Ñ€ÑÐ¶ÐµÐ½Ð¸Ñ:", create_equipment_category_keyboard(), vk_session)
   return
  item_name = text.strip()
  item_type = players[user_id].get("pending_buy_type")
  faction = players[user_id]["faction"]
  valid_names = []
  if item_type == "detector":
   valid_names = list(DETECTORS.keys())
  else:
   valid_names = [item[0] for item in EQUIPMENT[faction][item_type]]
  if item_name in valid_names:
   price = None
   if item_type == "detector":
    price = DETECTORS[item_name]["price"]
   else:
    for item in EQUIPMENT[faction][item_type]:
     if item[0] == item_name:
      price = item[4] if item_type == "weapon" else item[5]
      break
   if players[user_id]["money"] < price:
    send_message(user_id, f"âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´ÐµÐ½ÐµÐ³. ÐÑƒÐ¶Ð½Ð¾ {price}Ñ€.", create_back_only_keyboard(), vk_session)
    return
   players[user_id]["pending_buy_item"] = item_name
   send_message(user_id, f"Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÐºÑƒÐ¿Ð¸Ñ‚ÑŒ {item_name} Ð·Ð° {price}Ñ€?", create_confirmation_keyboard(), vk_session)
   players[user_id]["state"] = "confirming_equipment_buy"
   save_data()
  else:
   send_message(user_id, "âŒ ÐÐµÐ²ÐµÑ€Ð½Ð¾Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°:", create_back_only_keyboard(), vk_session)
  return
 if state == "confirming_equipment_buy":
  handle_equipment_buy_confirmation(user_id, text, vk_session)
  return
 if state == STATE_TRADER_SELL_EQUIPMENT_CONFIRM:
  handle_equipment_sell_confirmation(user_id, text, vk_session)
  return
 if state == STATE_TRADER_SELL_EQUIPMENT:
  if text == "âœ… Ð”Ð°" or text == "âŒ ÐÐµÑ‚":
   handle_equipment_sell_final(user_id, text, vk_session)
   return
  else:
   send_message(user_id, "ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ:", create_confirmation_keyboard(), vk_session)
  return
 if state == STATE_TRADER_REPAIR:
  handle_repair(user_id, text, vk_session)
  return
 if text.lower() == "/start":
  players[user_id]["state"] = STATE_WAITING_FOR_START
  save_data()
  send_message(user_id, f"ÐŸÑ€Ð¸Ð²ÐµÑ‚, {players[user_id]['name']}! ðŸ‘‹\nÐÐ°Ð¶Ð¼Ð¸ ÐºÐ½Ð¾Ð¿ÐºÑƒ Â«Ð¡Ñ‚Ð°Ñ€Ñ‚Â», Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð¸Ð³Ñ€Ñƒ.", create_start_keyboard(), vk_session)
  return
 if state == STATE_WAITING_FOR_START:
  if text == "Ð¡Ñ‚Ð°Ñ€Ñ‚":
   players[user_id]["state"] = STATE_READING_INSTRUCTIONS
   save_data()
   send_message(user_id, GAME_INFO_TEXT, create_next_keyboard(), vk_session)
   return
 if state == STATE_READING_INSTRUCTIONS:
  if text == "Ð”Ð°Ð»ÐµÐµ":
   players[user_id]["state"] = STATE_CHOOSING_FACTION
   save_data()
   send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸ ÑÐ²Ð¾ÑŽ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÑƒ:", create_faction_keyboard(), vk_session)
   return
 if state == STATE_CHOOSING_FACTION:
  faction_name = None
  if "Ð”Ð¾Ð»Ð³" in text:
   faction_name = "ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³"
  elif "Ð“Ñ€ÐµÑ…" in text:
   faction_name = "â˜¦ï¸ Ð“Ñ€ÐµÑ…"
  elif "ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸" in text:
   faction_name = "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸"
  if faction_name:
   if len(factions[faction_name]) >= MAX_FACTION_SIZES[faction_name]:
    all_full = True
    for f in factions:
     if len(factions[f]) < MAX_FACTION_SIZES[f]:
      all_full = False
      break
    if all_full:
     send_message(user_id, "â³ Ð’ÑÐµ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¸ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹. Ð”Ð¾Ð¶Ð´Ð¸Ñ‚ÐµÑÑŒ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð½Ð¾Ð²Ñ‹Ñ… Ð¼ÐµÑÑ‚.", create_faction_keyboard(), vk_session)
    else:
     send_message(user_id, f"âŒ Ð’ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐµ Â«{faction_name}Â» ÑƒÐ¶Ðµ Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð². Ð’Ñ‹Ð±ÐµÑ€Ð¸ Ð´Ñ€ÑƒÐ³ÑƒÑŽ.", create_faction_keyboard(), vk_session)
   else:
    was_closed = not is_game_open()
    factions[faction_name].append(user_id)
    players[user_id]["faction"] = faction_name
    start_loc, start_point = find_start_position(faction_name)
    players[user_id]["location"] = start_loc
    players[user_id]["point"] = start_point
    players[user_id]["state"] = STATE_ENTERING_NICKNAME
    save_data()
    chat_link = FACTION_CHAT_LINKS.get(faction_name, "")
    send_message(user_id, f"âœ… Ð’Ñ‹ Ð²ÑÑ‚ÑƒÐ¿Ð¸Ð»Ð¸ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÑƒ {faction_name}!\n\nðŸ’¬ Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ð° Ð±ÐµÑÐµÐ´Ñƒ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¸:\n{chat_link}\n\nÐ¢ÐµÐ¿ÐµÑ€ÑŒ Ð¿Ñ€Ð¸Ð´ÑƒÐ¼Ð°Ð¹ ÑÐµÐ±Ðµ ÐºÐ»Ð¸Ñ‡ÐºÑƒ Ð² Ð—Ð¾Ð½Ðµ:", None, vk_session)
   return
 if state == STATE_ENTERING_NICKNAME:
  nickname = text.strip()
  if nickname:
   players[user_id]["nickname"] = nickname
   players[user_id]["state"] = STATE_IN_MENU
   save_data()
   send_message(user_id, f"Ð£Ð´Ð°Ñ‡Ð½Ð¾Ð¹ Ð¾Ñ…Ð¾Ñ‚Ñ‹, {nickname}! ðŸŽ¯\n{MAIN_MENU_TEXT}", create_main_menu_keyboard(user_id), vk_session)
  return
 if state == STATE_IN_MENU:
  if text == "ðŸ•ï¸ Ð›Ð°Ð³ÐµÑ€ÑŒ":
   players[user_id]["state"] = STATE_IN_CAMP
   save_data()
   send_message(user_id, format_camp_info(user_id), create_camp_menu_keyboard(), vk_session)
  elif text == "ðŸ‘£ ÐŸÐµÑ€ÐµÑ…Ð¾Ð´":
   players[user_id]["state"] = STATE_IN_TRANSITION_MENU
   save_data()
   current_loc = players[user_id]["location"]
   current_point = players[user_id]["point"]
   send_location_image(user_id, current_loc, current_point, f"ðŸ“ Ð’Ð°ÑˆÐµ Ð¼ÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ: {current_loc} {current_point}\nÐ’Ñ‹Ð±ÐµÑ€Ð¸ Ð»Ð¾ÐºÐ°Ñ†Ð¸ÑŽ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð°:", create_transition_keyboard(user_id), vk_session)
  elif text == get_main_menu_button(players[user_id]["point"], players[user_id]["location"]):
   handle_exploration(user_id, vk_session)
   return
  elif text == "ðŸ›’ Ð¢Ð¾Ñ€Ð³Ð¾Ð²ÐµÑ†":
   players[user_id]["state"] = STATE_TRADER_MAIN
   save_data()
   send_message(user_id, "Ð’Ñ‹ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ñ‡Ñ‚Ð¾ Ð»Ð¸Ð±Ð¾ ðŸ’² Ð¿Ñ€Ð¸Ð¾Ð±Ñ€ÐµÑÑ‚Ð¸ Ð¸Ð»Ð¸ ðŸ’± Ð¿Ñ€Ð¾Ð´Ð°Ñ‚ÑŒ?", create_trader_main_keyboard(), vk_session)
   return
  elif text == "ðŸ§° Ð¡ÐºÐ»Ð°Ð´":
   players[user_id]["state"] = STATE_WAREHOUSE
   save_data()
   upload_and_send_warehouse_global(user_id, vk_session)
   return
  elif text == "âš”ï¸ Ð’Ð¾Ð¹Ð½Ð° Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²Ð¾Ðº":
   players[user_id]["state"] = STATE_WAR_MAIN
   save_data()
   send_message(user_id, "âš”ï¸ Ð’Ð¾Ð¹Ð½Ð° Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²Ð¾Ðº â€” Ð·Ð°Ñ…Ð²Ð°Ñ‚Ñ‹Ð²Ð°Ð¹ Ñ‚ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸ Ð¸ Ñ€Ð°Ð·Ð²Ð¸Ð²Ð°Ð¹ ÑÐ²Ð¾ÑŽ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÑƒ!", create_war_main_keyboard(), vk_session)
   return
  else:
   send_message(user_id, MAIN_MENU_TEXT, create_main_menu_keyboard(user_id), vk_session)
  return
 if state == STATE_IN_TRANSITION_MENU:
  if text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = STATE_IN_MENU
   save_data()
   send_message(user_id, MAIN_MENU_TEXT, create_main_menu_keyboard(user_id), vk_session)
   return
  current_loc = players[user_id]["location"]
  current_point = players[user_id]["point"]
  if text == f"â–¶ï¸ {current_loc} â—€ï¸":
   players[user_id]["state"] = STATE_WAITING_FOR_POINT
   save_data()
   if not send_location_map(user_id, current_loc, vk_session):
    send_message(user_id, 'ðŸŒ Ð’Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ð¾Ñ‡ÐºÐ¸ Ð½Ð° ÐºÐ°Ñ€Ñ‚Ðµ, Ð½Ð° ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÑ‚ÐµÑÑŒ Ð¿ÐµÑ€ÐµÐ¹Ñ‚Ð¸:\nâ• ÐŸÑ€Ð¸Ð¼ÐµÑ€: "Ð¢Ð 1", "Ð‘1".', None, vk_session)
   return
  elif text in ["ÐšÐ¾Ñ€Ð´Ð¾Ð½", "Ð¡Ð²Ð°Ð»ÐºÐ°", "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "ÐŸÐ¾Ð»ÑÐ½Ð°"]:
   if text == current_loc:
    send_message(user_id, "Ð’Ñ‹ ÑƒÐ¶Ðµ Ð·Ð´ÐµÑÑŒ.", create_transition_keyboard(user_id), vk_session)
    return
   if can_transition_from(current_loc, current_point):
    transitions = get_available_transitions(current_loc, current_point)
    target = None
    for (tloc, tpoint) in transitions:
     if tloc == text:
      target = (tloc, tpoint)
      break
    if target:
     players[user_id]["pending_transition"] = target
     players[user_id]["state"] = STATE_CONFIRMING_TRANSITION
     save_data()
     send_message(user_id, f"Ð’Ñ‹ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¿ÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð½Ð° {target[0]} {target[1]}?", create_confirmation_keyboard(), vk_session)
    else:
     send_message(user_id, "âŒ ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð½Ð° ÑÑ‚Ñƒ Ð»Ð¾ÐºÐ°Ñ†Ð¸ÑŽ Ð½ÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶ÐµÐ½ Ð¸Ð· Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¼ÐµÑÑ‚Ð°.", create_transition_keyboard(user_id), vk_session)
   else:
    send_message(user_id, "âŒ Ð˜Ð· ÑÑ‚Ð¾Ð¹ Ñ‚Ð¾Ñ‡ÐºÐ¸ Ð½ÐµÐ»ÑŒÐ·Ñ Ð¿ÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð½Ð° Ð´Ñ€ÑƒÐ³ÑƒÑŽ Ð»Ð¾ÐºÐ°Ñ†Ð¸ÑŽ.", create_transition_keyboard(user_id), vk_session)
   return
  return
 if state == STATE_CONFIRMING_TRANSITION:
  pending = players[user_id].get("pending_transition")
  if not pending:
   players[user_id]["state"] = STATE_IN_TRANSITION_MENU
   save_data()
   send_message(user_id, "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ.", create_transition_keyboard(user_id), vk_session)
   return
  if text == "âœ… Ð”Ð°":
   target_loc, target_point = pending
   target_owner = get_territory_owner(target_loc, target_point)
   player_faction = players[user_id]["faction"]
   if target_owner is not None and target_owner != player_faction:
    send_message(user_id, "âŒ Ð­Ñ‚Ð° Ñ‚ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ð½Ðµ Ð¿Ñ€Ð¸Ð½Ð°Ð´Ð»ÐµÐ¶Ð¸Ñ‚ Ð²Ð°ÑˆÐµÐ¹ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐµ. ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð½ÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶ÐµÐ½.", create_transition_keyboard(user_id), vk_session)
    players[user_id]["state"] = STATE_IN_TRANSITION_MENU
    players[user_id].pop("pending_transition", None)
    save_data()
    return
   ok, msg = check_vital_conditions(user_id, "Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´")
   if not ok:
    send_message(user_id, msg, create_transition_keyboard(user_id), vk_session)
    players[user_id]["state"] = STATE_IN_TRANSITION_MENU
    players[user_id].pop("pending_transition", None)
    save_data()
    return
   players[user_id]["previous_location"] = players[user_id]["location"]
   players[user_id]["previous_point"] = players[user_id]["point"]
   players[user_id]["stamina"] -= 3
   players[user_id]["hunger"] += 2
   players[user_id]["location"], players[user_id]["point"] = target_loc, target_point
   transition_time = 1800
   if has_active_donation(user_id):
    transition_time = 900
   players[user_id]["transition_end_time"] = time.time() + transition_time
   players[user_id]["state"] = STATE_TRANSITION_WAIT
   save_data()
   time_text = "30 Ð¼Ð¸Ð½ÑƒÑ‚" if transition_time == 1800 else "15 Ð¼Ð¸Ð½ÑƒÑ‚"
   send_message(user_id, f"ðŸš¶â€â™‚ï¸ Ð’Ñ‹ Ð½Ð°Ñ‡Ð°Ð»Ð¸ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´ Ð½Ð° {target_loc} {target_point}. ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ: {time_text}.", None, vk_session)
   return
  elif text == "âŒ ÐÐµÑ‚":
   players[user_id]["state"] = STATE_IN_TRANSITION_MENU
   players[user_id].pop("pending_transition", None)
   save_data()
   send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸ Ð»Ð¾ÐºÐ°Ñ†Ð¸ÑŽ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð°:", create_transition_keyboard(user_id), vk_session)
   return
  return
 if state == STATE_WAITING_FOR_POINT:
  point = text.upper().strip()
  current_loc = players[user_id]["location"]
  current_point = players[user_id]["point"]
  if point == current_point:
   send_message(user_id, "âŒ Ð’Ñ‹ ÑƒÐ¶Ðµ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÐµÑÑŒ Ð½Ð° ÑÑ‚Ð¾Ð¹ Ñ‚Ð¾Ñ‡ÐºÐµ.", create_main_menu_keyboard(user_id), vk_session)
   players[user_id]["state"] = STATE_IN_MENU
   save_data()
   return
  if is_valid_point(current_loc, point):
   target_owner = get_territory_owner(current_loc, point)
   player_faction = players[user_id]["faction"]
   if target_owner is not None and target_owner != player_faction:
    send_message(user_id, "âŒ Ð­Ñ‚Ð° Ñ‚ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ð½Ðµ Ð¿Ñ€Ð¸Ð½Ð°Ð´Ð»ÐµÐ¶Ð¸Ñ‚ Ð²Ð°ÑˆÐµÐ¹ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐµ. ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð½ÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶ÐµÐ½.", create_main_menu_keyboard(user_id), vk_session)
    players[user_id]["state"] = STATE_IN_MENU
    save_data()
    return
   ok, msg = check_vital_conditions(user_id, "Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´")
   if not ok:
    send_message(user_id, msg, create_main_menu_keyboard(user_id), vk_session)
    players[user_id]["state"] = STATE_IN_MENU
    save_data()
    return
   players[user_id]["previous_location"] = players[user_id]["location"]
   players[user_id]["previous_point"] = players[user_id]["point"]
   players[user_id]["stamina"] -= 3
   players[user_id]["hunger"] += 2
   players[user_id]["point"] = point
   transition_time = 1800
   if has_active_donation(user_id):
    transition_time = 900
   players[user_id]["transition_end_time"] = time.time() + transition_time
   players[user_id]["state"] = STATE_TRANSITION_WAIT
   save_data()
   time_text = "30 Ð¼Ð¸Ð½ÑƒÑ‚" if transition_time == 1800 else "15 Ð¼Ð¸Ð½ÑƒÑ‚"
   send_message(user_id, f"ðŸš¶â€â™‚ï¸ Ð’Ñ‹ Ð½Ð°Ñ‡Ð°Ð»Ð¸ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´ Ð½Ð° {current_loc} {point}. ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ: {time_text}.", None, vk_session)
  else:
   send_message(user_id, f"âŒ Ð¢Ð°ÐºÐ¾Ð¹ Ñ‚Ð¾Ñ‡ÐºÐ¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð² Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸ Â«{current_loc}Â».", create_main_menu_keyboard(user_id), vk_session)
   players[user_id]["state"] = STATE_IN_MENU
   save_data()
  return
 if state == STATE_IN_CAMP:
  if text == "ðŸŽ’ Ð ÑŽÐºÐ·Ð°Ðº":
   players[user_id]["state"] = STATE_IN_BACKPACK
   save_data()
   upload_and_send_inventory(user_id, vk_session)
   return
  elif text == "ðŸŸ¡ ÐŸÐ¾ÑÑ":
   players[user_id]["state"] = STATE_BELT_MAIN
   save_data()
   belt = players[user_id].get("belt", [None, None, None])
   belt_info = (f"ðŸŸ¡ ÐŸÐ¾ÑÑ:\n1ï¸âƒ£ {belt[0] or 'Ð¿ÑƒÑÑ‚Ð¾'}\n2ï¸âƒ£ {belt[1] or 'Ð¿ÑƒÑÑ‚Ð¾'}\n3ï¸âƒ£ {belt[2] or 'Ð¿ÑƒÑÑ‚Ð¾'}\nðŸ’¡ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:\nÂ«ÐŸÐ¾Ð²ÐµÑÐ¸Ñ‚ÑŒ [Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚]Â»\nÂ«Ð¡Ð½ÑÑ‚ÑŒ [Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚]Â»")
   send_message(user_id, belt_info, create_belt_main_keyboard(), vk_session)
   return
  elif text == "ðŸ’¤ ÐžÑ‚Ð´Ñ‹Ñ…":
   players[user_id]["state"] = STATE_RESTING
   players[user_id]["rest_start_time"] = time.time()
   players[user_id]["initial_stamina"] = players[user_id]["stamina"]
   save_data()
   stamina = players[user_id]["stamina"]
   rest_text = (f"âš¡ Ð’Ð°ÑˆÐ° Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ: {stamina}/10\nðŸ˜´ Ð’Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð¾Ñ‚Ð´Ñ‹Ñ…Ð°, Ð²Ð°ÑˆÐ° Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ Ð¿Ð¾Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð½Ð° 1 ÐºÐ°Ð¶Ð´Ñ‹Ðµ 6 Ð¼Ð¸Ð½ÑƒÑ‚.\nâš¡ Ð’Ñ‹Ð¿Ð¸Ð² ÑÑ‚Ð¸Ð¼ÑƒÐ»Ð¸Ñ€ÑƒÑŽÑ‰Ð¸Ð¹ Ð½Ð°Ð¿Ð¸Ñ‚Ð¾Ðº, Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¿Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ ÑÐ²Ð¾ÑŽ Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ\nðŸŒ• Ð¢Ð°ÐºÐ¶Ðµ, Ð½ÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ Ð¼Ð¾Ð³ÑƒÑ‚ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°Ñ‚ÑŒ Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ Ð² Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ñ€Ð°Ð· Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ")
   send_message(user_id, rest_text, create_resting_keyboard(), vk_session)
   return
  elif text == "ðŸ”‹ ÐŸÐ¾Ð´Ð·Ð°Ñ€ÑÐ´ÐºÐ°":
   p = players[user_id]
   detector = p.get("detector")
   detector_charge = p.get("detector_charge", 0)
   detector_max_charge = p.get("detector_max_charge", 0)
   if not detector or detector_max_charge <= 0:
    send_message(user_id, "âŒ Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ Ð´ÐµÑ‚ÐµÐºÑ‚Ð¾Ñ€Ð°.", create_camp_menu_keyboard(), vk_session)
    return
   if detector_charge >= detector_max_charge:
    send_message(user_id, "ðŸ”‹ Ð”ÐµÑ‚ÐµÐºÑ‚Ð¾Ñ€ ÑƒÐ¶Ðµ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð·Ð°Ñ€ÑÐ¶ÐµÐ½.", create_camp_menu_keyboard(), vk_session)
    return
   batteries_needed = detector_max_charge - detector_charge
   batteries_have = p["backpack"].get("Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸", 0)
   if batteries_have <= 0:
    send_message(user_id, "âŒ Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ Ð±Ð°Ñ‚Ð°Ñ€ÐµÐµÐº Ð´Ð»Ñ Ð¿Ð¾Ð´Ð·Ð°Ñ€ÑÐ´ÐºÐ¸.", create_camp_menu_keyboard(), vk_session)
    return
   batteries_used = min(batteries_needed, batteries_have)
   p["detector_charge"] = detector_charge + batteries_used
   p["backpack"]["Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸"] -= batteries_used
   if p["backpack"]["Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸"] <= 0:
    del p["backpack"]["Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸"]
   save_data()
   send_message(user_id, f"âœ… Ð”ÐµÑ‚ÐµÐºÑ‚Ð¾Ñ€ Ð·Ð°Ñ€ÑÐ¶ÐµÐ½ Ð½Ð° {batteries_used} ÐµÐ´Ð¸Ð½Ð¸Ñ†.\nðŸ“Ÿ Ð—Ð°Ñ€ÑÐ´: {p['detector_charge']}/{detector_max_charge}", create_camp_menu_keyboard(), vk_session)
   return
  elif text.startswith("ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð²Ñ‹Ð±Ñ€Ð¾ÑÐ°:"):
   status = get_emission_status()
   next_time = get_next_emission_time()
   if next_time:
    remaining = next_time - time.time()
    mins = int(remaining // 60)
    hours = mins // 60
    mins_left = mins % 60
    if hours > 0:
     time_str = f"{hours} Ñ‡ {mins_left} Ð¼Ð¸Ð½"
    else:
     time_str = f"{mins_left} Ð¼Ð¸Ð½"
   else:
    time_str = "Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾"
   restored_text = ", ".join(last_restored_categories) if last_restored_categories else "Ð½ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…"
   msg = (f"ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð²Ñ‹Ð±Ñ€Ð¾ÑÐ°: {status}\nâ™»ï¸ ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ:\n{restored_text}")
   send_message(user_id, msg, create_camp_menu_keyboard(), vk_session)
   return
  elif text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = STATE_IN_MENU
   save_data()
   send_message(user_id, MAIN_MENU_TEXT, create_main_menu_keyboard(user_id), vk_session)
   return
 if state == STATE_IN_BACKPACK:
  if text in ["ÐÐ°Ð·Ð°Ð´", "ðŸ”š ÐÐ°Ð·Ð°Ð´"]:
   players[user_id]["state"] = STATE_IN_CAMP
   save_data()
   send_message(user_id, format_camp_info(user_id), create_camp_menu_keyboard(), vk_session)
   return
  elif text == "â‡ï¸ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ":
   players[user_id]["state"] = STATE_USING_ITEM
   save_data()
   send_message(user_id, "ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð° Ð¸ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: Ñ…Ð»ÐµÐ± 2):", create_use_item_keyboard(), vk_session)
   return
  elif text == "â™»ï¸ Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ°":
   current = get_sort_mode(user_id)
   set_sort_mode(user_id, current + 1)
   mode_names = ["Ð¾Ð±Ñ‹Ñ‡Ð½Ð°Ñ", "Ð¿Ð¾ Ñ‚Ð¸Ð¿Ñƒ", "Ð¿Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ñƒ"]
   new_mode = mode_names[players[user_id]["backpack_sort"]]
   send_message(user_id, f"ðŸ”„ Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð° Ð½Ð°: {new_mode}", None, vk_session)
   upload_and_send_inventory(user_id, vk_session)
   return
  elif text == "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ":
   upload_and_send_inventory(user_id, vk_session)
   return
  elif text == "ðŸ’¡ Ð¸Ð½Ñ„Ð¾":
   send_message(user_id, format_minimal_info(user_id), create_backpack_menu_keyboard(), vk_session)
   return
  return
 if state == STATE_WAREHOUSE:
  if text in ["ÐÐ°Ð·Ð°Ð´", "ðŸ”š ÐÐ°Ð·Ð°Ð´", "ðŸ§° Ð¡ÐºÐ»Ð°Ð´"]:
   players[user_id]["state"] = STATE_IN_MENU
   save_data()
   send_message(user_id, MAIN_MENU_TEXT, create_main_menu_keyboard(user_id), vk_session)
   return
  else:
   handle_warehouse_action(user_id, text, vk_session)
   return
 if state == STATE_CONFIRMING_EQUIPMENT_SELL:
  handle_equipment_sell_final(user_id, text, vk_session)
  return
 if state == STATE_RESTING:
  if text == "âœ… Ð”Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¾Ñ‚Ð´Ñ‹Ñ…Ð°":
   players[user_id]["state"] = STATE_IN_CAMP
   players[user_id]["rest_start_time"] = None
   players[user_id].pop("initial_stamina", None)
   save_data()
   send_message(user_id, format_camp_info(user_id), create_camp_menu_keyboard(), vk_session)
   return
  start_time = players[user_id].get("rest_start_time")
  if start_time:
   elapsed = time.time() - start_time
   initial = players[user_id].get("initial_stamina", players[user_id]["stamina"])
   belt_bonus = apply_belt_effects_on_rest(user_id)
   donation_bonus = 1 if has_active_donation(user_id) else 0
   new_stamina = min(10, initial + int(elapsed // 360) * (1 + belt_bonus + donation_bonus))
   if new_stamina > players[user_id]["stamina"]:
    players[user_id]["stamina"] = new_stamina
    save_data()
    if new_stamina == 5:
     send_message(user_id, "âš¡ Ð’Ð°ÑˆÐ° Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ Ð´Ð¾ÑÑ‚Ð¸Ð³Ð»Ð° 5/10.", create_resting_keyboard(), vk_session)
    elif new_stamina >= 10:
     players[user_id]["stamina"] = 10
     players[user_id]["state"] = STATE_IN_CAMP
     players[user_id]["rest_start_time"] = None
     players[user_id].pop("initial_stamina", None)
     save_data()
     send_message(user_id, "ðŸ˜´ Ð’Ñ‹ Ð¾Ñ‚Ð´Ð¾Ñ…Ð½ÑƒÐ»Ð¸ Ð¸ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ð»Ð¸ Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ.", create_camp_menu_keyboard(), vk_session)
     return
   stamina = players[user_id]["stamina"]
   rest_text = (f"âš¡ Ð’Ð°ÑˆÐ° Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ: {stamina}/10\nðŸ˜´ Ð’Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð¾Ñ‚Ð´Ñ‹Ñ…Ð°, Ð²Ð°ÑˆÐ° Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ Ð¿Ð¾Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð½Ð° 1 ÐºÐ°Ð¶Ð´Ñ‹Ðµ 6 Ð¼Ð¸Ð½ÑƒÑ‚.\nâš¡ Ð’Ñ‹Ð¿Ð¸Ð² ÑÑ‚Ð¸Ð¼ÑƒÐ»Ð¸Ñ€ÑƒÑŽÑ‰Ð¸Ð¹ Ð½Ð°Ð¿Ð¸Ñ‚Ð¾Ðº, Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¿Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ ÑÐ²Ð¾ÑŽ Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ\nðŸŒ• Ð¢Ð°ÐºÐ¶Ðµ, Ð½ÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ Ð¼Ð¾Ð³ÑƒÑ‚ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°Ñ‚ÑŒ Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ Ð² Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ñ€Ð°Ð· Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ")
   send_message(user_id, rest_text, create_resting_keyboard(), vk_session)
   return
 if state == STATE_WAR_MAIN:
  if text == "ðŸ—ºï¸ Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸ Ð·Ð¾Ð½Ñ‹ ðŸ—ºï¸":
   players[user_id]["state"] = STATE_WAR_TERRITORIES
   save_data()
   send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð»Ð¾ÐºÐ°Ñ†Ð¸ÑŽ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð°:", create_war_territories_keyboard(), vk_session)
   return
  elif text == "ðŸ’² ÐŸÑ€Ð¸Ð¾Ð±Ñ€ÐµÑÑ‚Ð¸ ÑÐºÐ²Ð°Ð´":
   p = players[user_id]
   msg = (f"ðŸ’² Ð”ÐµÐ½ÑŒÐ³Ð¸: {p.get('money', 0)}Ñ€\nðŸ– Ð•Ð´Ð°: {p.get('food_units', 0)} ÐµÐ´Ð¸Ð½Ð¸Ñ†\nâš• ÐœÐµÐ´Ð¸Ñ†Ð¸Ð½Ð°: {p.get('med_units', 0)} ÐµÐ´Ð¸Ð½Ð¸Ñ†\nâ˜¢ Ð Ð°Ð´. Ð¿Ñ€ÐµÐ¿Ð°Ñ€Ð°Ñ‚Ñ‹: {p.get('rad_units', 0)} ÐµÐ´Ð¸Ð½Ð¸Ñ†\nÐšÐ°ÐºÐ¾Ð¹ ÑÐºÐ²Ð°Ð´ Ð¿Ñ€Ð¸Ð¾Ð±Ñ€ÐµÑ‚ÐµÑ‚Ðµ?\nðŸ‘¨â€ðŸ‘¦ 1 ÑÐºÐ²Ð°Ð´ 1 ÑÐ¸Ð»Ð° - ðŸ’²100Ñ€, ðŸ– 5 ÐµÐ´. ÐµÐ´Ñ‹, âš• 5 ÐµÐ´. Ð¼ÐµÐ´., â˜¢ 5 ÐµÐ´. Ñ€Ð°Ð´.\nðŸ‘¨â€ðŸ‘¦â€ðŸ‘¦ 3 ÑÐºÐ²Ð°Ð´Ð° 3 ÑÐ¸Ð»Ñ‹ - ðŸ’²300Ñ€, ðŸ– 10 ÐµÐ´. ÐµÐ´Ñ‹, âš• 10 ÐµÐ´. Ð¼ÐµÐ´., â˜¢ 10 ÐµÐ´. Ñ€Ð°Ð´.\nðŸ‘¨â€ðŸ‘¨â€ðŸ‘¦â€ðŸ‘¦ 5 ÑÐºÐ²Ð°Ð´Ð¾Ð² 5 ÑÐ¸Ð» - ðŸ’²500Ñ€, ðŸ– 15 ÐµÐ´. ÐµÐ´Ñ‹, âš• 15 ÐµÐ´. Ð¼ÐµÐ´., â˜¢ 15 ÐµÐ´. Ñ€Ð°Ð´.")
   players[user_id]["state"] = STATE_WAR_BUY_SQUAD
   save_data()
   send_message(user_id, msg, create_war_buy_squad_keyboard(), vk_session)
   return
  elif text == "â™»ï¸ Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐºÐ²Ð°Ð´Ð°Ð¼Ð¸":
   p = players[user_id]
   msg = (f"ðŸ‘¨â€ðŸ‘¨â€ðŸ‘¦â€ðŸ‘¦ Ð’Ð°ÑˆÐ¸ ÑÐºÐ²Ð°Ð´Ñ‹: {p.get('squads', 0)}\nÐšÐ°Ðº ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÑ‚ÐµÑÑŒ Ð¸Ð¼Ð¸ Ñ€Ð°ÑÐ¿Ð¾Ñ€ÑÐ´Ð¸Ñ‚ÑŒÑÑ?\n\nðŸ’¡ ÐŸÑ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ Ð¼Ð¾Ð¶Ð½Ð¾ ÑƒÐ·Ð½Ð°Ñ‚ÑŒ ÑÐºÐ²Ð°Ð´Ñ‹ Ð½Ð° ÑÐ²Ð¾ÐµÐ¹ Ñ‚Ð¾Ñ‡ÐºÐµ:\nÐ¸Ð½Ñ„Ð¾ [Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ] [Ñ‚Ð¾Ñ‡ÐºÐ°]\nÐŸÑ€Ð¸Ð¼ÐµÑ€: Ð¸Ð½Ñ„Ð¾ ÐºÐ¾Ñ€Ð´Ð¾Ð½ Ð±1")
   players[user_id]["state"] = STATE_WAR_MANAGE_SQUADS
   save_data()
   send_message(user_id, msg, create_war_manage_keyboard(), vk_session)
   return
  elif text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = STATE_IN_MENU
   save_data()
   send_message(user_id, MAIN_MENU_TEXT, create_main_menu_keyboard(user_id), vk_session)
   return
  return
 if state == STATE_WAR_TERRITORIES:
  if text in ["ÐšÐ¾Ñ€Ð´Ð¾Ð½", "Ð¡Ð²Ð°Ð»ÐºÐ°", "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "ÐŸÐ¾Ð»ÑÐ½Ð°"]:
   send_war_map(user_id, text, f"ðŸ“ Ð›Ð¾ÐºÐ°Ñ†Ð¸Ñ: {text}", create_war_territories_keyboard(), vk_session)
   return
  elif text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = STATE_WAR_MAIN
   save_data()
   send_message(user_id, "âš”ï¸ Ð’Ð¾Ð¹Ð½Ð° Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²Ð¾Ðº", create_war_main_keyboard(), vk_session)
   return
  return
 if state == STATE_WAR_BUY_SQUAD:
  if text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = STATE_WAR_MAIN
   save_data()
   send_message(user_id, "âš”ï¸ Ð’Ð¾Ð¹Ð½Ð° Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²Ð¾Ðº", create_war_main_keyboard(), vk_session)
   return
  elif text == "â™»ï¸ ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¾Ð²Ð¸Ð·Ð¸Ð¸":
   p = players[user_id]
   msg = (f"â™» Ð§Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÐºÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð² ÐµÐ´Ð¸Ð½Ð¸Ñ†Ñ‹?\nâ• ÐŸÑ€Ð¸Ð¼ÐµÑ€: Ð¥Ð»ÐµÐ± 1; Ð‘Ð¸Ð½Ñ‚ 2; Ð’Ð¾Ð´ÐºÐ° 3.\n\nðŸ– Ð•Ð´Ð°: {p.get('food_units', 0)} ÐµÐ´Ð¸Ð½Ð¸Ñ†\nâš• ÐœÐµÐ´Ð¸Ñ†Ð¸Ð½Ð°: {p.get('med_units', 0)} ÐµÐ´Ð¸Ð½Ð¸Ñ†\nâ˜¢ Ð Ð°Ð´. Ð¿Ñ€ÐµÐ¿Ð°Ñ€Ð°Ñ‚Ñ‹: {p.get('rad_units', 0)} ÐµÐ´Ð¸Ð½Ð¸Ñ†\n\nÐ”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ñ‹:\nðŸ– ÑˆÐ¾ÐºÐ¾Ð»Ð°Ð´Ð½Ñ‹Ð¹ Ð±Ð°Ñ‚Ð¾Ð½Ñ‡Ð¸Ðº(1), Ñ…Ð»ÐµÐ±(2), ÐºÐ¾Ð»Ð±Ð°ÑÐ°(3), ÐºÐ¾Ð½ÑÐµÑ€Ð²Ð°(4)\nâš• Ð±Ð¸Ð½Ñ‚(1), Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°(2), Ð°Ñ€Ð¼ÐµÐ¹ÑÐºÐ°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°(3), Ð½Ð°ÑƒÑ‡Ð½Ð°Ñ Ð°Ð¿Ñ‚ÐµÑ‡ÐºÐ°(3+1â˜¢)\nâ˜¢ ÑÐ¸Ð³Ð°Ñ€ÐµÑ‚Ñ‹(1), Ð²Ð¾Ð´ÐºÐ°(2), Ñ€Ð°Ð´Ð¸Ð¾Ð¿Ñ€Ð¾Ñ‚ÐµÐºÑ‚Ð¾Ñ€(3), Ð°Ð½Ñ‚Ð¸Ñ€Ð°Ð´(4)")
   players[user_id]["state"] = STATE_WAR_CONVERT
   save_data()
   send_message(user_id, msg, create_back_only_keyboard(), vk_session)
   return
  elif text == "1 ÑÐºÐ²Ð°Ð´":
   p = players[user_id]
   squad_count = 1
   cost = SQUAD_COSTS[squad_count]
   if p.get("money", 0) < cost["money"]:
    send_message(user_id, f"âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´ÐµÐ½ÐµÐ³. ÐÑƒÐ¶Ð½Ð¾ {cost['money']}Ñ€.", create_war_buy_squad_keyboard(), vk_session)
    return
   if p.get("food_units", 0) < cost["food"]:
    send_message(user_id, f"âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÐµÐ´Ñ‹. ÐÑƒÐ¶Ð½Ð¾ {cost['food']} ÐµÐ´Ð¸Ð½Ð¸Ñ†.", create_war_buy_squad_keyboard(), vk_session)
    return
   if p.get("med_units", 0) < cost["med"]:
    send_message(user_id, f"âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¼ÐµÐ´Ð¸Ñ†Ð¸Ð½Ñ‹. ÐÑƒÐ¶Ð½Ð¾ {cost['med']} ÐµÐ´Ð¸Ð½Ð¸Ñ†.", create_war_buy_squad_keyboard(), vk_session)
    return
   if p.get("rad_units", 0) < cost["rad"]:
    send_message(user_id, f"âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ñ€Ð°Ð´. Ð¿Ñ€ÐµÐ¿Ð°Ñ€Ð°Ñ‚Ð¾Ð². ÐÑƒÐ¶Ð½Ð¾ {cost['rad']} ÐµÐ´Ð¸Ð½Ð¸Ñ†.", create_war_buy_squad_keyboard(), vk_session)
    return
   p["money"] -= cost["money"]
   p["food_units"] -= cost["food"]
   p["med_units"] -= cost["med"]
   p["rad_units"] -= cost["rad"]
   p["squads"] = p.get("squads", 0) + squad_count
   save_data()
   send_message(user_id, f"âœ… ÐŸÑ€Ð¸Ð¾Ð±Ñ€ÐµÑ‚ÐµÐ½Ð¾ {squad_count} ÑÐºÐ²Ð°Ð´! Ð’ÑÐµÐ³Ð¾: {p['squads']}", create_war_buy_squad_keyboard(), vk_session)
   return
  elif text == "3 ÑÐºÐ²Ð°Ð´Ð°":
   p = players[user_id]
   squad_count = 3
   cost = SQUAD_COSTS[squad_count]
   if p.get("money", 0) < cost["money"]:
    send_message(user_id, f"âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´ÐµÐ½ÐµÐ³. ÐÑƒÐ¶Ð½Ð¾ {cost['money']}Ñ€.", create_war_buy_squad_keyboard(), vk_session)
    return
   if p.get("food_units", 0) < cost["food"]:
    send_message(user_id, f"âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÐµÐ´Ñ‹. ÐÑƒÐ¶Ð½Ð¾ {cost['food']} ÐµÐ´Ð¸Ð½Ð¸Ñ†.", create_war_buy_squad_keyboard(), vk_session)
    return
   if p.get("med_units", 0) < cost["med"]:
    send_message(user_id, f"âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¼ÐµÐ´Ð¸Ñ†Ð¸Ð½Ñ‹. ÐÑƒÐ¶Ð½Ð¾ {cost['med']} ÐµÐ´Ð¸Ð½Ð¸Ñ†.", create_war_buy_squad_keyboard(), vk_session)
    return
   if p.get("rad_units", 0) < cost["rad"]:
    send_message(user_id, f"âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ñ€Ð°Ð´. Ð¿Ñ€ÐµÐ¿Ð°Ñ€Ð°Ñ‚Ð¾Ð². ÐÑƒÐ¶Ð½Ð¾ {cost['rad']} ÐµÐ´Ð¸Ð½Ð¸Ñ†.", create_war_buy_squad_keyboard(), vk_session)
    return
   p["money"] -= cost["money"]
   p["food_units"] -= cost["food"]
   p["med_units"] -= cost["med"]
   p["rad_units"] -= cost["rad"]
   p["squads"] = p.get("squads", 0) + squad_count
   save_data()
   send_message(user_id, f"âœ… ÐŸÑ€Ð¸Ð¾Ð±Ñ€ÐµÑ‚ÐµÐ½Ð¾ {squad_count} ÑÐºÐ²Ð°Ð´Ð°! Ð’ÑÐµÐ³Ð¾: {p['squads']}", create_war_buy_squad_keyboard(), vk_session)
   return
  elif text == "5 ÑÐºÐ²Ð°Ð´Ð¾Ð²":
   p = players[user_id]
   squad_count = 5
   cost = SQUAD_COSTS[squad_count]
   if p.get("money", 0) < cost["money"]:
    send_message(user_id, f"âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´ÐµÐ½ÐµÐ³. ÐÑƒÐ¶Ð½Ð¾ {cost['money']}Ñ€.", create_war_buy_squad_keyboard(), vk_session)
    return
   if p.get("food_units", 0) < cost["food"]:
    send_message(user_id, f"âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÐµÐ´Ñ‹. ÐÑƒÐ¶Ð½Ð¾ {cost['food']} ÐµÐ´Ð¸Ð½Ð¸Ñ†.", create_war_buy_squad_keyboard(), vk_session)
    return
   if p.get("med_units", 0) < cost["med"]:
    send_message(user_id, f"âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¼ÐµÐ´Ð¸Ñ†Ð¸Ð½Ñ‹. ÐÑƒÐ¶Ð½Ð¾ {cost['med']} ÐµÐ´Ð¸Ð½Ð¸Ñ†.", create_war_buy_squad_keyboard(), vk_session)
    return
   if p.get("rad_units", 0) < cost["rad"]:
    send_message(user_id, f"âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ñ€Ð°Ð´. Ð¿Ñ€ÐµÐ¿Ð°Ñ€Ð°Ñ‚Ð¾Ð². ÐÑƒÐ¶Ð½Ð¾ {cost['rad']} ÐµÐ´Ð¸Ð½Ð¸Ñ†.", create_war_buy_squad_keyboard(), vk_session)
    return
   p["money"] -= cost["money"]
   p["food_units"] -= cost["food"]
   p["med_units"] -= cost["med"]
   p["rad_units"] -= cost["rad"]
   p["squads"] = p.get("squads", 0) + squad_count
   save_data()
   send_message(user_id, f"âœ… ÐŸÑ€Ð¸Ð¾Ð±Ñ€ÐµÑ‚ÐµÐ½Ð¾ {squad_count} ÑÐºÐ²Ð°Ð´Ð¾Ð²! Ð’ÑÐµÐ³Ð¾: {p['squads']}", create_war_buy_squad_keyboard(), vk_session)
   return
  else:
   p = players[user_id]
   msg = (f"âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°.\n\nðŸ’² Ð”ÐµÐ½ÑŒÐ³Ð¸: {p.get('money', 0)}Ñ€\nðŸ– Ð•Ð´Ð°: {p.get('food_units', 0)} ÐµÐ´Ð¸Ð½Ð¸Ñ†\nâš• ÐœÐµÐ´Ð¸Ñ†Ð¸Ð½Ð°: {p.get('med_units', 0)} ÐµÐ´Ð¸Ð½Ð¸Ñ†\nâ˜¢ Ð Ð°Ð´. Ð¿Ñ€ÐµÐ¿Ð°Ñ€Ð°Ñ‚Ñ‹: {p.get('rad_units', 0)} ÐµÐ´Ð¸Ð½Ð¸Ñ†\n\nÐ’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐºÐ²Ð°Ð´ Ð´Ð»Ñ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ¸:")
   send_message(user_id, msg, create_war_buy_squad_keyboard(), vk_session)
   return
 if state == STATE_WAR_CONVERT:
  if text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = STATE_WAR_BUY_SQUAD
   save_data()
   p = players[user_id]
   msg = f"ðŸ’² Ð”ÐµÐ½ÑŒÐ³Ð¸: {p.get('money', 0)}Ñ€\nðŸ– Ð•Ð´Ð°: {p.get('food_units', 0)} ÐµÐ´Ð¸Ð½Ð¸Ñ†\nâš• ÐœÐµÐ´Ð¸Ñ†Ð¸Ð½Ð°: {p.get('med_units', 0)} ÐµÐ´Ð¸Ð½Ð¸Ñ†\nâ˜¢ Ð Ð°Ð´. Ð¿Ñ€ÐµÐ¿Ð°Ñ€Ð°Ñ‚Ñ‹: {p.get('rad_units', 0)} ÐµÐ´Ð¸Ð½Ð¸Ñ†\nÐšÐ°ÐºÐ¾Ð¹ ÑÐºÐ²Ð°Ð´ Ð¿Ñ€Ð¸Ð¾Ð±Ñ€ÐµÑ‚ÐµÑ‚Ðµ?"
   send_message(user_id, msg, create_war_buy_squad_keyboard(), vk_session)
   return
  p = players[user_id]
  conversions = text.split(";")
  total_converted = {"food": 0, "med": 0, "rad": 0}
  errors = []
  for conv in conversions:
   conv = conv.strip()
   if not conv:
    continue
   words = conv.split()
   if len(words) < 2:
    errors.append(f"âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚: '{conv}'")
    continue
   try:
    count = int(words[-1])
    item_name = " ".join(words[:-1]).lower()
   except:
    errors.append(f"âŒ '{words[-1]}' Ð½Ðµ Ñ‡Ð¸ÑÐ»Ð¾")
    continue
   if count <= 0:
    errors.append("âŒ ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐµ 0")
    continue
   if item_name not in CONVERSION_VALUES:
    errors.append(f"âŒ '{' '.join(words[:-1])}' Ð½ÐµÐ»ÑŒÐ·Ñ ÐºÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ")
    continue
   if p["backpack"].get(item_name, 0) < count:
    errors.append(f"âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ '{' '.join(words[:-1])}' (ÐµÑÑ‚ÑŒ: {p['backpack'].get(item_name, 0)})")
    continue
   conv_data = CONVERSION_VALUES[item_name]
   p["backpack"][item_name] -= count
   if p["backpack"][item_name] <= 0:
    del p["backpack"][item_name]
   if conv_data["type"] == "special":
    med_value = conv_data.get("med", 0) * count
    rad_value = conv_data.get("rad", 0) * count
    p["med_units"] = p.get("med_units", 0) + med_value
    p["rad_units"] = p.get("rad_units", 0) + rad_value
    total_converted["med"] += med_value
    total_converted["rad"] += rad_value
   else:
    unit_type = conv_data["type"]
    unit_value = conv_data["value"] * count
    if unit_type == "food":
     p["food_units"] = p.get("food_units", 0) + unit_value
    elif unit_type == "med":
     p["med_units"] = p.get("med_units", 0) + unit_value
    elif unit_type == "rad":
     p["rad_units"] = p.get("rad_units", 0) + unit_value
    total_converted[unit_type] += unit_value
  save_data()
  msg_parts = []
  if total_converted["food"] > 0 or total_converted["med"] > 0 or total_converted["rad"] > 0:
   msg_parts.append("âœ… ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾:")
   if total_converted["food"] > 0:
    msg_parts.append(f"ðŸ– Ð•Ð´Ð°: +{total_converted['food']} ÐµÐ´Ð¸Ð½Ð¸Ñ†")
   if total_converted["med"] > 0:
    msg_parts.append(f"âš• ÐœÐµÐ´Ð¸Ñ†Ð¸Ð½Ð°: +{total_converted['med']} ÐµÐ´Ð¸Ð½Ð¸Ñ†")
   if total_converted["rad"] > 0:
    msg_parts.append(f"â˜¢ Ð Ð°Ð´. Ð¿Ñ€ÐµÐ¿Ð°Ñ€Ð°Ñ‚Ñ‹: +{total_converted['rad']} ÐµÐ´Ð¸Ð½Ð¸Ñ†")
  if errors:
   msg_parts.append("")
   msg_parts.extend(errors)
  msg_parts.append("")
  msg_parts.append(f"Ð¢ÐµÐºÑƒÑ‰Ð¸Ðµ Ð·Ð°Ð¿Ð°ÑÑ‹:\nðŸ– Ð•Ð´Ð°: {p.get('food_units', 0)} ÐµÐ´Ð¸Ð½Ð¸Ñ†\nâš• ÐœÐµÐ´Ð¸Ñ†Ð¸Ð½Ð°: {p.get('med_units', 0)} ÐµÐ´Ð¸Ð½Ð¸Ñ†\nâ˜¢ Ð Ð°Ð´. Ð¿Ñ€ÐµÐ¿Ð°Ñ€Ð°Ñ‚Ñ‹: {p.get('rad_units', 0)} ÐµÐ´Ð¸Ð½Ð¸Ñ†")
  msg_parts.append("\nÐ’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐµÑ‰Ñ‘ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ñ‹ Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐÐ°Ð·Ð°Ð´")
  send_message(user_id, "\n".join(msg_parts), create_back_only_keyboard(), vk_session)
  return
 if state == STATE_WAR_MANAGE_SQUADS:
  if text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = STATE_WAR_MAIN
   save_data()
   send_message(user_id, "âš”ï¸ Ð’Ð¾Ð¹Ð½Ð° Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²Ð¾Ðº", create_war_main_keyboard(), vk_session)
   return
  elif text == "ðŸ“¤ ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ":
   p = players[user_id]
   current_loc = p["location"]
   players[user_id]["state"] = STATE_WAR_SEND_SQUAD_LOCATION
   players[user_id]["squad_action"] = "send"
   save_data()
   send_message(user_id, f"ðŸ—ºï¸ Ð’Ñ‹ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÐµÑÑŒ Ð½Ð° Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸: {current_loc}\nÐ’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð»Ð¾ÐºÐ°Ñ†Ð¸ÑŽ Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐºÐ²Ð°Ð´Ð¾Ð²:", create_war_send_location_keyboard(user_id), vk_session)
   return
  elif text == "ðŸ“¥ Ð’Ñ‹Ð²ÐµÑÑ‚Ð¸":
   players[user_id]["state"] = STATE_WAR_SEND_SQUAD_LOCATION
   players[user_id]["squad_action"] = "withdraw"
   save_data()
   send_message(user_id, "ðŸ—ºï¸ Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð»Ð¾ÐºÐ°Ñ†Ð¸ÑŽ Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð° ÑÐºÐ²Ð°Ð´Ð¾Ð²:", create_war_send_location_keyboard(user_id), vk_session)
   return
  elif text == "ðŸ‘¥ ÐžÐ±Ñ‰Ð¸Ðµ ÑÐºÐ²Ð°Ð´Ñ‹":
   p = players[user_id]
   faction = p["faction"]
   shared = faction_shared_squads.get(faction, 0)
   players[user_id]["state"] = STATE_WAR_SHARED_SQUADS
   save_data()
   msg = f"ðŸ‘¥ ÐžÐ±Ñ‰Ð¸Ðµ ÑÐºÐ²Ð°Ð´Ñ‹ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¸ {faction}: {shared}\nÐ’Ð°ÑˆÐ¸ ÑÐºÐ²Ð°Ð´Ñ‹: {p.get('squads', 0)}"
   send_message(user_id, msg, create_shared_squads_keyboard(), vk_session)
   return
  return
 if state == STATE_WAR_SEND_SQUAD_LOCATION:
  if text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = STATE_WAR_MANAGE_SQUADS
   save_data()
   p = players[user_id]
   msg = f"ðŸ‘¨â€ðŸ‘¨â€ðŸ‘¦â€ðŸ‘¦ Ð’Ð°ÑˆÐ¸ ÑÐºÐ²Ð°Ð´Ñ‹: {p.get('squads', 0)}\nÐšÐ°Ðº ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÑ‚ÐµÑÑŒ Ð¸Ð¼Ð¸ Ñ€Ð°ÑÐ¿Ð¾Ñ€ÑÐ´Ð¸Ñ‚ÑŒÑÑ?"
   send_message(user_id, msg, create_war_manage_keyboard(), vk_session)
   return
  if text in ["ÐšÐ¾Ñ€Ð´Ð¾Ð½", "Ð¡Ð²Ð°Ð»ÐºÐ°", "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "ÐŸÐ¾Ð»ÑÐ½Ð°"]:
   p = players[user_id]
   action = p.get("squad_action", "send")
   current_loc = p["location"]
   current_point = p["point"]
   if action == "send":
    if text != current_loc:
     available_transitions = get_available_transitions(current_loc, current_point)
     valid_border_points = [tp for tl, tp in available_transitions if tl == text]
     if valid_border_points:
      players[user_id]["pending_squad_location"] = text
      players[user_id]["pending_border_points"] = valid_border_points
      players[user_id]["state"] = STATE_WAR_SEND_SQUAD_POINT
      save_data()
      border_info = ", ".join(valid_border_points)
      msg = f"ðŸ—ºï¸ Ð›Ð¾ÐºÐ°Ñ†Ð¸Ñ: {text}\nðŸ“ Ð’Ñ‹ Ð½Ð° Ñ‚Ð¾Ñ‡ÐºÐµ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð°! Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð³Ñ€Ð°Ð½Ð¸Ñ‡Ð°Ñ‰Ð¸Ðµ Ñ‚Ð¾Ñ‡ÐºÐ¸: {border_info}\nÐ’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚Ð¾Ñ‡ÐºÑƒ Ð¸ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐºÐ²Ð°Ð´Ð¾Ð² (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: {valid_border_points[0]} 5):"
      send_war_map(user_id, text, msg, create_back_only_keyboard(), vk_session)
      return
     else:
      send_message(user_id, f"âŒ Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ ÑÐºÐ²Ð°Ð´Ñ‹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð° Ð»Ð¾ÐºÐ°Ñ†Ð¸ÑŽ, Ð³Ð´Ðµ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÐµÑÑŒ ({current_loc}), Ð¸Ð»Ð¸ Ð½Ð° Ð³Ñ€Ð°Ð½Ð¸Ñ‡Ð°Ñ‰Ð¸Ðµ Ñ‚Ð¾Ñ‡ÐºÐ¸ Ñ Ñ‚Ð¾Ñ‡ÐµÐº Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð°.", create_war_send_location_keyboard(user_id), vk_session)
      return
   players[user_id]["pending_squad_location"] = text
   players[user_id]["pending_border_points"] = None
   players[user_id]["state"] = STATE_WAR_SEND_SQUAD_POINT
   save_data()
   if action == "send":
    msg = f"ðŸ—ºï¸ Ð›Ð¾ÐºÐ°Ñ†Ð¸Ñ: {text}\nÐ’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚Ð¾Ñ‡ÐºÑƒ Ð¸ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐºÐ²Ð°Ð´Ð¾Ð² (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: Ð‘1 5):"
   else:
    msg = f"ðŸ—ºï¸ Ð›Ð¾ÐºÐ°Ñ†Ð¸Ñ: {text}\nÐ’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚Ð¾Ñ‡ÐºÑƒ Ð¸ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐºÐ²Ð°Ð´Ð¾Ð² Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð° (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: Ð‘1 3):"
   send_war_map(user_id, text, msg, create_back_only_keyboard(), vk_session)
   return
  return
 if state == STATE_WAR_SEND_SQUAD_POINT:
  if text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = STATE_WAR_SEND_SQUAD_LOCATION
   save_data()
   send_message(user_id, "ðŸ—ºï¸ Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð»Ð¾ÐºÐ°Ñ†Ð¸ÑŽ:", create_war_send_location_keyboard(user_id), vk_session)
   return
  text_lower = text.lower()
  if text_lower.startswith("Ð¸Ð½Ñ„Ð¾ "):
   info_parts = text_lower[5:].strip().split()
   if len(info_parts) < 2:
    send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: Ð¸Ð½Ñ„Ð¾ [Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ] [Ñ‚Ð¾Ñ‡ÐºÐ°]\nÐŸÑ€Ð¸Ð¼ÐµÑ€: Ð¸Ð½Ñ„Ð¾ ÐºÐ¾Ñ€Ð´Ð¾Ð½ Ð±1\nÐ¡Ð¾ÐºÑ€Ð°Ñ‰ÐµÐ½Ð¸Ñ: Ñ‚Ð´ = Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", create_back_only_keyboard(), vk_session)
    return
   info_point = info_parts[-1].upper()
   info_loc_input = " ".join(info_parts[:-1])
   location_map = {"ÐºÐ¾Ñ€Ð´Ð¾Ð½": "ÐšÐ¾Ñ€Ð´Ð¾Ð½", "ÑÐ²Ð°Ð»ÐºÐ°": "Ð¡Ð²Ð°Ð»ÐºÐ°", "Ñ‚Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°": "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ñ‚ÐµÐ¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°": "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ñ‚Ð´": "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ð¿Ð¾Ð»ÑÐ½Ð°": "ÐŸÐ¾Ð»ÑÐ½Ð°"}
   info_location = location_map.get(info_loc_input)
   if not info_location:
    send_message(user_id, "âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ.\nÐ”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾: ÐšÐ¾Ñ€Ð´Ð¾Ð½, Ð¡Ð²Ð°Ð»ÐºÐ°, Ñ‚Ð´, ÐŸÐ¾Ð»ÑÐ½Ð°", create_back_only_keyboard(), vk_session)
    return
   if not is_valid_point(info_location, info_point):
    send_message(user_id, f"âŒ Ð¢Ð¾Ñ‡ÐºÐ° {info_point} Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð½Ð° Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸ {info_location}.", create_back_only_keyboard(), vk_session)
    return
   owner = get_territory_owner(info_location, info_point)
   player_faction = players[user_id]["faction"]
   if owner != player_faction:
    send_message(user_id, "âŒ Ð­Ñ‚Ð° Ñ‚ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ð½Ðµ Ð¿Ñ€Ð¸Ð½Ð°Ð´Ð»ÐµÐ¶Ð¸Ñ‚ Ð²Ð°ÑˆÐµÐ¹ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐµ.", create_back_only_keyboard(), vk_session)
    return
   squads_on_point = get_territory_squads(info_location, info_point)
   ptype = POINT_TYPES.get(info_point, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ")
   min_req = MIN_SQUADS_FOR_POINT.get(ptype, 1)
   send_message(user_id, f"ðŸ“ {info_location} {info_point}\nðŸ‘¥ Ð¡ÐºÐ²Ð°Ð´Ð¾Ð²: {squads_on_point}\nðŸ·ï¸ Ð¢Ð¸Ð¿: {ptype}\nðŸ“‹ ÐœÐ¸Ð½Ð¸Ð¼ÑƒÐ¼ Ð´Ð»Ñ ÑƒÐ´ÐµÑ€Ð¶Ð°Ð½Ð¸Ñ: {min_req}", create_back_only_keyboard(), vk_session)
   return
  parts = text.upper().split()
  if len(parts) != 2:
   send_message(user_id, "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚. ÐŸÑ€Ð¸Ð¼ÐµÑ€: Ð‘1 5\n\nðŸ’¡ Ð§Ñ‚Ð¾Ð±Ñ‹ ÑƒÐ·Ð½Ð°Ñ‚ÑŒ ÑÐºÐ²Ð°Ð´Ñ‹ Ð½Ð° ÑÐ²Ð¾ÐµÐ¹ Ñ‚Ð¾Ñ‡ÐºÐµ:\nÐ¸Ð½Ñ„Ð¾ [Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ] [Ñ‚Ð¾Ñ‡ÐºÐ°]\nÐŸÑ€Ð¸Ð¼ÐµÑ€: Ð¸Ð½Ñ„Ð¾ ÐºÐ¾Ñ€Ð´Ð¾Ð½ Ð±1", create_back_only_keyboard(), vk_session)
   return
  point = parts[0]
  try:
   squad_count = int(parts[1])
  except:
   send_message(user_id, "âŒ ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ñ‡Ð¸ÑÐ»Ð¾Ð¼.", create_back_only_keyboard(), vk_session)
   return
  if squad_count <= 0:
   send_message(user_id, "âŒ ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐºÐ²Ð°Ð´Ð¾Ð² Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐµ 0.", create_back_only_keyboard(), vk_session)
   return
  p = players[user_id]
  location = p.get("pending_squad_location")
  action = p.get("squad_action", "send")
  border_points = p.get("pending_border_points")
  if not is_valid_point(location, point):
   send_message(user_id, "âŒ Ð¢Ð°ÐºÐ¾Ð¹ Ñ‚Ð¾Ñ‡ÐºÐ¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚.", create_back_only_keyboard(), vk_session)
   return
  if border_points is not None and point not in border_points:
   border_info = ", ".join(border_points)
   send_message(user_id, f"âŒ Ð¡ Ð²Ð°ÑˆÐµÐ¹ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐºÐ²Ð°Ð´Ñ‹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð° Ð³Ñ€Ð°Ð½Ð¸Ñ‡Ð°Ñ‰Ð¸Ðµ Ñ‚Ð¾Ñ‡ÐºÐ¸: {border_info}", create_back_only_keyboard(), vk_session)
   return
  if action == "withdraw":
   owner = get_territory_owner(location, point)
   if owner != p["faction"]:
    send_message(user_id, "âŒ Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð²Ñ‹Ð²Ð¾Ð´Ð¸Ñ‚ÑŒ ÑÐºÐ²Ð°Ð´Ñ‹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ¾ ÑÐ²Ð¾Ð¸Ñ… Ñ‚ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹.", create_back_only_keyboard(), vk_session)
    return
   current_squads = get_territory_squads(location, point)
   ptype = POINT_TYPES.get(point, "Ð¢ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ")
   min_squads = MIN_SQUADS_FOR_POINT.get(ptype, 1)
   available = current_squads - min_squads
   if squad_count > available:
    send_message(user_id, f"âŒ ÐœÐ¾Ð¶Ð½Ð¾ Ð²Ñ‹Ð²ÐµÑÑ‚Ð¸ Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ {available} ÑÐºÐ²Ð°Ð´Ð¾Ð² (Ð½Ð° Ñ‚Ð¾Ñ‡ÐºÐµ {current_squads}, Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ {min_squads}).", create_back_only_keyboard(), vk_session)
    return
   territory_control[location][point]["squads"] -= squad_count
   p["squads"] = p.get("squads", 0) + squad_count
   players[user_id]["state"] = STATE_WAR_MANAGE_SQUADS
   players[user_id]["pending_border_points"] = None
   save_data()
   send_message(user_id, f"âœ… Ð’Ñ‹Ð²ÐµÐ´ÐµÐ½Ð¾ {squad_count} ÑÐºÐ²Ð°Ð´Ð¾Ð² Ñ {location} {point}. Ð£ Ð²Ð°Ñ Ñ‚ÐµÐ¿ÐµÑ€ÑŒ {p['squads']} ÑÐºÐ²Ð°Ð´Ð¾Ð².", create_war_manage_keyboard(), vk_session)
   return
  if p.get("squads", 0) < squad_count:
   send_message(user_id, f"âŒ Ð£ Ð²Ð°Ñ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ {p.get('squads', 0)} ÑÐºÐ²Ð°Ð´Ð¾Ð².", create_back_only_keyboard(), vk_session)
   return
  owner = get_territory_owner(location, point)
  if owner is None or owner == p["faction"]:
   result = process_attack(user_id, location, point, squad_count, False, vk_session)
   players[user_id]["state"] = STATE_WAR_MANAGE_SQUADS
   players[user_id]["pending_border_points"] = None
   save_data()
   send_message(user_id, result, create_war_manage_keyboard(), vk_session)
   return
  else:
   players[user_id]["pending_attack_point"] = point
   players[user_id]["pending_attack_squads"] = squad_count
   players[user_id]["state"] = STATE_WAR_ATTACK_CONFIRM
   save_data()
   enemy_squads = get_territory_squads(location, point)
   send_message(user_id, f"âš”ï¸ ÐÐ°Ð¿Ð°ÑÑ‚ÑŒ Ð½Ð° Ñ‚ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸ÑŽ Ð·Ð°Ð½Ð¸Ð¼Ð°ÐµÐ¼ÑƒÑŽ {owner}?", create_attack_confirm_keyboard(), vk_session)
   return
  return
 if state == STATE_WAR_ATTACK_CONFIRM:
  p = players[user_id]
  location = p.get("pending_squad_location")
  point = p.get("pending_attack_point")
  squad_count = p.get("pending_attack_squads", 0)
  if text == "âŒ ÐÐµÑ‚":
   players[user_id]["state"] = STATE_WAR_MANAGE_SQUADS
   save_data()
   msg = f"ðŸ‘¨â€ðŸ‘¨â€ðŸ‘¦â€ðŸ‘¦ Ð’Ð°ÑˆÐ¸ ÑÐºÐ²Ð°Ð´Ñ‹: {p.get('squads', 0)}\nÐšÐ°Ðº ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÑ‚ÐµÑÑŒ Ð¸Ð¼Ð¸ Ñ€Ð°ÑÐ¿Ð¾Ñ€ÑÐ´Ð¸Ñ‚ÑŒÑÑ?\n\nðŸ’¡ Ð¸Ð½Ñ„Ð¾ [Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ] [Ñ‚Ð¾Ñ‡ÐºÐ°] â€” ÑƒÐ·Ð½Ð°Ñ‚ÑŒ ÑÐºÐ²Ð°Ð´Ñ‹"
   send_message(user_id, msg, create_war_manage_keyboard(), vk_session)
   return
  elif text == "âœ… Ð”Ð°":
   result = process_attack(user_id, location, point, squad_count, False, vk_session)
   players[user_id]["state"] = STATE_WAR_MANAGE_SQUADS
   save_data()
   send_message(user_id, result, create_war_manage_keyboard(), vk_session)
   return
  elif text == "âš”ï¸ ÐÐ°Ð¿Ð°ÑÑ‚ÑŒ ÑÐ¾ ÑÐºÐ²Ð°Ð´Ð°Ð¼Ð¸":
   result = process_attack(user_id, location, point, squad_count, True, vk_session)
   players[user_id]["state"] = STATE_WAR_MANAGE_SQUADS
   save_data()
   send_message(user_id, result, create_war_manage_keyboard(), vk_session)
   return
  return
 if state == STATE_WAR_SHARED_SQUADS:
  p = players[user_id]
  faction = p["faction"]
  if text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = STATE_WAR_MANAGE_SQUADS
   save_data()
   msg = f"ðŸ‘¨â€ðŸ‘¨â€ðŸ‘¦â€ðŸ‘¦ Ð’Ð°ÑˆÐ¸ ÑÐºÐ²Ð°Ð´Ñ‹: {p.get('squads', 0)}\nÐšÐ°Ðº ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÑ‚ÐµÑÑŒ Ð¸Ð¼Ð¸ Ñ€Ð°ÑÐ¿Ð¾Ñ€ÑÐ´Ð¸Ñ‚ÑŒÑÑ?\n\nðŸ’¡ Ð¸Ð½Ñ„Ð¾ [Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ] [Ñ‚Ð¾Ñ‡ÐºÐ°] â€” ÑƒÐ·Ð½Ð°Ñ‚ÑŒ ÑÐºÐ²Ð°Ð´Ñ‹"
   send_message(user_id, msg, create_war_manage_keyboard(), vk_session)
   return
  elif text == "ðŸ“¥ ÐŸÐ¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ":
   send_message(user_id, "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐºÐ²Ð°Ð´Ð¾Ð² Ð´Ð»Ñ Ð¿Ð¾Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð¾Ð±Ñ‰Ð¸Ñ…:", create_back_only_keyboard(), vk_session)
   players[user_id]["shared_squad_action"] = "deposit"
   return
  elif text == "ðŸ“¤ Ð’Ñ‹Ð²ÐµÑÑ‚Ð¸":
   send_message(user_id, "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐºÐ²Ð°Ð´Ð¾Ð² Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð° Ð¸Ð· Ð¾Ð±Ñ‰Ð¸Ñ…:", create_back_only_keyboard(), vk_session)
   players[user_id]["shared_squad_action"] = "withdraw"
   return
  action = p.get("shared_squad_action")
  if action:
   try:
    count = int(text)
   except:
    send_message(user_id, "âŒ Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‡Ð¸ÑÐ»Ð¾.", create_shared_squads_keyboard(), vk_session)
    return
   if action == "deposit":
    if p.get("squads", 0) < count:
     send_message(user_id, f"âŒ Ð£ Ð²Ð°Ñ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ {p.get('squads', 0)} ÑÐºÐ²Ð°Ð´Ð¾Ð².", create_shared_squads_keyboard(), vk_session)
     return
    p["squads"] -= count
    faction_shared_squads[faction] = faction_shared_squads.get(faction, 0) + count
    save_data()
    send_message(user_id, f"âœ… ÐŸÐ¾Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾ {count} ÑÐºÐ²Ð°Ð´Ð¾Ð² Ð² Ð¾Ð±Ñ‰Ð¸Ðµ. ÐžÐ±Ñ‰Ð¸Ðµ ÑÐºÐ²Ð°Ð´Ñ‹: {faction_shared_squads[faction]}", create_shared_squads_keyboard(), vk_session)
   elif action == "withdraw":
    if faction_shared_squads.get(faction, 0) < count:
     send_message(user_id, f"âŒ Ð’ Ð¾Ð±Ñ‰Ð¸Ñ… Ñ‚Ð¾Ð»ÑŒÐºÐ¾ {faction_shared_squads.get(faction, 0)} ÑÐºÐ²Ð°Ð´Ð¾Ð².", create_shared_squads_keyboard(), vk_session)
     return
    faction_shared_squads[faction] -= count
    p["squads"] = p.get("squads", 0) + count
    save_data()
    send_message(user_id, f"âœ… Ð’Ñ‹Ð²ÐµÐ´ÐµÐ½Ð¾ {count} ÑÐºÐ²Ð°Ð´Ð¾Ð². Ð’Ð°ÑˆÐ¸ ÑÐºÐ²Ð°Ð´Ñ‹: {p['squads']}", create_shared_squads_keyboard(), vk_session)
   p["shared_squad_action"] = None
   return
  return
 if state == STATE_HUNTING:
  if text == "ðŸƒ ÐŸÐ¾Ð±ÐµÐ³":
   handle_hunting_escape(user_id, vk_session)
   return
  elif text.startswith("ðŸŽ¯ "):
   try:
    shot_num = int(text.split()[-1])
    if 1 <= shot_num <= 9:
     players[user_id]["state"] = STATE_HUNTING_SHOOTING
     players[user_id]["shot_button"] = shot_num
     save_data()
     handle_shooting(user_id, vk_session)
     return
   except ValueError:
    pass
   send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ†ÐµÐ»ÑŒ Ð¸Ð»Ð¸ ÑÐ±ÐµÐ³Ð¸Ñ‚Ðµ.", create_hunting_keyboard(), vk_session)
  else:
   send_message(user_id, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ†ÐµÐ»ÑŒ Ð¸Ð»Ð¸ ÑÐ±ÐµÐ³Ð¸Ñ‚Ðµ.", create_hunting_keyboard(), vk_session)
  return
 if state == STATE_HUNTING_SHOOTING:
  players[user_id]["state"] = STATE_HUNTING
  save_data()
  if players[user_id].get("mutant_hp", 0) > 0:
   send_message(user_id, "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð°Ð¹Ñ‚Ðµ Ð¾Ñ…Ð¾Ñ‚Ñƒ:", create_hunting_keyboard(), vk_session)
   return
 if state == "zombie_control":
  if text == "âš”ï¸ ÐÐ³Ñ€ÐµÑÑÐ¸Ð²Ð½Ñ‹Ð¹ Ð·Ð°Ñ…Ð²Ð°Ñ‚":
   zombie_bot["mode"] = "aggressive"
   save_data()
   send_message(user_id, "âœ… Ð ÐµÐ¶Ð¸Ð¼: ÐÐ³Ñ€ÐµÑÑÐ¸Ð²Ð½Ñ‹Ð¹ Ð·Ð°Ñ…Ð²Ð°Ñ‚\nÐ‘Ð¾Ñ‚ Ð±ÑƒÐ´ÐµÑ‚ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ Ð°Ñ‚Ð°ÐºÐ¾Ð²Ð°Ñ‚ÑŒ.", create_zombie_control_keyboard(), vk_session)
   return
  elif text == "âš–ï¸ ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼":
   zombie_bot["mode"] = "normal"
   save_data()
   send_message(user_id, "âœ… Ð ÐµÐ¶Ð¸Ð¼: ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹\nÐ‘Ð¾Ñ‚ Ð±ÑƒÐ´ÐµÑ‚ ÑÐ±Ð°Ð»Ð°Ð½ÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾ Ñ€Ð°Ð·Ð²Ð¸Ð²Ð°Ñ‚ÑŒÑÑ.", create_zombie_control_keyboard(), vk_session)
   return
  elif text == "ðŸ“¦ ÐÐ°ÐºÐ¾Ð¿Ð»ÐµÐ½Ð¸Ðµ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²":
   zombie_bot["mode"] = "loot"
   save_data()
   send_message(user_id, "âœ… Ð ÐµÐ¶Ð¸Ð¼: ÐÐ°ÐºÐ¾Ð¿Ð»ÐµÐ½Ð¸Ðµ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²\nÐ‘Ð¾Ñ‚ Ð±ÑƒÐ´ÐµÑ‚ Ð»ÑƒÑ‚Ð°Ñ‚ÑŒ Ð¸ ÐºÐ¾Ð¿Ð¸Ñ‚ÑŒ, Ð½Ðµ Ð°Ñ‚Ð°ÐºÑƒÑ.", create_zombie_control_keyboard(), vk_session)
   return
  elif text == "ðŸŽ¯ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚":
   send_message(user_id, "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ†ÐµÐ»ÑŒ Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ: [Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ] [Ñ‚Ð¾Ñ‡ÐºÐ°]\nÐŸÑ€Ð¸Ð¼ÐµÑ€: ÐšÐ¾Ñ€Ð´Ð¾Ð½ Ð‘1", create_back_only_keyboard(), vk_session)
   players[user_id]["state"] = "zombie_set_priority"
   save_data()
   return
  elif text == "âŒ Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚":
   zombie_bot["priority_target"] = None
   save_data()
   send_message(user_id, "âœ… ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ð½Ð°Ñ Ñ†ÐµÐ»ÑŒ ÑÐ±Ñ€Ð¾ÑˆÐµÐ½Ð°.", create_zombie_control_keyboard(), vk_session)
   return
  elif text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = STATE_IN_MENU
   save_data()
   send_message(user_id, MAIN_MENU_TEXT, create_main_menu_keyboard(user_id), vk_session)
   return
  return
 if state == "zombie_set_priority":
  if text == "ðŸ”š ÐÐ°Ð·Ð°Ð´":
   players[user_id]["state"] = "zombie_control"
   save_data()
   send_message(user_id, "ðŸ§Ÿ Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð¾Ð¼Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¼Ð¸:", create_zombie_control_keyboard(), vk_session)
   return
  parts = text.split()
  if len(parts) < 2:
   send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: [Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ] [Ñ‚Ð¾Ñ‡ÐºÐ°]\nÐŸÑ€Ð¸Ð¼ÐµÑ€: ÐšÐ¾Ñ€Ð´Ð¾Ð½ Ð‘1", create_back_only_keyboard(), vk_session)
   return
  point = parts[-1].upper()
  loc_input = " ".join(parts[:-1]).lower()
  location_map = {"ÐºÐ¾Ñ€Ð´Ð¾Ð½": "ÐšÐ¾Ñ€Ð´Ð¾Ð½", "ÑÐ²Ð°Ð»ÐºÐ°": "Ð¡Ð²Ð°Ð»ÐºÐ°", "Ñ‚Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°": "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ñ‚ÐµÐ¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°": "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ñ‚Ð´": "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ð¿Ð¾Ð»ÑÐ½Ð°": "ÐŸÐ¾Ð»ÑÐ½Ð°"}
  location = location_map.get(loc_input)
  if not location:
   send_message(user_id, "âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ.", create_back_only_keyboard(), vk_session)
   return
  if not is_valid_point(location, point):
   send_message(user_id, f"âŒ Ð¢Ð¾Ñ‡ÐºÐ° {point} Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚.", create_back_only_keyboard(), vk_session)
   return
  zombie_bot["priority_target"] = (location, point)
  players[user_id]["state"] = "zombie_control"
  save_data()
  send_message(user_id, f"âœ… ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ð½Ð°Ñ Ñ†ÐµÐ»ÑŒ: {location} {point}", create_zombie_control_keyboard(), vk_session)
  return
 if state == STATE_WAITING_QUOTE_PHOTO:
  p = players[user_id]
  quote_data = p.get("pending_quote")
  if not quote_data:
   players[user_id]["state"] = STATE_IN_MENU
   save_data()
   send_message(user_id, "âŒ Ð”Ð°Ð½Ð½Ñ‹Ðµ Ñ†Ð¸Ñ‚Ð°Ñ‚Ñ‹ Ð¿Ð¾Ñ‚ÐµÑ€ÑÐ½Ñ‹.", create_main_menu_keyboard(user_id), vk_session)
   return
  if text.lower() == "Ð½ÐµÑ‚":
   background_img = None
  else:
   send_message(user_id, "âŒ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ñ„Ð¾Ñ‚Ð¾ Ð´Ð»Ñ Ñ„Ð¾Ð½Ð° Ð¸Ð»Ð¸ Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Â«Ð½ÐµÑ‚Â» Ð´Ð»Ñ Ñ‡Ñ‘Ñ€Ð½Ð¾Ð³Ð¾ Ñ„Ð¾Ð½Ð°.", None, vk_session)
   return
  quote_text = quote_data.get("text", "")
  quote_user_id = quote_data.get("user_id")
  quote_date = quote_data.get("date", "")
  try:
   user_info = vk_session.method("users.get", {"user_ids": quote_user_id, "fields": "first_name"})[0]
   user_name = user_info.get("first_name", "ÐÐ½Ð¾Ð½Ð¸Ð¼")
  except:
   user_name = "ÐÐ½Ð¾Ð½Ð¸Ð¼"
  avatar_img = get_user_avatar(quote_user_id, vk_session)
  img_buffer = generate_quote_image(quote_text, user_name, avatar_img, quote_date, background_img)
  try:
   upload_url = vk_session.method("photos.getMessagesUploadServer")["upload_url"]
   response = vk_session.http.post(upload_url, files={"photo": ("quote.png", img_buffer, "image/png")})
   result = response.json()
   photo_data = vk_session.method("photos.saveMessagesPhoto", {"photo": result["photo"], "server": result["server"], "hash": result["hash"]})[0]
   vk_session.method("messages.send", {"user_id": user_id, "attachment": f"photo{photo_data['owner_id']}_{photo_data['id']}", "random_id": 0, "message": "ðŸ–¼ Ð’Ð°ÑˆÐ° Ñ†Ð¸Ñ‚Ð°Ñ‚Ð° Ð³Ð¾Ñ‚Ð¾Ð²Ð°!"})
  except Exception as e:
   logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ñ†Ð¸Ñ‚Ð°Ñ‚Ñ‹: {e}")
   send_message(user_id, "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ñ†Ð¸Ñ‚Ð°Ñ‚Ñ‹.", None, vk_session)
  players[user_id]["state"] = STATE_IN_MENU
  players[user_id].pop("pending_quote", None)
  save_data()
  return
def handle_chat_message(event, vk_session):
    message = event.obj.message
    user_id = message['from_id']
    if user_id in banned_users:
        return
    text = message.get('text', '').strip()
    peer_id = message['peer_id']
    if not text:
        return
    if user_id not in players:
        return
    reply_user_id = None
    if 'reply_message' in message and message['reply_message']:
        reply_user_id = message['reply_message'].get('from_id')
        if reply_user_id and reply_user_id not in players:
            reply_user_id = None
    text_lower = text.lower()
    words = text.split()
    words_lower = text_lower.split()
    if not words:
        return
    if words_lower[0] == "Ð¿ÐµÑ€ÐµÐ²ÐµÑÑ‚Ð¸":
        if reply_user_id and len(words) >= 2:
            try:
                amount = int(words[1])
            except:
                send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: Ð¿ÐµÑ€ÐµÐ²ÐµÑÑ‚Ð¸ [ÑÑƒÐ¼Ð¼Ð°] (Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð¼ Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ)", None, vk_session, peer_id)
                return
            target_uid = reply_user_id
        elif len(words) >= 3:
            try:
                amount = int(words[1])
                target_str = " ".join(words[2:])
            except:
                send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: Ð¿ÐµÑ€ÐµÐ²ÐµÑÑ‚Ð¸ [ÑÑƒÐ¼Ð¼Ð°] [Ð½Ð¸Ðº]", None, vk_session, peer_id)
                return
            target_uid = find_player_by_mention_or_nickname(target_str, vk_session)
        else:
            send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: Ð¿ÐµÑ€ÐµÐ²ÐµÑÑ‚Ð¸ [ÑÑƒÐ¼Ð¼Ð°] [Ð½Ð¸Ðº] Ð¸Ð»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð¼ Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ", None, vk_session, peer_id)
            return
        if amount <= 0:
            send_message(user_id, "âŒ Ð¡ÑƒÐ¼Ð¼Ð° Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐµ 0.", None, vk_session, peer_id)
            return
        if not target_uid:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session, peer_id)
            return
        if target_uid == user_id:
            send_message(user_id, "âŒ ÐÐµÐ»ÑŒÐ·Ñ Ð¿ÐµÑ€ÐµÐ²ÐµÑÑ‚Ð¸ ÑÐµÐ±Ðµ.", None, vk_session, peer_id)
            return
        if target_uid in banned_users:
            send_message(user_id, "âŒ Ð­Ñ‚Ð¾Ñ‚ Ð¸Ð³Ñ€Ð¾Ðº Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½.", None, vk_session, peer_id)
            return
        if players[user_id]["money"] < amount:
            send_message(user_id, f"âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´ÐµÐ½ÐµÐ³. Ð£ Ð²Ð°Ñ {players[user_id]['money']}Ñ€.", None, vk_session, peer_id)
            return
        players[user_id]["money"] -= amount
        players[target_uid]["money"] = players[target_uid].get("money", 0) + amount
        sender_nickname = players[user_id]["nickname"]
        save_data()
        send_message(user_id, f"âœ… ÐŸÐµÑ€ÐµÐ²ÐµÐ´ÐµÐ½Ð¾ {amount}Ñ€ Ð¸Ð³Ñ€Ð¾ÐºÑƒ {players[target_uid]['nickname']}.", None, vk_session, peer_id)
        send_message(target_uid, f"ðŸ“¥ Ð’Ð°Ð¼ Ð¿ÐµÑ€ÐµÐ²Ñ‘Ð»(Ð°) {sender_nickname}: {amount}Ñ€", None, vk_session)
        return
    if words_lower[0] == "Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ":
        if reply_user_id and len(words) >= 3:
            try:
                amount = int(words[-1])
                item_name_original = " ".join(words[1:-1])
            except:
                send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ [Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚] [ÐºÐ¾Ð»-Ð²Ð¾] (Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð¼)", None, vk_session, peer_id)
                return
            target_uid = reply_user_id
        elif len(words) >= 4:
            item_parts = []
            amount = None
            target_str = None
            for i in range(len(words) - 1, 0, -1):
                if target_str is None:
                    target_str = words[i]
                elif amount is None:
                    try:
                        amount = int(words[i])
                    except:
                        send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ [Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚] [ÐºÐ¾Ð»-Ð²Ð¾] [Ð½Ð¸Ðº]", None, vk_session, peer_id)
                        return
                else:
                    item_parts = words[1:i+1]
                    break
            if not item_parts or amount is None or target_str is None:
                send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ [Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚] [ÐºÐ¾Ð»-Ð²Ð¾] [Ð½Ð¸Ðº]", None, vk_session, peer_id)
                return
            item_name_original = " ".join(item_parts)
            target_uid = find_player_by_mention_or_nickname(target_str, vk_session)
        else:
            send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ [Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚] [ÐºÐ¾Ð»-Ð²Ð¾] [Ð½Ð¸Ðº] Ð¸Ð»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð¼", None, vk_session, peer_id)
            return
        if not target_uid:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session, peer_id)
            return
        if target_uid == user_id:
            send_message(user_id, "âŒ ÐÐµÐ»ÑŒÐ·Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐµÐ±Ðµ.", None, vk_session, peer_id)
            return
        found_item = None
        for item in ITEM_EFFECTS.keys():
            if item.lower() == item_name_original.lower():
                found_item = item
                break
        if not found_item:
            for art in ALL_ARTIFACTS:
                if art.lower() == item_name_original.lower():
                    found_item = art
                    break
        if not found_item:
            send_message(user_id, "âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚.", None, vk_session, peer_id)
            return
        backpack = players[user_id]["backpack"]
        current_count = backpack.get(found_item, 0)
        if current_count < amount:
            send_message(user_id, f"âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð¾Ð². Ð•ÑÑ‚ÑŒ: {current_count}.", None, vk_session, peer_id)
            return
        backpack[found_item] -= amount
        if backpack[found_item] <= 0:
            del backpack[found_item]
        players[target_uid]["backpack"][found_item] = players[target_uid]["backpack"].get(found_item, 0) + amount
        sender_nickname = players[user_id]["nickname"]
        save_data()
        send_message(user_id, f"âœ… ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ {found_item} x{amount} Ð¸Ð³Ñ€Ð¾ÐºÑƒ {players[target_uid]['nickname']}.", None, vk_session, peer_id)
        send_message(target_uid, f"ðŸ“¥ Ð’Ð°Ð¼ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ð»(Ð°) {sender_nickname}: {found_item} x{amount}", None, vk_session)
        return
    if not is_admin(user_id):
        return
    if text_lower == "/Ð±Ð¾Ð³":
        p = players[user_id]
        p["money"] += 1000
        p["health"] = 10
        p["radiation"] = 0
        p["hunger"] = 0
        p["stamina"] = 10
        save_data()
        send_message(user_id, "âœ… Ð’Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¸ 1000Ñ€ Ð¸ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ð»Ð¸ Ð²ÑÐµ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸ÐºÐ¸.", None, vk_session, peer_id)
        return
    if text_lower.startswith("/Ð»Ð¸Ð´ÐµÑ€ "):
        if reply_user_id and len(words) == 1:
            target_uid = reply_user_id
        else:
            parts = text.split(maxsplit=1)
            if len(parts) < 2:
                send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð½Ð¸Ðº Ð¸Ð»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚ÑŒÑ‚Ðµ Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ.", None, vk_session, peer_id)
                return
            target_uid = find_player_by_mention_or_nickname(parts[1].strip(), vk_session)
        if not target_uid:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session, peer_id)
            return
        target_faction = players[target_uid]["faction"]
        set_faction_leader(target_faction, target_uid)
        send_message(user_id, f"âœ… {players[target_uid]['nickname']} Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½ Ð»Ð¸Ð´ÐµÑ€Ð¾Ð¼ {target_faction}.", None, vk_session, peer_id)
        send_message(target_uid, f"ðŸ‘‘ Ð’Ñ‹ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ñ‹ Ð»Ð¸Ð´ÐµÑ€Ð¾Ð¼ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¸ {target_faction}!", None, vk_session)
        return
    if text_lower.startswith("/Ð»Ð¸Ð´ÐµÑ€") and reply_user_id:
        target_uid = reply_user_id
        target_faction = players[target_uid]["faction"]
        set_faction_leader(target_faction, target_uid)
        send_message(user_id, f"âœ… {players[target_uid]['nickname']} Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½ Ð»Ð¸Ð´ÐµÑ€Ð¾Ð¼ {target_faction}.", None, vk_session, peer_id)
        send_message(target_uid, f"ðŸ‘‘ Ð’Ñ‹ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ñ‹ Ð»Ð¸Ð´ÐµÑ€Ð¾Ð¼ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¸ {target_faction}!", None, vk_session)
        return
    if text_lower.startswith("/Ð³Ð¸Ð² "):
        parts = text.split()
        if reply_user_id and len(parts) >= 3:
            try:
                count = int(parts[-1])
                item_name = " ".join(parts[1:-1]).lower()
                target_uid = reply_user_id
            except:
                send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: /Ð³Ð¸Ð² [Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚] [ÐºÐ¾Ð»-Ð²Ð¾] (Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð¼)", None, vk_session, peer_id)
                return
        elif len(parts) >= 3:
            target_uid = None
            count = None
            item_end_index = len(parts)
            for i in range(len(parts) - 1, 1, -1):
                potential_nick = " ".join(parts[i:])
                found_uid = find_player_by_mention_or_nickname(potential_nick, vk_session)
                if found_uid:
                    target_uid = found_uid
                    try:
                        count = int(parts[i - 1])
                        item_end_index = i - 1
                        break
                    except:
                        continue
            if target_uid is None:
                try:
                    count = int(parts[-1])
                    item_end_index = len(parts) - 1
                    target_uid = user_id
                except:
                    send_message(user_id, "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚.", None, vk_session, peer_id)
                    return
            item_name = " ".join(parts[1:item_end_index]).lower()
        else:
            send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: /Ð³Ð¸Ð² [Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚] [ÐºÐ¾Ð»-Ð²Ð¾] [Ð½Ð¸Ðº]", None, vk_session, peer_id)
            return
        if count is None or count <= 0:
            send_message(user_id, "âŒ ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼.", None, vk_session, peer_id)
            return
        if item_name == "Ð´ÐµÐ½ÑŒÐ³Ð¸":
            players[target_uid]["money"] = players[target_uid].get("money", 0) + count
            save_data()
            send_message(user_id, f"âœ… Ð’Ñ‹Ð´Ð°Ð½Ð¾ {count}Ñ€ Ð¸Ð³Ñ€Ð¾ÐºÑƒ {players[target_uid]['nickname']}.", None, vk_session, peer_id)
            return
        found_item = None
        for item in ITEM_EFFECTS.keys():
            if item.lower() == item_name:
                found_item = item
                break
        if not found_item:
            for art in ALL_ARTIFACTS:
                if art.lower() == item_name:
                    found_item = art
                    break
        if not found_item:
            send_message(user_id, "âŒ ÐŸÑ€ÐµÐ´Ð¼ÐµÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session, peer_id)
            return
        players[target_uid]["backpack"][found_item] = players[target_uid]["backpack"].get(found_item, 0) + count
        save_data()
        send_message(user_id, f"âœ… Ð’Ñ‹Ð´Ð°Ð½Ð¾ {found_item} x{count} Ð¸Ð³Ñ€Ð¾ÐºÑƒ {players[target_uid]['nickname']}.", None, vk_session, peer_id)
        return
    if text_lower.startswith("/Ð´ÑÐ» "):
        parts = text.split()
        if reply_user_id and len(parts) >= 3:
            try:
                count = int(parts[-1])
                item_name = " ".join(parts[1:-1]).lower()
                target_uid = reply_user_id
            except:
                send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: /Ð´ÑÐ» [Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚] [ÐºÐ¾Ð»-Ð²Ð¾] (Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð¼)", None, vk_session, peer_id)
                return
        elif len(parts) >= 3:
            target_uid = None
            count = None
            item_end_index = len(parts)
            for i in range(len(parts) - 1, 1, -1):
                potential_nick = " ".join(parts[i:])
                found_uid = find_player_by_mention_or_nickname(potential_nick, vk_session)
                if found_uid:
                    target_uid = found_uid
                    try:
                        count = int(parts[i - 1])
                        item_end_index = i - 1
                        break
                    except:
                        continue
            if target_uid is None:
                try:
                    count = int(parts[-1])
                    item_end_index = len(parts) - 1
                    target_uid = user_id
                except:
                    send_message(user_id, "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚.", None, vk_session, peer_id)
                    return
            item_name = " ".join(parts[1:item_end_index]).lower()
        else:
            send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: /Ð´ÑÐ» [Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚] [ÐºÐ¾Ð»-Ð²Ð¾] [Ð½Ð¸Ðº]", None, vk_session, peer_id)
            return
        if count is None or count <= 0:
            send_message(user_id, "âŒ ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼.", None, vk_session, peer_id)
            return
        if item_name == "Ð´ÐµÐ½ÑŒÐ³Ð¸":
            players[target_uid]["money"] = max(0, players[target_uid].get("money", 0) - count)
            save_data()
            send_message(user_id, f"âœ… Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ {count}Ñ€ Ñƒ Ð¸Ð³Ñ€Ð¾ÐºÐ° {players[target_uid]['nickname']}.", None, vk_session, peer_id)
            return
        found_item = None
        for item in ITEM_EFFECTS.keys():
            if item.lower() == item_name:
                found_item = item
                break
        if not found_item:
            for art in ALL_ARTIFACTS:
                if art.lower() == item_name:
                    found_item = art
                    break
        if not found_item:
            send_message(user_id, "âŒ ÐŸÑ€ÐµÐ´Ð¼ÐµÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session, peer_id)
            return
        current = players[target_uid]["backpack"].get(found_item, 0)
        players[target_uid]["backpack"][found_item] = max(0, current - count)
        if players[target_uid]["backpack"][found_item] <= 0:
            del players[target_uid]["backpack"][found_item]
        save_data()
        send_message(user_id, f"âœ… Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ {found_item} x{count} Ñƒ Ð¸Ð³Ñ€Ð¾ÐºÐ° {players[target_uid]['nickname']}.", None, vk_session, peer_id)
        return
    if text_lower.startswith("/ÑÐµÑ‚"):
        if reply_user_id and len(words) == 1:
            target_uid = reply_user_id
        elif len(words) >= 2:
            target_uid = find_player_by_mention_or_nickname(" ".join(words[1:]), vk_session)
        else:
            send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð½Ð¸Ðº Ð¸Ð»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚ÑŒÑ‚Ðµ Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ.", None, vk_session, peer_id)
            return
        if not target_uid:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session, peer_id)
            return
        all_items = list(ITEM_EFFECTS.keys()) + ALL_ARTIFACTS
        for item in all_items:
            players[target_uid]["backpack"][item] = players[target_uid]["backpack"].get(item, 0) + 1
        save_data()
        send_message(user_id, f"âœ… Ð˜Ð³Ñ€Ð¾ÐºÑƒ {players[target_uid]['nickname']} Ð²Ñ‹Ð´Ð°Ð½Ñ‹ Ð²ÑÐµ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ñ‹.", None, vk_session, peer_id)
        return
    if text_lower.startswith("/Ð²Ñ‹Ð±Ñ€Ð¾Ñ"):
        parts = text_lower.split()
        if len(parts) >= 2 and parts[1] == "Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ":
            if not emission_schedule:
                send_message(user_id, "ðŸ“‹ Ð Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¿ÑƒÑÑ‚Ð¾.", None, vk_session, peer_id)
            else:
                moscow_offset = 3 * 3600
                lines = ["ðŸ“‹ Ð Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð²Ñ‹Ð±Ñ€Ð¾ÑÐ¾Ð²:"]
                for t in emission_schedule:
                    time_str = time.strftime('%d.%m %H:%M', time.gmtime(t + moscow_offset))
                    warned = " âš ï¸" if t in emission_warned else ""
                    remaining = t - time.time()
                    if remaining > 0:
                        mins = int(remaining // 60)
                        lines.append(f"  {time_str} (Ñ‡ÐµÑ€ÐµÐ· {mins} Ð¼Ð¸Ð½){warned}")
                    else:
                        lines.append(f"  {time_str} (Ð¿Ñ€Ð¾ÑÑ€Ð¾Ñ‡ÐµÐ½)")
                send_message(user_id, "\n".join(lines), None, vk_session, peer_id)
        else:
            trigger_emission(vk_session)
            send_message(user_id, "âœ… Ð’Ñ‹Ð±Ñ€Ð¾Ñ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½.", None, vk_session, peer_id)
        return
    if text_lower.startswith("/Ð´Ð¾Ð½Ð°Ñ‚ "):
        parts = text.split()
        if len(parts) < 3:
            send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: /Ð´Ð¾Ð½Ð°Ñ‚ [Ð´ÐµÐ½ÑŒ/Ð½ÐµÐ´ÐµÐ»Ñ/Ð¼ÐµÑÑÑ†] [Ð¿Ð¾Ð½Ñ‡Ð¸Ðº/ÑÑ‚ÐµÐ¹Ðº] [Ð½Ð¸Ðº]", None, vk_session, peer_id)
            return
        duration_str = parts[1].lower()
        if duration_str not in DONATION_DURATIONS:
            send_message(user_id, "âŒ Ð”Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ: Ð´ÐµÐ½ÑŒ, Ð½ÐµÐ´ÐµÐ»Ñ, Ð¼ÐµÑÑÑ†", None, vk_session, peer_id)
            return
        artifact_input = parts[2].lower()
        artifact = None
        for art in DONATION_ARTIFACTS:
            if art.lower() == artifact_input:
                artifact = art
                break
        if not artifact:
            send_message(user_id, "âŒ ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚: ÐŸÐ¾Ð½Ñ‡Ð¸Ðº, Ð¡Ñ‚ÐµÐ¹Ðº", None, vk_session, peer_id)
            return
        if reply_user_id and len(parts) == 3:
            target_uid = reply_user_id
        elif len(parts) >= 4:
            target_uid = find_player_by_mention_or_nickname(parts[3].strip(), vk_session)
        else:
            target_uid = user_id
        if not target_uid:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session, peer_id)
            return
        duration = DONATION_DURATIONS[duration_str]
        p = players[target_uid]
        p["donation_end_time"] = time.time() + duration
        p["donation_artifact"] = artifact
        p["backpack"][artifact] = p["backpack"].get(artifact, 0) + 1
        save_data()
        end_time_str = time.strftime('%d.%m.%Y %H:%M', time.localtime(p["donation_end_time"]))
        send_message(user_id, f"âœ… Ð”Ð¾Ð½Ð°Ñ‚ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð¸Ð³Ñ€Ð¾ÐºÑƒ {players[target_uid]['nickname']} Ð½Ð° {duration_str}!\nðŸŽ {artifact}\nâ° Ð”Ð¾: {end_time_str}", None, vk_session, peer_id)
        if target_uid != user_id:
            send_message(target_uid, f"ðŸŽ Ð”Ð¾Ð½Ð°Ñ‚ Ð½Ð° {duration_str}!\nðŸŒ• {artifact}\nâ° Ð”Ð¾: {end_time_str}", None, vk_session)
        return
    if text_lower == "/ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹":
        faction_info = "ðŸ‘¥ Ð“Ð Ð£ÐŸÐŸÐ˜Ð ÐžÐ’ÐšÐ˜:\n"
        for faction in ["ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³", "â˜¦ï¸ Ð“Ñ€ÐµÑ…", "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸"]:
            current = len(factions.get(faction, []))
            limit = MAX_FACTION_SIZES.get(faction, 5)
            faction_info += f"{faction}: {current}/{limit}\n"
        admin_help = f"ðŸ“‹ ÐÐ”ÐœÐ˜Ð ÐšÐžÐœÐÐÐ”Ð«:\n\n{faction_info}\n/Ð±Ð¾Ð³\n/Ð»Ð¸Ð´ÐµÑ€ [Ð½Ð¸Ðº]\n/ÑÐµÑ‚ [Ð½Ð¸Ðº]\n/Ð³Ð¸Ð² [Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚] [ÐºÐ¾Ð»-Ð²Ð¾] [Ð½Ð¸Ðº]\n/Ð´ÑÐ» [Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚] [ÐºÐ¾Ð»-Ð²Ð¾] [Ð½Ð¸Ðº]\n/Ð²Ñ‹Ð±Ñ€Ð¾Ñ\n/Ð´Ð¾Ð½Ð°Ñ‚ [Ð´ÐµÐ½ÑŒ/Ð½ÐµÐ´ÐµÐ»Ñ/Ð¼ÐµÑÑÑ†] [Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚] [Ð½Ð¸Ðº]\n/Ð»Ð¸Ð¼Ð¸Ñ‚ [Ð³Ð¿] [Ñ‡Ð¸ÑÐ»Ð¾]\n/ÑÐ¼ÐµÐ½Ð¸Ñ‚ÑŒÐ³Ð¿ [Ð½Ð¸Ðº] [Ð³Ð¿]\n/Ñ‚ÐµÐ»ÐµÐ¿Ð¾Ñ€Ñ‚ [Ð½Ð¸Ðº] [Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ] [Ñ‚Ð¾Ñ‡ÐºÐ°]\n/Ð½Ð¸Ðº [ÑÑ‚Ð°Ñ€Ñ‹Ð¹] [Ð½Ð¾Ð²Ñ‹Ð¹]\n/Ð±Ð°Ð½ [Ð½Ð¸Ðº] [Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ð°]\n/Ñ€Ð°Ð·Ð±Ð°Ð½ [Ð½Ð¸Ðº]\n/skip_cd\n\nðŸ’¡ ÐœÐ¾Ð¶Ð½Ð¾ Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ñ‚ÑŒ Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð²Ð¼ÐµÑÑ‚Ð¾ Ð½Ð¸ÐºÐ°"
        send_message(user_id, admin_help, None, vk_session, peer_id)
        return
    if text_lower.startswith("/Ð»Ð¸Ð¼Ð¸Ñ‚ "):
        parts = text.split()
        if len(parts) < 3:
            send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: /Ð»Ð¸Ð¼Ð¸Ñ‚ [Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ°] [Ñ‡Ð¸ÑÐ»Ð¾]", None, vk_session, peer_id)
            return
        faction_input = parts[1].lower()
        try:
            new_limit = int(parts[2])
        except:
            send_message(user_id, "âŒ Ð›Ð¸Ð¼Ð¸Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ñ‡Ð¸ÑÐ»Ð¾Ð¼.", None, vk_session, peer_id)
            return
        if new_limit < 1 or new_limit > 50:
            send_message(user_id, "âŒ Ð›Ð¸Ð¼Ð¸Ñ‚ Ð¾Ñ‚ 1 Ð´Ð¾ 50.", None, vk_session, peer_id)
            return
        faction_map = {"Ð´Ð¾Ð»Ð³": "ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³", "Ð³Ñ€ÐµÑ…": "â˜¦ï¸ Ð“Ñ€ÐµÑ…", "Ð¾Ð´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸"}
        if faction_input not in faction_map:
            send_message(user_id, "âŒ Ð“ÐŸ: Ð´Ð¾Ð»Ð³, Ð³Ñ€ÐµÑ…, Ð¾Ð´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸", None, vk_session, peer_id)
            return
        faction_name = faction_map[faction_input]
        MAX_FACTION_SIZES[faction_name] = new_limit
        save_data()
        send_message(user_id, f"âœ… Ð›Ð¸Ð¼Ð¸Ñ‚ {faction_name} â†’ {new_limit}.", None, vk_session, peer_id)
        return
    if text_lower.startswith("/ÑÐ¼ÐµÐ½Ð¸Ñ‚ÑŒÐ³Ð¿"):
        parts = text.split()
        if reply_user_id and reply_user_id in players and len(parts) == 2:
            target_uid = reply_user_id
            faction_input = parts[1].lower()
        elif len(parts) >= 3:
            target_nick = " ".join(parts[1:-1])
            faction_input = parts[-1].lower()
            target_uid = find_player_by_mention_or_nickname(target_nick, vk_session)
        else:
            send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: /ÑÐ¼ÐµÐ½Ð¸Ñ‚ÑŒÐ³Ð¿ [Ð½Ð¸Ðº] [Ð³Ð¿] Ð¸Ð»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð¼: /ÑÐ¼ÐµÐ½Ð¸Ñ‚ÑŒÐ³Ð¿ [Ð³Ð¿]", None, vk_session, peer_id)
            return
        if not target_uid:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session, peer_id)
            return
        faction_map = {"Ð´Ð¾Ð»Ð³": "ðŸ›¡ï¸ Ð”Ð¾Ð»Ð³", "Ð³Ñ€ÐµÑ…": "â˜¦ï¸ Ð“Ñ€ÐµÑ…", "Ð¾Ð´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸": "â˜¢ï¸ ÐžÐ´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸", "Ð·Ð¾Ð¼Ð±Ð¸": ZOMBIE_FACTION, "Ð·Ð¾Ð¼Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ": ZOMBIE_FACTION}
        if faction_input not in faction_map:
            send_message(user_id, "âŒ Ð“ÐŸ: Ð´Ð¾Ð»Ð³, Ð³Ñ€ÐµÑ…, Ð¾Ð´Ð¸Ð½Ð¾Ñ‡ÐºÐ¸, Ð·Ð¾Ð¼Ð±Ð¸", None, vk_session, peer_id)
            return
        new_faction = faction_map[faction_input]
        old_faction = players[target_uid].get("faction")
        if old_faction and target_uid in factions.get(old_faction, []):
            factions[old_faction].remove(target_uid)
        players[target_uid]["faction"] = new_faction
        if new_faction not in factions:
            factions[new_faction] = []
        if target_uid not in factions[new_faction]:
            factions[new_faction].append(target_uid)
        save_data()
        send_message(user_id, f"âœ… {players[target_uid]['nickname']} â†’ {new_faction}.", None, vk_session, peer_id)
        send_message(target_uid, f"âš ï¸ Ð’Ð°Ñ Ð¿ÐµÑ€ÐµÐ²ÐµÐ»Ð¸ Ð² {new_faction}!", None, vk_session)
        return
    if text_lower.startswith("/Ñ‚ÐµÐ»ÐµÐ¿Ð¾Ñ€Ñ‚ "):
        parts = text.split()
        if reply_user_id and len(parts) >= 3:
            target_uid = reply_user_id
            point = parts[-1].upper()
            location_input = " ".join(parts[1:-1]).lower()
        elif len(parts) >= 4:
            target_uid = find_player_by_mention_or_nickname(parts[1], vk_session)
            point = parts[-1].upper()
            location_input = " ".join(parts[2:-1]).lower()
        else:
            send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: /Ñ‚ÐµÐ»ÐµÐ¿Ð¾Ñ€Ñ‚ [Ð½Ð¸Ðº] [Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ] [Ñ‚Ð¾Ñ‡ÐºÐ°]", None, vk_session, peer_id)
            return
        if not target_uid:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session, peer_id)
            return
        location_map = {"ÐºÐ¾Ñ€Ð´Ð¾Ð½": "ÐšÐ¾Ñ€Ð´Ð¾Ð½", "ÑÐ²Ð°Ð»ÐºÐ°": "Ð¡Ð²Ð°Ð»ÐºÐ°", "Ñ‚Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°": "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ñ‚ÐµÐ¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°": "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ñ‚Ð´": "Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°", "Ð¿Ð¾Ð»ÑÐ½Ð°": "ÐŸÐ¾Ð»ÑÐ½Ð°"}
        location = location_map.get(location_input)
        if not location:
            send_message(user_id, "âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ.", None, vk_session, peer_id)
            return
        if not is_valid_point(location, point):
            send_message(user_id, f"âŒ Ð¢Ð¾Ñ‡ÐºÐ° {point} Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚.", None, vk_session, peer_id)
            return
        players[target_uid]["location"] = location
        players[target_uid]["point"] = point
        players[target_uid]["transition_end_time"] = None
        if players[target_uid].get("state") == STATE_TRANSITION_WAIT:
            players[target_uid]["state"] = STATE_IN_MENU
        save_data()
        send_message(user_id, f"âœ… {players[target_uid]['nickname']} â†’ {location} {point}.", None, vk_session, peer_id)
        send_message(target_uid, f"âš¡ Ð’Ð°Ñ Ñ‚ÐµÐ»ÐµÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð»Ð¸ Ð½Ð° {location} {point}!", None, vk_session)
        return
    if text_lower.startswith("/Ð½Ð¸Ðº "):
     content = text[5:].strip()
     if " > " in content:
        parts = content.split(" > ", 1)
        old_nick = parts[0].strip()
        new_nick = parts[1].strip()
        
        target_uid = None
        for uid, data in players.items():
            if data.get("nickname", "").lower() == old_nick.lower():
                target_uid = uid
                break
        
        if not target_uid:
            for uid, data in players.items():
                if old_nick.lower() in data.get("nickname", "").lower():
                    target_uid = uid
                    break
        if not target_uid:
            send_message(user_id, f"âŒ Ð˜Ð³Ñ€Ð¾Ðº '{old_nick}' Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session, peer_id)
            return
        old_nickname = players[target_uid]["nickname"]
        players[target_uid]["nickname"] = new_nick
        save_data()
        send_message(user_id, f"âœ… {old_nickname} â†’ {new_nick}", None, vk_session, peer_id)
        send_message(target_uid, f"ðŸ“ Ð’Ð°Ñˆ Ð½Ð¸Ðº Ð¸Ð·Ð¼ÐµÐ½Ñ‘Ð½ Ð½Ð°: {new_nick}", None, vk_session)
        return
     if reply_user_id and reply_user_id in players:
        new_nick = content
        if not new_nick:
            send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð½Ð¾Ð²Ñ‹Ð¹ Ð½Ð¸Ðº.", None, vk_session, peer_id)
            return
        old_nickname = players[reply_user_id]["nickname"]
        players[reply_user_id]["nickname"] = new_nick
        save_data()
        send_message(user_id, f"âœ… {old_nickname} â†’ {new_nick}", None, vk_session, peer_id)
        send_message(reply_user_id, f"ðŸ“ Ð’Ð°Ñˆ Ð½Ð¸Ðº Ð¸Ð·Ð¼ÐµÐ½Ñ‘Ð½ Ð½Ð°: {new_nick}", None, vk_session)
        return
     send_message(user_id, "âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚:\n/Ð½Ð¸Ðº ÑÑ‚Ð°Ñ€Ñ‹Ð¹ > Ð½Ð¾Ð²Ñ‹Ð¹\nÐ¸Ð»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð¼: /Ð½Ð¸Ðº Ð½Ð¾Ð²Ñ‹Ð¹", None, vk_session, peer_id)
     return
    if text_lower.startswith("/Ð±Ð°Ð½ "):
        content = text[5:].strip()
        if not content:
            send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð½Ð¸Ðº.", None, vk_session, peer_id)
            return
        if reply_user_id:
            target_uid = reply_user_id
            reason = content if content else "ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð° Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°"
        else:
            parts = content.split(maxsplit=1)
            target_uid = find_player_by_mention_or_nickname(parts[0], vk_session)
            reason = parts[1] if len(parts) > 1 else "ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð° Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°"
        if not target_uid:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session, peer_id)
            return
        if target_uid == user_id:
            send_message(user_id, "âŒ ÐÐµÐ»ÑŒÐ·Ñ Ð·Ð°Ð±Ð°Ð½Ð¸Ñ‚ÑŒ ÑÐµÐ±Ñ.", None, vk_session, peer_id)
            return
        if target_uid == 353430025:
            send_message(user_id, "âŒ ÐÐµÐ»ÑŒÐ·Ñ Ð·Ð°Ð±Ð°Ð½Ð¸Ñ‚ÑŒ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ°.", None, vk_session, peer_id)
            return
        if target_uid in banned_users:
            send_message(user_id, "âŒ Ð£Ð¶Ðµ Ð·Ð°Ð±Ð°Ð½ÐµÐ½.", None, vk_session, peer_id)
            return
        banned_users[target_uid] = reason
        save_data()
        send_message(user_id, f"âœ… {players[target_uid]['nickname']} Ð·Ð°Ð±Ð°Ð½ÐµÐ½.\nðŸ“ {reason}", None, vk_session, peer_id)
        send_message(target_uid, f"ðŸš« Ð’Ñ‹ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹.\nðŸ“ {reason}", None, vk_session)
        return
    if text_lower.startswith("/Ñ€Ð°Ð·Ð±Ð°Ð½"):
        if reply_user_id and len(words) == 1:
            target_uid = reply_user_id
        elif len(words) >= 2:
            target_uid = find_player_by_mention_or_nickname(" ".join(words[1:]), vk_session)
        else:
            send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð½Ð¸Ðº Ð¸Ð»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚ÑŒÑ‚Ðµ Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ.", None, vk_session, peer_id)
            return
        if not target_uid:
            send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session, peer_id)
            return
        if target_uid not in banned_users:
            send_message(user_id, "âŒ ÐÐµ Ð·Ð°Ð±Ð°Ð½ÐµÐ½.", None, vk_session, peer_id)
            return
        del banned_users[target_uid]
        save_data()
        send_message(user_id, f"âœ… {players[target_uid]['nickname']} Ñ€Ð°Ð·Ð±Ð°Ð½ÐµÐ½.", None, vk_session, peer_id)
        send_message(target_uid, "âœ… Ð’Ñ‹ Ñ€Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹.", None, vk_session)
        return
    if text_lower == "/skip_cd":
        if user_id in players and players[user_id].get("state") == STATE_TRANSITION_WAIT:
            players[user_id]["state"] = STATE_IN_MENU
            players[user_id]["transition_end_time"] = None
            save_data()
            send_message(user_id, "â±ï¸ Ð¢Ð°Ð¹Ð¼ÐµÑ€ ÑÐ±Ñ€Ð¾ÑˆÐµÐ½.", None, vk_session, peer_id)
        else:
            send_message(user_id, "Ð’Ñ‹ Ð½Ðµ Ð² Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ðµ.", None, vk_session, peer_id)
        return
    if user_id == 353430025:
        if text_lower.startswith("/Ð°Ð´Ð¼Ð¸Ð½"):
            if reply_user_id and len(words) == 1:
                target_uid = reply_user_id
            elif len(words) >= 2:
                target_uid = find_player_by_mention_or_nickname(" ".join(words[1:]), vk_session)
            else:
                send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð½Ð¸Ðº Ð¸Ð»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚ÑŒÑ‚Ðµ.", None, vk_session, peer_id)
                return
            if not target_uid:
                send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session, peer_id)
                return
            if target_uid == user_id:
                send_message(user_id, "âŒ Ð’Ñ‹ ÑƒÐ¶Ðµ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº.", None, vk_session, peer_id)
                return
            if target_uid in admin_users:
                send_message(user_id, "âŒ Ð£Ð¶Ðµ Ð°Ð´Ð¼Ð¸Ð½.", None, vk_session, peer_id)
                return
            admin_users.append(target_uid)
            save_data()
            send_message(user_id, f"âœ… {players[target_uid]['nickname']} â€” Ð°Ð´Ð¼Ð¸Ð½.", None, vk_session, peer_id)
            send_message(target_uid, "ðŸ‘‘ Ð’Ñ‹ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ñ‹ Ð°Ð´Ð¼Ð¸Ð½Ð¾Ð¼!", None, vk_session)
            return
        if text_lower.startswith("/Ð´ÐµÐ»Ð°Ð´Ð¼Ð¸Ð½"):
            if reply_user_id and len(words) == 1:
                target_uid = reply_user_id
            elif len(words) >= 2:
                target_uid = find_player_by_mention_or_nickname(" ".join(words[1:]), vk_session)
            else:
                send_message(user_id, "âŒ Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð½Ð¸Ðº Ð¸Ð»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚ÑŒÑ‚Ðµ.", None, vk_session, peer_id)
                return
            if not target_uid:
                send_message(user_id, "âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.", None, vk_session, peer_id)
                return
            if target_uid not in admin_users:
                send_message(user_id, "âŒ ÐÐµ Ð°Ð´Ð¼Ð¸Ð½.", None, vk_session, peer_id)
                return
            admin_users.remove(target_uid)
            save_data()
            send_message(user_id, f"âœ… {players[target_uid]['nickname']} ÑÐ½ÑÑ‚ Ñ Ð°Ð´Ð¼Ð¸Ð½ÐºÐ¸.", None, vk_session, peer_id)
            send_message(target_uid, "âš ï¸ Ð’Ñ‹ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð½Ðµ Ð°Ð´Ð¼Ð¸Ð½.", None, vk_session)
            return
def background_checker(vk_session):
    while True:
        try:
            current_time = time.time()
            check_emissions(vk_session)
            for user_id, data in list(players.items()):
                faction = data.get("faction")
                if not faction or faction == "None" or faction is None:
                    continue
                if data.get("donation_end_time") and current_time >= data.get("donation_end_time"):
                    remove_donation(user_id, vk_session)
                if data.get("health", 10) <= 0:
                    if not data.get("death_notified", False):
                        lose_random_items_on_death(user_id, vk_session)
                        continue
                if data.get("state") == STATE_TRANSITION_WAIT:
                    end_time = data.get("transition_end_time")
                    if end_time and current_time >= end_time:
                        data["previous_location"] = None
                        data["previous_point"] = None
                        if random.randint(1, 100) <= 30:
                            money_found = random.randint(5, 15)
                            data["money"] = data.get("money", 0) + money_found
                            transition_msg = f"âœ… ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½!\nðŸ’² ÐŸÐ¾ Ð¿ÑƒÑ‚Ð¸ Ð½Ð°ÑˆÐ»Ð¸: {money_found}Ñ€"
                        elif random.randint(1, 100) <= 20:
                            rad_gain = round(random.uniform(0.5, 1.5), 1)
                            data["radiation"] = min(10, data["radiation"] + rad_gain)
                            transition_msg = f"âœ… ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½!\nâ˜¢ï¸ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ Ð¾Ð±Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ: +{rad_gain}"
                        else:
                            transition_msg = "âœ… ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½!"
                        data["transition_end_time"] = None
                        data["state"] = STATE_IN_MENU
                        data["backpack"]["Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸"] = data["backpack"].get("Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸", 0) - 2
                        if data["backpack"]["Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸"] <= 0:
                            del data["backpack"]["Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸"]
                        transition_msg += "\nðŸ”‹ ÐŸÐ¾Ñ‚Ñ€Ð°Ñ‡ÐµÐ½Ð¾ 2 Ð±Ð°Ñ‚Ð°Ñ€ÐµÐ¹ÐºÐ¸."
                        current_location = data["location"]
                        current_point = data["point"]
                        if (current_location, current_point) in TRANSITION_ROUTES:
                            destinations = TRANSITION_ROUTES[(current_location, current_point)]
                            transition_msg += "\n\nðŸ“ Ð’Ñ‹ Ð½Ð° Ñ‚Ð¾Ñ‡ÐºÐµ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð°!"
                            for dest_loc, dest_point in destinations:
                                transition_msg += f"\nÐ¢ÐµÐ¿ÐµÑ€ÑŒ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¿Ð¾Ð¿Ð°ÑÑ‚ÑŒ Ð½Ð° {dest_loc} {dest_point}"
                        send_location_image(user_id, current_location, current_point, transition_msg, create_main_menu_keyboard(user_id), vk_session)
                        save_data()
                elif data.get("state") == STATE_RESTING:
                    start_time = data.get("rest_start_time")
                    if start_time:
                        elapsed = current_time - start_time
                        initial = data.get("initial_stamina", data["stamina"])
                        belt_bonus = apply_belt_effects_on_rest(user_id)
                        donation_bonus = 1 if has_active_donation(user_id) else 0
                        total_bonus = 1 + belt_bonus + donation_bonus
                        elapsed_intervals = int(elapsed // 360)
                        new_stamina = min(10, initial + elapsed_intervals * total_bonus)
                        if new_stamina > data["stamina"]:
                            data["stamina"] = new_stamina
                            save_data()
                        if data["stamina"] >= 10:
                            data["stamina"] = 10
                            data["state"] = STATE_IN_CAMP
                            data["rest_start_time"] = None
                            data.pop("initial_stamina", None)
                            save_data()
                            send_message(user_id, "ðŸ˜´ Ð’Ñ‹ Ð¾Ñ‚Ð´Ð¾Ñ…Ð½ÑƒÐ»Ð¸ Ð¸ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ð»Ð¸ Ð²Ñ‹Ð½Ð¾ÑÐ»Ð¸Ð²Ð¾ÑÑ‚ÑŒ.", create_camp_menu_keyboard(), vk_session)
            if LAST_STAND_MODE:
                next_action_time = zombie_bot.get("last_action_time", 0) + get_zombie_cooldown()
                if current_time >= next_action_time:
                    zombie_take_action(vk_session)
            time.sleep(10)
        except Exception as e:
            logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð² Ñ„Ð¾Ð½Ð¾Ð²Ð¾Ð¼ Ð¿Ð¾Ñ‚Ð¾ÐºÐµ: {e}")
            time.sleep(30)
if __name__ == "__main__":
    load_data()
    while True:
        try:
            logger.info("ðŸ” Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ VK ÑÐµÑÑÐ¸Ð¸...")
            vk_session = vk_api.VkApi(token=TOKEN)
            longpoll = VkBotLongPoll(vk_session, GROUP_ID)
            logger.info("âœ… Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¸ Ð¾Ð¶Ð¸Ð´Ð°ÐµÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹...")
            checker_thread = threading.Thread(target=background_checker, args=(vk_session,), daemon=True)
            checker_thread.start()
            logger.info("âœ… Ð¤Ð¾Ð½Ð¾Ð²Ñ‹Ð¹ Ð¿Ð¾Ñ‚Ð¾Ðº Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½...")
            for event in longpoll.listen():
                if event.type == VkBotEventType.MESSAGE_NEW:
                    message = event.obj.message
                    from_id = message.get('from_id', 0)
                    peer_id = message.get('peer_id', 0)
                    msg_text = message.get('text', '').strip()
                    if from_id < 0:
                        continue
                    attachments = message.get('attachments', [])
                    fwd_messages = message.get('fwd_messages', [])
                    reply_message = message.get('reply_message')
                    if from_id in players and players[from_id].get("state") == STATE_WAITING_QUOTE_PHOTO:
                        photo_att = None
                        for att in attachments:
                            if att.get('type') == 'photo':
                                photo_att = att.get('photo', {})
                                break
                        if photo_att or msg_text.lower().startswith("Ð½ÐµÑ‚"):
                            process_quote_photo(from_id, msg_text, photo_att, peer_id, vk_session)
                            continue
                        else:
                            send_message(from_id, "ðŸ“· ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ñ„Ð¾Ñ‚Ð¾ Ð¸Ð»Ð¸ Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Â«Ð½ÐµÑ‚Â».", None, vk_session, peer_id)
                            continue
                    if msg_text.lower() == "/Ñ†Ð¸Ñ‚Ð°Ñ‚Ð°":
                        source_msg = reply_message if reply_message else (fwd_messages[0] if fwd_messages else None)
                        if source_msg:
                            process_quote_request(from_id, source_msg.get('text', ''), source_msg.get('from_id', 0), source_msg.get('date', 0), peer_id, vk_session)
                        else:
                            send_message(from_id, "âŒ ÐžÑ‚Ð²ÐµÑ‚ÑŒÑ‚Ðµ Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¸Ð»Ð¸ Ð¿ÐµÑ€ÐµÑˆÐ»Ð¸Ñ‚Ðµ ÐµÐ³Ð¾ Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹ /Ñ†Ð¸Ñ‚Ð°Ñ‚Ð°", None, vk_session, peer_id)
                        continue
                    if attachments and from_id in players:
                        pending_target = players[from_id].get("pending_photo_target")
                        if pending_target and is_admin(from_id):
                            for att in attachments:
                                if att.get('type') == 'photo':
                                    photo = att.get('photo', {})
                                    sizes = photo.get('sizes', [])
                                    if sizes:
                                        best_size = max(sizes, key=lambda x: x.get('width', 0) * x.get('height', 0))
                                        photo_url = best_size.get('url')
                                        if photo_url:
                                            handle_photo_upload(from_id, photo_url, vk_session)
                                            break
                            continue
                    if peer_id != from_id:
                        try:
                            handle_chat_message(event, vk_session)
                        except Exception as e:
                            logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð² Ð±ÐµÑÐµÐ´Ðµ: {e}")
                    else:
                        try:
                            class SimpleEvent:
                                def __init__(self, msg):
                                    self.user_id = msg.get('from_id')
                                    self.text = msg.get('text', '')
                                    self.from_chat = False
                                    self.from_me = False
                            simple_event = SimpleEvent(message)
                            handle_message(simple_event, vk_session)
                        except Exception as e:
                            logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ: {e}")
        except (KeyboardInterrupt, SystemExit):
            logger.info("ðŸ›‘ Ð‘Ð¾Ñ‚ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ.")
            break
        except Exception as e:
            logger.error(f"âŒ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°: {e}")
            logger.info("â³ ÐŸÐµÑ€ÐµÐ¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· 5 ÑÐµÐºÑƒÐ½Ð´...")
            time.sleep(5)
