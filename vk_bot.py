import asyncio
import logging
import json
import os
import random
import io
import sqlite3
import time
from pathlib import Path
from PIL import Image, ImageDraw, ImageFont, ImageEnhance
from typing import Optional, Dict, List, Tuple, Any

from vkwave.bots import SimpleLongPollBot, Keyboard, ButtonColor, SimpleBotEvent
from vkwave.bots.fsm import StateFilter, ForWhat, State, FiniteStateMachine
from vkwave.api import API
from vkwave.client import AIOHTTPClient

# ==================== ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ Ğ›ĞĞ“Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ¯ ====================
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# ==================== ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ¯ ====================
TOKEN = "vk1.a.YOUR_TOKEN_HERE"  # Ğ—Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ Ğ½Ğ° ÑĞ²Ğ¾Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½
GROUP_ID = 233350137

DATA_DIR = Path("data")
DATA_DIR.mkdir(parents=True, exist_ok=True)
DB_PATH = DATA_DIR / "bot.db"
AVATAR_DIR = "custom_avatars"
os.makedirs(AVATAR_DIR, exist_ok=True)

# ==================== ĞšĞĞĞ¡Ğ¢ĞĞĞ¢Ğ« Ğ˜ĞĞ’Ğ•ĞĞ¢ĞĞ Ğ¯ ====================
CELL_SIZE = 60
MARGIN = 5
COLUMNS = 5
ROWS = 10
INVENTORY_SIZE = COLUMNS * ROWS

# ==================== ĞšĞĞ Ğ¢Ğ« Ğ›ĞĞšĞĞ¦Ğ˜Ğ™ ====================
LOCATION_MAPS = {
    "ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½": "backgrounds/ĞºĞ°Ñ€Ñ‚Ğ°_ĞºĞ¾Ñ€Ğ´Ğ¾Ğ½Ğ°.png",
    "Ğ¡Ğ²Ğ°Ğ»ĞºĞ°": "backgrounds/ĞºĞ°Ñ€Ñ‚Ğ°_ÑĞ²Ğ°Ğ»ĞºĞ¸.png",
    "Ğ¢Ñ‘Ğ¼Ğ½Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¸Ğ½Ğ°": "backgrounds/ĞºĞ°Ñ€Ñ‚Ğ°_Ñ‚ĞµĞ¼Ğ½Ğ¾Ğ¹_Ğ´Ğ¾Ğ»Ğ¸Ğ½Ñ‹.png",
    "ĞŸĞ¾Ğ»ÑĞ½Ğ°": "backgrounds/ĞºĞ°Ñ€Ñ‚Ğ°_Ğ¿Ğ¾Ğ»ÑĞ½Ñ‹.png"
}

# ==================== Ğ˜ĞšĞĞĞšĞ˜ ĞŸĞ Ğ•Ğ”ĞœĞ•Ğ¢ĞĞ’ ====================
ITEM_ICONS = {
    "ÑˆĞ¾ĞºĞ¾Ğ»Ğ°Ğ´Ğ½Ñ‹Ğ¹ Ğ±Ğ°Ñ‚Ğ¾Ğ½Ñ‡Ğ¸Ğº": "icons/chocolate.png",
    "Ñ…Ğ»ĞµĞ±": "icons/bread.png",
    "ĞºĞ¾Ğ»Ğ±Ğ°ÑĞ°": "icons/sausage.png",
    "ĞºĞ¾Ğ½ÑĞµÑ€Ğ²Ğ°": "icons/canned_food.png",
    "Ğ±Ğ¸Ğ½Ñ‚": "icons/bandage.png",
    "Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": "icons/first_aid.png",
    "Ğ°Ñ€Ğ¼ĞµĞ¹ÑĞºĞ°Ñ Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": "icons/army_medkit.png",
    "Ğ½Ğ°ÑƒÑ‡Ğ½Ğ°Ñ Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": "icons/science_medkit.png",
    "ÑĞ¸Ğ³Ğ°Ñ€ĞµÑ‚Ñ‹": "icons/cigarettes.png",
    "Ğ²Ğ¾Ğ´ĞºĞ°": "icons/vodka.png",
    "Ñ€Ğ°Ğ´Ğ¸Ğ¾Ğ¿Ñ€Ğ¾Ñ‚ĞµĞºÑ‚Ğ¾Ñ€": "icons/radioprotector.png",
    "Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ°Ğ´": "icons/antirad.png",
    "ÑĞ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸Ğº Ğ½Ğ¾Ğ½ÑÑ‚Ğ¾Ğ¿": "icons/energy_nostop.png",
    "ÑĞ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸Ğº ÑÑ‚Ğ°Ğ»ĞºĞµÑ€": "icons/energy_stalker.png",
    "Ğ³ĞµÑ€ĞºÑƒĞ»ĞµÑ": "icons/hercules.png",
    "Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸": "icons/battery.png",
    "Ğ¿Ğ¾Ğ½Ñ‡Ğ¸Ğº": "icons/ĞŸĞ¾Ğ½Ñ‡Ğ¸Ğº.png",
    "ÑÑ‚ĞµĞ¹Ğº": "icons/Ğ¡Ñ‚ĞµĞ¹Ğº.png",
    "Ğ¶ĞµĞ»ÑƒĞ´ÑŒ": "icons/Ğ–ĞµĞ»ÑƒĞ´ÑŒ.png"
}

# ==================== Ğ¡ĞŸĞ•Ğ¦Ğ˜ĞĞ›Ğ¬ĞĞĞ• ĞĞ Ğ£Ğ–Ğ˜Ğ• ====================
SPECIAL_WEAPONS = {
    "Ğ¡Ğ“Ğ˜ 5Ğº": {"mutant_bonus": 0.5, "radiation_reduce": 0.5},
    "Ğ“Ñ€Ğ¾Ğ¼ Ğ¡14": {"mutant_bonus": 1},
    "ĞĞšĞ¡-103": {"war_bonus_chance": 30, "war_bonus_damage": 1},
    "ĞĞ±Ñ€ĞµĞ· Ğ´Ğ²ÑƒÑÑ‚Ğ²Ğ¾Ğ»ĞºĞ¸": {"shotgun_spread": True},
    "Ğ¢ĞĞ—-34": {"shotgun_spread": True},
    "Ğ¡ĞŸĞ¡Ğ-14": {"shotgun_spread": True}
}

# ==================== Ğ”Ğ•Ğ¢Ğ•ĞšĞ¢ĞĞ Ğ« ====================
DETECTORS = {
    "ĞÑ‚ĞºĞ»Ğ¸Ğº": {"charge": 10, "price": 70},
    "ĞœĞµĞ´Ğ²ĞµĞ´ÑŒ": {"charge": 15, "price": 170},
    "Ğ’ĞµĞ»ĞµÑ": {"charge": 20, "price": 320},
    "Ğ¡Ğ²Ğ°Ñ€Ğ¾Ğ³": {"charge": 24, "price": 500}
}

# ==================== ĞĞĞĞœĞĞ›Ğ¬ĞĞ«Ğ• Ğ—ĞĞĞ« ====================
ANOMALY_ZONES = {
    "ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½": {"Ğ1": "Ğ³Ñ€Ğ°Ğ²Ğ¸", "Ğ2": "ÑĞ»ĞµĞºÑ‚Ñ€Ğ¾", "Ğ3": "Ñ…Ğ¸Ğ¼"},
    "Ğ¡Ğ²Ğ°Ğ»ĞºĞ°": {"Ğ1": "Ñ‚ĞµÑ€Ğ¼Ğ¾", "Ğ2": "Ğ³Ñ€Ğ°Ğ²Ğ¸", "Ğ3": "Ğ³Ñ€Ğ°Ğ²Ğ¸"},
    "Ğ¢Ñ‘Ğ¼Ğ½Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¸Ğ½Ğ°": {"Ğ1": "ÑĞ»ĞµĞºÑ‚Ñ€Ğ¾", "Ğ2": "Ğ³Ñ€Ğ°Ğ²Ğ¸"},
    "ĞŸĞ¾Ğ»ÑĞ½Ğ°": {"Ğ1": "Ğ³Ñ€Ğ°Ğ²Ğ¸", "Ğ2": "ÑĞ»ĞµĞºÑ‚Ñ€Ğ¾", "Ğ3": "Ñ‚ĞµÑ€Ğ¼Ğ¾"}
}

ANOMALY_BUTTONS = {
    "Ğ³Ñ€Ğ°Ğ²Ğ¸": "ğŸŒªï¸ Ğ“Ñ€Ğ°Ğ²Ğ¸ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ğ¸",
    "ÑĞ»ĞµĞºÑ‚Ñ€Ğ¾": "âš¡ Ğ­Ğ»ĞµĞºÑ‚Ñ€Ğ¾ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ğ¸",
    "Ñ…Ğ¸Ğ¼": "â˜£ï¸ Ğ¥Ğ¸Ğ¼ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ğ¸",
    "Ñ‚ĞµÑ€Ğ¼Ğ¾": "ğŸ”¥ Ğ¢ĞµÑ€Ğ¼Ğ¾ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ğ¸"
}

ANOMALY_DAMAGE = {
    "Ğ³Ñ€Ğ°Ğ²Ğ¸": (3, 4.5),
    "ÑĞ»ĞµĞºÑ‚Ñ€Ğ¾": (3, 5),
    "Ñ…Ğ¸Ğ¼": (3.5, 5.5),
    "Ñ‚ĞµÑ€Ğ¼Ğ¾": (3.5, 6)
}

# ==================== ĞĞ Ğ¢Ğ•Ğ¤ĞĞšĞ¢Ğ« ====================
ARTIFACTS = {
    "Ğ³Ñ€Ğ°Ğ²Ğ¸": ["Ğ’ÑĞ¿Ñ‹ÑˆĞºĞ°", "ĞšÑ€Ğ¾Ğ²ÑŒ ĞºĞ°Ğ¼Ğ½Ñ", "Ğ›Ğ¾Ğ¼Ğ¾Ñ‚ÑŒ Ğ¼ÑÑĞ°", "ĞšĞ¾Ğ»ÑÑ‡ĞºĞ°", "Ğ“Ğ»Ğ°Ğ·", "Ğ“Ñ€Ğ°Ğ²Ğ¸", "ĞœĞ°Ğ¼Ğ¸Ğ½Ñ‹ Ğ±ÑƒÑÑ‹", "Ğ—Ğ¾Ğ»Ğ¾Ñ‚Ğ°Ñ Ñ€Ñ‹Ğ±ĞºĞ°"],
    "ÑĞ»ĞµĞºÑ‚Ñ€Ğ¾": ["ĞœĞµĞ´ÑƒĞ·Ğ°", "Ğ¡Ğ»Ğ¸Ğ·ÑŒ", "Ğ‘ĞµĞ½Ğ³Ğ°Ğ»ÑŒÑĞºĞ¸Ğ¹ Ğ¾Ğ³Ğ¾Ğ½ÑŒ", "Ğ”ÑƒÑˆĞ°", "Ğ¡Ğ»ÑĞ´Ğ°", "ĞŸĞ»Ğ°Ğ¼Ñ", "ĞĞ¾Ñ‡Ğ½Ğ°Ñ Ğ·Ğ²ĞµĞ·Ğ´Ğ°", "Ğ‘Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ°"],
    "Ñ…Ğ¸Ğ¼": ["ĞšĞ¾Ğ»Ğ¾Ğ±Ğ¾Ğº", "ĞŸÑƒÑÑ‚Ñ‹ÑˆĞºĞ°", "ĞšĞ°Ğ¼ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ†Ğ²ĞµÑ‚Ğ¾Ğº", "ĞšĞ°Ğ¿Ğ»Ğ¸", "ĞšÑ€Ğ¸ÑÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ ĞºĞ¾Ğ»ÑÑ‡ĞºĞ°", "Ğ›ÑƒĞ½Ğ½Ñ‹Ğ¹ ÑĞ²ĞµÑ‚", "ĞŸÑƒĞ·Ñ‹Ñ€ÑŒ", "ĞŸĞ»Ñ‘Ğ½ĞºĞ°"],
    "Ñ‚ĞµÑ€Ğ¼Ğ¾": ["Ğ’Ñ‹Ğ²ĞµÑ€Ñ‚", "Ğ¡Ğ½ĞµĞ¶Ğ¸Ğ½ĞºĞ°", "ĞĞ³Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹ ÑˆĞ°Ñ€", "Ğ¡Ğ»Ğ¸Ğ·Ğ½ÑĞº", "ĞŸÑ€ÑƒĞ¶Ğ¸Ğ½Ğ°", "Ğ¡Ğ²ĞµÑ‚Ğ»ÑĞº", "ĞšÑ€Ğ¸ÑÑ‚Ğ°Ğ»Ğ»", "ĞœĞ¾Ñ€ÑĞºĞ¾Ğ¹ Ñ‘Ğ¶"]
}

DONATION_ARTIFACTS = ["ĞŸĞ¾Ğ½Ñ‡Ğ¸Ğº", "Ğ¡Ñ‚ĞµĞ¹Ğº"]

ALL_ARTIFACTS = []
for arts in ARTIFACTS.values():
    ALL_ARTIFACTS.extend(arts)
ALL_ARTIFACTS = list(set(ALL_ARTIFACTS + DONATION_ARTIFACTS))

ARTIFACT_EFFECTS = {
    "ĞšÑ€Ğ¾Ğ²ÑŒ ĞºĞ°Ğ¼Ğ½Ñ": {"health_regen": 0.25},
    "Ğ›Ğ¾Ğ¼Ğ¾Ñ‚ÑŒ Ğ¼ÑÑĞ°": {"health_regen": 0.5},
    "Ğ”ÑƒÑˆĞ°": {"health_regen": 0.75},
    "Ğ¡Ğ²ĞµÑ‚Ğ»ÑĞº": {"health_regen": 1},
    "ĞšĞ¾Ğ»Ğ¾Ğ±Ğ¾Ğº": {"radiation_reduce": 0.25},
    "ĞœĞµĞ´ÑƒĞ·Ğ°": {"radiation_reduce": 0.5},
    "Ğ¡Ğ»Ğ¸Ğ·Ğ½ÑĞº": {"radiation_reduce": 0.75},
    "ĞŸÑƒĞ·Ñ‹Ñ€ÑŒ": {"radiation_reduce": 1},
    "Ğ’ÑĞ¿Ñ‹ÑˆĞºĞ°": {"stamina_regen": 0.5},
    "Ğ¡Ğ½ĞµĞ¶Ğ¸Ğ½ĞºĞ°": {"stamina_regen": 1},
    "Ğ›ÑƒĞ½Ğ½Ñ‹Ğ¹ ÑĞ²ĞµÑ‚": {"stamina_regen": 1.5},
    "Ğ‘Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ°": {"stamina_regen": 2},
    "Ğ‘ĞµĞ½Ğ³Ğ°Ğ»ÑŒÑĞºĞ¸Ğ¹ Ğ¾Ğ³Ğ¾Ğ½ÑŒ": {"blast_resist": 0.25},
    "Ğ’Ñ‹Ğ²ĞµÑ€Ñ‚": {"blast_resist": 0.5},
    "Ğ“Ñ€Ğ°Ğ²Ğ¸": {"blast_resist": 0.75},
    "Ğ—Ğ¾Ğ»Ğ¾Ñ‚Ğ°Ñ Ñ€Ñ‹Ğ±ĞºĞ°": {"blast_resist": 1},
    "ĞŸÑƒÑÑ‚Ñ‹ÑˆĞºĞ°": {"bullet_resist": 0.5},
    "ĞšĞ°Ğ¼ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ†Ğ²ĞµÑ‚Ğ¾Ğº": {"bullet_resist": 1},
    "ĞĞ¾Ñ‡Ğ½Ğ°Ñ Ğ·Ğ²ĞµĞ·Ğ´Ğ°": {"bullet_resist": 1.5},
    "ĞšÑ€Ğ¸ÑÑ‚Ğ°Ğ»Ğ»": {"bullet_resist": 2},
    "ĞšĞ¾Ğ»ÑÑ‡ĞºĞ°": {"anomaly_resist": 0.25},
    "ĞŸĞ»Ğ°Ğ¼Ñ": {"anomaly_resist": 0.5},
    "ĞĞ³Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹ ÑˆĞ°Ñ€": {"anomaly_resist": 0.75},
    "ĞŸĞ»Ñ‘Ğ½ĞºĞ°": {"anomaly_resist": 1},
    "Ğ“Ğ»Ğ°Ğ·": {"weapon_damage": 0.5},
    "ĞšĞ°Ğ¿Ğ»Ğ¸": {"weapon_damage": 1},
    "ĞšÑ€Ğ¸ÑÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ ĞºĞ¾Ğ»ÑÑ‡ĞºĞ°": {"weapon_damage": 1.5},
    "ĞŸÑ€ÑƒĞ¶Ğ¸Ğ½Ğ°": {"weapon_damage": 2},
    "Ğ¡Ğ»Ğ¸Ğ·ÑŒ": {"weapon_accuracy": 0.5},
    "Ğ¡Ğ»ÑĞ´Ğ°": {"weapon_accuracy": 1},
    "ĞœĞ°Ğ¼Ğ¸Ğ½Ñ‹ Ğ±ÑƒÑÑ‹": {"weapon_accuracy": 1.5},
    "ĞœĞ¾Ñ€ÑĞºĞ¾Ğ¹ Ñ‘Ğ¶": {"weapon_accuracy": 2},
    "ĞŸĞ¾Ğ½Ñ‡Ğ¸Ğº": {"heal_on_consume": 0.5},
    "Ğ¡Ñ‚ĞµĞ¹Ğº": {"hunger_on_consume": 0.5}
}

ARTIFACT_PRICES = {
    "ĞšÑ€Ğ¾Ğ²ÑŒ ĞºĞ°Ğ¼Ğ½Ñ": 15, "ĞšĞ¾Ğ»Ğ¾Ğ±Ğ¾Ğº": 15, "Ğ’ÑĞ¿Ñ‹ÑˆĞºĞ°": 15, "Ğ‘ĞµĞ½Ğ³Ğ°Ğ»ÑŒÑĞºĞ¸Ğ¹ Ğ¾Ğ³Ğ¾Ğ½ÑŒ": 15,
    "ĞŸÑƒÑÑ‚Ñ‹ÑˆĞºĞ°": 15, "ĞšĞ¾Ğ»ÑÑ‡ĞºĞ°": 15, "Ğ“Ğ»Ğ°Ğ·": 15, "Ğ¡Ğ»Ğ¸Ğ·ÑŒ": 15,
    "Ğ›Ğ¾Ğ¼Ğ¾Ñ‚ÑŒ Ğ¼ÑÑĞ°": 25, "ĞœĞµĞ´ÑƒĞ·Ğ°": 25, "Ğ¡Ğ½ĞµĞ¶Ğ¸Ğ½ĞºĞ°": 25, "Ğ’Ñ‹Ğ²ĞµÑ€Ñ‚": 25,
    "ĞšĞ°Ğ¼ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ†Ğ²ĞµÑ‚Ğ¾Ğº": 25, "ĞŸĞ»Ğ°Ğ¼Ñ": 25, "ĞšĞ°Ğ¿Ğ»Ğ¸": 25, "Ğ¡Ğ»ÑĞ´Ğ°": 25,
    "Ğ”ÑƒÑˆĞ°": 35, "Ğ¡Ğ»Ğ¸Ğ·Ğ½ÑĞº": 35, "Ğ›ÑƒĞ½Ğ½Ñ‹Ğ¹ ÑĞ²ĞµÑ‚": 35, "Ğ“Ñ€Ğ°Ğ²Ğ¸": 35,
    "ĞĞ¾Ñ‡Ğ½Ğ°Ñ Ğ·Ğ²ĞµĞ·Ğ´Ğ°": 35, "ĞĞ³Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹ ÑˆĞ°Ñ€": 35, "ĞšÑ€Ğ¸ÑÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ ĞºĞ¾Ğ»ÑÑ‡ĞºĞ°": 35, "ĞœĞ°Ğ¼Ğ¸Ğ½Ñ‹ Ğ±ÑƒÑÑ‹": 35,
    "Ğ¡Ğ²ĞµÑ‚Ğ»ÑĞº": 45, "ĞŸÑƒĞ·Ñ‹Ñ€ÑŒ": 45, "Ğ‘Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ°": 45, "Ğ—Ğ¾Ğ»Ğ¾Ñ‚Ğ°Ñ Ñ€Ñ‹Ğ±ĞºĞ°": 45,
    "ĞšÑ€Ğ¸ÑÑ‚Ğ°Ğ»Ğ»": 45, "ĞŸĞ»Ñ‘Ğ½ĞºĞ°": 45, "ĞŸÑ€ÑƒĞ¶Ğ¸Ğ½Ğ°": 45, "ĞœĞ¾Ñ€ÑĞºĞ¾Ğ¹ Ñ‘Ğ¶": 45
}

ARTIFACT_ICONS = {
    "Ğ’ÑĞ¿Ñ‹ÑˆĞºĞ°": "icons/Ğ’ÑĞ¿Ñ‹ÑˆĞºĞ°.png", "ĞšÑ€Ğ¾Ğ²ÑŒ ĞºĞ°Ğ¼Ğ½Ñ": "icons/ĞšÑ€Ğ¾Ğ²ÑŒ_ĞºĞ°Ğ¼Ğ½Ñ.png",
    "Ğ›Ğ¾Ğ¼Ğ¾Ñ‚ÑŒ Ğ¼ÑÑĞ°": "icons/Ğ›Ğ¾Ğ¼Ğ¾Ñ‚ÑŒ_Ğ¼ÑÑĞ°.png", "ĞšĞ¾Ğ»ÑÑ‡ĞºĞ°": "icons/ĞšĞ¾Ğ»ÑÑ‡ĞºĞ°.png",
    "Ğ“Ğ»Ğ°Ğ·": "icons/Ğ“Ğ»Ğ°Ğ·.png", "Ğ“Ñ€Ğ°Ğ²Ğ¸": "icons/Ğ“Ñ€Ğ°Ğ²Ğ¸.png",
    "ĞœĞ°Ğ¼Ğ¸Ğ½Ñ‹ Ğ±ÑƒÑÑ‹": "icons/ĞœĞ°Ğ¼Ğ¸Ğ½Ñ‹_Ğ±ÑƒÑÑ‹.png", "Ğ—Ğ¾Ğ»Ğ¾Ñ‚Ğ°Ñ Ñ€Ñ‹Ğ±ĞºĞ°": "icons/Ğ—Ğ¾Ğ»Ğ¾Ñ‚Ğ°Ñ_Ñ€Ñ‹Ğ±ĞºĞ°.png",
    "ĞœĞµĞ´ÑƒĞ·Ğ°": "icons/ĞœĞµĞ´ÑƒĞ·Ğ°.png", "Ğ¡Ğ»Ğ¸Ğ·ÑŒ": "icons/Ğ¡Ğ»Ğ¸Ğ·ÑŒ.png",
    "Ğ‘ĞµĞ½Ğ³Ğ°Ğ»ÑŒÑĞºĞ¸Ğ¹ Ğ¾Ğ³Ğ¾Ğ½ÑŒ": "icons/Ğ‘ĞµĞ½Ğ³Ğ°Ğ»ÑŒÑĞºĞ¸Ğ¹_Ğ¾Ğ³Ğ¾Ğ½ÑŒ.png", "Ğ”ÑƒÑˆĞ°": "icons/Ğ”ÑƒÑˆĞ°.png",
    "Ğ¡Ğ»ÑĞ´Ğ°": "icons/Ğ¡Ğ»ÑĞ´Ğ°.png", "ĞŸĞ»Ğ°Ğ¼Ñ": "icons/ĞŸĞ»Ğ°Ğ¼Ñ.png",
    "ĞĞ¾Ñ‡Ğ½Ğ°Ñ Ğ·Ğ²ĞµĞ·Ğ´Ğ°": "icons/ĞĞ¾Ñ‡Ğ½Ğ°Ñ_Ğ·Ğ²ĞµĞ·Ğ´Ğ°.png", "Ğ‘Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ°": "icons/Ğ‘Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ°.png",
    "ĞšĞ¾Ğ»Ğ¾Ğ±Ğ¾Ğº": "icons/ĞšĞ¾Ğ»Ğ¾Ğ±Ğ¾Ğº.png", "ĞŸÑƒÑÑ‚Ñ‹ÑˆĞºĞ°": "icons/ĞŸÑƒÑÑ‚Ñ‹ÑˆĞºĞ°.png",
    "ĞšĞ°Ğ¼ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ†Ğ²ĞµÑ‚Ğ¾Ğº": "icons/ĞšĞ°Ğ¼ĞµĞ½Ğ½Ñ‹Ğ¹_Ñ†Ğ²ĞµÑ‚Ğ¾Ğº.png", "ĞšĞ°Ğ¿Ğ»Ğ¸": "icons/ĞšĞ°Ğ¿Ğ»Ğ¸.png",
    "ĞšÑ€Ğ¸ÑÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ ĞºĞ¾Ğ»ÑÑ‡ĞºĞ°": "icons/ĞšÑ€Ğ¸ÑÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ_ĞºĞ¾Ğ»ÑÑ‡ĞºĞ°.png", "Ğ›ÑƒĞ½Ğ½Ñ‹Ğ¹ ÑĞ²ĞµÑ‚": "icons/Ğ›ÑƒĞ½Ğ½Ñ‹Ğ¹_ÑĞ²ĞµÑ‚.png",
    "ĞŸÑƒĞ·Ñ‹Ñ€ÑŒ": "icons/ĞŸÑƒĞ·Ñ‹Ñ€ÑŒ.png", "ĞŸĞ»Ñ‘Ğ½ĞºĞ°": "icons/ĞŸĞ»ĞµĞ½ĞºĞ°.png",
    "Ğ’Ñ‹Ğ²ĞµÑ€Ñ‚": "icons/Ğ’Ñ‹Ğ²ĞµÑ€Ñ‚.png", "Ğ¡Ğ½ĞµĞ¶Ğ¸Ğ½ĞºĞ°": "icons/Ğ¡Ğ½ĞµĞ¶Ğ¸Ğ½ĞºĞ°.png",
    "ĞĞ³Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹ ÑˆĞ°Ñ€": "icons/ĞĞ³Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹_ÑˆĞ°Ñ€.png", "Ğ¡Ğ»Ğ¸Ğ·Ğ½ÑĞº": "icons/Ğ¡Ğ»Ğ¸Ğ·Ğ½ÑĞº.png",
    "ĞŸÑ€ÑƒĞ¶Ğ¸Ğ½Ğ°": "icons/ĞŸÑ€ÑƒĞ¶Ğ¸Ğ½Ğ°.png", "Ğ¡Ğ²ĞµÑ‚Ğ»ÑĞº": "icons/Ğ¡Ğ²ĞµÑ‚Ğ»ÑĞº.png",
    "ĞšÑ€Ğ¸ÑÑ‚Ğ°Ğ»Ğ»": "icons/ĞšÑ€Ğ¸ÑÑ‚Ğ°Ğ»Ğ».png", "ĞœĞ¾Ñ€ÑĞºĞ¾Ğ¹ Ñ‘Ğ¶": "icons/ĞœĞ¾Ñ€ÑĞºĞ¾Ğ¹_ĞµĞ¶.png",
    "ĞŸĞ¾Ğ½Ñ‡Ğ¸Ğº": "icons/ĞŸĞ¾Ğ½Ñ‡Ğ¸Ğº.png", "Ğ¡Ñ‚ĞµĞ¹Ğº": "icons/Ğ¡Ñ‚ĞµĞ¹Ğº.png"
}

# ==================== Ğ”ĞĞĞĞ¢ ====================
DONATION_DURATIONS = {"Ğ´ĞµĞ½ÑŒ": 86400, "Ğ½ĞµĞ´ĞµĞ»Ñ": 604800, "Ğ¼ĞµÑÑÑ†": 2592000}
DONATION_EXCLUDED_ITEMS = ["Ğ²Ğ¾Ğ´ĞºĞ°", "ÑĞ¸Ğ³Ğ°Ñ€ĞµÑ‚Ñ‹", "ÑĞ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸Ğº Ğ½Ğ¾Ğ½ÑÑ‚Ğ¾Ğ¿", "ÑĞ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸Ğº ÑÑ‚Ğ°Ğ»ĞºĞµÑ€", "Ğ³ĞµÑ€ĞºÑƒĞ»ĞµÑ"]

# ==================== Ğ“Ğ Ğ£ĞŸĞŸĞ˜Ğ ĞĞ’ĞšĞ˜ ====================
FACTION_ICONS = {
    "ğŸ›¡ï¸ Ğ”Ğ¾Ğ»Ğ³": "icons/dolg.png",
    "â˜¦ï¸ Ğ“Ñ€ĞµÑ…": "icons/greh.png",
    "â˜¢ï¸ ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸": "icons/odinochki.png"
}

ZOMBIE_FACTION = "ğŸ§Ÿ Ğ—Ğ¾Ğ¼Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ"
FACTION_ICONS[ZOMBIE_FACTION] = "icons/Ğ·Ğ¾Ğ¼Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ.png"

FACTION_START_LOCATIONS = {
    "ğŸ›¡ï¸ Ğ”Ğ¾Ğ»Ğ³": ("ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½", "Ğ‘1"),
    "â˜¦ï¸ Ğ“Ñ€ĞµÑ…": ("Ğ¢Ñ‘Ğ¼Ğ½Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¸Ğ½Ğ°", "Ğ‘1"),
    "â˜¢ï¸ ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸": ("Ğ¡Ğ²Ğ°Ğ»ĞºĞ°", "Ğ‘1")
}

FACTION_CHAT_LINKS = {
    "ğŸ›¡ï¸ Ğ”Ğ¾Ğ»Ğ³": "https://vk.me/join//eWcWfZ3Kcr3PZtkGLF91BIxJq4GnZ4aeB8=",
    "â˜¦ï¸ Ğ“Ñ€ĞµÑ…": "https://vk.me/join/gO2fqOqDnL756hWkhjvMm9P2ypNTz7/r2vw=",
    "â˜¢ï¸ ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸": "https://vk.me/join/ynzBEUOPUmsKVaB0K0BhSFnzGZsNJlrFGNY="
}

# ==================== Ğ¢Ğ˜ĞŸĞ« Ğ¢ĞĞ§Ğ•Ğš ====================
POINT_TYPES = {
    "Ğ‘1": "Ğ‘Ğ°Ğ·Ğ°", "Ğ‘2": "Ğ‘Ğ°Ğ·Ğ°", "Ğ‘3": "Ğ‘Ğ°Ğ·Ğ°", "Ğ‘4": "Ğ‘Ğ°Ğ·Ğ°",
    "Ğ¢1": "Ğ¢ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ", "Ğ¢2": "Ğ¢ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ", "Ğ¢3": "Ğ¢ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ", "Ğ¢4": "Ğ¢ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ", "Ğ¢5": "Ğ¢ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ",
    "Ğ¢Ğ 1": "Ğ¢Ğ¾Ñ‡ĞºĞ° Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²", "Ğ¢Ğ 2": "Ğ¢Ğ¾Ñ‡ĞºĞ° Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²", "Ğ¢Ğ 3": "Ğ¢Ğ¾Ñ‡ĞºĞ° Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²",
    "Ğ1": "ĞĞ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ·Ğ¾Ğ½Ğ°", "Ğ2": "ĞĞ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ·Ğ¾Ğ½Ğ°", "Ğ3": "ĞĞ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ·Ğ¾Ğ½Ğ°",
    "Ğ›1": "Ğ›Ğ¾Ğ³Ğ¾Ğ²Ğ¾", "Ğ›2": "Ğ›Ğ¾Ğ³Ğ¾Ğ²Ğ¾", "Ğ›3": "Ğ›Ğ¾Ğ³Ğ¾Ğ²Ğ¾", "Ğ›4": "Ğ›Ğ¾Ğ³Ğ¾Ğ²Ğ¾", "Ğ›5": "Ğ›Ğ¾Ğ³Ğ¾Ğ²Ğ¾"
}

# ==================== Ğ›ĞĞšĞĞ¦Ğ˜Ğ˜ ====================
LOCATIONS = {
    "ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½": ["Ğ¢1", "Ğ¢2", "Ğ¢3", "Ğ¢4", "Ğ¢5", "Ğ¢Ğ 1", "Ğ¢Ğ 2", "Ğ¢Ğ 3", "Ğ‘1", "Ğ‘2", "Ğ‘3", "Ğ‘4", "Ğ1", "Ğ2", "Ğ3", "Ğ›1", "Ğ›2", "Ğ›3", "Ğ›4", "Ğ›5"],
    "Ğ¡Ğ²Ğ°Ğ»ĞºĞ°": ["Ğ¢1", "Ğ¢2", "Ğ¢3", "Ğ¢Ğ 1", "Ğ¢Ğ 2", "Ğ¢Ğ 3", "Ğ‘1", "Ğ‘2", "Ğ1", "Ğ2", "Ğ3", "Ğ›1", "Ğ›2", "Ğ›3", "Ğ›4"],
    "Ğ¢Ñ‘Ğ¼Ğ½Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¸Ğ½Ğ°": ["Ğ¢1", "Ğ¢2", "Ğ¢3", "Ğ¢Ğ 1", "Ğ¢Ğ 2", "Ğ‘1", "Ğ‘2", "Ğ‘3", "Ğ1", "Ğ2", "Ğ›1", "Ğ›2", "Ğ›3", "Ğ›4"],
    "ĞŸĞ¾Ğ»ÑĞ½Ğ°": ["Ğ¢1", "Ğ¢2", "Ğ¢Ğ 1", "Ğ¢Ğ 2", "Ğ¢Ğ 3", "Ğ‘1", "Ğ‘2", "Ğ‘3", "Ğ1", "Ğ2", "Ğ3", "Ğ›1", "Ğ›2"]
}

BASE_POINTS = {"ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½": "Ğ‘1", "Ğ¡Ğ²Ğ°Ğ»ĞºĞ°": "Ğ‘1", "Ğ¢Ñ‘Ğ¼Ğ½Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¸Ğ½Ğ°": "Ğ‘1"}

# ==================== ĞœĞĞ Ğ¨Ğ Ğ£Ğ¢Ğ« ĞŸĞ•Ğ Ğ•Ğ¥ĞĞ”ĞĞ’ ====================
TRANSITION_ROUTES = {
    ("ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½", "Ğ¢3"): [("Ğ¢Ñ‘Ğ¼Ğ½Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¸Ğ½Ğ°", "Ğ‘1")],
    ("ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½", "Ğ›3"): [("ĞŸĞ¾Ğ»ÑĞ½Ğ°", "Ğ¢1")],
    ("ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½", "Ğ‘4"): [("Ğ¡Ğ²Ğ°Ğ»ĞºĞ°", "Ğ¢1")],
    ("Ğ¡Ğ²Ğ°Ğ»ĞºĞ°", "Ğ¢1"): [("ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½", "Ğ‘4")],
    ("Ğ¡Ğ²Ğ°Ğ»ĞºĞ°", "Ğ›2"): [("ĞŸĞ¾Ğ»ÑĞ½Ğ°", "Ğ›2")],
    ("Ğ¡Ğ²Ğ°Ğ»ĞºĞ°", "Ğ›3"): [("Ğ¢Ñ‘Ğ¼Ğ½Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¸Ğ½Ğ°", "Ğ›4")],
    ("Ğ¢Ñ‘Ğ¼Ğ½Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¸Ğ½Ğ°", "Ğ‘1"): [("ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½", "Ğ¢3")],
    ("Ğ¢Ñ‘Ğ¼Ğ½Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¸Ğ½Ğ°", "Ğ›4"): [("Ğ¡Ğ²Ğ°Ğ»ĞºĞ°", "Ğ›3")],
    ("Ğ¢Ñ‘Ğ¼Ğ½Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¸Ğ½Ğ°", "Ğ›3"): [("ĞŸĞ¾Ğ»ÑĞ½Ğ°", "Ğ¢Ğ 1")],
    ("ĞŸĞ¾Ğ»ÑĞ½Ğ°", "Ğ¢Ğ 1"): [("Ğ¢Ñ‘Ğ¼Ğ½Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¸Ğ½Ğ°", "Ğ›3")],
    ("ĞŸĞ¾Ğ»ÑĞ½Ğ°", "Ğ¢1"): [("ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½", "Ğ›3")],
    ("ĞŸĞ¾Ğ»ÑĞ½Ğ°", "Ğ›2"): [("Ğ¡Ğ²Ğ°Ğ»ĞºĞ°", "Ğ›2")]
}

# ==================== ĞšĞĞĞ Ğ”Ğ˜ĞĞĞ¢Ğ« Ğ¢ĞĞ§Ğ•Ğš ====================
POINT_COORDINATES = {
    "ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½": {
        "Ğ‘1": (136, 866), "Ğ‘2": (100, 693), "Ğ‘3": (322, 604), "Ğ‘4": (256, 92),
        "Ğ¢1": (85, 791), "Ğ¢2": (283, 491), "Ğ¢3": (482, 615), "Ğ¢4": (130, 434), "Ğ¢5": (343, 370),
        "Ğ›1": (174, 748), "Ğ›2": (142, 573), "Ğ›3": (425, 510), "Ğ›4": (420, 373), "Ğ›5": (325, 253),
        "Ğ¢Ğ 1": (180, 648), "Ğ¢Ğ 2": (236, 546), "Ğ¢Ğ 3": (245, 400),
        "Ğ1": (62, 611), "Ğ2": (190, 483), "Ğ3": (500, 413)
    },
    "Ğ¡Ğ²Ğ°Ğ»ĞºĞ°": {
        "Ğ‘1": (413, 406), "Ğ‘2": (661, 192),
        "Ğ¢1": (608, 906), "Ğ¢2": (667, 642), "Ğ¢3": (227, 451),
        "Ğ›1": (666, 765), "Ğ›2": (869, 664), "Ğ›3": (879, 390), "Ğ›4": (358, 177),
        "Ğ¢Ğ 1": (407, 727), "Ğ¢Ğ 2": (207, 628), "Ğ¢Ğ 3": (593, 86),
        "Ğ1": (471, 578), "Ğ2": (683, 387), "Ğ3": (448, 262)
    },
    "Ğ¢Ñ‘Ğ¼Ğ½Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¸Ğ½Ğ°": {
        "Ğ‘1": (288, 858), "Ğ‘2": (626, 516), "Ğ‘3": (486, 238),
        "Ğ¢1": (503, 441), "Ğ¢2": (363, 180), "Ğ¢3": (593, 201),
        "Ğ›1": (583, 790), "Ğ›2": (509, 650), "Ğ›3": (307, 643), "Ğ›4": (308, 452),
        "Ğ¢Ğ 1": (381, 374), "Ğ¢Ğ 2": (464, 136),
        "Ğ1": (439, 517), "Ğ2": (627, 410)
    },
    "ĞŸĞ¾Ğ»ÑĞ½Ğ°": {
        "Ğ‘1": (451, 751), "Ğ‘2": (1203, 495), "Ğ‘3": (915, 279),
        "Ğ¢1": (205, 761), "Ğ¢2": (1051, 401),
        "Ğ›1": (135, 575), "Ğ›2": (557, 143),
        "Ğ¢Ğ 1": (985, 649), "Ğ¢Ğ 2": (521, 527), "Ğ¢Ğ 3": (423, 331),
        "Ğ1": (743, 633), "Ğ2": (373, 499), "Ğ3": (607, 327)
    }
}

# ==================== Ğ­Ğ¤Ğ¤Ğ•ĞšĞ¢Ğ« ĞŸĞ Ğ•Ğ”ĞœĞ•Ğ¢ĞĞ’ ====================
ITEM_EFFECTS = {
    "ÑˆĞ¾ĞºĞ¾Ğ»Ğ°Ğ´Ğ½Ñ‹Ğ¹ Ğ±Ğ°Ñ‚Ğ¾Ğ½Ñ‡Ğ¸Ğº": {"hunger": -0.5},
    "Ñ…Ğ»ĞµĞ±": {"hunger": -1},
    "ĞºĞ¾Ğ»Ğ±Ğ°ÑĞ°": {"hunger": -1.5},
    "ĞºĞ¾Ğ½ÑĞµÑ€Ğ²Ğ°": {"hunger": -2},
    "Ğ±Ğ¸Ğ½Ñ‚": {"health": 0.5},
    "Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": {"health": 1},
    "Ğ°Ñ€Ğ¼ĞµĞ¹ÑĞºĞ°Ñ Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": {"health": 1.5},
    "Ğ½Ğ°ÑƒÑ‡Ğ½Ğ°Ñ Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": {"health": 1.5, "radiation": -0.5},
    "ÑĞ¸Ğ³Ğ°Ñ€ĞµÑ‚Ñ‹": {"radiation": -0.5},
    "Ğ²Ğ¾Ğ´ĞºĞ°": {"radiation": -1},
    "Ñ€Ğ°Ğ´Ğ¸Ğ¾Ğ¿Ñ€Ğ¾Ñ‚ĞµĞºÑ‚Ğ¾Ñ€": {"radiation": -1.5},
    "Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ°Ğ´": {"radiation": -2},
    "ÑĞ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸Ğº Ğ½Ğ¾Ğ½ÑÑ‚Ğ¾Ğ¿": {"stamina": 3},
    "ÑĞ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸Ğº ÑÑ‚Ğ°Ğ»ĞºĞµÑ€": {"stamina": 5},
    "Ğ³ĞµÑ€ĞºÑƒĞ»ĞµÑ": {"stamina": 7},
    "Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸": {},
    "Ğ¶ĞµĞ»ÑƒĞ´ÑŒ": {"random_effect": True}
}

# ==================== ĞšĞĞ¢Ğ•Ğ“ĞĞ Ğ˜Ğ˜ ĞŸĞ Ğ•Ğ”ĞœĞ•Ğ¢ĞĞ’ ====================
CATEGORIES = {
    "ĞµĞ´Ğ°": ["ÑˆĞ¾ĞºĞ¾Ğ»Ğ°Ğ´Ğ½Ñ‹Ğ¹ Ğ±Ğ°Ñ‚Ğ¾Ğ½Ñ‡Ğ¸Ğº", "Ñ…Ğ»ĞµĞ±", "ĞºĞ¾Ğ»Ğ±Ğ°ÑĞ°", "ĞºĞ¾Ğ½ÑĞµÑ€Ğ²Ğ°", "Ğ³ĞµÑ€ĞºÑƒĞ»ĞµÑ"],
    "Ğ¼ĞµĞ´Ğ¸ĞºĞ°Ğ¼ĞµĞ½Ñ‚Ñ‹": ["Ğ±Ğ¸Ğ½Ñ‚", "Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°", "Ğ°Ñ€Ğ¼ĞµĞ¹ÑĞºĞ°Ñ Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°", "Ğ½Ğ°ÑƒÑ‡Ğ½Ğ°Ñ Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°"],
    "Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ°Ğ´": ["ÑĞ¸Ğ³Ğ°Ñ€ĞµÑ‚Ñ‹", "Ğ²Ğ¾Ğ´ĞºĞ°", "Ñ€Ğ°Ğ´Ğ¸Ğ¾Ğ¿Ñ€Ğ¾Ñ‚ĞµĞºÑ‚Ğ¾Ñ€", "Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ°Ğ´"],
    "ÑĞ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸ĞºĞ¸": ["ÑĞ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸Ğº Ğ½Ğ¾Ğ½ÑÑ‚Ğ¾Ğ¿", "ÑĞ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸Ğº ÑÑ‚Ğ°Ğ»ĞºĞµÑ€"],
    "Ğ¿Ñ€Ğ¾Ñ‡ĞµĞµ": ["Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸", "Ğ¶ĞµĞ»ÑƒĞ´ÑŒ"],
    "Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹": ALL_ARTIFACTS
}

# ==================== Ğ¦Ğ•ĞĞ« ====================
BUY_PRICES = {
    "ÑˆĞ¾ĞºĞ¾Ğ»Ğ°Ğ´Ğ½Ñ‹Ğ¹ Ğ±Ğ°Ñ‚Ğ¾Ğ½Ñ‡Ğ¸Ğº": 5, "Ñ…Ğ»ĞµĞ±": 10, "ĞºĞ¾Ğ»Ğ±Ğ°ÑĞ°": 15, "ĞºĞ¾Ğ½ÑĞµÑ€Ğ²Ğ°": 20,
    "Ğ±Ğ¸Ğ½Ñ‚": 10, "Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": 15, "Ğ°Ñ€Ğ¼ĞµĞ¹ÑĞºĞ°Ñ Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": 20, "Ğ½Ğ°ÑƒÑ‡Ğ½Ğ°Ñ Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": 34,
    "ÑĞ¸Ğ³Ğ°Ñ€ĞµÑ‚Ñ‹": 5, "Ğ²Ğ¾Ğ´ĞºĞ°": 10, "Ñ€Ğ°Ğ´Ğ¸Ğ¾Ğ¿Ñ€Ğ¾Ñ‚ĞµĞºÑ‚Ğ¾Ñ€": 15, "Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ°Ğ´": 20,
    "ÑĞ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸Ğº Ğ½Ğ¾Ğ½ÑÑ‚Ğ¾Ğ¿": 21, "ÑĞ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸Ğº ÑÑ‚Ğ°Ğ»ĞºĞµÑ€": 35, "Ğ³ĞµÑ€ĞºÑƒĞ»ĞµÑ": 50, "Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸": 3
}

SELL_PRICES = {
    "ÑˆĞ¾ĞºĞ¾Ğ»Ğ°Ğ´Ğ½Ñ‹Ğ¹ Ğ±Ğ°Ñ‚Ğ¾Ğ½Ñ‡Ğ¸Ğº": 2, "Ñ…Ğ»ĞµĞ±": 5, "ĞºĞ¾Ğ»Ğ±Ğ°ÑĞ°": 7, "ĞºĞ¾Ğ½ÑĞµÑ€Ğ²Ğ°": 10,
    "Ğ±Ğ¸Ğ½Ñ‚": 5, "Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": 7, "Ğ°Ñ€Ğ¼ĞµĞ¹ÑĞºĞ°Ñ Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": 10, "Ğ½Ğ°ÑƒÑ‡Ğ½Ğ°Ñ Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": 17,
    "ÑĞ¸Ğ³Ğ°Ñ€ĞµÑ‚Ñ‹": 2, "Ğ²Ğ¾Ğ´ĞºĞ°": 5, "Ñ€Ğ°Ğ´Ğ¸Ğ¾Ğ¿Ñ€Ğ¾Ñ‚ĞµĞºÑ‚Ğ¾Ñ€": 7, "Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ°Ğ´": 10,
    "ÑĞ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸Ğº Ğ½Ğ¾Ğ½ÑÑ‚Ğ¾Ğ¿": 5, "ÑĞ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸Ğº ÑÑ‚Ğ°Ğ»ĞºĞµÑ€": 10, "Ğ³ĞµÑ€ĞºÑƒĞ»ĞµÑ": 20, "Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸": 0.5
}

# ==================== Ğ¡ĞĞĞ Ğ¯Ğ–Ğ•ĞĞ˜Ğ• ====================
EQUIPMENT = {
    "â˜¢ï¸ ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸": {
        "weapon": [
            ("ĞŸĞ‘-1Ñ", 2, 1, 1, 200), ("ĞšĞ¾Ñ€Ğ°-919", 3, 1, 2, 300),
            ("ĞĞ±Ñ€ĞµĞ· Ğ´Ğ²ÑƒÑÑ‚Ğ²Ğ¾Ğ»ĞºĞ¸", 3.5, 2, 1, 730), ("Ğ“Ğ°Ğ´ÑĞºĞ°", 4, 1, 5, 770),
            ("Ğ¢Ğ Ñ", 3.5, 2, 2, 780), ("ĞĞšĞœ-74/2", 4, 2, 3, 870),
            ("Ğ¢ĞĞ—-34", 4, 3, 1, 970), ("Ğ¡ĞŸĞ¡Ğ-14", 4.5, 4, 1, 1210),
            ("Ğ¡Ğ“Ğ˜ 5Ğº", 4.5, 4, 3, 1410)
        ],
        "armor": [
            ("ĞšĞ¾Ğ¶Ğ°Ğ½Ğ°Ñ ĞºÑƒÑ€Ñ‚ĞºĞ°", 3, 0, 1, 0, 250),
            ("ĞšĞ¾Ğ¼Ğ±Ğ¸Ğ½ĞµĞ·Ğ¾Ğ½ Â«Ğ—Ğ°Ñ€ÑÂ»", 4, 0, 1, 1, 500),
            ("ĞšĞ¾Ğ¼Ğ±Ğ¸Ğ½ĞµĞ·Ğ¾Ğ½ Â«Ğ¡Ğ•Ğ’ĞÂ»", 5, 1, 1, 3, 1300),
            ("Ğ¢ÑĞ¶Ñ‘Ğ»Ñ‹Ğ¹ Ğ±Ñ€Ğ¾Ğ½ĞµĞºĞ¾ÑÑ‚ÑĞ¼ Â«Ğ¢Ğ‘Â»", 6, 3, 3, 2, 2350),
            ("Ğ­ĞºĞ·Ğ¾ÑĞºĞµĞ»ĞµÑ‚ Ğ½ĞµĞ¹Ñ‚Ñ€Ğ°Ğ»Ğ¾Ğ²", 7, 4, 4, 2, 3000)
        ]
    },
    "ğŸ›¡ï¸ Ğ”Ğ¾Ğ»Ğ³": {
        "weapon": [
            ("ĞŸĞœ", 1.5, 1, 1, 150), ("Ğ¤Ğ¾Ñ€Ğ°-12", 2.5, 1, 1, 250),
            ("Ğ“Ğ°Ğ´ÑĞºĞ°", 4, 1, 5, 770), ("ĞĞšĞ¡-74Ñƒ", 4, 2, 2, 770),
            ("Ğ˜Ğ›-85", 4, 2, 3, 870), ("ĞĞ¡ Ğ’ĞĞ›", 4.5, 2, 5, 1010),
            ("ĞĞ±Ğ°ĞºĞ°Ğ½", 4, 3, 3, 1070), ("Ğ¡ĞŸĞ¡Ğ-14", 4.5, 4, 1, 1210),
            ("Ğ“Ñ€Ğ¾Ğ¼ Ğ¡14", 4.5, 4, 3, 1410)
        ],
        "armor": [
            ("ĞšÑƒÑ€Ñ‚ĞºĞ° Ğ”Ğ¾Ğ»Ğ³Ğ°", 3, 0, 1, 0, 250),
            ("ĞŸĞ¡5-Ğœ Â«Ğ£Ğ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°Â»", 4, 1, 1, 0, 750),
            ("ĞŸĞ¡Ğ—-9ĞœĞ´ Â«Ğ£Ğ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°Â»", 5, 2, 2, 1, 1550),
            ("ĞŸĞ¡Ğ—-9Ğ´ Ğ‘Ñ€Ğ¾Ğ½Ñ Â«Ğ”Ğ¾Ğ»Ğ³Ğ°Â»", 6, 3, 4, 1, 2350),
            ("Ğ­ĞºĞ·Ğ¾ÑĞºĞµĞ»ĞµÑ‚ Â«Ğ”Ğ¾Ğ»Ğ³Ğ°Â»", 7, 4, 5, 1, 3000)
        ]
    },
    "â˜¦ï¸ Ğ“Ñ€ĞµÑ…": {
        "weapon": [
            ("ĞŸĞ‘-1Ñ", 2, 1, 1, 200), ("ĞšĞ¾Ñ€Ğ°-919", 3, 1, 2, 300),
            ("ĞĞ±Ñ€ĞµĞ· Ğ´Ğ²ÑƒÑÑ‚Ğ²Ğ¾Ğ»ĞºĞ¸", 3.5, 2, 1, 730), ("Ğ“Ğ°Ğ´ÑĞºĞ°", 4, 1, 5, 770),
            ("ĞĞšĞœ-74/2", 4, 2, 3, 870), ("Ğ¢ĞĞ—-34", 4, 3, 1, 970),
            ("ĞĞšĞ¡-103", 5, 2, 4, 1000), ("ĞĞ¡ Ğ’ĞĞ›", 4.5, 2, 5, 1010),
            ("Ğ¡ĞŸĞ¡Ğ-14", 4.5, 4, 1, 1210)
        ],
        "armor": [
            ("ĞŸĞ»Ğ°Ñ‰ Â«Ğ“Ñ€ĞµÑ…Ğ¾Ğ²Ñ†Ğ°Â»", 3, 0, 0, 1, 250),
            ("ĞšĞµĞ²Ğ»Ğ°Ñ€Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ñ‰ Â«Ğ“Ñ€ĞµÑ…Ğ°Â»", 4, 0, 1, 1, 500),
            ("ĞĞ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ±Ñ€Ğ¾Ğ½Ñ Â«Ğ’ĞµĞ»ĞµÑÂ»", 5, 1, 2, 2, 1300),
            ("Ğ‘Ñ€Ğ¾Ğ½ĞµĞ¶Ğ¸Ğ»ĞµÑ‚ Â«ĞŸĞµĞ¿ĞµĞ»Â»", 6, 3, 2, 3, 2350),
            ("Ğ­ĞºĞ·Ğ¾ÑĞºĞµĞ»ĞµÑ‚ Â«Ğ˜Ñ€Ğ¸Ğ¹Â»", 7, 4, 3, 3, 3000)
        ]
    }
}
EQUIPMENT[ZOMBIE_FACTION] = EQUIPMENT["â˜¢ï¸ ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸"].copy()

# ==================== Ğ¢ĞĞ‘Ğ›Ğ˜Ğ¦Ğ« Ğ”Ğ ĞĞŸĞ ====================
DROP_T = {
    "Ğ”ĞµĞ½ÑŒĞ³Ğ¸": {"chance": 30, "min": 5, "max": 15, "type": "money"},
    "ÑˆĞ¾ĞºĞ¾Ğ»Ğ°Ğ´Ğ½Ñ‹Ğ¹ Ğ±Ğ°Ñ‚Ğ¾Ğ½Ñ‡Ğ¸Ğº": {"chance": 33, "min": 1, "max": 3},
    "Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸": {"chance": 33, "min": 1, "max": 10},
    "Ñ…Ğ»ĞµĞ±": {"chance": 20, "min": 1, "max": 3},
    "ĞºĞ¾Ğ»Ğ±Ğ°ÑĞ°": {"chance": 10, "min": 1, "max": 3},
    "ĞºĞ¾Ğ½ÑĞµÑ€Ğ²Ğ°": {"chance": 5, "min": 1, "max": 3},
    "Ğ±Ğ¸Ğ½Ñ‚": {"chance": 33, "min": 1, "max": 3},
    "Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": {"chance": 20, "min": 1, "max": 3},
    "Ğ°Ñ€Ğ¼ĞµĞ¹ÑĞºĞ°Ñ Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": {"chance": 10, "min": 1, "max": 3},
    "Ğ½Ğ°ÑƒÑ‡Ğ½Ğ°Ñ Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": {"chance": 5, "min": 1, "max": 3},
    "ÑĞ¸Ğ³Ğ°Ñ€ĞµÑ‚Ñ‹": {"chance": 33, "min": 1, "max": 3},
    "Ğ²Ğ¾Ğ´ĞºĞ°": {"chance": 20, "min": 1, "max": 3},
    "Ñ€Ğ°Ğ´Ğ¸Ğ¾Ğ¿Ñ€Ğ¾Ñ‚ĞµĞºÑ‚Ğ¾Ñ€": {"chance": 10, "min": 1, "max": 3},
    "Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ°Ğ´": {"chance": 5, "min": 1, "max": 3},
    "ÑĞ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸Ğº Ğ½Ğ¾Ğ½ÑÑ‚Ğ¾Ğ¿": {"chance": 10, "min": 1, "max": 3},
    "ÑĞ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸Ğº ÑÑ‚Ğ°Ğ»ĞºĞµÑ€": {"chance": 5, "min": 1, "max": 2},
    "Ğ³ĞµÑ€ĞºÑƒĞ»ĞµÑ": {"chance": 1, "min": 1, "max": 1}
}

DROP_TR = {
    "Ğ”ĞµĞ½ÑŒĞ³Ğ¸": {"chance": 29, "min": 5, "max": 30, "type": "money"},
    "ÑˆĞ¾ĞºĞ¾Ğ»Ğ°Ğ´Ğ½Ñ‹Ğ¹ Ğ±Ğ°Ñ‚Ğ¾Ğ½Ñ‡Ğ¸Ğº": {"chance": 23, "min": 1, "max": 3},
    "Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸": {"chance": 30, "min": 1, "max": 15},
    "Ñ…Ğ»ĞµĞ±": {"chance": 30, "min": 1, "max": 3},
    "ĞºĞ¾Ğ»Ğ±Ğ°ÑĞ°": {"chance": 20, "min": 1, "max": 3},
    "ĞºĞ¾Ğ½ÑĞµÑ€Ğ²Ğ°": {"chance": 10, "min": 1, "max": 3},
    "Ğ±Ğ¸Ğ½Ñ‚": {"chance": 23, "min": 1, "max": 3},
    "Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": {"chance": 25, "min": 1, "max": 3},
    "Ğ°Ñ€Ğ¼ĞµĞ¹ÑĞºĞ°Ñ Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": {"chance": 20, "min": 1, "max": 3},
    "Ğ½Ğ°ÑƒÑ‡Ğ½Ğ°Ñ Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": {"chance": 10, "min": 1, "max": 3},
    "ÑĞ¸Ğ³Ğ°Ñ€ĞµÑ‚Ñ‹": {"chance": 23, "min": 1, "max": 3},
    "Ğ²Ğ¾Ğ´ĞºĞ°": {"chance": 30, "min": 1, "max": 3},
    "Ñ€Ğ°Ğ´Ğ¸Ğ¾Ğ¿Ñ€Ğ¾Ñ‚ĞµĞºÑ‚Ğ¾Ñ€": {"chance": 20, "min": 1, "max": 3},
    "Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ°Ğ´": {"chance": 10, "min": 1, "max": 3},
    "ÑĞ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸Ğº Ğ½Ğ¾Ğ½ÑÑ‚Ğ¾Ğ¿": {"chance": 15, "min": 1, "max": 3},
    "ÑĞ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸Ğº ÑÑ‚Ğ°Ğ»ĞºĞµÑ€": {"chance": 10, "min": 1, "max": 2},
    "Ğ³ĞµÑ€ĞºÑƒĞ»ĞµÑ": {"chance": 5, "min": 1, "max": 1}
}

DROP_B = {
    "Ğ”ĞµĞ½ÑŒĞ³Ğ¸": {"chance": 30, "min": 5, "max": 45, "type": "money"},
    "ÑˆĞ¾ĞºĞ¾Ğ»Ğ°Ğ´Ğ½Ñ‹Ğ¹ Ğ±Ğ°Ñ‚Ğ¾Ğ½Ñ‡Ğ¸Ğº": {"chance": 13, "min": 1, "max": 3},
    "Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸": {"chance": 30, "min": 1, "max": 20},
    "Ñ…Ğ»ĞµĞ±": {"chance": 30, "min": 1, "max": 3},
    "ĞºĞ¾Ğ»Ğ±Ğ°ÑĞ°": {"chance": 30, "min": 1, "max": 3},
    "ĞºĞ¾Ğ½ÑĞµÑ€Ğ²Ğ°": {"chance": 20, "min": 1, "max": 3},
    "Ğ±Ğ¸Ğ½Ñ‚": {"chance": 9, "min": 1, "max": 3},
    "Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": {"chance": 13, "min": 1, "max": 3},
    "Ğ°Ñ€Ğ¼ĞµĞ¹ÑĞºĞ°Ñ Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": {"chance": 13, "min": 1, "max": 3},
    "Ğ½Ğ°ÑƒÑ‡Ğ½Ğ°Ñ Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": {"chance": 13, "min": 1, "max": 3},
    "ÑĞ¸Ğ³Ğ°Ñ€ĞµÑ‚Ñ‹": {"chance": 13, "min": 1, "max": 3},
    "Ğ²Ğ¾Ğ´ĞºĞ°": {"chance": 30, "min": 1, "max": 3},
    "Ñ€Ğ°Ğ´Ğ¸Ğ¾Ğ¿Ñ€Ğ¾Ñ‚ĞµĞºÑ‚Ğ¾Ñ€": {"chance": 25, "min": 1, "max": 3},
    "Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ°Ğ´": {"chance": 20, "min": 1, "max": 3},
    "ÑĞ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸Ğº Ğ½Ğ¾Ğ½ÑÑ‚Ğ¾Ğ¿": {"chance": 10, "min": 1, "max": 3},
    "ÑĞ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸Ğº ÑÑ‚Ğ°Ğ»ĞºĞµÑ€": {"chance": 5, "min": 1, "max": 2},
    "Ğ³ĞµÑ€ĞºÑƒĞ»ĞµÑ": {"chance": 5, "min": 1, "max": 1}
}

DROP_POLYANA_T = {"Ğ¶ĞµĞ»ÑƒĞ´ÑŒ": {"chance": 5, "min": 1, "max": 1}}

# ==================== ĞœĞ£Ğ¢ĞĞĞ¢Ğ« ====================
MUTANTS = {
    "Ñ‚ÑƒÑˆĞºĞ°Ğ½Ñ‡Ğ¸Ğº": [
        {"name": "Ğ¡Ğ»Ğ°Ğ±Ñ‹Ğ¹ Ñ‚ÑƒÑˆĞºĞ°Ğ½Ñ‡Ğ¸Ğº", "hp": 1, "damage": 0.5, "reward": 5},
        {"name": "ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ Ñ‚ÑƒÑˆĞºĞ°Ğ½Ñ‡Ğ¸Ğº", "hp": 1.5, "damage": 1, "reward": 10},
        {"name": "ĞœĞ°Ñ‚Ñ‘Ñ€Ñ‹Ğ¹ Ñ‚ÑƒÑˆĞºĞ°Ğ½Ñ‡Ğ¸Ğº", "hp": 2, "damage": 1.5, "reward": 15}
    ],
    "ÑĞ»ĞµĞ¿Ğ¾Ğ¹ Ğ¿Ñ‘Ñ": [
        {"name": "Ğ¡Ğ»Ğ°Ğ±Ñ‹Ğ¹ ÑĞ»ĞµĞ¿Ğ¾Ğ¹ Ğ¿Ñ‘Ñ", "hp": 2.5, "damage": 1.5, "reward": 15},
        {"name": "ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ ÑĞ»ĞµĞ¿Ğ¾Ğ¹ Ğ¿Ñ‘Ñ", "hp": 2.5, "damage": 2, "reward": 20},
        {"name": "ĞœĞ°Ñ‚Ñ‘Ñ€Ñ‹Ğ¹ ÑĞ»ĞµĞ¿Ğ¾Ğ¹ Ğ¿Ñ‘Ñ", "hp": 3, "damage": 2.5, "reward": 25}
    ],
    "Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ¿Ñ‘Ñ": [
        {"name": "Ğ¡Ğ»Ğ°Ğ±Ñ‹Ğ¹ Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ¿Ñ‘Ñ", "hp": 3.5, "damage": 3.5, "reward": 35},
        {"name": "ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ¿Ñ‘Ñ", "hp": 3.5, "damage": 4, "reward": 40},
        {"name": "ĞœĞ°Ñ‚Ñ‘Ñ€Ñ‹Ğ¹ Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ¿Ñ‘Ñ", "hp": 4, "damage": 4, "reward": 45}
    ],
    "Ğ¿Ğ»Ğ¾Ñ‚ÑŒ": [
        {"name": "Ğ¡Ğ»Ğ°Ğ±Ğ°Ñ Ğ¿Ğ»Ğ¾Ñ‚ÑŒ", "hp": 4, "damage": 2.5, "reward": 25},
        {"name": "ĞĞ±Ñ‹Ñ‡Ğ½Ğ°Ñ Ğ¿Ğ»Ğ¾Ñ‚ÑŒ", "hp": 4.5, "damage": 3, "reward": 30},
        {"name": "ĞœĞ°Ñ‚Ñ‘Ñ€Ğ°Ñ Ğ¿Ğ»Ğ¾Ñ‚ÑŒ", "hp": 5, "damage": 3, "reward": 35}
    ],
    "ĞºĞ°Ğ±Ğ°Ğ½": [
        {"name": "Ğ¡Ğ»Ğ°Ğ±Ñ‹Ğ¹ ĞºĞ°Ğ±Ğ°Ğ½", "hp": 4, "damage": 3, "reward": 30},
        {"name": "ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ°Ğ±Ğ°Ğ½", "hp": 4.5, "damage": 3.5, "reward": 35},
        {"name": "ĞœĞ°Ñ‚Ñ‘Ñ€Ñ‹Ğ¹ ĞºĞ°Ğ±Ğ°Ğ½", "hp": 5, "damage": 4, "reward": 40}
    ],
    "ĞºÑ€Ğ¾Ğ²Ğ¾ÑĞ¾Ñ": [
        {"name": "Ğ¡Ğ»Ğ°Ğ±Ñ‹Ğ¹ ĞºÑ€Ğ¾Ğ²Ğ¾ÑĞ¾Ñ", "hp": 5, "damage": 4, "reward": 40},
        {"name": "ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ ĞºÑ€Ğ¾Ğ²Ğ¾ÑĞ¾Ñ", "hp": 6, "damage": 4.5, "reward": 45},
        {"name": "ĞœĞ°Ñ‚Ñ‘Ñ€Ñ‹Ğ¹ ĞºÑ€Ğ¾Ğ²Ğ¾ÑĞ¾Ñ", "hp": 7, "damage": 4.5, "reward": 50}
    ]
}

MUTANT_SPAWN_CHANCES = {
    "ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½": {
        "Ğ›1": {"Ñ‚ÑƒÑˆĞºĞ°Ğ½Ñ‡Ğ¸Ğº": 20, "ÑĞ»ĞµĞ¿Ğ¾Ğ¹ Ğ¿Ñ‘Ñ": 5, "Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ¿Ñ‘Ñ": 0, "Ğ¿Ğ»Ğ¾Ñ‚ÑŒ": 10, "ĞºĞ°Ğ±Ğ°Ğ½": 15, "ĞºÑ€Ğ¾Ğ²Ğ¾ÑĞ¾Ñ": 0},
        "Ğ›2": {"Ñ‚ÑƒÑˆĞºĞ°Ğ½Ñ‡Ğ¸Ğº": 15, "ÑĞ»ĞµĞ¿Ğ¾Ğ¹ Ğ¿Ñ‘Ñ": 20, "Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ¿Ñ‘Ñ": 0, "Ğ¿Ğ»Ğ¾Ñ‚ÑŒ": 5, "ĞºĞ°Ğ±Ğ°Ğ½": 20, "ĞºÑ€Ğ¾Ğ²Ğ¾ÑĞ¾Ñ": 0},
        "Ğ›3": {"Ñ‚ÑƒÑˆĞºĞ°Ğ½Ñ‡Ğ¸Ğº": 10, "ÑĞ»ĞµĞ¿Ğ¾Ğ¹ Ğ¿Ñ‘Ñ": 20, "Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ¿Ñ‘Ñ": 10, "Ğ¿Ğ»Ğ¾Ñ‚ÑŒ": 10, "ĞºĞ°Ğ±Ğ°Ğ½": 15, "ĞºÑ€Ğ¾Ğ²Ğ¾ÑĞ¾Ñ": 0},
        "Ğ›4": {"Ñ‚ÑƒÑˆĞºĞ°Ğ½Ñ‡Ğ¸Ğº": 10, "ÑĞ»ĞµĞ¿Ğ¾Ğ¹ Ğ¿Ñ‘Ñ": 20, "Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ¿Ñ‘Ñ": 15, "Ğ¿Ğ»Ğ¾Ñ‚ÑŒ": 10, "ĞºĞ°Ğ±Ğ°Ğ½": 15, "ĞºÑ€Ğ¾Ğ²Ğ¾ÑĞ¾Ñ": 0},
        "Ğ›5": {"Ñ‚ÑƒÑˆĞºĞ°Ğ½Ñ‡Ğ¸Ğº": 5, "ÑĞ»ĞµĞ¿Ğ¾Ğ¹ Ğ¿Ñ‘Ñ": 25, "Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ¿Ñ‘Ñ": 15, "Ğ¿Ğ»Ğ¾Ñ‚ÑŒ": 10, "ĞºĞ°Ğ±Ğ°Ğ½": 15, "ĞºÑ€Ğ¾Ğ²Ğ¾ÑĞ¾Ñ": 0}
    },
    "Ğ¡Ğ²Ğ°Ğ»ĞºĞ°": {
        "Ğ›1": {"Ñ‚ÑƒÑˆĞºĞ°Ğ½Ñ‡Ğ¸Ğº": 20, "ÑĞ»ĞµĞ¿Ğ¾Ğ¹ Ğ¿Ñ‘Ñ": 15, "Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ¿Ñ‘Ñ": 10, "Ğ¿Ğ»Ğ¾Ñ‚ÑŒ": 5, "ĞºĞ°Ğ±Ğ°Ğ½": 5, "ĞºÑ€Ğ¾Ğ²Ğ¾ÑĞ¾Ñ": 0},
        "Ğ›2": {"Ñ‚ÑƒÑˆĞºĞ°Ğ½Ñ‡Ğ¸Ğº": 10, "ÑĞ»ĞµĞ¿Ğ¾Ğ¹ Ğ¿Ñ‘Ñ": 20, "Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ¿Ñ‘Ñ": 15, "Ğ¿Ğ»Ğ¾Ñ‚ÑŒ": 5, "ĞºĞ°Ğ±Ğ°Ğ½": 5, "ĞºÑ€Ğ¾Ğ²Ğ¾ÑĞ¾Ñ": 0},
        "Ğ›3": {"Ñ‚ÑƒÑˆĞºĞ°Ğ½Ñ‡Ğ¸Ğº": 15, "ÑĞ»ĞµĞ¿Ğ¾Ğ¹ Ğ¿Ñ‘Ñ": 20, "Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ¿Ñ‘Ñ": 10, "Ğ¿Ğ»Ğ¾Ñ‚ÑŒ": 10, "ĞºĞ°Ğ±Ğ°Ğ½": 10, "ĞºÑ€Ğ¾Ğ²Ğ¾ÑĞ¾Ñ": 0},
        "Ğ›4": {"Ñ‚ÑƒÑˆĞºĞ°Ğ½Ñ‡Ğ¸Ğº": 10, "ÑĞ»ĞµĞ¿Ğ¾Ğ¹ Ğ¿Ñ‘Ñ": 10, "Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ¿Ñ‘Ñ": 0, "Ğ¿Ğ»Ğ¾Ñ‚ÑŒ": 30, "ĞºĞ°Ğ±Ğ°Ğ½": 10, "ĞºÑ€Ğ¾Ğ²Ğ¾ÑĞ¾Ñ": 0}
    },
    "Ğ¢Ñ‘Ğ¼Ğ½Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¸Ğ½Ğ°": {
        "Ğ›1": {"Ñ‚ÑƒÑˆĞºĞ°Ğ½Ñ‡Ğ¸Ğº": 5, "ÑĞ»ĞµĞ¿Ğ¾Ğ¹ Ğ¿Ñ‘Ñ": 10, "Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ¿Ñ‘Ñ": 20, "Ğ¿Ğ»Ğ¾Ñ‚ÑŒ": 0, "ĞºĞ°Ğ±Ğ°Ğ½": 5, "ĞºÑ€Ğ¾Ğ²Ğ¾ÑĞ¾Ñ": 15},
        "Ğ›2": {"Ñ‚ÑƒÑˆĞºĞ°Ğ½Ñ‡Ğ¸Ğº": 10, "ÑĞ»ĞµĞ¿Ğ¾Ğ¹ Ğ¿Ñ‘Ñ": 5, "Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ¿Ñ‘Ñ": 5, "Ğ¿Ğ»Ğ¾Ñ‚ÑŒ": 15, "ĞºĞ°Ğ±Ğ°Ğ½": 10, "ĞºÑ€Ğ¾Ğ²Ğ¾ÑĞ¾Ñ": 5},
        "Ğ›3": {"Ñ‚ÑƒÑˆĞºĞ°Ğ½Ñ‡Ğ¸Ğº": 15, "ÑĞ»ĞµĞ¿Ğ¾Ğ¹ Ğ¿Ñ‘Ñ": 10, "Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ¿Ñ‘Ñ": 15, "Ğ¿Ğ»Ğ¾Ñ‚ÑŒ": 5, "ĞºĞ°Ğ±Ğ°Ğ½": 10, "ĞºÑ€Ğ¾Ğ²Ğ¾ÑĞ¾Ñ": 5},
        "Ğ›4": {"Ñ‚ÑƒÑˆĞºĞ°Ğ½Ñ‡Ğ¸Ğº": 15, "ÑĞ»ĞµĞ¿Ğ¾Ğ¹ Ğ¿Ñ‘Ñ": 20, "Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ¿Ñ‘Ñ": 15, "Ğ¿Ğ»Ğ¾Ñ‚ÑŒ": 5, "ĞºĞ°Ğ±Ğ°Ğ½": 10, "ĞºÑ€Ğ¾Ğ²Ğ¾ÑĞ¾Ñ": 0}
    },
    "ĞŸĞ¾Ğ»ÑĞ½Ğ°": {
        "Ğ›1": {"Ñ‚ÑƒÑˆĞºĞ°Ğ½Ñ‡Ğ¸Ğº": 15, "ÑĞ»ĞµĞ¿Ğ¾Ğ¹ Ğ¿Ñ‘Ñ": 10, "Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ¿Ñ‘Ñ": 15, "Ğ¿Ğ»Ğ¾Ñ‚ÑŒ": 10, "ĞºĞ°Ğ±Ğ°Ğ½": 10, "ĞºÑ€Ğ¾Ğ²Ğ¾ÑĞ¾Ñ": 5},
        "Ğ›2": {"Ñ‚ÑƒÑˆĞºĞ°Ğ½Ñ‡Ğ¸Ğº": 15, "ÑĞ»ĞµĞ¿Ğ¾Ğ¹ Ğ¿Ñ‘Ñ": 20, "Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ¿Ñ‘Ñ": 10, "Ğ¿Ğ»Ğ¾Ñ‚ÑŒ": 10, "ĞºĞ°Ğ±Ğ°Ğ½": 10, "ĞºÑ€Ğ¾Ğ²Ğ¾ÑĞ¾Ñ": 0}
    }
}

# ==================== Ğ¡ĞšĞ’ĞĞ”Ğ« ====================
SQUAD_COSTS = {
    1: {"money": 100, "food": 5, "med": 5, "rad": 5},
    3: {"money": 300, "food": 10, "med": 10, "rad": 10},
    5: {"money": 500, "food": 15, "med": 15, "rad": 15}
}

MIN_SQUADS_FOR_POINT = {
    "Ğ‘Ğ°Ğ·Ğ°": 5,
    "Ğ¢Ğ¾Ñ‡ĞºĞ° Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²": 4,
    "ĞĞ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ·Ğ¾Ğ½Ğ°": 3,
    "Ğ›Ğ¾Ğ³Ğ¾Ğ²Ğ¾": 2,
    "Ğ¢ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ": 1
}

CONVERSION_VALUES = {
    "ÑˆĞ¾ĞºĞ¾Ğ»Ğ°Ğ´Ğ½Ñ‹Ğ¹ Ğ±Ğ°Ñ‚Ğ¾Ğ½Ñ‡Ğ¸Ğº": {"type": "food", "value": 1},
    "Ñ…Ğ»ĞµĞ±": {"type": "food", "value": 2},
    "ĞºĞ¾Ğ»Ğ±Ğ°ÑĞ°": {"type": "food", "value": 3},
    "ĞºĞ¾Ğ½ÑĞµÑ€Ğ²Ğ°": {"type": "food", "value": 4},
    "Ğ±Ğ¸Ğ½Ñ‚": {"type": "med", "value": 1},
    "Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": {"type": "med", "value": 2},
    "Ğ°Ñ€Ğ¼ĞµĞ¹ÑĞºĞ°Ñ Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": {"type": "med", "value": 3},
    "Ğ½Ğ°ÑƒÑ‡Ğ½Ğ°Ñ Ğ°Ğ¿Ñ‚ĞµÑ‡ĞºĞ°": {"type": "special", "med": 3, "rad": 1},
    "ÑĞ¸Ğ³Ğ°Ñ€ĞµÑ‚Ñ‹": {"type": "rad", "value": 1},
    "Ğ²Ğ¾Ğ´ĞºĞ°": {"type": "rad", "value": 2},
    "Ñ€Ğ°Ğ´Ğ¸Ğ¾Ğ¿Ñ€Ğ¾Ñ‚ĞµĞºÑ‚Ğ¾Ñ€": {"type": "rad", "value": 3},
    "Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ°Ğ´": {"type": "rad", "value": 4}
}

# ==================== Ğ›Ğ˜ĞœĞ˜Ğ¢Ğ« Ğ˜Ğ¡Ğ¢ĞĞ©Ğ•ĞĞ˜Ğ¯ ====================
EXHAUSTION_LIMITS = {
    "Ğ‘Ğ°Ğ·Ğ°": 200,
    "Ğ¢Ğ¾Ñ‡ĞºĞ° Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²": 150,
    "Ğ¢ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ": 100,
    "Ğ›Ğ¾Ğ³Ğ¾Ğ²Ğ¾": 30,
    "ĞĞ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ·Ğ¾Ğ½Ğ°": 10
}

# ==================== ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ Ğ’Ğ«Ğ‘Ğ ĞĞ¡Ğ ====================
EMISSION_MAX = 350
EMISSION_WARNING = 335
GAME_CHAT_ID = 2000000005

# ==================== Ğ—ĞĞœĞ‘Ğ˜-Ğ‘ĞĞ¢ ====================
ZOMBIE_ACTION_INTERVAL = 1800
POINT_STRENGTH = {"Ğ‘Ğ°Ğ·Ğ°": 5, "Ğ¢Ğ¾Ñ‡ĞºĞ° Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²": 4, "ĞĞ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ·Ğ¾Ğ½Ğ°": 3, "Ğ›Ğ¾Ğ³Ğ¾Ğ²Ğ¾": 2, "Ğ¢ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ": 1}

ZOMBIE_PHASES = {
    15: {"name": "Ğ¡Ñ‚Ğ°Ñ€Ñ‚Ğ¾Ğ²Ñ‹Ğµ ÑĞ¸Ğ»Ñ‹", "territories": 1, "loot_times": 5},
    30: {"name": "ĞĞ¸Ğ·ĞºĞ¸Ğ¹ ÑÑ‚Ğ°Ñ€Ñ‚", "territories": 1, "loot_times": 10},
    45: {"name": "ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ñ„Ğ°Ğ·Ğ° Ğ°Ğ¿Ğ¾ĞºĞ°Ğ»Ğ¸Ğ¿ÑĞ¸ÑĞ°", "territories": 2, "loot_times": 10},
    60: {"name": "ĞĞµÑƒĞ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ñ‹Ğ¹ Ğ¼Ğ°Ñ€Ñˆ ÑĞ¼ĞµÑ€Ñ‚Ğ¸", "territories": 3, "loot_times": 10},
    75: {"name": "Ğ¥Ğ°Ğ¾Ñ Ğ²Ğ¾Ğ¿Ğ»Ğ¾Ñ‚Ğ¸", "territories": 4, "loot_times": 10},
    100: {"name": "ĞÑ€Ğ¼Ğ°Ğ³ĞµĞ´Ğ´Ğ¾Ğ½", "territories": 5, "loot_times": 10}
}

LAST_STAND_START_POSITIONS = {
    "ğŸ›¡ï¸ Ğ”Ğ¾Ğ»Ğ³": ("ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½", "Ğ‘1"),
    "â˜¢ï¸ ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸": ("ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½", "Ğ‘2"),
    "â˜¦ï¸ Ğ“Ñ€ĞµÑ…": ("ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½", "Ğ‘3"),
    ZOMBIE_FACTION: [("Ğ¡Ğ²Ğ°Ğ»ĞºĞ°", "Ğ‘1"), ("ĞŸĞ¾Ğ»ÑĞ½Ğ°", "Ğ‘1"), ("Ğ¢Ñ‘Ğ¼Ğ½Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¸Ğ½Ğ°", "Ğ‘3")]
}

# ==================== Ğ¢Ğ•ĞšĞ¡Ğ¢ĞĞ’Ğ«Ğ• ĞšĞĞĞ¡Ğ¢ĞĞĞ¢Ğ« ====================
GAME_INFO_TEXT = """ğŸŒŒ Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² Ğ—Ğ¾Ğ½Ñƒ, ÑÑ‚Ğ°Ğ»ĞºĞµÑ€!

Ğ­Ñ‚Ğ¾ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ°Ñ RPG Ğ¿Ğ¾ Ğ¼Ğ¾Ñ‚Ğ¸Ğ²Ğ°Ğ¼ S.T.A.L.K.E.R. Ğ—Ğ´ĞµÑÑŒ Ñ‚ĞµĞ±Ğµ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ¾Ğ¸Ñ‚ Ğ²Ñ‹Ğ¶Ğ¸Ğ²Ğ°Ñ‚ÑŒ, Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ‚ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸, Ğ¾Ñ…Ğ¾Ñ‚Ğ¸Ñ‚ÑŒÑÑ Ğ½Ğ° Ğ¼ÑƒÑ‚Ğ°Ğ½Ñ‚Ğ¾Ğ² Ğ¸ ÑÑ€Ğ°Ğ¶Ğ°Ñ‚ÑŒÑÑ Ğ·Ğ° Ñ‚ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸ ÑĞ²Ğ¾ĞµĞ¹ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸.

ğŸ›ï¸ Ğ“Ğ Ğ£ĞŸĞŸĞ˜Ğ ĞĞ’ĞšĞ˜
Ğ’ Ğ¸Ğ³Ñ€Ğµ Ñ‚Ñ€Ğ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸: Ğ”Ğ¾Ğ»Ğ³, Ğ“Ñ€ĞµÑ… Ğ¸ ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸. ĞšĞ°Ğ¶Ğ´Ğ°Ñ Ğ¸Ğ¼ĞµĞµÑ‚ ÑĞ²Ğ¾Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğ¾Ğ²Ñ‹Ğµ Ñ‚ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ¸ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ½Ğ°Ñ€ÑĞ¶ĞµĞ½Ğ¸Ğµ.

ğŸ“Š Ğ¥ĞĞ ĞĞšĞ¢Ğ•Ğ Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ˜
Â· â¤ï¸ Ğ—Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ: Ğ¿Ñ€Ğ¸ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ¶ĞµĞ½Ğ¸Ğ¸ 0 Ñ‚Ñ‹ ÑƒĞ¼Ğ¸Ñ€Ğ°ĞµÑˆÑŒ Ğ¸ Ñ‚ĞµÑ€ÑĞµÑˆÑŒ Ñ‡Ğ°ÑÑ‚ÑŒ Ğ²ĞµÑ‰ĞµĞ¹
Â· â˜¢ï¸ Ğ Ğ°Ğ´Ğ¸Ğ°Ñ†Ğ¸Ñ: Ğ¿Ñ€Ğ¸ Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼Ğµ Ğ½Ğ°Ğ½Ğ¾ÑĞ¸Ñ‚ ÑƒÑ€Ğ¾Ğ½ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒÑ
Â· ğŸ– Ğ“Ğ¾Ğ»Ğ¾Ğ´: Ğ¿Ñ€Ğ¸ Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼Ğµ ÑĞ½Ğ¸Ğ¶Ğ°ĞµÑ‚ Ğ²Ñ‹Ğ½Ğ¾ÑĞ»Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ Ğ¸ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ
Â· âš¡ Ğ’Ñ‹Ğ½Ğ¾ÑĞ»Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ: Ñ‚Ñ€Ğ°Ñ‚Ğ¸Ñ‚ÑÑ Ğ½Ğ° Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ñ‹

ğŸ’ Ğ˜ĞĞ’Ğ•ĞĞ¢ĞĞ Ğ¬ Ğ˜ ĞŸĞ Ğ•Ğ”ĞœĞ•Ğ¢Ğ«
Â· ğŸ Ğ•Ğ´Ğ° ÑĞ½Ğ¸Ğ¶Ğ°ĞµÑ‚ Ğ³Ğ¾Ğ»Ğ¾Ğ´
Â· ğŸ’Š ĞœĞµĞ´Ğ¸ĞºĞ°Ğ¼ĞµĞ½Ñ‚Ñ‹ Ğ»ĞµÑ‡Ğ°Ñ‚ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ
Â· ğŸ§ª ĞĞ½Ñ‚Ğ¸Ñ€Ğ°Ğ´ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ñ€Ğ°Ğ´Ğ¸Ğ°Ñ†Ğ¸Ñ
Â· ğŸ”‹ Ğ­Ğ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸ĞºĞ¸ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ÑÑ‚ Ğ²Ñ‹Ğ½Ğ¾ÑĞ»Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ
Â· ğŸ”Œ Ğ‘Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸ Ğ½ÑƒĞ¶Ğ½Ñ‹ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¾Ğ²

ğŸ—ºï¸ Ğ›ĞĞšĞĞ¦Ğ˜Ğ˜: ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½, Ğ¡Ğ²Ğ°Ğ»ĞºĞ°, Ğ¢Ñ‘Ğ¼Ğ½Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¸Ğ½Ğ°, ĞŸĞ¾Ğ»ÑĞ½Ğ°

âš”ï¸ Ğ’ĞĞ™ĞĞ Ğ“Ğ Ğ£ĞŸĞŸĞ˜Ğ ĞĞ’ĞĞš
ĞŸĞ¾ĞºÑƒĞ¿Ğ°Ğ¹ ÑĞºĞ²Ğ°Ğ´Ñ‹, Ğ·Ğ°Ñ…Ğ²Ğ°Ñ‚Ñ‹Ğ²Ğ°Ğ¹ Ñ‚ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸, Ğ·Ğ°Ñ‰Ğ¸Ñ‰Ğ°Ğ¹ ÑĞ²Ğ¾Ğ¸ Ñ‚Ğ¾Ñ‡ĞºĞ¸!

Ğ£Ğ´Ğ°Ñ‡Ğ½Ğ¾Ğ¹ Ğ¾Ñ…Ğ¾Ñ‚Ñ‹, ÑÑ‚Ğ°Ğ»ĞºĞµÑ€! ğŸºâš¡"""

MAIN_MENU_TEXT = """Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:

ğŸ’¡ ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° "2604" Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾ Ğ²ĞµÑ€Ğ½Ñ‘Ñ‚ Ğ²Ğ°Ñ Ğ² Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ
â“ ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ "Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ"

Â«ğŸ•ï¸ Ğ›Ğ°Ğ³ĞµÑ€ÑŒ - Ğ¼ĞµÑÑ‚Ğ¾ ÑƒĞºÑ€Ñ‹Ñ‚Ğ¸Ñ Ğ¸ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
Â«ğŸ‘£ ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ - Ğ¿ĞµÑ€ĞµĞ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸ÑĞ¼
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
Â«ğŸ” Ğ˜ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ - Ğ¿Ğ¾Ğ¸ÑĞº Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
Â«ğŸ›’ Ğ¢Ğ¾Ñ€Ğ³Ğ¾Ğ²ĞµÑ† - Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ° Ğ¸ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ°
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
Â«âš”ï¸ Ğ’Ğ¾Ğ¹Ğ½Ğ° Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº - Ğ·Ğ°Ñ…Ğ²Ğ°Ñ‚ Ñ‚ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹"""

ARTIFACT_INFO_TEXT = """ğŸ’¡ Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ± Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ°Ñ…:

â– Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒÑ:
ğŸŒ’ ĞšÑ€Ğ¾Ğ²ÑŒ ĞºĞ°Ğ¼Ğ½Ñ +0.25â¤ï¸ | ğŸŒ“ Ğ›Ğ¾Ğ¼Ğ¾Ñ‚ÑŒ Ğ¼ÑÑĞ° +0.5â¤ï¸
ğŸŒ” Ğ”ÑƒÑˆĞ° +0.75â¤ï¸ | ğŸŒ• Ğ¡Ğ²ĞµÑ‚Ğ»ÑĞº +1â¤ï¸

â– Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ñ€Ğ°Ğ´Ğ¸Ğ°Ñ†Ğ¸Ğ¸:
ğŸŒ’ ĞšĞ¾Ğ»Ğ¾Ğ±Ğ¾Ğº -0.25â˜¢ï¸ | ğŸŒ“ ĞœĞµĞ´ÑƒĞ·Ğ° -0.5â˜¢ï¸
ğŸŒ” Ğ¡Ğ»Ğ¸Ğ·Ğ½ÑĞº -0.75â˜¢ï¸ | ğŸŒ• ĞŸÑƒĞ·Ñ‹Ñ€ÑŒ -1â˜¢ï¸

â– Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¸Ğ»:
ğŸŒ’ Ğ’ÑĞ¿Ñ‹ÑˆĞºĞ° +0.5âš¡ | ğŸŒ“ Ğ¡Ğ½ĞµĞ¶Ğ¸Ğ½ĞºĞ° +1âš¡
ğŸŒ” Ğ›ÑƒĞ½Ğ½Ñ‹Ğ¹ ÑĞ²ĞµÑ‚ +1.5âš¡ | ğŸŒ• Ğ‘Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ° +2âš¡

â– Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ñ€Ğ°Ğ·Ñ€Ñ‹Ğ²Ğ°:
ğŸŒ’ Ğ‘ĞµĞ½Ğ³Ğ°Ğ»ÑŒÑĞºĞ¸Ğ¹ Ğ¾Ğ³Ğ¾Ğ½ÑŒ +0.25ğŸ¾ | ğŸŒ“ Ğ’Ñ‹Ğ²ĞµÑ€Ñ‚ +0.5ğŸ¾
ğŸŒ” Ğ“Ñ€Ğ°Ğ²Ğ¸ +0.75ğŸ¾ | ğŸŒ• Ğ—Ğ¾Ğ»Ğ¾Ñ‚Ğ°Ñ Ñ€Ñ‹Ğ±ĞºĞ° +1ğŸ¾"""

# ==================== Ğ¡ĞĞ¡Ğ¢ĞĞ¯ĞĞ˜Ğ¯ Ğ˜Ğ“Ğ ĞĞšĞĞ’ ====================
class GameState:
    WAITING_FOR_START = "waiting_for_start"
    READING_INSTRUCTIONS = "reading_instructions"
    CHOOSING_FACTION = "choosing_faction"
    ENTERING_NICKNAME = "entering_nickname"
    IN_MENU = "in_menu"
    IN_CAMP = "in_camp"
    IN_BACKPACK = "in_backpack"
    TRANSITION_WAIT = "transition_wait"
    IN_TRANSITION_MENU = "in_transition_menu"
    WAITING_FOR_POINT = "waiting_for_point"
    CONFIRMING_TRANSITION = "confirming_transition"
    RESTING = "resting"
    USING_ITEM = "using_item"
    EXPLORING = "exploring"
    TRADER_MAIN = "trader_main"
    TRADER_BUY = "trader_buy"
    TRADER_SELL = "trader_sell"
    TRADER_BUY_CATEGORY = "trader_buy_category"
    TRADER_SELL_CATEGORY = "trader_sell_category"
    TRADER_BUY_EQUIPMENT = "trader_buy_equipment"
    TRADER_SELL_EQUIPMENT = "trader_sell_equipment"
    TRADER_SELL_EQUIPMENT_CONFIRM = "trader_sell_equipment_confirm"
    TRADER_BUY_EQUIPMENT_CONFIRM = "trader_buy_equipment_confirm"
    TRADER_REPAIR = "trader_repair"
    WAREHOUSE = "in_warehouse"
    DEAD = "dead"
    WAR_MAIN = "war_main"
    WAR_TERRITORIES = "war_territories"
    HUNTING = "hunting"
    HUNTING_SHOOTING = "hunting_shooting"
    ANOMALY_EXPLORE = "anomaly_explore"
    BELT_MAIN = "belt_main"
    BELT_EQUIP = "belt_equip"
    BELT_UNEQUIP = "belt_unequip"
    BELT_SELECT_SLOT = "belt_select_slot"
    BELT_SELECT_ARTIFACT = "belt_select_artifact"
    TRADER_SELL_ARTIFACTS = "trader_sell_artifacts"
    WAR_BUY_SQUAD = "war_buy_squad"
    WAR_CONVERT = "war_convert"
    WAR_MANAGE_SQUADS = "war_manage_squads"
    WAR_SEND_SQUAD = "war_send_squad"
    WAR_SEND_SQUAD_LOCATION = "war_send_squad_location"
    WAR_SEND_SQUAD_POINT = "war_send_squad_point"
    WAR_ATTACK_CONFIRM = "war_attack_confirm"
    WAR_SHARED_SQUADS = "war_shared_squads"
    CONFIRMING_EQUIPMENT_SELL = "confirming_equipment_sell"


# ==================== Ğ“Ğ›ĞĞ‘ĞĞ›Ğ¬ĞĞ«Ğ• ĞŸĞ•Ğ Ğ•ĞœĞ•ĞĞĞ«Ğ• ====================
players: Dict[int, Dict] = {}
factions = {"ğŸ›¡ï¸ Ğ”Ğ¾Ğ»Ğ³": [], "â˜¦ï¸ Ğ“Ñ€ĞµÑ…": [], "â˜¢ï¸ ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸": []}
MAX_FACTION_SIZES = {"ğŸ›¡ï¸ Ğ”Ğ¾Ğ»Ğ³": 5, "â˜¦ï¸ Ğ“Ñ€ĞµÑ…": 5, "â˜¢ï¸ ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸": 5}
shared_warehouse: Dict[str, int] = {}
shared_warehouse_money: int = 0
territory_control: Dict[str, Dict] = {}
faction_leaders: Dict[str, int] = {}
territory_exhaustion: Dict[str, Dict] = {}
emission_counter: int = 0
last_restored_categories: List[str] = []
faction_shared_squads = {"ğŸ›¡ï¸ Ğ”Ğ¾Ğ»Ğ³": 0, "â˜¦ï¸ Ğ“Ñ€ĞµÑ…": 0, "â˜¢ï¸ ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸": 0}
banned_users: Dict[int, str] = {}
admin_users: List[int] = []
LAST_STAND_MODE = False
faction_warehouses = {"ğŸ›¡ï¸ Ğ”Ğ¾Ğ»Ğ³": {}, "â˜¦ï¸ Ğ“Ñ€ĞµÑ…": {}, "â˜¢ï¸ ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸": {}, ZOMBIE_FACTION: {}}
faction_warehouse_money = {"ğŸ›¡ï¸ Ğ”Ğ¾Ğ»Ğ³": 0, "â˜¦ï¸ Ğ“Ñ€ĞµÑ…": 0, "â˜¢ï¸ ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸": 0, ZOMBIE_FACTION: 0}
zombie_bot = {
    "money": 0, "squads": 0, "food_units": 0, "med_units": 0, "rad_units": 0,
    "last_action_time": 0, "next_action": "", "backpack": {}, "mode": "normal",
    "priority_target": None, "agro_points": [], "last_attacked_by": None,
    "pending_target": None, "last_logs": [], "bonus_squads": 0
}


# ==================== Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ Ğ‘ĞĞ¢Ğ ====================
bot = SimpleLongPollBot(tokens=TOKEN, group_id=GROUP_ID)


# ==================== Ğ‘ĞĞ—Ğ Ğ”ĞĞĞĞ«Ğ¥ ====================
def init_database():
    """Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ SQLite Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…"""
    conn = None
    try:
        conn = sqlite3.connect(str(DB_PATH))
        cursor = conn.cursor()
        cursor.execute('''CREATE TABLE IF NOT EXISTS players (
            user_id INTEGER PRIMARY KEY,
            data TEXT NOT NULL
        )''')
        cursor.execute('''CREATE TABLE IF NOT EXISTS game_state (
            key TEXT PRIMARY KEY,
            value TEXT NOT NULL
        )''')
        conn.commit()
        conn.close()
        logger.info(f"Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°: {DB_PATH}")
    except sqlite3.DatabaseError as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…: {e}")
        if conn:
            conn.close()
        if os.path.exists(DB_PATH):
            os.remove(DB_PATH)
            init_database()


def load_data():
    """Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹"""
    global players, factions, shared_warehouse, shared_warehouse_money, territory_control
    global faction_leaders, territory_exhaustion, emission_counter, last_restored_categories
    global faction_shared_squads, banned_users, admin_users, LAST_STAND_MODE
    global faction_warehouses, faction_warehouse_money, zombie_bot, EMISSION_MAX, ZOMBIE_ACTION_INTERVAL
    
    init_database()
    conn = sqlite3.connect(str(DB_PATH))
    cursor = conn.cursor()
    
    # Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²
    cursor.execute("SELECT user_id, data FROM players")
    rows = cursor.fetchall()
    for row in rows:
        user_id = row[0]
        try:
            p = json.loads(row[1])
            # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°ÑÑ‰Ğ¸Ğµ Ğ¿Ğ¾Ğ»Ñ
            defaults = {
                "belt": [None, None, None],
                "squads": 0, "food_units": 0, "med_units": 0, "rad_units": 0,
                "donation_end_time": None, "donation_artifact": None,
                "hidden_anomaly_positions": []
            }
            for key, value in defaults.items():
                if key not in p:
                    p[key] = value
            players[user_id] = p
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° {user_id}: {e}")
    
    def load_state(key, default):
        cursor.execute("SELECT value FROM game_state WHERE key = ?", (key,))
        row = cursor.fetchone()
        if row:
            try:
                return json.loads(row[0])
            except:
                return default
        return default
    
    factions = load_state("factions", {"ğŸ›¡ï¸ Ğ”Ğ¾Ğ»Ğ³": [], "â˜¦ï¸ Ğ“Ñ€ĞµÑ…": [], "â˜¢ï¸ ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸": []})
    for key in factions:
        factions[key] = [int(uid) for uid in factions[key]]
    
    shared_warehouse = load_state("shared_warehouse", {})
    shared_warehouse_money = load_state("shared_warehouse_money", 0)
    territory_control = load_state("territory_control", {})
    faction_leaders = load_state("faction_leaders", {})
    territory_exhaustion = load_state("territory_exhaustion", {})
    emission_counter = load_state("emission_counter", 0)
    last_restored_categories = load_state("last_restored_categories", [])
    faction_shared_squads = load_state("faction_shared_squads", {"ğŸ›¡ï¸ Ğ”Ğ¾Ğ»Ğ³": 0, "â˜¦ï¸ Ğ“Ñ€ĞµÑ…": 0, "â˜¢ï¸ ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸": 0})
    LAST_STAND_MODE = load_state("last_stand_mode", False)
    EMISSION_MAX = load_state("emission_max", 350)
    ZOMBIE_ACTION_INTERVAL = load_state("zombie_action_interval", 1800)
    faction_warehouses = load_state("faction_warehouses", {"ğŸ›¡ï¸ Ğ”Ğ¾Ğ»Ğ³": {}, "â˜¦ï¸ Ğ“Ñ€ĞµÑ…": {}, "â˜¢ï¸ ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸": {}, ZOMBIE_FACTION: {}})
    faction_warehouse_money = load_state("faction_warehouse_money", {"ğŸ›¡ï¸ Ğ”Ğ¾Ğ»Ğ³": 0, "â˜¦ï¸ Ğ“Ñ€ĞµÑ…": 0, "â˜¢ï¸ ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸": 0, ZOMBIE_FACTION: 0})
    zombie_bot = load_state("zombie_bot", zombie_bot)
    banned_users = load_state("banned_users", {})
    if isinstance(banned_users, list):
        banned_users = {uid: "ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ°" for uid in banned_users}
    admin_users = load_state("admin_users", [])
    
    loaded_limits = load_state("max_faction_sizes", {})
    for faction in MAX_FACTION_SIZES:
        if faction in loaded_limits:
            MAX_FACTION_SIZES[faction] = loaded_limits[faction]
    
    conn.close()
    
    if not territory_control:
        init_territory_control()
    if not territory_exhaustion:
        init_territory_exhaustion()
    
    logger.info("âœ… Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹ Ğ¸Ğ· SQLite.")


def save_data():
    """Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ² Ğ±Ğ°Ğ·Ñƒ"""
    try:
        conn = sqlite3.connect(str(DB_PATH))
        cursor = conn.cursor()
        
        for user_id, data in players.items():
            cursor.execute("INSERT OR REPLACE INTO players (user_id, data) VALUES (?, ?)",
                         (user_id, json.dumps(data, ensure_ascii=False)))
        
        def save_state(key, value):
            cursor.execute("INSERT OR REPLACE INTO game_state (key, value) VALUES (?, ?)",
                         (key, json.dumps(value, ensure_ascii=False)))
        
        save_state("factions", factions)
        save_state("shared_warehouse", shared_warehouse)
        save_state("shared_warehouse_money", shared_warehouse_money)
        save_state("territory_control", territory_control)
        save_state("faction_leaders", faction_leaders)
        save_state("territory_exhaustion", territory_exhaustion)
        save_state("emission_counter", emission_counter)
        save_state("last_restored_categories", last_restored_categories)
        save_state("faction_shared_squads", faction_shared_squads)
        save_state("last_stand_mode", LAST_STAND_MODE)
        save_state("faction_warehouses", faction_warehouses)
        save_state("faction_warehouse_money", faction_warehouse_money)
        save_state("zombie_bot", zombie_bot)
        save_state("emission_max", EMISSION_MAX)
        save_state("zombie_action_interval", ZOMBIE_ACTION_INTERVAL)
        save_state("banned_users", banned_users)
        save_state("admin_users", admin_users)
        save_state("max_faction_sizes", MAX_FACTION_SIZES)
        
        conn.commit()
        conn.close()
        logger.debug("ğŸ’¾ Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹ Ğ² SQLite.")
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ² SQLite: {e}")


# ==================== ĞšĞ›ĞĞ’Ğ˜ĞĞ¢Ğ£Ğ Ğ« ====================
def create_start_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button("Ğ¡Ñ‚Ğ°Ñ€Ñ‚", color=ButtonColor.POSITIVE)
    return kb.get_keyboard()


def create_next_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button("Ğ”Ğ°Ğ»ĞµĞµ", color=ButtonColor.PRIMARY)
    return kb.get_keyboard()


def create_faction_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button(f"ğŸ›¡ï¸ Ğ”Ğ¾Ğ»Ğ³ ({len(factions['ğŸ›¡ï¸ Ğ”Ğ¾Ğ»Ğ³'])}/{MAX_FACTION_SIZES['ğŸ›¡ï¸ Ğ”Ğ¾Ğ»Ğ³']})", color=ButtonColor.POSITIVE)
    kb.add_row()
    kb.add_text_button(f"â˜¦ï¸ Ğ“Ñ€ĞµÑ… ({len(factions['â˜¦ï¸ Ğ“Ñ€ĞµÑ…'])}/{MAX_FACTION_SIZES['â˜¦ï¸ Ğ“Ñ€ĞµÑ…']})", color=ButtonColor.POSITIVE)
    kb.add_row()
    kb.add_text_button(f"â˜¢ï¸ ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸ ({len(factions['â˜¢ï¸ ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸'])}/{MAX_FACTION_SIZES['â˜¢ï¸ ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸']})", color=ButtonColor.POSITIVE)
    return kb.get_keyboard()


def get_main_menu_button(point: str, location: str = None) -> str:
    ptype = POINT_TYPES.get(point, "Ğ¢ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ")
    if ptype == "Ğ‘Ğ°Ğ·Ğ°":
        return "ğŸ•‹ Ğ‘Ğ°Ğ·Ğ°"
    elif ptype == "Ğ¢Ğ¾Ñ‡ĞºĞ° Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²":
        return "ğŸ—ï¸ Ğ¢Ğ¾Ñ‡ĞºĞ° Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²"
    elif ptype == "ĞĞ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ·Ğ¾Ğ½Ğ°":
        if location and location in ANOMALY_ZONES and point in ANOMALY_ZONES[location]:
            atype = ANOMALY_ZONES[location][point]
            return ANOMALY_BUTTONS[atype]
        return "ğŸŒ• ĞĞ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ·Ğ¾Ğ½Ğ°"
    elif ptype == "Ğ›Ğ¾Ğ³Ğ¾Ğ²Ğ¾":
        return "â˜ ï¸ Ğ›Ğ¾Ğ³Ğ¾Ğ²Ğ¾"
    return "ğŸ§± Ğ¢ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ"


def create_main_menu_keyboard(user_id: int) -> str:
    p = players[user_id]
    point = p.get("point", "Ğ‘1")
    location = p.get("location", "Ğ›Ğ°Ğ³ĞµÑ€ÑŒ")
    
    kb = Keyboard(one_time=False)
    kb.add_text_button("ğŸ•ï¸ Ğ›Ğ°Ğ³ĞµÑ€ÑŒ", color=ButtonColor.POSITIVE)
    kb.add_row()
    kb.add_text_button("ğŸ‘£ ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´", color=ButtonColor.POSITIVE)
    kb.add_text_button(get_main_menu_button(point, location), color=ButtonColor.POSITIVE)
    kb.add_row()
    kb.add_text_button("ğŸ›’ Ğ¢Ğ¾Ñ€Ğ³Ğ¾Ğ²ĞµÑ†", color=ButtonColor.POSITIVE)
    kb.add_row()
    kb.add_text_button("âš”ï¸ Ğ’Ğ¾Ğ¹Ğ½Ğ° Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº", color=ButtonColor.NEGATIVE)
    
    if location in BASE_POINTS and point == BASE_POINTS.get(location):
        kb.add_row()
        kb.add_text_button("ğŸ§° Ğ¡ĞºĞ»Ğ°Ğ´", color=ButtonColor.SECONDARY)
    
    return kb.get_keyboard()


def create_camp_menu_keyboard() -> str:
    status = get_emission_status()
    kb = Keyboard(one_time=False)
    kb.add_text_button("ğŸ’ Ğ ÑĞºĞ·Ğ°Ğº", color=ButtonColor.POSITIVE)
    kb.add_row()
    kb.add_text_button("ğŸŸ¡ ĞŸĞ¾ÑÑ", color=ButtonColor.POSITIVE)
    kb.add_text_button("ğŸ’¤ ĞÑ‚Ğ´Ñ‹Ñ…", color=ButtonColor.POSITIVE)
    kb.add_text_button("ğŸ”‹ ĞŸĞ¾Ğ´Ğ·Ğ°Ñ€ÑĞ´ĞºĞ°", color=ButtonColor.POSITIVE)
    kb.add_row()
    kb.add_text_button(f"ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ²Ñ‹Ğ±Ñ€Ğ¾ÑĞ°: {status}", color=ButtonColor.NEGATIVE)
    kb.add_row()
    kb.add_text_button("ğŸ”š ĞĞ°Ğ·Ğ°Ğ´", color=ButtonColor.SECONDARY)
    return kb.get_keyboard()


def create_backpack_menu_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button("â‡ï¸ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ", color=ButtonColor.POSITIVE)
    kb.add_row()
    kb.add_text_button("â™»ï¸ Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°", color=ButtonColor.SECONDARY)
    kb.add_row()
    kb.add_text_button("ğŸ”„ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ", color=ButtonColor.POSITIVE)
    kb.add_text_button("ğŸ’¡ Ğ¸Ğ½Ñ„Ğ¾", color=ButtonColor.POSITIVE)
    kb.add_row()
    kb.add_text_button("ğŸ”š ĞĞ°Ğ·Ğ°Ğ´", color=ButtonColor.NEGATIVE)
    return kb.get_keyboard()


def create_warehouse_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button("ğŸ”š ĞĞ°Ğ·Ğ°Ğ´", color=ButtonColor.NEGATIVE)
    return kb.get_keyboard()


def create_trader_main_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button("ğŸ’² ĞŸÑ€Ğ¸Ğ¾Ğ±Ñ€ĞµÑÑ‚Ğ¸", color=ButtonColor.POSITIVE)
    kb.add_text_button("ğŸ’± ĞŸÑ€Ğ¾Ğ´Ğ°Ñ‚ÑŒ", color=ButtonColor.POSITIVE)
    kb.add_row()
    kb.add_text_button("âš™ï¸ ĞŸĞ¾Ñ‡Ğ¸Ğ½Ğ¸Ñ‚ÑŒ", color=ButtonColor.PRIMARY)
    kb.add_row()
    kb.add_text_button("ğŸ”š ĞĞ°Ğ·Ğ°Ğ´", color=ButtonColor.SECONDARY)
    return kb.get_keyboard()


def create_trader_category_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button("ğŸ¥« ĞŸÑ€Ğ¾Ğ²Ğ¸Ğ·Ğ¸Ñ", color=ButtonColor.POSITIVE)
    kb.add_text_button("ğŸª– Ğ¡Ğ½Ğ°Ñ€ÑĞ¶ĞµĞ½Ğ¸Ğµ", color=ButtonColor.PRIMARY)
    kb.add_row()
    kb.add_text_button("ğŸ”š ĞĞ°Ğ·Ğ°Ğ´", color=ButtonColor.SECONDARY)
    return kb.get_keyboard()


def create_trader_sell_category_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button("ğŸ¥« ĞŸÑ€Ğ¾Ğ²Ğ¸Ğ·Ğ¸Ñ", color=ButtonColor.POSITIVE)
    kb.add_text_button("ğŸª– Ğ¡Ğ½Ğ°Ñ€ÑĞ¶ĞµĞ½Ğ¸Ğµ", color=ButtonColor.PRIMARY)
    kb.add_row()
    kb.add_text_button("ğŸŒ• ĞÑ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹", color=ButtonColor.POSITIVE)
    kb.add_row()
    kb.add_text_button("ğŸ”š ĞĞ°Ğ·Ğ°Ğ´", color=ButtonColor.SECONDARY)
    return kb.get_keyboard()


def create_equipment_category_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button("ğŸ”« ĞÑ€ÑƒĞ¶Ğ¸Ğµ", color=ButtonColor.POSITIVE)
    kb.add_text_button("ğŸ¦º Ğ‘Ñ€Ğ¾Ğ½Ñ", color=ButtonColor.POSITIVE)
    kb.add_row()
    kb.add_text_button("ğŸ“Ÿ Ğ”ĞµÑ‚ĞµĞºÑ‚Ğ¾Ñ€Ñ‹", color=ButtonColor.PRIMARY)
    kb.add_row()
    kb.add_text_button("ğŸ”š ĞĞ°Ğ·Ğ°Ğ´", color=ButtonColor.SECONDARY)
    return kb.get_keyboard()


def create_repair_keyboard(user_id: int) -> str:
    p = players[user_id]
    kb = Keyboard(one_time=False)
    
    if p.get("weapon"):
        kb.add_text_button("ğŸ”« ĞÑ€ÑƒĞ¶Ğ¸Ğµ", color=ButtonColor.POSITIVE)
    else:
        kb.add_text_button("ğŸ”« Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚", color=ButtonColor.SECONDARY)
    
    if p.get("armor"):
        kb.add_text_button("ğŸ¦º Ğ‘Ñ€Ğ¾Ğ½Ñ", color=ButtonColor.POSITIVE)
    else:
        kb.add_text_button("ğŸ¦º Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚", color=ButtonColor.SECONDARY)
    
    kb.add_row()
    kb.add_text_button("ğŸ”š ĞĞ°Ğ·Ğ°Ğ´", color=ButtonColor.NEGATIVE)
    return kb.get_keyboard()


def create_confirmation_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button("âœ… Ğ”Ğ°", color=ButtonColor.POSITIVE)
    kb.add_text_button("âŒ ĞĞµÑ‚", color=ButtonColor.NEGATIVE)
    return kb.get_keyboard()


def create_resting_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button("âœ… Ğ”Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ¾Ñ‚Ğ´Ñ‹Ñ…Ğ°", color=ButtonColor.SECONDARY)
    return kb.get_keyboard()


def create_use_item_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button("ĞÑ‚Ğ¼ĞµĞ½Ğ°", color=ButtonColor.NEGATIVE)
    return kb.get_keyboard()


def create_back_only_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button("ğŸ”š ĞĞ°Ğ·Ğ°Ğ´", color=ButtonColor.SECONDARY)
    return kb.get_keyboard()


def create_war_main_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button("ğŸ—ºï¸ Ğ¢ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ·Ğ¾Ğ½Ñ‹ ğŸ—ºï¸", color=ButtonColor.NEGATIVE)
    kb.add_row()
    kb.add_text_button("ğŸ’² ĞŸÑ€Ğ¸Ğ¾Ğ±Ñ€ĞµÑÑ‚Ğ¸ ÑĞºĞ²Ğ°Ğ´", color=ButtonColor.PRIMARY)
    kb.add_text_button("â™»ï¸ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞºĞ²Ğ°Ğ´Ğ°Ğ¼Ğ¸", color=ButtonColor.PRIMARY)
    kb.add_row()
    kb.add_text_button("ğŸ”š ĞĞ°Ğ·Ğ°Ğ´", color=ButtonColor.SECONDARY)
    return kb.get_keyboard()


def create_war_territories_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button("ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½", color=ButtonColor.SECONDARY)
    kb.add_text_button("Ğ¡Ğ²Ğ°Ğ»ĞºĞ°", color=ButtonColor.SECONDARY)
    kb.add_row()
    kb.add_text_button("Ğ¢Ñ‘Ğ¼Ğ½Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¸Ğ½Ğ°", color=ButtonColor.SECONDARY)
    kb.add_text_button("ĞŸĞ¾Ğ»ÑĞ½Ğ°", color=ButtonColor.SECONDARY)
    kb.add_row()
    kb.add_text_button("ğŸ”š ĞĞ°Ğ·Ğ°Ğ´", color=ButtonColor.NEGATIVE)
    return kb.get_keyboard()


def create_hunting_keyboard() -> str:
    kb = Keyboard(one_time=False)
    for i in range(1, 10):
        kb.add_text_button(f"ğŸ¯ {i}", color=ButtonColor.SECONDARY)
        if i % 3 == 0 and i < 9:
            kb.add_row()
    kb.add_row()
    kb.add_text_button("ğŸƒ ĞŸĞ¾Ğ±ĞµĞ³", color=ButtonColor.NEGATIVE)
    return kb.get_keyboard()


def create_anomaly_movement_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button("â¬†ï¸", color=ButtonColor.PRIMARY)
    kb.add_row()
    kb.add_text_button("â¬…ï¸", color=ButtonColor.PRIMARY)
    kb.add_text_button("â¡ï¸", color=ButtonColor.PRIMARY)
    kb.add_row()
    kb.add_text_button("â¬‡ï¸", color=ButtonColor.PRIMARY)
    kb.add_row()
    kb.add_text_button("ğŸšª Ğ£Ğ¹Ñ‚Ğ¸", color=ButtonColor.NEGATIVE)
    return kb.get_keyboard()


def create_belt_main_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button("â• ĞŸĞ¾Ğ²ĞµÑĞ¸Ñ‚ÑŒ", color=ButtonColor.POSITIVE)
    kb.add_text_button("â– Ğ¡Ğ½ÑÑ‚ÑŒ", color=ButtonColor.NEGATIVE)
    kb.add_row()
    kb.add_text_button("ğŸ’¡ Ğ˜Ğ½Ñ„Ğ¾ Ğ¾Ğ± Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ°Ñ…", color=ButtonColor.PRIMARY)
    kb.add_row()
    kb.add_text_button("ğŸ”š ĞĞ°Ğ·Ğ°Ğ´", color=ButtonColor.SECONDARY)
    return kb.get_keyboard()


def create_belt_slot_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button("1ï¸âƒ£ ĞŸĞ¾ÑÑ", color=ButtonColor.PRIMARY)
    kb.add_text_button("2ï¸âƒ£ ĞŸĞ¾ÑÑ", color=ButtonColor.PRIMARY)
    kb.add_text_button("3ï¸âƒ£ ĞŸĞ¾ÑÑ", color=ButtonColor.PRIMARY)
    kb.add_row()
    kb.add_text_button("ğŸ”š ĞĞ°Ğ·Ğ°Ğ´", color=ButtonColor.SECONDARY)
    return kb.get_keyboard()


def create_transition_keyboard(user_id: int) -> str:
    current_loc = players[user_id]["location"]
    kb = Keyboard(one_time=False)
    kb.add_text_button(f"â–¶ï¸ {current_loc} â—€ï¸", color=ButtonColor.PRIMARY)
    kb.add_row()
    for loc in ["ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½", "Ğ¡Ğ²Ğ°Ğ»ĞºĞ°", "Ğ¢Ñ‘Ğ¼Ğ½Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¸Ğ½Ğ°", "ĞŸĞ¾Ğ»ÑĞ½Ğ°"]:
        if loc != current_loc:
            kb.add_text_button(loc, color=ButtonColor.SECONDARY)
    kb.add_row()
    kb.add_text_button("ğŸ”š ĞĞ°Ğ·Ğ°Ğ´", color=ButtonColor.NEGATIVE)
    return kb.get_keyboard()


def create_war_buy_squad_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button("1 ÑĞºĞ²Ğ°Ğ´", color=ButtonColor.POSITIVE)
    kb.add_text_button("3 ÑĞºĞ²Ğ°Ğ´Ğ°", color=ButtonColor.POSITIVE)
    kb.add_text_button("5 ÑĞºĞ²Ğ°Ğ´Ğ¾Ğ²", color=ButtonColor.POSITIVE)
    kb.add_row()
    kb.add_text_button("â™»ï¸ ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ²Ğ¸Ğ·Ğ¸Ğ¸", color=ButtonColor.PRIMARY)
    kb.add_row()
    kb.add_text_button("ğŸ”š ĞĞ°Ğ·Ğ°Ğ´", color=ButtonColor.SECONDARY)
    return kb.get_keyboard()


def create_war_manage_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button("ğŸ“¤ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ", color=ButtonColor.POSITIVE)
    kb.add_text_button("ğŸ“¥ Ğ’Ñ‹Ğ²ĞµÑÑ‚Ğ¸", color=ButtonColor.POSITIVE)
    kb.add_row()
    kb.add_text_button("ğŸ‘¥ ĞĞ±Ñ‰Ğ¸Ğµ ÑĞºĞ²Ğ°Ğ´Ñ‹", color=ButtonColor.PRIMARY)
    kb.add_row()
    kb.add_text_button("ğŸ”š ĞĞ°Ğ·Ğ°Ğ´", color=ButtonColor.SECONDARY)
    return kb.get_keyboard()


def create_war_send_location_keyboard(user_id: int) -> str:
    kb = Keyboard(one_time=False)
    for loc in ["ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½", "Ğ¡Ğ²Ğ°Ğ»ĞºĞ°", "Ğ¢Ñ‘Ğ¼Ğ½Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¸Ğ½Ğ°", "ĞŸĞ¾Ğ»ÑĞ½Ğ°"]:
        kb.add_text_button(loc, color=ButtonColor.SECONDARY)
        kb.add_row()
    kb.add_text_button("ğŸ”š ĞĞ°Ğ·Ğ°Ğ´", color=ButtonColor.NEGATIVE)
    return kb.get_keyboard()


def create_attack_confirm_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button("âœ… Ğ”Ğ°", color=ButtonColor.POSITIVE)
    kb.add_text_button("âŒ ĞĞµÑ‚", color=ButtonColor.NEGATIVE)
    kb.add_row()
    kb.add_text_button("âš”ï¸ ĞĞ°Ğ¿Ğ°ÑÑ‚ÑŒ ÑĞ¾ ÑĞºĞ²Ğ°Ğ´Ğ°Ğ¼Ğ¸", color=ButtonColor.PRIMARY)
    return kb.get_keyboard()


def create_shared_squads_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button("ğŸ“¥ ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ", color=ButtonColor.POSITIVE)
    kb.add_text_button("ğŸ“¤ Ğ’Ñ‹Ğ²ĞµÑÑ‚Ğ¸", color=ButtonColor.POSITIVE)
    kb.add_row()
    kb.add_text_button("ğŸ”š ĞĞ°Ğ·Ğ°Ğ´", color=ButtonColor.SECONDARY)
    return kb.get_keyboard()


def create_anomaly_path_keyboard() -> str:
    kb = Keyboard(one_time=False)
    kb.add_text_button("ğŸŒ€ ĞŸÑƒÑ‚ÑŒ 1", color=ButtonColor.PRIMARY)
    kb.add_text_button("ğŸŒ€ ĞŸÑƒÑ‚ÑŒ 2", color=ButtonColor.PRIMARY)
    kb.add_text_button("ğŸŒ€ ĞŸÑƒÑ‚ÑŒ 3", color=ButtonColor.PRIMARY)
    kb.add_row()
    kb.add_text_button("ğŸšª Ğ£Ğ¹Ñ‚Ğ¸", color=ButtonColor.NEGATIVE)
    return kb.get_keyboard()


def create_artifact_selection_keyboard(artifacts: List[str], page: int = 0) -> str:
    kb = Keyboard(one_time=False)
    items_per_page = 6
    start = page * items_per_page
    end = start + items_per_page
    page_items = artifacts[start:end]
    
    count = 0
    for art in page_items:
        if count > 0 and count % 2 == 0:
            kb.add_row()
        kb.add_text_button(art[:20], color=ButtonColor.SECONDARY)
        count += 1
    
    kb.add_row()
    total_pages = (len(artifacts) + items_per_page - 1) // items_per_page
    if total_pages > 1:
        if page > 0:
            kb.add_text_button("â—€ï¸ Ğ¢ÑƒĞ´Ğ°", color=ButtonColor.PRIMARY)
        if page < total_pages - 1:
            kb.add_text_button("â–¶ï¸ Ğ¡ÑĞ´Ğ°", color=ButtonColor.PRIMARY)
        kb.add_row()
    
    kb.add_text_button("ğŸ”š ĞĞ°Ğ·Ğ°Ğ´", color=ButtonColor.NEGATIVE)
    return kb.get_keyboard()


# ==================== Ğ’Ğ¡ĞŸĞĞœĞĞ“ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ«Ğ• Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜ ====================
def get_emission_status() -> str:
    global emission_counter, EMISSION_MAX
    ratio = emission_counter / EMISSION_MAX
    if ratio < 0.2:
        return "ğŸŸ¢"
    elif ratio < 0.4:
        return "ğŸŸ¡"
    elif ratio < 0.6:
        return "ğŸŸ "
    elif ratio < 0.8:
        return "ğŸ”´"
    elif ratio < 0.957:
        return "âš«"
    else:
        return "â˜ ï¸"


def has_active_donation(user_id: int) -> bool:
    p = players.get(user_id)
    if not p:
        return False
    end_time = p.get("donation_end_time")
    return end_time and time.time() < end_time


def get_donation_artifact(user_id: int) -> Optional[str]:
    p = players.get(user_id)
    if not p:
        return None
    if has_active_donation(user_id):
        return p.get("donation_artifact")
    return None


def is_admin(user_id: int) -> bool:
    return user_id == 353430025 or user_id in admin_users


def is_valid_point(loc_name: str, point: str) -> bool:
    return point in LOCATIONS.get(loc_name, [])


def can_transition_from(loc: str, point: str) -> bool:
    return (loc, point) in TRANSITION_ROUTES


def get_available_transitions(loc: str, point: str) -> List[Tuple[str, str]]:
    return TRANSITION_ROUTES.get((loc, point), [])


def get_territory_owner(location: str, point: str) -> Optional[str]:
    if location in territory_control and point in territory_control[location]:
        return territory_control[location][point].get("faction")
    return None


def get_territory_squads(location: str, point: str) -> int:
    if location in territory_control and point in territory_control[location]:
        return territory_control[location][point].get("squads", 0)
    return 0


def set_territory_control(location: str, point: str, faction: Optional[str], squads: int):
    global territory_control
    if location not in territory_control:
        territory_control[location] = {}
    territory_control[location][point] = {"faction": faction, "squads": squads}
    save_data()


def init_territory_control():
    global territory_control
    territory_control = {}
    for loc in LOCATIONS:
        territory_control[loc] = {}
        for point in LOCATIONS[loc]:
            territory_control[loc][point] = {"faction": None, "squads": 0}
    
    territory_control["ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½"]["Ğ‘1"] = {"faction": "ğŸ›¡ï¸ Ğ”Ğ¾Ğ»Ğ³", "squads": 5}
    territory_control["Ğ¢Ñ‘Ğ¼Ğ½Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¸Ğ½Ğ°"]["Ğ‘1"] = {"faction": "â˜¦ï¸ Ğ“Ñ€ĞµÑ…", "squads": 5}
    territory_control["Ğ¡Ğ²Ğ°Ğ»ĞºĞ°"]["Ğ‘1"] = {"faction": "â˜¢ï¸ ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸", "squads": 5}
    save_data()


def init_territory_exhaustion():
    global territory_exhaustion
    territory_exhaustion = {}
    for loc in LOCATIONS:
        territory_exhaustion[loc] = {}
        for point in LOCATIONS[loc]:
            territory_exhaustion[loc][point] = 0
    save_data()


def check_territory_exhaustion(location: str, point: str) -> bool:
    ptype = POINT_TYPES.get(point, "Ğ¢ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ")
    limit = EXHAUSTION_LIMITS.get(ptype, 100)
    current = territory_exhaustion.get(location, {}).get(point, 0)
    return current < limit


def add_territory_exhaustion(location: str, point: str):
    global territory_exhaustion
    if location not in territory_exhaustion:
        territory_exhaustion[location] = {}
    territory_exhaustion[location][point] = territory_exhaustion[location].get(point, 0) + 1
    save_data()


def is_player_on_own_territory(user_id: int) -> bool:
    p = players[user_id]
    location = p.get("location")
    point = p.get("point")
    faction = p.get("faction")
    owner = get_territory_owner(location, point)
    return owner == faction


def get_belt_bonus(user_id: int, stat: str) -> float:
    p = players[user_id]
    belt = p.get("belt", [None, None, None])
    total = 0
    for art in belt:
        if art and art in ARTIFACT_EFFECTS:
            total += ARTIFACT_EFFECTS[art].get(stat, 0)
    return total


def normalize_stats(user_id: int):
    p = players[user_id]
    p["health"] = round(max(0, min(10, p.get("health", 10))), 1)
    p["radiation"] = round(max(0, min(10, p.get("radiation", 0))), 1)
    p["hunger"] = round(max(0, min(10, p.get("hunger", 0))), 1)
    p["stamina"] = round(max(0, min(10, p.get("stamina", 10))), 1)


def get_total_weapon_damage(user_id: int) -> float:
    p = players[user_id]
    return p.get("weapon_damage", 0) + get_belt_bonus(user_id, "weapon_damage")


def get_total_weapon_accuracy(user_id: int) -> int:
    p = players[user_id]
    return int(p.get("weapon_accuracy", 0) + get_belt_bonus(user_id, "weapon_accuracy"))


def get_total_blast_resist(user_id: int) -> float:
    p = players[user_id]
    return p.get("blast_resist", 0) + get_belt_bonus(user_id, "blast_resist")


def get_total_anomaly_resist(user_id: int) -> float:
    p = players[user_id]
    return p.get("anomaly_resist", 0) + get_belt_bonus(user_id, "anomaly_resist")


def apply_belt_effects_on_rest(user_id: int) -> float:
    return get_belt_bonus(user_id, "stamina_regen")


def apply_belt_effects_on_exploration(user_id: int):
    p = players[user_id]
    health_regen = get_belt_bonus(user_id, "health_regen")
    radiation_reduce = get_belt_bonus(user_id, "radiation_reduce")
    if health_regen > 0:
        p["health"] = min(10, p["health"] + health_regen)
    if radiation_reduce > 0:
        p["radiation"] = max(0, p["radiation"] - radiation_reduce)
    normalize_stats(user_id)


def get_random_artifact_by_rarity(anomaly_type: str) -> str:
    artifacts = ARTIFACTS[anomaly_type]
    weighted_artifacts = []
    for art in artifacts:
        price = ARTIFACT_PRICES.get(art, 15)
        if price <= 15:
            weight = 40
        elif price <= 25:
            weight = 30
        elif price <= 35:
            weight = 20
        else:
            weight = 10
        weighted_artifacts.append((art, weight))
    
    total_weight = sum(w for _, w in weighted_artifacts)
    rand = random.randint(1, total_weight)
    current = 0
    for art, weight in weighted_artifacts:
        current += weight
        if rand <= current:
            return art
    return artifacts[0]


def format_camp_info(user_id: int) -> str:
    p = players[user_id]
    nickname = p["nickname"]
    faction = p["faction"]
    location = p.get("location", "Ğ›Ğ°Ğ³ĞµÑ€ÑŒ")
    point = p.get("point", "Ğ‘1")
    
    health = p.get("health", 10)
    radiation = p.get("radiation", 0)
    hunger = p.get("hunger", 0)
    stamina = p.get("stamina", 10)
    
    detector = p.get("detector", None)
    detector_charge = p.get("detector_charge", 0)
    detector_max_charge = p.get("detector_max_charge", 0)
    
    armor = p.get("armor", None)
    armor_durability = p.get("armor_durability", 0)
    armor_max_durability = p.get("armor_max_durability", 0)
    bullet_resist = p.get("bullet_resist", 0) + get_belt_bonus(user_id, "bullet_resist")
    blast_resist = p.get("blast_resist", 0) + get_belt_bonus(user_id, "blast_resist")
    anomaly_resist = p.get("anomaly_resist", 0) + get_belt_bonus(user_id, "anomaly_resist")
    
    weapon = p.get("weapon", None)
    weapon_durability = p.get("weapon_durability", 0)
    weapon_max_durability = p.get("weapon_max_durability", 0)
    weapon_damage = p.get("weapon_damage", 0) + get_belt_bonus(user_id, "weapon_damage")
    weapon_accuracy = p.get("weapon_accuracy", 0) + get_belt_bonus(user_id, "weapon_accuracy")
    
    money = p.get("money", 0)
    belt = p.get("belt", [None, None, None])
    belt_str = f"1ï¸âƒ£{belt[0] or '-'} 2ï¸âƒ£{belt[1] or '-'} 3ï¸âƒ£{belt[2] or '-'}"
    
    return f"""Â«ğŸ’¬ ĞšĞ»Ğ¸Ñ‡: {nickname}
Â«ğŸ‘¥ Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°: {faction}
Â«ğŸ—º ĞœĞµÑÑ‚Ğ¾Ğ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ: {location} {point}
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
Â«â¤ï¸ Ğ—Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ: {health}/10
Â«â˜¢ï¸ Ğ Ğ°Ğ´Ğ¸Ğ°Ñ†Ğ¸Ñ: {radiation}/10
Â«ğŸ½ï¸ Ğ“Ğ¾Ğ»Ğ¾Ğ´: {hunger}/10
Â«âš¡ Ğ’Ñ‹Ğ½Ğ¾ÑĞ»Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ: {stamina}/10
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
Â«ğŸ“Ÿ Ğ”ĞµÑ‚ĞµĞºÑ‚Ğ¾Ñ€: {'Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚' if not detector else detector} {detector_charge}/{detector_max_charge}ğŸ”‹
Â«ğŸª– Ğ‘Ñ€Ğ¾Ğ½Ñ: {'Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚' if not armor else armor} ğŸ”§{armor_durability}/{armor_max_durability}
(ğŸ›¡) {bullet_resist} (ğŸ¾) {blast_resist} (ğŸ’¥) {anomaly_resist}
Â«ğŸ”« ĞÑ€ÑƒĞ¶Ğ¸Ğµ: {'Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚' if not weapon else weapon} ğŸ”§{weapon_durability}/{weapon_max_durability}
(ğŸ’¢) {weapon_damage} (ğŸ¯) {weapon_accuracy}
Â«ğŸŸ¡ ĞŸĞ¾ÑÑ: {belt_str}
Â«ğŸ’² Ğ”ĞµĞ½ÑŒĞ³Ğ¸: {money}Ñ€"""


def format_backpack_info(user_id: int) -> str:
    p = players[user_id]
    backpack = p.get("backpack", {})
    money = p.get("money", 0)
    
    if not backpack:
        items_str = "ĞŸĞ¾ĞºĞ° Ğ¿ÑƒÑÑ‚Ğ¾... ğŸ“¦"
    else:
        active_items = {k: v for k, v in backpack.items() if v > 0}
        if not active_items:
            items_str = "ĞŸÑƒÑÑ‚Ğ¾"
        else:
            items_list = [f"{item}: {count}" for item, count in active_items.items()]
            items_str = ", ".join(items_list)
    
    return f"ğŸ’ Ğ’Ğ°ÑˆĞ¸ Ğ²ĞµÑ‰Ğ¸:\n{items_str}\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nğŸ’² Ğ’Ğ°ÑˆĞ¸ Ğ´ĞµĞ½ÑŒĞ³Ğ¸: {money}Ñ€"


def find_player_by_mention_or_nickname(target: str, _) -> Optional[int]:
    target = target.strip()
    if target.startswith('@'):
        screen_name = target[1:].lower()
        for uid, data in players.items():
            if data.get("screen_name", "").lower() == screen_name:
                return uid
        return None
    
    target_lower = target.lower()
    for uid, data in players.items():
        nickname = data.get("nickname", "")
        if nickname.lower() == target_lower:
            return uid
    
    for uid, data in players.items():
        nickname = data.get("nickname", "")
        if target_lower in nickname.lower():
            return uid
    
    return None


def find_start_position(faction: str) -> Tuple[str, str]:
    start_loc, start_point = FACTION_START_LOCATIONS.get(faction, ("ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½", "Ğ‘1"))
    owner = get_territory_owner(start_loc, start_point)
    if owner == faction:
        return start_loc, start_point
    
    for loc in LOCATIONS:
        for point in LOCATIONS[loc]:
            if get_territory_owner(loc, point) == faction:
                return loc, point
    
    return start_loc, start_point


def roll_drops(drop_table: Dict, point_type: str) -> Dict[str, int]:
    rand = random.random()
    if rand < 0.5:
        num_types = 1
    elif rand < 0.75:
        num_types = 2
    elif rand < 0.875:
        num_types = 3
    else:
        num_types = 1
    
    candidates = []
    for item, data in drop_table.items():
        if random.randint(1, 100) <= data["chance"]:
            candidates.append(item)
    
    if not candidates and random.random() < 0.1:
        all_items = list(drop_table.keys())
        candidates = random.sample(all_items, k=min(1, len(all_items)))
    
    if len(candidates) > num_types:
        candidates = random.sample(candidates, k=num_types)
    elif len(candidates) == 0:
        return {}
    
    found = {}
    for item in candidates:
        data = drop_table[item]
        amount = random.randint(data["min"], data["max"])
        found[item] = amount
    
    return found


def get_radiation_gain(point_type: str) -> float:
    if random.randint(1, 100) > 25:
        return 0
    
    gains = {
        "Ğ¢ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ": [0.5, 1],
        "Ğ¢Ğ¾Ñ‡ĞºĞ° Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²": [0.5, 1.5],
        "Ğ‘Ğ°Ğ·Ğ°": [0.5, 2],
        "ĞĞ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ·Ğ¾Ğ½Ğ°": [0.5, 2.5],
        "Ğ›Ğ¾Ğ³Ğ¾Ğ²Ğ¾": [0.5, 2]
    }
    return random.choice(gains.get(point_type, [0]))


def calculate_and_apply_death_losses(user_id: int, max_items: int = 10, max_money: int = 100) -> Tuple[Dict[str, int], int]:
    p = players[user_id]
    backpack = p.get("backpack", {})
    money = p.get("money", 0)
    
    lost_items = {}
    items_list = []
    for item, count in backpack.items():
        if item not in DONATION_ARTIFACTS:
            items_list.extend([item] * count)
    
    total_items = len(items_list)
    if total_items > 0:
        num_items_to_lose = random.randint(1, min(max_items, total_items))
        random.shuffle(items_list)
        lost_list = items_list[:num_items_to_lose]
        for item in lost_list:
            lost_items[item] = lost_items.get(item, 0) + 1
        for item, count in lost_items.items():
            p["backpack"][item] -= count
            if p["backpack"][item] <= 0:
                del p["backpack"][item]
    
    money_lost = random.randint(1, min(max_money, money)) if money > 0 else 0
    p["money"] -= money_lost
    
    return lost_items, money_lost


def format_death_losses(lost_items: Dict[str, int], money_lost: int) -> List[str]:
    lines = []
    if lost_items or money_lost:
        lines.append("ĞŸĞ¾Ñ‚ĞµÑ€ÑĞ½Ğ¾:")
        for item, count in lost_items.items():
            lines.append(f"  {item} x{count}")
        if money_lost > 0:
            lines.append(f"  ğŸ’² {money_lost}Ñ€")
    return lines


def select_mutant(location: str, point: str) -> Optional[Dict]:
    chances = MUTANT_SPAWN_CHANCES.get(location, {}).get(point, {})
    if not chances:
        return None
    
    total = sum(chances.values())
    if total == 0:
        return None
    
    rand = random.randint(1, total)
    cumulative = 0
    for mutant_type, prob in chances.items():
        cumulative += prob
        if rand <= cumulative:
            rank_roll = random.randint(1, 100)
            if rank_roll <= 30:
                rank = 0
            elif rank_roll <= 80:
                rank = 1
            else:
                rank = 2
            return MUTANTS[mutant_type][rank]
    
    return None


# ==================== ĞĞ¢ĞŸĞ ĞĞ’ĞšĞ Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ™ ====================
async def send_message(user_id: int, message: str, keyboard: str = None, peer_id: int = None):
    """ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"""
    if not message.strip():
        logger.warning("ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ")
        return
    
    try:
        target_id = peer_id if peer_id else user_id
        params = {
            "peer_id": target_id,
            "message": message,
            "random_id": random.randint(1, 10**9)
        }
        if keyboard:
            params["keyboard"] = keyboard
        
        await bot.api.messages.send(**params)
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ: {e}")


async def send_photo_with_message(user_id: int, photo_bytes: io.BytesIO, message: str, keyboard: str = None):
    """ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ñ„Ğ¾Ñ‚Ğ¾ Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ĞµĞ¼"""
    try:
        upload_server = await bot.api.photos.get_messages_upload_server()
        upload_url = upload_server.response.upload_url
        
        # Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ñ„Ğ¾Ñ‚Ğ¾
        import aiohttp
        async with aiohttp.ClientSession() as session:
            data = aiohttp.FormData()
            data.add_field('photo', photo_bytes.getvalue(), filename='image.png', content_type='image/png')
            async with session.post(upload_url, data=data) as resp:
                result = await resp.json()
        
        # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ„Ğ¾Ñ‚Ğ¾
        saved = await bot.api.photos.save_messages_photo(
            photo=result['photo'],
            server=result['server'],
            hash=result['hash']
        )
        photo = saved.response[0]
        attachment = f"photo{photo.owner_id}_{photo.id}"
        
        params = {
            "peer_id": user_id,
            "message": message,
            "attachment": attachment,
            "random_id": random.randint(1, 10**9)
        }
        if keyboard:
            params["keyboard"] = keyboard
        
        await bot.api.messages.send(**params)
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ñ„Ğ¾Ñ‚Ğ¾: {e}")
        await send_message(user_id, message, keyboard)


# ==================== ĞŸĞĞ›Ğ£Ğ§Ğ•ĞĞ˜Ğ• Ğ˜ĞĞ¤ĞĞ ĞœĞĞ¦Ğ˜Ğ˜ Ğ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ• ====================
async def get_user_info(user_id: int) -> Tuple[str, str]:
    """ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸Ğ¼ĞµĞ½Ğ¸ Ğ¸ screen_name Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"""
    try:
        response = await bot.api.users.get(user_ids=user_id, fields=["screen_name"])
        user = response.response[0]
        first_name = user.first_name
        screen_name = user.screen_name or ""
        return first_name, screen_name
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ¼ĞµĞ½Ğ¸: {e}")
        return "Ğ´Ñ€ÑƒĞ³", ""


# ==================== Ğ“Ğ•ĞĞ•Ğ ĞĞ¦Ğ˜Ğ¯ Ğ˜Ğ—ĞĞ‘Ğ ĞĞ–Ğ•ĞĞ˜Ğ™ ====================
def generate_inventory_image(user_id: int) -> io.BytesIO:
    """Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ¸Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ñ"""
    p = players[user_id]
    backpack = p.get("backpack", {})
    
    CELL_SIZE = 50
    INV_COLS = 6
    INV_ROWS = 10
    LEFT_PANEL_WIDTH = 210
    INV_WIDTH = INV_COLS * CELL_SIZE + 15
    width = LEFT_PANEL_WIDTH + INV_WIDTH + 5
    height = INV_ROWS * CELL_SIZE + 40
    
    try:
        bg = Image.open("backgrounds/inventory_bg.png").convert("RGBA").resize((width, height))
    except:
        bg = Image.new("RGBA", (width, height), (20, 25, 20, 255))
    
    img = bg.copy()
    draw = ImageDraw.Draw(img)
    
    try:
        font = ImageFont.truetype("Graffiti1C.ttf", 16)
        font_small = ImageFont.truetype("Graffiti1C.ttf", 12)
        font_title = ImageFont.truetype("Graffiti1C.ttf", 18)
    except:
        font = ImageFont.load_default()
        font_small = font
        font_title = font
    
    COLOR_FRAME = (70, 80, 60, 255)
    COLOR_SLOT_EMPTY = (40, 45, 40, 180)
    
    all_icons = {**ITEM_ICONS, **ARTIFACT_ICONS}
    
    # Ğ Ğ¸ÑÑƒĞµĞ¼ ÑÑ‚Ğ°Ñ‚Ñ‹
    panel_x = 5
    panel_y = 5
    
    draw.text((panel_x + 5, panel_y + 5), f"{p['nickname']}", fill="white", font=font_title)
    draw.text((panel_x + 5, panel_y + 30), f"{p.get('faction', '')}", fill="white", font=font)
    draw.text((panel_x + 5, panel_y + 55), f"{p.get('location', '')} {p.get('point', '')}", fill="white", font=font)
    draw.text((panel_x + 5, panel_y + 80), f"$ {p.get('money', 0)} RU", fill="yellow", font=font)
    
    # Ğ Ğ¸ÑÑƒĞµĞ¼ ÑÑ‡ĞµĞ¹ĞºĞ¸ Ğ¸Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ñ
    inv_panel_x = LEFT_PANEL_WIDTH
    inv_panel_y = 5
    
    items_list = []
    for item, count in backpack.items():
        if count > 0 and (item in ITEM_ICONS or item in ARTIFACT_ICONS):
            items_list.append((item, count))
    
    max_items = INV_COLS * INV_ROWS
    while len(items_list) < max_items:
        items_list.append((None, 0))
    items_list = items_list[:max_items]
    
    for idx, (item, count) in enumerate(items_list):
        row = idx // INV_COLS
        col = idx % INV_COLS
        x = inv_panel_x + 6 + col * CELL_SIZE
        y = inv_panel_y + 20 + row * CELL_SIZE
        
        draw.rectangle([x, y, x + CELL_SIZE - 2, y + CELL_SIZE - 2], fill=COLOR_SLOT_EMPTY, outline=COLOR_FRAME, width=1)
        
        if item:
            icon_path = all_icons.get(item)
            if icon_path and os.path.exists(icon_path):
                try:
                    icon = Image.open(icon_path).convert("RGBA").resize((CELL_SIZE - 6, CELL_SIZE - 6))
                    img.paste(icon, (x + 2, y + 2), icon)
                except:
                    pass
            
            text = str(count)
            draw.text((x + CELL_SIZE - 15, y + CELL_SIZE - 18), text, fill="white", font=font_small)
    
    buffer = io.BytesIO()
    img.save(buffer, format="PNG")
    buffer.seek(0)
    return buffer


def generate_war_map_image(location: str) -> Optional[io.BytesIO]:
    """Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ĞºĞ°Ñ€Ñ‚Ñ‹ Ñ‚ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹"""
    map_path = LOCATION_MAPS.get(location)
    if not map_path or not os.path.exists(map_path):
        return None
    
    try:
        img = Image.open(map_path).convert("RGBA")
        draw = ImageDraw.Draw(img)
        icon_size = 45 if location == "ĞŸĞ¾Ğ»ÑĞ½Ğ°" else 30
        
        # Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¸ĞºĞ¾Ğ½ĞºĞ¸ Ñ„Ñ€Ğ°ĞºÑ†Ğ¸Ğ¹
        faction_icons_loaded = {}
        for faction, icon_path in FACTION_ICONS.items():
            try:
                faction_icons_loaded[faction] = Image.open(icon_path).convert("RGBA").resize((icon_size, icon_size))
            except:
                faction_icons_loaded[faction] = None
        
        # Ğ Ğ¸ÑÑƒĞµĞ¼ Ğ¸ĞºĞ¾Ğ½ĞºĞ¸ Ğ½Ğ° Ñ‚Ğ¾Ñ‡ĞºĞ°Ñ…
        if location in POINT_COORDINATES:
            for point, (x, y) in POINT_COORDINATES[location].items():
                owner = get_territory_owner(location, point)
                if owner and owner in faction_icons_loaded and faction_icons_loaded[owner]:
                    icon = faction_icons_loaded[owner]
                    img.paste(icon, (x - icon_size // 2, y - icon_size // 2), icon)
        
        buffer = io.BytesIO()
        img.save(buffer, format="PNG")
        buffer.seek(0)
        return buffer
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ²Ğ¾Ğ¹Ğ½Ñ‹: {e}")
        return None


def generate_anomaly_map_image(user_id: int) -> io.BytesIO:
    """Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ·Ğ¾Ğ½Ñ‹"""
    p = players[user_id]
    player_pos = tuple(p.get("player_pos", (0, 0)))
    artifact_positions = [tuple(pos) for pos in p.get("artifact_positions", [])]
    anomaly_positions = [tuple(pos) for pos in p.get("anomaly_positions", [])]
    detector = p.get("detector", None)
    
    cell_size = 60
    grid_size = 6
    width = cell_size * grid_size
    height = cell_size * grid_size
    
    try:
        bg = Image.open("backgrounds/background.png").convert("RGBA").resize((width, height))
        enhancer = ImageEnhance.Brightness(bg)
        bg = enhancer.enhance(0.75)
    except:
        bg = Image.new("RGBA", (width, height), (40, 40, 40, 255))
    
    img = bg.copy()
    draw = ImageDraw.Draw(img)
    
    # Ğ Ğ¸ÑÑƒĞµĞ¼ ÑĞµÑ‚ĞºÑƒ
    for row in range(grid_size):
        for col in range(grid_size):
            x = col * cell_size
            y = row * cell_size
            draw.rectangle([x, y, x + cell_size, y + cell_size], outline="black", width=2)
    
    icon_size = cell_size - 10
    px, py = player_pos
    
    # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ²Ğ¸Ğ½ÑƒÑ‚Ñ‹Ñ… Ğ´ĞµÑ‚ĞµĞºÑ‚Ğ¾Ñ€Ğ¾Ğ²
    if detector in ["Ğ’ĞµĞ»ĞµÑ", "Ğ¡Ğ²Ğ°Ñ€Ğ¾Ğ³"]:
        for ax, ay in artifact_positions:
            if abs(ax - px) <= 4 and abs(ay - py) <= 4:
                x = ax * cell_size + 5
                y = ay * cell_size + 5
                draw.ellipse([x, y, x + icon_size, y + icon_size], fill="yellow", outline="orange")
    
    # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ¡Ğ²Ğ°Ñ€Ğ¾Ğ³Ğ°
    if detector == "Ğ¡Ğ²Ğ°Ñ€Ğ¾Ğ³":
        for ax, ay in anomaly_positions:
            if abs(ax - px) <= 4 and abs(ay - py) <= 4:
                x = ax * cell_size + 5
                y = ay * cell_size + 5
                draw.ellipse([x, y, x + icon_size, y + icon_size], fill="cyan", outline="blue")
    
    # Ğ Ğ¸ÑÑƒĞµĞ¼ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°
    x = px * cell_size + 5
    y = py * cell_size + 5
    draw.ellipse([x, y, x + icon_size, y + icon_size], fill="white", outline="gray")
    
    buffer = io.BytesIO()
    img.save(buffer, format="PNG")
    buffer.seek(0)
    return buffer


# ==================== Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ Ğ’Ğ«Ğ‘Ğ ĞĞ¡Ğ ====================
async def increment_emission():
    """Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸ĞºĞ° Ğ²Ñ‹Ğ±Ñ€Ğ¾ÑĞ°"""
    global emission_counter
    emission_counter += 1
    
    warning_threshold = int(EMISSION_MAX * 0.75)
    if emission_counter == warning_threshold:
        for uid in players:
            if uid in banned_users:
                continue
            p = players[uid]
            faction = p.get("faction")
            if not faction or faction == "None":
                continue
            state = p.get("state")
            if state in [GameState.WAITING_FOR_START, GameState.READING_INSTRUCTIONS, 
                        GameState.CHOOSING_FACTION, GameState.ENTERING_NICKNAME]:
                continue
            await send_message(uid, "âš ï¸ Ğ’ĞĞ˜ĞœĞĞĞ˜Ğ•! ĞŸÑ€Ğ¸Ğ±Ğ»Ğ¸Ğ¶Ğ°ĞµÑ‚ÑÑ Ğ²Ñ‹Ğ±Ñ€Ğ¾Ñ! Ğ£ĞºÑ€Ğ¾Ğ¹Ñ‚ĞµÑÑŒ Ğ² Ğ»Ğ°Ğ³ĞµÑ€Ğµ!")
    
    if emission_counter >= EMISSION_MAX:
        await 
async def trigger_emission():
    """Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ²Ñ‹Ğ±Ñ€Ğ¾ÑĞ°"""
    global emission_counter, last_restored_categories, territory_exhaustion
    
    categories = ["Ğ‘Ğ°Ğ·Ğ°", "Ğ¢Ğ¾Ñ‡ĞºĞ° Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²", "Ğ¢ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ", "Ğ›Ğ¾Ğ³Ğ¾Ğ²Ğ¾", "ĞĞ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ·Ğ¾Ğ½Ğ°"]
    num_categories = random.choice([1, 2])
    restored = random.sample(categories, num_categories)
    last_restored_categories = restored
    
    # Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ‚ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸
    for loc in LOCATIONS:
        for point in LOCATIONS[loc]:
            ptype = POINT_TYPES.get(point, "Ğ¢ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ")
            if ptype in restored:
                territory_exhaustion[loc][point] = 0
    
    # Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
    safe_states = [GameState.IN_CAMP, GameState.IN_BACKPACK, GameState.RESTING, 
                   GameState.USING_ITEM, GameState.BELT_MAIN, GameState.BELT_SELECT_SLOT,
                   GameState.BELT_SELECT_ARTIFACT, GameState.BELT_EQUIP, GameState.BELT_UNEQUIP]
    
    dead_players = []
    
    for uid, p in players.items():
        if uid in banned_users:
            continue
        faction = p.get("faction")
        if not faction or faction == "None":
            continue
        state = p.get("state")
        if state in [GameState.WAITING_FOR_START, GameState.READING_INSTRUCTIONS,
                     GameState.CHOOSING_FACTION, GameState.ENTERING_NICKNAME]:
            continue
        
        if state not in safe_states:
            # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ°
            if state == GameState.TRANSITION_WAIT:
                p["transition_end_time"] = None
                if p.get("previous_location") and p.get("previous_point"):
                    p["location"] = p["previous_location"]
                    p["point"] = p["previous_point"]
                p["previous_location"] = None
                p["previous_point"] = None
                p["state"] = GameState.IN_MENU
            elif state in [GameState.HUNTING, GameState.HUNTING_SHOOTING, GameState.ANOMALY_EXPLORE]:
                p["state"] = GameState.IN_MENU
                p["artifact_positions"] = []
                p["anomaly_positions"] = []
                p["hidden_anomaly_positions"] = []
                p["current_mutant"] = None
                p["mutant_hp"] = None
                p["anomaly_path_choosing"] = False
            
            p["health"] = 0
            p["hunger"] = 10
            p["radiation"] = 10
            p["death_notified"] = True
            
            nickname = p.get("nickname", "ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹")
            location = p.get("location", "?")
            point = p.get("point", "?")
            
            if faction != ZOMBIE_FACTION:
                dead_players.append(f"â€¢ {nickname} ({faction}) â€” {location} {point}")
            
            await send_message(uid, "â˜ ï¸ Ğ’Ñ‹ Ğ¿Ğ¾Ğ³Ğ¸Ğ±Ğ»Ğ¸ Ğ¾Ñ‚ Ğ²Ñ‹Ğ±Ñ€Ğ¾ÑĞ°! ĞÑƒĞ¶Ğ½Ğ¾ Ğ±Ñ‹Ğ»Ğ¾ ÑƒĞºÑ€Ñ‹Ñ‚ÑŒÑÑ Ğ² Ğ»Ğ°Ğ³ĞµÑ€Ğµ!")
    
    emission_counter = 0
    restored_text = ", ".join(restored)
    
    # Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑĞµĞ¼ Ğ²ÑĞµÑ… Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğ¸ Ğ²Ñ‹Ğ±Ñ€Ğ¾ÑĞ°
    for uid, p in players.items():
        if uid in banned_users:
            continue
        faction = p.get("faction")
        if not faction or faction == "None":
            continue
        state = p.get("state")
        if state in [GameState.WAITING_FOR_START, GameState.READING_INSTRUCTIONS,
                     GameState.CHOOSING_FACTION, GameState.ENTERING_NICKNAME]:
            continue
        await send_message(uid, f"â˜¢ï¸ Ğ’Ñ‹Ğ±Ñ€Ğ¾Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½!\nâ™»ï¸ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹: {restored_text}")
    
    # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ Ñ‡Ğ°Ñ‚
    if dead_players and GAME_CHAT_ID:
        dead_list = "\n".join(dead_players)
        chat_msg = f"â˜¢ï¸ Ğ’Ğ«Ğ‘Ğ ĞĞ¡ Ğ—ĞĞ’Ğ•Ğ Ğ¨ĞĞ!\n\nâ˜ ï¸ ĞŸĞ¾Ğ³Ğ¸Ğ±ÑˆĞ¸Ğµ ÑÑ‚Ğ°Ğ»ĞºĞµÑ€Ñ‹:\n{dead_list}\n\nâ™»ï¸ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹: {restored_text}"
        try:
            await bot.api.messages.send(peer_id=GAME_CHAT_ID, message=chat_msg, random_id=random.randint(1, 10**9))
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ² Ğ±ĞµÑĞµĞ´Ñƒ: {e}")
    
    save_data()


# ==================== ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ Ğ£Ğ¡Ğ›ĞĞ’Ğ˜Ğ™ ====================
def check_vital_conditions(user_id: int, action: str = "Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ") -> Tuple[bool, str]:
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¶Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ´Ğ»Ñ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ"""
    p = players[user_id]
    messages = []
    
    if p["health"] <= 0:
        messages.append("ğŸ’€ Ğ’Ñ‹ Ğ² ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¸!")
        return False, "\n".join(messages)
    
    if action == "Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´":
        if p["stamina"] < 3:
            messages.append("âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ²Ñ‹Ğ½Ğ¾ÑĞ»Ğ¸Ğ²Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° (Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ 3).")
        if p["hunger"] >= 8:
            messages.append("âŒ Ğ’Ñ‹ ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ½Ñ‹ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° (Ğ³Ğ¾Ğ»Ğ¾Ğ´ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ < 8).")
        if p["backpack"].get("Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸", 0) < 2:
            messages.append("âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞµĞº Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° (Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ 2).")
    elif action == "Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ":
        if p["stamina"] <= 0:
            messages.append("ğŸ˜´ Ğ£ Ğ²Ğ°Ñ Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»Ğ°ÑÑŒ Ğ²Ñ‹Ğ½Ğ¾ÑĞ»Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ â€” Ğ¿Ğ¾Ñ€Ğ° Ğ¾Ñ‚Ğ´Ğ¾Ñ…Ğ½ÑƒÑ‚ÑŒ.")
    elif action == "Ğ¾Ñ…Ğ¾Ñ‚Ğ°":
        if p["stamina"] <= 0:
            messages.append("ğŸ˜´ Ğ£ Ğ²Ğ°Ñ Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»Ğ°ÑÑŒ Ğ²Ñ‹Ğ½Ğ¾ÑĞ»Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ â€” Ğ¿Ğ¾Ñ€Ğ° Ğ¾Ñ‚Ğ´Ğ¾Ñ…Ğ½ÑƒÑ‚ÑŒ.")
        if not p.get("weapon"):
            messages.append("âŒ ĞĞµÑ‚ Ğ¾Ñ€ÑƒĞ¶Ğ¸Ñ â€” Ğ¾Ñ…Ğ¾Ñ‚Ğ° Ğ½ĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ°.")
        elif p.get("weapon_durability", 0) <= 0:
            messages.append("ğŸ”§ Ğ’Ğ°ÑˆĞµ Ğ¾Ñ€ÑƒĞ¶Ğ¸Ğµ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ ÑĞ»Ğ¾Ğ¼Ğ°Ğ½Ğ¾ â€” ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¸Ñ‚Ğµ ĞµĞ³Ğ¾.")
    
    if messages:
        return False, "\n".join(messages)
    return True, ""


# ==================== Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞĞ˜Ğ• ĞŸĞ Ğ•Ğ”ĞœĞ•Ğ¢ĞĞ’ ====================
async def use_item(user_id: int, item_input: str, from_global: bool = False):
    """Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ğ°"""
    p = players[user_id]
    parts = item_input.strip().split()
    
    if not parts:
        keyboard = None if from_global else create_backpack_menu_keyboard()
        await send_message(user_id, "âŒ Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚.", keyboard)
        return
    
    item_name = ""
    count = 1
    
    if len(parts) >= 2:
        try:
            count = int(parts[-1])
            item_name = " ".join(parts[:-1]).lower()
        except:
            item_name = item_input.strip().lower()
    else:
        item_name = item_input.strip().lower()
    
    if item_name == "Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸":
        keyboard = None if from_global else create_backpack_menu_keyboard()
        await send_message(user_id, "âŒ Ğ‘Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸ Ğ½ĞµĞ»ÑŒĞ·Ñ ÑƒĞ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ¸Ñ‚ÑŒ.", keyboard)
        return
    
    if item_name not in ITEM_EFFECTS:
        keyboard = None if from_global else create_backpack_menu_keyboard()
        await send_message(user_id, "âŒ ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚.", keyboard)
        return
    
    backpack = p.get("backpack", {})
    if backpack.get(item_name, 0) < count:
        keyboard = None if from_global else create_backpack_menu_keyboard()
        await send_message(user_id, f"âŒ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ {count} ÑˆÑ‚. ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ğ°.", keyboard)
        return
    
    effects = ITEM_EFFECTS[item_name]
    messages = []
    
    # Ğ¡Ğ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹Ğ¹ ÑÑ„Ñ„ĞµĞºÑ‚ Ğ´Ğ»Ñ Ğ¶ĞµĞ»ÑƒĞ´Ñ
    if effects.get("random_effect"):
        for _ in range(count):
            effect_msg = apply_random_effect(user_id)
            messages.append(f"ğŸŒ° Ğ–ĞµĞ»ÑƒĞ´ÑŒ: {effect_msg}")
        backpack[item_name] -= count
        if backpack[item_name] <= 0:
            del backpack[item_name]
        normalize_stats(user_id)
        save_data()
        keyboard = None if from_global else create_backpack_menu_keyboard()
        await send_message(user_id, "\n".join(messages), keyboard)
        return
    
    # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ ÑÑ„Ñ„ĞµĞºÑ‚Ñ‹
    for attr, value in effects.items():
        total_value = value * count
        if attr == "health":
            p["health"] = min(10, p["health"] + total_value)
            if p["health"] > 0:
                p.pop("death_notified", None)
            messages.append(f"â¤ï¸ Ğ—Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ Ğ´Ğ¾ {round(p['health'], 1)}/10")
        elif attr == "radiation":
            p["radiation"] = max(0, p["radiation"] + total_value)
            messages.append(f"â˜¢ï¸ Ğ Ğ°Ğ´Ğ¸Ğ°Ñ†Ğ¸Ñ ÑĞ½Ğ¸Ğ¶ĞµĞ½Ğ° Ğ´Ğ¾ {round(p['radiation'], 1)}/10")
        elif attr == "hunger":
            p["hunger"] = max(0, p["hunger"] + total_value)
            messages.append(f"ğŸ½ï¸ Ğ“Ğ¾Ğ»Ğ¾Ğ´ ÑĞ½Ğ¸Ğ¶ĞµĞ½ Ğ´Ğ¾ {round(p['hunger'], 1)}/10")
        elif attr == "stamina":
            p["stamina"] = min(10, p["stamina"] + total_value)
            messages.append(f"âš¡ Ğ’Ñ‹Ğ½Ğ¾ÑĞ»Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° Ğ´Ğ¾ {round(p['stamina'], 1)}/10")
    
    # Ğ‘Ğ¾Ğ½ÑƒÑ Ğ¾Ñ‚ Ğ´Ğ¾Ğ½Ğ°Ñ‚Ğ°
    if has_active_donation(user_id) and item_name not in DONATION_EXCLUDED_ITEMS:
        donation_art = get_donation_artifact(user_id)
        belt = p.get("belt", [None, None, None])
        if donation_art in belt or backpack.get(donation_art, 0) > 0:
            if donation_art == "ĞŸĞ¾Ğ½Ñ‡Ğ¸Ğº":
                heal_bonus = 0.5 * count
                p["health"] = min(10, p["health"] + heal_bonus)
                messages.append(f"ğŸ© ĞŸĞ¾Ğ½Ñ‡Ğ¸Ğº: +{heal_bonus}â¤ï¸")
            elif donation_art == "Ğ¡Ñ‚ĞµĞ¹Ğº":
                hunger_bonus = 0.5 * count
                p["hunger"] = max(0, p["hunger"] - hunger_bonus)
                messages.append(f"ğŸ¥© Ğ¡Ñ‚ĞµĞ¹Ğº: -{hunger_bonus}ğŸ½ï¸")
    
    if not messages:
        messages.append(f"âœ… Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¾: {item_name} x{count}")
    
    backpack[item_name] -= count
    if backpack[item_name] <= 0:
        del backpack[item_name]
    
    normalize_stats(user_id)
    save_data()
    
    keyboard = None if from_global else create_backpack_menu_keyboard()
    await send_message(user_id, "\n".join(messages), keyboard)


def apply_random_effect(user_id: int) -> str:
    """ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ğ¾Ğ³Ğ¾ ÑÑ„Ñ„ĞµĞºÑ‚Ğ° (Ğ¶ĞµĞ»ÑƒĞ´ÑŒ)"""
    p = players[user_id]
    effects = [
        ("health", 0.5, "â¤ï¸ +0.5 Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒÑ"),
        ("health", -0.5, "ğŸ’” -0.5 Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒÑ"),
        ("radiation", 0.5, "â˜¢ï¸ +0.5 Ñ€Ğ°Ğ´Ğ¸Ğ°Ñ†Ğ¸Ğ¸"),
        ("radiation", -0.5, "â˜¢ï¸ -0.5 Ñ€Ğ°Ğ´Ğ¸Ğ°Ñ†Ğ¸Ğ¸"),
        ("hunger", 0.5, "ğŸ½ï¸ +0.5 Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ°"),
        ("hunger", -0.5, "ğŸ½ï¸ -0.5 Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ°"),
        ("stamina", 0.5, "âš¡ +0.5 Ğ²Ñ‹Ğ½Ğ¾ÑĞ»Ğ¸Ğ²Ğ¾ÑÑ‚Ğ¸"),
        ("stamina", -0.5, "âš¡ -0.5 Ğ²Ñ‹Ğ½Ğ¾ÑĞ»Ğ¸Ğ²Ğ¾ÑÑ‚Ğ¸"),
    ]
    
    attr, value, msg = random.choice(effects)
    
    if attr == "health":
        p["health"] = max(0, min(10, p["health"] + value))
    elif attr == "radiation":
        p["radiation"] = max(0, min(10, p["radiation"] + value))
    elif attr == "hunger":
        p["hunger"] = max(0, min(10, p["hunger"] + value))
    elif attr == "stamina":
        p["stamina"] = max(0, min(10, p["stamina"] + value))
    
    save_data()
    return msg


# ==================== Ğ˜Ğ¡Ğ¡Ğ›Ğ•Ğ”ĞĞ’ĞĞĞ˜Ğ• ====================
async def handle_exploration(user_id: int):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"""
    p = players[user_id]
    point = p["point"]
    location = p["location"]
    ptype = POINT_TYPES.get(point, "Ğ¢ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ")
    
    if not is_player_on_own_territory(user_id):
        await send_message(user_id, "âŒ Ğ­Ñ‚Ğ° Ñ‚ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ Ğ½Ğµ Ğ¿Ñ€Ğ¸Ğ½Ğ°Ğ´Ğ»ĞµĞ¶Ğ¸Ñ‚ Ğ²Ğ°ÑˆĞµĞ¹ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞµ.", 
                          create_main_menu_keyboard(user_id))
        return
    
    if not check_territory_exhaustion(location, point):
        await send_message(user_id, "âŒ Ğ­Ñ‚Ğ° Ñ‚ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸ÑÑ‚Ğ¾Ñ‰ĞµĞ½Ğ°. Ğ”Ğ¾Ğ¶Ğ´Ğ¸Ñ‚ĞµÑÑŒ Ğ²Ñ‹Ğ±Ñ€Ğ¾ÑĞ°.", 
                          create_main_menu_keyboard(user_id))
        return
    
    # ĞĞ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ·Ğ¾Ğ½Ğ°
    if ptype == "ĞĞ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ·Ğ¾Ğ½Ğ°":
        if p["health"] <= 0:
            await send_message(user_id, "ğŸ’€ Ğ’Ñ‹ Ğ² ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¸!", create_main_menu_keyboard(user_id))
            return
        if not p.get("detector"):
            await send_message(user_id, "âŒ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ´ĞµÑ‚ĞµĞºÑ‚Ğ¾Ñ€Ğ°.", create_main_menu_keyboard(user_id))
            return
        if p.get("detector_charge", 0) <= 0:
            await send_message(user_id, "ğŸ”‹ Ğ”ĞµÑ‚ĞµĞºÑ‚Ğ¾Ñ€ Ñ€Ğ°Ğ·Ñ€ÑĞ¶ĞµĞ½.", create_main_menu_keyboard(user_id))
            return
        if p["stamina"] <= 0:
            await send_message(user_id, "ğŸ˜´ ĞĞµÑ‚ Ğ²Ñ‹Ğ½Ğ¾ÑĞ»Ğ¸Ğ²Ğ¾ÑÑ‚Ğ¸.", create_main_menu_keyboard(user_id))
            return
        
        add_territory_exhaustion(location, point)
        await increment_emission()
        
        p["stamina"] = max(0, p["stamina"] - 1)
        p["hunger"] = min(10, p["hunger"] + 0.5)
        
        # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ·Ğ¾Ğ½Ñ‹
        await init_anomaly_exploration(user_id)
        return
    
    # Ğ›Ğ¾Ğ³Ğ¾Ğ²Ğ¾ (Ğ¾Ñ…Ğ¾Ñ‚Ğ°)
    if ptype == "Ğ›Ğ¾Ğ³Ğ¾Ğ²Ğ¾":
        if p["health"] <= 0:
            await send_message(user_id, "ğŸ’€ Ğ’Ñ‹ Ğ² ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¸!", create_main_menu_keyboard(user_id))
            return
        if not p.get("weapon"):
            await send_message(user_id, "âŒ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ¾Ñ€ÑƒĞ¶Ğ¸Ñ.", create_main_menu_keyboard(user_id))
            return
        if p.get("weapon_durability", 0) <= 0:
            await send_message(user_id, "ğŸ”§ ĞÑ€ÑƒĞ¶Ğ¸Ğµ ÑĞ»Ğ¾Ğ¼Ğ°Ğ½Ğ¾.", create_main_menu_keyboard(user_id))
            return
        if p["stamina"] <= 0:
            await send_message(user_id, "ğŸ˜´ ĞĞµÑ‚ Ğ²Ñ‹Ğ½Ğ¾ÑĞ»Ğ¸Ğ²Ğ¾ÑÑ‚Ğ¸.", create_main_menu_keyboard(user_id))
            return
        
        add_territory_exhaustion(location, point)
        await increment_emission()
        
        p["stamina"] = max(0, p["stamina"] - 1)
        p["hunger"] = min(10, p["hunger"] + 0.5)
        apply_belt_effects_on_exploration(user_id)
        
        # Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¼ÑƒÑ‚Ğ°Ğ½Ñ‚Ğ°
        mutant = select_mutant(location, point)
        if not mutant:
            await send_message(user_id, "âŒ Ğ’ ÑÑ‚Ğ¾Ğ¼ Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğµ Ğ¿ÑƒÑÑ‚Ğ¾...", create_main_menu_keyboard(user_id))
            return
        
        p["current_mutant"] = mutant
        p["mutant_hp"] = mutant["hp"]
        
        weapon_accuracy = get_total_weapon_accuracy(user_id)
        all_buttons = list(range(1, 10))
        if weapon_accuracy > 0:
            valid_targets = random.sample(all_buttons, min(weapon_accuracy, 9))
        else:
            valid_targets = []
        p["valid_targets"] = valid_targets
        p["state"] = GameState.HUNTING
        save_data()
        
        msg = f"""ğŸ‘¹ Ğ’ÑÑ‚Ñ€ĞµÑ‡ĞµĞ½ Ğ¼ÑƒÑ‚Ğ°Ğ½Ñ‚: {mutant['name']}
Ğ¥ĞŸ Ğ¼ÑƒÑ‚Ğ°Ğ½Ñ‚Ğ°: {mutant['hp']}/{mutant['hp']}
ğŸ’¢ Ğ£Ñ€Ğ¾Ğ½ Ğ¼ÑƒÑ‚Ğ°Ğ½Ñ‚Ğ°: {mutant['damage']}
ğŸ’² ĞĞ°Ğ³Ñ€Ğ°Ğ´Ğ°: {mutant['reward']}Ñ€

â¤ï¸ Ğ’Ğ°ÑˆĞµ Ğ¥ĞŸ: {p['health']}/10
ğŸ’¢ Ğ’Ğ°Ñˆ ÑƒÑ€Ğ¾Ğ½: {get_total_weapon_damage(user_id)}
ğŸ¯ Ğ¢Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ: {weapon_accuracy}/9"""
        
        await send_message(user_id, msg, create_hunting_keyboard())
        return
    
    # ĞĞ±Ñ‹Ñ‡Ğ½Ğ¾Ğµ Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
    ok, msg = check_vital_conditions(user_id, "Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ")
    if not ok:
        await send_message(user_id, msg, create_main_menu_keyboard(user_id))
        return
    
    add_territory_exhaustion(location, point)
    await increment_emission()
    
    p["stamina"] = max(0, p["stamina"] - 1)
    p["hunger"] = min(10, p["hunger"] + 0.5)
    
    radiation_gain = get_radiation_gain(ptype)
    result_lines = []
    
    if radiation_gain > 0:
        p["radiation"] = min(10, p["radiation"] + radiation_gain)
        result_lines.append(f"â˜¢ï¸ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾ Ğ¾Ğ±Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ! (+{radiation_gain})")
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ³Ğ¾Ğ»Ğ¾Ğ´ Ğ¸ Ñ€Ğ°Ğ´Ğ¸Ğ°Ñ†Ğ¸Ñ
    if p["hunger"] >= 10:
        p["stamina"] = max(0, p["stamina"] - 2)
        p["health"] = max(0, p["health"] - 0.5)
        result_lines.append("ğŸ½ï¸ Ğ’Ñ‹ Ğ³Ğ¾Ğ»Ğ¾Ğ´Ğ°ĞµÑ‚Ğµ! (-2âš¡, -0.5â¤ï¸)")
    
    if p["radiation"] >= 10:
        rad_damage = random.choice([1, 1.5, 2])
        p["health"] = max(0, p["health"] - rad_damage)
        result_lines.append(f"â˜¢ï¸ Ğ Ğ°Ğ´Ğ¸Ğ°Ñ†Ğ¸Ñ Ñ€Ğ°Ğ·ÑŠĞµĞ´Ğ°ĞµÑ‚ Ğ²Ğ°Ñ! (-{rad_damage}â¤ï¸)")
    
    apply_belt_effects_on_exploration(user_id)
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑĞ¼ĞµÑ€Ñ‚ÑŒ
    if p["health"] <= 0:
        death_msg = "\n".join(result_lines) + "\n\nğŸ’€ Ğ’Ñ‹ Ğ¿Ğ¾Ğ³Ğ¸Ğ±Ğ»Ğ¸ Ğ¾Ñ‚ Ğ¸ÑÑ‚Ğ¾Ñ‰ĞµĞ½Ğ¸Ñ!"
        lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=5, max_money=50)
        loss_lines = format_death_losses(lost_items, money_lost)
        if loss_lines:
            death_msg += "\n" + "\n".join(loss_lines)
        p["death_notified"] = True
        p["state"] = GameState.IN_MENU
        normalize_stats(user_id)
        save_data()
        await send_message(user_id, death_msg, create_main_menu_keyboard(user_id))
        return
    
    # Ğ”Ñ€Ğ¾Ğ¿
    drops = {}
    if ptype == "Ğ¢ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ":
        drops = roll_drops(DROP_T, "Ğ¢ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ")
        if location == "ĞŸĞ¾Ğ»ÑĞ½Ğ°" and point.startswith("Ğ¢"):
            for item, data in DROP_POLYANA_T.items():
                if random.randint(1, 100) <= data["chance"]:
                    amount = random.randint(data["min"], data["max"])
                    drops[item] = drops.get(item, 0) + amount
    elif ptype == "Ğ¢Ğ¾Ñ‡ĞºĞ° Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²":
        drops = roll_drops(DROP_TR, "Ğ¢Ğ¾Ñ‡ĞºĞ° Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²")
    elif ptype == "Ğ‘Ğ°Ğ·Ğ°":
        drops = roll_drops(DROP_B, "Ğ‘Ğ°Ğ·Ğ°")
    
    for item, amount in drops.items():
        if item == "Ğ”ĞµĞ½ÑŒĞ³Ğ¸":
            p["money"] = p.get("money", 0) + amount
            result_lines.append(f"ğŸ’² ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾: {amount}Ñ€")
        else:
            p["backpack"][item] = p["backpack"].get(item, 0) + amount
            result_lines.append(f"ğŸ“¦ ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾: {item} x{amount}")
    
    if not drops and not result_lines:
        result_lines.append("ğŸ” Ğ’Ğ°Ğ¼ Ğ½Ğµ Ğ²Ñ‹Ğ¿Ğ°Ğ»Ğ¾ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾.")
    
    save_data()
    await send_message(user_id, "\n".join(result_lines), create_main_menu_keyboard(user_id))


# ==================== ĞĞĞĞœĞĞ›Ğ¬ĞĞ«Ğ• Ğ—ĞĞĞ« ====================
async def init_anomaly_exploration(user_id: int):
    """Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ·Ğ¾Ğ½Ñ‹"""
    p = players[user_id]
    location = p["location"]
    point = p["point"]
    atype = ANOMALY_ZONES.get(location, {}).get(point, "Ğ³Ñ€Ğ°Ğ²Ğ¸")
    
    p["current_anomaly_type"] = atype
    p["state"] = GameState.ANOMALY_EXPLORE
    
    # 70% ÑˆĞ°Ğ½Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ¿ÑƒÑ‚Ğ¸
    if random.randint(1, 100) <= 70:
        safe_path = random.randint(1, 3)
        p["anomaly_safe_path"] = safe_path
        p["anomaly_path_choosing"] = True
        save_data()
        
        msg = f"""ğŸŒ€ Ğ’Ñ‹ Ğ¿Ğ¾Ğ´Ğ¾ÑˆĞ»Ğ¸ Ğº Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ·Ğ¾Ğ½Ğµ ({atype})
âš ï¸ Ğ’Ğ¿ĞµÑ€ĞµĞ´Ğ¸ Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğ¹ ÑƒÑ‡Ğ°ÑÑ‚Ğ¾Ğº! Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿ÑƒÑ‚ÑŒ:

ğŸŒ€ Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ¸Ğ½ Ğ¿ÑƒÑ‚ÑŒ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞµĞ½..."""
        await send_message(user_id, msg, create_anomaly_path_keyboard())
    else:
        p["anomaly_path_choosing"] = False
        p["anomaly_safe_path"] = None
        start_anomaly_map(user_id)
        save_data()
        
        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ°Ñ€Ñ‚Ñƒ
        try:
            img_buffer = generate_anomaly_map_image(user_id)
            alerts = get_detector_alerts(user_id)
            msg = f"ğŸŒ€ Ğ’Ñ‹ Ğ²Ğ¾ÑˆĞ»Ğ¸ Ğ² Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ·Ğ¾Ğ½Ñƒ ({atype})\nĞ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ñ."
            if alerts:
                msg += f"\n{alerts}"
            await send_photo_with_message(user_id, img_buffer, msg, create_anomaly_movement_keyboard())
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ ĞºĞ°Ñ€Ñ‚Ñ‹: {e}")
            await send_message(user_id, "ğŸŒ€ Ğ’Ñ‹ Ğ²Ğ¾ÑˆĞ»Ğ¸ Ğ² Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ·Ğ¾Ğ½Ñƒ.", create_anomaly_movement_keyboard())


def start_anomaly_map(user_id: int):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ·Ğ¾Ğ½Ñ‹"""
    p = players[user_id]
    
    player_start = (random.randint(0, 5), random.randint(0, 5))
    p["player_pos"] = player_start
    
    num_artifacts = random.randint(1, 3)
    num_anomalies = random.randint(3, 6)
    num_hidden_anomalies = random.randint(0, 2)
    
    occupied = {player_start}
    
    artifact_positions = []
    for _ in range(num_artifacts):
        for _ in range(50):
            pos = (random.randint(0, 5), random.randint(0, 5))
            if pos not in occupied:
                artifact_positions.append(pos)
                occupied.add(pos)
                break
    
    anomaly_positions = []
    for _ in range(num_anomalies):
        for _ in range(50):
            pos = (random.randint(0, 5), random.randint(0, 5))
            if pos not in occupied:
                anomaly_positions.append(pos)
                occupied.add(pos)
                break
    
    hidden_anomaly_positions = []
    for _ in range(num_hidden_anomalies):
        for _ in range(50):
            pos = (random.randint(0, 5), random.randint(0, 5))
            if pos not in occupied:
                hidden_anomaly_positions.append(pos)
                occupied.add(pos)
                break
    
    p["artifact_positions"] = artifact_positions
    p["anomaly_positions"] = anomaly_positions
    p["hidden_anomaly_positions"] = hidden_anomaly_positions
    p["anomaly_path_choosing"] = False
    p["anomaly_safe_path"] = None


def get_detector_alerts(user_id: int) -> str:
    """ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğ¹ Ğ´ĞµÑ‚ĞµĞºÑ‚Ğ¾Ñ€Ğ°"""
    p = players[user_id]
    detector = p.get("detector", None)
    px, py = p.get("player_pos", (0, 0))
    artifact_positions = [tuple(pos) for pos in p.get("artifact_positions", [])]
    anomaly_positions = [tuple(pos) for pos in p.get("anomaly_positions", [])]
    
    alerts = []
    
    if detector in ["ĞœĞµĞ´Ğ²ĞµĞ´ÑŒ", "Ğ’ĞµĞ»ĞµÑ", "Ğ¡Ğ²Ğ°Ñ€Ğ¾Ğ³"]:
        anomaly_dirs = []
        for ax, ay in anomaly_positions:
            if abs(ax - px) <= 1 and abs(ay - py) <= 1 and (ax, ay) != (px, py):
                direction = ""
                if ay < py:
                    direction += "â¬†ï¸"
                if ay > py:
                    direction += "â¬‡ï¸"
                if ax < px:
                    direction += "â¬…ï¸"
                if ax > px:
                    direction += "â¡ï¸"
                if direction and direction not in anomaly_dirs:
                    anomaly_dirs.append(direction)
        if anomaly_dirs:
            alerts.append("ğŸš¨" + "|".join(anomaly_dirs))
    
    if detector == "ĞÑ‚ĞºĞ»Ğ¸Ğº":
        for ax, ay in artifact_positions:
            if abs(ax - px) <= 1 and abs(ay - py) <= 1 and (ax, ay) != (px, py):
                alerts.append("âœ´ï¸âœ´ï¸âœ´ï¸")
                break
    elif detector == "ĞœĞµĞ´Ğ²ĞµĞ´ÑŒ":
        for ax, ay in artifact_positions:
            dist = max(abs(ax - px), abs(ay - py))
            if dist == 1:
                alerts.append("âœ´ï¸âœ´ï¸âœ´ï¸")
                break
            elif dist == 2:
                alerts.append("âœ´ï¸âœ´ï¸")
                break
    
    return " ".join(alerts)


async def handle_anomaly_move(user_id: int, direction: str):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ñ Ğ² Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ·Ğ¾Ğ½Ğµ"""
    p = players[user_id]
    px, py = p.get("player_pos", (0, 0))
    
    # ĞŸĞµÑ€ĞµĞ¼ĞµÑ‰ĞµĞ½Ğ¸Ğµ
    if direction == "â¬†ï¸" and py > 0:
        py -= 1
    elif direction == "â¬‡ï¸" and py < 5:
        py += 1
    elif direction == "â¬…ï¸" and px > 0:
        px -= 1
    elif direction == "â¡ï¸" and px < 5:
        px += 1
    else:
        await send_message(user_id, "âŒ ĞĞµĞ»ÑŒĞ·Ñ Ğ´Ğ²Ğ¸Ğ³Ğ°Ñ‚ÑŒÑÑ Ğ² ÑÑ‚Ğ¾Ğ¼ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸.", create_anomaly_movement_keyboard())
        return
    
    p["player_pos"] = (px, py)
    messages = []
    
    artifact_positions = [tuple(pos) for pos in p.get("artifact_positions", [])]
    anomaly_positions = [tuple(pos) for pos in p.get("anomaly_positions", [])]
    hidden_anomaly_positions = [tuple(pos) for pos in p.get("hidden_anomaly_positions", [])]
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚
    if (px, py) in artifact_positions:
        atype = p.get("current_anomaly_type", "Ğ³Ñ€Ğ°Ğ²Ğ¸")
        found_artifact = get_random_artifact_by_rarity(atype)
        p["backpack"][found_artifact] = p["backpack"].get(found_artifact, 0) + 1
        artifact_positions.remove((px, py))
        p["artifact_positions"] = artifact_positions
        
        detector = p.get("detector", "ĞÑ‚ĞºĞ»Ğ¸Ğº")
        charge_cost = {"Ğ’ĞµĞ»ĞµÑ": 2, "Ğ¡Ğ²Ğ°Ñ€Ğ¾Ğ³": 3}.get(detector, 1)
        p["detector_charge"] = max(0, p.get("detector_charge", 0) - charge_cost)
        
        messages.append(f"ğŸŒ• Ğ’Ñ‹ Ğ½Ğ°ÑˆĞ»Ğ¸ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚: {found_artifact}!")
        messages.append(f"ğŸ“Ÿ Ğ”ĞµÑ‚ĞµĞºÑ‚Ğ¾Ñ€ Ñ€Ğ°Ğ·Ñ€ÑĞ´Ğ¸Ğ»ÑÑ Ğ½Ğ° {charge_cost} Ğ·Ğ°Ñ€ÑĞ´(Ğ°).")
        
        if not artifact_positions:
            messages.append("âœ… Ğ’ÑĞµ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹ Ğ² ÑÑ‚Ğ¾Ğ¹ Ğ·Ğ¾Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹!")
            p["state"] = GameState.IN_MENU
            save_data()
            await send_message(user_id, "\n".join(messages), create_main_menu_keyboard(user_id))
            return
        
        min_charge = {"Ğ’ĞµĞ»ĞµÑ": 2, "Ğ¡Ğ²Ğ°Ñ€Ğ¾Ğ³": 3}.get(detector, 1)
        if p["detector_charge"] < min_charge:
            messages.append(f"ğŸ”‹ Ğ—Ğ°Ñ€ÑĞ´Ğ° Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½Ğ¸Ñ!")
            p["state"] = GameState.IN_MENU
            save_data()
            await send_message(user_id, "\n".join(messages), create_main_menu_keyboard(user_id))
            return
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ğ¸
    if (px, py) in hidden_anomaly_positions:
        atype = p.get("current_anomaly_type", "Ğ³Ñ€Ğ°Ğ²Ğ¸")
        min_dmg, max_dmg = ANOMALY_DAMAGE[atype]
        raw_damage = round(random.uniform(min_dmg, max_dmg), 1)
        anomaly_resist = get_total_anomaly_resist(user_id)
        actual_damage = max(0, round(raw_damage - anomaly_resist, 1))
        p["health"] = max(0, p["health"] - actual_damage)
        messages.append(f"ğŸ’¥ Ğ¡ĞºÑ€Ñ‹Ñ‚Ğ°Ñ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ñ! Ğ£Ñ€Ğ¾Ğ½: {actual_damage} (â¤ï¸ {p['health']}/10)")
        hidden_anomaly_positions.remove((px, py))
        p["hidden_anomaly_positions"] = hidden_anomaly_positions
        
        if random.randint(1, 100) <= 25 and p.get("armor"):
            p["armor_durability"] = max(0, p["armor_durability"] - 1)
            messages.append("ğŸ”§ Ğ‘Ñ€Ğ¾Ğ½Ñ Ğ¿Ğ¾Ğ²Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ° (-1)!")
        
        if p["health"] <= 0:
            messages.append("ğŸ’€ Ğ’Ñ‹ Ğ¿Ğ¾Ğ³Ğ¸Ğ±Ğ»Ğ¸ Ğ² Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ğ¸!")
            lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=5, max_money=50)
            messages.extend(format_death_losses(lost_items, money_lost))
            p["state"] = GameState.IN_MENU
            p["death_notified"] = True
            normalize_stats(user_id)
            save_data()
            await send_message(user_id, "\n".join(messages), create_main_menu_keyboard(user_id))
            return
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğµ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ğ¸
    if (px, py) in anomaly_positions:
        atype = p.get("current_anomaly_type", "Ğ³Ñ€Ğ°Ğ²Ğ¸")
        min_dmg, max_dmg = ANOMALY_DAMAGE[atype]
        raw_damage = round(random.uniform(min_dmg, max_dmg), 1)
        anomaly_resist = get_total_anomaly_resist(user_id)
        actual_damage = max(0, round(raw_damage - anomaly_resist, 1))
        p["health"] = max(0, p["health"] - actual_damage)
        messages.append(f"ğŸ’¥ ĞĞ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ñ! Ğ£Ñ€Ğ¾Ğ½: {actual_damage} (â¤ï¸ {p['health']}/10)")
        
        if random.randint(1, 100) <= 25 and p.get("armor"):
            p["armor_durability"] = max(0, p["armor_durability"] - 1)
            messages.append("ğŸ”§ Ğ‘Ñ€Ğ¾Ğ½Ñ Ğ¿Ğ¾Ğ²Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ° (-1)!")
        
        if p["health"] <= 0:
            messages.append("ğŸ’€ Ğ’Ñ‹ Ğ¿Ğ¾Ğ³Ğ¸Ğ±Ğ»Ğ¸ Ğ² Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ğ¸!")
            lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=5, max_money=50)
            messages.extend(format_death_losses(lost_items, money_lost))
            p["state"] = GameState.IN_MENU
            p["death_notified"] = True
            normalize_stats(user_id)
            save_data()
            await send_message(user_id, "\n".join(messages), create_main_menu_keyboard(user_id))
            return
    
    alerts = get_detector_alerts(user_id)
    if alerts:
        messages.append(alerts)
    
    save_data()
    
    # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½Ğ½ÑƒÑ ĞºĞ°Ñ€Ñ‚Ñƒ
    try:
        img_buffer = generate_anomaly_map_image(user_id)
        msg = "\n".join(messages) if messages else "Ğ’Ñ‹ Ğ¿ĞµÑ€ĞµĞ¼ĞµÑÑ‚Ğ¸Ğ»Ğ¸ÑÑŒ."
        await send_photo_with_message(user_id, img_buffer, msg, create_anomaly_movement_keyboard())
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ ĞºĞ°Ñ€Ñ‚Ñ‹: {e}")
        await send_message(user_id, "\n".join(messages) if messages else "Ğ’Ñ‹ Ğ¿ĞµÑ€ĞµĞ¼ĞµÑÑ‚Ğ¸Ğ»Ğ¸ÑÑŒ.", 
                          create_anomaly_movement_keyboard())


# ==================== ĞĞ¥ĞĞ¢Ğ ====================
async def handle_shooting(user_id: int):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑÑ‚Ñ€ĞµĞ»ÑŒĞ±Ñ‹"""
    p = players[user_id]
    mutant = p.get("current_mutant")
    
    if not mutant or p.get("mutant_hp", 0) <= 0:
        await send_message(user_id, "ĞœÑƒÑ‚Ğ°Ğ½Ñ‚ ÑƒĞ¶Ğµ Ğ¼Ñ‘Ñ€Ñ‚Ğ².", create_main_menu_keyboard(user_id))
        p["state"] = GameState.IN_MENU
        save_data()
        return
    
    if p.get("weapon_durability", 0) <= 0:
        msg = f"""ğŸ”§ ĞÑ€ÑƒĞ¶Ğ¸Ğµ ÑĞ»Ğ¾Ğ¼Ğ°Ğ½Ğ¾! Ğ¡Ñ‚Ñ€ĞµĞ»ÑÑ‚ÑŒ Ğ½ĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾.
Ğ•Ğ´Ğ¸Ğ½ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ñ…Ğ¾Ğ´ â€” ğŸƒ ĞŸĞ¾Ğ±ĞµĞ³

ğŸ‘¹ {mutant['name']}
Ğ¥ĞŸ: {p.get('mutant_hp', 0)}/{mutant['hp']}"""
        p["state"] = GameState.HUNTING
        save_data()
        await send_message(user_id, msg, create_hunting_keyboard())
        return
    
    shot_button = p.get("shot_button", 0)
    valid_shots = set(p.get("valid_targets", []))
    messages = []
    
    weapon_damage = get_total_weapon_damage(user_id)
    weapon_name = p.get("weapon", "")
    special = SPECIAL_WEAPONS.get(weapon_name, {})
    mutant_bonus = special.get("mutant_bonus", 0)
    total_damage = weapon_damage + mutant_bonus
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ğ¾Ğ¿Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ
    if shot_button not in valid_shots:
        messages.append("ğŸ’¨ Ğ’Ñ‹ Ğ¿Ñ€Ğ¾Ğ¼Ğ°Ñ…Ğ½ÑƒĞ»Ğ¸ÑÑŒ!")
    else:
        if random.randint(1, 100) <= 10:
            messages.append("ğŸ‘¹ ĞœÑƒÑ‚Ğ°Ğ½Ñ‚ ÑƒĞ²ĞµÑ€Ğ½ÑƒĞ»ÑÑ!")
        else:
            p["mutant_hp"] = max(0, p["mutant_hp"] - total_damage)
            messages.append(f"ğŸ’¥ ĞŸĞ¾Ğ¿Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ! Ğ£Ñ€Ğ¾Ğ½: {total_damage}")
            
            if p["mutant_hp"] <= 0:
                reward = mutant["reward"]
                p["money"] += reward
                messages.append(f"â˜ ï¸ ĞœÑƒÑ‚Ğ°Ğ½Ñ‚ ÑƒĞ±Ğ¸Ñ‚! +{reward}Ñ€")
                
                radiation_reduce = special.get("radiation_reduce", 0)
                if radiation_reduce > 0:
                    p["radiation"] = max(0, p["radiation"] - radiation_reduce)
                    messages.append(f"â˜¢ï¸ Ğ Ğ°Ğ´Ğ¸Ğ°Ñ†Ğ¸Ñ -{radiation_reduce}")
                
                p["state"] = GameState.IN_MENU
                p.pop("current_mutant", None)
                p.pop("mutant_hp", None)
                p.pop("valid_targets", None)
                save_data()
                await send_message(user_id, "\n".join(messages), create_main_menu_keyboard(user_id))
                return
    
    # ĞÑ‚Ğ²ĞµÑ‚Ğ½Ğ°Ñ Ğ°Ñ‚Ğ°ĞºĞ° Ğ¼ÑƒÑ‚Ğ°Ğ½Ñ‚Ğ°
    if random.randint(1, 100) <= 10:
        messages.append("ğŸ›¡ï¸ Ğ’Ñ‹ ÑƒĞºĞ»Ğ¾Ğ½Ğ¸Ğ»Ğ¸ÑÑŒ!")
    else:
        raw_damage = mutant["damage"]
        blast_resist = get_total_blast_resist(user_id)
        actual_damage = max(0, round(raw_damage - blast_resist, 1))
        
        if actual_damage <= 0:
            messages.append("ğŸ›¡ï¸ Ğ‘Ñ€Ğ¾Ğ½Ñ Ğ¿Ğ¾Ğ³Ğ»Ğ¾Ñ‚Ğ¸Ğ»Ğ° ÑƒÑ€Ğ¾Ğ½!")
        else:
            p["health"] = max(0, p["health"] - actual_damage)
            messages.append(f"ğŸ’” ĞœÑƒÑ‚Ğ°Ğ½Ñ‚ Ğ½Ğ°Ğ½Ñ‘Ñ {actual_damage} ÑƒÑ€Ğ¾Ğ½Ğ°!")
            
            if p["health"] <= 0:
                messages.append(f"\nğŸ’€ Ğ’Ñ‹ Ğ¿Ğ¾Ğ³Ğ¸Ğ±Ğ»Ğ¸ Ğ² Ğ±Ğ¾Ñ Ñ {mutant['name']}!")
                lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=5, max_money=50)
                messages.extend(format_death_losses(lost_items, money_lost))
                p["state"] = GameState.IN_MENU
                p["death_notified"] = True
                p.pop("current_mutant", None)
                p.pop("mutant_hp", None)
                p.pop("valid_targets", None)
                normalize_stats(user_id)
                save_data()
                await send_message(user_id, "\n".join(messages), create_main_menu_keyboard(user_id))
                return
    
    # ĞŸĞ¾Ğ²Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ ÑĞ½Ğ°Ñ€ÑĞ¶ĞµĞ½Ğ¸Ñ
    if random.randint(1, 100) <= 25:
        equip_to_damage = []
        if p.get("weapon"):
            equip_to_damage.append("weapon")
        if p.get("armor"):
            equip_to_damage.append("armor")
        if equip_to_damage:
            target = random.choice(equip_to_damage)
            if target == "weapon":
                p["weapon_durability"] = max(0, p["weapon_durability"] - 0.5)
                messages.append("ğŸ”§ ĞÑ€ÑƒĞ¶Ğ¸Ğµ Ğ¿Ğ¾Ğ²Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¾ (-0.5)!")
            else:
                p["armor_durability"] = max(0, p["armor_durability"] - 0.5)
                messages.append("ğŸ”§ Ğ‘Ñ€Ğ¾Ğ½Ñ Ğ¿Ğ¾Ğ²Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ° (-0.5)!")
    
    # Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ±Ğ¾Ğµ
    battle_info = f"""
ğŸ‘¹ {mutant['name']}
Ğ¥ĞŸ: {p.get('mutant_hp', 0)}/{mutant['hp']}
ğŸ’¢ Ğ£Ñ€Ğ¾Ğ½ Ğ¼ÑƒÑ‚Ğ°Ğ½Ñ‚Ğ°: {mutant['damage']}

â¤ï¸ Ğ’Ğ°ÑˆĞµ Ğ¥ĞŸ: {p['health']}/10
ğŸ’¢ Ğ’Ğ°Ñˆ ÑƒÑ€Ğ¾Ğ½: {total_damage}
ğŸ¯ Ğ¢Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ: {get_total_weapon_accuracy(user_id)}/9"""
    
    messages.append(battle_info)
    p["state"] = GameState.HUNTING
    save_data()
    await send_message(user_id, "\n".join(messages), create_hunting_keyboard())


async def handle_hunting_escape(user_id: int):
    """ĞŸĞ¾Ğ±ĞµĞ³ Ñ Ğ¾Ñ…Ğ¾Ñ‚Ñ‹"""
    p = players[user_id]
    lost_items, money_lost = calculate_and_apply_death_losses(user_id, max_items=5, max_money=50)
    
    msg_lines = ["ğŸ’¨ Ğ’Ñ‹ ÑĞ±ĞµĞ¶Ğ°Ğ»Ğ¸ Ñ Ğ¾Ñ…Ğ¾Ñ‚Ñ‹!"]
    msg_lines.extend(format_death_losses(lost_items, money_lost))
    
    await send_message(user_id, "\n".join(msg_lines), create_main_menu_keyboard(user_id))
    
    p["state"] = GameState.IN_MENU
    p.pop("current_mutant", None)
    p.pop("mutant_hp", None)
    save_data()


# ==================== Ğ“Ğ›ĞĞ‘ĞĞ›Ğ¬ĞĞ«Ğ• ĞšĞĞœĞĞĞ”Ğ« ====================
async def handle_global_commands(user_id: int, text: str) -> bool:
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´"""
    text_original = text.strip()
    text = text_original.lower()
    words = text.split()
    
    if user_id in banned_users and not is_admin(user_id):
        return True
    
    # ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ¸Ğ½Ñ„Ğ¾
    if text == "Ğ¸Ğ½Ñ„Ğ¾":
        await send_message(user_id, format_camp_info(user_id))
        return True
    
    # ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° 2604 - Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ² Ğ¼ĞµĞ½Ñ
    if text == "2604":
        current_state = players.get(user_id, {}).get("state")
        if current_state in [GameState.TRANSITION_WAIT, GameState.HUNTING, GameState.HUNTING_SHOOTING]:
            await send_message(user_id, "âŒ ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° ÑĞµĞ¹Ñ‡Ğ°Ñ.")
        elif user_id in players:
            players[user_id]["state"] = GameState.IN_MENU
            save_data()
            await send_message(user_id, "âœ… Ğ’Ñ‹ Ğ²ĞµÑ€Ğ½ÑƒĞ»Ğ¸ÑÑŒ Ğ² Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ.", create_main_menu_keyboard(user_id))
        else:
            await send_message(user_id, "âŒ Ğ’Ñ‹ Ğ½Ğµ Ğ² Ğ¸Ğ³Ñ€Ğµ.")
        return True
    
    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ğ°
    if words and words[0] in ["Ğ¸ÑĞ¿", "Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ"] and len(words) >= 2:
        item_part = " ".join(words[1:])
        await use_item(user_id, item_part, from_global=True)
        return True
    
    # ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ
    if text == "Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ":
        await send_message(user_id, GAME_INFO_TEXT)
        return True
    
    # ĞĞ´Ğ¼Ğ¸Ğ½ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹
    if text == "/Ğ±Ğ¾Ğ³" and is_admin(user_id):
        p = players[user_id]
        p["money"] += 1000
        p["health"] = 10
        p["radiation"] = 0
        p["hunger"] = 0
        p["stamina"] = 10
        save_data()
        await send_message(user_id, "âœ… +1000Ñ€, Ğ²ÑĞµ Ñ…Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹.")
        return True
    
    return False


# ==================== Ğ¤ĞĞĞĞ’Ğ«Ğ• Ğ—ĞĞ”ĞĞ§Ğ˜ ====================
async def background_checker():
    """Ğ¤Ğ¾Ğ½Ğ¾Ğ²Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²"""
    while True:
        try:
            current_time = time.time()
            
            for user_id, data in list(players.items()):
                faction = data.get("faction")
                if not faction or faction == "None":
                    continue
                
                # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾Ğ½Ğ°Ñ‚Ğ°
                if data.get("donation_end_time") and current_time >= data.get("donation_end_time"):
                    data["donation_end_time"] = None
                    data["donation_artifact"] = None
                    save_data()
                    await send_message(user_id, "â° Ğ’Ğ°Ñˆ Ğ´Ğ¾Ğ½Ğ°Ñ‚-ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¸ÑÑ‚Ñ‘Ğº.")
                
                # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ°
                if data.get("state") == GameState.TRANSITION_WAIT:
                    end_time = data.get("transition_end_time")
                    if end_time and current_time >= end_time:
                        data["previous_location"] = None
                        data["previous_point"] = None
                        
                        if random.randint(1, 100) <= 30:
                            money_found = random.randint(5, 15)
                            data["money"] = data.get("money", 0) + money_found
                            transition_msg = f"âœ… ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½!\nğŸ’² ĞŸĞ¾ Ğ¿ÑƒÑ‚Ğ¸ Ğ½Ğ°ÑˆĞ»Ğ¸: {money_found}Ñ€"
                        elif random.randint(1, 100) <= 20:
                            rad_gain = round(random.uniform(0.5, 1.5), 1)
                            data["radiation"] = min(10, data["radiation"] + rad_gain)
                            transition_msg = f"âœ… ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½!\nâ˜¢ï¸ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾ Ğ¾Ğ±Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ: +{rad_gain}"
                        else:
                            transition_msg = "âœ… ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½!"
                        
                        data["transition_end_time"] = None
                        data["state"] = GameState.IN_MENU
                        
                        data["backpack"]["Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸"] = data["backpack"].get("Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸", 0) - 2
                        if data["backpack"]["Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸"] <= 0:
                            del data["backpack"]["Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸"]
                        
                        transition_msg += "\nğŸ”‹ ĞŸĞ¾Ñ‚Ñ€Ğ°Ñ‡ĞµĞ½Ğ¾ 2 Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸."
                        
                        current_location = data["location"]
                        current_point = data["point"]
                        
                        if (current_location, current_point) in TRANSITION_ROUTES:
                            destinations = TRANSITION_ROUTES[(current_location, current_point)]
                            transition_msg += "\n\nğŸ“ Ğ’Ñ‹ Ğ½Ğ° Ñ‚Ğ¾Ñ‡ĞºĞµ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ°!"
                            for dest_loc, dest_point in destinations:
                                transition_msg += f"\nĞœĞ¾Ğ¶ĞµÑ‚Ğµ Ğ¿Ğ¾Ğ¿Ğ°ÑÑ‚ÑŒ Ğ½Ğ° {dest_loc} {dest_point}"
                        
                        save_data()
                        await send_message(user_id, transition_msg, create_main_menu_keyboard(user_id))
                
                # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¾Ñ‚Ğ´Ñ‹Ñ…Ğ°
                elif data.get("state") == GameState.RESTING:
                    start_time = data.get("rest_start_time")
                    if start_time:
                        elapsed = current_time - start_time
                        initial = data.get("initial_stamina", data["stamina"])
                        belt_bonus = apply_belt_effects_on_rest(user_id)
                        donation_bonus = 1 if has_active_donation(user_id) else 0
                        total_bonus = 1 + belt_bonus + donation_bonus
                        elapsed_intervals = int(elapsed // 360)
                        new_stamina = min(10, initial + elapsed_intervals * total_bonus)
                        
                        if new_stamina > data["stamina"]:
                            data["stamina"] = new_stamina
                            save_data()
                        
                        if data["stamina"] >= 10:
                            data["stamina"] = 10
                            data["state"] = GameState.IN_CAMP
                            data["rest_start_time"] = None
                            data.pop("initial_stamina", None)
                            save_data()
                            await send_message(user_id, "ğŸ˜´ Ğ’Ñ‹ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¾Ñ‚Ğ´Ğ¾Ñ…Ğ½ÑƒĞ»Ğ¸.", create_camp_menu_keyboard())
            
            await asyncio.sleep(10)
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² Ñ„Ğ¾Ğ½Ğ¾Ğ²Ğ¾Ğ¼ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞµ: {e}")
            await asyncio.sleep(30)


# ==================== ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞ˜ Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ™ ====================
@bot.message_handler(bot.text_filter("Ğ¡Ñ‚Ğ°Ñ€Ñ‚"))
async def handle_start(event: SimpleBotEvent):
    user_id = event.from_id
    
    if user_id in banned_users:
        reason = banned_users.get(user_id, "ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ°")
        await event.answer(f"ğŸš« Ğ’Ñ‹ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹.\nğŸ“ ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: {reason}")
        return
    
    if user_id not in players:
        name, screen_name = await get_user_info(user_id)
        players[user_id] = {
            "state": GameState.WAITING_FOR_START,
            "name": name,
            "screen_name": screen_name,
            "faction": None,
            "nickname": None,
            "location": "Ğ›Ğ°Ğ³ĞµÑ€ÑŒ",
            "point": "Ğ‘1",
            "health": 10,
            "radiation": 0,
            "hunger": 0,
            "stamina": 10,
            "detector": None,
            "detector_charge": 0,
            "detector_max_charge": 0,
            "armor": None,
            "armor_durability": 0,
            "armor_max_durability": 0,
            "bullet_resist": 0,
            "blast_resist": 0,
            "anomaly_resist": 0,
            "weapon": None,
            "weapon_durability": 0,
            "weapon_max_durability": 0,
            "weapon_damage": 0,
            "weapon_accuracy": 0,
            "money": 0,
            "backpack": {"Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸": 4},
            "transition_end_time": None,
            "rest_start_time": None,
            "backpack_sort": 0,
            "death_notified": False,
            "belt": [None, None, None],
            "squads": 0,
            "food_units": 0,
            "med_units": 0,
            "rad_units": 0,
            "donation_end_time": None,
            "donation_artifact": None,
            "hidden_anomaly_positions": []
        }
        save_data()
    
    players[user_id]["state"] = GameState.READING_INSTRUCTIONS
    save_data()
    await event.answer(GAME_INFO_TEXT, keyboard=create_next_keyboard())


@bot.message_handler(bot.text_filter("Ğ”Ğ°Ğ»ĞµĞµ"))
async def handle_next(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.READING_INSTRUCTIONS:
        players[user_id]["state"] = GameState.CHOOSING_FACTION
        save_data()
        await event.answer("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ ÑĞ²Ğ¾Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºÑƒ:", keyboard=create_faction_keyboard())


@bot.message_handler(bot.text_filter(["ğŸ›¡ï¸ Ğ”Ğ¾Ğ»Ğ³", "â˜¦ï¸ Ğ“Ñ€ĞµÑ…", "â˜¢ï¸ ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸"]))
async def handle_faction_choice(event: SimpleBotEvent):
    user_id = event.from_id
    text = event.text
    
    if user_id not in players or players[user_id].get("state") != GameState.CHOOSING_FACTION:
        return
    
    # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ñ„Ñ€Ğ°ĞºÑ†Ğ¸Ñ
    faction_name = None
    if "Ğ”Ğ¾Ğ»Ğ³" in text:
        faction_name = "ğŸ›¡ï¸ Ğ”Ğ¾Ğ»Ğ³"
    elif "Ğ“Ñ€ĞµÑ…" in text:
        faction_name = "â˜¦ï¸ Ğ“Ñ€ĞµÑ…"
    elif "ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸" in text:
        faction_name = "â˜¢ï¸ ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞºĞ¸"
    
    if not faction_name:
        return
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚
    if len(factions[faction_name]) >= MAX_FACTION_SIZES[faction_name]:
        all_full = all(len(factions[f]) >= MAX_FACTION_SIZES[f] for f in factions)
        if all_full:
            await event.answer("â³ Ğ’ÑĞµ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ñ‹.", keyboard=create_faction_keyboard())
        else:
            await event.answer(f"âŒ Ğ’ {faction_name} ÑƒĞ¶Ğµ Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ².", keyboard=create_faction_keyboard())
        return
    
    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºÑƒ
    factions[faction_name].append(user_id)
    players[user_id]["faction"] = faction_name
    
    start_loc, start_point = find_start_position(faction_name)
    players[user_id]["location"] = start_loc
    players[user_id]["point"] = start_point
    players[user_id]["state"] = GameState.ENTERING_NICKNAME
    save_data()
    
    chat_link = FACTION_CHAT_LINKS.get(faction_name, "")
    await event.answer(f"âœ… Ğ’Ñ‹ Ğ²ÑÑ‚ÑƒĞ¿Ğ¸Ğ»Ğ¸ Ğ² {faction_name}!\n\nğŸ’¬ Ğ‘ĞµÑĞµĞ´Ğ°: {chat_link}\n\nĞŸÑ€Ğ¸Ğ´ÑƒĞ¼Ğ°Ğ¹Ñ‚Ğµ ĞºĞ»Ğ¸Ñ‡ĞºÑƒ:")


@bot.message_handler(bot.text_filter("ğŸ•ï¸ Ğ›Ğ°Ğ³ĞµÑ€ÑŒ"))
async def handle_camp(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.IN_MENU:
        players[user_id]["state"] = GameState.IN_CAMP
        save_data()
        await event.answer(format_camp_info(user_id), keyboard=create_camp_menu_keyboard())


@bot.message_handler(bot.text_filter("ğŸ”š ĞĞ°Ğ·Ğ°Ğ´"))
async def handle_back(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    state = players[user_id].get("state")
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ¸Ğ· Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹
    if state == GameState.IN_CAMP:
        players[user_id]["state"] = GameState.IN_MENU
        save_data()
        await event.answer(MAIN_MENU_TEXT, keyboard=create_main_menu_keyboard(user_id))
    elif state == GameState.IN_BACKPACK:
        players[user_id]["state"] = GameState.IN_CAMP
        save_data()
        await event.answer(format_camp_info(user_id), keyboard=create_camp_menu_keyboard())
    elif state == GameState.TRADER_MAIN:
        players[user_id]["state"] = GameState.IN_MENU
        save_data()
        await event.answer(MAIN_MENU_TEXT, keyboard=create_main_menu_keyboard(user_id))
    elif state in [GameState.TRADER_BUY_CATEGORY, GameState.TRADER_SELL_CATEGORY]:
        players[user_id]["state"] = GameState.TRADER_MAIN
        save_data()
        await event.answer("ğŸ’² ĞŸÑ€Ğ¸Ğ¾Ğ±Ñ€ĞµÑÑ‚Ğ¸ Ğ¸Ğ»Ğ¸ ğŸ’± Ğ¿Ñ€Ğ¾Ğ´Ğ°Ñ‚ÑŒ?", keyboard=create_trader_main_keyboard())
    elif state == GameState.WAR_MAIN:
        players[user_id]["state"] = GameState.IN_MENU
        save_data()
        await event.answer(MAIN_MENU_TEXT, keyboard=create_main_menu_keyboard(user_id))
    elif state == GameState.WAR_TERRITORIES:
        players[user_id]["state"] = GameState.WAR_MAIN
        save_data()
        await event.answer("âš”ï¸ Ğ’Ğ¾Ğ¹Ğ½Ğ° Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº", keyboard=create_war_main_keyboard())
    elif state == GameState.IN_TRANSITION_MENU:
        players[user_id]["state"] = GameState.IN_MENU
        save_data()
        await event.answer(MAIN_MENU_TEXT, keyboard=create_main_menu_keyboard(user_id))
    elif state == GameState.BELT_MAIN:
        players[user_id]["state"] = GameState.IN_CAMP
        save_data()
        await event.answer(format_camp_info(user_id), keyboard=create_camp_menu_keyboard())
    elif state == GameState.WAREHOUSE:
        players[user_id]["state"] = GameState.IN_MENU
        save_data()
        await event.answer(MAIN_MENU_TEXT, keyboard=create_main_menu_keyboard(user_id))


@bot.message_handler(bot.text_filter("ğŸ’ Ğ ÑĞºĞ·Ğ°Ğº"))
async def handle_backpack(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.IN_CAMP:
        players[user_id]["state"] = GameState.IN_BACKPACK
        save_data()
        
        try:
            img_buffer = generate_inventory_image(user_id)
            await send_photo_with_message(user_id, img_buffer, "ğŸ’ Ğ’Ğ°Ñˆ Ñ€ÑĞºĞ·Ğ°Ğº:", create_backpack_menu_keyboard())
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ñ: {e}")
            await event.answer(format_backpack_info(user_id), keyboard=create_backpack_menu_keyboard())


@bot.message_handler(bot.text_filter("ğŸ’¤ ĞÑ‚Ğ´Ñ‹Ñ…"))
async def handle_rest(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.IN_CAMP:
        players[user_id]["state"] = GameState.RESTING
        players[user_id]["rest_start_time"] = time.time()
        players[user_id]["initial_stamina"] = players[user_id]["stamina"]
        save_data()
        
        stamina = players[user_id]["stamina"]
        rest_text = f"""âš¡ Ğ’Ñ‹Ğ½Ğ¾ÑĞ»Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ: {stamina}/10
ğŸ˜´ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ +1 ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 6 Ğ¼Ğ¸Ğ½ÑƒÑ‚.
âš¡ Ğ­Ğ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸ĞºĞ¸ ÑƒÑĞºĞ¾Ñ€ÑÑÑ‚ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ.
ğŸŒ• ĞĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹ Ñ‚Ğ¾Ğ¶Ğµ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ÑÑ‚."""
        await event.answer(rest_text, keyboard=create_resting_keyboard())


@bot.message_handler(bot.text_filter("âœ… Ğ”Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ¾Ñ‚Ğ´Ñ‹Ñ…Ğ°"))
async def handle_stop_rest(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.RESTING:
        players[user_id]["state"] = GameState.IN_CAMP
        players[user_id]["rest_start_time"] = None
        players[user_id].pop("initial_stamina", None)
        save_data()
        await event.answer(format_camp_info(user_id), keyboard=create_camp_menu_keyboard())


@bot.message_handler(bot.text_filter("ğŸ›’ Ğ¢Ğ¾Ñ€Ğ³Ğ¾Ğ²ĞµÑ†"))
async def handle_trader(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.IN_MENU:
        players[user_id]["state"] = GameState.TRADER_MAIN
        save_data()
        await event.answer("ğŸ’² ĞŸÑ€Ğ¸Ğ¾Ğ±Ñ€ĞµÑÑ‚Ğ¸ Ğ¸Ğ»Ğ¸ ğŸ’± Ğ¿Ñ€Ğ¾Ğ´Ğ°Ñ‚ÑŒ?", keyboard=create_trader_main_keyboard())


@bot.message_handler(bot.text_filter("âš”ï¸ Ğ’Ğ¾Ğ¹Ğ½Ğ° Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº"))
async def handle_war(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.IN_MENU:
        players[user_id]["state"] = GameState.WAR_MAIN
        save_data()
        await event.answer("âš”ï¸ Ğ’Ğ¾Ğ¹Ğ½Ğ° Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº â€” Ğ·Ğ°Ñ…Ğ²Ğ°Ñ‚Ñ‹Ğ²Ğ°Ğ¹ Ñ‚ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸!", keyboard=create_war_main_keyboard())


@bot.message_handler(bot.text_filter("ğŸ—ºï¸ Ğ¢ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ·Ğ¾Ğ½Ñ‹ ğŸ—ºï¸"))
async def handle_war_territories(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.WAR_MAIN:
        players[user_id]["state"] = GameState.WAR_TERRITORIES
        save_data()
        await event.answer("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ:", keyboard=create_war_territories_keyboard())


@bot.message_handler(bot.text_filter(["ĞšĞ¾Ñ€Ğ´Ğ¾Ğ½", "Ğ¡Ğ²Ğ°Ğ»ĞºĞ°", "Ğ¢Ñ‘Ğ¼Ğ½Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¸Ğ½Ğ°", "ĞŸĞ¾Ğ»ÑĞ½Ğ°"]))
async def handle_location_select(event: SimpleBotEvent):
    user_id = event.from_id
    location = event.text
    
    if user_id not in players:
        return
    
    state = players[user_id].get("state")
    
    if state == GameState.WAR_TERRITORIES:
        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ°Ñ€Ñ‚Ñƒ Ğ²Ğ¾Ğ¹Ğ½Ñ‹
        try:
            img_buffer = generate_war_map_image(location)
            if img_buffer:
                await send_photo_with_message(user_id, img_buffer, f"ğŸ“ Ğ›Ğ¾ĞºĞ°Ñ†Ğ¸Ñ: {location}", 
                                             create_war_territories_keyboard())
            else:
                await event.answer(f"ğŸ“ Ğ›Ğ¾ĞºĞ°Ñ†Ğ¸Ñ: {location}", keyboard=create_war_territories_keyboard())
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ²Ğ¾Ğ¹Ğ½Ñ‹: {e}")
            await event.answer(f"ğŸ“ Ğ›Ğ¾ĞºĞ°Ñ†Ğ¸Ñ: {location}", keyboard=create_war_territories_keyboard())


@bot.message_handler(bot.text_filter("ğŸŸ¡ ĞŸĞ¾ÑÑ"))
async def handle_belt(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.IN_CAMP:
        players[user_id]["state"] = GameState.BELT_MAIN
        save_data()
        
        belt = players[user_id].get("belt", [None, None, None])
        belt_info = f"""ğŸŸ¡ ĞŸĞ¾ÑÑ:
1ï¸âƒ£ {belt[0] or 'Ğ¿ÑƒÑÑ‚Ğ¾'}
2ï¸âƒ£ {belt[1] or 'Ğ¿ÑƒÑÑ‚Ğ¾'}
3ï¸âƒ£ {belt[2] or 'Ğ¿ÑƒÑÑ‚Ğ¾'}

ğŸ’¡ ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹: Â«ĞŸĞ¾Ğ²ĞµÑĞ¸Ñ‚ÑŒ [Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚]Â», Â«Ğ¡Ğ½ÑÑ‚ÑŒ [Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚]Â»"""
        await event.answer(belt_info, keyboard=create_belt_main_keyboard())


@bot.message_handler(bot.text_filter("ğŸƒ ĞŸĞ¾Ğ±ĞµĞ³"))
async def handle_escape(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.HUNTING:
        await handle_hunting_escape(user_id)


@bot.message_handler(bot.text_filter("ğŸšª Ğ£Ğ¹Ñ‚Ğ¸"))
async def handle_leave_anomaly(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.ANOMALY_EXPLORE:
        players[user_id]["state"] = GameState.IN_MENU
        players[user_id]["artifact_positions"] = []
        players[user_id]["anomaly_positions"] = []
        players[user_id]["anomaly_path_choosing"] = False
        save_data()
        await event.answer("Ğ’Ñ‹ Ğ¿Ğ¾ĞºĞ¸Ğ½ÑƒĞ»Ğ¸ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ·Ğ¾Ğ½Ñƒ.", keyboard=create_main_menu_keyboard(user_id))


@bot.message_handler(bot.text_filter(["â¬†ï¸", "â¬‡ï¸", "â¬…ï¸", "â¡ï¸"]))
async def handle_anomaly_movement(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.ANOMALY_EXPLORE:
        await handle_anomaly_move(user_id, event.text)


@bot.message_handler(bot.regex_filter(r"^ğŸ¯ \d$"))
async def handle_hunting_shot(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.HUNTING:
        try:
            shot_num = int(event.text.split()[-1])
            if 1 <= shot_num <= 9:
                players[user_id]["state"] = GameState.HUNTING_SHOOTING
                players[user_id]["shot_button"] = shot_num
                save_data()
                await handle_shooting(user_id)
        except ValueError:
            await event.answer("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ†ĞµĞ»ÑŒ.", keyboard=create_hunting_keyboard())


# ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ´Ğ»Ñ Ñ‚Ğ¾Ñ‡ĞµĞº Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
@bot.message_handler(bot.text_filter(["ğŸ•‹ Ğ‘Ğ°Ğ·Ğ°", "ğŸ—ï¸ Ğ¢Ğ¾Ñ‡ĞºĞ° Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²", "ğŸ§± Ğ¢ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ", "â˜ ï¸ Ğ›Ğ¾Ğ³Ğ¾Ğ²Ğ¾",
                                       "ğŸŒªï¸ Ğ“Ñ€Ğ°Ğ²Ğ¸ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ğ¸", "âš¡ Ğ­Ğ»ĞµĞºÑ‚Ñ€Ğ¾ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ğ¸", 
                                       "â˜£ï¸ Ğ¥Ğ¸Ğ¼ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ğ¸", "ğŸ”¥ Ğ¢ĞµÑ€Ğ¼Ğ¾ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ğ¸"]))
async def handle_exploration_button(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.IN_MENU:
        await handle_exploration(user_id)


# ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
@bot.message_handler()
async def handle_default(event: SimpleBotEvent):
    user_id = event.from_id
    text = event.text.strip() if event.text else ""
    
    if user_id in banned_users:
        reason = banned_users.get(user_id, "ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ°")
        await event.answer(f"ğŸš« Ğ’Ñ‹ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹.\nğŸ“ ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: {reason}")
        return
    
    # ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¸Ğ³Ñ€Ğ¾Ğº
    if user_id not in players:
        name, screen_name = await get_user_info(user_id)
        players[user_id] = {
            "state": GameState.WAITING_FOR_START,
            "name": name,
            "screen_name": screen_name,
            "faction": None,
            "nickname": None,
            "location": "Ğ›Ğ°Ğ³ĞµÑ€ÑŒ",
            "point": "Ğ‘1",
            "health": 10, "radiation": 0, "hunger": 0, "stamina": 10,
            "detector": None, "detector_charge": 0, "detector_max_charge": 0,
            "armor": None, "armor_durability": 0, "armor_max_durability": 0,
            "bullet_resist": 0, "blast_resist": 0, "anomaly_resist": 0,
            "weapon": None, "weapon_durability": 0, "weapon_max_durability": 0,
            "weapon_damage": 0, "weapon_accuracy": 0,
            "money": 0,
            "backpack": {"Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸": 4},
            "transition_end_time": None, "rest_start_time": None,
            "backpack_sort": 0, "death_notified": False,
            "belt": [None, None, None],
            "squads": 0, "food_units": 0, "med_units": 0, "rad_units": 0,
            "donation_end_time": None, "donation_artifact": None,
            "hidden_anomaly_positions": []
        }
        save_data()
        await event.answer(f"ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, {name}! ğŸ‘‹\nĞĞ°Ğ¶Ğ¼Ğ¸ Â«Ğ¡Ñ‚Ğ°Ñ€Ñ‚Â» Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°.", keyboard=create_start_keyboard())
        return
    
    state = players[user_id].get("state")
    
    # Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹
    registration_states = [GameState.WAITING_FOR_START, GameState.READING_INSTRUCTIONS,
                          GameState.CHOOSING_FACTION, GameState.ENTERING_NICKNAME]
    if state not in registration_states:
        if await handle_global_commands(user_id, text):
            return
    
    # Ğ’Ğ²Ğ¾Ğ´ Ğ½Ğ¸ĞºĞ½ĞµĞ¹Ğ¼Ğ°
    if state == GameState.ENTERING_NICKNAME:
        nickname = text.strip()
        if nickname:
            players[user_id]["nickname"] = nickname
            players[user_id]["state"] = GameState.IN_MENU
            save_data()
            await event.answer(f"Ğ£Ğ´Ğ°Ñ‡Ğ½Ğ¾Ğ¹ Ğ¾Ñ…Ğ¾Ñ‚Ñ‹, {nickname}! ğŸ¯\n{MAIN_MENU_TEXT}", 
                              keyboard=create_main_menu_keyboard(user_id))
        return
    
    # ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ°
    if state == GameState.TRANSITION_WAIT:
        end_time = players[user_id].get("transition_end_time")
        if end_time and time.time() < end_time:
            remaining = end_time - time.time()
            minutes = int(remaining // 60)
            seconds = int(remaining % 60)
            await event.answer(f"â³ ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ°: {minutes} Ğ¼Ğ¸Ğ½ {seconds} ÑĞµĞº")
        return
    
    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ğ°
    if state == GameState.USING_ITEM:
        if text.lower() == "Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ°":
            players[user_id]["state"] = GameState.IN_BACKPACK
            save_data()
            await event.answer(format_backpack_info(user_id), keyboard=create_backpack_menu_keyboard())
        else:
            await use_item(user_id, text)
            players[user_id]["state"] = GameState.IN_BACKPACK
            save_data()
        return
# ==================== Ğ¢ĞĞ Ğ“ĞĞ’Ğ•Ğ¦ ====================

@bot.message_handler(bot.text_filter("ğŸ’² ĞŸÑ€Ğ¸Ğ¾Ğ±Ñ€ĞµÑÑ‚Ğ¸"))
async def handle_trader_buy_menu(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.TRADER_MAIN:
        players[user_id]["state"] = GameState.TRADER_BUY_CATEGORY
        save_data()
        await event.answer("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ:", keyboard=create_trader_category_keyboard())


@bot.message_handler(bot.text_filter("ğŸ’± ĞŸÑ€Ğ¾Ğ´Ğ°Ñ‚ÑŒ"))
async def handle_trader_sell_menu(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.TRADER_MAIN:
        players[user_id]["state"] = GameState.TRADER_SELL_CATEGORY
        save_data()
        await event.answer("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ:", keyboard=create_trader_sell_category_keyboard())


@bot.message_handler(bot.text_filter("âš™ï¸ ĞŸĞ¾Ñ‡Ğ¸Ğ½Ğ¸Ñ‚ÑŒ"))
async def handle_trader_repair_menu(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.TRADER_MAIN:
        players[user_id]["state"] = GameState.TRADER_REPAIR
        save_data()
        
        p = players[user_id]
        money = p.get("money", 0)
        weapon = p.get("weapon")
        weapon_dur = p.get("weapon_durability", 0)
        weapon_max = p.get("weapon_max_durability", 0)
        armor = p.get("armor")
        armor_dur = p.get("armor_durability", 0)
        armor_max = p.get("armor_max_durability", 0)
        
        repair_text = f"""âš™ï¸ Ğ§Ñ‚Ğ¾ ÑĞ¾Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ĞµÑÑŒ Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¸Ñ‚ÑŒ?
â— Ğ ĞµĞ¼Ğ¾Ğ½Ñ‚ Ğ½Ğ° 1 ĞµĞ´Ğ¸Ğ½Ğ¸Ñ†Ñƒ = 15Ñ€
ğŸ’² Ğ”ĞµĞ½ÑŒĞ³Ğ¸: {money}Ñ€

ğŸ”« ĞÑ€ÑƒĞ¶Ğ¸Ğµ: {'Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚' if not weapon else f'{weapon} ğŸ”§{weapon_dur}/{weapon_max}'}
ğŸ¦º Ğ‘Ñ€Ğ¾Ğ½Ñ: {'Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚' if not armor else f'{armor} ğŸ”§{armor_dur}/{armor_max}'}"""
        
        await event.answer(repair_text, keyboard=create_repair_keyboard(user_id))


@bot.message_handler(bot.text_filter("ğŸ¥« ĞŸÑ€Ğ¾Ğ²Ğ¸Ğ·Ğ¸Ñ"))
async def handle_provisions(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    state = players[user_id].get("state")
    
    if state == GameState.TRADER_BUY_CATEGORY:
        await show_buy_provisions_menu(user_id)
    elif state == GameState.TRADER_SELL_CATEGORY:
        await show_sell_provisions_menu(user_id)


async def show_buy_provisions_menu(user_id: int):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¼ĞµĞ½Ñ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ²Ğ¸Ğ·Ğ¸Ğ¸"""
    p = players[user_id]
    money = p.get("money", 0)
    
    all_provisions = (CATEGORIES["ĞµĞ´Ğ°"] + CATEGORIES["Ğ¼ĞµĞ´Ğ¸ĞºĞ°Ğ¼ĞµĞ½Ñ‚Ñ‹"] + 
                     CATEGORIES["Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ°Ğ´"] + CATEGORIES["ÑĞ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸ĞºĞ¸"] + CATEGORIES["Ğ¿Ñ€Ğ¾Ñ‡ĞµĞµ"])
    
    msg_lines = [f"ğŸ’² Ğ’Ğ°ÑˆĞ¸ Ğ´ĞµĞ½ÑŒĞ³Ğ¸: {money}Ñ€", "", "ğŸ›’ ĞŸĞ ĞĞ’Ğ˜Ğ—Ğ˜Ğ¯:", ""]
    
    for item in all_provisions:
        if item in BUY_PRICES:
            price = BUY_PRICES[item]
            msg_lines.append(f"â€¢ {item} â€” {price}Ñ€")
    
    msg_lines.append("")
    msg_lines.append("âœï¸ ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ: [Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ] [ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾]")
    msg_lines.append("ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: Ñ…Ğ»ĞµĞ± 5")
    
    players[user_id]["state"] = GameState.TRADER_BUY
    save_data()
    
    await send_message(user_id, "\n".join(msg_lines), create_back_only_keyboard())


async def show_sell_provisions_menu(user_id: int):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¼ĞµĞ½Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸ Ğ¿Ñ€Ğ¾Ğ²Ğ¸Ğ·Ğ¸Ğ¸"""
    p = players[user_id]
    backpack = p.get("backpack", {})
    money = p.get("money", 0)
    
    all_provisions = (CATEGORIES["ĞµĞ´Ğ°"] + CATEGORIES["Ğ¼ĞµĞ´Ğ¸ĞºĞ°Ğ¼ĞµĞ½Ñ‚Ñ‹"] + 
                     CATEGORIES["Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ°Ğ´"] + CATEGORIES["ÑĞ½ĞµÑ€Ğ³ĞµÑ‚Ğ¸ĞºĞ¸"] + CATEGORIES["Ğ¿Ñ€Ğ¾Ñ‡ĞµĞµ"])
    
    msg_lines = [f"ğŸ’² Ğ’Ğ°ÑˆĞ¸ Ğ´ĞµĞ½ÑŒĞ³Ğ¸: {money}Ñ€", "", "ğŸ“¦ Ğ’Ğ°ÑˆĞ° Ğ¿Ñ€Ğ¾Ğ²Ğ¸Ğ·Ğ¸Ñ:", ""]
    
    has_items = False
    for item in all_provisions:
        count = backpack.get(item, 0)
        if count > 0:
            price = SELL_PRICES.get(item, 0)
            msg_lines.append(f"â€¢ {item} x{count} â€” {price}Ñ€/ÑˆÑ‚")
            has_items = True
    
    if not has_items:
        msg_lines.append("ĞŸÑƒÑÑ‚Ğ¾")
    
    msg_lines.append("")
    msg_lines.append("âœï¸ ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ: [Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ] [ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾]")
    msg_lines.append("ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: Ñ…Ğ»ĞµĞ± 2")
    
    players[user_id]["state"] = GameState.TRADER_SELL
    save_data()
    
    await send_message(user_id, "\n".join(msg_lines), create_back_only_keyboard())


@bot.message_handler(bot.text_filter("ğŸª– Ğ¡Ğ½Ğ°Ñ€ÑĞ¶ĞµĞ½Ğ¸Ğµ"))
async def handle_equipment(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    state = players[user_id].get("state")
    
    if state == GameState.TRADER_BUY_CATEGORY:
        players[user_id]["state"] = GameState.TRADER_BUY_EQUIPMENT
        save_data()
        await event.answer("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ‚Ğ¸Ğ¿ ÑĞ½Ğ°Ñ€ÑĞ¶ĞµĞ½Ğ¸Ñ:", keyboard=create_equipment_category_keyboard())
    elif state == GameState.TRADER_SELL_CATEGORY:
        players[user_id]["state"] = GameState.TRADER_SELL_EQUIPMENT_CONFIRM
        save_data()
        await event.answer("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸:", keyboard=create_equipment_category_keyboard())


@bot.message_handler(bot.text_filter("ğŸŒ• ĞÑ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹"))
async def handle_sell_artifacts(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.TRADER_SELL_CATEGORY:
        await show_sell_artifacts_menu(user_id)


async def show_sell_artifacts_menu(user_id: int):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¼ĞµĞ½Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ğ²"""
    p = players[user_id]
    backpack = p.get("backpack", {})
    
    available_arts = []
    for art in ALL_ARTIFACTS:
        if backpack.get(art, 0) > 0:
            available_arts.append((art, backpack[art]))
    
    if not available_arts:
        await send_message(user_id, "âŒ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸.", 
                          create_trader_sell_category_keyboard())
        return
    
    msg_lines = ["ğŸŒ• Ğ’Ğ°ÑˆĞ¸ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹:", ""]
    for art, count in available_arts:
        price = ARTIFACT_PRICES.get(art, 15)
        msg_lines.append(f"â€¢ {art} x{count} â€” {price}Ñ€/ÑˆÑ‚")
    
    msg_lines.append("")
    msg_lines.append("âœï¸ ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ: [Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ] [ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾]")
    msg_lines.append("ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: ĞœĞµĞ´ÑƒĞ·Ğ° 2")
    
    players[user_id]["state"] = GameState.TRADER_SELL_ARTIFACTS
    save_data()
    
    await send_message(user_id, "\n".join(msg_lines), create_back_only_keyboard())


@bot.message_handler(bot.text_filter(["ğŸ”« ĞÑ€ÑƒĞ¶Ğ¸Ğµ", "ğŸ¦º Ğ‘Ñ€Ğ¾Ğ½Ñ", "ğŸ“Ÿ Ğ”ĞµÑ‚ĞµĞºÑ‚Ğ¾Ñ€Ñ‹"]))
async def handle_equipment_type(event: SimpleBotEvent):
    user_id = event.from_id
    text = event.text
    
    if user_id not in players:
        return
    
    state = players[user_id].get("state")
    p = players[user_id]
    faction = p.get("faction")
    money = p.get("money", 0)
    
    if state == GameState.TRADER_BUY_EQUIPMENT:
        if text == "ğŸ“Ÿ Ğ”ĞµÑ‚ĞµĞºÑ‚Ğ¾Ñ€Ñ‹":
            msg_lines = [f"ğŸ’² Ğ’Ğ°ÑˆĞ¸ Ğ´ĞµĞ½ÑŒĞ³Ğ¸: {money}Ñ€", "", "ğŸ“Ÿ Ğ”Ğ•Ğ¢Ğ•ĞšĞ¢ĞĞ Ğ«:", ""]
            
            sorted_detectors = sorted(DETECTORS.items(), key=lambda x: x[1]["price"])
            for i, (name, data) in enumerate(sorted_detectors, 1):
                msg_lines.append(f"{i}. {name} â€” {data['price']}Ñ€ (âš¡{data['charge']})")
            
            msg_lines.append("")
            msg_lines.append("âœï¸ ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´ĞµÑ‚ĞµĞºÑ‚Ğ¾Ñ€Ğ°:")
            
            players[user_id]["pending_buy_type"] = "detector"
            players[user_id]["state"] = GameState.TRADER_BUY_EQUIPMENT_CONFIRM
            save_data()
            
            await send_message(user_id, "\n".join(msg_lines), create_back_only_keyboard())
        
        elif text == "ğŸ”« ĞÑ€ÑƒĞ¶Ğ¸Ğµ":
            if faction not in EQUIPMENT:
                await event.answer("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸.")
                return
            
            items = EQUIPMENT[faction]["weapon"]
            sorted_items = sorted(items, key=lambda x: x[4])
            
            msg_lines = [f"ğŸ’² Ğ’Ğ°ÑˆĞ¸ Ğ´ĞµĞ½ÑŒĞ³Ğ¸: {money}Ñ€", "", f"ğŸ”« ĞĞ Ğ£Ğ–Ğ˜Ğ• ({faction}):", ""]
            
            for i, item in enumerate(sorted_items, 1):
                name, dur, dmg, acc, price = item
                msg_lines.append(f"{i}. {name} â€” {price}Ñ€")
                msg_lines.append(f"   ğŸ”§[{dur}] ğŸ’¢[{dmg}] ğŸ¯[{acc}]")
            
            msg_lines.append("")
            msg_lines.append("âœï¸ ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ€ÑƒĞ¶Ğ¸Ñ:")
            
            players[user_id]["pending_buy_type"] = "weapon"
            players[user_id]["state"] = GameState.TRADER_BUY_EQUIPMENT_CONFIRM
            save_data()
            
            await send_message(user_id, "\n".join(msg_lines), create_back_only_keyboard())
        
        elif text == "ğŸ¦º Ğ‘Ñ€Ğ¾Ğ½Ñ":
            if faction not in EQUIPMENT:
                await event.answer("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸.")
                return
            
            items = EQUIPMENT[faction]["armor"]
            sorted_items = sorted(items, key=lambda x: x[5])
            
            msg_lines = [f"ğŸ’² Ğ’Ğ°ÑˆĞ¸ Ğ´ĞµĞ½ÑŒĞ³Ğ¸: {money}Ñ€", "", f"ğŸ¦º Ğ‘Ğ ĞĞĞ¯ ({faction}):", ""]
            
            for i, item in enumerate(sorted_items, 1):
                name, dur, shield, blast, anom, price = item
                msg_lines.append(f"{i}. {name} â€” {price}Ñ€")
                msg_lines.append(f"   ğŸ”§[{dur}] ğŸ›¡ï¸[{shield}] ğŸ¾[{blast}] ğŸ’¥[{anom}]")
            
            msg_lines.append("")
            msg_lines.append("âœï¸ ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ±Ñ€Ğ¾Ğ½Ğ¸:")
            
            players[user_id]["pending_buy_type"] = "armor"
            players[user_id]["state"] = GameState.TRADER_BUY_EQUIPMENT_CONFIRM
            save_data()
            
            await send_message(user_id, "\n".join(msg_lines), create_back_only_keyboard())
    
    elif state == GameState.TRADER_SELL_EQUIPMENT_CONFIRM:
        if text == "ğŸ”« ĞÑ€ÑƒĞ¶Ğ¸Ğµ":
            if not p.get("weapon"):
                await event.answer("âŒ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ¾Ñ€ÑƒĞ¶Ğ¸Ñ.", keyboard=create_equipment_category_keyboard())
                return
            
            weapon_name = p["weapon"]
            price = 0
            for item in EQUIPMENT[faction]["weapon"]:
                if item[0] == weapon_name:
                    price = item[4] // 2
                    break
            
            players[user_id]["pending_sell"] = "weapon"
            players[user_id]["state"] = GameState.CONFIRMING_EQUIPMENT_SELL
            save_data()
            
            await send_message(user_id, f"ĞŸÑ€Ğ¾Ğ´Ğ°Ñ‚ÑŒ {weapon_name} Ğ·Ğ° {price}Ñ€?", create_confirmation_keyboard())
        
        elif text == "ğŸ¦º Ğ‘Ñ€Ğ¾Ğ½Ñ":
            if not p.get("armor"):
                await event.answer("âŒ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ±Ñ€Ğ¾Ğ½Ğ¸.", keyboard=create_equipment_category_keyboard())
                return
            
            armor_name = p["armor"]
            price = 0
            for item in EQUIPMENT[faction]["armor"]:
                if item[0] == armor_name:
                    price = item[5] // 2
                    break
            
            players[user_id]["pending_sell"] = "armor"
            players[user_id]["state"] = GameState.CONFIRMING_EQUIPMENT_SELL
            save_data()
            
            await send_message(user_id, f"ĞŸÑ€Ğ¾Ğ´Ğ°Ñ‚ÑŒ {armor_name} Ğ·Ğ° {price}Ñ€?", create_confirmation_keyboard())
        
        elif text == "ğŸ“Ÿ Ğ”ĞµÑ‚ĞµĞºÑ‚Ğ¾Ñ€Ñ‹":
            if not p.get("detector"):
                await event.answer("âŒ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ´ĞµÑ‚ĞµĞºÑ‚Ğ¾Ñ€Ğ°.", keyboard=create_equipment_category_keyboard())
                return
            
            det_name = p["detector"]
            price = DETECTORS[det_name]["price"] // 2
            
            players[user_id]["pending_sell"] = "detector"
            players[user_id]["state"] = GameState.CONFIRMING_EQUIPMENT_SELL
            save_data()
            
            await send_message(user_id, f"ĞŸÑ€Ğ¾Ğ´Ğ°Ñ‚ÑŒ {det_name} Ğ·Ğ° {price}Ñ€?", create_confirmation_keyboard())
    
    elif state == GameState.TRADER_REPAIR:
        if text == "ğŸ”« ĞÑ€ÑƒĞ¶Ğ¸Ğµ":
            if not p.get("weapon"):
                await event.answer("âŒ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ¾Ñ€ÑƒĞ¶Ğ¸Ñ.", keyboard=create_repair_keyboard(user_id))
                return
            if p["money"] < 15:
                await event.answer("âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ´ĞµĞ½ĞµĞ³ (Ğ½ÑƒĞ¶Ğ½Ğ¾ 15Ñ€).", keyboard=create_repair_keyboard(user_id))
                return
            if p["weapon_durability"] >= p["weapon_max_durability"]:
                await event.answer("ğŸ”« ĞÑ€ÑƒĞ¶Ğ¸Ğµ ÑƒĞ¶Ğµ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ½Ğ¾.", keyboard=create_repair_keyboard(user_id))
                return
            
            p["money"] -= 15
            p["weapon_durability"] = min(p["weapon_max_durability"], p["weapon_durability"] + 1)
            save_data()
            
            await event.answer(f"âœ… ĞÑ€ÑƒĞ¶Ğ¸Ğµ Ğ¿Ğ¾Ñ‡Ğ¸Ğ½ĞµĞ½Ğ¾. ğŸ”§{p['weapon_durability']}/{p['weapon_max_durability']}", 
                              keyboard=create_repair_keyboard(user_id))
        
        elif text == "ğŸ¦º Ğ‘Ñ€Ğ¾Ğ½Ñ":
            if not p.get("armor"):
                await event.answer("âŒ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ±Ñ€Ğ¾Ğ½Ğ¸.", keyboard=create_repair_keyboard(user_id))
                return
            if p["money"] < 15:
                await event.answer("âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ´ĞµĞ½ĞµĞ³ (Ğ½ÑƒĞ¶Ğ½Ğ¾ 15Ñ€).", keyboard=create_repair_keyboard(user_id))
                return
            if p["armor_durability"] >= p["armor_max_durability"]:
                await event.answer("ğŸ¦º Ğ‘Ñ€Ğ¾Ğ½Ñ ÑƒĞ¶Ğµ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ½Ğ°.", keyboard=create_repair_keyboard(user_id))
                return
            
            p["money"] -= 15
            p["armor_durability"] = min(p["armor_max_durability"], p["armor_durability"] + 1)
            save_data()
            
            await event.answer(f"âœ… Ğ‘Ñ€Ğ¾Ğ½Ñ Ğ¿Ğ¾Ñ‡Ğ¸Ğ½ĞµĞ½Ğ°. ğŸ”§{p['armor_durability']}/{p['armor_max_durability']}", 
                              keyboard=create_repair_keyboard(user_id))


async def handle_trader_buy(user_id: int, text: str):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ²Ğ¸Ğ·Ğ¸Ğ¸"""
    parts = text.strip().lower().split()
    
    if len(parts) < 2:
        await send_message(user_id, "âŒ Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: [Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ] [ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾]", create_back_only_keyboard())
        return
    
    try:
        count = int(parts[-1])
        item_name = " ".join(parts[:-1])
    except:
        await send_message(user_id, "âŒ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼.", create_back_only_keyboard())
        return
    
    if item_name not in BUY_PRICES:
        await send_message(user_id, "âŒ Ğ¢Ğ°ĞºĞ¾Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ½Ğµ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ñ‘Ñ‚ÑÑ.", create_back_only_keyboard())
        return
    
    price = BUY_PRICES[item_name] * count
    
    if players[user_id]["money"] < price:
        await send_message(user_id, f"âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ´ĞµĞ½ĞµĞ³. ĞÑƒĞ¶Ğ½Ğ¾ {price}Ñ€.", create_back_only_keyboard())
        return
    
    players[user_id]["money"] -= price
    players[user_id]["backpack"][item_name] = players[user_id]["backpack"].get(item_name, 0) + count
    save_data()
    
    await send_message(user_id, f"âœ… ĞšÑƒĞ¿Ğ»ĞµĞ½Ğ¾: {item_name} x{count} Ğ·Ğ° {price}Ñ€.", 
                      create_trader_category_keyboard())
    players[user_id]["state"] = GameState.TRADER_BUY_CATEGORY
    save_data()


async def handle_trader_sell(user_id: int, text: str):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸ Ğ¿Ñ€Ğ¾Ğ²Ğ¸Ğ·Ğ¸Ğ¸"""
    parts = text.strip().lower().split()
    
    if len(parts) < 2:
        await send_message(user_id, "âŒ Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: [Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ] [ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾]", create_back_only_keyboard())
        return
    
    try:
        count = int(parts[-1])
        item_name = " ".join(parts[:-1])
    except:
        await send_message(user_id, "âŒ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼.", create_back_only_keyboard())
        return
    
    if item_name not in SELL_PRICES:
        await send_message(user_id, "âŒ Ğ¢Ğ°ĞºĞ¾Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ñ‚ÑŒ.", create_back_only_keyboard())
        return
    
    if count <= 0:
        await send_message(user_id, "âŒ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 0.", create_back_only_keyboard())
        return
    
    if players[user_id]["backpack"].get(item_name, 0) < count:
        await send_message(user_id, f"âŒ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ {count} ÑˆÑ‚.", create_back_only_keyboard())
        return
    
    price = int(SELL_PRICES[item_name] * count)
    players[user_id]["money"] += price
    players[user_id]["backpack"][item_name] -= count
    if players[user_id]["backpack"][item_name] <= 0:
        del players[user_id]["backpack"][item_name]
    save_data()
    
    await send_message(user_id, f"âœ… ĞŸÑ€Ğ¾Ğ´Ğ°Ğ½Ğ¾: {item_name} x{count} Ğ·Ğ° {price}Ñ€.", 
                      create_trader_sell_category_keyboard())
    players[user_id]["state"] = GameState.TRADER_SELL_CATEGORY
    save_data()


async def handle_trader_sell_artifact(user_id: int, text: str):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ğ²"""
    parts = text.strip().split()
    
    if len(parts) < 2:
        await send_message(user_id, "âŒ Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: [Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ] [ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾]", create_back_only_keyboard())
        return
    
    try:
        count = int(parts[-1])
        item_name = " ".join(parts[:-1])
    except:
        await send_message(user_id, "âŒ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼.", create_back_only_keyboard())
        return
    
    found_art = None
    for art in ALL_ARTIFACTS:
        if art.lower() == item_name.lower():
            found_art = art
            break
    
    if not found_art:
        await send_message(user_id, "âŒ Ğ¢Ğ°ĞºĞ¾Ğ¹ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.", create_back_only_keyboard())
        return
    
    if players[user_id]["backpack"].get(found_art, 0) < count:
        await send_message(user_id, f"âŒ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ {count} ÑˆÑ‚.", create_back_only_keyboard())
        return
    
    price = ARTIFACT_PRICES.get(found_art, 15) * count
    players[user_id]["money"] += price
    players[user_id]["backpack"][found_art] -= count
    if players[user_id]["backpack"][found_art] <= 0:
        del players[user_id]["backpack"][found_art]
    save_data()
    
    await send_message(user_id, f"âœ… ĞŸÑ€Ğ¾Ğ´Ğ°Ğ½Ğ¾: {found_art} x{count} Ğ·Ğ° {price}Ñ€.", 
                      create_trader_sell_category_keyboard())
    players[user_id]["state"] = GameState.TRADER_SELL_CATEGORY
    save_data()


async def handle_equipment_buy_confirm(user_id: int, text: str):
    """ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸ ÑĞ½Ğ°Ñ€ÑĞ¶ĞµĞ½Ğ¸Ñ"""
    p = players[user_id]
    item_type = p.get("pending_buy_type")
    faction = p.get("faction")
    item_name = text.strip()
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´ĞµÑ‚ĞµĞºÑ‚Ğ¾Ñ€Ñ‹
    if item_type == "detector":
        if item_name not in DETECTORS:
            await send_message(user_id, "âŒ ĞĞµĞ²ĞµÑ€Ğ½Ğ¾Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ.", create_back_only_keyboard())
            return
        
        if p.get("detector"):
            await send_message(user_id, f"âŒ Ğ£ Ğ²Ğ°Ñ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ğ´ĞµÑ‚ĞµĞºÑ‚Ğ¾Ñ€: {p['detector']}. Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¹Ñ‚Ğµ.", 
                              create_equipment_category_keyboard())
            p["state"] = GameState.TRADER_BUY_EQUIPMENT
            save_data()
            return
        
        price = DETECTORS[item_name]["price"]
        if p["money"] < price:
            await send_message(user_id, f"âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ´ĞµĞ½ĞµĞ³. ĞÑƒĞ¶Ğ½Ğ¾ {price}Ñ€.", create_back_only_keyboard())
            return
        
        p["money"] -= price
        p["detector"] = item_name
        p["detector_charge"] = DETECTORS[item_name]["charge"]
        p["detector_max_charge"] = DETECTORS[item_name]["charge"]
        p["pending_buy_type"] = None
        p["state"] = GameState.TRADER_BUY_EQUIPMENT
        save_data()
        
        await send_message(user_id, f"âœ… ĞšÑƒĞ¿Ğ»ĞµĞ½Ğ¾: {item_name} Ğ·Ğ° {price}Ñ€.", create_equipment_category_keyboard())
        return
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¾Ñ€ÑƒĞ¶Ğ¸Ğµ/Ğ±Ñ€Ğ¾Ğ½Ñ
    if item_type in ["weapon", "armor"]:
        if faction not in EQUIPMENT:
            await send_message(user_id, "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸.", create_back_only_keyboard())
            return
        
        found_item = None
        for item in EQUIPMENT[faction][item_type]:
            if item[0].lower() == item_name.lower():
                found_item = item
                break
        
        if not found_item:
            await send_message(user_id, "âŒ ĞĞµĞ²ĞµÑ€Ğ½Ğ¾Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ.", create_back_only_keyboard())
            return
        
        if item_type == "weapon" and p.get("weapon"):
            await send_message(user_id, f"âŒ Ğ£ Ğ²Ğ°Ñ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ğ¾Ñ€ÑƒĞ¶Ğ¸Ğµ: {p['weapon']}. Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¹Ñ‚Ğµ.", 
                              create_equipment_category_keyboard())
            p["state"] = GameState.TRADER_BUY_EQUIPMENT
            save_data()
            return
        
        if item_type == "armor" and p.get("armor"):
            await send_message(user_id, f"âŒ Ğ£ Ğ²Ğ°Ñ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ğ±Ñ€Ğ¾Ğ½Ñ: {p['armor']}. Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¹Ñ‚Ğµ.", 
                              create_equipment_category_keyboard())
            p["state"] = GameState.TRADER_BUY_EQUIPMENT
            save_data()
            return
        
        if item_type == "weapon":
            name, dur, dmg, acc, price = found_item
            if p["money"] < price:
                await send_message(user_id, f"âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ´ĞµĞ½ĞµĞ³. ĞÑƒĞ¶Ğ½Ğ¾ {price}Ñ€.", create_back_only_keyboard())
                return
            
            p["money"] -= price
            p["weapon"] = name
            p["weapon_durability"] = dur
            p["weapon_max_durability"] = dur
            p["weapon_damage"] = dmg
            p["weapon_accuracy"] = acc
        else:
            name, dur, shield, blast, anom, price = found_item
            if p["money"] < price:
                await send_message(user_id, f"âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ´ĞµĞ½ĞµĞ³. ĞÑƒĞ¶Ğ½Ğ¾ {price}Ñ€.", create_back_only_keyboard())
                return
            
            p["money"] -= price
            p["armor"] = name
            p["armor_durability"] = dur
            p["armor_max_durability"] = dur
            p["bullet_resist"] = shield
            p["blast_resist"] = blast
            p["anomaly_resist"] = anom
        
        p["pending_buy_type"] = None
        p["state"] = GameState.TRADER_BUY_EQUIPMENT
        save_data()
        
        await send_message(user_id, f"âœ… ĞšÑƒĞ¿Ğ»ĞµĞ½Ğ¾: {name} Ğ·Ğ° {price}Ñ€.", create_equipment_category_keyboard())


@bot.message_handler(bot.text_filter(["âœ… Ğ”Ğ°", "âŒ ĞĞµÑ‚"]))
async def handle_confirmation(event: SimpleBotEvent):
    user_id = event.from_id
    text = event.text
    
    if user_id not in players:
        return
    
    state = players[user_id].get("state")
    p = players[user_id]
    
    if state == GameState.CONFIRMING_EQUIPMENT_SELL:
        if text == "âœ… Ğ”Ğ°":
            sell_type = p.get("pending_sell")
            faction = p.get("faction")
            msg = ""
            
            if sell_type == "weapon":
                weapon_name = p["weapon"]
                for item in EQUIPMENT[faction]["weapon"]:
                    if item[0] == weapon_name:
                        price = item[4] // 2
                        p["money"] += price
                        p["weapon"] = None
                        p["weapon_durability"] = 0
                        p["weapon_max_durability"] = 0
                        p["weapon_damage"] = 0
                        p["weapon_accuracy"] = 0
                        msg = f"âœ… ĞŸÑ€Ğ¾Ğ´Ğ°Ğ½Ğ¾: {weapon_name} Ğ·Ğ° {price}Ñ€."
                        break
            
            elif sell_type == "armor":
                armor_name = p["armor"]
                for item in EQUIPMENT[faction]["armor"]:
                    if item[0] == armor_name:
                        price = item[5] // 2
                        p["money"] += price
                        p["armor"] = None
                        p["armor_durability"] = 0
                        p["armor_max_durability"] = 0
                        p["bullet_resist"] = 0
                        p["blast_resist"] = 0
                        p["anomaly_resist"] = 0
                        msg = f"âœ… ĞŸÑ€Ğ¾Ğ´Ğ°Ğ½Ğ¾: {armor_name} Ğ·Ğ° {price}Ñ€."
                        break
            
            elif sell_type == "detector":
                det_name = p["detector"]
                price = DETECTORS[det_name]["price"] // 2
                p["money"] += price
                p["detector"] = None
                p["detector_charge"] = 0
                p["detector_max_charge"] = 0
                msg = f"âœ… ĞŸÑ€Ğ¾Ğ´Ğ°Ğ½Ğ¾: {det_name} Ğ·Ğ° {price}Ñ€."
            
            p["pending_sell"] = None
            p["state"] = GameState.TRADER_SELL_EQUIPMENT_CONFIRM
            save_data()
            await event.answer(msg, keyboard=create_equipment_category_keyboard())
        
        elif text == "âŒ ĞĞµÑ‚":
            p["pending_sell"] = None
            p["state"] = GameState.TRADER_SELL_EQUIPMENT_CONFIRM
            save_data()
            await event.answer("ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶Ğ° Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°.", keyboard=create_equipment_category_keyboard())
    
    elif state == GameState.CONFIRMING_TRANSITION:
        pending = p.get("pending_transition")
        
        if text == "âœ… Ğ”Ğ°" and pending:
            target_loc, target_point = pending
            target_owner = get_territory_owner(target_loc, target_point)
            player_faction = p["faction"]
            
            if target_owner is not None and target_owner != player_faction:
                await event.answer("âŒ Ğ¢ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ Ğ½Ğµ Ğ²Ğ°ÑˆĞ°.", keyboard=create_transition_keyboard(user_id))
                p["state"] = GameState.IN_TRANSITION_MENU
                p.pop("pending_transition", None)
                save_data()
                return
            
            ok, msg = check_vital_conditions(user_id, "Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´")
            if not ok:
                await event.answer(msg, keyboard=create_transition_keyboard(user_id))
                p["state"] = GameState.IN_TRANSITION_MENU
                p.pop("pending_transition", None)
                save_data()
                return
            
            # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ÑƒÑ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ
            p["previous_location"] = p["location"]
            p["previous_point"] = p["point"]
            
            # Ğ¢Ñ€Ğ°Ñ‚Ğ¸Ğ¼ Ñ€ĞµÑÑƒÑ€ÑÑ‹
            p["stamina"] -= 3
            p["hunger"] += 2
            
            # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ
            p["location"], p["point"] = target_loc, target_point
            
            # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ°
            transition_time = 900 if has_active_donation(user_id) else 1800
            p["transition_end_time"] = time.time() + transition_time
            p["state"] = GameState.TRANSITION_WAIT
            p.pop("pending_transition", None)
            save_data()
            
            time_text = "15 Ğ¼Ğ¸Ğ½ÑƒÑ‚" if transition_time == 900 else "30 Ğ¼Ğ¸Ğ½ÑƒÑ‚"
            await event.answer(f"ğŸš¶â€â™‚ï¸ ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ½Ğ° {target_loc} {target_point}. ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ: {time_text}.")
        
        elif text == "âŒ ĞĞµÑ‚":
            p["state"] = GameState.IN_TRANSITION_MENU
            p.pop("pending_transition", None)
            save_data()
            await event.answer("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ:", keyboard=create_transition_keyboard(user_id))


# ==================== ĞŸĞ•Ğ Ğ•Ğ¥ĞĞ”Ğ« ====================

@bot.message_handler(bot.text_filter("ğŸ‘£ ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´"))
async def handle_transition_menu(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.IN_MENU:
        players[user_id]["state"] = GameState.IN_TRANSITION_MENU
        save_data()
        
        current_loc = players[user_id]["location"]
        current_point = players[user_id]["point"]
        
        await event.answer(f"ğŸ“ Ğ’Ñ‹ Ğ½Ğ°: {current_loc} {current_point}\nĞ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ:", 
                          keyboard=create_transition_keyboard(user_id))


async def handle_location_transition(user_id: int, target_loc: str):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸ÑĞ¼Ğ¸"""
    p = players[user_id]
    current_loc = p["location"]
    current_point = p["point"]
    
    if target_loc == current_loc:
        await send_message(user_id, "Ğ’Ñ‹ ÑƒĞ¶Ğµ Ğ·Ğ´ĞµÑÑŒ.", keyboard=create_transition_keyboard(user_id))
        return
    
    if can_transition_from(current_loc, current_point):
        transitions = get_available_transitions(current_loc, current_point)
        target = None
        for (tloc, tpoint) in transitions:
            if tloc == target_loc:
                target = (tloc, tpoint)
                break
        
        if target:
            p["pending_transition"] = target
            p["state"] = GameState.CONFIRMING_TRANSITION
            save_data()
            await send_message(user_id, f"ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğ½Ğ° {target[0]} {target[1]}?", create_confirmation_keyboard())
        else:
            await send_message(user_id, "âŒ ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ½Ğ° ÑÑ‚Ñƒ Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ Ğ½ĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶ĞµĞ½.", 
                              keyboard=create_transition_keyboard(user_id))
    else:
        await send_message(user_id, "âŒ Ğ˜Ğ· ÑÑ‚Ğ¾Ğ¹ Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ¿ĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğ½Ğ° Ğ´Ñ€ÑƒĞ³ÑƒÑ Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ.", 
                          keyboard=create_transition_keyboard(user_id))


async def handle_point_transition(user_id: int, point: str):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Ñ‚Ğ¾Ñ‡ĞºÑƒ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¸"""
    p = players[user_id]
    current_loc = p["location"]
    current_point = p["point"]
    
    point = point.upper().strip()
    
    if point == current_point:
        await send_message(user_id, "âŒ Ğ’Ñ‹ ÑƒĞ¶Ğµ Ğ½Ğ° ÑÑ‚Ğ¾Ğ¹ Ñ‚Ğ¾Ñ‡ĞºĞµ.", keyboard=create_main_menu_keyboard(user_id))
        p["state"] = GameState.IN_MENU
        save_data()
        return
    
    if not is_valid_point(current_loc, point):
        await send_message(user_id, f"âŒ Ğ¢Ğ¾Ñ‡ĞºĞ° {point} Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ² {current_loc}.", 
                          keyboard=create_main_menu_keyboard(user_id))
        p["state"] = GameState.IN_MENU
        save_data()
        return
    
    target_owner = get_territory_owner(current_loc, point)
    player_faction = p["faction"]
    
    if target_owner is not None and target_owner != player_faction:
        await send_message(user_id, "âŒ Ğ­Ñ‚Ğ° Ñ‚ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ Ğ½Ğµ Ğ²Ğ°ÑˆĞ°.", keyboard=create_main_menu_keyboard(user_id))
        p["state"] = GameState.IN_MENU
        save_data()
        return
    
    ok, msg = check_vital_conditions(user_id, "Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´")
    if not ok:
        await send_message(user_id, msg, keyboard=create_main_menu_keyboard(user_id))
        p["state"] = GameState.IN_MENU
        save_data()
        return
    
    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ÑƒÑ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ
    p["previous_location"] = p["location"]
    p["previous_point"] = p["point"]
    
    # Ğ¢Ñ€Ğ°Ñ‚Ğ¸Ğ¼ Ñ€ĞµÑÑƒÑ€ÑÑ‹
    p["stamina"] -= 3
    p["hunger"] += 2
    
    # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ Ñ‚Ğ¾Ñ‡ĞºÑƒ
    p["point"] = point
    
    # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ°
    transition_time = 900 if has_active_donation(user_id) else 1800
    p["transition_end_time"] = time.time() + transition_time
    p["state"] = GameState.TRANSITION_WAIT
    save_data()
    
    time_text = "15 Ğ¼Ğ¸Ğ½ÑƒÑ‚" if transition_time == 900 else "30 Ğ¼Ğ¸Ğ½ÑƒÑ‚"
    await send_message(user_id, f"ğŸš¶â€â™‚ï¸ ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ½Ğ° {current_loc} {point}. ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ: {time_text}.")


# ==================== Ğ¡ĞšĞ›ĞĞ” ====================

@bot.message_handler(bot.text_filter("ğŸ§° Ğ¡ĞºĞ»Ğ°Ğ´"))
async def handle_warehouse(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.IN_MENU:
        p = players[user_id]
        location = p.get("location")
        point = p.get("point")
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ¸Ğ³Ñ€Ğ¾Ğº Ğ½Ğ° Ğ±Ğ°Ğ·Ğµ
        if location not in BASE_POINTS or point != BASE_POINTS.get(location):
            await event.answer("âŒ Ğ¡ĞºĞ»Ğ°Ğ´ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ° Ğ±Ğ°Ğ·Ğµ.")
            return
        
        players[user_id]["state"] = GameState.WAREHOUSE
        save_data()
        
        await send_warehouse_info(user_id)


async def send_warehouse_info(user_id: int):
    """ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ÑĞºĞ»Ğ°Ğ´Ğµ"""
    if LAST_STAND_MODE:
        faction = players[user_id].get("faction")
        warehouse = faction_warehouses.get(faction, {})
        money = faction_warehouse_money.get(faction, 0)
    else:
        warehouse = shared_warehouse
        money = shared_warehouse_money
    
    if not warehouse:
        items_str = "ĞŸÑƒÑÑ‚Ğ¾ ğŸ“¦"
    else:
        active_items = {k: v for k, v in warehouse.items() if v > 0}
        if not active_items:
            items_str = "ĞŸÑƒÑÑ‚Ğ¾"
        else:
            items_list = [f"â€¢ {item}: {count}" for item, count in active_items.items()]
            items_str = "\n".join(items_list)
    
    msg = f"""ğŸ§° Ğ¡ĞºĞ»Ğ°Ğ´:
{items_str}

ğŸ’² Ğ”ĞµĞ½ÑŒĞ³Ğ¸ Ğ½Ğ° ÑĞºĞ»Ğ°Ğ´Ğµ: {money}Ñ€

ğŸ“ ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:
â€¢ Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ [Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚] [ĞºĞ¾Ğ»-Ğ²Ğ¾]
â€¢ Ğ·Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ [Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚] [ĞºĞ¾Ğ»-Ğ²Ğ¾]
â€¢ Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ Ğ´ĞµĞ½ÑŒĞ³Ğ¸ [ÑÑƒĞ¼Ğ¼Ğ°]
â€¢ Ğ·Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ´ĞµĞ½ÑŒĞ³Ğ¸ [ÑÑƒĞ¼Ğ¼Ğ°]"""
    
    await send_message(user_id, msg, create_warehouse_keyboard())


async def handle_warehouse_action(user_id: int, text: str):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ ÑĞ¾ ÑĞºĞ»Ğ°Ğ´Ğ¾Ğ¼"""
    global shared_warehouse, shared_warehouse_money, faction_warehouses, faction_warehouse_money
    
    if LAST_STAND_MODE:
        faction = players[user_id].get("faction")
        warehouse = faction_warehouses.get(faction, {})
        warehouse_money = faction_warehouse_money.get(faction, 0)
    else:
        warehouse = shared_warehouse
        warehouse_money = shared_warehouse_money
    
    parts = text.strip().lower().split()
    
    if len(parts) < 2:
        await send_message(user_id, "âŒ Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ/Ğ·Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ [Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚] [ĞºĞ¾Ğ»-Ğ²Ğ¾]", create_warehouse_keyboard())
        return
    
    action = parts[0]
    if action not in ["Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ", "Ğ·Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ"]:
        await send_message(user_id, "âŒ Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ/Ğ·Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ [Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚] [ĞºĞ¾Ğ»-Ğ²Ğ¾]", create_warehouse_keyboard())
        return
    
    # Ğ”ĞµĞ½ÑŒĞ³Ğ¸
    if parts[1] == "Ğ´ĞµĞ½ÑŒĞ³Ğ¸":
        try:
            amount = int(parts[2])
        except:
            await send_message(user_id, "âŒ Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ ÑÑƒĞ¼Ğ¼Ñƒ.", create_warehouse_keyboard())
            return
        
        if action == "Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ":
            if players[user_id]["money"] < amount:
                await send_message(user_id, "âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ´ĞµĞ½ĞµĞ³.", create_warehouse_keyboard())
                return
            
            players[user_id]["money"] -= amount
            if LAST_STAND_MODE:
                faction_warehouse_money[faction] = faction_warehouse_money.get(faction, 0) + amount
            else:
                shared_warehouse_money += amount
        else:
            current_money = faction_warehouse_money.get(faction, 0) if LAST_STAND_MODE else shared_warehouse_money
            if current_money < amount:
                await send_message(user_id, "âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ´ĞµĞ½ĞµĞ³ Ğ½Ğ° ÑĞºĞ»Ğ°Ğ´Ğµ.", create_warehouse_keyboard())
                return
            
            if LAST_STAND_MODE:
                faction_warehouse_money[faction] -= amount
            else:
                shared_warehouse_money -= amount
            
            players[user_id]["money"] += amount
    
    # ĞŸÑ€ĞµĞ´Ğ¼ĞµÑ‚Ñ‹
    else:
        try:
            count = int(parts[-1])
            item_name = " ".join(parts[1:-1])
        except:
            await send_message(user_id, "âŒ Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾.", create_warehouse_keyboard())
            return
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ğ°
        valid_item = None
        for item in ITEM_EFFECTS.keys():
            if item.lower() == item_name:
                valid_item = item
                break
        if not valid_item:
            for art in ALL_ARTIFACTS:
                if art.lower() == item_name:
                    valid_item = art
                    break
        
        if not valid_item:
            await send_message(user_id, "âŒ ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚.", create_warehouse_keyboard())
            return
        
        if action == "Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ":
            if players[user_id]["backpack"].get(valid_item, 0) < count:
                await send_message(user_id, f"âŒ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ {count} ÑˆÑ‚.", create_warehouse_keyboard())
                return
            
            players[user_id]["backpack"][valid_item] -= count
            warehouse[valid_item] = warehouse.get(valid_item, 0) + count
            
            if players[user_id]["backpack"][valid_item] <= 0:
                del players[user_id]["backpack"][valid_item]
        else:
            if warehouse.get(valid_item, 0) < count:
                await send_message(user_id, f"âŒ ĞĞ° ÑĞºĞ»Ğ°Ğ´Ğµ Ğ½ĞµÑ‚ {count} ÑˆÑ‚.", create_warehouse_keyboard())
                return
            
            warehouse[valid_item] -= count
            players[user_id]["backpack"][valid_item] = players[user_id]["backpack"].get(valid_item, 0) + count
            
            if warehouse[valid_item] <= 0:
                del warehouse[valid_item]
        
        if LAST_STAND_MODE:
            faction_warehouses[faction] = warehouse
        else:
            shared_warehouse = warehouse
    
    save_data()
    await send_warehouse_info(user_id)


# ==================== ĞŸĞĞ”Ğ—ĞĞ Ğ¯Ğ”ĞšĞ Ğ”Ğ•Ğ¢Ğ•ĞšĞ¢ĞĞ Ğ ====================

@bot.message_handler(bot.text_filter("ğŸ”‹ ĞŸĞ¾Ğ´Ğ·Ğ°Ñ€ÑĞ´ĞºĞ°"))
async def handle_recharge(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.IN_CAMP:
        p = players[user_id]
        detector = p.get("detector")
        detector_charge = p.get("detector_charge", 0)
        detector_max_charge = p.get("detector_max_charge", 0)
        
        if not detector or detector_max_charge <= 0:
            await event.answer("âŒ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ´ĞµÑ‚ĞµĞºÑ‚Ğ¾Ñ€Ğ°.", keyboard=create_camp_menu_keyboard())
            return
        
        if detector_charge >= detector_max_charge:
            await event.answer("ğŸ”‹ Ğ”ĞµÑ‚ĞµĞºÑ‚Ğ¾Ñ€ ÑƒĞ¶Ğµ Ğ·Ğ°Ñ€ÑĞ¶ĞµĞ½.", keyboard=create_camp_menu_keyboard())
            return
        
        batteries_needed = detector_max_charge - detector_charge
        batteries_have = p["backpack"].get("Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸", 0)
        
        if batteries_have <= 0:
            await event.answer("âŒ ĞĞµÑ‚ Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞµĞº.", keyboard=create_camp_menu_keyboard())
            return
        
        batteries_used = min(batteries_needed, batteries_have)
        p["detector_charge"] = detector_charge + batteries_used
        p["backpack"]["Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸"] -= batteries_used
        
        if p["backpack"]["Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸"] <= 0:
            del p["backpack"]["Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞ¹ĞºĞ¸"]
        
        save_data()
        await event.answer(f"âœ… Ğ—Ğ°Ñ€ÑĞ¶ĞµĞ½Ğ¾ Ğ½Ğ° {batteries_used} ĞµĞ´Ğ¸Ğ½Ğ¸Ñ†.\nğŸ“Ÿ {p['detector_charge']}/{detector_max_charge}", 
                          keyboard=create_camp_menu_keyboard())


# ==================== Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡ Ğ’Ğ«Ğ‘Ğ ĞĞ¡Ğ ====================

@bot.message_handler(bot.regex_filter(r"^ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ²Ñ‹Ğ±Ñ€Ğ¾ÑĞ°"))
async def handle_emission_status(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    status = get_emission_status()
    restored_text = ", ".join(last_restored_categories) if last_restored_categories else "Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…"
    
    msg = f"""ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ²Ñ‹Ğ±Ñ€Ğ¾ÑĞ°: {status}
ĞÑ‡ĞºĞ¾Ğ²: {emission_counter}/{EMISSION_MAX}

â™»ï¸ ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ:
{restored_text}"""
    
    await event.answer(msg, keyboard=create_camp_menu_keyboard())


# ==================== ĞŸĞĞ¯Ğ¡ ĞĞ Ğ¢Ğ•Ğ¤ĞĞšĞ¢ĞĞ’ ====================

@bot.message_handler(bot.text_filter("â• ĞŸĞ¾Ğ²ĞµÑĞ¸Ñ‚ÑŒ"))
async def handle_belt_equip(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.BELT_MAIN:
        players[user_id]["state"] = GameState.BELT_SELECT_SLOT
        players[user_id]["belt_action"] = "equip"
        save_data()
        await event.answer("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿Ğ¾ÑÑ:", keyboard=create_belt_slot_keyboard())


@bot.message_handler(bot.text_filter("â– Ğ¡Ğ½ÑÑ‚ÑŒ"))
async def handle_belt_unequip(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    if players[user_id].get("state") == GameState.BELT_MAIN:
        players[user_id]["state"] = GameState.BELT_SELECT_SLOT
        players[user_id]["belt_action"] = "unequip"
        save_data()
        await event.answer("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿Ğ¾ÑÑ Ğ´Ğ»Ñ ÑĞ½ÑÑ‚Ğ¸Ñ:", keyboard=create_belt_slot_keyboard())


@bot.message_handler(bot.text_filter("ğŸ’¡ Ğ˜Ğ½Ñ„Ğ¾ Ğ¾Ğ± Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ°Ñ…"))
async def handle_artifacts_info(event: SimpleBotEvent):
    user_id = event.from_id
    if user_id not in players:
        return
    
    await event.answer(ARTIFACT_INFO_TEXT, keyboard=create_belt_main_keyboard())


@bot.message_handler(bot.text_filter(["1ï¸âƒ£ ĞŸĞ¾ÑÑ", "2ï¸âƒ£ ĞŸĞ¾ÑÑ", "3ï¸âƒ£ ĞŸĞ¾ÑÑ"]))
async def handle_belt_slot_select(event: SimpleBotEvent):
    user_id = event.from_id
    text = event.text
    
    if user_id not in players:
        return
    
    if players[user_id].get("state") != GameState.BELT_SELECT_SLOT:
        return
    
    slot = -1
    if text == "1ï¸âƒ£ ĞŸĞ¾ÑÑ":
        slot = 0
    elif text == "2ï¸âƒ£ ĞŸĞ¾ÑÑ":
        slot = 1
    elif text == "3ï¸âƒ£ ĞŸĞ¾ÑÑ":
        slot = 2
    
    if slot < 0:
        return
    
    p = players[user_id]
    action = p.get("belt_action", "equip")
    belt = p.get("belt", [None, None, None])
    
    if action == "equip":
        if belt[slot] is not None:
            await event.answer(f"âŒ ĞŸĞ¾ÑÑ {slot+1} Ğ·Ğ°Ğ½ÑÑ‚ ({belt[slot]}).", keyboard=create_belt_slot_keyboard())
            return
        
        available_arts = [art for art in ALL_ARTIFACTS if p["backpack"].get(art, 0) > 0]
        if not available_arts:
            await event.answer("âŒ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ğ².", keyboard=create_belt_slot_keyboard())
            return
        
        p["pending_belt_slot"] = slot
        p["state"] = GameState.BELT_SELECT_ARTIFACT
        p["artifact_page"] = 0
        save_data()
        
        await event.answer(f"ğŸŸ¡ ĞšĞ°ĞºĞ¾Ğ¹ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚ Ğ½Ğ° Ğ¿Ğ¾ÑÑ {slot + 1}?", 
                          keyboard=create_artifact_selection_keyboard(available_arts, 0))
    else:
        if belt[slot] is None:
            await event.answer(f"âŒ ĞŸĞ¾ÑÑ {slot+1} Ğ¿ÑƒÑÑ‚.", keyboard=create_belt_slot_keyboard())
            return
        
        art = belt[slot]
        belt[slot] = None
        p["belt"] = belt
        p["backpack"][art] = p["backpack"].get(art, 0) + 1
        p["state"] = GameState.BELT_MAIN
        save_data()
        
        await event.answer(f"âœ… {art} ÑĞ½ÑÑ‚ Ñ Ğ¿Ğ¾ÑÑĞ° {slot+1}.", keyboard=create_belt_main_keyboard())


@bot.message_handler(bot.text_filter(["â—€ï¸ Ğ¢ÑƒĞ´Ğ°", "â–¶ï¸ Ğ¡ÑĞ´Ğ°"]))
async def handle_artifact_page(event: SimpleBotEvent):
    user_id = event.from_id
    text = event.text
    
    if user_id not in players:
        return
    
    if players[user_id].get("state") != GameState.BELT_SELECT_ARTIFACT:
        return
    
    p = players[user_id]
    available_arts = [art for art in ALL_ARTIFACTS if p["backpack"].get(art, 0) > 0]
    current_page = p.get("artifact_page", 0)
    items_per_page = 6
    total_pages = (len(available_arts) + items_per_page - 1) // items_per_page
    
    if text == "â—€ï¸ Ğ¢ÑƒĞ´Ğ°" and current_page > 0:
        current_page -= 1
    elif text == "â–¶ï¸ Ğ¡ÑĞ´Ğ°" and current_page < total_pages - 1:
        current_page += 1
    
    p["artifact_page"] = current_page
    save_data()
    
    slot = p.get("pending_belt_slot", 0)
    await event.answer(f"ğŸŸ¡ ĞšĞ°ĞºĞ¾Ğ¹ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚ Ğ½Ğ° Ğ¿Ğ¾ÑÑ {slot + 1}? (ÑÑ‚Ñ€. {current_page + 1})", 
                      keyboard=create_artifact_selection_keyboard(available_arts, current_page))


# ==================== Ğ¢ĞĞ§ĞšĞ Ğ’Ğ¥ĞĞ”Ğ ====================
async def main():
    """Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ±Ğ¾Ñ‚Ğ°"""
    logger.info("ğŸ”„ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...")
    load_data()
    
    logger.info("ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ„Ğ¾Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡...")
    asyncio.create_task(background_checker())
    
    logger.info("âœ… Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½!")
    await bot.run()


if __name__ == "__main__":
    asyncio.run(main())
